define("modules/application",[],function(){"use strict";function log(t,e){(!e||s>=e)&&console.log(t)}var t,e,i={CRITICAL:"critical",SEVERE:"severe",MINOR:"minor"},r="text/plain; charset=utf-8",n=null,o=!0,s=0,a="",l=!0,h=!1;return{ErrorSeverity:i,getFolder:function(t){return t.length>0&&"/"===t[t.length-1]?t:n?void 0!==n[t]?n[t]:(this.showError("Asked for folder for file type '"+t+"', and folder for such files is not registered!",i.SEVERE),null):(this.log("Looking for the folder assigned to file type '"+t+"', but there are no folders specified in the application configuration. Will use the folder with the same name as the file type."),t+"/")},setFolders:function(t){var e="",r=function(e,n,o){var s=-1,a=-1,l="",h="";for(o=o||[];e.indexOf("{{")>=0;){if(!(e.indexOf("}}")>=0))return this.showError("Invalid folder name specified! Cannot resolve: '"+e+"'",i.SEVERE,"References to other folders must be surrounded by {{ and }}."),null;if(s=e.indexOf("{{"),a=e.indexOf("}}"),h=e.substring(s+2,a),l=t[h],!l)return this.showError("Invalid folder name specified! Cannot find referenced folder '"+e.substring(s+2,a)+"' in "+e+"!",i.SEVERE),null;if(!(o.indexOf(h)<0))return this.showError("Circular reference detected among the following folders: "+o.concat(n).join(", "),i.SEVERE),null;e=e.replace(e.substring(s,Math.min(a+3,e.length)),r(l,h,o.concat(n)))}return e}.bind(this);n={};for(e in t)t.hasOwnProperty(e)&&(n[e]=r(t[e],e))},setFileCacheBypassEnabled:function(t){o=t},setLogVerbosity:function(t){s=t},getVersion:function(){return a},getVersionURLArg:function(){return"v="+this.getVersion().split(" ")[0]},setVersion:function(t){a=t,requirejs.config({urlArgs:this.getVersionURLArg()})},setPreviouslyRunVersion:function(i){t=i,e=void 0===t},isFirstRun:function(){return e},hasVersionChanged:function(){return void 0!==e?t!==a:void this.showError("Cannot determine whether the game version has changed, because the previously ran version is not set!")},isDebugVersion:function(){return l},setDebugVersion:function(t){l=t},usesElectron:function(){return h},useElectron:function(t){h=t},getFileURL:function(t,e){return this.getFolder(t)+(e+(o||!this.getVersion()?"?t="+performance.now():"?"+this.getVersionURLArg()))},showError:function(t,e,r){var n="Error: "+t+(r?"\n\n"+r+"\n\n":"\n\n");switch(e){case i.CRITICAL:n+="Unfortunately this is a critical error.\nThe application is not functional until this error is resolved.";break;case i.SEVERE:n+="This is a severe error.\nThe application might produce unexpected behaviour from this point on. It is recommended that you restart the application by refreshing the page in your browser.";break;case i.MINOR:n+="This is a minor error.\nThe application might be fully functional, but you might need to readjust some settings or take some other actions depending on the explanation of the error.";break;default:n+="The severity of this error cannot be determined.\nThe application might produce unexpected behaviour from this point on. It is recommended that you restart the application by refreshing the page in your browser."}alert(n)},log:log,log_DEBUG:log,requestFile:function(t,e,r,n,o){this.log("Requesting file: '"+e+"' from "+(""!==this.getFolder(t)?"folder: '"+this.getFolder(t):"root folder")+"'...",2);var s=new XMLHttpRequest;s.onload=function(){this.log("File: '"+e+"' successfully loaded.",2),r(s)}.bind(this),s.onerror=function(){this.showError("An error occured while trying to load file: '"+e+"'.",i.SEVERE,"The status of the request was: '"+s.statusText+"' when the error happened."),r()}.bind(this),s.ontimeout=function(){this.showError("Request to load the file: '"+e+"' timed out.",i.SEVERE),r()}.bind(this),n&&s.overrideMimeType(n),o&&(s.responseType=o),s.open("GET",this.getFileURL(t,e),!0),s.send(null)},requestTextFile:function(t,e,i,n){this.requestFile(t,e,function(t){i(t?t.responseText:null)},n||r)},requestXMLFile:function(t,e,r){this.requestFile(t,e,function(t){var n=t?null===t.responseXML?(new DOMParser).parseFromString(t.responseText,"application/xml"):t.responseXML:null;n&&"parsererror"!==n.documentElement.nodeName?r(n):(this.showError("Could not parse XML file: '"+e+"'.",i.SEVERE,"The file could be loaded, but for some reason the parsing of it has failed. \nThe status of the request was: '"+t.statusText+"' when the error happened.\nThe text content of the file:\n"+(t.responseText.length>120?t.responseText.slice(0,120)+"...":t.responseText)),r())}.bind(this),"application/xml")},requestCSSFile:function(t,e,i){var r;0===document.head.querySelectorAll("link[href='"+this.getFileURL(t,e)+"']").length?(r=document.createElement("link"),r.setAttribute("rel","stylesheet"),r.setAttribute("type","text/css"),r.onload=i,r.href=this.getFileURL(t,e),document.head.appendChild(r)):i&&i()}}}),define("modules/async-resource",[],function(){"use strict";function AsyncResource(){this._readyToUse=!1,this._onReadyQueue=[],this._triggeredOnreadyQueueLength=0}return AsyncResource.prototype.addOnReadyFunction=function(t){this._onReadyQueue.push(t)},AsyncResource.prototype.isReadyToUse=function(){return this._readyToUse},AsyncResource.prototype.resetReadyState=function(){this._readyToUse=!1},AsyncResource.prototype.resetResource=function(){this._readyToUse=!1,this._onReadyQueue=[]},AsyncResource.prototype.executeOnReadyQueue=function(){var t;for(this._triggeredOnreadyQueueLength=this._onReadyQueue.length,t=0;t<this._triggeredOnreadyQueueLength;t++)this._onReadyQueue[t]&&this._onReadyQueue[t].call(this),this._onReadyQueue[t]=null;this._onReadyQueue=this._onReadyQueue.length>this._triggeredOnreadyQueueLength?this._onReadyQueue.slice(this._triggeredOnreadyQueueLength):[]},AsyncResource.prototype.setToReady=function(){this._readyToUse===!1&&(this._readyToUse=!0,this.executeOnReadyQueue())},AsyncResource.prototype.executeWhenReady=function(t,e,i){return this._readyToUse?i?(setTimeout(t.bind(this),0),!1):(t.call(this),!0):(this.addOnReadyFunction(t),void 0!==e&&e.call(this),!1)},{AsyncResource:AsyncResource}}),define("modules/screen-manager",["modules/async-resource","modules/application"],function(t,e){"use strict";function ScreenManager(){t.AsyncResource.call(this),this._screens={},this._coveredScreens=[],this._currentScreen=null,this._screensLoaded=0,this._screensToLoad=0}var i;return ScreenManager.prototype=new t.AsyncResource,ScreenManager.prototype.constructor=ScreenManager,ScreenManager.prototype.getCurrentScreen=function(){return this._currentScreen},ScreenManager.prototype.getScreen=function(t){return t?this._screens[t]:this.getCurrentScreen()},ScreenManager.prototype.addScreen=function(t,e,i){var r,n=function(){this._screensLoaded++,this._screensLoaded===this._screensToLoad&&this.setToReady()}.bind(this);if(this.resetReadyState(),e===!0)for(r in this._screens)this._screens.hasOwnProperty(r)&&this._screens[r].removeFromPage();this._screensToLoad++,this._screens[t.getName()]=t,e===!0?t.replacePageWithScreen(n):t.addScreenToPage(n,i),this._currentScreen||(this._currentScreen=t,this._currentScreen.setActive(!0))},ScreenManager.prototype.setCurrentScreen=function(t,i,r){var n,o=this.getScreen(t);if(!o)return void e.showError("Cannot switch to screen '"+t+"', because it does not exist!");if(i!==!0&&null!==this._currentScreen)for(this._currentScreen.hide(),n=0;n<this._coveredScreens.length;n++)this._coveredScreens[n].hide();i===!0?(this._coveredScreens.push(this._currentScreen),this._currentScreen.setActive(!1),this._currentScreen=o,o.superimposeOnPage(r)):(this._currentScreen=o,o.show()),this._currentScreen===o&&this._currentScreen.setActive(!0)},ScreenManager.prototype.closeSuperimposedScreen=function(){this._currentScreen.hide(),this._currentScreen=this._coveredScreens.pop(),this._currentScreen.setActive(!0)},ScreenManager.prototype.closeOrNavitageTo=function(t){this.getCurrentScreen().isSuperimposed()?this.closeSuperimposedScreen():this.setCurrentScreen(t)},ScreenManager.prototype.updateAllScreens=function(){var t;for(t in this._screens)this._screens.hasOwnProperty(t)&&this._screens[t].updateScreen()},i=new ScreenManager,{getCurrentScreen:i.getCurrentScreen.bind(i),getScreen:i.getScreen.bind(i),addScreen:i.addScreen.bind(i),setCurrentScreen:i.setCurrentScreen.bind(i),closeSuperimposedScreen:i.closeSuperimposedScreen.bind(i),closeOrNavitageTo:i.closeOrNavitageTo.bind(i),updateAllScreens:i.updateAllScreens.bind(i),executeWhenReady:i.executeWhenReady.bind(i)}}),define("utils/utils",[],function(){"use strict";var t={WIDTH:"width",HEIGHT:"height",ASPECT:"aspect",MINIMUM:"minimum",MAXIMUM:"maximum"},e={LEFT:1,MIDDLE:2,RIGHT:3},i="",r=[],n=" ",o={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,"caps lock":20,escape:27,space:32,"page up":33,"page down":34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,"delete":46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,"left window":91,"right window":92,select:93,"numpad 0":96,"numpad 1":97,"numpad 2":98,"numpad 3":99,"numpad 4":100,"numpad 5":101,"numpad 6":102,"numpad 7":103,"numpad 8":104,"numpad 9":105,"numpad *":106,"numpad +":107,"numpad -":109,"numpad /":111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,";":186,"=":187,",":188,"-":189,".":190,"/":191,"`":192,"[":219,"\\":220,"]":221,"'":222},s={};return s.EMPTY_ARRAY=r,s.EMPTY_STRING=i,s.ScaleMode=t,s.MouseButton=e,s.scalesWithWidth=function(e,i,r){return e===t.WIDTH||e===t.MINIMUM&&r>i||e===t.MAXIMUM&&i>=r},s.xScalesWithWidth=function(e,i,r){return e===t.ASPECT||e===t.WIDTH||e===t.MINIMUM&&r>i||e===t.MAXIMUM&&i>=r},s.yScalesWithHeight=function(e,i,r){return e===t.ASPECT||e===t.HEIGHT||e===t.MINIMUM&&i>r||e===t.MAXIMUM&&r>=i},s.getRGBColorFromXMLTag=function(t){return[parseFloat(t.getAttribute("r")),parseFloat(t.getAttribute("g")),parseFloat(t.getAttribute("b"))]},s.getDimensionsFromXMLTag=function(t){return[parseFloat(t.getAttribute("w")),parseFloat(t.getAttribute("h")),parseFloat(t.getAttribute("d"))]},s.evaluateProduct=function(t){var e,i,r;for(e=t.split("*"),i=1,r=0;r<e.length;r++)i*=parseFloat(e[r]);return i},s.getFirstXMLElement=function(t,e){var i=t.getElementsByTagName(e);return i.length>0?i[0]:null},s.getKeyCodeOf=function(t){return t?"#"===t[0]?parseInt(t.slice(1),10):o[t]:-1},s.getKeyOfCode=function(t){var e;for(e in o)if(o[e]===t)return e;return"#"+t},s.arraysEqual=function(t,e){var i,r;if(!e)return!1;if(t.length!==e.length)return!1;for(i=0,r=t.length;r>i;i++)if(t[i]instanceof Array&&e[i]instanceof Array){if(!t[i].equals(e[i]))return!1}else if(t[i]!==e[i])return!1;return!0},s.objectsEqual=function(t,e){var i,r,n;if(null===t&&null===e)return!0;if(!t)return!1;if(i=Object.keys(t).sort(),!e)return!1;if(r=Object.keys(e).sort(),i.length!==r.length)return!1;for(n=0;n<i.length;n++)if(i[n]!==r[n]||t[i[n]]!==e[r[n]])return!1;return!0},s.equivalent=function(t,e){var i,r,n,o;if("object"==typeof t&&"object"==typeof e){if(null===t||null===e)return t===e;if(t instanceof Array&&e instanceof Array){if(t.length!==e.length)return!1;for(i=0,r=t.length;r>i;i++)if(!s.equivalent(t[i],e[i]))return!1;return!0}if(n=Object.keys(t).sort(),o=Object.keys(e).sort(),n.length!==o.length)return!1;for(i=0,r=n.length;r>i;i++)if(n[i]!==o[i]||!s.equivalent(t[n[i]],e[o[i]]))return!1;return!0}return t===e},s.shallowCopy=function(t){var e,i,r;if("object"==typeof t){if(t instanceof Array)return t.slice();for(e={},r=Object.keys(t),i=0;i<r.length;i++)e[r[i]]=t[r[i]];return e}return t},s.deepCopy=function(t){var e,i,r;if("object"==typeof t){if(t instanceof Array){for(e=[],i=0;i<t.length;i++)e.push(s.deepCopy(t[i]));return e}for(e={},r=Object.keys(t),i=0;i<r.length;i++)e[r[i]]=s.deepCopy(t[r[i]]);return e}return t},s.removeFromArray=function(t,e){var i=t.indexOf(e);return i>=0?(t.splice(i,1),!0):!1},s.getSafeEnumValue=function(t,e,i){var r;i=i?s.getSafeEnumValue(t,i):null;for(r in t)if(t.hasOwnProperty(r)&&e===t[r])return e;return i||null},s.getEnumValues=function(t){var e,i=[];for(e in t)t.hasOwnProperty(e)&&i.push(t[e]);return i},s.getKeyOfValue=function(t,e){var i;for(i in t)if(t.hasOwnProperty(i)&&t[i]===e)return i;return null},s.getPaddedStringForNumber=function(t,e,i){var r,n=t.toString(i||10);for(r=n.length;e>r;r++)n="0"+n;return n},s.getDelimitedStringForNumber=function(t){return t>=1e3?s.getDelimitedStringForNumber(Math.floor(t/1e3))+n+s.getPaddedStringForNumber(t%1e3,3):t.toString()},s.getLengthString=function(t){return 2e3>t?100>t?t.toPrecision(3)+" m":Math.round(t)+" m":1e5>t?(t/1e3).toPrecision(3)+" km":s.getDelimitedStringForNumber(Math.round(t/1e3))+" km"},s.getMassString=function(t){return 2e3>t?100>t?t.toPrecision(3)+" kg":Math.round(t)+" kg":1e5>t?(t/1e3).toPrecision(3)+" t":s.getDelimitedStringForNumber(Math.round(t/1e3))+" t"},s.constantName=function(t){var e,i="";for(e=0;e<t.length;e++)t[e].match(/[A-Z]/)&&(i+="_"),i+=" "===t[e]?"_":t[e].toUpperCase();return i},s.formatString=function(t,e){var i,r=t.toString();for(i in e)e.hasOwnProperty(i)&&(r=r.replace(new RegExp("\\{"+i+"\\}","gi"),e[i]));return r},s.formatTimeToMinutes=function(t){var e,i;return e=Math.floor(t/6e4),i=Math.floor(t/1e3)%60,s.getPaddedStringForNumber(e,2)+":"+s.getPaddedStringForNumber(i,2)},s.formatTimeToSeconds=function(t){var e,i;return e=Math.floor(t/1e3)%60,i=Math.floor(t%1e3/10),s.getPaddedStringForNumber(e,2)+"."+s.getPaddedStringForNumber(i,2)},s.executeAsync=function(t){setTimeout(t,0)},s.pointInRect=function(t,e,i,r,n,o){return t>=i&&n>=t&&e>=r&&o>=e},s.getFilenameWithoutExtension=function(t){var e=t.lastIndexOf("."),i=t.lastIndexOf("/");return t=e>0?t.substr(0,e):t,t=i>0?t.substr(i+1):t},s.getLinearMix=function(t,e,i){return t*(1-i)+e*i},s.getMixedColor=function(t,e,i){var r=1-i;return[t[0]*r+e[0]*i,t[1]*r+e[1]*i,t[2]*r+e[2]*i,t[3]*r+e[3]*i]},s.getCSSColor=function(t){return"rgba("+Math.round(255*t[0])+","+Math.round(255*t[1])+","+Math.round(255*t[2])+","+t[3]+")"},s.getHexColor=function(t){return"#"+s.getPaddedStringForNumber(Math.round(255*t[0]),2,16)+s.getPaddedStringForNumber(Math.round(255*t[1]),2,16)+s.getPaddedStringForNumber(Math.round(255*t[2]),2,16)},s.getColor3FromHex=function(t){var e=[0,0,0];return e[0]=parseInt(t.substr(1,2),16)/255,e[1]=parseInt(t.substr(3,2),16)/255,e[2]=parseInt(t.substr(5,2),16)/255,e},s.getGreaterSolutionOfQuadraticEquation=function(t,e,i){var r=e*e-4*t*i;return r>=0?(Math.sqrt(r)-e)/(2*t):NaN},s}),define("utils/types",["utils/utils","modules/application"],function(t,e){"use strict";function _getCheckFailErrorMessage(t,e,i,r){return"Invalid value for '"+t+"' ("+e+")"+(r?": "+r:".")+" Using default value "+i+" instead."}function _showCheckFailError(t,i,r,n){e.showError(_getCheckFailErrorMessage(t,i,r,n))}function _logCheckFailError(t,i,n,o,s){e.log(_getCheckFailErrorMessage(t,i,n,o),void 0!==s?s:r)}function _getTypeError(t,e,i,r){return"Invalid value for '"+e+"'. Expected "+t+", got a(n) "+("object"==typeof i?i.constructor.name:typeof i)+" ("+i+"). Using default value "+(r instanceof Array?"["+r.join(", ")+"]":"'"+r+"'")+" instead."}function _showTypeError(t,i,r,n){e.showError(_getTypeError(t,i,r,n))}function _logTypeError(t,i,n,o,s){e.log(_getTypeError(t,i,n,o),void 0!==s?s:r)}function _getEnumValueError(e,i,r,n){return"Unrecognized '"+e+"' value: '"+i+"'. Possible values are are: "+t.getEnumValues(r).join(", ")+". Default value '"+n+"' will be used instead."}function _showEnumValueError(t,i,r,n){e.showError(_getEnumValueError(t,i,r,n))}function _logEnumValueError(t,i,n,o,s){e.log(_getEnumValueError(t,i,n,o),void 0!==s?s:r)}var i={CHECK_FAIL_ERROR:"checkFailError",TYPE_ERROR:"typeError",ENUM_VALUE_ERROR:"enumValueError",INVALID_ENUM_OBJECT_ERROR:"invalidEnumObjectError"},r=1,n={Errors:i};return n.NUMBER="number",n.VECTOR2={baseType:"array",length:2,elementType:"number"},n.VECTOR3={baseType:"array",length:3,elementType:"number"},n.COLOR3={baseType:"array",length:3,elementType:"number",elementTypeParams:{range:[0,1]}},n.COLOR4={baseType:"array",length:4,elementType:"number",elementTypeParams:{range:[0,1]}},n.DURATION={baseType:"number",range:[0,void 0]},n.ANGLE_DEGREES={baseType:"number",range:[-360,360]},n.getBooleanValue=function(t,e){if(e=e||{},e.name=e.name||"unnamed boolean","boolean"==typeof t){if(!e.checkFunction||e.checkFunction(t,e.parentObject))return t;e.error=i.CHECK_FAIL_ERROR,e.silentFallback?_logCheckFailError(e.name,t,e.defaultValue,e.checkFailMessage):_showCheckFailError(e.name,t,e.defaultValue,e.checkFailMessage)}else e.error=i.TYPE_ERROR,e.silentFallback?_logTypeError("a boolean",e.name,t,e.defaultValue):_showTypeError("a boolean",e.name,t,e.defaultValue);return null!==e.defaultValue?(t=e.defaultValue,e.defaultValue=null,n.getBooleanValue(t,e)):null},n.getNumberValue=function(t,e,i,r,o,s,a){return"number"==typeof e?r&&!r(e,s)?(_showCheckFailError(t,e,i,o),null!==i?n.getNumberValue(t,i,null,r,o,s):null):e:("number"==typeof i&&a||_showTypeError("a number",t,e,i),null!==i?n.getNumberValue(t,i,null,r,o,s):null)},n.getNumberValueInRange=function(t,i,r,o,s,a,l,h){return"number"==typeof i?((void 0!==r&&r>i||void 0!==o&&i>o)&&(e.showError("Invalid value for "+t+": out of range ("+(void 0!==r?r:"...")+"-"+(void 0!==o?o:"...")+"). The setting will be changed to fit the valid range."),void 0!==r&&(i=Math.max(r,i)),void 0!==o&&(i=Math.min(i,o))),a&&!a(i,h)?(_showCheckFailError(t,i,s,l),null!==s?n.getNumberValueInRange(t,s,r,o,null,a,l,h):null):i):(_showTypeError("a number",t,i,s),null!==s?n.getNumberValueInRange(t,s,r,o,null,a,l,h):null)},n.getStringValue=function(t,e,i,r,o,s){return"string"==typeof e?r&&!r(e,s)?(_showCheckFailError(t,e,i,o),null!==i?n.getStringValue(t,i,null,r,o,s):null):e:(_showTypeError("a string",t,e,i),null!==i?n.getStringValue(t,i,null,r,o,s):null)},n.getEnumValue=function(r,o,s){var a=t.getSafeEnumValue(r,o);if(s=s||{},s.name=s.name||"unnamed enum "+r.constructor.name,null!==a){if(!s.checkFunction||s.checkFunction(a,s.parentObject))return a;s.error=i.CHECK_FAIL_ERROR,s.silentFallback?_logCheckFailError(s.name,a,s.defaultValue,s.checkFailMessage):_showCheckFailError(s.name,a,s.defaultValue,s.checkFailMessage)}else{if("object"!=typeof r||0===Object.keys(r).length)return s.error=i.INVALID_ENUM_OBJECT_ERROR,e.showError("Invalid enum object specified for "+s.name+": "+r+", and thus its value ("+o+") cannot be verified!"),null;s.error=i.ENUM_VALUE_ERROR,s.silentFallback?_logEnumValueError(s.name,o,r,s.defaultValue):_showEnumValueError(s.name,o,r,s.defaultValue)}return null!==s.defaultValue?(o=s.defaultValue,s.defaultValue=null,n.getEnumValue(r,o,s)):null},n.getObjectValue=function(t,e,i,r,o,s){return"object"==typeof e?r&&!r(e,s)?(_showCheckFailError(t,e,i,o),null!==i?n.getObjectValue(t,i,null,r,o,s):null):e:(_showTypeError("an object",t,e,i),null!==i?n.getObjectValue(t,i,null,r,o,s):null)},n.getValueOfType=function(t,i,r,o,s,a,l,h,u){if(a=a||{},void 0===r)return void 0!==o?null!==o?n.getValueOfType(t,i,o,null,s,a,l,h,u):null:void(s||e.showError("Missing required value of '"+t+"'!"));if("object"==typeof i)return i.baseType?n.getValueOfType(t,i.baseType,r,o,s,i,l,h,u):n.getVerifiedObject(t,r,i);switch(i){case"boolean":return n.getBooleanValue(r,{name:t,defaultValue:o,checkFunction:l,checkFailMessage:h,parentObject:u});case"number":return a.range?n.getNumberValueInRange(t,r,a.range[0],a.range[1],o,l,h,u):n.getNumberValue(t,r,o,l,h,u);case"string":return n.getStringValue(t,r,o,l,h,u);case"enum":return a.values?n.getEnumValue(a.values,r,{name:t,defaultValue:o,checkFunction:l,checkFailMessage:h,parentObject:u}):(e.showError("Missing enum definition object for '"+t+"'!"),null);case"object":return a.properties?n.getVerifiedObject(t,r,a.properties):n.getObjectValue(t,r,o,l,h,u);case"array":return n.getArrayValue(t,r,a.elementType,a.elementTypeParams,a,o,l,h,a.elementCheck,a.elementCheckFailMessage,u);default:return e.showError("Unknown type specified for '"+t+"': "+i),null}},n.getArrayValue=function(t,i,r,o,s,a,l,h,u,c,p){var d,_=[];if(i instanceof Array){if(void 0!==s){if(void 0!==s.length&&i.length!==s.length)return e.showError("Invalid array length for '"+t+"'! Expected a length of "+s.length+" and got "+i.length+(a?". Using default value ["+a.join(", ")+"] instead.":".")),a?n.getArrayValue(t,a,r,o,s,null,l,h,u,c,p):null;if(void 0!==s.minLength&&i.length<s.minLength)return e.showError("Invalid array length for '"+t+"'! Expected a minimum length of "+s.minLength+" and got "+i.length+(a?". Using default value ["+a.join(", ")+"] instead.":".")),a?n.getArrayValue(t,a,r,o,s,null,l,h,u,c,p):null;if(void 0!==s.maxLength&&i.length>s.maxLength)return e.showError("Invalid array length for '"+t+"'! Expected a maximum length of "+s.maxLength+" and got "+i.length+(a?". Using default value ["+a.join(", ")+"] instead.":".")),a?n.getArrayValue(t,a,r,o,s,null,l,h,u,c,p):null}return void 0!==r&&(i.forEach(function(e,i){d=n.getValueOfType(t+"["+i+"]",r,e,null,!1,o,u,c,p),null!==d&&_.push(d)}),i=_),l&&!l(i)?(_showCheckFailError(t,i,"["+a.join(", ")+"]",h),null!==a?n.getArrayValue(t,a,r,o,s,null,l,h,u,c,p):null):i}return _showTypeError("an array",t,i,a),null!==a?n.getArrayValue(t,a,r,o,s,null,l,h,u,c,p):null},n.getVerifiedObject=function(t,i,r,o,s,a,l){var h,u,c,p,d,_,g=o||{},m=[];if("object"==typeof i){for(u in r)if(r.hasOwnProperty(u)){if(c=r[u],g[c.name]&&e.showError("'"+t+"' already has a property named '"+c.name+"', which will be overridden by a new value!"),!c.type&&!l)for(p={},_=Object.keys(c),d=0;d<_.length;d++)"object"==typeof c[_[d]]&&(p[_[d]]=c[_[d]]);g[c.name]=n.getValueOfType(t+"."+c.name,c.type||p||l,i[c.name],c.defaultValue,c.optional,{range:c.range,values:c.values,elementType:c.elementType,elementEnumObject:c.elementEnum,length:c.length,minLength:c.minLength,maxLength:c.maxLength,elementCheck:c.elementCheck,elementCheckFailMessage:c.elementCheckFailMessage,properties:c.properties},c.check,c.checkFailMessage,i),m.push(c.name)}if(!a||s)for(h in i)i.hasOwnProperty(h)&&m.indexOf(h)<0&&(a||e.showError("Unrecognized property '"+h+"' defined for '"+t+"'. The value of this property "+(l?"can be verified only against the default property type":"cannot be verified ")+(s?"but will be included.":"and will be discarded.")),s&&(l?g[h]=n.getValueOfType(t+"."+h,l,i[h]):g[h]=i[h]));return g}return e.showError("Invalid value for '"+t+"'. Expected an object, got a(n) "+typeof i+" ("+i+")."),null},n.getBooleanValueFromLocalStorage=function(t,e){var i;return i=localStorage[t]===(!0).toString()?!0:localStorage[t]===(!1).toString()?!1:localStorage[t],e=e||{},e.name=e.name||"localStorage."+t,n.getBooleanValue(i,e)},n.getNumberValueFromLocalStorage=function(t,e){var i=parseFloat(localStorage[t]);return isNaN(i)&&(i=localStorage[t]),e=e||{},e.name=e.name||"localStorage."+t,n.getNumberValue(e.name,i,e.defaultValue,e.checkFunction,e.checkFailMessage,e.parentObject,e.silentFallback)},n.getEnumValueFromLocalStorage=function(t,e,i){return i=i||{},i.name=i.name||"localStorage."+e,n.getEnumValue(t,localStorage[e],i)},n.getValueOfTypeFromLocalStorage=function(t,i,r){if("object"==typeof t)return r.values=t.values,n.getValueOfTypeFromLocalStorage(t.baseType,i,r);switch(t){case"boolean":return n.getBooleanValueFromLocalStorage(i,r);case"number":return n.getNumberValueFromLocalStorage(i,r);case"enum":return n.getEnumValueFromLocalStorage(r.values,i,r);default:e.crash()}},n.getNameAndValueDefinitionObject=function(t){return{baseType:"object",properties:{NAME:{name:"name",type:"string"},VALUE:{name:t,type:"number"}}}},n.getEnumObjectForArray=function(t){var e,i={};for(e=0;e<t.length;e++)i[t[e]]=t[e];return i},n}),define("modules/strings",["utils/types","modules/application"],function(t,e){"use strict";function _flatten(t){var e,r;for(e in t)if(t.hasOwnProperty(e)&&"object"==typeof t[e]){_flatten(t[e]);for(r in t[e])t[e].hasOwnProperty(r)&&(t[e+i+r]=t[e][r]);delete t[e]}}var i=".",r={},n=null,o={},s={};return r.getLanguage=function(){return n},r.setLanguage=function(t){s.hasOwnProperty(t)?n=t:e.showError("Cannot set language to '"+t+"', as there are no strings loaded for that language!")},r.languageIsLoaded=function(t){return s.hasOwnProperty(t)},r.loadStrings=function(e,i,a){var l;o[e]={},_flatten(i);for(l in a)a.hasOwnProperty(l)&&"object"==typeof a[l]&&t.getVerifiedObject("strings."+l,i,a[l],o[e],!1,!0,"string");s[e]=t.getVerifiedObject("strings."+l,i,{},null,!0,!0,"string"),n||r.setLanguage(e)},r.get=function(t,e,i){return s[n]&&s[n][t.name+(e||"")]||i||t.defaultValue||t.name+(e||"")},r.has=function(t,e){return s[n]&&void 0!==s[n][t.name+(e||"")]},r.CATEGORY_SEPARATOR=i,r}),define("modules/game",["modules/application","modules/screen-manager","modules/strings"],function(t,e,i){"use strict";var r=!1,n=!1,o=!1,s=null,a=null,l=null,h=null,u=null,c=null,p=null,d=function(){r&&n&&o&&(t.log("Initialization of "+s+" completed."),document.body.firstElementChild.style.display="none",e.setCurrentScreen(a))},_=function(){t._buildScreensAndExecuteCallback(function(){o=!0,d()})},g=function(e){t.requestTextFile(e.folder,e.filename,function(e){var i=JSON.parse(e);t.log("Loading game settings...",1),t._loadGameSettingsAndExecuteCallback(i,function(){t.log("Game settings loaded.",1),n=!0,_()})})},m=function(){t.requestTextFile(l,h,function(e){var i=JSON.parse(e);t.log("Loading game configuration..."),t.setFolders(i.folders),t.setLogVerbosity(i.logVerbosity),t.setVersion(i.version),t.setDebugVersion(i.debugVersion),t.log("Game version is: "+t.getVersion(),1),u=i.defaultLanguage,c=i.configFiles.strings,requirejs(["modules/media-resources"],function(e){t._loadGameConfigurationAndExecuteCallback(i,function(){e.requestConfigLoad(i.dataFiles.media.resources,function(){t.log("Game configuration loaded."),r=!0}),g(i.configFiles.settings)})})})};return t._loadGameSettingsAndExecuteCallback=function(){t.showError("You need to override the _loadGameSettings method!")},t._loadGameConfigurationAndExecuteCallback=function(){t.showError("You need to override the _loadGameConfiguration method!")},t._buildScreensAndExecuteCallback=function(){t.showError("You need to override the _buildScreensAndExecuteCallback method!")},t.setGameName=function(t){s=t},t.setStartScreenName=function(t){a=t},t.setConfigFolder=function(t){l=t},t.setConfigFileName=function(t){h=t},t.getDefaultLanguage=function(){return u},t.getLanguage=function(){return i.getLanguage()||u},t.getLanguages=function(){return Object.keys(c)},t.getDefaultCursor=function(){return p},t.requestLanguageChange=function(r,n,o){return c&&c[r]?(i.languageIsLoaded(r)?(i.setLanguage(r),e.updateAllScreens(),o(!1)):t.requestTextFile(c[r].folder,c[r].filename,function(t){i.loadStrings(r,JSON.parse(t),n),i.setLanguage(r),e.updateAllScreens(),o(!0)}),!0):(t.showError("Cannot change application language to '"+r+"' as there is no strings file set for this langauge!"),!1)},t.initialize=function(e){return t.log("Initializing "+s+"..."),t.useElectron(e.electron),t.usesElectron()||"file:"!==location.protocol?(p=document.body.style.cursor,void m()):void this.showError("Trying to run the game from the local filesystem!",t.ErrorSeverity.CRITICAL,"This application can only be run through a web server. If you wish to run it from your own computer, you have to install, set up and start a web server first. You have to put the folder containing the files of this game (assume it is called 'game') to the HTML serving folder of the web server, then you can start the game by entering 'localhost/game' in your browser's address bar.")},t.getScreen=e.getScreen,t.setScreen=e.setCurrentScreen,t.addScreen=e.addScreen,t.closeSuperimposedScreen=e.closeSuperimposedScreen,t.closeOrNavigateTo=e.closeOrNavitageTo,t.updateAllScreens=e.updateAllScreens,t.executeWhenAllScreensReady=e.executeWhenReady,t}),define("modules/components",["utils/utils","modules/application","modules/async-resource","modules/strings"],function(t,e,i,r){"use strict";function _isModelLoadedForSource(t){return F[t]&&!!F[t].model}function _getModelForSource(t){return F[t]&&F[t].model}function _isModelRequestedForSource(t){return F[t]&&F[t].requested}function _requestModelForSource(t,i){_isModelRequestedForSource(t)?_isModelLoadedForSource(t)?i&&i():F[t].onLoadQueue.push(i):(F[t]={},F[t].requested=!0,F[t].onLoadQueue=[i],e.requestTextFile(o,t,function(e){var i;for(F[t].model=document.implementation.createHTMLDocument(),F[t].model.documentElement.innerHTML=e,i=0;i<F[t].onLoadQueue.length;i++)F[t].onLoadQueue[i]()}))}function _getLabelText(t){return t.caption||r.get({name:t.id})}function clearStoredDOMModels(){F={}}function SimpleComponent(t,e,i){this._name=t,this._elementID=e||t,this._element=null,this._displayStyle=null,this._onShow=i?i[x]:null,this._onHide=i?i[b]:null,this._onEnable=i?i[O]:null,this._onDisable=i?i[R]:null,this._onSelect=i?i[A]:null,this._onUnselect=i?i[I]:null}function ExternalComponent(t,e,r){i.AsyncResource.call(this),this._name=t,this._rootElementID=t,this._htmlFilename=e,this._style=r||{},this._rootElement=null,this._rootElementDefaultDisplayMode=null,this._cssLoaded=!1,this._simpleComponents=[],e&&this.requestModelLoad()}function LoadingBox(t,e,i,r){ExternalComponent.call(this,t,e,i),this._progress=this.registerSimpleComponent(a),this._status=this.registerSimpleComponent(l),this._header=this.registerSimpleComponent(h),this._headerID=r}function InfoBox(t,e,i,r,n,o){ExternalComponent.call(this,t,e,i),this._onShow=o?o[x]:null,this._onHide=o?o[b]:null,this._onButtonSelect=o?o[v]:null,this._onButtonClick=o?o[N]:null,this._message=this.registerSimpleComponent(u),this._okButton=this.registerSimpleComponent(c,this._onButtonSelect?{select:function(){this._onButtonSelect(this._okButton.isEnabled())}.bind(this)}:null),this._header=this.registerSimpleComponent(p),this._headerID=r,this._okButtonID=n,this._handleKeyUp=function(t){t.keyCode===S?this._okButton.getElement().onclick():(t.keyCode===y||t.keyCode===T)&&this._okButton.select()}.bind(this)}function MenuComponent(t,e,i,r,n){var o;for(ExternalComponent.call(this,t,e,i),this._menuOptions=r,o=0;o<this._menuOptions.length;o++)void 0===this._menuOptions[o].enabled&&(this._menuOptions[o].enabled=!0);this._selectedIndex=-1,this._onOptionSelect=n?n[L]:null,this._onOptionClick=n?n[D]:null,this._validateStyle(i)}function ListComponent(t,e,i,r,n,o){var s;for(ExternalComponent.call(this,t,e,i),this._listElements=r,s=0;s<this._listElements.length;s++)void 0===this._listElements[s].enabled&&(this._listElements[s].enabled=!0);this._subcaptions=n,this._highlightedIndex=-1,this._selectedIndex=-1,this._onElementHighlight=o?o[P]:null,this._onElementSelect=o?o[w]:null,this._validateStyle(i)}function Selector(t,e,i,r,n){ExternalComponent.call(this,t,e,i),this._propertyLabelDescriptor=r,this._valueList=n,this._valueIndex=0,this._propertyLabel=this.registerSimpleComponent(d),this._valueSelector=this.registerSimpleComponent(_),this.onChange=null}function Slider(t,e,i,r,n,o){ExternalComponent.call(this,t,e,i),this._propertyLabelDescriptor=r,n=n||{},this._min=n.valueList?0:n.min,this._max=n.valueList?n.valueList.length-1:n.max,this._default=n["default"],this._step=n.valueList?1:void 0!==n.step?n.step:1,this._valueList=n.valueList||null,this._propertyLabel=this.registerSimpleComponent(g),this._slider=this.registerSimpleComponent(m),this._valueLabel=this.registerSimpleComponent(f),this.onChange=o||null}var n="_",o="component",s="css",a="progress",l="status",h="header",u="message",c="okButton",p="header",d="property",_="value",g="property",m="slider",f="valueLabel",S=13,y=38,T=40,E="disabled",C="selected",M="highlighted",x="show",b="hide",O="enable",R="disable",A="select",I="unselect",v="buttonselect",N="buttonclick",L="optionselect",D="optionclick",P="elementhighlight",w="elementselect",V="data-translation-key",F={};return SimpleComponent.prototype.getName=function(){return this._name},SimpleComponent.prototype.setElementID=function(t){this._elementID=t,this._element&&this._element.setAttribute("id",this._elementID)},SimpleComponent.prototype.getElement=function(){
return this._element},SimpleComponent.prototype.getContent=function(){return this._element.innerHTML},SimpleComponent.prototype.setContent=function(e,i){this._element.innerHTML=i?t.formatString(e,i):e},SimpleComponent.prototype.customizeContent=function(e){this._element.innerHTML=t.formatString(this._element.innerHTML,e)},SimpleComponent.prototype.getAttribute=function(t){return this._element[t]},SimpleComponent.prototype.setAttribute=function(t,e){this._element[t]=e},SimpleComponent.prototype.initComponent=function(){this._element=document.getElementById(this._elementID),this._element?this._displayStyle=this._element.style.display:e.showError("Cannot initialize component: '"+this._name+"'!",e.ErrorSeverity.SEVERE,"No element can be found on the page with a corresponding ID: '"+this._elementID+"'!")},SimpleComponent.prototype.resetComponent=function(){this._element=null,this._displayStyle=null},SimpleComponent.prototype.isVisible=function(){return"none"!==this._element.style.display},SimpleComponent.prototype.hide=function(){this.isVisible()&&(this._element.style.display="none",this._onHide&&this._onHide())},SimpleComponent.prototype.show=function(){this.isVisible()||(this._element.style.display=this._displayStyle,this._onShow&&this._onShow())},SimpleComponent.prototype.setVisible=function(t){t?this.show():this.hide()},SimpleComponent.prototype.isEnabled=function(){return!this._element.classList.contains(E)},SimpleComponent.prototype.disable=function(){this.isEnabled()&&(this._element.classList.add(E),this._onDisable&&this._onDisable())},SimpleComponent.prototype.enable=function(){this.isEnabled()||(this._element.classList.remove(E),this._onEnable&&this._onEnable())},SimpleComponent.prototype.isSelected=function(){return this._element.classList.contains(C)},SimpleComponent.prototype.select=function(){this.isSelected()||(this._element.classList.add(C),this._onSelect&&this._onSelect())},SimpleComponent.prototype.unselect=function(){this.isSelected()&&(this._element.classList.remove(C),this._onUnselect&&this._onUnselect()),this._element.blur()},ExternalComponent.prototype=new i.AsyncResource,ExternalComponent.prototype.constructor=ExternalComponent,ExternalComponent.prototype.getName=function(){return this._name},ExternalComponent.prototype.setRootElementID=function(t){var i;if(this._rootElement)e.showError("Attempting to change the root element ID for external component '"+this._name+"' after it has already been added to the page!");else for(this._rootElementID=t,i=0;i<this._simpleComponents.length;i++)this._simpleComponents[i].setElementID(this._getElementID(this._simpleComponents[i].getName()))},ExternalComponent.prototype.requestModelLoad=function(){this._style.cssFilename?(this._cssLoaded=!1,e.requestCSSFile(s,this._style.cssFilename,function(){this._cssLoaded=!0,_isModelLoadedForSource(this._htmlFilename)&&this.setToReady()}.bind(this))):this._cssLoaded=!0,_requestModelForSource(this._htmlFilename,function(){this._cssLoaded===!0&&this.setToReady()}.bind(this))},ExternalComponent.prototype.appendToPage=function(t){var e,i;for(t=t||document.body,this._rootElement=t.appendChild(document.importNode(_getModelForSource(this._htmlFilename).body.firstElementChild,!0)),this._rootElement.setAttribute("id",this._rootElementID),this._rootElementDefaultDisplayMode=this._rootElement.style.display,e=this._rootElement.querySelectorAll("[id]"),i=0;i<e.length;i++)e[i].setAttribute("id",this._getElementID(e[i].getAttribute("id")));this._initializeComponents()},ExternalComponent.prototype._getElementID=function(t){return this._rootElementID+n+t},ExternalComponent.prototype._getOriginalElementID=function(t){return t.getAttribute("id").substr(this._rootElementID.length+n.length)},ExternalComponent.prototype._initializeComponents=function(){var t;if(this._rootElement)for(t=0;t<this._simpleComponents.length;t++)this._simpleComponents[t].initComponent();else e.log("WARNING! Attempting to initaialize external component "+this._name+" before appending it to the page! It will be initialized automatically once it is added.")},ExternalComponent.prototype.updateComponents=function(){var t,i;if(this._rootElement)for(i=this._rootElement.querySelectorAll("["+V+"]"),t=0;t<i.length;t++)i[t].innerHTML=r.get({name:i[t].getAttribute(V),defaultValue:i[t].innerHTML});else e.log("WARNING! Attempting to update external component "+this._name+" before appending it to the page!")},ExternalComponent.prototype.registerSimpleComponent=function(t,e){var i=new SimpleComponent(t,this._getElementID(t),e);return this._simpleComponents.push(i),i},ExternalComponent.prototype.resetComponent=function(){var t;for(this.resetResource(),t=0;t<this._simpleComponents.length;t++)this._simpleComponents[t].resetComponent()},ExternalComponent.prototype.isVisible=function(){return!("none"===this._rootElement.style.display)},ExternalComponent.prototype.show=function(){if(this._rootElement){if(!this.isVisible())return this._rootElement.style.display=this._rootElementDefaultDisplayMode,!0}else e.log("WARNING! Attempting to show external component "+this._name+" before appending it to the page!");return!1},ExternalComponent.prototype.hide=function(){if(this._rootElement){if(this.isVisible())return this._rootElement.style.display="none",!0}else e.log("WARNING! Attempting to hide external component "+this._name+" before appending it to the page!");return!1},LoadingBox.prototype=new ExternalComponent,LoadingBox.prototype.constructor=LoadingBox,LoadingBox.prototype._initializeComponents=function(){ExternalComponent.prototype._initializeComponents.call(this),this._rootElement&&(this._headerID&&this._header.setElementID(this._getElementID(this._headerID)),this.hide())},LoadingBox.prototype.setMaxProgress=function(t){this._rootElement?this._progress.getElement().max=t:e.log("WARNING! Attempting to update the maximum progress value of loading box"+this._name+" before appending it to the page!")},LoadingBox.prototype.updateProgress=function(t){this._rootElement?this._progress.getElement().value=t:e.log("WARNING! Attempting to update the progress value of loading box"+this._name+" before appending it to the page!")},LoadingBox.prototype.updateStatus=function(t,i,r){this._rootElement?(this._status.setContent(t,i),void 0!==r&&this.updateProgress(r)):e.log("WARNING! Attempting to update the status message of loading box"+this._name+" before appending it to the page!")},InfoBox.prototype=new ExternalComponent,InfoBox.prototype.constructor=InfoBox,InfoBox.prototype._initializeComponents=function(){ExternalComponent.prototype._initializeComponents.call(this),this._rootElement&&(this._headerID&&this._header.setElementID(this._getElementID(this._headerID)),this._okButtonID&&this._okButton.setElementID(this._getElementID(this._okButtonID)),this._okButton.getElement().onmouseenter=function(){this._okButton.select()}.bind(this),this._okButton.getElement().onmouseleave=function(){this._okButton.unselect()}.bind(this),this._okButton.getElement().onclick=function(){return this._onButtonClick&&this._onButtonClick(this._okButton.isEnabled()),this.hide(),!1}.bind(this),ExternalComponent.prototype.hide.call(this))},InfoBox.prototype.show=function(){return ExternalComponent.prototype.show.call(this)?(this._okButton.unselect(),document.addEventListener("keyup",this._handleKeyUp),this._onShow&&this._onShow(),!0):!1},InfoBox.prototype.hide=function(){return ExternalComponent.prototype.hide.call(this)?(document.removeEventListener("keyup",this._handleKeyUp),this._onHide&&this._onHide(),!0):!1},InfoBox.prototype.updateMessage=function(t,i){this._rootElement?this._message.setContent(t,i):e.log("WARNING! Attempting to update the message of info box"+this._name+" before appending it to the page!")},MenuComponent.prototype=new ExternalComponent,MenuComponent.prototype.constructor=MenuComponent,MenuComponent.prototype._validateStyle=function(t){return"object"!=typeof t?void e.showError("Invalid menu style specified: not an object!"):(t.selectedButtonClassName||e.showError("Attempting to specify a menu style without specifying a class for selected menu buttons!"),void(t.disabledClassName||e.showError("Attempting to specify a menu style without specifying a class for disabled menu buttons!")))},MenuComponent.prototype._selectIndex=function(t){t!==this._selectedIndex&&(this._selectedIndex>=0&&(this._menuOptions[this._selectedIndex].element.classList.remove(this._style.selectedButtonClassName),this._menuOptions[this._selectedIndex].element.blur()),this._selectedIndex=t,this._selectedIndex>=0&&this._menuOptions[this._selectedIndex].enabled&&(this._menuOptions[this._selectedIndex].element.classList.add(this._style.selectedButtonClassName),this._onOptionSelect&&this._onOptionSelect(!0)))},MenuComponent.prototype._getMenuClickHandler=function(t){return function(){return this._menuOptions[t].enabled&&(this._selectIndex(t),this._menuOptions[t].action()),this._onOptionClick&&this._onOptionClick(this._menuOptions[t].enabled),!1}.bind(this)},MenuComponent.prototype._getMenuMouseMoveHandler=function(t){return function(){this._menuOptions[t].enabled&&this._selectIndex(t)}.bind(this)},MenuComponent.prototype._initializeComponents=function(){var t,e,i;if(ExternalComponent.prototype._initializeComponents.call(this),this._rootElement){for(this._rootElement.classList.add(this._style.menuClassName),t=0;t<this._menuOptions.length;t++)e=document.createElement("a"),this._menuOptions[t].id&&(e.id=this._getElementID(this._menuOptions[t].id),e.setAttribute(V,this._menuOptions[t].id)),e.href="#",e.className=(this._style.menuClassName||"")+" "+(this._style.buttonClassName||"")+(this._menuOptions[t].enabled?"":this._style.disabledClassName),e.innerHTML=_getLabelText(this._menuOptions[t]),e.onclick=this._getMenuClickHandler(t),e.onmousemove=this._getMenuMouseMoveHandler(t),this._menuOptions[t].element=e,i=document.createElement("li"),i.className=this._style.buttonContainerClassName||"",i.appendChild(e),this._rootElement.appendChild(i);this._rootElement.onmouseout=this.unselect.bind(this)}},MenuComponent.prototype.unselect=function(){this._selectIndex(-1)},MenuComponent.prototype.selectNext=function(){var t=this._selectedIndex;-1===t&&(t=this._menuOptions.length-1);do this._selectIndex((this._selectedIndex+1)%this._menuOptions.length);while(this._selectedIndex!==t&&!this._menuOptions[this._selectedIndex].enabled);this._menuOptions[this._selectedIndex].enabled||this._selectIndex(-1)},MenuComponent.prototype.selectPrevious=function(){var t=this._selectedIndex;-1===t&&(t=0);do this._selectedIndex>0?this._selectIndex(this._selectedIndex-1):this._selectIndex(this._menuOptions.length-1);while(this._selectedIndex!==t&&!this._menuOptions[this._selectedIndex].enabled);this._menuOptions[this._selectedIndex].enabled||this._selectIndex(-1)},MenuComponent.prototype.activateSelected=function(){this._selectedIndex>=0&&this._menuOptions[this._selectedIndex].element.onclick()},ListComponent.prototype=new ExternalComponent,ListComponent.prototype.constructor=ListComponent,ListComponent.prototype._validateStyle=function(t){return"object"!=typeof t?void e.showError("Invalid menu style specified: not an object!"):(t.disabledElementClassName||e.showError("Attempting to specify a list style without specifying a class for disabled list elements!"),t.selectedElementClassName||e.showError("Attempting to specify a list style without specifying a class for selected list elements!"),void(t.highlightedElementClassName||e.showError("Attempting to specify a list style without specifying a class for highlighted list elements!")))},ListComponent.prototype._highlightIndex=function(t,e){var i;t!==this._highlightedIndex&&(this._highlightedIndex>=0&&this._listElements[this._highlightedIndex].element.classList.remove(this._style.highlightedElementClassName),this._highlightedIndex=t,this._highlightedIndex>=0&&this._listElements[this._highlightedIndex].enabled&&(this._listElements[this._highlightedIndex].element.classList.add(this._style.highlightedElementClassName),e&&(i=this._listElements[this._highlightedIndex].element,i.offsetTop<this._rootElement.scrollTop?this._rootElement.scrollTop=i.offsetTop:i.offsetTop+i.offsetHeight>this._rootElement.scrollTop+this._rootElement.clientHeight&&(this._rootElement.scrollTop=i.offsetTop+i.offsetHeight-this._rootElement.clientHeight)),this._onElementHighlight&&this._onElementHighlight(t,!0)))},ListComponent.prototype._selectIndex=function(t){t!==this._selectedIndex&&((0>t||t>=0&&this._listElements[t].enabled)&&(this._selectedIndex>=0&&this._listElements[this._selectedIndex].element.classList.remove(this._style.selectedElementClassName),this._selectedIndex=t,this._selectedIndex>=0&&this._listElements[this._selectedIndex].element.classList.add(this._style.selectedElementClassName)),this._onElementSelect&&this._onElementSelect(t,t>=0&&this._listElements[t].enabled))},ListComponent.prototype.getHighlightedIndex=function(){return this._highlightedIndex},ListComponent.prototype.getSelectedIndex=function(){return this._selectedIndex},ListComponent.prototype._getElementClickHandler=function(t){return function(){return this._listElements[t].enabled&&(this._highlightIndex(t),this._selectIndex(t)),!1}.bind(this)},ListComponent.prototype._getElementMouseMoveHandler=function(t){return function(){this._listElements[t].enabled?this._highlightIndex(t):this._highlightIndex(-1)}.bind(this)},ListComponent.prototype._initializeComponents=function(){var t,e,i,n,o;if(ExternalComponent.prototype._initializeComponents.call(this),this._rootElement){for(this._rootElement.classList.add(this._style.listContainerClassName),e=document.createElement("ul"),e.classList.add(this._style.listClassName),t=0;t<this._listElements.length;t++)o=document.createElement("li"),o.className=this._style.elementContainerClassName||"",n=document.createElement("a"),n.className=(this._style.elementClassName||"")+" "+(this._listElements[t].enabled?"":this._style.disabledElementClassName),this._listElements[t].element=n,n.onclick=this._getElementClickHandler(t),n.onmousemove=this._getElementMouseMoveHandler(t),o.appendChild(n),i=document.createElement("span"),this._listElements[t].captionID&&i.setAttribute(V,this._listElements[t].captionID),i.className=this._style.captionClassName||"",i.innerHTML=this._listElements[t].caption||r.get({name:this._listElements[t].captionID}),n.appendChild(i),this._subcaptions&&(n.appendChild(document.createElement("br")),i=document.createElement("span"),this._listElements[t].subcaptionID&&i.setAttribute(V,this._listElements[t].subcaptionID),i.className=this._style.subcaptionClassName||"",i.innerHTML=this._listElements[t].subcaption||r.get({name:this._listElements[t].subcaptionID}),n.appendChild(i)),e.appendChild(o);this._rootElement.onmouseleave=this.unhighlight.bind(this),this._rootElement.appendChild(e)}},ListComponent.prototype.unhighlight=function(){this._highlightIndex(-1)},ListComponent.prototype.unselect=function(){this._selectIndex(-1)},ListComponent.prototype.reset=function(){this.unselect(),this.unhighlight(),this._rootElement.scrollTop=0},ListComponent.prototype.highlightNext=function(){var t=this._highlightedIndex;-1===t&&(t=this._listElements.length-1);do this._highlightIndex((this._highlightedIndex+1)%this._listElements.length,!0);while(this._highlightedIndex!==t&&!this._listElements[this._highlightedIndex].enabled);this._listElements[this._highlightedIndex].enabled||this._highlightIndex(-1)},ListComponent.prototype.highlightPrevious=function(){var t=this._highlightedIndex;-1===t&&(t=0);do this._highlightedIndex>0?this._highlightIndex(this._highlightedIndex-1,!0):this._highlightIndex(this._listElements.length-1,!0);while(this._highlightedIndex!==t&&!this._listElements[this._highlightedIndex].enabled);this._listElements[this._highlightedIndex].enabled||this._highlightIndex(-1)},ListComponent.prototype.selectHighlighted=function(){this._highlightedIndex>=0&&this._listElements[this._highlightedIndex].element.onclick()},ListComponent.prototype.executeForListElements=function(t){var e;for(e=0;e<this._listElements.length;e++)t(this._listElements[e].element)},Selector.prototype=new ExternalComponent,Selector.prototype.constructor=Selector,Selector.prototype._initializeComponents=function(){ExternalComponent.prototype._initializeComponents.call(this),this._rootElement&&(this._style.selectorClassName&&(this._rootElement.className=this._style.selectorClassName),this._propertyLabelDescriptor.id&&(this._propertyLabel.setElementID(this._getElementID(this._propertyLabelDescriptor.id)),this._propertyLabel.getElement().setAttribute(V,this._propertyLabelDescriptor.id)),this._propertyLabel.setContent(_getLabelText(this._propertyLabelDescriptor)),this._style.propertyContainerClassName&&(this._propertyLabel.getElement().className=this._style.propertyContainerClassName),this._valueSelector.setContent(this._valueList[0]),this._valueIndex=0,this.setValueList(this._valueList),this._valueSelector.getElement().onclick=function(){return this.selectNextValue(),!1}.bind(this))},Selector.prototype.selectValue=function(t){if(this._rootElement){for(var i=0;i<this._valueList.length&&this._valueList[i]!==t;)i++;i<this._valueList.length?this.selectValueWithIndex(i):e.showError("Attempted to select value: '"+t+"' for '"+_getLabelText(this._propertyLabelDescriptor)+"', which is not one of the available options.",e.ErrorSeverity.MINOR)}else e.showError("Attemted to select value for selector "+this._name+" which is not yet appended to the page!")},Selector.prototype.selectValueWithIndex=function(t){var i=this._valueIndex;this._rootElement?this._valueList.length>t?(this._valueIndex=t,this._valueSelector.setContent(this._valueList[this._valueIndex]),i!==t&&this.onChange&&this.onChange()):e.showError("Attempted to select value with index '"+t+"' for '"+_getLabelText(this._propertyLabelDescriptor)+"', while the available range is: 0-"+(this._valueList.length-1),e.ErrorSeverity.MINOR):e.showError("Attemted to select value for selector "+this._name+" which is not yet appended to the page!")},Selector.prototype.getSelectedValue=function(){return this._valueList[this._valueIndex]},Selector.prototype.getSelectedIndex=function(){return this._valueIndex},Selector.prototype.selectNextValue=function(){this.selectValueWithIndex((this._valueIndex+1)%this._valueList.length)},Selector.prototype.setValueList=function(t){this._valueList=t,this._valueIndex>=this._valueList.length&&(this._valueIndex=0),this._valueList.length<2?this._valueSelector.disable():this._valueSelector.enable()},Slider.prototype=new ExternalComponent,Slider.prototype.constructor=Slider,Slider.prototype._initializeComponents=function(){var t=function(){this._updateValueLabel(),this.onChange&&this.onChange(this.getValue())}.bind(this);ExternalComponent.prototype._initializeComponents.call(this),this._rootElement&&(this._propertyLabelDescriptor.id&&(this._propertyLabel.setElementID(this._getElementID(this._propertyLabelDescriptor.id)),this._propertyLabel.getElement().setAttribute(V,this._propertyLabelDescriptor.id)),this._propertyLabel.setContent(_getLabelText(this._propertyLabelDescriptor)),this._valueList?(this.setValueList(this._valueList),this._valueLabel.show()):(this._valueLabel.hide(),this._updateSlider()),this.setNumericValue(this._default),this._slider.getElement().onchange=t,this._slider.getElement().oninput=t)},Slider.prototype._updateSlider=function(){this._slider.setAttribute("min",this._min),this._slider.setAttribute("max",this._max),this._slider.setAttribute("step",this._step)},Slider.prototype._updateValueLabel=function(){this._valueList&&this._valueLabel.setContent(this._valueList[this.getNumericValue()])},Slider.prototype.setNumericValue=function(t){this._slider.setAttribute("value",t),this._updateValueLabel()},Slider.prototype.setListedValue=function(t){var i;this._valueList?(i=this._valueIndex.indexOf(t),i>=0?this.setNumericValue(i):e.showError("Cannot set listed value '"+t+"' for slider '"+this.getName()+"', because it is not in the value list!")):e.showError("Cannot set listed value '"+t+"' for slider '"+this.getName()+"', because it has no value list!")},Slider.prototype.getNumericValue=function(){return parseFloat(this._slider.getAttribute("value"))},Slider.prototype.getListedValue=function(){return this._valueList[this.getNumericValue()]},Slider.prototype.getValue=function(){return this._valueList?this.getListedValue():this.getNumericValue()},Slider.prototype.setValueList=function(t){var e=this.getNumericValue();this._valueList=t,this._min=0,this._max=t.length-1,this._step=1,e>this._max&&(e=0),this._updateSlider(),this.setNumericValue(e)},{ELEMENT_ID_SEPARATOR:n,DISABLED_CLASS_NAME:E,SELECTED_CLASS_NAME:C,HIGHLIGHTED_CLASS_NAME:M,SHOW_EVENT_NAME:x,HIDE_EVENT_NAME:b,BUTTON_SELECT_EVENT_NAME:v,BUTTON_CLICK_EVENT_NAME:N,OPTION_SELECT_EVENT_NAME:L,OPTION_CLICK_EVENT_NAME:D,TRANSLATION_KEY_ATTRIBUTE:V,clearStoredDOMModels:clearStoredDOMModels,SimpleComponent:SimpleComponent,LoadingBox:LoadingBox,InfoBox:InfoBox,MenuComponent:MenuComponent,ListComponent:ListComponent,Selector:Selector,Slider:Slider}}),define("armada/constants",[],function(){"use strict";var t="Interstellar Armada",e="armada_",i=e+"language",r=e+"version";return{GAME_NAME:t,LOCAL_STORAGE_PREFIX:e,LANGUAGE_LOCAL_STORAGE_ID:i,VERSION_LOCAL_STORAGE_ID:r}}),define("modules/managed-gl",["utils/utils","utils/types","modules/application","modules/async-resource"],function(t,e,i,r){"use strict";function getFloatVectorSize(t){switch(t){case o.NONE:return 0;case o.FLOAT:return 1;case o.VEC2:return 2;case o.VEC3:return 3;case o.VEC4:return 4;case o.MAT2:return 4;case o.MAT3:return 9;case o.MAT4:return 16;case o.SAMPLER2D:return 1;case o.SAMPLER_CUBE:return 1;case o.INT:return 1;case o.BOOL:return 1;default:return i.showError("Cannot determine vector size of GLSL type '"+t+"'!"),0}}function getVectorCount(t){switch(t){case o.NONE:return 0;case o.FLOAT:return 1;case o.VEC2:return 1;case o.VEC3:return 1;case o.VEC4:return 1;case o.MAT2:return 2;case o.MAT3:return 3;case o.MAT4:return 4;case o.SAMPLER2D:return 1;case o.SAMPLER_CUBE:return 1;case o.INT:return 1;case o.BOOL:return 1;default:return i.showError("Cannot determine vector count of GLSL type '"+t+"'!"),0}}function isSamplerType(t){return t===o.SAMPLER2D||t===o.SAMPLER_CUBE}function intValueOfBool(t){return t?1:0}function ManagedTexture(t,e,i){this._name=t,this._image=e,this._mipmap=void 0!==i?i:!0,this._ids={},this._locations={}}function ManagedCubemap(t,e){this._name=t,this._images=e,this._ids={},this._locations={}}function ShaderAttribute(t,e,i){this.name=t,this.size=e,this.role=i}function ShaderUniform(t,r,n,s){this._name=t,this._type=e.getEnumValue(o,r,{name:"uniform "+this._name+".type",defaultValue:o.NONE}),this._arraySize=n||0,this._unpacked=s,this._unpacked&&(!isSamplerType(this._type)||this._arraySize<1)&&(i.showError("Uniform '"+this._name+"' cannot be declared as an unpacked array!"),this._unpacked=!1),this._members=this._type===o.STRUCT?[]:null,this._locations={},this._numericValues={}}function VertexBuffer(t,e,i,r){this._name=t,this._role=e,this._vectorSize=i,this._data=new Float32Array(r*this._vectorSize),this._ids={},this._locations={},this._filledVectors=0}function FrameBuffer(t,e,i,r){this._name=t,this._id=null,this._width=e,this._height=i,this._depthOnly=!!r,this._textureID=null,this._textureLocation=this.TEXTURE_LOCATION_NOT_SET,this._renderBufferID=null}function ManagedShader(t,e,r,n,o,s,a,l){this._name=t,this._blendMode=n,this._vertexAttributes=[],this._instanceAttributes=[],this._uniforms=[],this._vertexShaderSource=e,this._fragmentShaderSource=r,this._ids={},this._instanceAttributeBuffers=[],this._uniformNamesForInstanceAttributeNames=s,this._instanceAttributeNames=Object.keys(s),this._numVertexUniformVectors=0,this._numAttributeVectors=0,this._numVaryingVectors=0,this._numTextureUnits=0,this._numFragmentUniformVectors=0,this._vertexShaderSource?this._fragmentShaderSource?this._parseShaderSources(o,a,l):i.showError("Cannot initialize shader '"+this._name+"': no fragment shader source specified!"):i.showError("Cannot initialize shader '"+this._name+"': no vertex shader source specified!")}function ManagedGLContext(t,e,i,n,o,s){r.AsyncResource.call(this),this._name=t,this._canvas=e,this.gl=null,this._antialiasing=i===!0,this._alpha=void 0===n||n,this._filtering=null,this.anisotropicFilterExt=null,this.instancingExt=null,this.depthTextureExt=null,this._shaders=[],this._models=[],this._vertexBuffers=null,this._boundVertexBuffers=[],this._boundVertexBufferCount=0,this._frameBuffers={},this._currentShader=null,this._currentBlendMode=null,this._currentColorMask=null,this._currentDepthMask=!1,this._blendingEnabled=!1,this._textures=[],this._boundTextures=[],this._maxBoundTextures=0,this._nextTextureBindLocation=0,this._maxTextureSize=0,this._maxCubemapSize=0,this._maxRenderbufferSize=0,this._maxVertexAttributes=0,this._maxVertexShaderUniforms=0,this._maxFragmentShaderUniforms=0,this._maxVaryings=0,this._createContext(s),this.setFiltering(o)}var n={BILINEAR:"bilinear",TRILINEAR:"trilinear",ANISOTROPIC:"anisotropic"},o={NONE:"none",FLOAT:"float",VEC2:"vec2",VEC3:"vec3",VEC4:"vec4",MAT2:"mat2",MAT3:"mat3",MAT4:"mat4",SAMPLER2D:"sampler2D",SAMPLER_CUBE:"samplerCube",INT:"int",BOOL:"bool",STRUCT:"struct"},s={NONE:"none",MIX:"mix",ADD:"add"},a="u_",l="",h="",u="Texture",c="",p="Cubemap",d=null;return Object.freeze(n),Object.freeze(o),ManagedTexture.prototype.getName=function(){return this._name},ManagedTexture.prototype.getLastTextureBindLocation=function(t){return this._locations[t]},ManagedTexture.prototype.forgetLastTextureBindLocation=function(t){delete this._locations[t]},ManagedTexture.prototype.setMinFiltering=function(t,e,i){if(this._mipmap===!1)t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR);else{switch(e){case n.BILINEAR:t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST),i&&t.texParameterf(t.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,1);break;case n.TRILINEAR:t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),i&&t.texParameterf(t.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,1);break;case n.ANISOTROPIC:t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameterf(t.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,4)}t.generateMipmap(t.TEXTURE_2D)}},ManagedTexture.prototype.createGLTexture=function(t,e){this._ids[t]=e.createTexture()},ManagedTexture.prototype.bindGLTexture=function(t,e,i){e.activeTexture(e.TEXTURE0+i),e.bindTexture(e.TEXTURE_2D,this._ids[t]),this._locations[t]=i},ManagedTexture.prototype.setupGLTexture=function(t,e,i){t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._image),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),this.setMinFiltering(t,e,i)},ManagedTexture.prototype.deleteGLTexture=function(t,e){this._ids[t]&&(e.deleteTexture(this._ids[t]),delete this._ids[t],delete this._locations[t])},ManagedCubemap.prototype.getName=function(){return this._name},ManagedCubemap.prototype.getLastTextureBindLocation=function(t){return this._locations[t]},ManagedCubemap.prototype.forgetLastTextureBindLocation=function(t){delete this._locations[t]},ManagedCubemap.prototype.createGLTexture=function(t,e){this._ids[t]=e.createTexture()},ManagedCubemap.prototype.bindGLTexture=function(t,e,i){e.activeTexture(e.TEXTURE0+i),e.bindTexture(e.TEXTURE_CUBE_MAP,this._ids[t]),this._locations[t]=i},ManagedCubemap.prototype.setupGLTexture=function(t){var e,i;for(t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.LINEAR),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),e=[t.TEXTURE_CUBE_MAP_POSITIVE_X,t.TEXTURE_CUBE_MAP_NEGATIVE_X,t.TEXTURE_CUBE_MAP_POSITIVE_Y,t.TEXTURE_CUBE_MAP_NEGATIVE_Y,t.TEXTURE_CUBE_MAP_POSITIVE_Z,t.TEXTURE_CUBE_MAP_NEGATIVE_Z],i=0;6>i;i++)t.texImage2D(e[i],0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._images[i])},ManagedCubemap.prototype.deleteGLTexture=function(t,e){this._ids[t]&&(e.deleteTexture(this._ids[t]),delete this._ids[t],delete this._locations[t])},ShaderUniform.prototype.getName=function(){return this._name},ShaderUniform.prototype.addMember=function(t){this._type===o.STRUCT?this._members.push(t):i.showError("Attempting to add a member to uniform "+this._name+", which is not of struct type!")},ShaderUniform.prototype.saveLocation=function(t,e,i,r){r=r||this._name,this._locations[t]||(this._locations[t]={}),this._locations[t][r]=e.getUniformLocation(i.getIDForContext(t),r)},ShaderUniform.prototype.forgetLocations=function(t){var e,i;if(delete this._locations[t],this._numericValues={},this._members)for(e=0;e<this._arraySize;e++)for(i=0;i<this._members.length;i++)this._members[i].forgetLocations(t)},ShaderUniform.prototype.getLocation=function(t,e,i,r,n){var o=(r||"")+this._name+(n||"");return!r&&!n||this._locations[t]&&void 0!==this._locations[t][o]||this.saveLocation(t,e,i,o),this._locations[t][o]},ShaderUniform.prototype.getArraySize=function(){return this._arraySize},ShaderUniform.prototype.getRawName=function(){var t,e=this._name;return a.length>0&&(t=e.split(a),e=t[t.length-1]),l.length>0&&(e=e.split(l)[0]),e},ShaderUniform.prototype.getTextureType=function(){var t,e;if(this._type!==o.SAMPLER2D)return null;if(t=this.getRawName(),h.length>0){if(e=t.split(h),e.length<2)return null;t=e[e.length-1]}if(u.length>0){if(e=t.split(u),e.length<2)return null;t=e[0]}return t},ShaderUniform.prototype.getCubemapName=function(){var t,e;if(this._type!==o.SAMPLER_CUBE)return null;if(t=this.getRawName(),c.length>0){if(e=t.split(c),e.length<2)return null;t=e[e.length-1]}if(p.length>0){if(e=t.split(p),e.length<2)return null;t=e[0]}return t},ShaderUniform.prototype.getUniformName=function(t){return a+t+l},ShaderUniform.prototype.getTextureUniformRawName=function(t){return h+t+u},ShaderUniform.prototype.getCubemapUniformRawName=function(t){return c+t+p},ShaderUniform.prototype.setConstantValue=function(t,e,r,n,s){var a,l,h,u,c,p;switch(this._unpacked||(a=this.getLocation(t,e,r,s)),this._type){case o.FLOAT:this._arraySize>0?e.uniform1fv(a,n):(s||this._numericValues[t]!==n)&&(e.uniform1f(a,n),this._numericValues[t]=n);break;case o.VEC2:e.uniform2fv(a,n);break;case o.VEC3:e.uniform3fv(a,n);break;case o.VEC4:e.uniform4fv(a,n);break;case o.MAT2:e.uniformMatrix2fv(a,!1,n);break;case o.MAT3:e.uniformMatrix3fv(a,!1,n);break;case o.MAT4:e.uniformMatrix4fv(a,!1,n);break;case o.SAMPLER2D:case o.SAMPLER_CUBE:case o.INT:if(this._arraySize>0)if(this._unpacked)for(l=0;l<n.length;l++)e.uniform1i(this.getLocation(t,e,r,s,l.toString()),n[l]);else e.uniform1iv(a,n);else(s||this._numericValues[t]!==n)&&(e.uniform1i(a,n),this._numericValues[t]=n);break;case o.BOOL:this._arraySize>0?e.uniform1iv(a,n.map(intValueOfBool)):(p=n?1:0,(s||this._numericValues[t]!==p)&&(e.uniform1i(a,p),this._numericValues[t]=p));break;case o.STRUCT:if(u=this._members.length,this._arraySize>0)for(l=0;l<n.length&&null!==n[l];l++)for(h=0;u>h;h++)void 0!==n[l][this._members[h]._name]&&(c=this._members[h]._name,this._members[h].setConstantValue(t,e,r,n[l][c],this._name+"["+l+"]."));else for(l=0;u>l;l++)void 0!==n[this._members[l]._name]&&(c=this._members[l]._name,this._members[l].setConstantValue(t,e,r,n[c],this._name+"."));break;default:i.showError("Attempting to set uniform '"+this._name+"', but it has a type that cannot be handled! ("+(this._arraySize>0?"array ("+this._arraySize+") of ":"")+this._type+")")}},ShaderUniform.prototype.setValue=function(t,e,i,r,n){this.setConstantValue(t,e,i,r(t),n)},ShaderUniform.prototype.getVectorCount=function(){var t,e;if(this._type===o.STRUCT){for(t=0,e=0;e<this._members.length;e++)t+=this._members[e].getVectorCount();return t}return getVectorCount(this._type)*(this._arraySize||1);
},ShaderUniform.prototype.isSamplerType=function(){return isSamplerType(this._type)},VertexBuffer.prototype.getName=function(){return this._name},VertexBuffer.prototype.getRole=function(){return this._role},VertexBuffer.prototype.setData=function(t,e){this._data.set(t,e*this._vectorSize)},VertexBuffer.prototype.getSize=function(){return this._data.length/this._vectorSize},VertexBuffer.prototype.resize=function(t){this._data=new Float32Array(t*this._vectorSize)},VertexBuffer.prototype.addVector=function(t){this._data.set(t,this._filledVectors*this._vectorSize),this._filledVectors++},VertexBuffer.prototype.resetFilledVectors=function(){this._filledVectors=0},VertexBuffer.prototype.freeData=function(){this._data=null},VertexBuffer.prototype.loadToGPUMemory=function(t,e,i){this._ids[t]=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._ids[t]),e.bufferData(e.ARRAY_BUFFER,this._data,e.STATIC_DRAW),i||this.freeData()},VertexBuffer.prototype.bind=function(t,e,r){(void 0===this._locations[e.getName()]||-1===this._locations[e.getName()])&&(this._locations[e.getName()]=t.gl.getAttribLocation(e.getIDForContext(t.getName()),this._name));var n=this._locations[e.getName()];n>=0&&t.getBoundVertexBuffer(n)!==this&&(i.log_DEBUG("Binding "+(r?"instance":"vertex")+" buffer '"+this._name+"' to attribute location "+n+" in shader '"+e.getName()+"'.",3),r?this.loadToGPUMemory(t.getName(),t.gl,!0):t.gl.bindBuffer(t.gl.ARRAY_BUFFER,this._ids[t.getName()]),t.getBoundVertexBuffer(n)||t.gl.enableVertexAttribArray(n),t.gl.vertexAttribPointer(n,this._vectorSize,t.gl.FLOAT,!1,0,0),t.instancingExt&&(r?t.instancingExt.vertexAttribDivisorANGLE(n,1):t.instancingExt.vertexAttribDivisorANGLE(n,0)),t.setBoundVertexBuffer(n,this))},VertexBuffer.prototype["delete"]=function(t){var e,i;t.gl.deleteBuffer(this._ids[t.getName()]);for(e in this._locations)this._locations.hasOwnProperty(e)&&(i=this._locations[e],t.getBoundVertexBuffer(i)===this&&(t.setBoundVertexBuffer(i,null),t.gl.disableVertexAttribArray(i)));delete this._ids[t.getName()],0===Object.keys(this._ids).length&&(this.freeData(),this._locations={})},FrameBuffer.prototype.TEXTURE_LOCATION_NOT_SET=-1,FrameBuffer.prototype.getName=function(){return this._name},FrameBuffer.prototype.getLastTextureBindLocation=function(){return this._textureLocation},FrameBuffer.prototype.forgetLastTextureBindLocation=function(){this._textureLocation=this.TEXTURE_LOCATION_NOT_SET},FrameBuffer.prototype.setup=function(t){var e;if(!this._id)switch(this._id=t.gl.createFramebuffer(),t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,this._id),this._textureID=t.gl.createTexture(),this._textureLocation=t.bindTexture(this),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MAG_FILTER,t.gl.NEAREST),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MIN_FILTER,t.gl.NEAREST),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_WRAP_S,t.gl.CLAMP_TO_EDGE),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_WRAP_T,t.gl.CLAMP_TO_EDGE),this._depthOnly&&t.areDepthTexturesAvailable()?(t.gl.texImage2D(t.gl.TEXTURE_2D,0,t.gl.DEPTH_COMPONENT,this._width,this._height,0,t.gl.DEPTH_COMPONENT,t.gl.UNSIGNED_SHORT,null),t.gl.framebufferTexture2D(t.gl.FRAMEBUFFER,t.gl.DEPTH_ATTACHMENT,t.gl.TEXTURE_2D,this._textureID,0)):(t.gl.texImage2D(t.gl.TEXTURE_2D,0,t.gl.RGBA,this._width,this._height,0,t.gl.RGBA,t.gl.UNSIGNED_BYTE,null),this._renderBufferID=t.gl.createRenderbuffer(),t.gl.bindRenderbuffer(t.gl.RENDERBUFFER,this._renderBufferID),t.gl.renderbufferStorage(t.gl.RENDERBUFFER,t.gl.DEPTH_COMPONENT16,this._width,this._height),t.gl.framebufferTexture2D(t.gl.FRAMEBUFFER,t.gl.COLOR_ATTACHMENT0,t.gl.TEXTURE_2D,this._textureID,0),t.gl.framebufferRenderbuffer(t.gl.FRAMEBUFFER,t.gl.DEPTH_ATTACHMENT,t.gl.RENDERBUFFER,this._renderBufferID)),e=t.gl.checkFramebufferStatus(t.gl.FRAMEBUFFER)){case t.gl.FRAMEBUFFER_COMPLETE:i.log_DEBUG("Framebuffer '"+this._name+"' successfully created.",2);break;case t.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete.");break;case t.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': Attachment missing.");break;case t.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': Height and width of the attachment are not the same.");break;case t.gl.FRAMEBUFFER_UNSUPPORTED:i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': The format of the attachment is not supported or depth and stencil attachments are not the same renderbuffer.");break;default:i.showGraphicsError("Unknown framebuffer status for '"+this._name+"' ("+e+")!")}},FrameBuffer.prototype.bind=function(t){t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,this._id)},FrameBuffer.prototype.bindGLTexture=function(t,e){t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_2D,this._textureID),this._textureLocation=e},FrameBuffer.prototype["delete"]=function(t){t.gl.deleteTexture(this._textureID),this._depthOnly&&t.areDepthTexturesAvailable()||t.gl.deleteRenderbuffer(this._renderBufferID),t.gl.deleteFramebuffer(this._id),this._id=null},ManagedShader.prototype._hasUniform=function(t){var e;for(e=0;e<this._uniforms.length;e++)if(this._uniforms[e].getName()===t)return!0;return!1},ManagedShader.prototype._getUniform=function(t){var e;for(e=0;e<this._uniforms.length;e++)if(this._uniforms[e].getName()===t)return this._uniforms[e];return null},ManagedShader.prototype._parseShaderSources=function(e,r,n){var s,a,l,h,u,c,p,d,_,g,m,f,S,y,T,E,C,M,x,b=0,O=1,R={},A={},I=function(t){return""!==t},v=function(t){return"highp"===t||"mediump"===t||"lowp"===t},N=function(e){return t.getSafeEnumValue(o,e,o.NONE)!==o.NONE},L=function(t,e){var i,r,n,o;for(i=!1,n=0;n<u.length;n++)if(r=u[n].split(" "),i){if(r=r.filter(I),r.length>0&&"}"===r[r.length-1].split(";")[0])break;r.length>=2&&(o=v(r[0])?1:0,t.addMember(new ShaderUniform(r[o+1].split(";")[0],r[o],0)))}else"struct"===r[0]&&r[1].split("{")[0]===e&&(i=!0)};for(h=0;2>h;h++){switch(h){case b:u=this._vertexShaderSource.split("\n");break;case O:u=this._fragmentShaderSource.split("\n")}for(M=!1,s=0;s<u.length;s++)if(u[s].length>0)if(c=u[s].split(/\s+|[\(\)\[\]\{\}\+\?\-!<>=*\/\^\|\&,;]/),p=u[s].match(/\s+|[\(\)\[\]\{\}\+\?\-!<>=*\/\^\|\&,;]/g),"#define"===c[0])r&&void 0!==r[c[1]]?(R[c[1]]=r[c[1]],c[2]!==r[c[1]]&&(u[s]=u[s].replace(c[2],r[c[1]]),M=!0)):R[c[1]]=c[2];else if(h===b&&"attribute"===c[0])if(d=v(c[1])?3:2,_=c[d],y=c[d-1],g=getFloatVectorSize(y),m=e[_],this._numAttributeVectors+=getVectorCount(y),void 0===m){if(!this._uniformNamesForInstanceAttributeNames.hasOwnProperty(_))return void i.showError("Role for attribute named '"+_+"' not found for shader '"+this._name+"'!");m=this._uniformNamesForInstanceAttributeNames[_],this._instanceAttributes.push(new ShaderAttribute(_,g,m))}else this._vertexAttributes.push(new ShaderAttribute(_,g,m));else if("uniform"===c[0]){if(d=v(c[1])?3:2,S=c[d],y=c[d-1],this._hasUniform(S)===!1){if("["===p[d]){if(C=!1,E=c[d+1],R[E]&&(E=R[E]),T=parseInt(E,10),isSamplerType(y)&&n){for(u[s]="",a=0;T>a;a++){for(l=0;d>l;l++)u[s]+=c[l],u[s]+=p[l];u[s]+=S+a.toString()+";\n"}M=!0,C=!0}}else T=0;N(y)?this._uniforms.push(new ShaderUniform(S,y,T,C)):(f=new ShaderUniform(S,"struct",T),L(f,y),this._uniforms.push(f))}switch(h){case b:this._numVertexUniformVectors+=this._getUniform(S).getVectorCount();break;case O:this._numFragmentUniformVectors+=this._getUniform(S).getVectorCount(),isSamplerType(y)&&(this._numTextureUnits+=this._getUniform(S).getVectorCount());break;default:i.crash()}}else if("varying"===c[0])d=v(c[1])?3:2,y=c[d-1],h===O&&("["===p[d]?(E=c[d+1],R[E]&&(E=R[E]),T=parseInt(E,10)):T=1,this._numVaryingVectors+=getVectorCount(y)*T);else{for(d=0;""===c[d];)d++;if(N(c[d])||v(c[d]))d=v(c[d])?d+2:d+1,"["===p[d]&&(E=c[d+1],R[E]&&(E=R[E]),A[c[d]]=parseInt(E,10));else{for(a=0;a<this._uniforms.length;a++)if(d=c.indexOf(this._uniforms[a].getName()),d>=0&&this._uniforms[a].getArraySize()>0&&"["===p[d]){if(parseInt(c[d+1],10).toString()===c[d+1]&&parseInt(c[d+1],10)>=this._uniforms[a].getArraySize()){u[s]="",M=!0;break}if(this._uniforms[a].isSamplerType()&&n){for(u[s]="",l=0;d>l;l++)u[s]+=c[l],u[s]+=p[l];for(u[s]+=c[d]+c[d+1],l=d+2;l<p.length;l++)u[s]+=c[l],u[s]+=p[l];u[s]+=c[c.length-1],M=!0;break}}for(x=Object.keys(A),a=0;a<x.length;a++)if(d=c.indexOf(x[a]),d>=0&&"["===p[d]&&parseInt(c[d+1],10).toString()===c[d+1]&&parseInt(c[d+1],10)>=A[c[d]]){u[s]="",M=!0;break}}}if(M)switch(h){case b:this._vertexShaderSource=u.join("\n");break;case O:this._fragmentShaderSource=u.join("\n")}}},ManagedShader.prototype.getName=function(){return this._name},ManagedShader.prototype.getIDForContext=function(t){return this._ids[t]},ManagedShader.prototype.getVertexAttributes=function(){return this._vertexAttributes},ManagedShader.prototype.getVertexAttribute=function(t){var e;for(e=0;e<this._vertexAttributes.length;e++)if(this._vertexAttributes[e].name===t)return this._vertexAttributes[e];return null},ManagedShader.prototype.getInstanceAttribute=function(t){var e;for(e=0;e<this._instanceAttributes.length;e++)if(this._instanceAttributes[e].name===t)return this._instanceAttributes[e];return null},ManagedShader.prototype.setupGLProgram=function(t,e){var r,n,o,s,a;if(!this._vertexShaderSource||!this._fragmentShaderSource)return i.log("ERROR: Cannot set up GL shader program for '"+this._name+"', because the vertex or fragment shader source is missing!",1),void(this._ids[t]=null);if(r=e.createShader(e.VERTEX_SHADER),e.shaderSource(r,this._vertexShaderSource),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS))return n=e.getShaderInfoLog(r),i.showGraphicsError("Compiling GLSL vertex shader of '"+this._name+"' failed.",i.ErrorSeverity.SEVERE,"More details:\n"+n,e),void(this._ids[t]=null);if(o=e.createShader(e.FRAGMENT_SHADER),e.shaderSource(o,this._fragmentShaderSource),e.compileShader(o),!e.getShaderParameter(o,e.COMPILE_STATUS))return n=e.getShaderInfoLog(o),i.showGraphicsError("Compiling GLSL fragment shader of '"+this._name+"' failed.",i.ErrorSeverity.SEVERE,"More details:\n"+n,e),void(this._ids[t]=null);if(this._ids[t]=e.createProgram(),s=this._ids[t],e.attachShader(s,r),e.attachShader(s,o),e.linkProgram(s),!e.getProgramParameter(s,e.LINK_STATUS))return n=e.getProgramInfoLog(s),i.showGraphicsError("Linking GLSL shader '"+this._name+"' failed.",i.ErrorSeverity.SEVERE,"More details: "+n,e),e.deleteProgram(s),void(this._ids[t]=null);for(a=0;a<this._uniforms.length;a++)this._uniforms[a].saveLocation(t,e,this)},ManagedShader.prototype.getBlendMode=function(){return this._blendMode},ManagedShader.prototype.assignUniforms=function(t,e){var i;if(t.setCurrentShader(this),e)for(i=0;i<this._uniforms.length;i++)void 0!==e[this._uniforms[i].getName()]&&this._uniforms[i].setValue(t.getName(),t.gl,this,e[this._uniforms[i].getName()])},ManagedShader.prototype.bindVertexBuffers=function(t){var e;for(e=0;e<this._vertexAttributes.length;e++)t.getVertexBuffer(this._vertexAttributes[e].name).bind(t,this);t.disableUnusedVertexBuffers(this._vertexAttributes.length)},ManagedShader.prototype.getUniformArrayLength=function(t){var e;for(e=0;e<this._uniforms.length;e++)if(this._uniforms[e].getName()===t)return this._uniforms[e].getArraySize();return 0},ManagedShader.prototype.getTextureTypes=function(){var t,e,i=[];for(t=0;t<this._uniforms.length;t++)e=this._uniforms[t].getTextureType(),e&&i.push(e);return i},ManagedShader.prototype.getCubemapNames=function(){var t,e,i=[];for(t=0;t<this._uniforms.length;t++)e=this._uniforms[t].getCubemapName(),e&&i.push(e);return i},ManagedShader.prototype.createInstanceBuffers=function(t,e){var i,r;for(this._instanceAttributeBuffers.length<t+1&&(this._instanceAttributeBuffers=this._instanceAttributeBuffers.concat(new Array(t-this._instanceAttributeBuffers.length+1))),i=0;i<this._instanceAttributeNames.length;i++)r=this._instanceAttributeNames[i],this._instanceAttributeBuffers[t]||(this._instanceAttributeBuffers[t]={}),this._instanceAttributeBuffers[t][r]?(this._instanceAttributeBuffers[t][r].resize(e),this._instanceAttributeBuffers[t][r].resetFilledVectors()):this._instanceAttributeBuffers[t][r]=new VertexBuffer(r,this._uniformNamesForInstanceAttributeNames[r],this.getInstanceAttribute(r).size,e)},ManagedShader.prototype.addDataToInstanceBuffers=function(e,i){var r,n,o;for(r=0;r<this._instanceAttributeNames.length;r++)n=this._instanceAttributeNames[r],o=this._instanceAttributeBuffers[e][n].getRole(),this._instanceAttributeBuffers[e][n].addVector(i[o](t.EMPTY_STRING))},ManagedShader.prototype.bindAndFillInstanceBuffers=function(t,e){var i;for(i=0;i<this._instanceAttributeNames.length;i++)this._instanceAttributeBuffers[e][this._instanceAttributeNames[i]].bind(t,this,!0)},ManagedShader.prototype.deleteInstanceBuffers=function(t){var e,i;for(e=0;e<this._instanceAttributeBuffers.length;e++)for(i=0;i<this._instanceAttributeNames.length;i++)this._instanceAttributeBuffers[e][this._instanceAttributeNames[i]]["delete"](t);this._instanceAttributeBuffers=[]},ManagedShader.prototype.deleteGLProgram=function(t,e){var i;if(this._ids[t]){for(i=0;i<this._uniforms.length;i++)this._uniforms[i].forgetLocations(t);e.deleteProgram(this._ids[t]),delete this._ids[t]}},ManagedShader.prototype.isAllowedByRequirements=function(t){return this._numAttributeVectors<=t.requiredAttributeVectors&&this._numVertexUniformVectors<=t.requiredVertexUniformVectors&&this._numVaryingVectors<=t.requiredVaryingVectors&&this._numTextureUnits<=t.requiredTextureUnits&&this._numFragmentUniformVectors<=t.requiredFragmentUniformVectors},ManagedGLContext.prototype=new r.AsyncResource,ManagedGLContext.prototype.constructor=ManagedGLContext,ManagedGLContext.prototype._createContext=function(t){var e,r;i.log("Initializing WebGL context...",1),r={alpha:this._alpha,antialias:this._antialiasing};try{this.gl=this._canvas.getContext("webgl",r)}catch(n){}if(!this.gl){i.log("Initializing a regular context failed, initializing experimental context...",1),r.alpha=!1;try{this.gl=this._canvas.getContext("experimental-webgl",r)}catch(n){}if(!this.gl)return void i.showError("Unable to initialize WebGL.",i.ErrorSeverity.CRITICAL,"It looks like your device, browser or graphics drivers do not support web 3D graphics. Make sure your browser and graphics drivers are updated to the latest version, and you are using a modern web browser (Firefox or Chrome are recommended).\nPlease note that some phones or handheld devices do not have 3D web capabilities, even if you use the latest software.");i.showError("Your device appears to only have experimental WebGL (web based 3D) support.",void 0,"This application relies on 3D web features, and without full support, the graphics of the application might be displayed with glitches or not at all. If you experience problems, it is recommended to use lower graphics quality settings.")}e=this.gl,this._antialiasing&&!e.getContextAttributes().antialias&&(t||i.showGraphicsError("Antialiasing is enabled in graphics settings but it is not supported.",i.ErrorSeverity.MINOR,"Your graphics driver, browser or device unfortunately does not support antialiasing. To avoid this error message showing up again, disable antialiasing in the graphics settings or try running the application in a different browser. Antialiasing will not work, but otherwise this error will have no consequences.",e),this._antialiasing=!1),this._maxBoundTextures=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextures=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this._maxCubemapSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this._maxRenderbufferSize=e.getParameter(e.MAX_RENDERBUFFER_SIZE),this._maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._maxVertexShaderUniforms=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentShaderUniforms=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxVaryings=e.getParameter(e.MAX_VARYING_VECTORS),i.log("WebGL context successfully created.\n"+this.getInfoString(),1),this.anisotropicFilterExt=e.getExtension("EXT_texture_filter_anisotropic"),null===this.anisotropicFilterExt?i.log("Anisotropic filtering not available.",1):i.log("Anisotropic filtering successfully initialized.",1),this.instancingExt=e.getExtension("ANGLE_instanced_arrays"),null===this.instancingExt?i.log("Instancing is not available, and so it will be disabled.",1):i.log("Instancing successfully initialized.",1),this.depthTextureExt=e.getExtension("WEBGL_depth_texture"),null===this.depthTextureExt?i.log("Depth textures not available, and so will be disabled.",1):i.log("Depth texture extension successfully initialized.",1),e.clearDepth(1),e.colorMask(!0,!0,!0,!0),this._currentColorMask=[!0,!0,!0,!0],e.depthMask(!0),this._currentDepthMask=!0,e.enable(e.BLEND),this._blendingEnabled=!0,e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW)},ManagedGLContext.prototype.getInfoString=function(){return this.gl?"WebGL version: "+this.gl.getParameter(this.gl.VERSION)+"\nShading language version: "+this.gl.getParameter(this.gl.SHADING_LANGUAGE_VERSION)+"\nWebGL vendor: "+this.gl.getParameter(this.gl.VENDOR)+"\nWebGL renderer: "+this.gl.getParameter(this.gl.RENDERER)+"\nAvailable vertex shader uniform vectors: "+this._maxVertexShaderUniforms+"\nAvailable vertex attributes: "+this._maxVertexAttributes+"\nAvailable texture units in vertex shaders: "+this._maxVertexTextures+"\nAvailable varying vectors: "+this._maxVaryings+"\nAvailable fragment shader uniform vectors: "+this._maxFragmentShaderUniforms+"\nAvailable texture units: "+this._maxBoundTextures+"\nMaximum texture size: "+this._maxTextureSize+"\nMaximum cubemap size: "+this._maxCubemapSize+"\nMaximum renderbuffer size: "+this._maxRenderbufferSize:"N/A"},ManagedGLContext.prototype.getName=function(){return this._name},ManagedGLContext.prototype.isAntialiased=function(){return this._antialiasing},ManagedGLContext.prototype.getFiltering=function(){return this._filtering},ManagedGLContext.prototype.setFiltering=function(e){var r;if(e=t.getSafeEnumValue(n,e,this._filtering),e!==this._filtering)for(this._filtering=e,this._filtering===n.ANISOTROPIC&&(this.anisotropicFilterExt||(i.log("Anisotropic filtering is set, but the required extension is not available. Trilinear filtering will be used.",1),this._filtering=n.TRILINEAR)),r=0;r<this._textures.length;r++)this._textures[r].setMinFiltering&&(this.bindTexture(this._textures[r],void 0,void 0,!0),this._textures[r].setMinFiltering(this.gl,this._filtering,this.anisotropicFilterExt))},ManagedGLContext.prototype.isAnisotropicFilteringAvailable=function(){return!!this.anisotropicFilterExt},ManagedGLContext.prototype.isInstancingAvailable=function(){return!!this.instancingExt},ManagedGLContext.prototype.areDepthTexturesAvailable=function(){return!!this.depthTextureExt},ManagedGLContext.prototype.setColorMask=function(t){(this._currentColorMask[0]!==t[0]||this._currentColorMask[1]!==t[1]||this._currentColorMask[2]!==t[2]||this._currentColorMask[3]!==t[3])&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this._currentColorMask=t)},ManagedGLContext.prototype.setDepthMask=function(t){this._currentDepthMask!==t&&(this.gl.depthMask(t),this._currentDepthMask=t)},ManagedGLContext.prototype.enableBlending=function(){this._blendingEnabled||(this.gl.enable(this.gl.BLEND),this._blendingEnabled=!0)},ManagedGLContext.prototype.disableBlending=function(){this._blendingEnabled&&(this.gl.disable(this.gl.BLEND),this._blendingEnabled=!1)},ManagedGLContext.prototype.addShader=function(t){this._shaders.indexOf(t)<0&&(this._shaders.push(t),t.setupGLProgram(this._name,this.gl),this.resetReadyState())},ManagedGLContext.prototype.addModel=function(t){this._models.indexOf(t)<0&&(this._models.push(t),this.resetReadyState())},ManagedGLContext.prototype.getVertexBuffer=function(t){return this._vertexBuffers[t]},ManagedGLContext.prototype.addVertexBuffer=function(t){void 0===this._vertexBuffers[t.getName()]&&(this._vertexBuffers[t.getName()]=t)},ManagedGLContext.prototype.getBoundVertexBuffer=function(t){return this._boundVertexBuffers[t]},ManagedGLContext.prototype.setBoundVertexBuffer=function(t,e){this._boundVertexBuffers[t]=e,e&&t>=this._boundVertexBufferCount&&(this._boundVertexBufferCount=t+1)},ManagedGLContext.prototype.disableUnusedVertexBuffers=function(t){var e;for(e=t;e<this._boundVertexBufferCount;e++)this.gl.disableVertexAttribArray(e),this._boundVertexBuffers[e]=null;this._boundVertexBufferCount=t},ManagedGLContext.prototype.setVertexBufferData=function(t,e){var i;for(i in this._vertexBuffers)this._vertexBuffers.hasOwnProperty(i)&&void 0!==t[this._vertexBuffers[i].getRole()]&&this._vertexBuffers[i].setData(t[this._vertexBuffers[i].getRole()],e)},ManagedGLContext.prototype.setupVertexBuffers=function(){var t,e,i,r,n,o;if(this.isReadyToUse()!==!0){for(i in this._vertexBuffers)this._vertexBuffers.hasOwnProperty(i)&&this._vertexBuffers[i]["delete"](this);for(r=0,t=0;t<this._models.length;t++)r+=this._models[t].getBufferSize(this);for(this._vertexBuffers={},t=0;t<this._shaders.length;t++)for(n=this._shaders[t].getVertexAttributes(),e=0;e<n.length;e++)this.addVertexBuffer(new VertexBuffer(n[e].name,n[e].role,n[e].size,r));for(o=0,t=0;t<this._models.length;t++)for(e=this._models[t].getMinLOD();e<=this._models[t].getMaxLOD();e++)o+=this._models[t].loadToVertexBuffers(this,o,e);for(i in this._vertexBuffers)this._vertexBuffers.hasOwnProperty(i)&&this._vertexBuffers[i].loadToGPUMemory(this._name,this.gl);for(this._currentShader=null,t=0;t<this._shaders.length;t++)this.setCurrentShader(this._shaders[t])}},ManagedGLContext.prototype.getFrameBuffer=function(t){return this._frameBuffers[t]},ManagedGLContext.prototype.addFrameBuffer=function(t){void 0===this._frameBuffers[t.getName()]&&(i.log_DEBUG("Adding new framebuffer '"+t.getName()+"' to context ("+this._name+")...",2),this._frameBuffers[t.getName()]=t,this.isReadyToUse()&&this._frameBuffers[t.getName()].setup(this))},ManagedGLContext.prototype.setupFrameBuffers=function(){var t;if(!this.isReadyToUse())for(t in this._frameBuffers)this._frameBuffers.hasOwnProperty(t)&&this._frameBuffers[t].setup(this)},ManagedGLContext.prototype.clearFrameBuffers=function(){var t;for(t in this._frameBuffers)this._frameBuffers.hasOwnProperty(t)&&this._frameBuffers[t]["delete"](this);this._frameBuffers={}},ManagedGLContext.prototype.setup=function(){i.log_DEBUG("Setting up context '"+this._name+"'...",2),this.setupVertexBuffers(),this.setupFrameBuffers(),this.setToReady()},ManagedGLContext.prototype.clear=function(){var t;for(i.log_DEBUG("Clearing context '"+this._name+"'...",2),this.clearFrameBuffers(),this._currentShader=null,t=0;t<this._boundTextures.length;t++)this.unbindTexture(this._boundTextures[t].texture);for(this._boundTextures=[],t=0;t<this._textures.length;t++)this._textures[t].forgetLastTextureBindLocation(this._name);for(t=0;t<this._boundVertexBuffers.length;t++)this.gl.disableVertexAttribArray(t);this._boundVertexBufferCount=0,this._boundVertexBuffers=[]},ManagedGLContext.prototype.removeShaders=function(){var t;for(t=0;t<this._shaders.length;t++)this._shaders[t].deleteInstanceBuffers(this),this._shaders[t].deleteGLProgram(this._name,this.gl);this._shaders=[],this._currentShader=null},ManagedGLContext.prototype.setCurrentFrameBuffer=function(t){t?this._frameBuffers[t].bind(this):this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)},ManagedGLContext.prototype.getCurrentShader=function(){return this._currentShader},ManagedGLContext.prototype.setCurrentShader=function(t){var e,r;if(this._currentShader!==t){if(i.log_DEBUG("Switching to shader: "+t.getName(),3),r=t.getIDForContext(this._name)){switch(this.gl.useProgram(r),e=t.getBlendMode()){case s.MIX:this._currentBlendMode!==e&&(this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this._currentBlendMode=e);break;case s.ADD:this._currentBlendMode!==e&&(this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE),this._currentBlendMode=e);break;case s.NONE:break;default:i.crash()}return t.bindVertexBuffers(this),this._currentShader=t,!0}i.log("ERROR: trying to switch to non-initialized shader: '"+t.getName()+"'!",3),this._currentShader=null}return!1},ManagedGLContext.prototype.addTexture=function(t){this._textures.indexOf(t)<0&&(this._textures.push(t),t.createGLTexture(this._name,this.gl),this.bindTexture(t),t.setupGLTexture(this.gl,this._filtering,this.anisotropicFilterExt))},ManagedGLContext.prototype.bindTexture=function(t,e,r,n){var o=void 0!==e||r;if(void 0===e&&(e=t.getLastTextureBindLocation(this._name),void 0===e||e===FrameBuffer.prototype.TEXTURE_LOCATION_NOT_SET||this._boundTextures[e].texture!==t)){for(e=0;e<this._maxBoundTextures&&e<this._boundTextures.length&&this._boundTextures[e];)e++;if(e===this._maxBoundTextures){for(;this._boundTextures[this._nextTextureBindLocation].reserved;)this._nextTextureBindLocation=(this._nextTextureBindLocation+1)%this._maxBoundTextures;e=this._nextTextureBindLocation,this._nextTextureBindLocation=(this._nextTextureBindLocation+1)%this._maxBoundTextures}}return(!this._boundTextures[e]||this._boundTextures[e].texture!==t||n)&&(t instanceof ManagedTexture?(i.log_DEBUG("Binding texture: '"+t.getName()+"' to texture unit "+e+(o?", reserving place.":"."),3),t.bindGLTexture(this._name,this.gl,e)):t instanceof ManagedCubemap?(i.log_DEBUG("Binding cubemap texture: '"+t.getName()+"' to texture unit "+e+(o?", reserving place.":"."),3),t.bindGLTexture(this._name,this.gl,e)):t instanceof FrameBuffer?(i.log_DEBUG("Binding framebuffer texture: '"+t.getName()+"' to texture unit "+e+(o?", reserving place.":"."),3),t.bindGLTexture(this.gl,e)):i.showError("Cannot set object: '"+t.toString()+"' as current texture, because it is not of an appropriate type."),this._boundTextures[e]={texture:t,reserved:o}),this._boundTextures[e].reserved!==o&&(this._boundTextures[e].reserved=o,i.log_DEBUG((o?"Reserved":"Freed")+" texture unit index "+e+".",3)),e},ManagedGLContext.prototype.unbindTexture=function(t){var e=t&&t.getLastTextureBindLocation(this._name);void 0!==e&&e>=0&&this._boundTextures[e]===t&&(this.gl.activeTexture(this.gl.TEXTURE0+e),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,null),this._boundTextures[e]=null,t.forgetLastTextureBindLocation(this._name))},ManagedGLContext.prototype.removeTexture=function(t){var e=this._textures.indexOf(t);e>=0&&(this.unbindTexture(t),t.deleteGLTexture(this._name,this.gl),this._textures.splice(e,1))},ManagedGLContext.prototype.satisfiesRequirements=function(t){return this._maxVertexAttributes>=t.requiredAttributeVectors&&this._maxVertexShaderUniforms>=t.requiredVertexUniformVectors&&this._maxVaryings>=t.requiredVaryingVectors&&this._maxFragmentShaderUniforms>=t.requiredFragmentUniformVectors&&this._maxBoundTextures>=t.requiredTextureUnits},ManagedGLContext.prototype.getMaxTextureSize=function(){return this._maxTextureSize},ManagedGLContext.prototype.getMaxCubemapSize=function(){return this._maxCubemapSize},ManagedGLContext.prototype.getMaxRenderbufferSize=function(){return this._maxRenderbufferSize},i.showGraphicsError=function(t,e,r){i.showError(t,e,(r?r+"\n\n":"")+"This is a graphics related error.\nInformation about your graphics support:\n"+d.getInfoString())},d=new ManagedGLContext("",document.createElement("canvas"),!0,!0,n.BILINEAR,!0),{TextureFiltering:n,ShaderVariableType:o,ShaderBlendMode:s,getUniformName:ShaderUniform.prototype.getUniformName,getTextureUniformRawName:ShaderUniform.prototype.getTextureUniformRawName,getCubemapUniformRawName:ShaderUniform.prototype.getCubemapUniformRawName,ManagedTexture:ManagedTexture,ManagedCubemap:ManagedCubemap,ManagedShader:ManagedShader,FrameBuffer:FrameBuffer,ManagedGLContext:ManagedGLContext,requirementsAreSatisfied:d.satisfiesRequirements.bind(d),getMaxTextureSize:d.getMaxTextureSize.bind(d),getMaxCubemapSize:d.getMaxCubemapSize.bind(d),getMaxRenderbufferSize:d.getMaxRenderbufferSize.bind(d),isAntialiasingAvailable:d.isAntialiased.bind(d),isAnisotropicFilteringAvailable:d.isAnisotropicFilteringAvailable.bind(d),isInstancingAvailable:d.isInstancingAvailable.bind(d),areDepthTexturesAvailable:d.areDepthTexturesAvailable.bind(d)}}),define("modules/resource-manager",["utils/utils","modules/application","modules/async-resource"],function(t,e,i){"use strict";function GenericResource(t){i.AsyncResource.call(this),this._name=t,this._requested=!1,this._loading=!1,this._hasError=!1,this._requestParams={}}function JSONResource(t,i,n){GenericResource.call(this,t?t.name||n&&(t&&t.source||r)||e.showError("Cannot initialize instance of "+this.constructor.name+": a name is required!"):null),this._source=t?t.source||null:null,this._sourceFolder=i,this._dataJSON=t,t&&(this._source||(this._loadData(t),this.setToReady()))}function ResourceHolder(t){i.AsyncResource.call(this),this._resourceType=t,this._resources={},this._resourceNames=[],this._numLoadedResources=0,this._numRequestedResources=0}function ResourceManager(){i.AsyncResource.call(this),this._resourceHolders={},this._numLoadedResources=0,this._numRequestedResources=0,this._onResourceTypeLoadFunctionQueues={},this._onAnyResourceTypeLoadFunctionQueue=[],this._onResourceLoadFunctionQueue=[],this._resourceClasses=null,this._sourceFolder=null}var r="unnamed";return GenericResource.prototype=new i.AsyncResource,GenericResource.prototype.constructor=GenericResource,GenericResource.prototype.getName=function(){return this._name},GenericResource.prototype.isRequested=function(e){if(!this._requested)return!1;if(e){if(!this._requestParams)return!1;if(!t.equivalent(this._requestParams,e))return!1}return!0},GenericResource.prototype.request=function(i){this._loading&&!t.equivalent(this._requestParams||null,i||null)?e.showError("Attempting to request resource '"+this._name+"' with different parameters while it is being loaded!"):(this._requested=!0,this._requestParams=i)},GenericResource.prototype.requiresReload=function(){e.showError("Resource class does not implement requiresReload!")},GenericResource.prototype.isLoaded=function(){return this.isReadyToUse()},GenericResource.prototype.hasError=function(){return this._hasError},GenericResource.prototype._requestFiles=function(){e.showError("Attempting to request files for a resource type that has no file request function implemented!")},GenericResource.prototype._loadData=function(){return e.showError("Attempting to load data for a resource type that has no data loading function implemented!"),!1},GenericResource.prototype.onFinalLoad=function(){this._requested=!1,this._loading=!1,this.setToReady()},GenericResource.prototype._onFilesLoad=function(t,e){this._hasError=this._hasError||!this._loadData(e),t===!0&&this.onFinalLoad()},GenericResource.prototype.requestLoadFromFile=function(){this.isReadyToUse()===!1&&this._requested===!0&&this._loading===!1&&(this._loading=!0,this._requestFiles(this._requestParams))},GenericResource.prototype.getData=function(){return null},JSONResource.prototype=new GenericResource,JSONResource.prototype.constructor=JSONResource,JSONResource.prototype.requiresReload=function(){return this.isRequested()?!1:!this.isLoaded()},JSONResource.prototype._requestFiles=function(){e.requestTextFile(this._sourceFolder,this._source,function(t){this._onFilesLoad(!0,JSON.parse(t))}.bind(this))},JSONResource.prototype._loadData=function(t){return this._source=this._source||"",this._dataJSON=t,!0},JSONResource.prototype.getData=function(){return this._dataJSON},JSONResource.prototype.reloadData=function(){this._loadData(this._dataJSON)},ResourceHolder.prototype=new i.AsyncResource,ResourceHolder.prototype.constructor=ResourceHolder,ResourceHolder.prototype.allResourcesAreLoaded=function(){return this._numLoadedResources===this._numRequestedResources},ResourceHolder.prototype.addResource=function(t){var i=t.getName();
return this._resources[i]?e.showError("Attemtping to add a resource named '"+i+"' that already exists! Data will be overwritten."):this._resourceNames.push(i),this._resources[i]=t,this._resources[i]},ResourceHolder.prototype.getResource=function(t,i){var r;return this._resources[t]?(r=this._resources[t],i&&i.doNotLoad||r.requiresReload(i)&&(this._numRequestedResources++,this.resetReadyState(),r.resetReadyState(),r.executeWhenReady(function(){this._numLoadedResources++,this.allResourcesAreLoaded()&&this.setToReady()}.bind(this))),r):(i&&i.allowNullResult===!0||e.showError("Requested a resource named '"+t+"' from "+this._resourceType+", which does not exist."),null)},ResourceHolder.prototype.requestResourceLoad=function(){var t;for(t in this._resources)this._resources.hasOwnProperty(t)&&this._resources[t].requestLoadFromFile()},ResourceHolder.prototype.getResourceNames=function(){return this._resourceNames},ResourceHolder.prototype.renameResource=function(t,e){t!==e&&(this._resources[e]=this._resources[t],delete this._resources[t],this._resourceNames[this._resourceNames.indexOf(t)]=e)},ResourceHolder.prototype.moveResourceAfter=function(t,e){this._resourceNames.splice(this._resourceNames.indexOf(t),1),this._resourceNames.splice(this._resourceNames.indexOf(e)+1,0,t)},ResourceManager.prototype=new i.AsyncResource,ResourceManager.prototype.constructor=ResourceManager,ResourceManager.prototype.setToReady=function(){this._onResourceTypeLoadFunctionQueues={},this._onAnyResourceTypeLoadFunctionQueue=[],this._onResourceLoadFunctionQueue=[],this._numRequestedResources=0,this._numLoadedResources=0,i.AsyncResource.prototype.setToReady.call(this)},ResourceManager.prototype.executeOnResourceTypeLoad=function(t,e){this._onResourceTypeLoadFunctionQueues[t]=this._onResourceTypeLoadFunctionQueues[t]||[],this._onResourceTypeLoadFunctionQueues[t].push(e)},ResourceManager.prototype.executeOnAnyResourceTypeLoad=function(t){this._onAnyResourceTypeLoadFunctionQueue.push(t)},ResourceManager.prototype.executeOnResourceLoad=function(t){this._onResourceLoadFunctionQueue.push(t)},ResourceManager.prototype.addResource=function(t,e){return this._resourceHolders[t]=this._resourceHolders[t]||new ResourceHolder(t),this._resourceHolders[t].addResource(e)},ResourceManager.prototype.createResource=function(t,i){return this._resourceClasses?this._resourceClasses[t]?void this.addResource(t,new this._resourceClasses[t](i,this._sourceFolder)):void e.showError("Cannot create resource of type '"+t+"': no resource constructor was assigned for this resource type!"):void e.showError("Cannot create resource of type '"+t+"': no resource constructors were assigned!")},ResourceManager.prototype._onResourceLoad=function(t,e){var i,r;for(r=this._onResourceLoadFunctionQueue,i=0;i<r.length;i++)r[i](e,t,this._numRequestedResources,this._numLoadedResources);if(this.allResourcesOfTypeAreLoaded(t))for(r=this._onResourceTypeLoadFunctionQueues[t]||[],i=0;i<r.length;i++)r[i]();this.allResourcesAreLoaded()&&this.setToReady()},ResourceManager.prototype.getResource=function(t,i,r){var n;return(n=this._resourceHolders[t]?this._resourceHolders[t].getResource(i,r):null)?(r&&r.doNotLoad||n.requiresReload(r)&&(this._numRequestedResources++,this.resetReadyState(),n.request(r),n.executeWhenReady(function(){this._numLoadedResources++,this._onResourceLoad(t,i)}.bind(this))),n):(r&&r.allowNullResult===!0||e.showError("Requested a resource named '"+i+"' of type '"+t+"', which does not exist."),null)},ResourceManager.prototype.requestAllResources=function(){var t,e,i;for(t in this._resourceHolders)if(this._resourceHolders.hasOwnProperty(t))for(e=this._resourceHolders[t].getResourceNames(),i=0;i<e.length;i++)this.getResource(t,e[i])},ResourceManager.prototype.allResourcesOfTypeAreLoaded=function(t){return this._resourceHolders[t].isReadyToUse()},ResourceManager.prototype.allResourcesAreLoaded=function(){return this._numLoadedResources===this._numRequestedResources},ResourceManager.prototype.requestConfigLoad=function(t,i,r,n){e.requestTextFile(i,t,function(t){this._loadConfigFromJSON(JSON.parse(t),r),n&&n()}.bind(this))},ResourceManager.prototype._loadConfigFromJSON=function(t,e){var i,r,n;this._resourceClasses=e,this._sourceFolder=t.config?t.config.sourceFolder:null;for(i in e)if(e.hasOwnProperty(i))for(r=t[i],n=0;n<r.length;n++)this.addResource(i,new e[i](r[n],this._sourceFolder))},ResourceManager.prototype.requestResourceLoad=function(){var t;if(e.log_DEBUG("Requesting loading of resources contained in the resource manager...",2),this.allResourcesAreLoaded()===!0)e.log_DEBUG("There are no resources to load, executing set up callback queue right away...",2),this.executeOnReadyQueue();else for(t in this._resourceHolders)this._resourceHolders.hasOwnProperty(t)&&(e.log_DEBUG("Requesting the loading of "+t+" from files...",2),this._resourceHolders[t].requestResourceLoad())},ResourceManager.prototype.getResourceTypes=function(){return Object.keys(this._resourceHolders)},ResourceManager.prototype.getResourceNames=function(t){return this._resourceHolders[t]?this._resourceHolders[t].getResourceNames():(e.showError("Asked for the names of resources of type: '"+t+"', but no such resource type exists!"),null)},ResourceManager.prototype.renameResource=function(t,e,i){this._resourceHolders[t].renameResource(e,i)},ResourceManager.prototype.moveResourceAfter=function(t,e,i){this._resourceHolders[t].moveResourceAfter(e,i)},ResourceManager.prototype.executeForAllResourcesOfType=function(t,e){var i,r;for(r=this._resourceHolders[t].getResourceNames(),i=0;i<r.length;i++)e(this._resourceHolders[t].getResource(r[i]),t)},ResourceManager.prototype.executeForAllResources=function(t){var e,i=Object.keys(this._resourceHolders);for(e=0;e<i.length;e++)this.executeForAllResourcesOfType(i[e],t)},{GenericResource:GenericResource,JSONResource:JSONResource,ResourceManager:ResourceManager}}),define("utils/vectors",[],function(){"use strict";var t={},e=.99999,i=1e-7,r=20,n=[],o=0,s=new Float32Array([0,0,0]),a=new Float32Array([0,0,0,0]);return t.NULL3=[0,0,0],Object.freeze(t.NULL3),t.NULL4=[0,0,0,0],Object.freeze(t.NULL4),t.UNIT3_X=[1,0,0],Object.freeze(t.UNIT3_X),t.UNIT3_Y=[0,1,0],Object.freeze(t.UNIT3_Y),t.UNIT3_Z=[0,0,1],Object.freeze(t.UNIT3_Z),t.perpendicular3=function(t){return[t[1],-t[0],0]},t.floatVector3Aux=function(t){return s[0]=t[0],s[1]=t[1],s[2]=t[2],s},t.floatVector4Aux=function(t){return a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a},t.length2=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])},t.length3=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},t.length3Squared=function(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]},t.toString3=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)},t.toString4=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)+" "+t[3].toFixed(e)},t.getYawAndPitch=function(i){var r,n={};return Math.abs(i[2])>e?(n.yaw=0,n.pitch=i[2]>0?-Math.PI/2:Math.PI/2):(n.yaw=t.angle2uCapped([0,1],t.normal2([i[0],i[1]])),i[0]>0&&(n.yaw=-n.yaw),r=t.rotated2(i,-n.yaw),n.pitch=t.angle2uCapped([1,0],t.normal2([r[1],i[2]])),i[2]<0&&(n.pitch=-n.pitch)),n},t.getRollAndYaw=function(i,r){var n,o={};return Math.abs(i[1])>e?(o.roll=0,o.yaw=i[1]>0?0:Math.PI):(o.roll=t.angle2uCapped([1,0],t.normal2([i[0],i[2]])),i[2]<0&&(o.roll=-o.roll),n=t.rotated2([i[0],i[2]],-o.roll),o.yaw=t.angle2uCapped([0,1],t.normal2([n[0],i[1]])),!r&&Math.abs(o.roll)>Math.PI/2&&(o.yaw=-o.yaw,o.roll-=Math.PI*Math.sign(o.roll))),o},t.getRollAndPitch=function(i,r){var n,o={};return Math.abs(i[1])>e?(o.roll=0,o.pitch=i[1]>0?0:Math.PI):(o.roll=t.angle2uCapped([0,1],t.normal2([i[0],i[2]])),i[0]>0&&(o.roll=-o.roll),n=t.rotated2([i[0],i[2]],-o.roll),o.pitch=t.angle2uCapped([1,0],t.normal2([i[1],n[1]])),!r&&Math.abs(o.roll)>Math.PI/2&&(o.pitch=-o.pitch,o.roll-=Math.PI*Math.sign(o.roll))),o},t.vector4From3=function(t,e){return[t[0],t[1],t[2],e]},t.vector4From3Aux=function(t){var e=n[o];return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=1,o=(o+1)%r,e},t.normal2=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]),i=0===e?1:1/e;return[t[0]*i,t[1]*i]},t.normal3=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),i=0===e?1:1/e;return[t[0]*i,t[1]*i,t[2]*i]},t.normal3Aux=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),i=0===e?1:1/e,s=n[o];return s[0]=t[0]*i,s[1]=t[1]*i,s[2]=t[2]*i,o=(o+1)%r,s},t.scaled2=function(t,e){return[t[0]*e,t[1]*e]},t.scaled3=function(t,e){return[t[0]*e,t[1]*e,t[2]*e]},t.scaled3Aux=function(t,e){var i=n[o];return i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,o=(o+1)%r,i},t.scaled4=function(t,e){return[t[0]*e,t[1]*e,t[2]*e,t[3]*e]},t.rotated2=function(t,e){var i=Math.cos(e),r=Math.sin(e),n=[0,0];return n[0]=t[0]*i+t[1]*-r,n[1]=t[0]*r+t[1]*i,n},t.sum3=function(t,e){return[t[0]+e[0],t[1]+e[1],t[2]+e[2]]},t.sumArray3=function(t){var e,i=[0,0,0];for(e=0;e<t.length;e++)i[0]+=t[e][0],i[1]+=t[e][1],i[2]+=t[e][2];return i},t.diff3=function(t,e){return[t[0]-e[0],t[1]-e[1],t[2]-e[2]]},t.diff3Aux=function(t,e){var i=n[o];return i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],o=(o+1)%r,i},t.dot3=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},t.cross3=function(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]},t.angle2u=function(t,e){return Math.acos(t[0]*e[0]+t[1]*e[1])},t.angle2uCapped=function(t,e){return Math.acos(Math.min(Math.max(-1,t[0]*e[0]+t[1]*e[1]),1))},t.angle3u=function(t,e){return Math.acos(t[0]*e[0]+t[1]*e[1]+t[2]*e[2])},t.angle3uCapped=function(t,e){return Math.acos(Math.min(Math.max(-1,t[0]*e[0]+t[1]*e[1]+t[2]*e[2]),1))},t.prodVec3Mat3=function(t,e){return[e[0]*t[0]+e[3]*t[1]+e[6]*t[2],e[1]*t[0]+e[4]*t[1]+e[7]*t[2],e[2]*t[0]+e[5]*t[1]+e[8]*t[2]]},t.prodVec3Mat3Aux=function(e,i){var s=n[o];return t.setProdVec3Mat3(s,e,i),o=(o+1)%r,s},t.prodVec3Mat4=function(t,e){return[e[0]*t[0]+e[4]*t[1]+e[8]*t[2],e[1]*t[0]+e[5]*t[1]+e[9]*t[2],e[2]*t[0]+e[6]*t[1]+e[10]*t[2]]},t.prodVec3Mat4Aux=function(e,i){var s=n[o];return t.setProdVec3Mat4(s,e,i),o=(o+1)%r,s},t.prodVec4Mat4=function(t,e){return[e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12]*t[3],e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13]*t[3],e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14]*t[3],e[3]*t[0]+e[7]*t[1]+e[11]*t[2]+e[15]*t[3]]},t.prodVec4Mat4Aux=function(e,i){var s=n[o];return t.setProdVec4Mat4(s,e,i),o=(o+1)%r,s},t.prodMat3Vec3=function(t,e){return[t[0]*e[0]+t[1]*e[1]+t[2]*e[2],t[3]*e[0]+t[4]*e[1]+t[5]*e[2],t[6]*e[0]+t[7]*e[1]+t[8]*e[2]]},t.prodMat4Vec3=function(t,e){return[t[0]*e[0]+t[1]*e[1]+t[2]*e[2],t[4]*e[0]+t[5]*e[1]+t[6]*e[2],t[8]*e[0]+t[9]*e[1]+t[10]*e[2]]},t.prodMat4Vec4=function(t,e){return[t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3],t[4]*e[0]+t[5]*e[1]+t[6]*e[2]+t[7]*e[3],t[8]*e[0]+t[9]*e[1]+t[10]*e[2]+t[11]*e[3],t[12]*e[0]+t[13]*e[1]+t[14]*e[2]+t[15]*e[3]]},t.setNull3=function(t){t[0]=0,t[1]=0,t[2]=0},t.setVector3=function(t,e){t[0]=e[0],t[1]=e[1],t[2]=e[2]},t.setVector4=function(t,e){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]},t.negate2=function(t){t[0]=-t[0],t[1]=-t[1]},t.normalize2=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]),i=0===e?1:1/e;t[0]*=i,t[1]*=i},t.normalize3=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),i=0===e?1:1/e;t[0]*=i,t[1]*=i,t[2]*=i},t.normalize4D=function(t){t[3]=t[3]||i,t[0]/=t[3],t[1]/=t[3],t[2]/=t[3],t[3]=1},t.setSum3=function(t,e,i){t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2]},t.add3=function(t,e){t[0]+=e[0],t[1]+=e[1],t[2]+=e[2]},t.sub3=function(t,e){t[0]-=e[0],t[1]-=e[1],t[2]-=e[2]},t.mulCross3=function(t,e){var i=t[0],r=t[1],n=t[2];t[0]=r*e[2]-n*e[1],t[1]=n*e[0]-i*e[2],t[2]=i*e[1]-r*e[0]},t.rotate2=function(t,e){var i=Math.cos(e),r=Math.sin(e),n=t[0];t[0]=t[0]*i+t[1]*-r,t[1]=n*r+t[1]*i},t.mulVec3Mat3=function(t,e){var i=t[0],r=t[1],n=t[2];t[0]=e[0]*i+e[3]*r+e[6]*n,t[1]=e[1]*i+e[4]*r+e[7]*n,t[2]=e[2]*i+e[5]*r+e[8]*n},t.setProdVec3Mat3=function(t,e,i){t[0]=i[0]*e[0]+i[3]*e[1]+i[6]*e[2],t[1]=i[1]*e[0]+i[4]*e[1]+i[7]*e[2],t[2]=i[2]*e[0]+i[5]*e[1]+i[8]*e[2]},t.mulVec3Mat4=function(t,e){var i=t[0],r=t[1],n=t[2];t[0]=e[0]*i+e[4]*r+e[8]*n,t[1]=e[1]*i+e[5]*r+e[9]*n,t[2]=e[2]*i+e[6]*r+e[10]*n},t.setProdVec3Mat4=function(t,e,i){t[0]=i[0]*e[0]+i[4]*e[1]+i[8]*e[2],t[1]=i[1]*e[0]+i[5]*e[1]+i[9]*e[2],t[2]=i[2]*e[0]+i[6]*e[1]+i[10]*e[2]},t.mulVec4Mat4=function(t,e){var i=t[0],r=t[1],n=t[2],o=t[3];t[0]=e[0]*i+e[4]*r+e[8]*n+e[12]*o,t[1]=e[1]*i+e[5]*r+e[9]*n+e[13]*o,t[2]=e[2]*i+e[6]*r+e[10]*n+e[14]*o,t[3]=e[3]*i+e[7]*r+e[11]*n+e[15]*o},t.setProdVec4Mat4=function(t,e,i){t[0]=i[0]*e[0]+i[4]*e[1]+i[8]*e[2]+i[12]*e[3],t[1]=i[1]*e[0]+i[5]*e[1]+i[9]*e[2]+i[13]*e[3],t[2]=i[2]*e[0]+i[6]*e[1]+i[10]*e[2]+i[14]*e[3],t[3]=i[3]*e[0]+i[7]*e[1]+i[11]*e[2]+i[15]*e[3]},function(){var t;for(t=0;r>t;t++)n.push([0,0,0,0])}(),t}),define("modules/egom-model",["utils/vectors","modules/application"],function(t,e){"use strict";function resetDebugStats(){n.triangleDrawCalls=0,n.triangles=0,n.lineDrawCalls=0,n.lines=0,n.instancedTriangleDrawCalls=0,n.instancedTriangles=0,n.instancedLineDrawCalls=0,n.instancedLines=0}function getDebugStats(){return n}function Vertex(t,e){this.x=t[0],this.y=t[1],this.z=t[2],e=e||[this.x,this.y],this.u=e[0],this.v=e[1]}function Line(t,e,i,r){this.a=t,this.b=e,this.color=i,this.normal=r}function Triangle(e,i,r,n,o,s,a,l){this._mesh=e,this.a=i,this.b=r,this.c=n,this.color=o,this.texCoords=s,this._normals=a||t.normal3(t.cross3(this._mesh.getVector(i,r),this._mesh.getVector(i,n))),this.groupIndices=l||[0,0]}function MeshContextProperties(){this.bufferStartWireframe=0,this.bufferStartSolid=0,this.bufferStartTransparent=0}function Mesh(){this._vertices=[],this._lines=[],this._triangles=[],this._size=0,this._maxX=0,this._minX=0,this._maxY=0,this._minY=0,this._maxZ=0,this._minZ=0,this._nOpaqueTriangles=0,this._nTransparentTriangles=0,this._contextProperties={},this._texCoords=[[0,1],[1,1],[1,0],[0,0]],this._currentGroupIndices=[0,0],this._nullVertex=new Vertex([0,0,0])}function uvCoordsOnTexture(t,e,i,r,n,o){var s=[0,0];return s[0]=t+(i-t)*n,s[1]=e+(r-e)*o,s}function ModelContextProperties(){this.wireframe=!1,this.solid=!1,this.minLOD=0,this.maxLOD=0}function Model(){this._meshes=[],this._minLOD=this.LOD_NOT_SET,this._maxLOD=this.LOD_NOT_SET,this._editedMesh=null,this._minEditedLOD=0,this._maxEditedLOD=0,this._name=null,this._infoProperties={},this._scale=1,this._contextProperties={}}var i={POSITION:"position",TEXTURE_COORDINATES:"texCoord",NORMAL:"normal",COLOR:"color",GROUP_INDICES:"groupIndices",TRIANGLE_INDEX:"triangleIndex"},r=[[0,0],[1,1]],n={triangleDrawCalls:0,triangles:0,lineDrawCalls:0,lines:0,instancedTriangleDrawCalls:0,instancedTriangles:0,instancedLineDrawCalls:0,instancedLines:0},o=["3.0"];return Object.freeze(i),Vertex.prototype.getTexCoords=function(){return[this.u,this.v]},Vertex.prototype.setX=function(t){this.x=t},Vertex.prototype.setY=function(t){this.y=t},Vertex.prototype.setZ=function(t){this.z=t},Triangle.prototype.getNormal=function(t){return this._normals[t]||this._normals[0]},Mesh.prototype.getNumLines=function(){return this._lines.length},Mesh.prototype.getNumOpaqueTriangles=function(){return this._nOpaqueTriangles},Mesh.prototype.getNumTransparentTriangles=function(){return this._nTransparentTriangles},Mesh.prototype.getNumTriangles=function(t){return void 0===t?this._triangles.length:t?this._nTransparentTriangles:this._nOpaqueTriangles},Mesh.prototype.resetMesh=function(){this.resetVertices(),this.resetLines(),this.resetTriangles()},Mesh.prototype.resetVertices=function(){this._vertices=[],this._maxX=0,this._minX=0,this._maxY=0,this._minY=0,this._maxZ=0,this._minZ=0},Mesh.prototype.setVertex=function(e,i){var r,n;if(this._vertices.length<e)for(r=this._vertices.length;e>r;r++)this._vertices[r]=this._nullVertex;this._vertices[e]=i,n=t.length3([this._vertices[e].x,this._vertices[e].y,this._vertices[e].z]),2*n>this._size&&(this._size=2*n),this._vertices[e].x>this._maxX&&(this._maxX=this._vertices[e].x),this._vertices[e].x<this._minX&&(this._minX=this._vertices[e].x),this._vertices[e].y>this._maxY&&(this._maxY=this._vertices[e].y),this._vertices[e].y<this._minY&&(this._minY=this._vertices[e].y),this._vertices[e].z>this._maxZ&&(this._maxZ=this._vertices[e].z),this._vertices[e].z<this._minZ&&(this._minZ=this._vertices[e].z)},Mesh.prototype.appendVertex=function(t,e){this.setVertex(this._vertices.length,new Vertex(t,e))},Mesh.prototype.resetLines=function(){this._lines=[]},Mesh.prototype.addLine=function(t){this._lines.push(t)},Mesh.prototype.setLine=function(t,e){this._lines[t]=e},Mesh.prototype.resetTriangles=function(){this._triangles=[],this._nOpaqueTriangles=0,this._nTransparentTriangles=0},Mesh.prototype.getVector=function(t,e){return[this._vertices[e].x-this._vertices[t].x,this._vertices[e].y-this._vertices[t].y,this._vertices[e].z-this._vertices[t].z]},Mesh.prototype.addTriangle=function(t,e){this._triangles.push(t),e||(this._lines.push(new Line(t.a,t.b,t.color,t.getNormal(0))),this._lines.push(new Line(t.b,t.c,t.color,t.getNormal(0))),this._lines.push(new Line(t.c,t.a,t.color,t.getNormal(0)))),t.color[3]<1?this._nTransparentTriangles++:this._nOpaqueTriangles++},Mesh.prototype.addTriangleWithParams=function(t,e,i,r){var n,o,s,a,l;return n=r.color||[1,1,1,1],o=r.useVertexTexCoords?[this._vertices[t].getTexCoords(),this._vertices[e].getTexCoords(),this._vertices[i].getTexCoords()]:r.texCoords||[this._texCoords[0],this._texCoords[1],this._texCoords[2]],s=r.normals,a=r.groupIndices||this._currentGroupIndices,l=new Triangle(this,t,e,i,n,o,s,a),this.addTriangle(l,r.withoutLines),l},Mesh.prototype.addQuad=function(t,e,i,r,n){var o,s,a,l;n=n||{},o=Object.create(n),o.withoutLines=!0,o.texCoords=n.useVertexTexCoords?[this._vertices[t].getTexCoords(),this._vertices[e].getTexCoords(),this._vertices[i].getTexCoords()]:n.texCoords?[n.texCoords[0],n.texCoords[1],n.texCoords[2]]:[this._texCoords[0],this._texCoords[1],this._texCoords[2]],o.normals=n.normals?4===n.normals.length?[n.normals[0],n.normals[1],n.normals[2]]:n.normals:null,this.addTriangleWithParams(t,e,i,o),s=Object.create(n),s.texCoords=n.useVertexTexCoords?[this._vertices[i].getTexCoords(),this._vertices[r].getTexCoords(),this._vertices[t].getTexCoords()]:n.texCoords?[n.texCoords[2],n.texCoords[3],n.texCoords[0]]:[this._texCoords[2],this._texCoords[3],this._texCoords[0]],s.normals=n.normals?4===n.normals.length?[n.normals[2],n.normals[3],n.normals[0]]:n.normals:null,this.addTriangleWithParams(i,r,t,s),n.withoutLines||(a=n.color||[1,1,1,1],l=n.normals?n.normals[0]:this._triangles[this._triangles.length-1].getNormal(0),this._lines.push(new Line(t,e,a,l)),this._lines.push(new Line(e,i,a,l)),this._lines.push(new Line(i,r,a,l)),this._lines.push(new Line(r,t,a,l)))},Mesh.prototype.getSize=function(){return this._size},Mesh.prototype.getMaxX=function(){return this._maxX},Mesh.prototype.getMinX=function(){return this._minX},Mesh.prototype.getMaxY=function(){return this._maxY},Mesh.prototype.getMinY=function(){return this._minY},Mesh.prototype.getMaxZ=function(){return this._maxZ},Mesh.prototype.getMinZ=function(){return this._minZ},Mesh.prototype.getWidth=function(){return this._maxX-this._minX},Mesh.prototype.getHeight=function(){return this._maxY-this._minY},Mesh.prototype.getDepth=function(){return this._maxZ-this._minZ},Mesh.prototype.getBufferData=function(t,e){var r,n,o,s,a,l,h,u,c,p,d,_,g;if(e=e||0,t===!0){for(o=this._lines.length,h=new Float32Array(6*o),r=0;o>r;r++)h[6*r]=this._vertices[this._lines[r].a].x,h[6*r+1]=this._vertices[this._lines[r].a].y,h[6*r+2]=this._vertices[this._lines[r].a].z,h[6*r+3]=this._vertices[this._lines[r].b].x,h[6*r+4]=this._vertices[this._lines[r].b].y,h[6*r+5]=this._vertices[this._lines[r].b].z;for(u=new Float32Array(4*o),r=0;o>r;r++)u[4*r]=0,u[4*r+1]=1,u[4*r+2]=1,u[4*r+3]=1;for(c=new Float32Array(6*o),r=0;o>r;r++)c[6*r]=this._lines[r].normal[0],c[6*r+1]=this._lines[r].normal[1],c[6*r+2]=this._lines[r].normal[2],c[6*r+3]=this._lines[r].normal[0],c[6*r+4]=this._lines[r].normal[1],c[6*r+5]=this._lines[r].normal[2];for(p=new Float32Array(8*o),r=0;o>r;r++)p[8*r]=this._lines[r].color[0],p[8*r+1]=this._lines[r].color[1],p[8*r+2]=this._lines[r].color[2],p[8*r+3]=1,p[8*r+4]=this._lines[r].color[0],p[8*r+5]=this._lines[r].color[1],p[8*r+6]=this._lines[r].color[2],p[8*r+7]=1;for(d=new Float32Array(4*o),r=0;o>r;r++)d[4*r]=0,d[4*r+1]=0,d[4*r+2]=0,d[4*r+3]=0;for(s=this._triangles.length,_=new Float32Array(3*s),r=0;s>r;r++)_[12*r]=0,_[12*r+1]=0,_[12*r+2]=0,_[12*r+3]=0,_[12*r+4]=0,_[12*r+5]=0,_[12*r+6]=0,_[12*r+7]=0,_[12*r+8]=0,_[12*r+9]=0,_[12*r+10]=0,_[12*r+11]=0}else{for(s=this._triangles.length,h=new Float32Array(9*s),r=0;s>r;r++)h[9*r]=this._vertices[this._triangles[r].a].x,h[9*r+1]=this._vertices[this._triangles[r].a].y,h[9*r+2]=this._vertices[this._triangles[r].a].z,h[9*r+3]=this._vertices[this._triangles[r].b].x,h[9*r+4]=this._vertices[this._triangles[r].b].y,h[9*r+5]=this._vertices[this._triangles[r].b].z,h[9*r+6]=this._vertices[this._triangles[r].c].x,h[9*r+7]=this._vertices[this._triangles[r].c].y,h[9*r+8]=this._vertices[this._triangles[r].c].z;for(u=new Float32Array(6*s),r=0;s>r;r++)u[6*r]=this._triangles[r].texCoords[0][0],u[6*r+1]=this._triangles[r].texCoords[0][1],u[6*r+2]=this._triangles[r].texCoords[1][0],u[6*r+3]=this._triangles[r].texCoords[1][1],u[6*r+4]=this._triangles[r].texCoords[2][0],u[6*r+5]=this._triangles[r].texCoords[2][1];for(c=new Float32Array(9*s),r=0;s>r;r++)c[9*r]=this._triangles[r].getNormal(0)[0],c[9*r+1]=this._triangles[r].getNormal(0)[1],c[9*r+2]=this._triangles[r].getNormal(0)[2],c[9*r+3]=this._triangles[r].getNormal(1)[0],c[9*r+4]=this._triangles[r].getNormal(1)[1],c[9*r+5]=this._triangles[r].getNormal(1)[2],c[9*r+6]=this._triangles[r].getNormal(2)[0],c[9*r+7]=this._triangles[r].getNormal(2)[1],c[9*r+8]=this._triangles[r].getNormal(2)[2];for(p=new Float32Array(12*s),r=0;s>r;r++)p[12*r]=this._triangles[r].color[0],p[12*r+1]=this._triangles[r].color[1],p[12*r+2]=this._triangles[r].color[2],p[12*r+3]=this._triangles[r].color[3],p[12*r+4]=this._triangles[r].color[0],p[12*r+5]=this._triangles[r].color[1],p[12*r+6]=this._triangles[r].color[2],p[12*r+7]=this._triangles[r].color[3],p[12*r+8]=this._triangles[r].color[0],p[12*r+9]=this._triangles[r].color[1],p[12*r+10]=this._triangles[r].color[2],p[12*r+11]=this._triangles[r].color[3];for(d=new Float32Array(6*s),r=0;s>r;r++)d[6*r]=this._triangles[r].groupIndices[0],d[6*r+1]=this._triangles[r].groupIndices[1],d[6*r+2]=this._triangles[r].groupIndices[0],d[6*r+3]=this._triangles[r].groupIndices[1],d[6*r+4]=this._triangles[r].groupIndices[0],d[6*r+5]=this._triangles[r].groupIndices[1];for(_=new Float32Array(12*s),r=0;s>r;r++){for(a=e+r,l=[],n=0;4>n;n++)l[n]=a%256/255,a=Math.floor(a/256);_[12*r]=l[0],_[12*r+1]=l[1],_[12*r+2]=l[2],_[12*r+3]=l[3],_[12*r+4]=l[0],_[12*r+5]=l[1],_[12*r+6]=l[2],_[12*r+7]=l[3],_[12*r+8]=l[0],_[12*r+9]=l[1],_[12*r+10]=l[2],_[12*r+11]=l[3]}}return g={},g[i.POSITION]=h,g[i.TEXTURE_COORDINATES]=u,g[i.NORMAL]=c,g[i.COLOR]=p,g[i.GROUP_INDICES]=d,g[i.TRIANGLE_INDEX]=_,g.dataSize=t?2*this._lines.length:3*this._triangles.length,g},Mesh.prototype.getBufferSize=function(t,e){return(t?2*this._lines.length:0)+(e?3*this._triangles.length:0)},Mesh.prototype.loadToVertexBuffers=function(t,e,i,r){var n=null,o=0,s=this._contextProperties[t.getName()]||new MeshContextProperties;return i&&(n=this.getBufferData(!0,e),s.bufferStartWireframe=e,t.setVertexBufferData(n,e),o+=n.dataSize,e+=n.dataSize),r&&(n=this.getBufferData(!1,e),s.bufferStartSolid=e,s.bufferStartTransparent=e+3*this._nOpaqueTriangles,t.setVertexBufferData(n,e),o+=n.dataSize,e+=n.dataSize),this._contextProperties[t.getName()]=s,o},Mesh.prototype.render=function(t,e,i){var r=this._contextProperties[t.getName()];if(e===!0)t.gl.drawArrays(t.gl.LINES,r.bufferStartWireframe,2*this._lines.length),n.lineDrawCalls++,n.lines+=this._lines.length;else{switch(i){case!0:t.gl.drawArrays(t.gl.TRIANGLES,r.bufferStartSolid,3*this._nOpaqueTriangles),n.triangles+=this._nOpaqueTriangles;break;case!1:t.gl.drawArrays(t.gl.TRIANGLES,r.bufferStartTransparent,3*this._nTransparentTriangles),n.triangles+=this._nTransparentTriangles;break;case void 0:t.gl.drawArrays(t.gl.TRIANGLES,r.bufferStartSolid,3*this._triangles.length),n.triangles+=this._triangles.length}n.triangleDrawCalls++}},Mesh.prototype.renderInstances=function(t,e,i,r){var o=this._contextProperties[t.getName()];if(e===!0)t.instancingExt.drawArraysInstancedANGLE(t.gl.LINES,o.bufferStartWireframe,2*this._lines.length,r),n.instancedLineDrawCalls++,n.instancedLines+=this._lines.length*r;else{switch(i){case!0:t.instancingExt.drawArraysInstancedANGLE(t.gl.TRIANGLES,o.bufferStartSolid,3*this._nOpaqueTriangles,r),n.instancedTriangles+=this._nOpaqueTriangles*r;break;case!1:t.instancingExt.drawArraysInstancedANGLE(t.gl.TRIANGLES,o.bufferStartTransparent,3*this._nTransparentTriangles,r),n.instancedTriangles+=this._nTransparentTriangles*r;break;case void 0:t.instancingExt.drawArraysInstancedANGLE(t.gl.TRIANGLES,o.bufferStartSolid,3*this._triangles.length,r),n.instancedTriangles+=this._triangles.length*r}n.instancedTriangleDrawCalls++}},Mesh.prototype.addCuboid=function(e,i,r,n,o,s,a,l,h){var u,c,p,d;for(c=+this._vertices.length,this.appendVertex([e-n/2,i-o/2,r+s/2]),this.appendVertex([e+n/2,i-o/2,r+s/2]),this.appendVertex([e+n/2,i+o/2,r+s/2]),this.appendVertex([e-n/2,i+o/2,r+s/2]),this.appendVertex([e-n/2,i+o/2,r-s/2]),this.appendVertex([e+n/2,i+o/2,r-s/2]),this.appendVertex([e+n/2,i-o/2,r-s/2]),this.appendVertex([e-n/2,i-o/2,r-s/2]),this.appendVertex([e+n/2,i+o/2,r-s/2]),this.appendVertex([e-n/2,i+o/2,r-s/2]),this.appendVertex([e-n/2,i+o/2,r+s/2]),this.appendVertex([e+n/2,i+o/2,r+s/2]),this.appendVertex([e-n/2,i-o/2,r-s/2]),this.appendVertex([e+n/2,i-o/2,r-s/2]),this.appendVertex([e+n/2,i-o/2,r+s/2]),this.appendVertex([e-n/2,i-o/2,r+s/2]),this.appendVertex([e+n/2,i-o/2,r-s/2]),this.appendVertex([e+n/2,i+o/2,r-s/2]),this.appendVertex([e+n/2,i+o/2,r+s/2]),this.appendVertex([e+n/2,i-o/2,r+s/2]),this.appendVertex([e-n/2,i+o/2,r-s/2]),this.appendVertex([e-n/2,i-o/2,r-s/2]),this.appendVertex([e-n/2,i-o/2,r+s/2]),this.appendVertex([e-n/2,i+o/2,r+s/2]),p=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],d={color:a,texCoords:l},u=0;6>u;u++)d.normals=[p[u]],this.addQuad(c+4*u,c+4*u+1,c+4*u+2,c+4*u+3,d),h||(d.normals=[t.scaled3(p[u],-1)],this.addQuad(c+4*u+2,c+4*u+1,c+4*u,c+4*u+3,d))},Mesh.prototype.addSphere=function(e,i,r,n,o,s,a,l){var h,u,c,p,d,_,g,m,f,S;for(h=0;o>h;h++)for(c=0;o>c;c++)this.appendVertex([e+n*Math.sin(2*c*Math.PI/o)*Math.cos(2*h*Math.PI/o),i+n*Math.cos(2*c*Math.PI/o),r+n*Math.sin(2*h*Math.PI/o)*Math.sin(2*c*Math.PI/o)]);for(u=this._vertices.length-o*o,o%2===1&&(this._vertices[u+(o+1)/2].setX(e),this._vertices[u+(o+1)/2].setZ(r)),h=0;o>h;h++)for(p=[u+h*o,u+(h+1)%o*o+1,u+h*o+1],d=uvCoordsOnTexture(a[0][0],a[0][1],a[2][0],a[2][1],1/(2*o)+h/o,1),_=uvCoordsOnTexture(a[0][0],a[0][1],a[2][0],a[2][1],(h+1)/o,1-2/o),g=uvCoordsOnTexture(a[0][0],a[0][1],a[2][0],a[2][1],h/o,1-2/o),m=[(this._vertices[p[0]].x-e)/n,(this._vertices[p[0]].y-i)/n,(this._vertices[p[0]].z-r)/n],f=[(this._vertices[p[1]].x-e)/n,(this._vertices[p[1]].y-i)/n,(this._vertices[p[1]].z-r)/n],S=[(this._vertices[p[2]].x-e)/n,(this._vertices[p[2]].y-i)/n,(this._vertices[p[2]].z-r)/n],this.addTriangleWithParams(p[0],p[1],p[2],{color:s,texCoords:[d,_,g],normals:[m,f,S]}),l!==!0&&this.addTriangleWithParams(p[0],p[2],p[1],{color:s,texCoords:[d,g,_],normals:[t.scaled3(m,-1),t.scaled3(S,-1),t.scaled3(f,-1)]}),p=o%2===0?[u+h*o+o/2,u+h*o+o/2-1,u+(h+1)%o*o+o/2-1]:[u+(o+1)/2,u+h*o+(o-1)/2,u+(h+1)%o*o+(o-1)/2],d=uvCoordsOnTexture(a[0][0],a[0][1],a[2][0],a[2][1],1/(2*o)+h/o,0),_=uvCoordsOnTexture(a[0][0],a[0][1],a[2][0],a[2][1],h/o,o%2===0?2/o:1/o),g=uvCoordsOnTexture(a[0][0],a[0][1],a[2][0],a[2][1],(h+1)/o,o%2===0?2/o:1/o),m=[(this._vertices[p[0]].x-e)/n,(this._vertices[p[0]].y-i)/n,(this._vertices[p[0]].z-r)/n],f=[(this._vertices[p[1]].x-e)/n,(this._vertices[p[1]].y-i)/n,(this._vertices[p[1]].z-r)/n],S=[(this._vertices[p[2]].x-e)/n,(this._vertices[p[2]].y-i)/n,(this._vertices[p[2]].z-r)/n],this.addTriangleWithParams(p[0],p[1],p[2],{color:s,texCoords:[d,_,g],normals:[m,f,S]}),l!==!0&&this.addTriangleWithParams(p[0],p[2],p[1],{color:s,texCoords:[d,g,_],normals:[t.scaled3(m,-1),t.scaled3(S,-1),t.scaled3(f,-1)]}),c=1;o/2-1>c;c++)p=[u+h*o+c,u+(h+1)%o*o+c+1,u+h*o+c+1],d=uvCoordsOnTexture(a[0][0],a[0][1],a[2][0],a[2][1],h/o,1-2*c/o),_=uvCoordsOnTexture(a[0][0],a[0][1],a[2][0],a[2][1],(h+1)/o,1-2*(c+1)/o),g=uvCoordsOnTexture(a[0][0],a[0][1],a[2][0],a[2][1],h/o,1-2*(c+1)/o),m=[(this._vertices[p[0]].x-e)/n,(this._vertices[p[0]].y-i)/n,(this._vertices[p[0]].z-r)/n],f=[(this._vertices[p[1]].x-e)/n,(this._vertices[p[1]].y-i)/n,(this._vertices[p[1]].z-r)/n],S=[(this._vertices[p[2]].x-e)/n,(this._vertices[p[2]].y-i)/n,(this._vertices[p[2]].z-r)/n],this.addTriangleWithParams(p[0],p[1],p[2],{color:s,texCoords:[d,_,g],normals:[m,f,S]}),l!==!0&&this.addTriangleWithParams(p[0],p[2],p[1],{color:s,texCoords:[d,g,_],normals:[t.scaled3(m,-1),t.scaled3(S,-1),t.scaled3(f,-1)]}),p=[u+(h+1)%o*o+c+1,u+h*o+c,u+(h+1)%o*o+c],d=uvCoordsOnTexture(a[0][0],a[0][1],a[2][0],a[2][1],(h+1)/o,1-2*(c+1)/o),_=uvCoordsOnTexture(a[0][0],a[0][1],a[2][0],a[2][1],h/o,1-2*c/o),g=uvCoordsOnTexture(a[0][0],a[0][1],a[2][0],a[2][1],(h+1)/o,1-2*c/o),m=[(this._vertices[p[0]].x-e)/n,(this._vertices[p[0]].y-i)/n,(this._vertices[p[0]].z-r)/n],f=[(this._vertices[p[1]].x-e)/n,(this._vertices[p[1]].y-i)/n,(this._vertices[p[1]].z-r)/n],S=[(this._vertices[p[2]].x-e)/n,(this._vertices[p[2]].y-i)/n,(this._vertices[p[2]].z-r)/n],this.addTriangleWithParams(p[0],p[1],p[2],{color:s,texCoords:[d,_,g],normals:[m,f,S]}),l!==!0&&this.addTriangleWithParams(p[0],p[2],p[1],{color:s,texCoords:[d,g,_],normals:[t.scaled3(m,-1),t.scaled3(S,-1),t.scaled3(f,-1)]})},Model.prototype.LOD_NOT_SET=-1,Model.prototype.getName=function(){return this._name},Model.prototype.setName=function(t){this._name=t},Model.prototype.getMinLOD=function(){return this._minLOD},Model.prototype.getMaxLOD=function(){return this._maxLOD},Model.prototype.getClosestAvailableLOD=function(t){return Math.min(Math.max(this.getMinLOD(),t),this.getMaxLOD())},Model.prototype.updateLODInfo=function(t,e){this._minLOD=this._minLOD===this.LOD_NOT_SET?t:t<this._minLOD?t:this._minLOD,this._maxLOD=this._maxLOD===this.LOD_NOT_SET?e:e>this._maxLOD?e:this._maxLOD},Model.prototype.getMeshWithLOD=function(t){var e;for(e=this._meshes.length;t>=e;e++)this._meshes.push(new Mesh),this._maxLOD=e;return this._meshes[t]},Model.prototype.startEditingMeshWithLOD=function(t){this._editedMesh=this.getMeshWithLOD(t),this._minEditedLOD=t,this._maxEditedLOD=t},Model.prototype.getCurrentlyEditedMesh=function(){return this._editedMesh},Model.prototype.setMinimumEditedLOD=function(t){this._minEditedLOD=t,this._editedMesh=this._minEditedLOD===this._maxEditedLOD?this.getMeshWithLOD(t):null},Model.prototype.setMaximumEditedLOD=function(t){this._maxEditedLOD=t,this._editedMesh=this._minEditedLOD===this._maxEditedLOD?this.getMeshWithLOD(t):null},Model.prototype.loadFromJSON=function(t,i,r){var n,s,a,l,h,u,c,p,d,_,g,m,f,S,y,T=null,E=null,C=null,M=null,x=function(t,e){var i;if(null===T){for(i=t;e>=i;i++)this.getMeshWithLOD(i).resetMesh();T=t,E=e}else{for(i=t;T>i;i++)this.getMeshWithLOD(i).resetMesh();for(i=E+1;e>=i;i++)this.getMeshWithLOD(i).resetMesh();T=T>t?t:T,E=e>E?e:E}}.bind(this);if(r=r||0,e.log_DEBUG("Loading EgomModel data from file: "+t+" ...",2),"object"!=typeof i)return e.showError("'"+t+"' does not appear to be an JSON file.",e.ErrorSeverity.SEVERE,"A model was supposed to be loaded from this file, but only models of EgomModel format are accepted. Such a file needs to be a valid XML document with an EgomModel root element or a valid JSON file."),!1;if(u=i.version,!u)return e.showError("Model from file: '"+t+"' could not be loaded, because the file version could not have been determined.",e.ErrorSeverity.SEVERE),!1;if(o.indexOf(u)<0)return e.showError("Model from file: '"+t+"' could not be loaded, because the version of the file ("+u+") is not supported.",e.ErrorSeverity.SEVERE,"Supported versions are: "+o.join(", ")+"."),
!1;for(c=null,this._infoProperties=i.info||{},this._name=i.info.name||null,this._scale=i.info.scale||1,C=i.info.defaultLOD[0],M=i.info.defaultLOD[1],c=i.info.colorPalette,d=i.vertices.length,n=0;d>n;n++)for(m=i.vertices[n].i,l=null===C?r:C,h=null===M?r:M,l=i.vertices[n].lod?i.vertices[n].lod[0]:l,h=i.vertices[n].lod?i.vertices[n].lod[1]:h,this.updateLODInfo(l,h),x(l,h),f=new Vertex(i.vertices[n].p),s=l;h>=s;s++)this.getMeshWithLOD(s).setVertex(m,f);for(e.log_DEBUG("Loaded "+d+" vertices.",3),_=i.lines.length,n=0;_>n;n++)for(l=null===C?r:C,h=null===M?r:M,l=i.lines[n].lod?i.lines[n].lod[0]:l,h=i.lines[n].lod?i.lines[n].lod[1]:h,this.updateLODInfo(l,h),x(l,h),S=new Line(i.lines[n].a,i.lines[n].b,c?c[i.lines[n].color]:i.lines[n].color,i.lines[n].lum||0,i.lines[n].n),s=l;h>=s;s++)this.getMeshWithLOD(s).addLine(S);for(e.log_DEBUG("Loaded "+_+" lines.",3),g=i.triangles.length,p={},n=0;g>n;n++)for(l=null===C?r:C,h=null===M?r:M,l=i.triangles[n].lod?i.triangles[n].lod[0]:l,h=i.triangles[n].lod?i.triangles[n].lod[1]:h,this.updateLODInfo(l,h),x(l,h),p.color=c?c[i.triangles[n].color]:i.triangles[n].color,p.texCoords=i.triangles[n].t,p.normals=i.triangles[n].n,p.groupIndices=void 0!==i.triangles[n].groups?i.triangles[n].groups:null,p.withoutLines=!0,y=null,s=l;h>=s;s++)y?this.getMeshWithLOD(s).addTriangle(y,p.withoutLines):y=this.getMeshWithLOD(s).addTriangleWithParams(i.triangles[n].a,i.triangles[n].b,i.triangles[n].c,p);for(e.log_DEBUG("Loaded "+g+" triangles.",3),e.log_DEBUG("Model loaded: "+this._name+". Details: "+this._minLOD+"-"+this._maxLOD,2),a="Number of triangles per LOD for "+this._name+": ",n=this._minLOD;n<=this._maxLOD;n++)a+=" ["+n+"]: "+this.getMeshWithLOD(n).getNumTriangles();return e.log_DEBUG(a,2),!0},Model.prototype.getScale=function(){return this._scale},Model.prototype._getLargestValueOfMeshes=function(t,e){var i,r;if(void 0!==t)return e(this.getMeshWithLOD(t));for(t=this._minLOD;t<=this._maxLOD;t++)r=e(this.getMeshWithLOD(t)),(void 0===i||r>i)&&(i=r);return i},Model.prototype._getLowestValueOfMeshes=function(t,e){var i,r;if(void 0!==t)return e(this.getMeshWithLOD(t));for(t=this._minLOD;t<=this._maxLOD;t++)r=e(this.getMeshWithLOD(t)),(void 0===i||i>r)&&(i=r);return i},Model.prototype.getSize=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getSize():0})},Model.prototype.getMaxX=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getMaxX():0})},Model.prototype.getMinX=function(t){return this._getLowestValueOfMeshes(t,function(t){return t?t.getMinX():0})},Model.prototype.getMaxY=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getMaxY():0})},Model.prototype.getMinY=function(t){return this._getLowestValueOfMeshes(t,function(t){return t?t.getMinY():0})},Model.prototype.getMaxZ=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getMaxZ():0})},Model.prototype.getMinZ=function(t){return this._getLowestValueOfMeshes(t,function(t){return t?t.getMinZ():0})},Model.prototype.getWidth=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getWidth():0})},Model.prototype.getHeight=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getHeight():0})},Model.prototype.getDepth=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getDepth():0})},Model.prototype.getWidthInMeters=function(t){return t=void 0!==t?t:this._minLOD,this.getWidth(t)*this._scale},Model.prototype.getHeightInMeters=function(t){return t=void 0!==t?t:this._minLOD,this.getHeight(t)*this._scale},Model.prototype.getDepthInMeters=function(t){return t=void 0!==t?t:this._minLOD,this.getDepth(t)*this._scale},Model.prototype.getNumLines=function(t){return t=void 0!==t?t:this._minLOD,t>=0?this.getMeshWithLOD(t).getNumLines():0},Model.prototype.getNumOpaqueTriangles=function(t){return t=void 0!==t?t:this._minLOD,this.getMeshWithLOD(t).getNumOpaqueTriangles()},Model.prototype.getNumTransparentTriangles=function(t){return t=void 0!==t?t:this._minLOD,this.getMeshWithLOD(t).getNumTransparentTriangles()},Model.prototype.getNumTriangles=function(t,e){return t=void 0!==t?t:this._minLOD,t>=0?this.getMeshWithLOD(t).getNumTriangles(e):0},Model.prototype.addToContext=function(t,i){this._minLOD=this._minLOD!==this.LOD_NOT_SET?this._minLOD:0,this._maxLOD=this._maxLOD!==this.LOD_NOT_SET?this._maxLOD:0;var r=this._contextProperties[t.getName()];r?(!r.wireframe&&i&&(e.log_DEBUG("Adding model ("+this._name+") to context in wireframe mode)...",2),r.wireframe=!0,t.resetReadyState()),r.solid||i||(e.log_DEBUG("Adding model ("+this._name+") to context in solid mode)...",2),r.solid=!0,t.resetReadyState()),r.minLOD>this._minLOD&&(e.log_DEBUG("Adding model ("+this._name+") to context with minimum LOD "+this._minLOD+"...",2),r.minLOD=this._minLOD,t.resetReadyState()),r.maxLOD<this._maxLOD&&(e.log_DEBUG("Adding model ("+this._name+") to context with maximum LOD "+this._maxLOD+"...",2),r.maxLOD=this._maxLOD,t.resetReadyState())):(e.log_DEBUG("Adding model ("+this._name+") to context ("+(i?"wireframe":"solid")+" mode)...",2),r=new ModelContextProperties,r.wireframe=i,r.solid=!i,r.minLOD=this._minLOD,r.maxLOD=this._maxLOD,t.addModel(this)),this._contextProperties[t.getName()]=r},Model.prototype.clearContextBindings=function(){var t;for(t in this._contextProperties)this._contextProperties.hasOwnProperty(t)&&delete this._contextProperties[t]},Model.prototype.getBufferData=function(t,e,i){return i=void 0!==i?i:this._minLOD,this.getMeshWithLOD(i).getBufferData(t,e)},Model.prototype.getBufferSize=function(t){var e,i=this._contextProperties[t.getName()],r=0;for(e=i.minLOD;e<=i.maxLOD;e++)r+=this.getMeshWithLOD(e).getBufferSize(i.wireframe,i.solid);return r},Model.prototype.loadToVertexBuffers=function(t,e,i){i=void 0!==i?i:this._minLOD;var r=this._contextProperties[t.getName()];return this.getMeshWithLOD(i).loadToVertexBuffers(t,e,r.wireframe,r.solid)},Model.prototype.render=function(t,e,i,r){r=void 0!==r?r:this._minLOD,this.getMeshWithLOD(r).render(t,e,i)},Model.prototype.renderInstances=function(t,e,i,r,n){r=void 0!==r?r:this._minLOD,this.getMeshWithLOD(r).renderInstances(t,e,i,n)},Model.prototype.appendVertex=function(t,e){var i;if(this._editedMesh)this._editedMesh.appendVertex(t,e);else for(i=this._minEditedLOD;i<=this._maxEditedLOD;i++)this.getMeshWithLOD(i).appendVertex(t,e)},Model.prototype.addLine=function(t){var e;if(this._editedMesh)this._editedMesh.addLine(t);else for(e=this._minEditedLOD;e<=this._maxEditedLOD;e++)this.getMeshWithLOD(e).addLine(t)},Model.prototype.addQuad=function(t,e,i,r,n){var o;if(this._editedMesh)this._editedMesh.addQuad(t,e,i,r,n);else for(o=this._minEditedLOD;o<=this._maxEditedLOD;o++)this.getMeshWithLOD(o).addQuad(t,e,i,r,n)},Model.prototype.addCuboid=function(t,e,i,r,n,o,s,a,l){var h;if(this._editedMesh)this._editedMesh.addCuboid(t,e,i,r,n,o,s,a,l);else for(h=this._minEditedLOD;h<=this._maxEditedLOD;h++)this.getMeshWithLOD(h).addCuboid(t,e,i,r,n,o,s,a,l)},{VertexAttributeRole:i,resetDebugStats:resetDebugStats,getDebugStats:getDebugStats,Model:Model,fvqModel:function(t){var e=new Model;return t&&e.setName(t),e.appendVertex([-1,-1,0]),e.appendVertex([1,-1,0]),e.appendVertex([1,1,0]),e.appendVertex([-1,1,0]),e.addQuad(0,1,2,3),e},squareModel:function(t,e){var i,n=new Model;return t&&n.setName(t),i=e||r,n.appendVertex([-1,-1,0]),n.appendVertex([1,-1,0]),n.appendVertex([1,1,0]),n.appendVertex([-1,1,0]),n.addQuad(0,1,2,3,{texCoords:[[i[0][0],i[1][1]],[i[1][0],i[1][1]],[i[1][0],i[0][1]],[i[0][0],i[0][1]]]}),n},turningBillboardModel:function(t,e,i){var r,n=.5-.5*i,o=.5+.5*i,s=.75-.25*i,a=.75+.25*i,l=new Model;if(t&&l.setName(t),l.appendVertex([-i,-1,0]),l.appendVertex([i,-1,0]),l.appendVertex([i,1,0]),l.appendVertex([-i,1,0]),l.addQuad(0,1,2,3,{texCoords:[[n,.5],[o,.5],[o,0],[n,0]]}),e)for(r=0;r<e.length;r++)l.appendVertex([i,e[r],-i]),l.appendVertex([-i,e[r],-i]),l.appendVertex([-i,e[r],i]),l.appendVertex([i,e[r],i]),l.addQuad(4*(r+1),4*(r+1)+1,4*(r+1)+2,4*(r+1)+3,{texCoords:[[n,a],[o,a],[o,s],[n,s]]}),l.addQuad(4*(r+1)+3,4*(r+1)+2,4*(r+1)+1,4*(r+1),{texCoords:[[n,a],[o,a],[o,s],[n,s]]});return l},cuboidModel:function(t,e,i,r,n){var o=new Model;return t&&o.setName(t),o.addCuboid(0,0,0,e,i,r,n,[[0,1],[1,1],[1,0],[0,0]],!1),o},lineModel:function(t,e,i){var r=new Model;return t&&r.setName(t),r.appendVertex([0,0,0]),r.appendVertex(e),r.addLine(new Line(0,1,i,e)),r}}}),define("modules/audio",["modules/application"],function(t){"use strict";function _rampVolume(t,e,i,r){var n=l.currentTime;t.gain.cancelScheduledValues(n),t.gain.setValueAtTime(t.gain.value,n),r?t.gain.setTargetAtTime(e,n,i||c):t.gain.linearRampToValueAtTime(e,n+(i||c))}function SoundSource(t,e,i){this._position=t?t.slice():null,this._rolloffFactor=e||p,this._pannerNode=null,this._panningModel=i||d,this._clips={}}function SoundClip(t,e,i,r,n,o,s,a){this._soundCategory=t,this._sampleName=e,this._volume=i,this._loop=r,this._shouldStack=n||!1,this._stackTimeThreshold=o||0,this._stackVolumeFactor=s||1,this._sourceNode=null,this._gainNode=null,this._playbackStartTime=0,this._playing=!1,this._onFinish=null,this._onEnded=null,this._soundSource=null,a&&this.setSource(a)}function loadSample(e,i,r,n){l.decodeAudioData(i.response,function(t){_[e]=t,r&&r()},function(){t.showError("Decoding audio sample '"+e+"' failed!"),n&&n()})}function playSound(t,e,i,r){SoundClip.call(s,h.SOUND_EFFECT,t,e,!1),i&&(SoundSource.call(a,i,r,d),s.setSource(a)),s.play()}function setEffectVolume(t,i){i?_rampVolume(e,t,i):e.gain.value=t}function setMusicVolume(t,e){e?_rampVolume(i,t,e):i.gain.value=t}function setUIVolume(t,e){e?_rampVolume(r,t,e):r.gain.value=t}function setMasterVolume(t,e){e?_rampVolume(n,t,e):n.gain.value=t}var e,i,r,n,o,s,a,l,h={NOME:0,SOUND_EFFECT:1,MUSIC:2,UI:3},u={EQUAL_POWER:"equalpower",HRTF:"HRTF"},c=.01,p=.01,d=u.EQUAL_POWER,_={};return SoundSource.prototype.getNode=function(){return this._pannerNode||(this._pannerNode=l.createPanner(),this._pannerNode.panningModel=this._panningModel,this._pannerNode.refDistance=1,this._pannerNode.rolloffFactor=this._rolloffFactor,this._pannerNode.setPosition(this._position[0],this._position[1],this._position[2]),this._pannerNode.connect(e)),this._pannerNode},SoundSource.prototype.setPosition=function(t,e,i){var r;(t!==this._position[0]||e!==this._position[1]||i!==this._position[2])&&(this._position[0]=t,this._position[1]=e,this._position[2]=i,this._pannerNode&&(this._pannerNode.positionX&&(!this._gainNode||this._gainNode.gain.value>0)?(r=l.currentTime,this._pannerNode.positionX.value!==t&&(this._pannerNode.positionX.cancelScheduledValues(r),this._pannerNode.positionX.setValueAtTime(this._pannerNode.positionX.value,r),this._pannerNode.positionX.linearRampToValueAtTime(t,r+c)),this._pannerNode.positionY.value!==e&&(this._pannerNode.positionY.cancelScheduledValues(r),this._pannerNode.positionY.setValueAtTime(this._pannerNode.positionY.value,r),this._pannerNode.positionY.linearRampToValueAtTime(e,r+c)),this._pannerNode.positionZ.value!==i&&(this._pannerNode.positionZ.cancelScheduledValues(r),this._pannerNode.positionZ.setValueAtTime(this._pannerNode.positionZ.value,r),this._pannerNode.positionZ.linearRampToValueAtTime(i,r+c))):this._pannerNode.setPosition(t,e,i)))},SoundSource.prototype.setClip=function(t,e){this._clips[t]=e},SoundSource.prototype.getClip=function(t){return this._clips[t]},SoundSource.prototype.destroy=function(){this._pannerNode&&this._pannerNode.disconnect(),this._pannerNode=null},SoundClip.prototype.setSource=function(e){this._soundCategory!==h.SOUND_EFFECT?t.showError("Cannot set sound source for clip '"+this._sampleName+"', because its sound category is not sound effect!"):this._soundSource?t.showError("Cannot set sound source for clip '"+this._sampleName+"', because it already has a source!"):this._playing?t.showError("Cannot set sound source for clip '"+this._sampleName+"', because it is already playing!"):this._soundSource=e},SoundClip.prototype.getVolume=function(){return void 0!==this._volume?this._volume:1},SoundClip.prototype.setVolume=function(t){this._volume=t,this._gainNode&&(this._gainNode.gain.value=t)},SoundClip.prototype.increaseVolume=function(t){this._volume+=t,this._gainNode&&(this._gainNode.gain.value=this._volume)},SoundClip.prototype.rampVolume=function(t,e,i,r){!this._gainNode||i&&this._volume===t||_rampVolume(this._gainNode,t,e,r),this._volume=t},SoundClip.prototype.getPlaybackPosition=function(){var t=l.currentTime-this._playbackStartTime;return this._loop?t%_[this._sampleName].duration:Math.min(t,_[this._sampleName].duration)},SoundClip.prototype.isPlaying=function(){return this._playing},SoundClip.prototype._handleEnded=function(){this._playing=!1},SoundClip.prototype._startPlayingSample=function(n,o){var s;if(this._sourceNode=l.createBufferSource(),this._sourceNode.buffer=_[this._sampleName],o?this._sourceNode.onended=function(){this._playing=!1,o()}.bind(this):(this._onEnded=this._onEnded||this._handleEnded.bind(this),this._sourceNode.onended=this._onEnded),this._onFinish=o,s=this._sourceNode,void 0!==this._volume&&(this._gainNode=l.createGain(),this._gainNode.gain.value=this._volume,s.connect(this._gainNode),s=this._gainNode),this._loop&&(this._sourceNode.loop=!0),this._soundSource)s.connect(this._soundSource.getNode());else switch(this._soundCategory){case h.SOUND_EFFECT:s.connect(e);break;case h.MUSIC:s.connect(i);break;case h.UI:s.connect(r);break;default:t.showError("Cannot play sound '"+this._sampleName+"', because it has an unkown category: "+this._soundCategory)}this._playing=!0,this._sourceNode.start(l.currentTime,n),this._playbackStartTime=l.currentTime-n},SoundClip.prototype.play=function(e,i){var r;if(_[this._sampleName]){if(this._playing)if(e)this.stopPlaying();else if(this._loop)return;this._soundSource&&this._shouldStack?(r=this._soundSource.getClip(this._sampleName),r&&r.isPlaying()&&r.getPlaybackPosition()<=this._stackTimeThreshold?r.increaseVolume(this._volume*this._stackVolumeFactor):(this._startPlayingSample(0,i),this._soundSource&&this._soundSource.setClip(this._sampleName,this))):this._startPlayingSample(0,i)}else this._sampleName&&t.showError("Attempting to play back '"+this._sampleName+"', which is not loaded!")},SoundClip.prototype.stopPlaying=function(t){this._sourceNode&&(t?(this.rampVolume(0,t),setTimeout(this._sourceNode.stop.bind(this._sourceNode),1e3*t)):this._sourceNode.stop())},SoundClip.prototype.destroy=function(){this.stopPlaying(),this._sourceNode=null,this._gainNode=null,this._position=null},l=new AudioContext,o=l.createDynamicsCompressor(),o.connect(l.destination),n=l.createGain(),n.connect(o),e=l.createGain(),e.connect(n),i=l.createGain(),i.connect(n),r=l.createGain(),r.connect(n),s=new SoundClip,a=new SoundSource,{SoundCategory:h,PanningModel:u,SoundClip:SoundClip,SoundSource:SoundSource,loadSample:loadSample,playSound:playSound,setEffectVolume:setEffectVolume,setMusicVolume:setMusicVolume,setUIVolume:setUIVolume,setMasterVolume:setMasterVolume}}),define("modules/media-resources",["utils/utils","utils/types","modules/application","modules/resource-manager","modules/managed-gl","modules/egom-model","modules/audio"],function(t,e,i,r,n,o,s){"use strict";function MediaResource(t){r.GenericResource.call(this,t?t.name:""),this._dataJSON=t,t&&this._loadConfig(t)}function TextureResource(t){MediaResource.call(this,t)}function CubemapResource(t){MediaResource.call(this,t)}function ShaderResource(t){MediaResource.call(this,t)}function ModelResource(t){MediaResource.call(this,t)}function SoundEffectResource(t){MediaResource.call(this,t)}function MusicResource(t){MediaResource.call(this,t)}function MediaResourceManager(){r.ResourceManager.call(this)}function requestConfigLoad(t,e){var i={};i[h]=TextureResource,i[u]=CubemapResource,i[c]=ShaderResource,i[p]=ModelResource,i[f]=SoundEffectResource,i[y]=MusicResource,a.requestConfigLoad(t.filename,t.folder,i,e)}var a,l={VERTEX:"vertex",FRAGMENT:"fragment"},h="textures",u="cubemaps",c="shaders",p="models",d="texture",_="texture",g="shader",m="model",f="soundEffects",S="soundEffect",y="music",T="music",E='#include "',C='"',M="-",x={},b={},O={};return Object.freeze(l),MediaResource.prototype=new r.GenericResource,MediaResource.prototype.constructor=MediaResource,MediaResource.prototype._loadConfig=function(t){this._dataJSON=t},MediaResource.prototype.getData=function(){return this._dataJSON},MediaResource.prototype.reloadData=function(){this._loadConfig(this._dataJSON),this.resetReadyState()},TextureResource.prototype=new MediaResource,TextureResource.prototype.constructor=TextureResource,TextureResource.prototype._loadConfig=function(t){MediaResource.prototype._loadConfig.call(this,t),this._basepath=t.basepath,this._format=t.format,this._useMipmap=t.useMipmap===!0,this._typeSuffixes=t.typeSuffixes,this._qualitySuffixes=t.qualitySuffixes,this._loadedImages=0,this._imagesToLoad=0,this._images={},this._managedTextures={},this._cachedManagedTexturesOfTypes=[]},TextureResource.prototype._getPath=function(t,e){return this._basepath+this._typeSuffixes[t]+this._qualitySuffixes[e]+"."+this._format},TextureResource.prototype._getOnLoadImageFunction=function(t,e){var i=this._getPath(t,e);return function(){this._loadedImages++,this._onFilesLoad(this._loadedImages===this._imagesToLoad,{path:i})}.bind(this)},TextureResource.prototype._handleError=function(t){i.showError("Could not load texture '"+this._name+"': downloading file '"+t+"' failed!"),this._loadedImages++,this._onFilesLoad(this._loadedImages===this._imagesToLoad,{path:t,error:!0})},TextureResource.prototype._getMostFittingQuality=function(t){var e,r,n,o=this.getQualities(),s=-1;for(e=0;e<o.length;e++)r=t.indexOf(o[e]),r>=0&&(-1===s||s>r)&&(s=r,n=t[r]);return-1===s?(i.showError("Texture '"+this.getName()+"' is not available in any of the qualities: ["+t.join(", ")+"]!"),null):n},TextureResource.prototype._getProcessedParams=function(t){return t=t||{},t.types=t.types||Object.keys(this._typeSuffixes),t.qualities=t.qualities||t.qualityPreferenceList&&[this._getMostFittingQuality(t.qualityPreferenceList)]||Object.keys(this._qualitySuffixes),delete t.qualityPreferenceList,t},TextureResource.prototype.requiresReload=function(t){var e,i;if(t=this._getProcessedParams(t),this.isRequested(t))return!1;for(e=0;e<t.types.length;e++)if(this._typeSuffixes.hasOwnProperty(t.types[e])){if(!this._images[t.types[e]])return!0;for(i=0;i<t.qualities.length;i++)if(this._qualitySuffixes.hasOwnProperty(t.qualities[i])&&!this._images[t.types[e]][t.qualities[i]])return!0}return!1},TextureResource.prototype._requestFiles=function(t){var e,r,n,o,s;for(t=this._getProcessedParams(t),e=0;e<t.types.length;e++)if(n=t.types[e],this._typeSuffixes.hasOwnProperty(n))for(this._images[n]=this._images[n]||{},r=0;r<t.qualities.length;r++)o=t.qualities[r],this._qualitySuffixes.hasOwnProperty(o)&&(this._images[n][o]||(s=this._getPath(n,o),b[s]?this._images[n][o]=b[s]:(b[s]=new Image,this._imagesToLoad++,this._images[n][o]=b[s],this._images[n][o].onload=this._getOnLoadImageFunction(n,o).bind(this),this._images[n][o].onerror=this._handleError.bind(this,s))));for(e=0;e<t.types.length;e++)if(n=t.types[e],this._typeSuffixes.hasOwnProperty(n))for(r=0;r<t.qualities.length;r++)o=t.qualities[r],this._qualitySuffixes.hasOwnProperty(o)&&(this._images[n][o].src||(this._images[n][o].src=i.getFileURL(d,this._getPath(n,o))));this._loadedImages===this._imagesToLoad&&this._onFilesLoad(!0,{path:this._basepath})},TextureResource.prototype._loadData=function(t){return t.error?(i.log("WARNING: Texture from file: "+t.path+" could not be loaded.",1),!1):(i.log_DEBUG("Texture from file: "+t.path+" has been loaded.",2),!0)},TextureResource.prototype.getTypes=function(){return Object.keys(this._typeSuffixes)},TextureResource.prototype.getQualities=function(){return Object.keys(this._qualitySuffixes)},TextureResource.prototype.getManagedTexture=function(t,e){return this.isReadyToUse()===!1?(i.showError("Cannot get managed GL texture for '"+this.getName()+"', as it has not been loaded from file yet!"),null):(this._images[t]||(i.showError("The requested texture '"+this.getName()+"' has no type '"+t+"' available!"),t=Object.keys(this._images)[0]),this._managedTextures[t]=this._managedTextures[t]||{},this._managedTextures[t][e]=this._managedTextures[t][e]||new n.ManagedTexture(this.getName(),this._images[t][e],this._useMipmap),this._managedTextures[t][e])},TextureResource.prototype.getManagedTexturesOfTypes=function(e,i){var r,n,o;for(e.sort(),r=0;r<this._cachedManagedTexturesOfTypes.length;r++)if(t.arraysEqual(e,this._cachedManagedTexturesOfTypes[r].types)&&t.arraysEqual(i,this._cachedManagedTexturesOfTypes[r].qualityPreferenceList))return this._cachedManagedTexturesOfTypes[r].textures;for(n={},o=this._getMostFittingQuality(i),r=0;r<e.length;r++)n[e[r]]=this.getManagedTexture(e[r],o);return this._cachedManagedTexturesOfTypes.push({types:e,qualityPreferenceList:i,textures:n}),n},TextureResource.prototype.getManagedTextures=function(t){return this.getManagedTexturesOfTypes(this.getTypes(),t)},CubemapResource.prototype=new MediaResource,CubemapResource.prototype.constructor=CubemapResource,CubemapResource.prototype._loadConfig=function(t){MediaResource.prototype._loadConfig.call(this,t),this._basepath=t.basepath,this._format=t.format,this._imageNames=t.imageNames,this._qualitySuffixes=t.qualitySuffixes,this._loadedImages=0,this._imagesToLoad=0,this._images={},this._cachedManagedCubemaps=[]},CubemapResource.prototype._getPath=function(t,e){return this._basepath+this._imageNames[t]+this._qualitySuffixes[e]+"."+this._format},CubemapResource.prototype._getOnLoadImageFunction=function(t,e){var i=this._getPath(t,e);return function(){this._loadedImages++,this._onFilesLoad(this._loadedImages===this._imagesToLoad,{path:i})}.bind(this)},CubemapResource.prototype._handleError=function(t){i.showError("Could not load cube mapped texture '"+this._name+"': downloading file '"+t+"' failed!"),this._loadedImages++,this._onFilesLoad(this._loadedImages===this._imagesToLoad,{path:t,error:!0})},CubemapResource.prototype._getMostFittingQuality=function(t){var e,r,n,o=this.getQualities(),s=-1;for(e=0;e<o.length;e++)r=t.indexOf(o[e]),r>=0&&(-1===s||s>r)&&(s=r,n=t[r]);return-1===s?(i.showError("Cubemap '"+this.getName()+"' is not available in any of the qualities: ["+t.join(", ")+"]!"),null):n},CubemapResource.prototype._getProcessedParams=function(t){return t=t||{},t.qualities=t.qualities||t.qualityPreferenceList&&[this._getMostFittingQuality(t.qualityPreferenceList)]||Object.keys(this._qualitySuffixes),delete t.qualityPreferenceList,t},CubemapResource.prototype.requiresReload=function(t){var e,i;if(t=this._getProcessedParams(t),this.isRequested(t))return!1;for(e in this._imageNames)if(this._imageNames.hasOwnProperty(e)){if(!this._images[e])return!0;for(i=0;i<t.qualities.length;i++)if(this._qualitySuffixes.hasOwnProperty(t.qualities[i])&&!this._images[e][t.qualities[i]])return!0}return!1},CubemapResource.prototype._requestFiles=function(t){var e,r,n,o;t=this._getProcessedParams(t);for(e in this._imageNames)if(this._imageNames.hasOwnProperty(e))for(this._images[e]=this._images[e]||{},r=0;r<t.qualities.length;r++)n=t.qualities[r],this._qualitySuffixes.hasOwnProperty(n)&&(this._images[e][n]||(o=this._getPath(e,n),O[o]?this._images[e][n]=O[o]:(O[o]=new Image,this._imagesToLoad++,this._images[e][n]=O[o],this._images[e][n].onload=this._getOnLoadImageFunction(e,n).bind(this),this._images[e][n].onerror=this._handleError.bind(this,o))));for(e in this._imageNames)if(this._imageNames.hasOwnProperty(e))for(r=0;r<t.qualities.length;r++)n=t.qualities[r],this._qualitySuffixes.hasOwnProperty(n)&&(this._images[e][n].src||(this._images[e][n].src=i.getFileURL(_,this._getPath(e,n))));this._loadedImages===this._imagesToLoad&&this._onFilesLoad(!0,{path:this._basepath})},CubemapResource.prototype._loadData=function(t){return t.error?(i.log("WARNING: Face '"+t.path+"' of cubemap named '"+this.getName()+"' could not be loaded.",1),!1):(i.log_DEBUG("Face '"+t.path+"' of cubemap named '"+this.getName()+"' has been loaded.",2),!0)},CubemapResource.prototype.getQualities=function(){return Object.keys(this._qualitySuffixes)},CubemapResource.prototype.getManagedCubemap=function(e){var r,o,s;if(this.isReadyToUse()===!1)return i.showError("Cannot get managed GL cubemap for '"+this.getName()+"', as it has not been loaded from file yet!"),null;for(r=0;r<this._cachedManagedCubemaps.length;r++)if(t.arraysEqual(e,this._cachedManagedCubemaps[r].qualityPreferenceList))return this._cachedManagedCubemaps[r].cubemap;return s=this._getMostFittingQuality(e),o=new n.ManagedCubemap(this.getName(),[this._images.posX[s],this._images.negX[s],this._images.posY[s],this._images.negY[s],this._images.posZ[s],this._images.negZ[s]]),this._cachedManagedCubemaps.push({qualityPreferenceList:e,cubemap:o}),o},ShaderResource.prototype=new MediaResource,ShaderResource.prototype.constructor=ShaderResource,ShaderResource.prototype._loadConfig=function(t){MediaResource.prototype._loadConfig.call(this,t),this._variantShaderNames=t.variants||null,this._vertexShaderSourcePath=t.vertexShaderSource,this._fragmentShaderSourcePath=t.fragmentShaderSource,this._blendMode=e.getEnumValue(n.ShaderBlendMode,t.blendMode,{name:"shader.blendMode"}),this._vertexAttributeRoles=t.vertexAttributeRoles,this._instanceAttributeRoles=t.instanceAttributeRoles||{},this._vertexShaderSource=null,this._fragmentShaderSource=null,this._managedShaderBindings=[],this._shaderIncludesToLoad=0,this._shaderIncludesLoaded=0},ShaderResource.prototype._checkAllSourcesLoaded=function(){this._vertexShaderSource&&this._fragmentShaderSource&&this._shaderIncludesLoaded===this._shaderIncludesToLoad&&(this._vertexShaderSource===M&&(this._vertexShaderSource=null),this._fragmentShaderSource===M&&(this._fragmentShaderSource=null),this.onFinalLoad())},ShaderResource.prototype._loadIncludeSource=function(t,e,i){var r;for(x[e].source=i,this._resolveInclude(t,e),r=0;r<x[e].onLoad.length;r++)x[e].onLoad[r]()},ShaderResource.prototype._getIncludeFileName=function(t){return t.substr(E.length,t.length-(E.length+C.length))},ShaderResource.prototype._resolveInclude=function(t,e){var r,n,o=x[e].source;switch(t){case l.VERTEX:n=this._vertexShaderSource.split("\n");break;case l.FRAGMENT:n=this._fragmentShaderSource.split("\n");break;default:i.crash()}for(r=0;r<n.length;r++)if(n[r].substr(0,E.length)===E&&e===this._getIncludeFileName(n[r])){switch(n[r]=o,t){case l.VERTEX:this._vertexShaderSource=n.join("\n");break;case l.FRAGMENT:this._fragmentShaderSource=n.join("\n");break;default:i.crash()}this._resolveSource(t,o);break}this._shaderIncludesLoaded++,this._checkAllSourcesLoaded()},ShaderResource.prototype._resolveSource=function(t,e){var r,n=e.split("\n"),o=[];for(r=0;r<n.length;r++)n[r].substr(0,E.length)===E&&(o.push(this._getIncludeFileName(n[r])),this._shaderIncludesToLoad++);for(r=0;r<o.length;r++)x[o[r]]?x[o[r]].source?this._resolveInclude(t,o[r]):x[o[r]].onLoad.push(this._resolveInclude.bind(this,t,o[r])):(x[o[r]]={onLoad:[]},i.requestTextFile(g,o[r],this._loadIncludeSource.bind(this,t,o[r])))},ShaderResource.prototype.requiresReload=function(){return this.isRequested()?!1:!this.isLoaded()},ShaderResource.prototype._requestFiles=function(){i.requestTextFile(g,this._vertexShaderSourcePath,function(t){this._onFilesLoad(!1,{shaderType:l.VERTEX,text:t})}.bind(this)),i.requestTextFile(g,this._fragmentShaderSourcePath,function(t){this._onFilesLoad(!1,{shaderType:l.FRAGMENT,text:t})}.bind(this))},ShaderResource.prototype._loadData=function(t){switch(e.getEnumValue(l,t.shaderType,{name:"shaderType",defaultValue:null})){case l.VERTEX:this._vertexShaderSource=t.text||M;break;case l.FRAGMENT:this._fragmentShaderSource=t.text||M;break;default:i.crash()}return t.text&&this._resolveSource(t.shaderType,t.text),this._checkAllSourcesLoaded(),t.text?!0:(i.log("ERROR: There was an error loading "+t.shaderType+" shader of shader program '"+this._name+"'!",1),!1)},ShaderResource.prototype.getVariantShaderName=function(t){return this._variantShaderNames?this._variantShaderNames[t]:null},ShaderResource.prototype.getManagedShader=function(e,r){var o;if(this.isReadyToUse()===!1)return i.showError("Cannot get managed GL shader for '"+this.getName()+"', as it has not been loaded from file yet!"),null;for(e=e||null,o=0;o<this._managedShaderBindings.length;o++)if(t.objectsEqual(this._managedShaderBindings[o].replacedDefines,e))return this._managedShaderBindings[o].managedShader;return this._managedShaderBindings.push({managedShader:new n.ManagedShader(this.getName(),this._vertexShaderSource,this._fragmentShaderSource,this._blendMode,this._vertexAttributeRoles,this._instanceAttributeRoles,e,r),replacedDefines:e}),this._managedShaderBindings[this._managedShaderBindings.length-1].managedShader},ModelResource.prototype=new MediaResource,ModelResource.prototype.constructor=ModelResource,ModelResource.prototype._loadConfig=function(t){return MediaResource.prototype._loadConfig.call(this,t),t.model?(this._model=t.model,this._files=[],this._dataJSON=null,void this.setToReady()):(this._basepath=t.basepath,this._format=t.format,this._files=t.files,this._loadedFiles=0,this._filesToLoad=0,this._model=null,void(this._maxLoadedLOD=-1))},ModelResource.prototype._getPath=function(t){var e;for(e=0;e<this._files.length;e++)if(this._files[e].maxLOD===t)return this._basepath+this._files[e].suffix+"."+this._format;return null},ModelResource.prototype.requiresReload=function(t){return this.isRequested(t)?!1:0===this._files.length?!1:t&&"number"==typeof t.maxLOD?t.maxLOD>this._maxLoadedLOD:null!==this.getMaxLOD()?this.requiresReload({maxLOD:this.getMaxLOD()}):!1},ModelResource.prototype.getMaxLOD=function(){var t,e=null;for(t=0;t<this._files.length;t++)(null===e||this._files[t].maxLOD>e)&&(e=this._files[t].maxLOD);return e},ModelResource.prototype._requestFile=function(t){this._filesToLoad++,i.requestTextFile(m,this._getPath(t),function(e){this._loadedFiles++,this._onFilesLoad(this._filesToLoad===this._loadedFiles,{maxLOD:t,text:e})}.bind(this))},ModelResource.prototype._requestFiles=function(t){var e,r;if(t=t||{},void 0!==t.maxLOD){for(e=t.maxLOD;e>=0;e--)if(null!==this._getPath(e))return void this._requestFile(e);if(0>e&&this._files.length>0)for(r=this.getMaxLOD(),e=t.maxLOD+1;r>=e;e++)if(null!==this._getPath(e))return void this._requestFile(e);i.showError("Could not find any files to load for model: '"+this._name+"'!")}else this._requestFiles({maxLOD:this.getMaxLOD()})},ModelResource.prototype._loadData=function(t){return this._model=new o.Model,t.text?(i.log_DEBUG("Model file of max LOD level "+t.maxLOD+" has been loaded for model '"+this.getName()+"'",2),"{"===t.text[0]?this._model.loadFromJSON(this._getPath(t.maxLOD),JSON.parse(t.text),t.maxLOD):i.showError("Cannot load Egom Model from file '"+this._getPath(t.maxLOD)+"' - the file needs to start with '{'!"),this._maxLoadedLOD=t.maxLOD,!0):(i.showError("Model file of max LOD level "+t.maxLOD+" could not be loaded for model '"+this.getName()+"'!"),!1)},ModelResource.prototype.getEgomModel=function(){return this.isReadyToUse()===!1?(i.showError("Cannot get model object for '"+this.getName()+"', as it has not been loaded from file yet!"),null):this._model},SoundEffectResource.prototype=new MediaResource,SoundEffectResource.prototype.constructor=SoundEffectResource,SoundEffectResource.prototype._loadConfig=function(t){MediaResource.prototype._loadConfig.call(this,t),this._samples=t.samples,this._loadedSamples=0,this._samplesToLoad=0},SoundEffectResource.prototype.requiresReload=function(){return!this.isReadyToUse()&&!this.isRequested()},SoundEffectResource.prototype._requestFile=function(t){this._samplesToLoad++,i.requestFile(S,this._samples[t],function(e){e?s.loadSample(this._samples[t],e,function(){this._loadedSamples++,this._onFilesLoad(this._samplesToLoad===this._loadedSamples,{path:this._samples[t]})}.bind(this)):(i.showError("Could not load sound sample '"+this.getName()+"'!"),
this._samples[t]=null,this._loadedSamples++,this._onFilesLoad(this._samplesToLoad===this._loadedSamples,{path:this._samples[t],error:!0}))}.bind(this),void 0,"arraybuffer")},SoundEffectResource.prototype._requestFiles=function(){var t;for(t=0;t<this._samples.length;t++)this._requestFile(t)},SoundEffectResource.prototype._loadData=function(t){return t.error?(i.log("WARNING: Sound effect sample from file: "+t.path+" could not be loaded.",1),!1):(i.log_DEBUG("Sound effect sample from file: "+t.path+" has been loaded.",2),!0)},SoundEffectResource.prototype.play=function(t,e,r){var n;return this.isReadyToUse()===!1?void i.showError("Cannot play sound effect '"+this.getName()+"', as it has not been loaded from file yet!"):(n=this._samples[Math.floor(Math.random()*this._samples.length)],void(n?s.playSound(n,t,e,r):i.log("WARNING: cannot play sound sample '"+n+"', as there was a problem while loading it.",1)))},SoundEffectResource.prototype.createSoundClip=function(t,e,r,n,o,a,l){var h;return this.isReadyToUse()===!1?(i.showError("Cannot create sound source for sound effect '"+this.getName()+"', as it has not been loaded from file yet!"),null):(h=this._samples[Math.floor(Math.random()*this._samples.length)])?new s.SoundClip(t,h,e,r,n,o,a,l):(i.log("WARNING: cannot create sound source for sample '"+h+"', as there was a problem while loading it.",1),null)},MusicResource.prototype=new MediaResource,MusicResource.prototype.constructor=MusicResource,MusicResource.prototype._loadConfig=function(t){MediaResource.prototype._loadConfig.call(this,t),this._sample=t.sample},MusicResource.prototype.requiresReload=function(){return!this.isReadyToUse()&&!this.isRequested()},MusicResource.prototype._requestFiles=function(){i.requestFile(T,this._sample,function(t){t?s.loadSample(this._sample,t,function(){this._onFilesLoad(!0,{path:this._sample})}.bind(this)):(i.showError("Could not load music track '"+this.getName()+"'!"),this._sample=null,this._onFilesLoad(!0,{path:this._sample,error:!0}))}.bind(this),void 0,"arraybuffer")},MusicResource.prototype._loadData=function(t){return t.error?(i.log("WARNING: Music song from file: "+t.path+" cound not be loaded.",1),!1):(i.log_DEBUG("Music song from file: "+t.path+" has been loaded.",2),!0)},MusicResource.prototype.createSoundClip=function(t,e){return this.isReadyToUse()===!1?(i.showError("Cannot create sound source for music '"+this.getName()+"', as it has not been loaded from file yet!"),null):this._sample?new s.SoundClip(s.SoundCategory.MUSIC,this._sample,t,e):(i.log("WARNING: cannot create sound source for music track '"+this._sample+"', as there was a problem while loading it.",1),null)},MediaResourceManager.prototype=new r.ResourceManager,MediaResourceManager.prototype.constructor=MediaResourceManager,MediaResourceManager.prototype.getTexture=function(t,e){return this.getResource(h,t,e)},MediaResourceManager.prototype.getCubemap=function(t,e){return this.getResource(u,t,e)},MediaResourceManager.prototype.getShader=function(t){return this.getResource(c,t)},MediaResourceManager.prototype.getVariantShader=function(t,e){return this.getResource(c,this.getResource(c,t,{doNotLoad:!0}).getVariantShaderName(e),{allowNullResult:!0})||this.getShader(t)},MediaResourceManager.prototype.getModel=function(t,e){return this.getResource(p,t,e)},MediaResourceManager.prototype.getOrAddModel=function(t){var e=this.getResource(p,t.getName(),{allowNullResult:!0});return e||(e=this.addResource(p,new ModelResource({name:t.getName(),model:t}))),e},MediaResourceManager.prototype.getSoundEffect=function(t){return this.getResource(f,t)},MediaResourceManager.prototype.getMusic=function(t){return this.getResource(y,t)},a=new MediaResourceManager,{SoundCategory:s.SoundCategory,requestConfigLoad:requestConfigLoad,requestResourceLoad:a.requestResourceLoad.bind(a),getTexture:a.getTexture.bind(a),getCubemap:a.getCubemap.bind(a),getShader:a.getShader.bind(a),getVariantShader:a.getVariantShader.bind(a),getModel:a.getModel.bind(a),getOrAddModel:a.getOrAddModel.bind(a),getSoundEffect:a.getSoundEffect.bind(a),getMusic:a.getMusic.bind(a),getResourceTypes:a.getResourceTypes.bind(a),getResourceNames:a.getResourceNames.bind(a),getResource:a.getResource.bind(a),addResource:a.addResource.bind(a),createResource:a.createResource.bind(a),executeWhenReady:a.executeWhenReady.bind(a),executeOnResourceLoad:a.executeOnResourceLoad.bind(a),executeForAllResources:a.executeForAllResources.bind(a),renameResource:a.renameResource.bind(a),moveResourceAfter:a.moveResourceAfter.bind(a)}}),define("utils/matrices",["utils/vectors"],function(t){"use strict";function _getFreeTempMatrixIndex(){var t;for(t=0;t<n.length;t++)if(!n[t].used)return t;return n.push({used:!1,matrix:e.identity4()}),n.length-1}function _getTempMatrix(t){return n[t].used=!0,n[t].matrix}function _releaseTempMatrix(t){n[t].used=!1}var e={},i=.99999,r=20,n=[],o=[],s=0,a=[],l=0,h=0;return e.clearMatrixCount=function(){h=0},e.getMatrixCount=function(){return h},e.identity3=function(){return new Float32Array([1,0,0,0,1,0,0,0,1])},e.IDENTITY3=e.identity3(),e.identity4=function(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},e.identity4Aux=function(){var t=o[s];return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,s=(s+1)%r,t},e.IDENTITY4=e.identity4(),e.null3=function(){return new Float32Array([0,0,0,0,0,0,0,0,0])},e.NULL3=e.null3(),e.null4=function(){return new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])},e.NULL4=e.null4(),e.matrix3=function(t){return new Float32Array([t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]])},e.matrix4=function(t){return new Float32Array([t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]])},e.matrix4Aux=function(t){var e=o[s];return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],s=(s+1)%r,e},e.translation4=function(t,e,i){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t,e,i,1])},e.translation4Aux=function(t,e,i){var n=o[s];return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=t,n[13]=e,n[14]=i,n[15]=1,s=(s+1)%r,n},e.translation4v=function(t){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t[0],t[1],t[2],1])},e.translation4vAux=function(t){var e=o[s];return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,s=(s+1)%r,e},e.translation4m4=function(t){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t[12],t[13],t[14],1])},e.translation4m4Aux=function(t){var e=o[s];return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=1,s=(s+1)%r,e},e.rotation2=function(t){var e=Math.cos(t),i=Math.sin(t);return new Float32Array([e,-i,i,e])},e.rotation4=function(t,e){var i=Math.cos(e),r=Math.sin(e);return new Float32Array([i+(1-i)*t[0]*t[0],(1-i)*t[0]*t[1]-r*t[2],(1-i)*t[0]*t[2]+r*t[1],0,(1-i)*t[0]*t[1]+r*t[2],i+(1-i)*t[1]*t[1],(1-i)*t[1]*t[2]-r*t[0],0,(1-i)*t[0]*t[2]-r*t[1],(1-i)*t[1]*t[2]+r*t[0],i+(1-i)*t[2]*t[2],0,0,0,0,1])},e.rotationX4=function(t){var e=Math.cos(t),i=Math.sin(t);return new Float32Array([1,0,0,0,0,e,-i,0,0,i,e,0,0,0,0,1])},e.ROTATION_X_90=e.rotationX4(.5*Math.PI),e.ROTATION_X_180=e.rotationX4(1*Math.PI),e.ROTATION_X_270=e.rotationX4(1.5*Math.PI),e.rotationY4=function(t){var e=Math.cos(t),i=Math.sin(t);return new Float32Array([e,0,i,0,0,1,0,0,-i,0,e,0,0,0,0,1])},e.ROTATION_Y_90=e.rotationY4(.5*Math.PI),e.ROTATION_Y_180=e.rotationY4(1*Math.PI),e.ROTATION_Y_270=e.rotationY4(1.5*Math.PI),e.rotationZ4=function(t){var e=Math.cos(t),i=Math.sin(t);return new Float32Array([e,-i,0,0,i,e,0,0,0,0,1,0,0,0,0,1])},e.ROTATION_Z_90=e.rotationZ4(.5*Math.PI),e.ROTATION_Z_180=e.rotationZ4(1*Math.PI),e.ROTATION_Z_270=e.rotationZ4(1.5*Math.PI),e.rotation4Aux=function(t,e){var i=Math.cos(e),n=Math.sin(e),a=o[s];return a[0]=i+(1-i)*t[0]*t[0],a[1]=(1-i)*t[0]*t[1]-n*t[2],a[2]=(1-i)*t[0]*t[2]+n*t[1],a[3]=0,a[4]=(1-i)*t[0]*t[1]+n*t[2],a[5]=i+(1-i)*t[1]*t[1],a[6]=(1-i)*t[1]*t[2]-n*t[0],a[7]=0,a[8]=(1-i)*t[0]*t[2]-n*t[1],a[9]=(1-i)*t[1]*t[2]+n*t[0],a[10]=i+(1-i)*t[2]*t[2],a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,s=(s+1)%r,a},e.rotationX4Aux=function(t){var e=Math.cos(t),i=Math.sin(t),n=o[s];return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=e,n[6]=-i,n[7]=0,n[8]=0,n[9]=i,n[10]=e,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,s=(s+1)%r,n},e.rotationY4Aux=function(t){var e=Math.cos(t),i=Math.sin(t),n=o[s];return n[0]=e,n[1]=0,n[2]=i,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=-i,n[9]=0,n[10]=e,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,s=(s+1)%r,n},e.rotationZ4Aux=function(t){var e=Math.cos(t),i=Math.sin(t),n=o[s];return n[0]=e,n[1]=-i,n[2]=0,n[3]=0,n[4]=i,n[5]=e,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,s=(s+1)%r,n},e.rotationAroundPoint4=function(i,r,n){var o=e.rotation4(r,n),s=t.prodVec3Mat4Aux(i,o);return o[12]=i[0]-s[0],o[13]=i[1]-s[1],o[14]=i[2]-s[2],o},e.rotation4m4=function(t){return new Float32Array([t[0],t[1],t[2],0,t[4],t[5],t[6],0,t[8],t[9],t[10],0,0,0,0,1])},e.rotation4m4Aux=function(t){var e=o[s];return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=0,e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,s=(s+1)%r,e},e.lookTowards4=function(t,i){var r;return r=e.identity4(),e.setLookTowards4(r,t,i),r},e.lookTowards4Aux=function(t,i){var n=o[s];return e.setLookTowards4(n,t,i),s=(s+1)%r,n},e.scaling4=function(t,e,i){return void 0===e&&(e=t),void 0===i&&(i=t),new Float32Array([t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1])},e.scaling4Aux=function(t,e,i){var n=o[s];return void 0===e&&(e=t),void 0===i&&(i=t),n[0]=t,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=e,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=i,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,s=(s+1)%r,n},e.translationRotation=function(t,e){return new Float32Array([e[0],e[1],e[2],0,e[4],e[5],e[6],0,e[8],e[9],e[10],0,t[12],t[13],t[14],1])},e.perspective4=function(t,e,i,r){return new Float32Array([i/t,0,0,0,0,i/e,0,0,0,0,(i+r)/(i-r),-1,0,0,2*i*r/(i-r),0])},e.orthographic4=function(t,e,i,r){return new Float32Array([1/t,0,0,0,0,1/e,0,0,0,0,-2/(r-i),0,0,0,-(i+r)/2,1])},e.orthographic4Aux=function(t,i,n,a){var l=o[s];return e.setOrthographic4(l,t,i,n,a),s=(s+1)%r,l},e.rotation4FromJSON=function(i){var r,n,o,s=e.identity4();if(i)for(r=0;r<i.length;r++){if(o="string"==typeof i[r]?{axis:i[r][0],degrees:parseFloat(i[r].substring(1))}:i[r],"string"==typeof o.axis)switch(o.axis){case"x":case"X":n=t.UNIT3_X;break;case"y":case"Y":n=t.UNIT3_Y;break;case"z":case"Z":n=t.UNIT3_Z}else o.axis instanceof Array&&(n=o.axis);e.mul4(s,e.rotation4Aux(n,o.degrees/180*Math.PI))}return s},e.fromVectorsTo3=function(t,e,i){return new Float32Array([t[0],t[1],t[2],e[0],e[1],e[2],i[0],i[1],i[2]])},e.fromVectorsTo4=function(t,e,i,r){return r=r||[0,0,0,1],new Float32Array([t[0],t[1],t[2],t.length>3?t[3]:0,e[0],e[1],e[2],e.length>3?e[3]:0,i[0],i[1],i[2],i.length>3?i[3]:0,r[0],r[1],r[2],r[3]])},e.getRowA3=function(t){return[t[0],t[1],t[2]]},e.getRowA3Neg=function(t){return[-t[0],-t[1],-t[2]]},e.getRowA4=function(t){return[t[0],t[1],t[2],t[3]]},e.getRowA4Neg=function(t){return[-t[0],-t[1],-t[2],-t[3]]},e.getRowA43=function(t){return[t[0],t[1],t[2]]},e.getRowA43Neg=function(t){return[-t[0],-t[1],-t[2]]},e.getRowB3=function(t){return[t[3],t[4],t[5]]},e.getRowB3Neg=function(t){return[-t[3],-t[4],-t[5]]},e.getRowB4=function(t){return[t[4],t[5],t[6],t[7]]},e.getRowB4Neg=function(t){return[-t[4],-t[5],-t[6],-t[7]]},e.getRowB43=function(t){return[t[4],t[5],t[6]]},e.getRowB43Neg=function(t){return[-t[4],-t[5],-t[6]]},e.getRowC4=function(t){return[t[8],t[9],t[10],t[11]]},e.getRowC43=function(t){return[t[8],t[9],t[10]]},e.getRowC43Neg=function(t){return[-t[8],-t[9],-t[10]]},e.getRowD4=function(t){return[t[12],t[13],t[14],t[15]]},e.determinant3=function(t){return t[0]*t[4]*t[8]+t[1]*t[5]*t[6]+t[2]*t[3]*t[7]-t[2]*t[4]*t[6]-t[1]*t[3]*t[8]-t[0]*t[5]*t[7]},e.translationVector3=function(t){return[t[12],t[13],t[14]]},e.translationVector4=function(t){return[t[12],t[13],t[14],t[15]]},e.translationLength=function(e){return t.length3([e[12],e[13],e[14]])},e.getVectorYawAndPitch=function(r){var n,o={};return Math.abs(r[2])>i?(o.yaw=0,o.pitch=r[2]>0?-Math.PI/2:Math.PI/2):(o.yaw=t.angle2uCapped([0,1],t.normal2([r[0],r[1]])),r[0]<0&&(o.yaw=-o.yaw),n=t.prodVec3Mat4Aux(r,e.rotationZ4Aux(-o.yaw)),o.pitch=t.angle2uCapped([1,0],t.normal2([n[1],n[2]])),n[2]>0&&(o.pitch=-o.pitch)),o},e.getYawAndPitch=function(r){var n,o={};return Math.abs(r[6])>i?(o.yaw=0,o.pitch=r[6]>0?-Math.PI/2:Math.PI/2):(o.yaw=t.angle2uCapped([0,1],t.normal2(r[10]>0?[r[4],r[5]]:[-r[4],-r[5]])),r[4]*r[10]<0&&(o.yaw=-o.yaw),n=e.prod3x3SubOf4Aux(r,e.rotationZ4Aux(-o.yaw)),e.correctOrthogonal4(n),o.pitch=t.angle2uCapped([1,0],t.normal2([n[5],n[6]])),n[6]>0&&(o.pitch=-o.pitch)),o},e.getRotations=function(r){var n,o,s={};return n=t.dot3(t.UNIT3_Y,e.getRowB43(r)),Math.abs(n)>i?(s.alphaAxis=[0,0,1],s.alpha=n>0?0:Math.PI):(s.alphaAxis=t.normal3(t.cross3(e.getRowB43(r),t.UNIT3_Y)),s.alpha=t.angle3u(e.getRowB43(r),t.UNIT3_Y)),s.alpha>Math.PI&&(s.alpha-=2*Math.PI),o=e.prod3x3SubOf4Aux(r,e.rotation4Aux(s.alphaAxis,-s.alpha)),e.correctOrthogonal4(o),n=t.dot3(t.UNIT3_X,e.getRowA43(o)),Math.abs(n)>i?(s.gammaAxis=[0,1,0],s.gamma=n>0?0:Math.PI):(s.gammaAxis=t.normal3(t.cross3(e.getRowA43(o),t.UNIT3_X)),s.gamma=t.angle3u(e.getRowA43(o),t.UNIT3_X)),s.gamma>Math.PI&&(s.gamma-=2*Math.PI),s},e.toString3=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)+"\n"+t[3].toFixed(e)+" "+t[4].toFixed(e)+" "+t[5].toFixed(e)+"\n"+t[6].toFixed(e)+" "+t[7].toFixed(e)+" "+t[8].toFixed(e)},e.toString4=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)+" "+t[3].toFixed(e)+"\n"+t[4].toFixed(e)+" "+t[5].toFixed(e)+" "+t[6].toFixed(e)+" "+t[7].toFixed(e)+"\n"+t[8].toFixed(e)+" "+t[9].toFixed(e)+" "+t[10].toFixed(e)+" "+t[11].toFixed(e)+"\n"+t[12].toFixed(e)+" "+t[13].toFixed(e)+" "+t[14].toFixed(e)+" "+t[15].toFixed(e)},e.toHTMLString4=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)+" "+t[3].toFixed(e)+"<br/>"+t[4].toFixed(e)+" "+t[5].toFixed(e)+" "+t[6].toFixed(e)+" "+t[7].toFixed(e)+"<br/>"+t[8].toFixed(e)+" "+t[9].toFixed(e)+" "+t[10].toFixed(e)+" "+t[11].toFixed(e)+"<br/>"+t[12].toFixed(e)+" "+t[13].toFixed(e)+" "+t[14].toFixed(e)+" "+t[15].toFixed(e)},e.matrix3from4=function(t){return new Float32Array([t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]])},e.matrix3from4Aux=function(t){var e=a[l];return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],l=(l+1)%r,e},e.matrix4from3=function(t){return new Float32Array([t[0],t[1],t[2],0,t[3],t[4],t[5],0,t[6],t[7],t[8],0,0,0,0,1])},e.transposed3=function(t){return new Float32Array([t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8]])},e.transposed3Aux=function(t){var i=a[l];return e.setTransposed3(i,t),l=(l+1)%r,i},e.transposed43=function(t){return new Float32Array([t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]])},e.transposed4=function(t){return new Float32Array([t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15]])},e.transposed4Aux=function(t){var i=o[s];return e.setTransposed4(i,t),s=(s+1)%r,i},e.inverse3=function(t){var i;return i=e.identity3(),e.setInverse3(i,t),i},e.inverse3Aux=function(t){var i=a[l];return e.setInverse3(i,t),l=(l+1)%r,i},e.inverse4=function(t){var i;return i=e.identity4(),e.setInverse4(i,t),i},e.inverse4Aux=function(t){var i=o[s];return e.setInverse4(i,t),s=(s+1)%r,i},e.inverseOfTranslation4=function(t){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,-t[12],-t[13],-t[14],1])},e.inverseOfTranslation4Aux=function(t){var i=o[s];return e.setInverseOfTranslation4(i,t),s=(s+1)%r,i},e.inverseOfRotation4=e.transposed4,e.inverseOfRotation4Aux=e.transposed4Aux,e.inverseOfScaling4=function(t){return e.scaling4(1/t[0],1/t[5],1/t[10])},e.scaled3=function(t,e){return new Float32Array([t[0]*e,t[1]*e,t[2]*e,t[3]*e,t[4]*e,t[5]*e,t[6]*e,t[7]*e,t[8]*e])},e.scaled4=function(t,e){return new Float32Array([t[0]*e,t[1]*e,t[2]*e,t[3]*e,t[4]*e,t[5]*e,t[6]*e,t[7]*e,t[8]*e,t[9]*e,t[10]*e,t[11]*e,t[12]*e,t[13]*e,t[14]*e,t[15]*e])},e.correctedOrthogonal4=function(e){var i=t.normal3([e[0],e[1],e[2]]),r=t.normal3([e[4],e[5],e[6]]),n=t.cross3(i,r);return r=t.cross3(n,i),new Float32Array([i[0],i[1],i[2],0,r[0],r[1],r[2],0,n[0],n[1],n[2],0,0,0,0,1])},e.straightened=function(t,e){var i,r=new Float32Array(t);for(i=0;i<r.length;i++)r[i]=Math.abs(t[i])<e?0:Math.abs(1-t[i])<e?1:Math.abs(-1-t[i])<e?-1:t[i];return r},e.equal4=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]},e.sum4=function(t,e){return new Float32Array([t[0]+e[0],t[1]+e[1],t[2]+e[2],t[3]+e[3],t[4]+e[4],t[5]+e[5],t[6]+e[6],t[7]+e[7],t[8]+e[8],t[9]+e[9],t[10]+e[10],t[11]+e[11],t[12]+e[12],t[13]+e[13],t[14]+e[14],t[15]+e[15]])},e.prod3=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[3]+t[2]*e[6],t[0]*e[1]+t[1]*e[4]+t[2]*e[7],t[0]*e[2]+t[1]*e[5]+t[2]*e[8],t[3]*e[0]+t[4]*e[3]+t[5]*e[6],t[3]*e[1]+t[4]*e[4]+t[5]*e[7],t[3]*e[2]+t[4]*e[5]+t[5]*e[8],t[6]*e[0]+t[7]*e[3]+t[8]*e[6],t[6]*e[1]+t[7]*e[4]+t[8]*e[7],t[6]*e[2]+t[7]*e[5]+t[8]*e[8]])},e.prod4=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[4]+t[2]*e[8]+t[3]*e[12],t[0]*e[1]+t[1]*e[5]+t[2]*e[9]+t[3]*e[13],t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+t[3]*e[14],t[0]*e[3]+t[1]*e[7]+t[2]*e[11]+t[3]*e[15],t[4]*e[0]+t[5]*e[4]+t[6]*e[8]+t[7]*e[12],t[4]*e[1]+t[5]*e[5]+t[6]*e[9]+t[7]*e[13],t[4]*e[2]+t[5]*e[6]+t[6]*e[10]+t[7]*e[14],t[4]*e[3]+t[5]*e[7]+t[6]*e[11]+t[7]*e[15],t[8]*e[0]+t[9]*e[4]+t[10]*e[8]+t[11]*e[12],t[8]*e[1]+t[9]*e[5]+t[10]*e[9]+t[11]*e[13],t[8]*e[2]+t[9]*e[6]+t[10]*e[10]+t[11]*e[14],t[8]*e[3]+t[9]*e[7]+t[10]*e[11]+t[11]*e[15],t[12]*e[0]+t[13]*e[4]+t[14]*e[8]+t[15]*e[12],t[12]*e[1]+t[13]*e[5]+t[14]*e[9]+t[15]*e[13],t[12]*e[2]+t[13]*e[6]+t[14]*e[10]+t[15]*e[14],t[12]*e[3]+t[13]*e[7]+t[14]*e[11]+t[15]*e[15]])},e.prod4Aux=function(t,i){var n=o[s];return e.setProd4(n,t,i),s=(s+1)%r,n},e.prod3x3SubOf43=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[4]+t[2]*e[8],t[0]*e[1]+t[1]*e[5]+t[2]*e[9],t[0]*e[2]+t[1]*e[6]+t[2]*e[10],t[4]*e[0]+t[5]*e[4]+t[6]*e[8],t[4]*e[1]+t[5]*e[5]+t[6]*e[9],t[4]*e[2]+t[5]*e[6]+t[6]*e[10],t[8]*e[0]+t[9]*e[4]+t[10]*e[8],t[8]*e[1]+t[9]*e[5]+t[10]*e[9],t[8]*e[2]+t[9]*e[6]+t[10]*e[10]])},e.prod3x3SubOf4=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[4]+t[2]*e[8],t[0]*e[1]+t[1]*e[5]+t[2]*e[9],t[0]*e[2]+t[1]*e[6]+t[2]*e[10],0,t[4]*e[0]+t[5]*e[4]+t[6]*e[8],t[4]*e[1]+t[5]*e[5]+t[6]*e[9],t[4]*e[2]+t[5]*e[6]+t[6]*e[10],0,t[8]*e[0]+t[9]*e[4]+t[10]*e[8],t[8]*e[1]+t[9]*e[5]+t[10]*e[9],t[8]*e[2]+t[9]*e[6]+t[10]*e[10],0,0,0,0,1])},e.prod3x3SubOf4Aux=function(t,e){var i=o[s];return i[0]=t[0]*e[0]+t[1]*e[4]+t[2]*e[8],i[1]=t[0]*e[1]+t[1]*e[5]+t[2]*e[9],i[2]=t[0]*e[2]+t[1]*e[6]+t[2]*e[10],i[3]=0,i[4]=t[4]*e[0]+t[5]*e[4]+t[6]*e[8],i[5]=t[4]*e[1]+t[5]*e[5]+t[6]*e[9],i[6]=t[4]*e[2]+t[5]*e[6]+t[6]*e[10],i[7]=0,i[8]=t[8]*e[0]+t[9]*e[4]+t[10]*e[8],i[9]=t[8]*e[1]+t[9]*e[5]+t[10]*e[9],i[10]=t[8]*e[2]+t[9]*e[6]+t[10]*e[10],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,s=(s+1)%r,i},e.prodTranslationRotation4=function(t,e){return new Float32Array([e[0],e[1],e[2],0,e[4],e[5],e[6],0,e[8],e[9],e[10],0,e[0]*t[12]+e[4]*t[13]+e[8]*t[14],e[1]*t[12]+e[5]*t[13]+e[9]*t[14],e[2]*t[12]+e[6]*t[13]+e[10]*t[14],1])},e.prodTranslationRotation4Aux=function(t,i){var n=o[s];return e.setProdTranslationRotation4(n,t,i),s=(s+1)%r,n},e.prod34=function(t,i,r){var n=e.prod4(t,i);return e.mul4(n,r),n},e.prod34Aux=function(t,i,r){var n=e.prod4Aux(t,i);return e.mul4(n,r),n},e.translatedByVector=function(t,e){return new Float32Array([t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12]+e[0],t[13]+e[1],t[14]+e[2],t[15]])},e.translatedByVectorAux=function(t,i){var n=o[s];return e.setTranslatedByVector(n,t,i),s=(s+1)%r,n},e.translatedByM4=function(t,e){return new Float32Array([t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12]+e[12],t[13]+e[13],t[14]+e[14],t[15]])},e.translatedByM4Aux=function(t,i){var n=o[s];return e.setTranslatedByM4(n,t,i),s=(s+1)%r,n},e.distanceSquared=function(t,e){return(t[12]-e[12])*(t[12]-e[12])+(t[13]-e[13])*(t[13]-e[13])+(t[14]-e[14])*(t[14]-e[14])},e.setNull3=function(t){t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t[8]=0},e.setIdentity3=function(t){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1},e.setIdentity4=function(t){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1},e.setMatrix3=function(t,e){var i;for(i=0;9>i;i++)t[i]=e[i]},e.setMatrix4=function(t,e){var i;for(i=0;16>i;i++)t[i]=e[i]},e.setTranslation4v=function(t,e){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1},e.setRotation2=function(t,e){var i=Math.cos(e),r=Math.sin(e);t[0]=i,t[1]=-r,t[2]=r,t[3]=i},e.setRotation4=function(t,e,i){var r=Math.cos(i),n=Math.sin(i);t[0]=r+(1-r)*e[0]*e[0],t[1]=(1-r)*e[0]*e[1]-n*e[2],t[2]=(1-r)*e[0]*e[2]+n*e[1],t[3]=0,t[4]=(1-r)*e[0]*e[1]+n*e[2],t[5]=r+(1-r)*e[1]*e[1],t[6]=(1-r)*e[1]*e[2]-n*e[0],t[7]=0,t[8]=(1-r)*e[0]*e[2]-n*e[1],t[9]=(1-r)*e[1]*e[2]+n*e[0],t[10]=r+(1-r)*e[2]*e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1},e.setRotationAroundPoint4=function(i,r,n,o){var s;e.setRotation4(i,n,o),s=t.prodVec3Mat4Aux(r,i),i[12]=r[0]-s[0],i[13]=r[1]-s[1],i[14]=r[2]-s[2]},e.setLookTowards4=function(r,n,o){var s;o=o||[0,1,0],Math.abs(t.dot3(o,n))>i&&(o=t.perpendicular3(n)),s=t.cross3(o,n),r[0]=s[0],r[1]=s[1],r[2]=s[2],o=t.cross3(n,s),r[4]=o[0],r[5]=o[1],r[6]=o[2],e.correctOrthogonal4(r)},e.translateByVector=function(t,e){t[12]+=e[0],t[13]+=e[1],t[14]+=e[2]},e.translateByMatrix=function(t,e){t[12]+=e[12],t[13]+=e[13],t[14]+=e[14]},e.rotate4=function(t,i,r){var n=_getFreeTempMatrixIndex(),o=_getTempMatrix(n);e.setRotation4(o,i,r),e.mul4(t,o),_releaseTempMatrix(n)},e.rotateAroundPoint4=function(t,i,r,n){var o=_getFreeTempMatrixIndex(),s=_getTempMatrix(o);e.setRotationAroundPoint4(s,i,r,n),e.mul4(t,s),_releaseTempMatrix(o)},e.setInverse3=function(t,i){var r,n,o,s,a,l,h,u=_getFreeTempMatrixIndex();if(l=_getTempMatrix(u),e.setMatrix3(l,i),0===e.determinant3(l))return void e.setNull3(t);for(e.setIdentity3(t),r=0;3>r;r++){if(Math.abs(l[4*r])<=1e-4){for(n=r+1;Math.abs(l[3*n+r])<=1e-4;)n++;for(o=0;3>o;o++)h=l[3*r+o],l[3*r+o]=l[3*n+o],l[3*n+o]=h,h=t[3*r+o],t[3*r+o]=t[3*n+o],t[3*n+o]=h}for(s=l[4*r],n=0;3>n;n++)l[3*r+n]=l[3*r+n]/s,t[3*r+n]=t[3*r+n]/s;for(n=r+1;3>n;n++)for(a=l[3*n+r]/l[4*r],o=0;3>o;o++)l[3*n+o]=l[3*n+o]-a*l[3*r+o],t[3*n+o]=t[3*n+o]-a*t[3*r+o]}for(r=2;r>=1;r--)for(n=r-1;n>=0;n--)for(o=0;3>o;o++)t[3*n+o]=t[3*n+o]-l[3*n+r]*t[3*r+o];_releaseTempMatrix(u)},e.setInverse4=function(t,i){var r,n,o,s,a,l,h,u=_getFreeTempMatrixIndex();for(l=_getTempMatrix(u),e.setMatrix4(l,i),e.setIdentity4(t),r=0;4>r;r++){if(Math.abs(l[5*r])<=1e-4){for(n=r+1;Math.abs(l[4*n+r])<=1e-4;)n++;for(o=0;4>o;o++)h=l[4*r+o],l[4*r+o]=l[4*n+o],l[4*n+o]=h,h=t[4*r+o],t[4*r+o]=t[4*n+o],t[4*n+o]=h}for(s=l[5*r],n=0;4>n;n++)l[4*r+n]=l[4*r+n]/s,t[4*r+n]=t[4*r+n]/s;for(n=r+1;4>n;n++)for(a=l[4*n+r]/l[5*r],o=0;4>o;o++)l[4*n+o]=l[4*n+o]-a*l[4*r+o],t[4*n+o]=t[4*n+o]-a*t[4*r+o]}for(r=3;r>=1;r--)for(n=r-1;n>=0;n--)for(o=0;4>o;o++)t[4*n+o]=t[4*n+o]-l[4*n+r]*t[4*r+o];_releaseTempMatrix(u)},e.setInverseOfTranslation4=function(t,e){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=-e[12],t[13]=-e[13],t[14]=-e[14],t[15]=1},e.setTransposed3=function(t,e){t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8]},e.setTransposed4=function(t,e){t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15]},e.setInverseOfRotation4=e.setTransposed4,e.setInverseOfScaling4=function(t,e){t[0]=1/e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1/e[5],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1/e[10],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1},e.mul4=function(t,i){var r=_getFreeTempMatrixIndex(),n=_getTempMatrix(r);e.setMatrix4(n,t),t[0]=n[0]*i[0]+n[1]*i[4]+n[2]*i[8]+n[3]*i[12],t[1]=n[0]*i[1]+n[1]*i[5]+n[2]*i[9]+n[3]*i[13],t[2]=n[0]*i[2]+n[1]*i[6]+n[2]*i[10]+n[3]*i[14],t[3]=n[0]*i[3]+n[1]*i[7]+n[2]*i[11]+n[3]*i[15],t[4]=n[4]*i[0]+n[5]*i[4]+n[6]*i[8]+n[7]*i[12],t[5]=n[4]*i[1]+n[5]*i[5]+n[6]*i[9]+n[7]*i[13],t[6]=n[4]*i[2]+n[5]*i[6]+n[6]*i[10]+n[7]*i[14],t[7]=n[4]*i[3]+n[5]*i[7]+n[6]*i[11]+n[7]*i[15],t[8]=n[8]*i[0]+n[9]*i[4]+n[10]*i[8]+n[11]*i[12],t[9]=n[8]*i[1]+n[9]*i[5]+n[10]*i[9]+n[11]*i[13],t[10]=n[8]*i[2]+n[9]*i[6]+n[10]*i[10]+n[11]*i[14],t[11]=n[8]*i[3]+n[9]*i[7]+n[10]*i[11]+n[11]*i[15],t[12]=n[12]*i[0]+n[13]*i[4]+n[14]*i[8]+n[15]*i[12],t[13]=n[12]*i[1]+n[13]*i[5]+n[14]*i[9]+n[15]*i[13],t[14]=n[12]*i[2]+n[13]*i[6]+n[14]*i[10]+n[15]*i[14],t[15]=n[12]*i[3]+n[13]*i[7]+n[14]*i[11]+n[15]*i[15],_releaseTempMatrix(r)},e.setProd4=function(t,e,i){t[0]=e[0]*i[0]+e[1]*i[4]+e[2]*i[8]+e[3]*i[12],t[1]=e[0]*i[1]+e[1]*i[5]+e[2]*i[9]+e[3]*i[13],t[2]=e[0]*i[2]+e[1]*i[6]+e[2]*i[10]+e[3]*i[14],t[3]=e[0]*i[3]+e[1]*i[7]+e[2]*i[11]+e[3]*i[15],t[4]=e[4]*i[0]+e[5]*i[4]+e[6]*i[8]+e[7]*i[12],t[5]=e[4]*i[1]+e[5]*i[5]+e[6]*i[9]+e[7]*i[13],t[6]=e[4]*i[2]+e[5]*i[6]+e[6]*i[10]+e[7]*i[14],t[7]=e[4]*i[3]+e[5]*i[7]+e[6]*i[11]+e[7]*i[15],t[8]=e[8]*i[0]+e[9]*i[4]+e[10]*i[8]+e[11]*i[12],t[9]=e[8]*i[1]+e[9]*i[5]+e[10]*i[9]+e[11]*i[13],t[10]=e[8]*i[2]+e[9]*i[6]+e[10]*i[10]+e[11]*i[14],t[11]=e[8]*i[3]+e[9]*i[7]+e[10]*i[11]+e[11]*i[15],t[12]=e[12]*i[0]+e[13]*i[4]+e[14]*i[8]+e[15]*i[12],t[13]=e[12]*i[1]+e[13]*i[5]+e[14]*i[9]+e[15]*i[13],t[14]=e[12]*i[2]+e[13]*i[6]+e[14]*i[10]+e[15]*i[14],t[15]=e[12]*i[3]+e[13]*i[7]+e[14]*i[11]+e[15]*i[15]},e.setProd3x3SubOf4=function(t,e,i){t[0]=e[0]*i[0]+e[1]*i[4]+e[2]*i[8],t[1]=e[0]*i[1]+e[1]*i[5]+e[2]*i[9],t[2]=e[0]*i[2]+e[1]*i[6]+e[2]*i[10],t[3]=0,t[4]=e[4]*i[0]+e[5]*i[4]+e[6]*i[8],t[5]=e[4]*i[1]+e[5]*i[5]+e[6]*i[9],t[6]=e[4]*i[2]+e[5]*i[6]+e[6]*i[10],t[7]=0,t[8]=e[8]*i[0]+e[9]*i[4]+e[10]*i[8],t[9]=e[8]*i[1]+e[9]*i[5]+e[10]*i[9],t[10]=e[8]*i[2]+e[9]*i[6]+e[10]*i[10],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1},e.setProdTranslationRotation4=function(t,e,i){t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=0,t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=0,t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=0,t[12]=i[0]*e[12]+i[4]*e[13]+i[8]*e[14],t[13]=i[1]*e[12]+i[5]*e[13]+i[9]*e[14],t[14]=i[2]*e[12]+i[6]*e[13]+i[10]*e[14],t[15]=1},e.setTranslationRotation=function(t,e,i){t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=0,t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=0,t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=0,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=1},e.setTranslatedByVector=function(t,e,i){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12]+i[0],t[13]=e[13]+i[1],t[14]=e[14]+i[2],t[15]=e[15]},e.setTranslatedByM4=function(t,e,i){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12]+i[12],t[13]=e[13]+i[13],t[14]=e[14]+i[14],t[15]=e[15]},e.setPerspective4=function(t,e,i,r,n){t[0]=r/e,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=r/i,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(r+n)/(r-n),t[11]=-1,t[12]=0,t[13]=0,t[14]=2*r*n/(r-n),t[15]=0},e.setOrthographic4=function(t,e,i,r,n){t[0]=1/e,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1/i,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=-2/(n-r),t[11]=0,t[12]=0,t[13]=0,t[14]=-(r+n)/2,t[15]=1},e.correctOrthogonal4=function(e){var i=t.normal3([e[0],e[1],e[2]]),r=t.normal3([e[4],e[5],e[6]]),n=t.cross3(i,r);r=t.cross3(n,i),e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=0,e[4]=r[0],e[5]=r[1],e[6]=r[2],e[7]=0,e[8]=n[0],e[9]=n[1],e[10]=n[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1},e.straighten=function(t,e){var i;for(i=0;i<t.length;i++)t[i]=Math.abs(t[i])<e?0:Math.abs(1-t[i])<e?1:Math.abs(-1-t[i])<e?-1:t[i]},function(){var t;for(t=0;r>t;t++)o.push(e.identity4());for(t=0;r>t;t++)a.push(e.identity3())}(),e}),define("modules/containers",[],function(){"use strict";function DirectDoubleLinkedList(){this._first=null,this._last=null,this._length=0}return DirectDoubleLinkedList.prototype.add=function(t){this._first?(this._last.next=t,t.previous=this._last):(this._first=t,t.previous=null),t.next=null,t.list=this,this._last=t,this._length++},DirectDoubleLinkedList.prototype.remove=function(t){t.list===this&&(t.previous?t.previous.next=t.next:this._first=t.next,t.next?t.next.previous=t.previous:this._last=t.previous,t.list=null,this._length--)},DirectDoubleLinkedList.prototype.clear=function(t){var e;if(t)for(e=this._first;e;e=e.next)e.list=null;this._first=null,this._last=null,this._length=0},DirectDoubleLinkedList.prototype.getLength=function(){return this._length},DirectDoubleLinkedList.prototype.getFirst=function(){return this._first},DirectDoubleLinkedList.prototype.getLast=function(){return this._last},DirectDoubleLinkedList.prototype.getNext=function(t){return t&&t.list===this?t.next||this._first:this._first},DirectDoubleLinkedList.prototype.getPrevious=function(t){return t&&t.list===this?t.previous||this._last:this._last},DirectDoubleLinkedList.prototype.appendToArray=function(t){var e,i;for(i=t.length,t.length=i+this._length,e=this._first;e;e=e.next,i++)t[i]=e},{DirectDoubleLinkedList:DirectDoubleLinkedList}}),define("modules/scene/object-3d",["utils/vectors","utils/matrices"],function(t,e){"use strict";function Object3D(t,i,r,n,o,s){this._parent=null,this._positionMatrix=t||e.identity4(),this._orientationMatrix=i||e.identity4(),this._scalingMatrix=r||e.identity4(),this._cascadeScalingMatrix=e.identity4(),this._cascadeScalingMatrixValid=!1,this._modelMatrix=e.identity4(),this._modelMatrixValid=!1,this._modelMatrixForFrame=e.identity4(),this._modelMatrixForFrameValid=!1,this._modelMatrixInverse=e.identity4(),this._modelMatrixInverseValid=!1,this._modelMatrixInverseForFrame=e.identity4(),this._modelMatrixInverseForFrameValid=!1,this._size=void 0!==n?n:1,this._insideParent=null,this._childrenAlwaysInside=o||!1,this._lastSizeInsideViewFrustum={width:-1,height:-1},this._positionMatrixInCameraSpace=e.identity4(),this._positionMatrixInCameraSpaceValid=!1,this._ignoreTransform=s||!1}var i,r;return i=function(){function init(t,i,r,n,o){this._parent=null,e.setMatrix4(this._positionMatrix,t||e.IDENTITY4),e.setMatrix4(this._orientationMatrix,i||e.IDENTITY4),e.setMatrix4(this._scalingMatrix,r||e.IDENTITY4),this._cascadeScalingMatrixValid=!1,this._modelMatrixValid=!1,this._modelMatrixForFrameValid=!1,this._modelMatrixInverseValid=!1,this._modelMatrixInverseForFrameValid=!1,this._size=void 0!==n?n:1,this._insideParent=null,this._childrenAlwaysInside=o||!1,this._lastSizeInsideViewFrustum={width:-1,height:-1},this._positionMatrixInCameraSpaceValid=!1}function resetCachedValues(){this._positionMatrixInCameraSpaceValid=!1,this._modelMatrixForFrameValid=!1,this._modelMatrixInverseForFrameValid=!1}function getParent(){return this._parent}function setParent(t){this._parent=t}function getPositionMatrix(){return this._positionMatrix}function setPositionMatrix(t){this._positionMatrix=t,this._modelMatrix[12]=this._positionMatrix[12],this._modelMatrix[13]=this._positionMatrix[13],this._modelMatrix[14]=this._positionMatrix[14],this._modelMatrixInverseValid=!1,this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this._positionMatrixInCameraSpaceValid=!1}function getPositionVector(){return[this._positionMatrix[12],this._positionMatrix[13],this._positionMatrix[14]]}function setPositionv(t){this._positionMatrix[12]=t[0],this._positionMatrix[13]=t[1],this._positionMatrix[14]=t[2],this._modelMatrix[12]=t[0],this._modelMatrix[13]=t[1],this._modelMatrix[14]=t[2],
this._modelMatrixInverseValid=!1,this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this._positionMatrixInCameraSpaceValid=!1}function setPositionM4(t){this._positionMatrix[12]=t[12],this._positionMatrix[13]=t[13],this._positionMatrix[14]=t[14],this._modelMatrix[12]=t[12],this._modelMatrix[13]=t[13],this._modelMatrix[14]=t[14],this._modelMatrixInverseValid=!1,this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this._positionMatrixInCameraSpaceValid=!1}function translate(t,e,i){this._positionMatrix[12]+=t,this._positionMatrix[13]+=e,this._positionMatrix[14]+=i,this._modelMatrix[12]+=t,this._modelMatrix[13]+=e,this._modelMatrix[14]+=i,this._modelMatrixInverseValid=!1,this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this._positionMatrixInCameraSpaceValid=!1}function translatev(t){this._positionMatrix[12]+=t[0],this._positionMatrix[13]+=t[1],this._positionMatrix[14]+=t[2],this._modelMatrix[12]+=t[0],this._modelMatrix[13]+=t[1],this._modelMatrix[14]+=t[2],this._modelMatrixInverseValid=!1,this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this._positionMatrixInCameraSpaceValid=!1}function translateByMatrix(t){this._positionMatrix[12]+=t[12],this._positionMatrix[13]+=t[13],this._positionMatrix[14]+=t[14],this._modelMatrix[12]+=t[12],this._modelMatrix[13]+=t[13],this._modelMatrix[14]+=t[14],this._modelMatrixInverseValid=!1,this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this._positionMatrixInCameraSpaceValid=!1}function getOrientationMatrix(){return this._orientationMatrix}function setOrientationMatrix(t){t&&(this._orientationMatrix=t),this._modelMatrixValid=!1,this._modelMatrixInverseValid=!1,this._handleOrientationChanged&&this._handleOrientationChanged()}function setOrientationM4(t){e.setMatrix4(this._orientationMatrix,t),this._modelMatrixValid=!1,this._modelMatrixInverseValid=!1,this._handleOrientationChanged&&this._handleOrientationChanged()}function getXDirectionVector(){return[this._orientationMatrix[0],this._orientationMatrix[1],this._orientationMatrix[2]]}function getYDirectionVector(){return[this._orientationMatrix[4],this._orientationMatrix[5],this._orientationMatrix[6]]}function getZDirectionVector(){return[this._orientationMatrix[8],this._orientationMatrix[9],this._orientationMatrix[10]]}function rotate(t,i){0!==i&&(e.rotate4(this._orientationMatrix,t,i),this.setOrientationMatrix())}function rotateByMatrix(t){e.mul4(this._orientationMatrix,t),this.setOrientationMatrix()}function getScalingMatrix(){return this._scalingMatrix}function setScalingMatrix(t){t&&(this._scalingMatrix=t),this._modelMatrixValid=!1,this._modelMatrixInverseValid=!1,this._cascadeScalingMatrixValid=!1}function setScale(t){this._scalingMatrix[0]=t,this._scalingMatrix[5]=t,this._scalingMatrix[10]=t,this.setScalingMatrix()}function getCascadeScalingMatrix(){return this._cascadeScalingMatrixValid||(this._parent&&!this._parent._ignoreTransform?e.setProd3x3SubOf4(this._cascadeScalingMatrix,this._parent.getCascadeScalingMatrix(),this._scalingMatrix):e.setMatrix4(this._cascadeScalingMatrix,this._scalingMatrix),this._cascadeScalingMatrixValid=!0),this._cascadeScalingMatrix}function getModelMatrix(){return this._modelMatrixForFrameValid||(this._modelMatrixValid||(e.setTranslationRotation(this._modelMatrix,this._positionMatrix,e.prod3x3SubOf4Aux(this._scalingMatrix,this._orientationMatrix)),this._modelMatrixValid=!0),this._parent&&!this._parent._ignoreTransform?e.setProd4(this._modelMatrixForFrame,this._modelMatrix,this._parent.getModelMatrix()):e.setMatrix4(this._modelMatrixForFrame,this._modelMatrix),this._modelMatrixForFrameValid=!0),this._modelMatrixForFrame}function getModelMatrixInverse(){return this._modelMatrixInverseForFrameValid||(this._modelMatrixInverseValid||(e.setInverse4(this._modelMatrixInverse,this.getModelMatrix()),this._modelMatrixInverseValid=!0),this._parent&&!this._parent._ignoreTransform?e.setProd4(this._modelMatrixInverseForFrame,this._parent.getModelMatrixInverse(),this._modelMatrixInverse):e.setMatrix4(this._modelMatrixInverseForFrame,this._modelMatrixInverse),this._modelMatrixInverseForFrameValid=!0),this._modelMatrixInverseForFrame}function getSize(){return this._size}function setSize(t){this._size=t}function getScaledSize(){return this.getSize()*this.getCascadeScalingMatrix()[0]}function isInsideParent(){return null===this._insideParent&&(this._insideParent=this._parent?this._parent._childrenAlwaysInside||Math.abs(this._positionMatrix[12])<this._parent.getSize()&&Math.abs(this._positionMatrix[13])<this._parent.getSize()&&Math.abs(this._positionMatrix[14])<this._parent.getSize():!1),this._insideParent}function childrenAlwaysInside(){return this._childrenAlwaysInside}function getPositionMatrixInCameraSpace(i){return this._positionMatrixInCameraSpaceValid||(e.setTranslation4v(this._positionMatrixInCameraSpace,t.prodVec4Mat4Aux(e.translationVector4(this.getModelMatrix()),i.getViewMatrix())),this._positionMatrixInCameraSpaceValid=!0),this._positionMatrixInCameraSpace}function getSizeInsideViewFrustum(i,r){var n,o,s,a,l,h,u,c,p,d,_;return s=this.getPositionMatrixInCameraSpace(i),o=this.getCascadeScalingMatrix(),r&&(n=this.getSize()*o[0],s[14]-n>=-i.getNearDistance()||s[14]+n<-i.getViewDistance())?(this._lastSizeInsideViewFrustum.width=0,this._lastSizeInsideViewFrustum.height=0,this._lastSizeInsideViewFrustum):(a=e.prod34Aux(o,s,i.getProjectionMatrix()),n=this.getSize(),_=1/a[15],l=0===a[12]?0:a[12]*_,h=0===a[13]?0:a[13]*_,u=t.prodVec4Mat4Aux([n,0,0,1],a),c=t.prodVec4Mat4Aux([0,n,0,1],a),p=Math.abs((0===u[0]?0:u[0]/u[3])-l),d=Math.abs((0===c[1]?0:c[1]/c[3])-h),-1>l+p||l-p>1||-1>h+d||h-d>1?(this._lastSizeInsideViewFrustum.width=0,this._lastSizeInsideViewFrustum.height=0,this._lastSizeInsideViewFrustum):(this._lastSizeInsideViewFrustum.width=p,this._lastSizeInsideViewFrustum.height=d,this._lastSizeInsideViewFrustum))}function isInsideShadowRegion(i,r,n){var o,s;return o=t.prodVec4Mat4Aux(e.translationVector4(this.getModelMatrix()),i),s=this.getScaledSize(),Math.abs(o[0])-s<r&&Math.abs(o[1])-s<r&&Math.abs(o[2])-s<r*n}function shouldIgnoreTransform(){return this._ignoreTransform}return function(){this.prototype.init=init,this.prototype.resetCachedValues=resetCachedValues,this.prototype.getParent=getParent,this.prototype.setParent=setParent,this.prototype.getPositionMatrix=getPositionMatrix,this.prototype.setPositionMatrix=setPositionMatrix,this.prototype.setPositionv=setPositionv,this.prototype.setPositionM4=setPositionM4,this.prototype.getOrientationMatrix=getOrientationMatrix,this.prototype.setOrientationMatrix=setOrientationMatrix,this.prototype.setOrientationM4=setOrientationM4,this.prototype.getScalingMatrix=getScalingMatrix,this.prototype.setScalingMatrix=setScalingMatrix,this.prototype.setScale=setScale,this.prototype.getPositionVector=getPositionVector,this.prototype.translate=translate,this.prototype.translatev=translatev,this.prototype.translateByMatrix=translateByMatrix,this.prototype.getXDirectionVector=getXDirectionVector,this.prototype.getYDirectionVector=getYDirectionVector,this.prototype.getZDirectionVector=getZDirectionVector,this.prototype.rotate=rotate,this.prototype.rotateByMatrix=rotateByMatrix,this.prototype.getCascadeScalingMatrix=getCascadeScalingMatrix,this.prototype.getModelMatrix=getModelMatrix,this.prototype.getModelMatrixInverse=getModelMatrixInverse,this.prototype.getSize=getSize,this.prototype.setSize=setSize,this.prototype.getScaledSize=getScaledSize,this.prototype.isInsideParent=isInsideParent,this.prototype.childrenAlwaysInside=childrenAlwaysInside,this.prototype.getPositionMatrixInCameraSpace=getPositionMatrixInCameraSpace,this.prototype.getSizeInsideViewFrustum=getSizeInsideViewFrustum,this.prototype.isInsideShadowRegion=isInsideShadowRegion,this.prototype.shouldIgnoreTransform=shouldIgnoreTransform}},r=i(),r.call(Object3D),{Object3D:Object3D,makeObject3DMixinClass:r}}),define("modules/scene/camera",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/scene/object-3d"],function(t,e,i,r,n){"use strict";function CameraPositionConfiguration(t,e,r,n,o,s,a,l,h,u){this._fixed=t,this._turnsAroundObjects=e,this._movesRelativeToObject=r,this._followedObjects=n||[],this._startsWithRelativePosition=o,this._defaultRelativePositionMatrix=i.matrix4(s),this._relativePositionMatrix=s,this._worldPositionMatrix=i.identity4(),this._worldPositionMatrixValid=!1,this._distanceIsConfined=a?!0:!1,this._minimumDistance=a?a[0]:0,this._maximumDistance=a?a[1]:0,this._xIsConfined=l&&l[0]?!0:!1,this._minimumX=l&&l[0]?l[0][0]:0,this._maximumX=l&&l[0]?l[0][1]:0,this._yIsConfined=l&&l[1]?!0:!1,this._minimumY=l&&l[1]?l[1][0]:0,this._maximumY=l&&l[1]?l[1][1]:0,this._zIsConfined=l&&l[2]?!0:!1,this._minimumZ=l&&l[2]?l[2][0]:0,this._maximumZ=l&&l[2]?l[2][1]:0,this._resetsWhenLeavingConfines=h,this._isTransitionConfiguration=u,this._isStarting=!0,this._camera=null}function CameraOrientationConfiguration(t,e,r,n,h,u,c,p,d,_,g,m){this._fixed=t,this._pointsTowardsObjects=e,this._fps=r,this._followedObjects=n||[],this._defaultRelativeOrientationMatrix=i.matrix4(h),this._relativeOrientationMatrix=h,this._worldOrientationMatrix=i.identity4(),this._worldOrientationMatrixValid=!1,this._defaultAlpha=u||0,this._alpha=u||0,this._defaultBeta=c||0,this._beta=c||0,this._minAlpha=p&&void 0!==p[0]?p[0]:o,this._maxAlpha=p&&void 0!==p[1]?p[1]:s,this._minBeta=d&&void 0!==d[0]?d[0]:a,this._maxBeta=d&&void 0!==d[1]?d[1]:l,this._baseOrientation=_,this._pointToFallback=g,this._isTransitionConfiguration=m,this._camera=null}function CameraConfiguration(t,e,i,r,o,s,a,l,h){n.Object3D.call(this,e._positionMatrix,i._orientationMatrix),this._name=t,this._positionConfiguration=e,this._orientationConfiguration=i,this._defaultFOV=r,this._fov=r,this._minFOV=o?o[0]:0,this._maxFOV=o?o[1]:0,this._defaultSpan=s,this._span=s,this._minSpan=a?a[0]:0,this._maxSpan=a?a[1]:0,this._resetsOnFocusChange=l,this._excludeFromCycle=h,this._camera=null}function getFreeCameraConfiguration(e,r,n,o,s,a,l,h,u){var c=i.getYawAndPitch(n);return new CameraConfiguration(t.EMPTY_STRING,new CameraPositionConfiguration(!1,!1,!1,[],!1,i.matrix4(r),null,null,!1),new CameraOrientationConfiguration(!1,!1,e,[],i.matrix4(n),Math.degrees(c.yaw),Math.degrees(c.pitch),void 0,void 0,CameraOrientationConfiguration.BaseOrientation.WORLD,CameraOrientationConfiguration.PointToFallback.POSITION_FOLLOWED_OBJECT_OR_WORLD),o,[s,a],l,[h,u])}function Camera(t,e,r,o,s,a,l){this._object3D=new n.Object3D(i.identity4(),i.identity4(),i.identity4()),this._scene=t,this._aspect=e,this._usesVerticalValues=r,this._viewDistance=o,this._previousConfiguration=null,this._currentConfiguration=s,this._currentConfiguration.setCamera(this),this._transitionStyle=Camera.TransitionStyle.NONE,this._defaultTransitionStyle=l||Camera.TransitionStyle.NONE,this._transitionDuration=0,this._defaultTransitionDuration=a||0,this._transitionElapsedTime=0,this._velocityVector=[0,0,0],this._controlledVelocityVector=[0,0,0],this._angularVelocityVector=[0,0,0],this._previousFollowedPositionVector=null,this._projectionMatrix=i.identity4(),this._projectionMatrixValid=!1,this._followedNode=null,this._viewMatrix=i.identity4(),this._viewMatrixValid=!1,this._inversePositionMatrix=i.identity4(),this._inversePositionMatrixValid=!1,this._inverseOrientationMatrix=i.identity4(),this._inverseOrientationMatrixValid=!1,this._fov=0,this._span=0,this._near=0,this._extendedCamera=null,this._extendedCameraValid=!1,this._combinedExtendedCamera=null,this._combinedExtendedCameraValid=!1,this._updateFOV(),this._updateSpan()}var o=-360,s=360,a=-90,l=90,h=.95,u=1.05,c=.95,p=1.05,d=5;return CameraPositionConfiguration.prototype.init=function(t,e,r,n,o,s,a,l,h,u){this._fixed=t,this._turnsAroundObjects=e,this._movesRelativeToObject=r,this._followedObjects=n||[],this._startsWithRelativePosition=o,i.setMatrix4(this._defaultRelativePositionMatrix,s),i.setMatrix4(this._relativePositionMatrix,s),i.setIdentity4(this._worldPositionMatrix),this._worldPositionMatrixValid=!1,this._distanceIsConfined=a?!0:!1,this._minimumDistance=a?a[0]:0,this._maximumDistance=a?a[1]:0,this._xIsConfined=l&&l[0]?!0:!1,this._minimumX=l&&l[0]?l[0][0]:0,this._maximumX=l&&l[0]?l[0][1]:0,this._yIsConfined=l&&l[1]?!0:!1,this._minimumY=l&&l[1]?l[1][0]:0,this._maximumY=l&&l[1]?l[1][1]:0,this._zIsConfined=l&&l[2]?!0:!1,this._minimumZ=l&&l[2]?l[2][0]:0,this._maximumZ=l&&l[2]?l[2][1]:0,this._resetsWhenLeavingConfines=h,this._isTransitionConfiguration=u,this._isStarting=!0,this._camera=null},CameraPositionConfiguration.prototype.copy=function(t){var e=new CameraPositionConfiguration(this._fixed,this._turnsAroundObjects,this._movesRelativeToObject,this._followedObjects.slice(),this._startsWithRelativePosition,i.matrix4(this._defaultRelativePositionMatrix),this._distanceIsConfined?[this._minimumDistance,this._maximumDistance]:null,[this._xIsConfined?[this._minimumX,this._maximumX]:null,this._yIsConfined?[this._minimumY,this._maximumY]:null,this._zIsConfined?[this._minimumZ,this._maximumZ]:null],this._resetsWhenLeavingConfines,t);return e._relativePositionMatrix=i.matrix4(this._relativePositionMatrix),e._worldPositionMatrix=i.matrix4(this._worldPositionMatrix),e._isStarting=this._isStarting,e},CameraPositionConfiguration.prototype.setCamera=function(t,e){t&&this._camera!==t&&this._startsWithRelativePosition&&!e&&this.resetToDefaults(!0),this._camera=t},CameraPositionConfiguration.prototype.resetToDefaults=function(t){this._camera&&!t&&this._camera.positionConfigurationWillChange(),i.setMatrix4(this._relativePositionMatrix,this._defaultRelativePositionMatrix),this._worldPositionMatrixValid=!1,this._isStarting=!0},CameraPositionConfiguration.prototype.setRelativePositionMatrix=function(t,e){this._camera&&!e&&this._camera.positionConfigurationWillChange(),this._relativePositionMatrix=t},CameraPositionConfiguration.prototype.moveByVector=function(t,e){this._camera&&!e&&this._camera.positionConfigurationWillChange(),i.translateByVector(this._relativePositionMatrix,t)},CameraPositionConfiguration.prototype.followsObjects=function(e){return e?t.arraysEqual(this._followedObjects.sort(),e.sort()):this._followedObjects.length>0&&!this._startsWithRelativePosition},CameraPositionConfiguration.prototype.getFollowedPositionVector=function(){var t,i=[0,0,0];if(0===this._followedObjects.length)r.crash();else{for(t=0;t<this._followedObjects.length;t++)e.add3(i,this._followedObjects[t].getPositionVector());i=[i[0]/this._followedObjects.length,i[1]/this._followedObjects.length,i[2]/this._followedObjects.length]}return i},CameraPositionConfiguration.prototype.getFollowedPositionMatrix=function(){var t,e=i.identity4Aux();if(0===this._followedObjects.length)r.crash();else{for(t=0;t<this._followedObjects.length;t++)i.translateByMatrix(e,this._followedObjects[t]._positionMatrix);e=i.translation4Aux(e[12]/this._followedObjects.length,e[13]/this._followedObjects.length,e[14]/this._followedObjects.length)}return e},CameraPositionConfiguration.prototype.getFollowedObjectOrientationMatrix=function(){return 0===this._followedObjects.length?(r.crash(),null):this._followedObjects[0]._orientationMatrix},CameraPositionConfiguration.prototype._cleanupFollowedObjects=function(){var t,e,r;for(t=0;t<this._followedObjects.length;t++){for(e=t,r=0;e<this._followedObjects.length&&(!this._followedObjects[e]||this._followedObjects[e].canBeReused()===!0);)e++,r++;r>0&&(this._followedObjects.splice(t,r),0===this._followedObjects.length&&i.setMatrix4(this._relativePositionMatrix,this._worldPositionMatrixValid&&this._worldPositionMatrix||this._relativePositionMatrix||this._defaultRelativePositionMatrix))}},CameraPositionConfiguration.prototype._calculateWorldPositionMatrix=function(t){this._followedObjects.length>0&&(!this._startsWithRelativePosition||this._isStarting)?(this._isStarting=!1,this._turnsAroundObjects?t?i.setTranslatedByM4(this._worldPositionMatrix,i.translation4m4Aux(i.prodTranslationRotation4Aux(this._relativePositionMatrix,i.prod3x3SubOf4Aux(i.ROTATION_X_90,t))),this.getFollowedPositionMatrix()):r.crash():i.setTranslatedByM4(this._worldPositionMatrix,i.translation4m4Aux(i.prodTranslationRotation4Aux(this._relativePositionMatrix,this.getFollowedObjectOrientationMatrix())),this.getFollowedPositionMatrix()),this._startsWithRelativePosition&&i.setMatrix4(this._relativePositionMatrix,this._worldPositionMatrix)):i.setMatrix4(this._worldPositionMatrix,this._relativePositionMatrix),this._worldPositionMatrixValid=!0},CameraPositionConfiguration.prototype.getWorldPositionMatrix=function(t){return this._worldPositionMatrixValid||this._calculateWorldPositionMatrix(t),this._worldPositionMatrix},CameraPositionConfiguration.prototype._checkConfines=function(t){var n,o,s;if(s=this._startsWithRelativePosition&&!this._isStarting&&this._followedObjects.length>0?i.translation4m4Aux(i.prodTranslationRotation4Aux(i.translatedByM4Aux(this._relativePositionMatrix,i.inverseOfTranslation4Aux(this.getFollowedPositionMatrix())),i.inverseOfRotation4Aux(this.getFollowedObjectOrientationMatrix()))):this._relativePositionMatrix,this._distanceIsConfined)if(this._followedObjects.length>0){if(n=i.translationVector3(s),o=e.length3(n),o<this._minimumDistance||o>this._maximumDistance){if(o>this._maximumDistance&&this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;o=Math.min(Math.max(o,this._minimumDistance),this._maximumDistance),s=i.translation4vAux(e.scaled3(e.normal3(n),o))}}else if(t&&(n=e.diff3Aux(i.translationVector3(s),t),o=e.length3(n),o<this._minimumDistance||o>this._maximumDistance)){if(o>this._maximumDistance&&this._resetsWhenLeavingConfines)return r.crash(),!1;o=Math.min(Math.max(o,this._minimumDistance),this._maximumDistance),s=i.translation4vAux(e.sum3(t,e.scaled3(e.normal3(n),o)))}if(this._xIsConfined&&(s[12]<this._minimumX||s[12]>this._maximumX)){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;s[12]=Math.min(Math.max(s[12],this._minimumX),this._maximumX)}if(this._yIsConfined&&(s[13]<this._minimumY||s[13]>this._maximumY)){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;s[13]=Math.min(Math.max(s[13],this._minimumY),this._maximumY)}if(this._zIsConfined&&(s[14]<this._minimumZ||s[14]>this._maximumZ)){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;s[14]=Math.min(Math.max(s[14],this._minimumZ),this._maximumZ)}return this._startsWithRelativePosition&&!this._isStarting&&this._followedObjects.length>0?i.setTranslatedByM4(this._relativePositionMatrix,i.translation4m4Aux(i.prodTranslationRotation4Aux(s,this.getFollowedObjectOrientationMatrix())),this.getFollowedPositionMatrix()):i.setMatrix4(this._relativePositionMatrix,s),!0},CameraPositionConfiguration.prototype.update=function(t,r,n,o){var s,a;if(!this._fixed)if(0===this._followedObjects.length||this._startsWithRelativePosition)s=e.scaled3(e.prodVec3Mat4Aux(n,t),o/1e3),i.translateByVector(this._relativePositionMatrix,s);else if(this._turnsAroundObjects){if(this._distanceIsConfined){if(s=i.translationVector3(this._relativePositionMatrix),a=e.length3(s)+n[2]*o/1e3,a<this._minimumDistance||a>this._maximumDistance){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;n[2]=0,a=Math.min(Math.max(a,this._minimumDistance),this._maximumDistance)}i.setTranslation4v(this._relativePositionMatrix,e.scaled3(e.normal3(s),a))}}else this._movesRelativeToObject?i.translateByVector(this._relativePositionMatrix,e.scaled3(e.prodVec3Mat4Aux(n,i.ROTATION_X_270),.001*o)):i.translateByVector(this._relativePositionMatrix,e.scaled3(e.prodVec3Mat4Aux(n,i.prod3x3SubOf4Aux(t,i.inverseOfRotation4Aux(this.getFollowedObjectOrientationMatrix()))),.001*o));if(!this._isTransitionConfiguration){if(!this._checkConfines(r))return!1;this._cleanupFollowedObjects()}return this._worldPositionMatrixValid=!1,!0},CameraOrientationConfiguration.BaseOrientation={WORLD:"world",POSITION_FOLLOWED_OBJECTS:"positionFollowedObjects",ORIENTATION_FOLLOWED_OBJECT:"orientationFollowedObject"},Object.freeze(CameraOrientationConfiguration.BaseOrientation),CameraOrientationConfiguration.PointToFallback={WORLD:"world",STATIONARY:"stationary",POSITION_FOLLOWED_OBJECT_OR_WORLD:"positionFollowedObjectOrWorld"},Object.freeze(CameraOrientationConfiguration.PointToFallback),CameraOrientationConfiguration.prototype.init=function(t,e,r,n,h,u,c,p,d,_,g,m){this._fixed=t,this._pointsTowardsObjects=e,this._fps=r,this._followedObjects=n||[],i.setMatrix4(this._defaultRelativeOrientationMatrix,h),i.setMatrix4(this._relativeOrientationMatrix,h),i.setIdentity4(this._worldOrientationMatrix),this._worldOrientationMatrixValid=!1,this._defaultAlpha=u||0,this._alpha=u||0,this._defaultBeta=c||0,this._beta=c||0,this._minAlpha=p&&void 0!==p[0]?p[0]:o,this._maxAlpha=p&&void 0!==p[1]?p[1]:s,this._minBeta=d&&void 0!==d[0]?d[0]:a,this._maxBeta=d&&void 0!==d[1]?d[1]:l,this._baseOrientation=_,this._pointToFallback=g,this._isTransitionConfiguration=m,this._camera=null},CameraOrientationConfiguration.prototype.copy=function(t){var e=new CameraOrientationConfiguration(this._fixed,this._pointsTowardsObjects,this._fps,this._followedObjects.slice(),i.matrix4(this._defaultRelativeOrientationMatrix),this._alpha,this._beta,[this._minAlpha,this._maxAlpha],[this._minBeta,this._maxBeta],this._baseOrientation,this._pointToFallback,t);return e._relativeOrientationMatrix=i.matrix4(this._relativeOrientationMatrix),e._worldOrientationMatrix=i.matrix4(this._worldOrientationMatrix),e},CameraOrientationConfiguration.prototype.setCamera=function(t){this._camera=t},CameraOrientationConfiguration.prototype.resetToDefaults=function(t){this._camera&&!t&&this._camera.orientationConfigurationWillChange(),i.setMatrix4(this._relativeOrientationMatrix,this._defaultRelativeOrientationMatrix),this._alpha=this._defaultAlpha,this._beta=this._defaultBeta,this._worldOrientationMatrixValid=!1},CameraOrientationConfiguration.prototype.setRelativeOrientationMatrix=function(t,e){this._camera&&!e&&this._camera.orientationConfigurationWillChange(),this._relativeOrientationMatrix=t},CameraOrientationConfiguration.prototype.isFPS=function(){return this._fps},CameraOrientationConfiguration.prototype.followsObjects=function(e){return e?t.arraysEqual(this._followedObjects.sort(),e.sort()):this._followedObjects.length>0},CameraOrientationConfiguration.prototype.setFollowedObjects=function(t,e){(0!==this._followedObjects.length||0!==t.length)&&(this._camera&&!e&&this._camera.orientationConfigurationWillChange(),this._followedObjects=t)},CameraOrientationConfiguration.prototype.setFollowedObject=function(t,e){(1!==this._followedObjects.length||this._followedObjects[0]!==t)&&this.setFollowedObjects([t],e)},CameraOrientationConfiguration.prototype.getFollowedObjectsPositionVector=function(){var t,i=[0,0,0];if(0===this._followedObjects.length)r.crash();else{for(t=0;t<this._followedObjects.length;t++)e.add3(i,this._followedObjects[t].getPositionVector());i=[i[0]/this._followedObjects.length,i[1]/this._followedObjects.length,i[2]/this._followedObjects.length]}return i},CameraOrientationConfiguration.prototype.getFollowedOrientationMatrix=function(){return 0===this._followedObjects.length?(r.crash(),null):this._followedObjects[0]._orientationMatrix},CameraOrientationConfiguration.prototype._cleanupFollowedObjects=function(){var t,e,r;for(t=0;t<this._followedObjects.length;t++){for(e=t,r=0;e<this._followedObjects.length&&(!this._followedObjects[e]||this._followedObjects[e].canBeReused()===!0);)e++,r++;if(r>0){if(this._followedObjects.length===r)return this._camera&&this._camera.orientationConfigurationWillChange(),this._pointsTowardsObjects||(i.setMatrix4(this._relativeOrientationMatrix,this._worldOrientationMatrixValid&&this._worldOrientationMatrix||this._relativeOrientationMatrix||this._defaultRelativeOrientationMatrix),this._fps=!1),this._followedObjects.splice(t,r),!1;this._followedObjects.splice(t,r)}}return!0},CameraOrientationConfiguration.prototype._calculateWorldOrientationMatrix=function(t,n){var o,s,a,l=function(t){i.setProd3x3SubOf4(this._worldOrientationMatrix,i.prod3x3SubOf4Aux(i.ROTATION_X_270,this._relativeOrientationMatrix),t)}.bind(this),h=function(){this._fps?i.setProd3x3SubOf4(this._worldOrientationMatrix,i.ROTATION_X_270,this._relativeOrientationMatrix):i.setMatrix4(this._worldOrientationMatrix,this._relativeOrientationMatrix)}.bind(this);if(this._followedObjects.length>0)if(this._pointsTowardsObjects)if(t)if(s=e.normal3(e.diff3(this.getFollowedObjectsPositionVector(),i.translationVector3(t))),this._fps){switch(this._baseOrientation){case CameraOrientationConfiguration.BaseOrientation.WORLD:o=null;break;case CameraOrientationConfiguration.BaseOrientation.POSITION_FOLLOWED_OBJECTS:o=n||null;break;case CameraOrientationConfiguration.BaseOrientation.ORIENTATION_FOLLOWED_OBJECT:o=this.followsObjects()?this.getFollowedOrientationMatrix():null;break;default:r.crash()}o?s=e.prodVec3Mat4Aux(s,i.inverseOfRotation4Aux(o)):o=i.IDENTITY4,this._alpha=e.angle2uCapped([0,1],e.normal2([s[0],s[1]])),s[0]<0&&(this._alpha=-this._alpha),i.setProd3x3SubOf4(this._worldOrientationMatrix,i.ROTATION_X_270,i.rotationZ4Aux(this._alpha)),this._beta=e.angle3uCapped(i.getRowC43Neg(this._worldOrientationMatrix),s),s[2]>0&&(this._beta=-this._beta),i.setProd3x3SubOf4(this._worldOrientationMatrix,i.prod3x3SubOf4Aux(i.ROTATION_X_270,i.rotationX4Aux(this._beta)),i.rotationZ4Aux(this._alpha)),i.mul4(this._worldOrientationMatrix,o)}else this._worldOrientationMatrix[8]=s[0],this._worldOrientationMatrix[9]=s[1],this._worldOrientationMatrix[10]=s[2],this._worldOrientationMatrix[11]=0,a=e.cross3(e.UNIT3_X,s),this._worldOrientationMatrix[4]=a[0],this._worldOrientationMatrix[5]=a[1],this._worldOrientationMatrix[6]=a[2],this._worldOrientationMatrix[7]=0,a=e.cross3(s,a),this._worldOrientationMatrix[0]=a[0],this._worldOrientationMatrix[1]=a[1],this._worldOrientationMatrix[2]=a[2],this._worldOrientationMatrix[3]=0,this._worldOrientationMatrix[12]=0,this._worldOrientationMatrix[13]=0,this._worldOrientationMatrix[14]=0,this._worldOrientationMatrix[15]=1,i.correctOrthogonal4(this._worldOrientationMatrix);else r.crash();else l(this.getFollowedOrientationMatrix());else if(this._pointsTowardsObjects)switch(this._pointToFallback){case CameraOrientationConfiguration.PointToFallback.WORLD:h();break;case CameraOrientationConfiguration.PointToFallback.STATIONARY:i.setIdentity4(this._worldOrientationMatrix);break;case CameraOrientationConfiguration.PointToFallback.POSITION_FOLLOWED_OBJECT_OR_WORLD:n?l(n):h();break;default:r.crash()}else h();this._worldOrientationMatrixValid=!0},CameraOrientationConfiguration.prototype.getWorldOrientationMatrix=function(t,e){return this._worldOrientationMatrixValid||this._calculateWorldOrientationMatrix(t,e),this._worldOrientationMatrix},CameraOrientationConfiguration.prototype.update=function(t,r){return!this._pointsTowardsObjects||this.followsObjects()||this._pointToFallback!==CameraOrientationConfiguration.PointToFallback.STATIONARY?(this._fixed||(this._fps?(this._alpha+=t[1]*r/1e3,this._beta+=t[0]*r/1e3,this._alpha>=360&&(this._alpha-=360),this._alpha<=-360&&(this._alpha+=360),this._beta>=360&&(this._beta-=360),this._beta<=-360&&(this._beta+=360),this._alpha=Math.min(Math.max(this._minAlpha,this._alpha),this._maxAlpha),this._beta=Math.min(Math.max(this._minBeta,this._beta),this._maxBeta),i.setProd3x3SubOf4(this._relativeOrientationMatrix,i.rotationX4Aux(this._beta*Math.PI/180),i.rotationZ4Aux(this._alpha*Math.PI/180))):this._followedObjects.length>0?i.mul4(this._relativeOrientationMatrix,i.prod34Aux(i.rotation4Aux(e.normal3(i.getRowB43(this._relativeOrientationMatrix)),t[2]*Math.PI/180*r/1e3),i.rotation4Aux(e.normal3(i.getRowA43(this._relativeOrientationMatrix)),t[0]*Math.PI/180*r/1e3),i.rotation4Aux(e.normal3(i.getRowC43(this._relativeOrientationMatrix)),t[1]*Math.PI/180*r/1e3))):i.mul4(this._relativeOrientationMatrix,i.prod34Aux(i.rotation4Aux(e.normal3(i.getRowC43(this._relativeOrientationMatrix)),t[2]*Math.PI/180*r/1e3),i.rotation4Aux(e.normal3(i.getRowA43(this._relativeOrientationMatrix)),t[0]*Math.PI/180*r/1e3),i.rotation4Aux(e.normal3(i.getRowB43(this._relativeOrientationMatrix)),t[1]*Math.PI/180*r/1e3)))),this._isTransitionConfiguration||this._cleanupFollowedObjects()?(this._worldOrientationMatrixValid=!1,!0):!1):void 0},n.makeObject3DMixinClass.call(CameraConfiguration),CameraConfiguration.prototype.init=function(t,e,i,r,o,s,a,l,h){n.Object3D.prototype.init.call(this,e._positionMatrix,i._orientationMatrix),this._name=t,this._positionConfiguration=e,this._orientationConfiguration=i,this._defaultFOV=r,this._fov=r,this._minFOV=o?o[0]:0,this._maxFOV=o?o[1]:0,this._defaultSpan=s,this._span=s,this._minSpan=a?a[0]:0,this._maxSpan=a?a[1]:0,this._resetsOnFocusChange=l,this._excludeFromCycle=h,this._camera=null},CameraConfiguration.prototype.copy=function(e,r){var n=new CameraConfiguration(e||t.EMPTY_STRING,this._positionConfiguration.copy(r),this._orientationConfiguration.copy(r),this._fov,[this._minFOV,this._maxFOV],this._span,[this._minSpan,this._maxSpan]);return n.setPositionMatrix(i.matrix4(this._positionMatrix)),n.setOrientationMatrix(i.matrix4(this._orientationMatrix)),n},CameraConfiguration.prototype.setCamera=function(t,e){this._camera=t,this._positionConfiguration.setCamera(t,e),this._orientationConfiguration.setCamera(t),this._camera&&this._resetsOnFocusChange&&!e&&this.resetToDefaults(!0)},CameraConfiguration.prototype.setRelativePositionMatrix=function(t,e){this._positionConfiguration.setRelativePositionMatrix(t,e)},CameraConfiguration.prototype.moveByVector=function(t,e){this._positionConfiguration.moveByVector(t,e)},CameraConfiguration.prototype.setRelativeOrientationMatrix=function(t,e){this._orientationConfiguration.setRelativeOrientationMatrix(t,e)},CameraConfiguration.prototype.getName=function(){return this._name},CameraConfiguration.prototype.isFPS=function(){return this._orientationConfiguration.isFPS()},CameraConfiguration.prototype.setFOV=function(t,e){this._camera&&!e&&this._camera.configurationWillChange(),this._fov=Math.min(Math.max(t,this._minFOV),this._maxFOV)},CameraConfiguration.prototype.getFOV=function(){return this._fov},CameraConfiguration.prototype.getMinFOV=function(){return this._minFOV},CameraConfiguration.prototype.getMaxFOV=function(){return this._maxFOV},CameraConfiguration.prototype.decreaseFOV=function(){return this.setFOV(this._fov*h,!0),this._fov},CameraConfiguration.prototype.increaseFOV=function(){return this.setFOV(this._fov*u,!0),this._fov},CameraConfiguration.prototype.setSpan=function(t,e){this._camera&&!e&&this._camera.configurationWillChange(),this._span=Math.min(Math.max(t,this._minSpan),this._maxSpan)},CameraConfiguration.prototype.getSpan=function(){return this._span},CameraConfiguration.prototype.getMinSpan=function(){return this._minSpan},CameraConfiguration.prototype.getMaxSpan=function(){return this._maxSpan},CameraConfiguration.prototype.decreaseSpan=function(){return this.setSpan(this._span*c,!0),this._span},CameraConfiguration.prototype.increaseSpan=function(){return this.setSpan(this._span*p,!0),this._span},CameraConfiguration.prototype.resetsOnFocusChange=function(){return this._resetsOnFocusChange},CameraConfiguration.prototype.shouldExcludeFromCycle=function(){return this._excludeFromCycle},CameraConfiguration.prototype.resetToDefaults=function(t){this._camera&&!t&&this._camera.configurationWillChange(),this.setFOV(this._defaultFOV,!0),this.setSpan(this._defaultSpan,!0),this._positionConfiguration.resetToDefaults(!0),this._orientationConfiguration.resetToDefaults(!0)},CameraConfiguration.prototype.update=function(t,e,i){var r=!0;return r=this._orientationConfiguration.update(e,i),this.setOrientationMatrix(this._orientationConfiguration.getWorldOrientationMatrix(this._positionMatrix,this._positionConfiguration.followsObjects()?this._positionConfiguration.getFollowedObjectOrientationMatrix():null)),
r=this._positionConfiguration.update(this._orientationMatrix,this._orientationConfiguration.followsObjects()?this._orientationConfiguration.getFollowedObjectsPositionVector():null,t,i)&&r,this.setPositionMatrix(this._positionConfiguration.getWorldPositionMatrix(this._orientationMatrix)),r},CameraConfiguration.prototype.positionFollowsObjects=function(){return this._positionConfiguration.followsObjects()},CameraConfiguration.prototype.orientationFollowsObjects=function(){return this._orientationConfiguration.followsObjects()},CameraConfiguration.prototype.getFollowedPositionVector=function(){return this._positionConfiguration.getFollowedPositionVector()},CameraConfiguration.prototype.setOrientationFollowedObjects=function(t,e){this._orientationConfiguration.setFollowedObjects(t,e)},CameraConfiguration.prototype.setToFree=function(e,r,n,o,s,a,l,h,u){var c=i.getYawAndPitch(n);this._positionConfiguration.init(!1,!1,!1,[],!1,r,null,null,!1),this._orientationConfiguration.init(!1,!1,e,[],n,Math.degrees(c.yaw),Math.degrees(c.pitch),void 0,void 0,CameraOrientationConfiguration.BaseOrientation.WORLD,CameraOrientationConfiguration.PointToFallback.POSITION_FOLLOWED_OBJECT_OR_WORLD),this.init(t.EMPTY_STRING,this._positionConfiguration,this._orientationConfiguration,o,[s,a],l,[h,u])},CameraConfiguration.prototype.destroy=function(){this._positionConfiguration=null,this._orientationConfiguration=null,this._camera=null},Camera.TransitionStyle={NONE:"none",LINEAR:"linear",SMOOTH:"smooth"},Object.freeze(Camera.TransitionStyle),Camera.prototype.init=function(t,e,r,n,o,s,a){this._object3D.init(i.IDENTITY4,i.IDENTITY4,i.IDENTITY4),this._scene=t,this._aspect=e,this._usesVerticalValues=r,this._viewDistance=n,this._previousConfiguration=null,this._currentConfiguration=o,this._currentConfiguration.setCamera(this),this._transitionStyle=Camera.TransitionStyle.NONE,this._defaultTransitionStyle=a||Camera.TransitionStyle.NONE,this._transitionDuration=0,this._defaultTransitionDuration=s||0,this._transitionElapsedTime=0,this._velocityVector=[0,0,0],this._controlledVelocityVector=[0,0,0],this._angularVelocityVector=[0,0,0],this._previousFollowedPositionVector=null,i.setIdentity4(this._projectionMatrix),this._projectionMatrixValid=!1,this._followedNode=null,i.setIdentity4(this._viewMatrix),this._viewMatrixValid=!1,i.setIdentity4(this._inversePositionMatrix),this._inversePositionMatrixValid=!1,i.setIdentity4(this._inverseOrientationMatrix),this._inverseOrientationMatrixValid=!1,this._fov=0,this._span=0,this._near=0,this._extendedCamera=null,this._extendedCameraValid=!1,this._combinedExtendedCamera=null,this._combinedExtendedCameraValid=!1,this._updateFOV(),this._updateSpan()},Camera.prototype.getViewDistance=function(){return this._viewDistance},Camera.prototype.getNearDistance=function(){return this._near},Camera.prototype.getCameraPositionMatrix=function(){return this._object3D._positionMatrix},Camera.prototype.getCameraPositionVector=function(){return this._object3D.getPositionVector()},Camera.prototype.getCameraOrientationMatrix=function(){return this._object3D._orientationMatrix},Camera.prototype._setPositionMatrix=function(t){this._object3D.setPositionMatrix(t),this._viewMatrixValid=!1,this._inversePositionMatrixValid=!1},Camera.prototype._setPositionv=function(t){this._object3D.setPositionv(t),this._viewMatrixValid=!1,this._inversePositionMatrixValid=!1},Camera.prototype._setPositionM4=function(t){this._object3D.setPositionM4(t),this._viewMatrixValid=!1,this._inversePositionMatrixValid=!1},Camera.prototype._setOrientationMatrix=function(t){this._object3D.setOrientationMatrix(t),this._viewMatrixValid=!1,this._inverseOrientationMatrixValid=!1},Camera.prototype._setOrientationM4=function(t){this._object3D.setOrientationM4(t),this._viewMatrixValid=!1,this._inverseOrientationMatrixValid=!1},Camera.prototype._rotate=function(t,e){this._object3D.rotate(t,e),this._setOrientationMatrix()},Camera.prototype.moveToPosition=function(t,e,r){e=void 0===e?this._defaultTransitionDuration:e,e>0&&this.transitionToSameConfiguration(e,r),this._currentConfiguration.setRelativePositionMatrix(i.translation4v(t),!0)},Camera.prototype.getViewMatrix=function(){return this._viewMatrixValid||(i.setProdTranslationRotation4(this._viewMatrix,this.getInversePositionMatrix(),this.getInverseOrientationMatrix()),this._viewMatrixValid=!0),this._viewMatrix},Camera.prototype.getInversePositionMatrix=function(){return this._inversePositionMatrixValid||(i.setInverseOfTranslation4(this._inversePositionMatrix,this._object3D._positionMatrix),this._inversePositionMatrixValid=!0),this._inversePositionMatrix},Camera.prototype.getInverseOrientationMatrix=function(){return this._inverseOrientationMatrixValid||(i.setInverseOfRotation4(this._inverseOrientationMatrix,this._object3D._orientationMatrix),this._inverseOrientationMatrixValid=!0),this._inverseOrientationMatrix},Camera.prototype.getConfiguration=function(){return this._currentConfiguration},Camera.prototype.getVelocityVector=function(){return this._velocityVector},Camera.prototype.getProjectionMatrix=function(){return this._projectionMatrixValid||this._updateProjectionMatrix(this.getFOV(),this.getSpan()),this._projectionMatrix},Camera.prototype._updateProjectionMatrix=function(t,e){this._near=e/2/Math.tan(Math.radians(t)/2),this._usesVerticalValues?i.setPerspective4(this._projectionMatrix,e*this._aspect/2,e/2,this._near,this._viewDistance):i.setPerspective4(this._projectionMatrix,e/2,e/this._aspect/2,this._near,this._viewDistance),this._projectionMatrixValid=!0},Camera.prototype.getAspect=function(){return this._aspect},Camera.prototype.setAspect=function(t){this._aspect!==t&&(this._aspect=t,this._projectionMatrixValid=!1)},Camera.prototype.getFOV=function(){return this._fov||this._updateFOV(this._getTransitionProgress()),this._fov},Camera.prototype.setFOV=function(t,e,i){e=void 0===e?this._defaultTransitionDuration:e,e>0?this.transitionToSameConfiguration(e,i):this._fov=t,this._currentConfiguration.setFOV(t,!0),this._projectionMatrixValid=!1},Camera.prototype.decreaseFOV=function(){this._fov=this._currentConfiguration.decreaseFOV(),this._projectionMatrixValid=!1},Camera.prototype.increaseFOV=function(){this._fov=this._currentConfiguration.increaseFOV(),this._projectionMatrixValid=!1},Camera.prototype.getSpan=function(){return this._span||this._updateSpan(this._getTransitionProgress()),this._span},Camera.prototype.setSpan=function(t,e,i){e=void 0===e?this._defaultTransitionDuration:e,e>0?this.transitionToSameConfiguration(e,i):this._span=t,this._currentConfiguration.setSpan(t,!0),this._projectionMatrixValid=!1},Camera.prototype.decreaseSpan=function(){this._span=this._currentConfiguration.decreaseSpan(),this._projectionMatrixValid=!1},Camera.prototype.increaseSpan=function(){this._span=this._currentConfiguration.increaseSpan(),this._projectionMatrixValid=!1},Camera.prototype.setControlledVelocityVector=function(t){this._controlledVelocityVector=t},Camera.prototype.setAngularVelocityVector=function(t){this._angularVelocityVector=t},Camera.prototype._getFreeCameraConfiguration=function(t,e,r){return void 0===t&&(t=this._currentConfiguration.isFPS()),e=e||this.getCameraPositionMatrix(),r=r||this.getCameraOrientationMatrix(),t&&(r=i.prod3x3SubOf4Aux(i.ROTATION_X_90,r)),getFreeCameraConfiguration(t,e,r,this.getFOV(),this._currentConfiguration.getMinFOV(),this._currentConfiguration.getMaxFOV(),this.getSpan(),this._currentConfiguration.getMinSpan(),this._currentConfiguration.getMaxSpan())},Camera.prototype.setConfiguration=function(t,e){this._currentConfiguration&&this._currentConfiguration.setCamera(null),this._currentConfiguration=t,this._previousConfiguration=null,this._updateFOV(),this._updateSpan(),this._updateProjectionMatrix(this._fov,this._span),this._currentConfiguration.setCamera(this,e)},Camera.prototype.startTransitionToConfiguration=function(t,e,i){this._currentConfiguration!==t&&(0===e?this.setConfiguration(t):(this._previousConfiguration&&this._currentConfiguration?this._previousConfiguration=this._getFreeCameraConfiguration(!1):this._previousConfiguration=this._currentConfiguration,this._currentConfiguration&&this._currentConfiguration.setCamera(null),this._currentConfiguration=t,this._currentConfiguration.setCamera(this),this._transitionDuration=void 0===e?this._defaultTransitionDuration:e,this._transitionElapsedTime=0,this._transitionStyle=void 0===i?this._defaultTransitionStyle:i))},Camera.prototype.transitionToFreeCamera=function(t,e,i,r,n){this._followedNode=null,this.startTransitionToConfiguration(this._getFreeCameraConfiguration(t,e,i),r,n)},Camera.prototype.setToFreeCamera=function(t,e,i){this.transitionToFreeCamera(t,e,i,0)},Camera.prototype.transitionToSameConfiguration=function(e,i){var r=this._currentConfiguration;this.setConfiguration(this._previousConfiguration?this._getFreeCameraConfiguration(!1):this._currentConfiguration.copy(t.EMPTY_STRING,!0),!0),this.startTransitionToConfiguration(r,e,i)},Camera.prototype.transitionToConfigurationDefaults=function(t,e){this.transitionToSameConfiguration(t,e),this._currentConfiguration.resetToDefaults(!0)},Camera.prototype.positionConfigurationWillChange=function(){this.transitionToSameConfiguration()},Camera.prototype.orientationConfigurationWillChange=function(){this.transitionToSameConfiguration()},Camera.prototype.configurationWillChange=function(){this.transitionToSameConfiguration()},Camera.prototype.getFollowedNode=function(){return this._followedNode},Camera.prototype.moveToOrigoIfNeeded=function(t){var e=this.getCameraPositionMatrix(),r=null;return(e[12]>t||e[12]<-t||e[13]>t||e[13]<-t||e[14]>t||e[14]<-t)&&(r=[-e[12],-e[13],-e[14]],this._currentConfiguration.positionFollowsObjects()||this._currentConfiguration.setRelativePositionMatrix(i.identity4(),!0),this._previousConfiguration&&!this._previousConfiguration.positionFollowsObjects()&&this._previousConfiguration.moveByVector(r,!0)),r},Camera.prototype.followNode=function(t,e,i,r){var n;return e||this._followedNode!==t?(this._followedNode=t,this._followedNode?(n=this._followedNode.getNextCameraConfiguration(),n?(this.startTransitionToConfiguration(n,i,r),!0):!1):(n=this._scene.getNextCameraConfiguration(),n?(this.startTransitionToConfiguration(n,i,r),!0):!1)):!0},Camera.prototype.followObject=function(t,e,i,r){return this.followNode(t.getNode(),e,i,r)},Camera.prototype.changeToNextView=function(t,e){this._followedNode?this.startTransitionToConfiguration(this._followedNode.getNextCameraConfiguration(this._currentConfiguration),t,e):this._scene.getNextCameraConfiguration()&&this.startTransitionToConfiguration(this._scene.getNextCameraConfiguration(this._scene.hasCameraConfiguration(this._currentConfiguration)?this._currentConfiguration:null),t,e)},Camera.prototype.changeToPreviousView=function(t,e){this._followedNode?this.startTransitionToConfiguration(this._followedNode.getPreviousCameraConfiguration(this._currentConfiguration),t,e):this._scene.getNextCameraConfiguration()&&this.startTransitionToConfiguration(this._scene.getPreviousCameraConfiguration(this._scene.hasCameraConfiguration(this._currentConfiguration)?this._currentConfiguration:null),t,e)},Camera.prototype.followNextNode=function(t,e,i){for(var r=this._scene.getNextNode(this._followedNode),n=this._followedNode;r!==n&&r&&(!r.getNextCameraConfiguration()||!r.isVisible());)if(n||(n=r),r=this._scene.getNextNode(r),t&&this._followedNode&&r===this._scene.getFirstNode()&&this.followNode(null,!0,e,i))return!0;return r&&r.getNextCameraConfiguration()&&r.isVisible()?this.followNode(r,!0,e,i):!1},Camera.prototype.followPreviousNode=function(t,e,i){for(var r=this._scene.getFirstNode(),n=this._scene.getPreviousNode(this._followedNode),o=this._followedNode;n!==o&&n&&(!n.getNextCameraConfiguration()||!n.isVisible());){if(o||(o=n),t&&n===r&&this.followNode(null,!0,e,i))return;n=this._scene.getPreviousNode(n)}n&&n.getNextCameraConfiguration()&&this.followNode(n,!0,e,i)},Camera.prototype.followOrientationOfObjects=function(t,e,i){e=void 0===e?this._defaultTransitionDuration:e,e>0&&this.transitionToSameConfiguration(e,i),this._currentConfiguration.setOrientationFollowedObjects(t,!0)},Camera.prototype._getTransitionProgress=function(){var t;if(0===this._transitionDuration)return 0;switch(this._transitionStyle){case Camera.TransitionStyle.LINEAR:return this._transitionElapsedTime/this._transitionDuration;case Camera.TransitionStyle.SMOOTH:return t=this._transitionElapsedTime/this._transitionDuration,t=3*t*t-2*t*t*t;default:r.crash()}return-1},Camera.prototype._updateFOV=function(t){this._fov=this._previousConfiguration?this._previousConfiguration.getFOV()+(this._currentConfiguration.getFOV()-this._previousConfiguration.getFOV())*t:this._currentConfiguration.getFOV()},Camera.prototype._updateSpan=function(t){this._span=this._previousConfiguration?this._previousConfiguration.getSpan()+(this._currentConfiguration.getSpan()-this._previousConfiguration.getSpan())*t:this._currentConfiguration.getSpan()},Camera.prototype.update=function(t){var r,n,o,s,a,l,h;if(this._extendedCameraValid=!1,this._combinedExtendedCameraValid=!1,this._previousConfiguration){if(!this._currentConfiguration.update([0,0,0],[0,0,0],t))return void this.update(t);if(this._transitionElapsedTime+=t,this._transitionElapsedTime>this._transitionDuration&&(this._transitionElapsedTime=this._transitionDuration),l=this._getTransitionProgress(),!this._previousConfiguration.update([0,0,0],[0,0,0],t))return void this.update(t);r=this._previousConfiguration.getPositionVector(),n=this._currentConfiguration.getPositionVector(),o=this.getCameraPositionVector(),this._setPositionv(e.sum3(e.scaled3(r,1-l),e.scaled3(n,l))),this._velocityVector=e.scaled3(e.prodMat4Vec3(this.getCameraOrientationMatrix(),e.diff3(this.getCameraPositionVector(),o)),1e3/t),s=i.prod3x3SubOf4Aux(i.inverseOfRotation4Aux(this._previousConfiguration._orientationMatrix),this._currentConfiguration._orientationMatrix),a=i.getRotations(s),this._setOrientationM4(i.IDENTITY4),this._rotate(a.gammaAxis,a.gamma*l),this._rotate(a.alphaAxis,a.alpha*l),h=i.prod3x3SubOf4Aux(this._previousConfiguration._orientationMatrix,this.getCameraOrientationMatrix()),i.correctOrthogonal4(h),this._setOrientationM4(h),this._updateFOV(l),this._updateSpan(l),this._updateProjectionMatrix(this._fov,this._span),this._transitionElapsedTime===this._transitionDuration&&(this._previousConfiguration=null)}else{if(!this._currentConfiguration.update(this._controlledVelocityVector,this._angularVelocityVector,t))return void this.update(t);if(!this._currentConfiguration.update([0,0,0],[0,0,0],t))return void this.update(t);o=this.getCameraPositionVector(),this._setPositionM4(this._currentConfiguration._positionMatrix),this._setOrientationM4(this._currentConfiguration._orientationMatrix),this._currentConfiguration.positionFollowsObjects()?(this._previousFollowedPositionVector?this._velocityVector=e.scaled3(e.prodMat4Vec3(this.getCameraOrientationMatrix(),e.diff3(this._currentConfiguration.getFollowedPositionVector(),this._previousFollowedPositionVector)),1e3/t):this._velocityVector=[0,0,0],this._previousFollowedPositionVector=this._currentConfiguration.getFollowedPositionVector()):this._velocityVector=e.scaled3(e.prodMat4Vec3(this.getCameraOrientationMatrix(),e.diff3(this.getCameraPositionVector(),o)),1e3/t)}},Camera.prototype.getExtendedCamera=function(t){var e,i;return!t&&this._extendedCameraValid?this._extendedCamera:t&&this._combinedExtendedCameraValid?this._combinedExtendedCamera:(0===this._fov&&(this._updateFOV(),this._updateSpan()),e=t?this._span:this._span/this._near*this._viewDistance,i=t?this._combinedExtendedCamera:this._extendedCamera,i?(i.getConfiguration().setToFree(!1,this._object3D._positionMatrix,this._object3D._orientationMatrix,this._fov,this._fov,this._fov,e,e,e),i.init(this._scene,this._aspect,this._usesVerticalValues,this._viewDistance*d,i.getConfiguration())):i=new Camera(this._scene,this._aspect,this._usesVerticalValues,this._viewDistance*d,getFreeCameraConfiguration(!1,this._object3D._positionMatrix,this._object3D._orientationMatrix,this._fov,this._fov,this._fov,e,e,e)),i.update(0),t?(this._combinedExtendedCameraValid=!0,this._combinedExtendedCamera=i):(this._extendedCameraValid=!0,this._extendedCamera=i),i)},{CameraPositionConfiguration:CameraPositionConfiguration,CameraOrientationConfiguration:CameraOrientationConfiguration,CameraConfiguration:CameraConfiguration,Camera:Camera,getFreeCameraConfiguration:getFreeCameraConfiguration}}),define("modules/scene/renderable-objects",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/managed-gl","modules/scene/object-3d"],function(t,e,i,r,n,o){"use strict";function _getScaleModeInt(e){switch(e){case t.ScaleMode.WIDTH:return 0;case t.ScaleMode.HEIGHT:return 1;case t.ScaleMode.ASPECT:return 2;case t.ScaleMode.MINIMUM:return 3;case t.ScaleMode.MAXIMUM:return 4;default:r.crash()}}function RenderableObject(t,e,i,r,n){this._node=null,this._wasRendered=!1,this._shader=t,this._textures={},this._textureRoles=[],this._uniformValueFunctions={},this._isRenderedWithDepthMask=void 0===e?!0:e,this._isRenderedWithoutDepthMask=void 0===i?!0:i,this._instancedShader=r||null,this._canBeReused=!1,this._visible=!0,this._castsShadows=void 0!==n?n:!0,this._wasRenderedToShadowMap=!1,this._name=null}function RenderableObject3D(t,e,i,r,n,s,a,l,h,u){RenderableObject.call(this,t,e,i,a),o.Object3D.call(this,r,n,s,l,h,u),this._visibleSize={width:-1,height:-1},this._insideShadowCastFrustum=null,this._smallestSizeWhenDrawn=0}function CubemapSampledFVQ(t,e,r,n,o){RenderableObject.call(this,e,!1,!0),this._model=t,this._samplerName=r,this._camera=o,this.setTexture(r,n),this.setUniformValueFunction(a,function(){return i.inverse4Aux(i.prod4Aux(this._camera.getInverseOrientationMatrix(),this._camera.getProjectionMatrix()))})}function ShadedLODMesh(t,e,r,n,o,s,a,u){if(RenderableObject3D.call(this,e,!0,!0,n,o,s),this.setSmallestSizeWhenDrawn(5),this.setTextures(r),this._model=t,this._wireframe=a===!0,this._wireframe&&(this._isRenderedWithDepthMask=!1),this._currentLOD=this.LOD_NOT_SET,this._lastLOD=this.LOD_NOT_SET,this._modelSize=0,this._lodSizeFactors={},this._staticLOD=void 0!==u?u:this.LOD_NOT_SET,this.setUniformValueFunction(l,function(){return this.getModelMatrix()}),this.setUniformValueFunction(h,function(){return i.transposed3Aux(i.inverse3Aux(i.matrix3from4Aux(this.getModelMatrix())))}),this._model)for(var c=this._model.getMinLOD();c<=this._model.getMaxLOD();c++)this._model.getSize(c)>this._modelSize&&(this._modelSize=this._model.getSize(c))}function ParameterizedMesh(t,e,i,o,s,a,l,h,u){var c,p,d,_,g;for(ShadedLODMesh.call(this,t,e,i,o,s,a,l,h),this._parameterArrays={},g=Object.keys(u),c=0;c<g.length;c++)if(d=n.getUniformName(g[c]),_=e.getUniformArrayLength(d),_>0){switch(u[g[c]]){case n.ShaderVariableType.FLOAT:break;case n.ShaderVariableType.MAT4:_*=16;break;default:r.showError("Cannot create uniform parameter array with elements of type: '"+u[g[c]]+"'!")}for(this._parameterArrays[g[c]]=new Float32Array(_),p=0;_>p;p++)this._parameterArrays[g[c]][p]=0;this.setUniformValueFunction(g[c],this.createGetParameterArrayFunction(g[c]))}else r.log("Note: cannot initialize parameter array '"+g[c]+"' for parameterized mesh, as the given shader ("+e.getName()+") does not have a uniform array named '"+d+"'.",2),this._parameterArrays[g[c]]=new Float32Array}function Billboard(e,r,n,o,s,a,h,u){RenderableObject3D.call(this),this._model=null,this._wireframe=!1,this._sizeVector=[0],e&&this.init(e,r,n,o,s,a,h,u),this.setUniformValueFunction(l,function(){return this.getModelMatrix()}),this.setUniformValueFunction(g,function(){return this.getPositionVector()}),this.setUniformValueFunction(m,function(){return i.getRowB43(this._orientationMatrix)}),this.setUniformValueFunction(f,function(e){return e===t.EMPTY_STRING?this._sizeVector:this._sizeVector[0]}),this.setUniformValueFunction(c,function(){return b})}function ParticleState(t,e,i){this.color=t,this.size=e,this.timeToReach=i}function Particle(i,r,n,o,s,a,h,p){RenderableObject3D.call(this),this.setSmallestSizeWhenDrawn(.1),this._model=i,this._color=[0,0,0,0],this._size=0,this._relativeSize=0,this._calculatedSize=[0],this._positionVector=[0,0,0],this._states=null,this._currentStateIndex=0,this._looping=!1,this._timeSinceLastTransition=0,this._velocityVector=[0,0,0],this._worldVelocityDirectionVector=[0,0,0],this._worldVelocityDirectionVectorValid=!1,this._shouldAnimate=!1,this._duration=0,i&&this.init(i,r,n,o,s,a,h,p),this.setUniformValueFunction(g,function(){var t;return t=this.getModelMatrix(),this._positionVector[0]=t[12],this._positionVector[1]=t[13],this._positionVector[2]=t[14],this._positionVector}),this.setUniformValueFunction(u,function(e){return e===t.EMPTY_STRING?this._calculatedSize:this._calculatedSize[0]}),this.setUniformValueFunction(c,function(){return this._color}),this.setUniformValueFunction(l,function(){return this.getModelMatrix()}),this.setUniformValueFunction(m,function(){return e.floatVector3Aux(this.getWorldVelocityDirectionVector())}),this.setUniformValueFunction(f,function(e){return e===t.EMPTY_STRING?this._calculatedSize:this._calculatedSize[0]})}function initDynamicParticle(t,e,i,r,n,o,s,a,l){t.init(e,i,r,s,[new ParticleState(n,o,0),new ParticleState(n,0,a)],!1,l)}function dynamicParticle(t,e,i,r,n,o,s,a){var l=new Particle;return initDynamicParticle(l,t,e,i,r,n,o,s,a),l}function staticParticle(t,e,i,r,n,o,s){return new Particle(t,e,i,o,[new ParticleState(r,n,0)],!1,s)}function BackgroundBillboard(t,r,n,o,s,a,h){var u,c,p,d;Particle.call(this,t,r,n,a,[new ParticleState(o,s,0)],!1),d=[0,1],e.rotate2(d,h),u=[d[0],0,d[1]],c=e.normal3(i.translationVector3(a)),p=e.getYawAndPitch(c),d=[0,d[1]],e.rotate2(d,p.pitch),u=[u[0],d[0],d[1]],d=[u[0],d[0]],e.rotate2(d,p.yaw),u=[d[0],d[1],u[2]],this.setOrientationMatrix(i.lookTowards4(e.scaled3(c,-1),u)),this.setUniformValueFunction(l,function(){return this.getModelMatrix()})}function PointParticle(t,i,r,n,o,s){RenderableObject.call(this,i,!1,!0,r),this._positionVector=n,this._model=t,this._color=o,this._range=s,this._shift=[0,0,0],this.setUniformValueFunction(g,function(){return this._positionVector}),this._color&&(this.setUniformValueFunction(c,function(){return this._color}),this.setUniformValueFunction(p,function(){return this._shift}),this.setUniformValueFunction(d,function(){return e.length3(this._shift)}),this.setUniformValueFunction(_,function(){return this._range}))}function UIElement(t,e,r,n,o,s,a,l,h,u){RenderableObject.call(this,e,!1,!0),this.setTextures(r),this._model=t,this._position=n,this._color=a,this._size=o,this._scaleMode=_getScaleModeInt(s),this._rotationMatrix=i.rotation2(Math.radians(l||0)),this._clipCoordinates=h||x.slice(),this._clipColor=u||[0,0,0,0],this.setUniformValueFunction(g,function(){return this._position}),this.setUniformValueFunction(f,function(){return this._size}),this.setUniformValueFunction(S,function(){return this._scaleMode}),this.setUniformValueFunction(c,function(){return this._color}),this.setUniformValueFunction(y,function(){return this._rotationMatrix}),this.setUniformValueFunction(T,function(){return this._clipCoordinates}),this.setUniformValueFunction(E,function(){return this._clipColor})}var s={NONE:0,FRONT_QUEUE_BIT:1,DISTANCE_QUEUE_BIT:2},a="viewDirectionProjectionInverse",l="modelMatrix",h="normalMatrix",u="billboardSize",c="color",p="shift",d="length",_="farthestZ",g="position",m="direction",f="size",S="scaleMode",y="rotationMatrix",T="clipCoords",E="clipColor",C=0,M=.01,x=[0,1,0,1],b=[1,1,1,1];return RenderableObject.prototype.init=function(t,e,i,r,n){this._node=null,this._wasRendered=!1,this._shader=t,this._textures={},this._textureRoles=[],this._isRenderedWithDepthMask=void 0===e?!0:e,this._isRenderedWithoutDepthMask=void 0===i?!0:i,this._instancedShader=r||null,this._canBeReused=!1,this._visible=!0,this._castsShadows=void 0!==n?n:!0,this._wasRenderedToShadowMap=!1,this._name=null},RenderableObject.prototype.getNode=function(){return this._node},RenderableObject.prototype.setNode=function(t){this._node=t},RenderableObject.prototype.getShader=function(){return this._shader},RenderableObject.prototype.setShader=function(t){this._shader=t},RenderableObject.prototype.setInstancedShader=function(t){this._instancedShader=t},RenderableObject.prototype._updateTextures=function(){var t,e,i;for(this._textureRoles=Object.keys(this._textures),t=0;t<this._textureRoles.length;t++){if(e=this._textureRoles[t],this._textures[e]instanceof n.ManagedTexture)i=n.getUniformName(n.getTextureUniformRawName(e));else{if(!(this._textures[e]instanceof n.ManagedCubemap)){r.showError("Attemtping to add a texture of unknown type ("+this._textures[e].constructor.name+") to the GL context.");continue}i=n.getUniformName(n.getCubemapUniformRawName(e))}this._uniformValueFunctions[i]=this._uniformValueFunctions[i]||this._getTextureLocation.bind(this,e)}},RenderableObject.prototype.setTexture=function(t,e){this._textures[t]=e,this._updateTextures()},RenderableObject.prototype.setTextures=function(t){this._textures=t,t&&this._updateTextures()},RenderableObject.prototype.isRenderedWithoutDepthMask=function(){return this._isRenderedWithoutDepthMask},RenderableObject.prototype.isRenderedWithDepthMask=function(){return this._isRenderedWithDepthMask},RenderableObject.prototype.setUniformValueFunction=function(t,e,i){this._uniformValueFunctions[n.getUniformName(t)]=e.bind(i||this)},RenderableObject.prototype.setName=function(t){this._name=t},RenderableObject.prototype.getName=function(){return this._name},RenderableObject.prototype._getTextureLocation=function(t,e){return this._textures[t].getLastTextureBindLocation(e)},RenderableObject.prototype.addToContext=function(t){var e,i;for(this._shader&&t.addShader(this._shader),this._instancedShader&&t.addShader(this._instancedShader),i=0;i<this._textureRoles.length;i++)e=this._textureRoles[i],t.addTexture(this._textures[e])},RenderableObject.prototype.bindTextures=function(t){var e,i;for(i=0;i<this._textureRoles.length;i++)e=this._textureRoles[i],t.bindTexture(this._textures[e])},RenderableObject.prototype.markAsReusable=function(t){this._canBeReused=!0,this._node&&this._node.handleObjectBecameReusable(t)},RenderableObject.prototype.canBeReused=function(){return this._canBeReused},RenderableObject.prototype.isVisible=function(){return this._visible&&(!this._node||this._node.isVisible())},RenderableObject.prototype.resetForNewFrame=function(){this._wasRendered=!1,this._wasRenderedToShadowMap=!1},RenderableObject.prototype.getRenderQueueBits=function(){return this._visible?s.FRONT_QUEUE_BIT:s.NONE},RenderableObject.prototype.prepareForInstancedRender=function(t,e,i,r){t.setCurrentShader(this._instancedShader)&&e.assignUniforms(t,this._instancedShader),t.getCurrentShader()===this._instancedShader&&(this.bindTextures(t),this._instancedShader.assignUniforms(t,this._uniformValueFunctions),this._instancedShader.createInstanceBuffers(i,r))},RenderableObject.prototype.mightBeRendered=function(){return this._canBeReused!==!0&&this._visible},RenderableObject.prototype.shouldBeRendered=function(t){return t.depthMask&&this._isRenderedWithDepthMask||!t.depthMask&&this._isRenderedWithoutDepthMask},RenderableObject.prototype.prepareForRender=function(t){t.useInstancing&&t.context.getCurrentShader()===this._instancedShader?this._instancedShader.addDataToInstanceBuffers(t.instanceQueueIndex,this._uniformValueFunctions):(t.context.setCurrentShader(this._shader)&&t.scene.assignUniforms(t.context,this._shader),t.context.getCurrentShader()===this._shader&&(this.bindTextures(t.context),this._shader.assignUniforms(t.context,this._uniformValueFunctions)))},RenderableObject.prototype.performRender=function(){return!0},RenderableObject.prototype.finishRender=function(){this._wasRendered=!0},RenderableObject.prototype.render=function(t){return this.shouldBeRendered(t)?(this.prepareForRender(t),t.useInstancing||this.performRender(t),this.finishRender(t),!0):!1},RenderableObject.prototype._peformRenderInstances=function(t,e){r.showError("Cannot render "+e+" instances of "+this.constructor.name+" to "+t.getName()+" in instanced mode, because no instanced render method was defined for it!")},RenderableObject.prototype.renderInstances=function(t,e,i){this._instancedShader.bindAndFillInstanceBuffers(t,e),this._peformRenderInstances(t,i)},RenderableObject.prototype.mightBeRenderedToShadowMap=function(){return!this._canBeReused&&this._visible&&this._castsShadows},RenderableObject.prototype.shouldBeRenderedToShadowMap=function(){return!0},RenderableObject.prototype.wasRenderedToShadowMap=function(){return this._wasRenderedToShadowMap},RenderableObject.prototype.prepareForRenderToShadowMap=function(){return!0},RenderableObject.prototype.performRenderToShadowMap=function(){return!0},RenderableObject.prototype.renderToShadowMap=function(t){return this.shouldBeRenderedToShadowMap(t)?(this.prepareForRenderToShadowMap(t),this.performRenderToShadowMap(t),this._wasRenderedToShadowMap=!0,!0):(this._wasRenderedToShadowMap=!1,!1)},RenderableObject.prototype.shouldAnimate=function(t){return t>0},RenderableObject.prototype.performAnimate=function(){return!0},RenderableObject.prototype.animate=function(t){this.shouldAnimate(t)&&this.performAnimate(t)},RenderableObject.prototype.wasRendered=function(){return this._wasRendered},RenderableObject.prototype.shouldGoInSameRenderQueue=function(t){return this._shader===t.getShader()},RenderableObject.prototype.shouldGoInSameRenderQueueInstanced=function(t){return this.constructor===t.constructor&&this._shader===t._shader},RenderableObject3D.prototype=new RenderableObject,o.makeObject3DMixinClass.call(RenderableObject3D),RenderableObject3D.prototype.constructor=RenderableObject,RenderableObject3D.prototype.init=function(t,e,i,r,n,s,a,l){RenderableObject.prototype.init.call(this,t,e,i,a),o.Object3D.prototype.init.call(this,r,n,s,l),this._visibleSize={width:-1,height:-1},this._insideShadowCastFrustum=null,this._smallestSizeWhenDrawn=0},RenderableObject3D.prototype.setSmallestSizeWhenDrawn=function(t){this._smallestSizeWhenDrawn=t},RenderableObject3D.prototype.getVisibleSize=function(t){return this._visibleSize.width<0&&(this._visibleSize=this.getSizeInsideViewFrustum(t.camera)),this._visibleSize},RenderableObject3D.prototype.isInsideViewFrustum=function(t){return this.getVisibleSize(t).width>0},RenderableObject3D.prototype.getSizeInPixels=function(t){return this.getVisibleSize(t),this._visibleSize.width<0&&r.showError("Attempting to access the size of an object on the screen in pixels, before the size has been calculated."),Math.max(this._visibleSize.width*t.viewportWidth/2,this._visibleSize.height*t.viewportHeight/2)},RenderableObject3D.prototype.resetForNewFrame=function(){RenderableObject.prototype.resetForNewFrame.call(this),RenderableObject3D.prototype.resetCachedValues.call(this),this._visibleSize.width=-1,this._visibleSize.height=-1,this._insideShadowCastFrustum=null},RenderableObject3D.prototype.getRenderQueueBits=function(t,e){var i,r,n,o=s.NONE;return this.isInsideParent()?e:(i=this.getPositionMatrixInCameraSpace(t),r=this.getCascadeScalingMatrix(),n=this.getSize()*r[0],i[14]-n<=-t.getNearDistance()&&i[14]+n>-t.getViewDistance()&&(o|=s.FRONT_QUEUE_BIT),i[14]-n<=-t.getViewDistance()&&i[14]+n>-t.getExtendedCamera().getViewDistance()&&(o|=s.DISTANCE_QUEUE_BIT),o)},RenderableObject3D.prototype.shouldBeRendered=function(t){var e,i;return RenderableObject.prototype.shouldBeRendered.call(this,t)?this.isInsideParent()===!0?void 0===t.parent.isInsideViewFrustum||t.parent.isInsideViewFrustum(t)?(e=t.parent.getVisibleSize(t),i=Math.max(this.getSize()/t.parent.getSize(),t.lodContext.minimumRelativeSize),this._visibleSize.width=e.width*i,this._visibleSize.height=e.height*i,this.getSizeInPixels(t)<this._smallestSizeWhenDrawn?!1:!0):(this._visibleSize.width=0,this._visibleSize.height=0,!1):(e=this.getVisibleSize(t),
this.getSizeInPixels(t)<this._smallestSizeWhenDrawn?!1:this.isInsideViewFrustum(t)):!1},RenderableObject3D.prototype.shouldBeRenderedToShadowMap=function(t){return this.isInsideParent()===!0?t.parent.wasRenderedToShadowMap():this.isInsideShadowRegion(t.lightMatrix,t.shadowMapRange,t.shadowMapDepthRatio)},CubemapSampledFVQ.prototype=new RenderableObject,CubemapSampledFVQ.prototype.constructor=CubemapSampledFVQ,CubemapSampledFVQ.prototype.addToContext=function(t){RenderableObject.prototype.addToContext.call(this,t),this._model.addToContext(t,!1)},CubemapSampledFVQ.prototype.performRender=function(t){this._model.render(t.context,!1)},ShadedLODMesh.prototype=new RenderableObject3D,ShadedLODMesh.prototype.constructor=ShadedLODMesh,ShadedLODMesh.prototype.LOD_NOT_SET=-1,ShadedLODMesh.prototype.addToContext=function(t){RenderableObject3D.prototype.addToContext.call(this,t),this._model.addToContext(t,this._wireframe)},ShadedLODMesh.prototype.getModel=function(){return this._model},ShadedLODMesh.prototype.getSize=function(){return this._modelSize},ShadedLODMesh.prototype.getLODSize=function(t,e){return void 0===this._lodSizeFactors[e.toString()]&&(this._lodSizeFactors[e.toString()]=Math.log10(e+10)/Math.log10(this.getScaledSize()+10)),t*this._lodSizeFactors[e.toString()]},ShadedLODMesh.prototype.getHeight=function(){return this._model.getHeight()},ShadedLODMesh.prototype.getHeightInMeters=function(){return this._model.getHeightInMeters()},ShadedLODMesh.prototype.getMaxY=function(){return this._model.getMaxY()},ShadedLODMesh.prototype.getCurrentLOD=function(t){var e,i,r;if(this._currentLOD===this.LOD_NOT_SET)if(this._staticLOD!==this.LOD_NOT_SET)this._currentLOD=this._model.getClosestAvailableLOD(this._staticLOD);else{if(!t)return this.LOD_NOT_SET;if(e=this.getSizeInPixels(t),i=t.lodContext.compensateForObjectSize?this.getLODSize(e,t.lodContext.referenceSize):e,i>0)for(r=Math.min(this._model.getMaxLOD(),t.lodContext.maxEnabledLOD);r>=this._model.getMinLOD();r--)if(t.lodContext.thresholds[r]<=i){this._currentLOD=r;break}}return this._currentLOD!==this.LOD_NOT_SET?(this._lastLOD=this._currentLOD,this._currentLOD):this._lastLOD!==this.LOD_NOT_SET?this._lastLOD:C},ShadedLODMesh.prototype.setStaticLOD=function(t){this._staticLOD=t,this._currentLOD=this.LOD_NOT_SET,this._lastLOD=this.LOD_NOT_SET},ShadedLODMesh.prototype.resetForNewFrame=function(){RenderableObject3D.prototype.resetForNewFrame.call(this),this._staticLOD===this.LOD_NOT_SET&&(this._currentLOD=this.LOD_NOT_SET)},ShadedLODMesh.prototype.shouldBeRendered=function(t){if(RenderableObject3D.prototype.shouldBeRendered.call(this,t)){if(this._wireframe===!0)return!0;if(t.depthMask===!0){if(this._model.getNumOpaqueTriangles(this.getCurrentLOD(t))>0)return!0}else if(t.depthMask===!1&&this._model.getNumTransparentTriangles(this.getCurrentLOD(t))>0)return!0;return!1}return!1},ShadedLODMesh.prototype.performRender=function(t){this._model.render(t.context,this._wireframe,t.depthMask,this.getCurrentLOD(t))},ShadedLODMesh.prototype.shouldBeRenderedToShadowMap=function(t){return RenderableObject3D.prototype.shouldBeRenderedToShadowMap.call(this,t)?this._model.getNumOpaqueTriangles(this.getCurrentLOD(t))>0:void 0},ShadedLODMesh.prototype.prepareForRenderToShadowMap=function(t){t.context.getCurrentShader().assignUniforms(t.context,this._uniformValueFunctions)},ShadedLODMesh.prototype.performRenderToShadowMap=function(t){this._model.render(t.context,this._wireframe,!0,this.getCurrentLOD(t)),r.log_DEBUG("Rendered model ("+this._model.getName()+") to shadow map.",5)},ParameterizedMesh.prototype=new ShadedLODMesh,ParameterizedMesh.prototype.constructor=ParameterizedMesh,ParameterizedMesh.prototype.createGetParameterArrayFunction=function(t){return function(){return this._parameterArrays[t]}},ParameterizedMesh.prototype.setFloatParameter=function(t,e,i){this._parameterArrays[t][e]=i},ParameterizedMesh.prototype.setMat4Parameter=function(t,e,i){var r;for(r=0;16>r;r++)this._parameterArrays[t][16*e+r]=i[r]},Billboard.prototype=new RenderableObject3D,Billboard.prototype.constructor=Billboard,Billboard.prototype.init=function(t,e,r,n,o,s,a,l){RenderableObject3D.prototype.init.call(this,e,!1,!0,s,a,i.scaling4Aux(n),l),this.setTextures(r),this._sizeVector[0]=n,this._model=t,this._wireframe=o===!0,this._wireframe&&(this._isRenderedWithDepthMask=!1)},Billboard.prototype.getModel=function(){return this._model},Billboard.prototype.getCurrentLOD=function(){return 0},Billboard.prototype.addToContext=function(t){RenderableObject3D.prototype.addToContext.call(this,t),this._model.addToContext(t,this._wireframe)},Billboard.prototype.isInsideViewFrustum=function(){return!0},Billboard.prototype.performRender=function(t){this._model.render(t.context,this._wireframe)},Billboard.prototype._peformRenderInstances=function(t,e){this._model.renderInstances(t,this._wireframe,void 0,void 0,e)},Billboard.prototype.mightBeRenderedToShadowMap=function(){return!1},Billboard.prototype.shouldGoInSameRenderQueueInstanced=function(t){return RenderableObject3D.prototype.shouldGoInSameRenderQueueInstanced.call(this,t)&&this._textures===t._textures&&this._model===t._model},Particle.prototype=new RenderableObject3D,Particle.prototype.constructor=Particle,Particle.prototype.init=function(t,e,r,n,o,s,a,l){var h;if(RenderableObject3D.prototype.init.call(this,e,!1,!0,n,i.IDENTITY4,i.IDENTITY4,a),this.setTextures(r),this._model=t,o)for(h=0;h<o[0].color.length;h++)this._color[h]=o[0].color[h];this._size=void 0!==l?l:o?o[0].size:0,this._relativeSize=1,this._calculateSize(),this._states=o||[],this._calculateDuration(),this._currentStateIndex=0,this._looping=s===!0,this._timeSinceLastTransition=0,this._velocityVector[0]=0,this._velocityVector[1]=0,this._velocityVector[2]=0,this._worldVelocityDirectionVector[0]=0,this._worldVelocityDirectionVector[1]=0,this._worldVelocityDirectionVector[2]=0,this._worldVelocityDirectionVectorValid=!1,this._shouldAnimate=!1,this._updateShouldAnimate()},Particle.prototype._calculateDuration=function(){var t;if(this._states.length<=1)return 0;for(this._duration=0,t=0;t<this._states.length;t++)this._duration+=this._states[t].timeToReach},Particle.prototype._calculateSize=function(){this._calculatedSize[0]=this._size*this._relativeSize,this._visible=this._calculatedSize[0]>=M},Particle.prototype.getDuration=function(){return this._duration},Particle.prototype.getSize=function(){return this._calculatedSize[0]},Particle.prototype.getFinalSize=function(){return 0===this._states.length?this._size:this._states[this._states.length-1].size},Particle.prototype.getMaxSize=function(){var t,e;if(0===this._states.length)return this._size;for(t=0,e=0;e<this._states.length;e++)this._states[e].size>t&&(t=this._states[e].size);return t},Particle.prototype._hasVelocity=function(){return this._velocityVector&&(0!==this._velocityVector[0]||0!==this._velocityVector[1]||0!==this._velocityVector[2])},Particle.prototype._updateShouldAnimate=function(){this._shouldAnimate=this._states.length>1||this._hasVelocity()},Particle.prototype._updateVelocity=function(){this._worldVelocityDirectionVectorValid=!1,this._updateShouldAnimate()},Particle.prototype.getRelativeSize=function(){return this._relativeSize},Particle.prototype.setRelativeSize=function(t){this._relativeSize=t,this._calculateSize()},Particle.prototype.getVelocityVector=function(){return this._velocityVector},Particle.prototype.setVelocityVector=function(t){this._velocityVector=t,this._updateVelocity()},Particle.prototype.setVelocity=function(t,e,i){this._velocityVector[0]=t,this._velocityVector[1]=e,this._velocityVector[2]=i,this._updateVelocity()},Particle.prototype.setVelocityM=function(t){this._velocityVector[0]=t[12],this._velocityVector[1]=t[13],this._velocityVector[2]=t[14],this._updateVelocity()},Particle.prototype.getWorldVelocityDirectionVector=function(){return this._worldVelocityDirectionVectorValid||(this._worldVelocityDirectionVector=e.normal3(e.prodVec3Mat4Aux(this._velocityVector,this.getModelMatrix())),this._worldVelocityDirectionVectorValid=!0),this._worldVelocityDirectionVector},Particle.prototype.invalidateWorldVelocityDirectionVector=function(){this._worldVelocityDirectionVectorValid=!1},Particle.prototype.getStates=function(){return this._states},Particle.prototype.setAnimationTime=function(t){this._currentStateIndex=0,this._timeSinceLastTransition=0,this.performAnimate(t)},Particle.prototype.addToContext=function(t){RenderableObject3D.prototype.addToContext.call(this,t),this._model.addToContext(t,!1)},Particle.prototype.isInsideViewFrustum=function(){return this._parent&&this.isInsideParent()?this._parent.isInsideViewFrustum():!0},Particle.prototype.getRenderQueueBits=function(t,e){return this._visible?RenderableObject3D.prototype.getRenderQueueBits.call(this,t,e):s.NONE},Particle.prototype.performRender=function(t){this._model.render(t.context,!1)},Particle.prototype._peformRenderInstances=function(t,e){this._model.renderInstances(t,!1,void 0,void 0,e)},Particle.prototype.mightBeRenderedToShadowMap=function(){return!1},Particle.prototype.shouldAnimate=function(t){return RenderableObject3D.prototype.shouldAnimate.call(this,t)?this._shouldAnimate:!1},Particle.prototype.performAnimate=function(t){var i,r,n;if(this._states.length>1){for(this._timeSinceLastTransition+=t,i=(this._currentStateIndex+1)%this._states.length;this._timeSinceLastTransition>this._states[i].timeToReach;){if(0===i&&!this._looping)return this._size=0,void this.markAsReusable(!0);this._timeSinceLastTransition-=this._states[i].timeToReach,i=(i+1)%this._states.length}for(this._currentStateIndex=0===i?this._states.length-1:i-1,r=this._timeSinceLastTransition/this._states[i].timeToReach,n=0;n<this._color.length;n++)this._color[n]=this._states[this._currentStateIndex].color[n]*(1-r)+this._states[i].color[n]*r;this._size=this._states[this._currentStateIndex].size*(1-r)+this._states[i].size*r,this._calculateSize()}this._hasVelocity()&&this.translatev(e.scaled3Aux(this._velocityVector,.001*t))},Particle.prototype.shouldGoInSameRenderQueueInstanced=function(t){return RenderableObject3D.prototype.shouldGoInSameRenderQueueInstanced.call(this,t)&&this._textures===t._textures&&this._model===t._model},BackgroundBillboard.prototype=new Particle,BackgroundBillboard.prototype.constructor=BackgroundBillboard,BackgroundBillboard.prototype.isInsideViewFrustum=function(){return!0},BackgroundBillboard.prototype.shouldBeRendered=function(t){return RenderableObject.prototype.shouldBeRendered.call(this,t)},PointParticle.prototype=new RenderableObject,PointParticle.prototype.constructor=PointParticle,PointParticle.prototype.addToContext=function(t){RenderableObject.prototype.addToContext.call(this,t),this._model.addToContext(t,!1)},PointParticle.prototype.setShift=function(t,e,i){this._shift[0]=t,this._shift[1]=e,this._shift[2]=i},PointParticle.prototype.fitPositionWithinRange=function(t,e){var i;for(i=0;3>i;i++){for(;this._positionVector[i]>t[12+i]+e;)this._positionVector[i]-=2*e;for(;this._positionVector[i]<t[12+i]-e;)this._positionVector[i]+=2*e}},PointParticle.prototype.performRender=function(t){this._model.render(t.context,!0)},PointParticle.prototype._peformRenderInstances=function(t,e){this._model.renderInstances(t,!0,!1,void 0,e)},PointParticle.prototype.mightBeRenderedToShadowMap=function(){return!1},PointParticle.prototype.shouldAnimate=function(){return!1},PointParticle.prototype.shouldGoInSameRenderQueueInstanced=function(t){return RenderableObject.prototype.shouldGoInSameRenderQueueInstanced.call(this,t)&&this._color===t._color&&this._range===t._range},UIElement.prototype=new RenderableObject,UIElement.prototype.constructor=UIElement,UIElement.prototype.init=function(t,e,r,n,o,s,a,l,h,u){RenderableObject.prototype.init.call(this,e,!1,!0),this.setTextures(r),this._model=t,this._position=n,this._color=a,this._size=o,this._scaleMode=_getScaleModeInt(s),i.setRotation2(this._rotationMatrix,Math.radians(l||0)),this._clipCoordinates=h||x.slice(),this._clipColor=u||[0,0,0,0]},UIElement.prototype.addToContext=function(t){RenderableObject.prototype.addToContext.call(this,t),this._model.addToContext(t,!1)},UIElement.prototype.performRender=function(t){this._model.render(t.context)},UIElement.prototype.setPosition=function(t){this._position=t},UIElement.prototype.setSize=function(t){this._size=t},UIElement.prototype.setColor=function(t){this._color=t},UIElement.prototype.setAngle=function(t){i.setRotation2(this._rotationMatrix,t)},UIElement.prototype.setClipCoordinates=function(t){this._clipCoordinates=t},UIElement.prototype.clipX=function(t,e){this._clipCoordinates[0]=t,this._clipCoordinates[1]=e},UIElement.prototype.clipY=function(t,e){this._clipCoordinates[2]=1-e,this._clipCoordinates[3]=1-t},UIElement.prototype.setClipColor=function(t){this._clipColor=t},UIElement.prototype.setModel=function(t){this._model=t},{RenderQueueBits:s,UNIFORM_COLOR_NAME:c,CLIP_COORDINATES_NO_CLIP:x,RenderableObject:RenderableObject,RenderableObject3D:RenderableObject3D,CubemapSampledFVQ:CubemapSampledFVQ,ShadedLODMesh:ShadedLODMesh,ParameterizedMesh:ParameterizedMesh,Billboard:Billboard,ParticleState:ParticleState,Particle:Particle,staticParticle:staticParticle,initDynamicParticle:initDynamicParticle,dynamicParticle:dynamicParticle,BackgroundBillboard:BackgroundBillboard,PointParticle:PointParticle,UIElement:UIElement}}),define("modules/scene/lights",["utils/vectors","utils/matrices","modules/managed-gl"],function(t,e,i){"use strict";function DirectionalLightSource(i,r){this._color=i,this._direction=t.normal3(r),this._orientationMatrix=e.inverseOfRotation4(e.lookTowards4(this._direction)),this._baseMatrix=e.identity4(),this._baseMatrixValid=!1,this._translationVector=null,this._translatedMatrix=e.identity4(),this._shadowMapBufferNamePrefix=null,this._uniformData={color:this._color,direction:this._direction,matrix:this._baseMatrix,translationVector:t.NULL3}}function PointLightSource(t,e,i,r,n,o){this._color=t,this._objectIntensity=e,this._relativePositionVector=i,this._emittingObjects=r,this._totalIntensity=e*(r?r.length:1),this._positionVector=[0,0,0],this._states=n,this._timeSinceLastTransition=0,this._currentStateIndex=0,this._looping=o,this._uniformColor=[0,0,0,0],this._uniformData={color:this._uniformColor,position:this._positionVector},t&&this._updateUniformColor()}function SpotLightSource(t,e,i,r,n,o,s,a,l){PointLightSource.call(this,t,e,i,s,a,l),this._relativeSpotDirection=r,this._spotCutoffCosine=Math.cos(Math.radians(n)),this._spotFullIntensityCosine=n>o?Math.cos(Math.radians(o)):0,this._spotDirection=[0,0,0],this._uniformData={color:this._uniformColor,spot:[0,0,0,0],position:[0,0,0,0]}}var r="lightMatrix",n="shadowMapDepth",o="projMatrix";return DirectionalLightSource.prototype.getShadowMapBufferName=function(t){return this._shadowMapBufferNamePrefix+t.toString()},DirectionalLightSource.prototype.addToContext=function(t,e,r,n,o){var s;if(this._shadowMapBufferNamePrefix=r,e)for(s=0;n>s;s++)t.getFrameBuffer(this.getShadowMapBufferName(s))||t.addFrameBuffer(new i.FrameBuffer(this.getShadowMapBufferName(s),o,o,!0))},DirectionalLightSource.prototype.reset=function(){this._baseMatrixValid=!1,this._translationVector=null,e.setIdentity4(this._translatedMatrix)},DirectionalLightSource.prototype.getTranslatedMatrix=function(){return this._translatedMatrix},DirectionalLightSource.prototype.startShadowMap=function(s,a,l,h,u,c){var p={};s.setCurrentFrameBuffer(this.getShadowMapBufferName(l)),e.setProdTranslationRotation4(this._translatedMatrix,e.translatedByVectorAux(a.getInversePositionMatrix(),t.scaled3(e.getRowC43(a.getCameraOrientationMatrix()),c)),this._orientationMatrix),this._baseMatrixValid||(e.setProdTranslationRotation4(this._baseMatrix,a.getInversePositionMatrix(),this._orientationMatrix),this._baseMatrixValid=!0),this._translationVector=this._translationVector||t.normal3(t.diff3(e.translationVector3(this._translatedMatrix),e.translationVector3(this._baseMatrix))),p[i.getUniformName(r)]=function(){return this._translatedMatrix}.bind(this),p[i.getUniformName(n)]=function(){return u},p[i.getUniformName(o)]=function(){return e.orthographic4Aux(h,h,-u,u)},s.getCurrentShader().assignUniforms(s,p)},DirectionalLightSource.prototype.getUniformData=function(){return this._uniformData.translationVector=this._translationVector||t.NULL3,this._uniformData},PointLightSource.prototype._updateUniformColor=function(){this._uniformColor[0]=this._color[0],this._uniformColor[1]=this._color[1],this._uniformColor[2]=this._color[2],this._uniformColor[3]=this._totalIntensity},PointLightSource.prototype.updateState=function(e){var i,r;if(this._states&&this._states.length>1&&e>0){for(this._timeSinceLastTransition+=e,i=(this._currentStateIndex+1)%this._states.length;this._timeSinceLastTransition>this._states[i].timeToReach;){if(0===i&&!this._looping){i=this._states.length-1,this._timeSinceLastTransition=this._states[i].timeToReach;break}this._timeSinceLastTransition-=this._states[i].timeToReach,i=(i+1)%this._states.length}this._currentStateIndex=0===i?this._states.length-1:i-1,r=this._timeSinceLastTransition/this._states[i].timeToReach,this.setObjectIntensity(this._states[this._currentStateIndex].intensity*(1-r)+this._states[i].intensity*r),this.setColor(t.sum3(t.scaled3(this._states[this._currentStateIndex].color,1-r),t.scaled3(this._states[i].color,r)))}},PointLightSource.prototype.update=function(i){var r,n,o=this._totalIntensity;if(this.updateState(i),this._emittingObjects)if(1===this._emittingObjects.length)this._emittingObjects[0].isVisible()?(this._totalIntensity=this._objectIntensity,t.setSum3(this._positionVector,this._emittingObjects[0].getPositionVector(),t.prodVec3Mat4Aux(this._relativePositionVector,e.prod3x3SubOf4Aux(this._emittingObjects[0].getCascadeScalingMatrix(),this._emittingObjects[0]._orientationMatrix)))):this._totalIntensity=0;else{for(t.setNull3(this._positionVector),n=0,r=0;r<this._emittingObjects.length;r++)this._emittingObjects[r]&&!this._emittingObjects[r].canBeReused()&&this._emittingObjects[r].isVisible()&&(t.add3(this._positionVector,this._emittingObjects[r].getPositionVector()),n++);n>0&&(this._positionVector[0]/=n,this._positionVector[1]/=n,this._positionVector[2]/=n),this._totalIntensity=this._objectIntensity*n}else this._totalIntensity=this._objectIntensity,t.setVector3(this._positionVector,this._relativePositionVector);this._totalIntensity!==o&&this._updateUniformColor()},PointLightSource.prototype.getUniformData=function(){return this._uniformData},PointLightSource.prototype.canBeReused=function(){var t;if(!this._emittingObjects)return!1;for(t=0;t<this._emittingObjects.length;t++)if(this._emittingObjects[t]&&!this._emittingObjects[t].canBeReused())return!1;return!0},PointLightSource.prototype.setColor=function(t){this._color=t,this._updateUniformColor()},PointLightSource.prototype.setObjectIntensity=function(t){this._objectIntensity=t},PointLightSource.prototype.addEmittingObject=function(t){this._emittingObjects.push(t)},PointLightSource.prototype.shouldBeRendered=function(t){var e=t.getViewMatrix();return this._totalIntensity>0&&this._positionVector[0]*e[2]+this._positionVector[1]*e[6]+this._positionVector[2]*e[10]+e[14]<this._totalIntensity},PointLightSource.prototype.setAnimationTime=function(t){this._timeSinceLastTransition=0,this._currentStateIndex=0,this.updateState(t)},SpotLightSource.prototype=new PointLightSource,SpotLightSource.prototype.constructor=SpotLightSource,SpotLightSource.prototype.setSpotDirection=function(t){this._relativeSpotDirection=t},SpotLightSource.prototype.setSpotCutoffAngle=function(t){this._spotCutoffCosine=Math.cos(Math.radians(t))},SpotLightSource.prototype.update=function(e){PointLightSource.prototype.update.call(this,e),this._emittingObjects&&1===this._emittingObjects.length?t.setProdVec3Mat4(this._spotDirection,this._relativeSpotDirection,this._emittingObjects[0]._orientationMatrix):t.setVector3(this._spotDirection,this._relativeSpotDirection)},SpotLightSource.prototype.getUniformData=function(){return this._uniformData.spot[0]=this._spotDirection[0],this._uniformData.spot[1]=this._spotDirection[1],this._uniformData.spot[2]=this._spotDirection[2],this._uniformData.spot[3]=this._spotCutoffCosine,this._uniformData.position[0]=this._positionVector[0],this._uniformData.position[1]=this._positionVector[1],this._uniformData.position[2]=this._positionVector[2],this._uniformData.position[3]=this._spotFullIntensityCosine,this._uniformData},{UNIFORM_PROJECTION_MATRIX_NAME:o,DirectionalLightSource:DirectionalLightSource,PointLightSource:PointLightSource,SpotLightSource:SpotLightSource}}),define("modules/scene/scene-graph",["utils/utils","utils/types","utils/vectors","utils/matrices","modules/application","modules/managed-gl","modules/egom-model","modules/containers","modules/scene/camera","modules/scene/renderable-objects","modules/scene/lights"],function(t,e,i,r,n,o,s,a,l,h,u){"use strict";function getDebugInfo(){return j}function LODContext(t,e,i,r,n){this.maxEnabledLOD=t,this.thresholds=e,this.compensateForObjectSize=i===!0,this.referenceSize=r||c,this.minimumRelativeSize=n||p}function RenderParameters(t,e,i,r,n,o,s,a,l,h,u,c,p,d){this.context=t,this.depthMask=e,this.scene=i,this.parent=r,this.camera=n,this.viewportWidth=o,this.viewportHeight=s,this.lodContext=a,this.dt=l||0,this.useInstancing=h||!1,this.instanceQueueIndex=u,this.lightMatrix=c,this.shadowMapRange=p,this.shadowMapDepthRatio=d}function RenderableNode(t,e,i,r){this._renderableObject=t,t.setNode(this),this._scene=null,this._parent=null,this._subnodes=new a.DirectDoubleLinkedList,this._visible=!0,this._renderParameters=new RenderParameters,this._cameraConfigurations=[],this._isRenderedToShadowMap=e!==!1,this._hasInstancedSubnodes=i,this._minimumCountForInstancing=r||0,this._canBeReused=!1,this.next=null,this.previous=null,this.list=null}function Scene(t,e,i,n,o,s,a,h,u,c,p,d,_,g){this._left=t,this._bottom=e,this._width=i,this._height=n,this._shouldClearColorOnRender=o,this._clearColorMask=s,this._clearColor=a,this._shouldClearDepthOnRender=h,this._rootBackgroundNode=null,this._rootNode=null,this._rootUINode=null,this._directionalLights=[],this._maxRenderedDirectionalLights=c||0,this._renderedDirectionalLights=0,this._directionalLightUniformData=new Array(this._maxRenderedDirectionalLights),this._pointLightPriorityArrays=null,this._maxRenderedPointLights=p||0,this._renderedPointLights=0,this._pointLightUniformData=new Array(this._maxRenderedPointLights),this._spotLights=[],this._maxRenderedSpotLights=d||0,this._renderedSpotLights=0,this._spotLightUniformData=new Array(this._maxRenderedSpotLights),this._rootResourceNode=null,this._resourceObjectIDs=null,this._camera=new l.Camera(this,this._width/this._height,_.useVerticalValues,_.viewDistance,_.configuration||l.getFreeCameraConfiguration(_.fps,_.positionMatrix||r.IDENTITY4,_.orientationMatrix||r.IDENTITY4,_.fov,_.fovRange&&_.fovRange[0]||_.fov,_.fovRange&&_.fovRange[1]||_.fov,_.span,_.spanRange&&_.spanRange[0]||_.span,_.spanRange&&_.spanRange[1]||_.span),_.transitionDuration,_.transitionStyle),this._lodContext=u,this._shadowMappingEnabled=!1,this._shadowMappingShader=null,this._shadowMapTextureSize=0,this._shadowMapRanges=new Float32Array([]),this._shadowMapDepthRatio=0,this._numShadowMapSamples=0,this._shadowMapSampleOffsets=[],this._uniformValueFunctions={},this._contextUniformValueFunctions=[],this._shouldAnimate=!0,this._shouldUpdateCamera=!0,this._numDrawnTriangles=0,this._contexts=[],this._distanceRendering=void 0!==g?g:!0,this._renderQueues=this._distanceRendering?[[],[],[],[]]:[[],[]],this._shadowQueue=null,this._uniformsUpdatedForFrame=!1,this._uniformsUpdated=null,this._nodeCount=0,this._nodeCountByType=null,this._mainDebugStats=null,this._shadowMapDebugStats=null,this._initNodes(),this.clearPointLights(),this._setGeneralUniformValueFunctions()}var c=100,p=.05,d="shadow-map-buffer-",_="-",g=5,m="numDirLights",f="dirLights",S="numPointLights",y="pointLights",T="numSpotLights",E="spotLights",C="cameraMatrix",M="viewProjMatrix",x="cameraOrientationMatrix",b="aspect",O="viewportSize",R="eyePos",A="numRanges",I="shadowMapRanges",v="shadowMapDepthRatio",N="shadowMapTextureSize",L="shadowMaps",D="shadowMapSampleOffsets",P=[0,0,1,0,0,1,-1,0,0,-1,1,1,1,-1,-1,1,-1,-1],w=0,V=1,F=2,B=3,U=[!0,!0,!0,!0],j="";return RenderableNode.prototype.canBeReused=function(){var t;if(this._canBeReused)return!0;if(this._renderableObject.canBeReused()){for(t=this._subnodes.getFirst();t;t=t.next)if(t.canBeReused()===!1)return!1;return this._canBeReused=!0,!0}return!1},RenderableNode.prototype.getScene=function(){return this._scene},RenderableNode.prototype.setScene=function(t,e){var i;for(this._scene=t,t&&e&&t.addObjectToContexts(this._renderableObject),i=this._subnodes.getFirst();i;i=i.next)i.setScene(t,e)},RenderableNode.prototype.addToRenderQueue=function(t){var e;if(0===this._minimumCountForInstancing){for(e=0;e<t.length;e++)if(t[e].length>0&&0===t[e][0]._minimumCountForInstancing&&this._renderableObject.shouldGoInSameRenderQueue(t[e][0]._renderableObject))return t[e].push(this),e}else for(e=0;e<t.length;e++)if(t[e].length>0&&t[e][0]._minimumCountForInstancing>0&&this._renderableObject.shouldGoInSameRenderQueueInstanced(t[e][0]._renderableObject))return t[e].push(this),e;return t.push([this]),t.length-1},RenderableNode.prototype.animateAndAddToRenderQueues=function(t,e,i,r,n){var o,s,a,l,u,c;if(this._visible&&(this._scene.shouldAnimate()&&this._renderableObject.animate(r),!this._renderableObject.canBeReused()&&(u=this._renderableObject.isRenderedWithoutDepthMask(),c=this._renderableObject.isRenderedWithDepthMask(),(u||c)&&(e?(o=this._renderableObject.getRenderQueueBits(i,n),o&h.RenderQueueBits.FRONT_QUEUE_BIT&&(u&&this.addToRenderQueue(t[V]),c&&this.addToRenderQueue(t[w])),o&h.RenderQueueBits.DISTANCE_QUEUE_BIT&&(u&&this.addToRenderQueue(t[B]),c&&this.addToRenderQueue(t[F]))):(u&&this.addToRenderQueue(t[V]),c&&this.addToRenderQueue(t[w]))),this._subnodes.getLength()>0)))if(void 0===o&&(o=e?this._renderableObject.getRenderQueueBits(i,n):h.RenderQueueBits.FRONT_QUEUE_BIT),!this._hasInstancedSubnodes||this._subnodes.getLength()<this._subnodes.getFirst()._minimumCountForInstancing)for(s=this._subnodes.getFirst();s;s=a)a=s.next,s.animateAndAddToRenderQueues(t,e,i,r,o);else{if(this._scene.shouldAnimate())for(s=this._subnodes.getFirst();s;s=a)a=s.next,s._renderableObject.animate(r);s=this._subnodes.getFirst(),u=s._renderableObject.isRenderedWithoutDepthMask(),c=s._renderableObject.isRenderedWithDepthMask(),(u||c)&&(o=s._renderableObject.getRenderQueueBits(i,o),o&h.RenderQueueBits.FRONT_QUEUE_BIT&&(u&&(l=s.addToRenderQueue(t[V]),t[V][l].pop(),this._subnodes.appendToArray(t[V][l])),c&&(l=s.addToRenderQueue(t[w]),t[w][l].pop(),this._subnodes.appendToArray(t[w][l]))),o&h.RenderQueueBits.DISTANCE_QUEUE_BIT&&(u&&(l=s.addToRenderQueue(t[B]),t[B][l].pop(),this._subnodes.appendToArray(t[B][l])),c&&(l=s.addToRenderQueue(t[F]),t[F][l].pop(),this._subnodes.appendToArray(t[F][l]))))}},RenderableNode.prototype.getParent=function(){return this._parent},RenderableNode.prototype.setParent=function(t){this._parent=t,this.setScene(t._scene),this._renderableObject.setParent&&this._renderableObject.setParent(t._renderableObject)},RenderableNode.prototype.getRenderableObject=function(){return this._renderableObject},RenderableNode.prototype.isVisible=function(){return this._visible&&(!this._parent||this._parent.isVisible())},RenderableNode.prototype.show=function(){this._visible=!0},RenderableNode.prototype.hide=function(){this._visible=!1},RenderableNode.prototype.toggleVisibility=function(){this._visible=!this._visible},RenderableNode.prototype.addSubnode=function(t,e){return this._subnodes.add(t),t.setParent(this),this._scene&&t.setScene(this._scene,e),t},RenderableNode.prototype.getSubnodes=function(){return this._subnodes},RenderableNode.prototype.getFirstSubnode=function(){return this._subnodes.getFirst()},RenderableNode.prototype.getNextSubnode=function(t){return this._subnodes.getNext(t)},RenderableNode.prototype.getPreviousSubnode=function(t){return this._subnodes.getPrevious(t)},RenderableNode.prototype.addCameraConfiguration=function(t){this._cameraConfigurations.push(t)},RenderableNode.prototype.hasCameraConfiguration=function(t){var e;for(e=0;e<this._cameraConfigurations.length;e++)if(this._cameraConfigurations[e]===t)return!0;return!1},RenderableNode.prototype.getNextCameraConfiguration=function(t){var e,i,r=this._cameraConfigurations.length;if(0>=r)return null;if(t){for(e=0;r>e;e++)if(this._cameraConfigurations[e]===t){i=e;break}if(e>=r)return void n.crash()}else i=-1;for(e=(i+1)%r;e!==i&&this._cameraConfigurations[e].shouldExcludeFromCycle();)e=(e+1)%r;return this._cameraConfigurations[e]},RenderableNode.prototype.getPreviousCameraConfiguration=function(t){var e,i,r=this._cameraConfigurations.length;if(0>=r)return null;if(t){for(e=r-1;e>=0;e--)if(this._cameraConfigurations[e]===t){i=e;break}if(0>e)return void n.crash()}else i=r;for(e=(i+r-1)%r;e!==i&&this._cameraConfigurations[e].shouldExcludeFromCycle();)e=(e+r-1)%r;return this._cameraConfigurations[e]},RenderableNode.prototype.getCameraConfigurationsWithName=function(t){var e,i=[];for(e=0;e<this._cameraConfigurations.length;e++)this._cameraConfigurations[e].getName()===t&&i.push(this._cameraConfigurations[e]);return i},RenderableNode.prototype.resetCameraConfigurations=function(){var t;for(t=0;t<this._cameraConfigurations.length;t++)this._cameraConfigurations[t].resetToDefaults()},RenderableNode.prototype.log=function(t){var e,i,r="",o=this._renderableObject.constructor.name;for(e=0;t>e;e++)r+=". ";for(r+=o,n.log(r),this._scene.increaseCount(o),i=this._subnodes.getFirst();i;i=i.next)i.log(t+1)},RenderableNode.prototype.resetForNewFrame=function(){var t;for(this._renderableObject.resetForNewFrame(),t=this._subnodes.getFirst();t;t=t.next)t.resetForNewFrame()},RenderableNode.prototype.setRenderParameters=function(t,e,i,r,n,o,s,a,l){var h=this._renderParameters;h.context=t,h.depthMask=r,h.scene=this._scene,h.parent=this._parent?this._parent._renderableObject:null,h.camera=this._scene._camera,h.viewportWidth=e,h.viewportHeight=i,h.lodContext=this._scene._lodContext,h.useInstancing=n,h.instanceQueueIndex=o,h.lightMatrix=s,h.shadowMapRange=a,h.shadowMapDepthRatio=l},RenderableNode.prototype.render=function(t,e,i,r,n,o,s){var a,l;if(this._visible){if(this._renderableObject.mightBeRendered()?(this.setRenderParameters(t,e,i,r,o,s),l=this._renderableObject.render(this._renderParameters)):l=!1,!n)for(a=this._subnodes.getFirst();a;a=a.next)a.render(t,e,i,r,n,o,s);return l}return!1},RenderableNode.prototype.prepareForInstancedRender=function(t,e,i){this._renderableObject.prepareForInstancedRender(t,this._scene,e,i)},RenderableNode.prototype.renderInstances=function(t,e,i){this._renderableObject.renderInstances(t,e,i)},RenderableNode.prototype.renderToShadowMap=function(t,e,i,r,n,o){var s,a;if(this._visible&&this._isRenderedToShadowMap){for(this._renderableObject.mightBeRenderedToShadowMap()?(this.setRenderParameters(t,e,i,!0,void 0,void 0,r,n,o),a=this._renderableObject.renderToShadowMap(this._renderParameters)):a=!1,s=this._subnodes.getFirst();s;s=s.next)s.renderToShadowMap(t,e,i,r,n,o);return a}return!1},RenderableNode.prototype.execute=function(t){var e;for(t(this._renderableObject),e=this._subnodes.getFirst();e;e=e.next)e.execute(t)},RenderableNode.prototype.addToContext=function(t){var e;for(this._renderableObject.addToContext(t),e=this._subnodes.getFirst();e;e=e.next)e.addToContext(t)},RenderableNode.prototype.getShader=function(){return this._renderableObject.getShader()},RenderableNode.prototype.setShader=function(t){var e;for(this._renderableObject.setShader(t),e=this._subnodes.getFirst();e;e=e.next)e.setShader(t)},RenderableNode.prototype.markAsReusable=function(t){var e,i;for(this._renderableObject.markAsReusable(t),e=this._subnodes.getFirst();e;e=i)i=e.next,
e.markAsReusable(t);this._canBeReused=!0,t&&this._parent&&this._parent.removeSubnode(this,!0)},RenderableNode.prototype.handleObjectBecameReusable=function(t){t&&this._parent&&0===this._subnodes.getLength()&&this._parent.removeSubnode(this,!0)},RenderableNode.prototype.cleanUp=function(){var t,e;for(t=this._subnodes.getFirst();t;)e=t.next,t.canBeReused()&&this._subnodes.remove(t),t=e;for(t=this._subnodes.getFirst();t;t=t.next)t.cleanUp()},RenderableNode.prototype.getMinimumCountForInstancing=function(){return this._minimumCountForInstancing},RenderableNode.prototype.removeSubnode=function(t,e){this._subnodes.remove(t),e&&0===this._subnodes.getLength()&&this._renderableObject.canBeReused()&&this._parent&&this._parent.removeSubnode(this,!0)},RenderableNode.prototype.removeSubnodes=function(t){this._subnodes.clear(t)},RenderableNode.prototype.destroy=function(){var t,e;if(this._renderableObject.setNode(null),this._renderableObject=null,this._scene=null,this._parent=null,this._subnodes){for(t=this._subnodes.getFirst();t;t=e)e=t.next,t.destroy(),t=null;this._subnodes=null}this._renderParameters=null,this._cameraConfigurations=null,this.next=null,this.previous=null,this.list=null},Scene.prototype._setGeneralUniformValueFunctions=function(){this.setUniformValueFunction(m,function(){return this._renderedDirectionalLights}),this.setUniformValueFunction(f,function(){return this._directionalLightUniformData}),this.setUniformValueFunction(S,function(){return this._renderedPointLights}),this.setUniformValueFunction(y,function(){return this._pointLightUniformData}),this.setUniformValueFunction(T,function(){return this._renderedSpotLights}),this.setUniformValueFunction(E,function(){return this._spotLightUniformData}),this.setUniformValueFunction(C,function(){return this._camera.getViewMatrix()}),this.setUniformValueFunction(x,function(){return this._camera.getInverseOrientationMatrix()}),this.setUniformValueFunction(b,function(){return this._camera.getAspect()}),this.setUniformValueFunction(u.UNIFORM_PROJECTION_MATRIX_NAME,function(){return this._camera.getProjectionMatrix()}),this.setUniformValueFunction(M,function(){return r.prod4Aux(this._camera.getViewMatrix(),this._camera.getProjectionMatrix())}),this.setUniformValueFunction(R,function(){return i.floatVector3Aux(this._camera.getCameraPositionVector())})},Scene.prototype._setContextUniformValueFunctions=function(t){var e=this._contexts[t].gl;this.setContextUniformValueFunction(t,O,function(){return[e.drawingBufferWidth*this._width,e.drawingBufferHeight*this._height]})},Scene.prototype._setShadowMappedShaderUniformValueFunctions=function(t){var e;if(0===t&&(this.setUniformValueFunction(A,function(){return this._shadowMapRanges.length}),this.setUniformValueFunction(I,function(){return this._shadowMapRanges}),this.setUniformValueFunction(v,function(){return this._shadowMapDepthRatio}),this.setUniformValueFunction(N,function(){return this._shadowMapTextureSize}),this.setUniformValueFunction(D,function(){return this._shadowMapSampleOffsets})),void 0!==t)this.setContextUniformValueFunction(t,L,function(){var e,i,r=[];for(e=0;e<this._directionalLights.length&&e<this._maxRenderedDirectionalLights;e++)for(i=0;i<this._shadowMapRanges.length;i++)r.push(this._contexts[t].getFrameBuffer(this._directionalLights[e].getShadowMapBufferName(i)).getLastTextureBindLocation(this._contexts[t].getName()));return new Int32Array(r)});else for(e=0;e<this._contexts.length;e++)this._setShadowMappedShaderUniformValueFunctions(e)},Scene.prototype._updateStaticLightUniformData=function(){var t;for(this._renderedDirectionalLights=Math.min(this._directionalLights.length,this._maxRenderedDirectionalLights),t=0;t<this._renderedDirectionalLights;t++)this._directionalLightUniformData[t]=this._directionalLights[t].getUniformData();t<this._maxRenderedDirectionalLights&&(this._directionalLightUniformData[t]=null)},Scene.prototype._clearDynamicLightUniformData=function(){this._renderedPointLights=0,this._pointLightUniformData[0]=null,this._renderedSpotLights=0,this._spotLightUniformData[0]=null},Scene.prototype._updateDynamicLightUniformData=function(t){var e,i,r,n;for(e=0,r=0;e<this._pointLightPriorityArrays.length;e++){for(i=0;i<this._pointLightPriorityArrays[e].length&&r<this._maxRenderedPointLights;i++)this._pointLightPriorityArrays[e][i].update(t),this._pointLightPriorityArrays[e][i].shouldBeRendered(this._camera)&&(this._pointLightUniformData[r]=this._pointLightPriorityArrays[e][i].getUniformData(),r++);for(;i<this._pointLightPriorityArrays[e].length;)this._pointLightPriorityArrays[e][i].updateState(t),i++}for(this._renderedPointLights=r,r<this._maxRenderedPointLights&&(this._pointLightUniformData[r]=null),r=0,e=0,n=Math.min(this._spotLights.length,this._maxRenderedSpotLights);e<this._spotLights.length&&n>r;e++)this._spotLights[e].update(t),this._spotLights[e].shouldBeRendered(this._camera)&&(this._spotLightUniformData[r]=this._spotLights[e].getUniformData(),r++);for(;e<this._spotLights.length;)this._spotLights[e].updateState(t),e++;this._renderedSpotLights=r,r<this._maxRenderedSpotLights&&(this._spotLightUniformData[r]=null)},Scene.prototype._getShadowMapBufferNamePrefix=function(t){return d+t+_},Scene.prototype._setupContext=function(t){var e;if(void 0!==t)for(this._setContextUniformValueFunctions(t),this._shadowMappingEnabled&&(this._contexts[t].addShader(this._shadowMappingShader),this._setShadowMappedShaderUniformValueFunctions(t)),e=0;e<this._directionalLights.length&&e<this._maxRenderedDirectionalLights;e++)this._directionalLights[e].addToContext(this._contexts[t],this._shadowMappingEnabled,this._getShadowMapBufferNamePrefix(e),this._shadowMapRanges.length,this._shadowMapTextureSize);else for(e=0;e<this._contexts.length;e++)this._setupContext(e)},Scene.prototype.setRelativeViewport=function(t,e,i,r){this._left=t,this._bottom=e,this._width=i,this._height=r},Scene.prototype.addToContext=function(t){var e=this._contexts.findIndex(function(e){return e.getName()===t.getName()});0>e&&(this._contexts.push(t),e=this._contexts.length-1),this._setupContext(e),this._rootBackgroundNode.addToContext(t),this._rootNode.addToContext(t),this._rootUINode.addToContext(t),this._rootResourceNode.addToContext(t)},Scene.prototype.enableShadowMapping=function(){this._shadowMappingShader&&this._shadowMapRanges.length>0?(this._shadowMappingEnabled=!0,this._setupContext()):n.showError("Cannot enable shadow mapping, as no shadow mapping shader or no shadow mapping ranges were specified")},Scene.prototype.disableShadowMapping=function(){this._shadowMappingEnabled=!1},Scene.prototype.toggleShadowMapping=function(){this._shadowMappingEnabled=!this._shadowMappingEnabled,this._shadowMappingEnabled?this.enableShadowMapping():this.disableShadowMapping()},Scene.prototype.setShadowMapRanges=function(t){this._shadowMapRanges=new Float32Array(t),this._setupContext()},Scene.prototype.setShadowMapping=function(t){t?(this._shadowMappingEnabled=void 0!==t.enable?t.enable:this._shadowMappingEnabled,this._shadowMappingShader=t.shader||this._shadowMappingShader,this._shadowMapTextureSize=t.textureSize||this._shadowMapTextureSize,this._shadowMapRanges=t.ranges?new Float32Array(t.ranges):this._shadowMapRanges,this._shadowMapDepthRatio=t.depthRatio||this._shadowMapDepthRatio,this._numShadowMapSamples=t.numSamples?e.getNumberValueInRange("shadowMappingParams.numSamples",t.numSamples,this._shadowMappingEnabled?1:0,this._shadowMappingEnabled?P.length/2:0,this._shadowMappingEnabled?1:0):t.numSamples,this._shadowMapSampleOffsets=P.slice(0,2*this._numShadowMapSamples),t.deferSetup||this._setupContext()):(this._shadowMappingEnabled=!1,this._shadowMappingShader=null,this._shadowMapTextureSize=0,this._shadowMapRanges=new Float32Array([]),this._shadowMapDepthRatio=0,this._numShadowMapSamples=0,this._shadowMapSampleOffsets=[])},Scene.prototype.getRootNode=function(){return this._rootNode},Scene.prototype.getCamera=function(){return this._camera},Scene.prototype.shouldAnimate=function(){return this._shouldAnimate},Scene.prototype.setShouldAnimate=function(t){this._shouldAnimate=t},Scene.prototype.shouldUpdateCamera=function(){return this._shouldUpdateCamera},Scene.prototype.setShouldUpdateCamera=function(t){this._shouldUpdateCamera=t},Scene.prototype.addBackgroundObject=function(t){var e=new RenderableNode(t,!1);return this._rootBackgroundNode.addSubnode(e),e},Scene.prototype.addObject=function(t,e,i){var r=new RenderableNode(t,e,!1,i);return this._rootNode.addSubnode(r),r},Scene.prototype.addNode=function(t){return this._rootNode.addSubnode(t),t},Scene.prototype.addUIObject=function(t){var e=new RenderableNode(t,!1);return this._rootUINode.addSubnode(e),e},Scene.prototype.addObjectToContexts=function(t){var e;for(e=0;e<this._contexts.length;e++)t.addToContext(this._contexts[e])},Scene.prototype.clear=function(t){this.clearNodes(t),this.clearDirectionalLights(),this.clearPointLights(),this.clearSpotLights()},Scene.prototype._initNodes=function(){this._rootBackgroundNode=new RenderableNode(new h.RenderableObject3D(null,!1,!1,r.IDENTITY4,r.IDENTITY4,r.IDENTITY4,void 0,0,!1,!0),!1),this._rootBackgroundNode.setScene(this),this._rootNode=new RenderableNode(new h.RenderableObject3D(null,!1,!1,r.IDENTITY4,r.IDENTITY4,r.IDENTITY4,void 0,0,!1,!0)),this._rootNode.setScene(this),this._rootResourceNode=new RenderableNode(new h.RenderableObject3D(null,!1,!1,r.IDENTITY4,r.IDENTITY4,r.IDENTITY4,void 0,1,!1,!0),!1),this._rootResourceNode.setScene(this),this._resourceObjectIDs={},this._rootUINode=new RenderableNode(new h.RenderableObject3D(null,!1,!1,r.IDENTITY4,r.IDENTITY4,r.IDENTITY4,void 0,0,!1,!0),!1),this._rootUINode.setScene(this)},Scene.prototype.clearNodes=function(t){this._rootBackgroundNode&&this._rootBackgroundNode.removeSubnodes(t),this._rootNode&&this._rootNode.removeSubnodes(t),this._rootResourceNode&&this._rootResourceNode.removeSubnodes(t),this._resourceObjectIDs={},this._rootUINode&&this._rootUINode.removeSubnodes(t)},Scene.prototype.clearDirectionalLights=function(){this._directionalLights=[]},Scene.prototype.clearPointLights=function(){var t;for(this._pointLightPriorityArrays=new Array(g),t=0;g>t;t++)this._pointLightPriorityArrays[t]=[]},Scene.prototype.clearSpotLights=function(){this._spotLights=[]},Scene.prototype.getAllObjects=function(){var t,e=[],i=this._rootNode._subnodes;for(t=i.getFirst();t;t=t.next)e.push(t._renderableObject);return e},Scene.prototype.getAll3DObjects=function(){var t,e,i=[],r=this._rootNode._subnodes;for(e=r.getFirst();e;e=e.next)t=e._renderableObject,t.getPositionMatrix&&t.getOrientationMatrix&&i.push(t);return i},Scene.prototype.moveAllObjectsByVector=function(t){var e,i,r=this._rootNode._subnodes;for(i=r.getFirst();i;i=i.next)e=i._renderableObject,e.translatev&&e.translatev(t)},Scene.prototype.moveCameraToOrigoIfNeeded=function(t){var e=this._camera.moveToOrigoIfNeeded(t);return e&&this.moveAllObjectsByVector(e),e},Scene.prototype.getFirstNode=function(){return this._rootNode.getFirstSubnode()},Scene.prototype.getNextNode=function(t){return this._rootNode.getNextSubnode(t)},Scene.prototype.getPreviousNode=function(t){return this._rootNode.getPreviousSubnode(t)},Scene.prototype.hasResourcesOfObject=function(t){return!!this._resourceObjectIDs[t]},Scene.prototype.addResourcesOfObject=function(t,e){var i;e&&this._resourceObjectIDs[e]||(t&&(i=new RenderableNode(t,!1),this._rootResourceNode.addSubnode(i,!0),i.markAsReusable(!1)),e&&(this._resourceObjectIDs[e]=!0))},Scene.prototype.addDirectionalLightSource=function(t){this._directionalLights.push(t)},Scene.prototype.addPointLightSource=function(t,e){e=Math.min(e||0,g-1),this._pointLightPriorityArrays[e].push(t)},Scene.prototype.addSpotLightSource=function(t){this._spotLights.push(t)},Scene.prototype.getLODContext=function(){return this._lodContext},Scene.prototype.setUniformValueFunction=function(t,e){this._uniformValueFunctions[o.getUniformName(t)]=e.bind(this)},Scene.prototype.setContextUniformValueFunction=function(t,e,i){this._contextUniformValueFunctions[t]||(this._contextUniformValueFunctions[t]={}),this._contextUniformValueFunctions[t][o.getUniformName(e)]=i.bind(this)},Scene.prototype.addCameraConfiguration=function(t){this._rootNode.addCameraConfiguration(t)},Scene.prototype.hasCameraConfiguration=function(t){return this._rootNode.hasCameraConfiguration(t)},Scene.prototype.getNextCameraConfiguration=function(t){return this._rootNode.getNextCameraConfiguration(t)},Scene.prototype.getPreviousCameraConfiguration=function(t){return this._rootNode.getPreviousCameraConfiguration(t)},Scene.prototype.getCameraConfigurationsWithName=function(t){return this._rootNode.getCameraConfigurationsWithName(t)},Scene.prototype.hideUI=function(){this._rootUINode.hide()},Scene.prototype.showUI=function(){this._rootUINode.show()},Scene.prototype.assignUniforms=function(t,e){this._uniformsUpdated[e.getName()]||(e.assignUniforms(t,this._uniformValueFunctions),e.assignUniforms(t,this._contextUniformValueFunctions[this._contexts.indexOf(t)]),this._uniformsUpdated[e.getName()]=!0,this._uniformsUpdatedForFrame=!0)},Scene.prototype.cleanUpLights=function(){var t,e,i,r;for(r=0;r<this._pointLightPriorityArrays.length;r++)for(t=0;t<this._pointLightPriorityArrays[r].length;t++){for(e=t,i=0;e<this._pointLightPriorityArrays[r].length&&(!this._pointLightPriorityArrays[r][e]||this._pointLightPriorityArrays[r][e].canBeReused()===!0);)e++,i++;this._pointLightPriorityArrays[r].splice(t,i)}for(t=0;t<this._spotLights.length;t++){for(e=t,i=0;e<this._spotLights.length&&(!this._spotLights[e]||this._spotLights[e].canBeReused()===!0);)e++,i++;this._spotLights.splice(t,i)}},Scene.prototype._renderShadowMap=function(t,e,i,r,s,a){var l,h,u=t.gl;if(n.log_DEBUG("Starting new shadow map...",4),this._shadowQueue.length>0){for(o.areDepthTexturesAvailable()?u.clear(u.DEPTH_BUFFER_BIT):u.clear(u.COLOR_BUFFER_BIT|u.DEPTH_BUFFER_BIT),h=[],l=0;l<this._shadowQueue.length;l++)this._shadowQueue[l].renderToShadowMap(t,e,i,r,s,a)&&h.push(this._shadowQueue[l]);this._shadowQueue=h}},Scene.prototype._renderShadowMaps=function(t,e,i){var r,o,s,a=t.gl;if(this._shadowMappingEnabled){for(n.log_DEBUG("Rendering shadow maps for scene...",4),a.viewport(0,0,this._shadowMapTextureSize,this._shadowMapTextureSize),a.clearColor(0,0,0,0),t.setColorMask(U),t.disableBlending(),t.setDepthMask(!0),t.setCurrentShader(this._shadowMappingShader),this.assignUniforms(t,this._shadowMappingShader),r=0;r<this._directionalLights.length&&r<this._maxRenderedDirectionalLights;r++){for(this._directionalLights[r].reset(),this._shadowQueue=new Array(this._rootNode._subnodes.getLength()),o=0,s=this._rootNode._subnodes.getFirst();s;s=s.next,o++)this._shadowQueue[o]=s;for(n.log_DEBUG("Rendering shadow maps for light "+r+"...",4),o=this._shadowMapRanges.length-1;o>=0;o--)this._directionalLights[r].startShadowMap(t,this._camera,o,this._shadowMapRanges[o],this._shadowMapRanges[o]*this._shadowMapDepthRatio,this._shadowMapRanges[o]),this._renderShadowMap(t,e,i,this._directionalLights[r].getTranslatedMatrix(),this._shadowMapRanges[o],this._shadowMapDepthRatio)}for(r=0;r<this._directionalLights.length&&r<this._maxRenderedDirectionalLights;r++)for(o=0;o<this._shadowMapRanges.length;o++)t.bindTexture(t.getFrameBuffer(this._directionalLights[r].getShadowMapBufferName(o)),void 0,!0)}t.setCurrentFrameBuffer(null)},Scene.prototype._renderBackgroundObjects=function(t,e,i){n.log_DEBUG("Rendering background objects of scene...",4),t.enableBlending(),t.setDepthMask(!1),this._rootBackgroundNode.resetForNewFrame(),this._rootBackgroundNode.render(t,e,i,!1)},Scene.prototype._renderQueue=function(t,e,i,r,n,o){var s,a,l,h=r.length;if(h>0)if(a=r[0]._minimumCountForInstancing,a>0&&h>=a&&t.instancingExt){for(l=0,r[0].prepareForInstancedRender(t,n,h),s=0;h>s;s++)r[s].render(t,e,i,o,!0,!0,n)&&l++;l>0&&r[0].renderInstances(t,n,l)}else for(s=0;h>s;s++)r[s].render(t,e,i,o,!0)},Scene.prototype._renderMainObjects=function(t,e,i,r,o,s){var a;if(n.log_DEBUG("Rendering opaque phase...",4),r.length>0)for(t.setDepthMask(!0),t.disableBlending(),a=0;a<r.length;a++)this._renderQueue(t,e,i,r[a],a,!0);if(s&&this._renderBackgroundObjects(t,e,i),n.log_DEBUG("Rendering transparent phase...",4),o.length>0)for(t.setDepthMask(!1),t.enableBlending(),a=0;a<o.length;a++)this._renderQueue(t,e,i,o[a],a,!1)},Scene.prototype._renderUIObjects=function(t,e,i){var r,n=t.gl;this._rootUINode.isVisible()&&this._rootUINode._subnodes.getLength()>0&&(r=this._camera,this._distanceRendering&&(this._camera=this._camera.getExtendedCamera(!0)),t.enableBlending(),n.disable(n.DEPTH_TEST),t.setDepthMask(!1),this._rootUINode.resetForNewFrame(),this._rootUINode.render(t,e,i,!1),n.enable(n.DEPTH_TEST),this._camera=r)},Scene.prototype.render=function(e,i){var r,o,a,l,h=e.gl,u=h.drawingBufferWidth,c=h.drawingBufferHeight,p=u*this._width,d=c*this._height;n.log_DEBUG("Rendering scene...",3),s.resetDebugStats(),this._camera.setAspect(p/d),this._shouldUpdateCamera&&this._camera.update(i),this._numDrawnTriangles=0,this._uniformsUpdated={},this._rootNode.resetForNewFrame(),this._renderQueues[w]=[],this._renderQueues[V]=[],this._distanceRendering&&(this._renderQueues[F]=[],this._renderQueues[B]=[]),this._rootNode.animateAndAddToRenderQueues(this._renderQueues,this._distanceRendering,this._camera,i),this.cleanUpLights(),a=this._renderQueues[w].length>0||this._renderQueues[V].length>0,l=this._distanceRendering&&(this._renderQueues[F].length>0||this._renderQueues[B].length>0),a&&this._renderShadowMaps(e,p,d),n.isDebugVersion()&&(this._shadowMapDebugStats=t.shallowCopy(s.getDebugStats()),s.resetDebugStats()),this._updateStaticLightUniformData(),h.viewport(this._left*u,this._bottom*c,p,d),this._shouldClearColorOnRender&&(e.setColorMask(this._clearColorMask),h.clearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3])),e.setDepthMask(!0),r=this._shouldClearColorOnRender?h.COLOR_BUFFER_BIT:0,r=this._shouldClearDepthOnRender?r|h.DEPTH_BUFFER_BIT:r,h.clear(r),this._uniformsUpdatedForFrame===!1&&e.getCurrentShader()&&this.assignUniforms(e,e.getCurrentShader()),this._uniformsUpdatedForFrame=!1,l&&(o=this._camera,this._camera=this._camera.getExtendedCamera(),this._clearDynamicLightUniformData(),this._renderMainObjects(e,p,d,this._renderQueues[F],this._renderQueues[B],!0),this._camera=o,e.setDepthMask(!0),h.clear(h.DEPTH_BUFFER_BIT),this._uniformsUpdated={}),(a||!l)&&(this._updateDynamicLightUniformData(this._shouldAnimate?i:0),e.getCurrentShader()&&this.assignUniforms(e,e.getCurrentShader()),this._renderMainObjects(e,p,d,this._renderQueues[w],this._renderQueues[V],!l)),this._renderUIObjects(e,p,d),n.isDebugVersion()&&(this._mainDebugStats=t.shallowCopy(s.getDebugStats()))},Scene.prototype.increaseCount=function(t){this._nodeCount++,this._nodeCountByType[t]=this._nodeCountByType[t]||0,this._nodeCountByType[t]++},Scene.prototype.logNodes=function(){var t,e;for(n.log("--------------"),this._nodeCount=0,this._nodeCountByType={},n.log("Scene structure:"),this._rootNode.log(0),n.log("Scene statistics:"),n.log("Total node count: "+this._nodeCount),n.log("Count by type:"),t=Object.keys(this._nodeCountByType),e=0;e<t.length;e++)n.log("["+t[e]+"]: "+this._nodeCountByType[t[e]]);n.log("--------------")},Scene.prototype.getMainDebugStats=function(){return this._mainDebugStats},Scene.prototype.getShadowMapDebugStats=function(){return this._shadowMapDebugStats},{getDebugInfo:getDebugInfo,LODContext:LODContext,RenderableNode:RenderableNode,Scene:Scene}}),function(){"use strict";Math.sign=Math.sign||function(t){return t=+t,0===t||isNaN(t)?t:t>0?1:-1},Math.log10=Math.log10||function(t){return Math.log(t)/Math.LN10},Math.log2=Math.log2||function(t){return Math.log(t)/Math.LN2},Math.seed=function(t){return function(){return t=1e4*Math.sin(t),t-Math.floor(t)}},Math.radians=function(t){return t*Math.PI/180},Math.degrees=function(t){return 180*t/Math.PI},Number.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},Array.prototype.findIndex=Array.prototype.findIndex||function(t,e){var i;for(i=0;i<this.length;i++)if(t.call(e||t,this[i],i,this))return i;return-1},Array.prototype.find=Array.prototype.find||function(t,e){var i;for(i=0;i<this.length;i++)if(t.call(e||t,this[i],i,this))return this[i]}}(),define("utils/polyfill",function(){}),define("armada/graphics",["utils/types","modules/application","modules/async-resource","modules/managed-gl","modules/media-resources","modules/scene/scene-graph","armada/constants","utils/polyfill"],function(t,e,i,r,n,o,s){"use strict";function _getDependentShaderRequirement(t,e){var i,r,n=0;for(i in p)p.hasOwnProperty(i)&&(r=p[i],e.hasOwnProperty(r.name)&&(n+=t[r.name]*e[r.name]));return n}function _getShaderRequirementsFromDescriptor(t,e){return{requiredVertexUniformVectors:t[d]+_getDependentShaderRequirement(t[_],e),requiredAttributeVectors:t[g]+_getDependentShaderRequirement(t[m],e),requiredVaryingVectors:t[f]+_getDependentShaderRequirement(t[S],e),requiredTextureUnits:t[y]+_getDependentShaderRequirement(t[T],e),requiredFragmentUniformVectors:t[E]+_getDependentShaderRequirement(t[C],e)}}function _getCombinedRequirements(t,e){return{requiredVertexUniformVectors:t.requiredVertexUniformVectors+e.requiredVertexUniformVectors,requiredAttributeVectors:t.requiredAttributeVectors+e.requiredAttributeVectors,requiredVaryingVectors:t.requiredVaryingVectors+e.requiredVaryingVectors,requiredTextureUnits:t.requiredTextureUnits+e.requiredTextureUnits,requiredFragmentUniformVectors:t.requiredFragmentUniformVectors+e.requiredFragmentUniformVectors}}function OrderedNamedNumericOptions(e,i,r,n){this._list=e?t.getArrayValue(r||"OrderedNamedNumericOptions.list",e,i,null,{minLength:1},[]):[],this._optionNamePropertyName=i?i.properties.NAME.name:null,this._optionValuePropertyName=i?i.properties.VALUE.name:null,this._list.sort(function(t,e){return t[this._optionValuePropertyName]-e[this._optionValuePropertyName]}.bind(this)),this._currentIndex=this._list.length-1,n&&this.applyLimit(n)}function TextureQuality(t,e,i){OrderedNamedNumericOptions.call(this,t,h,e,i),this._preferenceList=null,this._preferenceNameList=null,this._updatePreferenceList()}function GraphicsSettingsContext(){i.AsyncResource.call(this),this._dataJSON=null,this._antialiasing=!1,this._filtering=null,this._lodLevel=null,this._maxLoadedLOD=0,this._lodContext=null,this._textureQuality=null,this._cubemapQuality=null,this._shadowMappingEnabled=!1,this._shadowMapQuality=null,this._shadowRanges=null,this._shadowDistances=null,this._shadowDepthRatio=0,this._pointLightAmount=null,this._particleAmount=null,this._dustParticleAmount=null,this._shaderConfig=null,this._shaderComplexity=null,this._luminosityTextureAreAvailable=!1}function shouldUseShadowMapping(){return a.isShadowMappingEnabled()&&a.isShadowMappingAvailable()}function getShadowMappingShader(){return a.getShader(a.getShadowMappingShaderName())}function getShadowMappingSettings(){return shouldUseShadowMapping()?{enable:!0,shader:a.getManagedShader(a.getShadowMappingShaderName()),textureSize:a.getShadowMapTextureSize(),ranges:a.getShadowRanges(),depthRatio:a.getShadowDepthRatio(),numSamples:a.getNumShadowMapSamples()}:null}var a,l=s.LOCAL_STORAGE_PREFIX+"graphics_",h=t.getNameAndValueDefinitionObject("maximumResolution"),u=t.getNameAndValueDefinitionObject("lod"),c={baseType:"object",properties:{LUMINOSITY_FACTOR:{name:"luminosityFactor",type:"number",defaultValue:0},GROUP_TRANSFORM:{name:"groupTransform",type:"number",defaultValue:0},DIR_LIGHT:{name:"dirLight",type:"number",defaultValue:0},POINT_LIGHT:{name:"pointLight",type:"number",defaultValue:0},SPOT_LIGHT:{name:"spotLight",type:"number",defaultValue:0},SHADOW_MAP:{name:"shadowMap",type:"number",defaultValue:0},SHADOW_MAP_RANGE:{name:"shadowMapRange",type:"number",defaultValue:0},SHADOW_MAP_SAMPLE:{name:"shadowMapSample",type:"number",defaultValue:0}}},p=c.properties,d="requiredVertexUniformVectors",_="requiredVertexUniformVectorsPer",g="requiredAttributeVectors",m="requiredAttributeVectorsPer",f="requiredVaryingVectors",S="requiredVaryingVectorsPer",y="requiredTextureUnits",T="requiredTextureUnitsPer",E="requiredFragmentUniformVectors",C="requiredFragmentUniformVectorsPer",M={baseType:"object",properties:{VERTEX_UNIFORM_VECTORS:{name:d,type:"number",defaultValue:0},VERTEX_UNIFORM_VECTORS_PER:{name:_,type:c,defaultValue:{}},ATTRIBUTE_VECTORS:{name:g,type:"number",defaultValue:0},ATTRIBUTE_VECTORS_PER:{name:m,type:c,defaultValue:{}},VARYING_VECTORS:{name:f,type:"number",defaultValue:0},VARYING_VECTORS_PER:{name:S,type:c,defaultValue:{}},TEXTURE_UNITS:{name:y,type:"number",defaultValue:0},TEXTURE_UNITS_PER:{name:T,type:c,defaultValue:{}},FRAGMENT_UNIFORM_VECTORS:{name:E,type:"number",defaultValue:0},FRAGMENT_UNIFORM_VECTORS_PER:{name:C,type:c,defaultValue:{}}}},x={baseType:"object",properties:{NAME:{name:"name",type:"string"},SHADOW_MAPPING_AVAILABLE:{name:"shadows",type:"boolean"},NUM_SHADOW_MAP_SAMPLES:{name:"numShadowMapSamples",type:"number",defaultValue:0},DYNAMIC_LIGHTS_AVAILABLE:{name:"dynamicLights",type:"boolean"},MAX_DIR_LIGHTS:{name:"maxDirLights",type:"number"},MAX_SPOT_LIGHTS:{name:"maxSpotLights",type:"number",defaultValue:0},LUMINOSITY_TEXTURES_AVAILABLE:{name:"luminosityTextures",type:"boolean"},REVEAL_AVAILABLE:{name:"reveal",type:"boolean"},REQUIREMENTS:{name:"requirements",type:M}}},b=x.properties,O="complexities",R={FEATURE_REQUIREMENTS:{name:"featureRequirements",type:"object",properties:{SHADOWS:{name:"shadows",type:M},DYNAMIC_LIGHTS:{name:"dynamicLights",type:M},REVEAL:{name:"reveal",type:M}}},COMPLEXITIES:{name:O,type:"array",elementType:x,minLength:1},SHADOW_MAPPING_SHADER_NAME:{name:"shadowMappingShaderName",type:"string"},MAX_DIR_LIGHTS_DEFINE_NAME:{name:"maxDirLightsDefineName",type:"string"},MAX_POINT_LIGHTS_DEFINE_NAME:{name:"maxPointLightsDefineName",type:"string"},MAX_SPOT_LIGHTS_DEFINE_NAME:{name:"maxSpotLightsDefineName",type:"string"},DUST_LENGTH_DIVISOR:{name:"dustLengthDivisor",type:"string"},DUST_LENGTH_DIVISOR_DEFINE_NAME:{name:"dustLengthDivisorDefineName",type:"string"},MAX_LUMINOSITY_FACTORS:{name:"maxLuminosityFactors",type:"number"},MAX_LUMINOSITY_FACTORS_DEFINE_NAME:{name:"maxLuminosityFactorsDefineName",type:"string"},MAX_GROUP_TRANSFORMS:{name:"maxGroupTransforms",type:"number"},MAX_GROUP_TRANSFORMS_DEFINE_NAME:{name:"maxGroupTransformsDefineName",type:"string"},MAX_SHADOW_MAP_RANGES_DEFINE_NAME:{name:"maxShadowMapRangesDefineName",type:"string"},MAX_SHADOW_MAPS_DEFINE_NAME:{name:"maxShadowMapsDefineName",type:"string"},NUM_SHADOW_MAP_SAMPLES_DEFINE_NAME:{name:"numShadowMapSamplesDefineName",type:"string"},DEPTH_TEXTURES_DEFINE_NAME:{name:"depthTexturesDefineName",type:"string"},MAX_SHININESS:{name:"maxShininess",type:"string"},MAX_SHININESS_DEFINE_NAME:{name:"maxShininessDefineName",type:"string"}},A=R.FEATURE_REQUIREMENTS.properties,I=t.getNameAndValueDefinitionObject("numRanges"),v=t.getNameAndValueDefinitionObject("maxLights"),N=t.getNameAndValueDefinitionObject("particleCountFactor"),L=l+"antialiasing",D=l+"filtering",P=r.TextureFiltering.TRILINEAR,w=l+"textureQuality",V=l+"cubemapQuality",F=l+"maxLOD",B=l+"shaderComplexity",U=l+"shadowMapping",j=l+"shadowQuality",G=l+"shadowDistance",k=l+"pointLightAmount",H=l+"particleAmount",W=l+"dustParticleAmount",q="withoutShadows",z="withoutDynamicLights";return OrderedNamedNumericOptions.prototype._getNameFunction=function(t){return t[this._optionNamePropertyName]},OrderedNamedNumericOptions.prototype._checkNameFunction=function(t,e){return e[this._optionNamePropertyName]===t},OrderedNamedNumericOptions.prototype._isWithinLimitFunction=function(t,e){return e[this._optionValuePropertyName]<=t},OrderedNamedNumericOptions.prototype._valueFilterFunction=function(t,e){return t(e[this._optionValuePropertyName])},OrderedNamedNumericOptions.prototype._getInvalidOptionAccessErrorMessage=function(t){return"Invalid option ("+this._optionValuePropertyName+") '"+t+"' specified! Valid values are: "+this.getNameList().join(", ")+"."},OrderedNamedNumericOptions.prototype.getNameList=function(){return this._list.map(this._getNameFunction.bind(this))},OrderedNamedNumericOptions.prototype.getFilteredNameList=function(t){return this._list.filter(this._valueFilterFunction.bind(this,t)).map(this._getNameFunction.bind(this))},OrderedNamedNumericOptions.prototype.setCurrent=function(t,i){return this._currentIndex=this._list.findIndex(this._checkNameFunction.bind(this,t)),this._currentIndex<0&&i&&(this._currentIndex=this._list.length-1),this._currentIndex<0?(e.showError(this._getInvalidOptionAccessErrorMessage(t)),!1):!0},OrderedNamedNumericOptions.prototype.getCurrentName=function(){return this._currentIndex>=0?this._list[this._currentIndex][this._optionNamePropertyName]:null},OrderedNamedNumericOptions.prototype.getCurrentValue=function(){return this._currentIndex>=0?this._list[this._currentIndex][this._optionValuePropertyName]:0},OrderedNamedNumericOptions.prototype.getValueForName=function(t){var i=this._list.findIndex(this._checkNameFunction.bind(this,t));return i>=0?this._list[i][this._optionValuePropertyName]:(e.showError(this._getInvalidOptionAccessErrorMessage(t)),0)},OrderedNamedNumericOptions.prototype.applyLimit=function(t){var i=this.getCurrentName();this._list=this._list.filter(this._isWithinLimitFunction.bind(this,t)),this._currentIndex>=this._list.length&&(this._currentIndex=this._list.length-1,e.log("Setting ("+this._optionValuePropertyName+") changed to '"+this.getCurrentName()+"' from '"+i+"' as a result of limiting the setting to "+t+".",1))},OrderedNamedNumericOptions.prototype.decrease=function(){return this._currentIndex>0?(this._currentIndex--,!0):!1},OrderedNamedNumericOptions.prototype.setLowest=function(){this._currentIndex=0},OrderedNamedNumericOptions.prototype.getFirstValue=function(){return this._list[0][this._optionValuePropertyName]},TextureQuality.prototype=new OrderedNamedNumericOptions,TextureQuality.prototype.constructor=TextureQuality,TextureQuality.prototype._updatePreferenceList=function(){var t;for(this._preferenceList=[],t=this._currentIndex;t>=0;t--)this._preferenceList.push(this._list[t]);for(t=this._currentIndex+1;t<this._list.length;t++)this._preferenceList.push(this._list[t]);this._preferenceNameList=this._preferenceList.map(this._getNameFunction.bind(this))},TextureQuality.prototype.setCurrent=function(t,e){var i;return i=OrderedNamedNumericOptions.prototype.setCurrent.call(this,t,e),this._updatePreferenceList(),i},TextureQuality.prototype.getPreferenceNameList=function(){return this._preferenceNameList},TextureQuality.prototype.applyLimit=function(t){OrderedNamedNumericOptions.prototype.applyLimit.call(this,t),this._updatePreferenceList()},GraphicsSettingsContext.prototype=new i.AsyncResource,GraphicsSettingsContext.prototype.constructor=GraphicsSettingsContext,GraphicsSettingsContext.prototype._getShaderRequirements=function(t){t=t||{};var e,i=this._getShaderComplexityDescriptor(t.complexityLevelIndex),r=this.getShaderConfig(R.FEATURE_REQUIREMENTS),n=i[b.MAX_DIR_LIGHTS.name],o=void 0===t.numPointLights?this.getMaxPointLights():t.numPointLights,s=o>0?i[b.MAX_SPOT_LIGHTS.name]:0,a=void 0===t.numShadowRanges?this.getNumShadowMapRanges():t.numShadowRanges,l=n*a,h=i[b.NUM_SHADOW_MAP_SAMPLES.name],u={};return u[p.DIR_LIGHT.name]=n,u[p.POINT_LIGHT.name]=o,u[p.SPOT_LIGHT.name]=s,u[p.SHADOW_MAP.name]=l,u[p.SHADOW_MAP_RANGE.name]=a,u[p.SHADOW_MAP_SAMPLE.name]=h,u[p.LUMINOSITY_FACTOR.name]=this.getShaderConfig(R.MAX_LUMINOSITY_FACTORS),u[p.GROUP_TRANSFORM.name]=this.getShaderConfig(R.MAX_GROUP_TRANSFORMS),e=_getShaderRequirementsFromDescriptor(i[b.REQUIREMENTS.name],u),i[b.SHADOW_MAPPING_AVAILABLE.name]&&a>0&&(e=_getCombinedRequirements(e,_getShaderRequirementsFromDescriptor(r[A.SHADOWS.name],u))),i[b.DYNAMIC_LIGHTS_AVAILABLE.name]&&o>0&&(e=_getCombinedRequirements(e,_getShaderRequirementsFromDescriptor(r[A.DYNAMIC_LIGHTS.name],u))),i[b.REVEAL_AVAILABLE.name]&&(e=_getCombinedRequirements(e,_getShaderRequirementsFromDescriptor(r[A.REVEAL.name],u))),
e},GraphicsSettingsContext.prototype._shaderRequirementsAreSatisfied=function(t){return r.requirementsAreSatisfied(this._getShaderRequirements(t))},GraphicsSettingsContext.prototype._limitShaderComplexities=function(){var t,i=[],r=this.getShaderConfig(R.COMPLEXITIES);for(t=0;t<r.length;t++)this._shaderRequirementsAreSatisfied({numPointLights:0,numShadowRanges:0,complexityLevelIndex:t})?i.push(r[t]):e.log("Defined shader complexity level '"+r[t][b.NAME.name]+"', which has too high requirements and thus will be dropped from the available shader complexities.",1);this.setShaderConfig(R.COMPLEXITIES,i)},GraphicsSettingsContext.prototype._setFallbackShaderComplexity=function(t){var e;for(t&&!this._shaderRequirementsAreSatisfied()&&this._disableShaderFeatures(),e=this.getShaderComplexities().indexOf(this.getShaderComplexity());e>0&&!this._shaderRequirementsAreSatisfied({complexityLevelIndex:e});)e--;this.setShaderComplexity(this.getShaderComplexities()[e],!1)},GraphicsSettingsContext.prototype.loadConfigurationFromJSON=function(e){var i,n,s,a;for(this._shaderConfig=t.getVerifiedObject("config.graphics.shaders",e.shaders,R),this._limitShaderComplexities(),this._textureQuality=new TextureQuality(e.context.textureQualities,"config.graphics.context.textureQualities",r.getMaxTextureSize()),this._cubemapQuality=new TextureQuality(e.context.cubemapQualities,"config.graphics.context.cubemapQualities",r.getMaxCubemapSize()),this._shadowMapQuality=new TextureQuality(e.context.shadows.qualities,"config.graphics.context.shadows.qualities",r.getMaxRenderbufferSize()),this._shadowRanges=t.getArrayValue("config.graphics.context.shadows.ranges",e.context.shadows.ranges,"number",null,{minLength:1}),this._shadowDistances=new OrderedNamedNumericOptions(e.context.shadows.distances,I,"config.graphics.context.shadows.distances",this._shadowRanges.length),this._shadowDepthRatio=t.getNumberValue("config.graphics.context.shadows.depthRatio",e.context.shadows.depthRatio),this._pointLightAmount=new OrderedNamedNumericOptions(e.context.pointLightAmounts,v,"config.graphics.context.pointLightAmounts"),this._particleAmount=new OrderedNamedNumericOptions(e.context.particleAmounts,N,"config.graphics.context.particleAmounts"),this._dustParticleAmount=new OrderedNamedNumericOptions(e.context.dustParticleAmounts,N,"config.graphics.context.dustParticleAmounts"),this._lodLevel=new OrderedNamedNumericOptions(e.levelOfDetailSettings.lodLevels,u,"config.graphics.levelOfDetailSettings.lodLevels"),a=new Array(e.levelOfDetailSettings.lodDisplayProfile.limits.length+1),a[0]=0,i=0,n=e.levelOfDetailSettings.lodDisplayProfile.limits.length;n>i;i++)s=e.levelOfDetailSettings.lodDisplayProfile.limits[i],a[this._lodLevel.getValueForName(s.level)+1]=s.objectSizeLessThan;this._lodContext=new o.LODContext(this._lodLevel.getFirstValue(),a,e.levelOfDetailSettings.lodDisplayProfile.compensateForObjectSize,e.levelOfDetailSettings.lodDisplayProfile.referenceSize,e.levelOfDetailSettings.lodDisplayProfile.minimumRelativeSize)},GraphicsSettingsContext.prototype._limitSettingByScreenSize=function(t,e,i,r,n){var o,s,a,l;if(t.autoLimitByScreenSize===!0)for(o=Math.max(screen.width,screen.height),s=0,a=t.limits.length;a>s;s++)l=t.limits[s],o<l.screenSizeLessThan&&i()>e.getValueForName(l[n])&&r(l[n],!1)},GraphicsSettingsContext.prototype.loadSettingsFromJSON=function(i,n){n=n||!1,n||(this._dataJSON=i),"object"==typeof i.shaders?this.setShaderComplexity(i.shaders.complexity,!1,!0):e.showError("Missing required settings.graphics.shaders from the setting definition object!"),"object"==typeof i.context?(this.setAntialiasing(t.getBooleanValue(i.context.antialiasing,{name:"settings.graphics.context.antialiasing"}),!1),this.setFiltering(t.getEnumValue(r.TextureFiltering,i.context.filtering,{name:"settings.graphics.context.filtering"}),!1),this.setTextureQuality(i.context.textureQuality,!1,!0),this.setCubemapQuality(i.context.cubemapQuality.level,!1,!0),this._limitSettingByScreenSize(i.context.cubemapQuality,this._cubemapQuality,this.getCubemapMaxResolution.bind(this),this.setCubemapQuality.bind(this),"level"),this.setShadowMapping(t.getBooleanValue(i.context.shadowMapping,{name:"settings.graphics.context.shadowMapping"}),!1,!0),"object"==typeof i.context.shadows&&(this.setShadowMapQuality(i.context.shadows.quality,!1,!0),this.setShadowDistance(i.context.shadows.distance,!1,!0)),this.setPointLightAmount(i.context.pointLightAmount,!1,!0)):e.showError("Missing required settings.graphics.context from the setting definition object!"),this.setLODLevel(i.levelOfDetail.maxLevel,!1),this._limitSettingByScreenSize(i.levelOfDetail,this._lodLevel,this.getMaxLoadedLOD.bind(this),this.setLODLevel.bind(this),"level"),this.setParticleAmount(i.particleAmount.amount,!1),this._limitSettingByScreenSize(i.particleAmount,this._particleAmount,this.getParticleCountFactor.bind(this),this.setParticleAmount.bind(this),"amount"),i.particleAmount.autoDecreaseIfInstancingNotAvailable===!0&&(r.isInstancingAvailable()||this._particleAmount.decrease()),this.setDustParticleAmount(i.dustParticleAmount.amount,!1),this._limitSettingByScreenSize(i.dustParticleAmount,this._dustParticleAmount,this.getDustParticleCountFactor.bind(this),this.setDustParticleAmount.bind(this),"amount"),i.dustParticleAmount.autoDecreaseIfInstancingNotAvailable===!0&&(r.isInstancingAvailable()||this._dustParticleAmount.decrease()),this._setFallbackShaderComplexity(!0)},GraphicsSettingsContext.prototype.loadFromLocalStorage=function(){var i,n,o=function(r,o,s,a){void 0!==localStorage[r]&&(n={silentFallback:e.hasVersionChanged(),defaultValue:s},i=t.getValueOfTypeFromLocalStorage(o,r,n),(!n.error||e.hasVersionChanged())&&a(i,!!n.error&&n.error!==t.Errors.INVALID_ENUM_OBJECT_ERROR))};o(L,"boolean",this.getAntialiasing(),this.setAntialiasing.bind(this)),o(D,{baseType:"enum",values:r.TextureFiltering},this.getFiltering(),this.setFiltering.bind(this)),o(w,{baseType:"enum",values:t.getEnumObjectForArray(this.getTextureQualities())},this.getTextureQuality(),this.setTextureQuality.bind(this)),o(V,{baseType:"enum",values:t.getEnumObjectForArray(this.getCubemapQualities())},this.getCubemapQuality(),this.setCubemapQuality.bind(this)),o(F,{baseType:"enum",values:t.getEnumObjectForArray(this.getLODLevels())},this.getLODLevel(),this.setLODLevel.bind(this)),o(B,{baseType:"enum",values:t.getEnumObjectForArray(this.getShaderComplexities())},this.getShaderComplexity(),this.setShaderComplexity.bind(this)),o(U,"boolean",this.isShadowMappingEnabled(),this.setShadowMapping.bind(this)),o(j,{baseType:"enum",values:t.getEnumObjectForArray(this.getShadowMapQualities())},this.getShadowMapQuality(),this.setShadowMapQuality.bind(this)),this.canEnableShadowMapping()&&o(G,{baseType:"enum",values:t.getEnumObjectForArray(this.getShadowDistances())},this.getShadowDistance(),this.setShadowDistance.bind(this)),o(k,{baseType:"enum",values:t.getEnumObjectForArray(this.getPointLightAmounts())},this.getPointLightAmount(),this.setPointLightAmount.bind(this)),o(H,{baseType:"enum",values:t.getEnumObjectForArray(this.getParticleAmounts())},this.getParticleAmount(),this.setParticleAmount.bind(this)),o(W,{baseType:"enum",values:t.getEnumObjectForArray(this.getDustParticleAmounts())},this.getDustParticleAmount(),this.setDustParticleAmount.bind(this)),this.setToReady()},GraphicsSettingsContext.prototype.restoreDefaults=function(){this.loadSettingsFromJSON(this._dataJSON,!0),localStorage.removeItem(L),localStorage.removeItem(D),localStorage.removeItem(w),localStorage.removeItem(V),localStorage.removeItem(F),localStorage.removeItem(B),localStorage.removeItem(U),localStorage.removeItem(j),localStorage.removeItem(G),localStorage.removeItem(k)},GraphicsSettingsContext.prototype.getAntialiasing=function(){return this._antialiasing},GraphicsSettingsContext.prototype.setAntialiasing=function(t,i){return void 0===i&&(i=!0),r.isAntialiasingAvailable()?this._antialiasing=t:(this._antialiasing=!1,t&&e.log("Attempted to enable antialiasing, but it is not supported and so will be disabled.",1)),i&&(localStorage[L]=t.toString()),this._antialiasing===t},GraphicsSettingsContext.prototype.getFiltering=function(){return this._filtering},GraphicsSettingsContext.prototype.setFiltering=function(i,n){void 0===n&&(n=!0),i=t.getEnumValue(r.TextureFiltering,i,{name:"texture filtering",defaultValue:this._filtering}),this._filtering=i,r.isAnisotropicFilteringAvailable()||i!==r.TextureFiltering.ANISOTROPIC||(this._filtering=P,e.log("Attempted to set texture filtering to anisotropic, but it is not supported and so a fallback filtering will be applied instead.",1)),n&&(localStorage[D]=i.toString())},GraphicsSettingsContext.prototype.getTextureQualities=function(){return this._textureQuality.getNameList()},GraphicsSettingsContext.prototype.getTextureQualityPreferenceList=function(){return this._textureQuality.getPreferenceNameList()},GraphicsSettingsContext.prototype.getTextureQuality=function(){return this._textureQuality.getCurrentName()},GraphicsSettingsContext.prototype.setTextureQuality=function(t,e,i){void 0===e&&(e=!0),this._textureQuality.setCurrent(t,i)&&e&&(localStorage[w]=t)},GraphicsSettingsContext.prototype.getCubemapMaxResolution=function(){return this._cubemapQuality.getCurrentValue()},GraphicsSettingsContext.prototype.getCubemapQualities=function(){return this._cubemapQuality.getNameList()},GraphicsSettingsContext.prototype.getCubemapQualityPreferenceList=function(){return this._cubemapQuality.getPreferenceNameList()},GraphicsSettingsContext.prototype.getCubemapQuality=function(){return this._cubemapQuality.getCurrentName()},GraphicsSettingsContext.prototype.setCubemapQuality=function(t,e,i){void 0===e&&(e=!0),this._cubemapQuality.setCurrent(t,i)&&e&&(localStorage[V]=t)},GraphicsSettingsContext.prototype.getMaxLoadedLOD=function(){return this._maxLoadedLOD},GraphicsSettingsContext.prototype.getLODLevels=function(){return this._lodLevel.getNameList()},GraphicsSettingsContext.prototype.getLODLevel=function(){return this._lodLevel.getCurrentName()},GraphicsSettingsContext.prototype.getLOD=function(t){return this._lodLevel.getValueForName(t)},GraphicsSettingsContext.prototype.setLODLevel=function(t,e){void 0===e&&(e=!0),this._lodLevel.setCurrent(t)&&(this._maxLoadedLOD=this._lodLevel.getCurrentValue(),this._lodContext.maxEnabledLOD=this._lodLevel.getCurrentValue(),e&&(localStorage[F]=t))},GraphicsSettingsContext.prototype.getLODContext=function(){return this._lodContext},GraphicsSettingsContext.prototype.getShaderComplexity=function(){return this._shaderComplexity},GraphicsSettingsContext.prototype._limitShaderFeatures=function(){var t=this.isShadowMappingEnabled(),i=this.getNumShadowMapRanges(),r=this.getMaxPointLights();for(e.log_DEBUG("Checking requirements for current shader complexity...");!this._shaderRequirementsAreSatisfied();)if(this.isShadowMappingEnabled())this._shadowDistances.decrease()||this.setShadowMapping(!1,!1,!0);else if(!this._pointLightAmount.decrease())return void e.showError("Cannot satisfy shader requirements for current complexity!");this.isShadowMappingEnabled()!==t?e.log("Disabled shadow mapping to satisfy requirements of current shader complexity.",1):this.getNumShadowMapRanges()!==i&&e.log("Changed number of shadow map ranges from "+i+" to "+this.getNumShadowMapRanges()+" to satisfy requirements of current shader complexity.",1),this.getMaxPointLights()!==r&&e.log("Changed number of maximum point lights from "+r+" to "+this.getMaxPointLights()+" to satisfy requirements of current shader complexity.",1)},GraphicsSettingsContext.prototype._disableShaderFeatures=function(){this.isShadowMappingEnabled()&&this.setShadowMapping(!1,!1,!0),this._pointLightAmount.setLowest()},GraphicsSettingsContext.prototype.setShaderComplexity=function(t,i,r){var n=this.getShaderComplexities();void 0===i&&(i=!0),n.indexOf(t)>=0?(this._shaderComplexity!==t&&(this._shaderComplexity=t,this._limitShaderFeatures()),i&&(localStorage[B]=t)):r?(this._shaderComplexity=n[n.length-1],e.log("Attempted to set shader complexity to '"+t+"', which is not supported, and thus '"+this._shaderComplexity+"' has been selected instead.",1)):e.showError("Attempting to set shader complexity to '"+t+"', which is not one of the available options ("+this.getShaderComplexities().join(", ")+").",e.ErrorSeverity.MINOR,"The shader complexity will stay '"+this.getShaderComplexity()+"'."),this._luminosityTextureAreAvailable=this._getShaderComplexityDescriptor()[b.LUMINOSITY_TEXTURES_AVAILABLE.name]},GraphicsSettingsContext.prototype.getShaderComplexities=function(){return this.getShaderConfig(R.COMPLEXITIES).map(function(t){return t[b.NAME.name]})},GraphicsSettingsContext.prototype.getShadowMappingShaderName=function(){return this.getShaderConfig(R.SHADOW_MAPPING_SHADER_NAME)},GraphicsSettingsContext.prototype.isShadowMappingEnabled=function(){return this._shadowMappingEnabled},GraphicsSettingsContext.prototype.setShadowMapping=function(t,i,r){return void 0===i&&(i=!0),r||!t||this.canEnableShadowMapping()?this._shadowMappingEnabled!==t&&(this._shadowMappingEnabled=t,!r&&t&&this._limitShaderFeatures()):(this._shadowMappingEnabled=!1,e.log("Attempted to enable shadow mapping, but it is not supported (at the current shader complexity level) and so will be disabled.",1)),i&&(localStorage[U]=t.toString()),this._shadowMappingEnabled===t},GraphicsSettingsContext.prototype.getShadowMapQualities=function(){return this._shadowMapQuality.getNameList()},GraphicsSettingsContext.prototype.getShadowMapQuality=function(){return this._shadowMapQuality.getCurrentName()},GraphicsSettingsContext.prototype.getShadowMapTextureSize=function(){return this._shadowMapQuality.getCurrentValue()},GraphicsSettingsContext.prototype.setShadowMapQuality=function(t,e,i){void 0===e&&(e=!0),this._shadowMapQuality.setCurrent(t,i)&&e&&(localStorage[j]=t)},GraphicsSettingsContext.prototype.getShadowRanges=function(){var t,e=[],i=this.getNumShadowMapRanges();for(t=0;i>t;t++)e.push(this._shadowRanges[t]);return e},GraphicsSettingsContext.prototype.getShadowDistances=function(){return this._shadowDistances.getFilteredNameList(function(t){return this._shaderRequirementsAreSatisfied({numShadowRanges:t})}.bind(this))},GraphicsSettingsContext.prototype.getShadowDistance=function(){return this._shadowDistances.getCurrentName()},GraphicsSettingsContext.prototype.getNumShadowMapRanges=function(){return this._shadowMappingEnabled?this._shadowDistances.getCurrentValue():0},GraphicsSettingsContext.prototype.setShadowDistance=function(t,e,i){void 0===e&&(e=!0),this._shadowDistances.setCurrent(t,i)&&e&&(localStorage[G]=t)},GraphicsSettingsContext.prototype.getShadowDepthRatio=function(){return this._shadowDepthRatio},GraphicsSettingsContext.prototype._getShaderComplexityDescriptor=function(t){return void 0===t?this.getShaderConfig(R.COMPLEXITIES).find(function(t){return t[b.NAME.name]===this.getShaderComplexity()}.bind(this),this):this.getShaderConfig(R.COMPLEXITIES)[t]},GraphicsSettingsContext.prototype.getMaxDirLights=function(){return this._getShaderComplexityDescriptor()[b.MAX_DIR_LIGHTS.name]},GraphicsSettingsContext.prototype.getPointLightAmounts=function(){return this._pointLightAmount.getFilteredNameList(function(t){return this._shaderRequirementsAreSatisfied({numPointLights:t})}.bind(this))},GraphicsSettingsContext.prototype.getPointLightAmount=function(){return this._pointLightAmount.getCurrentName()},GraphicsSettingsContext.prototype.getMaxPointLights=function(){return this._pointLightAmount.getCurrentValue()},GraphicsSettingsContext.prototype.setPointLightAmount=function(t,e,i){void 0===e&&(e=!0),this._pointLightAmount.setCurrent(t,i)&&e&&(localStorage[k]=t)},GraphicsSettingsContext.prototype.getMaxSpotLights=function(){return this._getShaderComplexityDescriptor()[b.MAX_SPOT_LIGHTS.name]},GraphicsSettingsContext.prototype.getParticleAmounts=function(){return this._particleAmount.getNameList()},GraphicsSettingsContext.prototype.getParticleAmount=function(){return this._particleAmount.getCurrentName()},GraphicsSettingsContext.prototype.getParticleCountFactor=function(){return this._particleAmount.getCurrentValue()},GraphicsSettingsContext.prototype.setParticleAmount=function(t,e,i){void 0===e&&(e=!0),this._particleAmount.setCurrent(t,i)&&e&&(localStorage[H]=t)},GraphicsSettingsContext.prototype.getDustParticleAmounts=function(){return this._dustParticleAmount.getNameList()},GraphicsSettingsContext.prototype.getDustParticleAmount=function(){return this._dustParticleAmount.getCurrentName()},GraphicsSettingsContext.prototype.getDustParticleCountFactor=function(){return this._dustParticleAmount.getCurrentValue()},GraphicsSettingsContext.prototype.setDustParticleAmount=function(t,e,i){void 0===e&&(e=!0),this._dustParticleAmount.setCurrent(t,i)&&e&&(localStorage[W]=t)},GraphicsSettingsContext.prototype.getShaderConfig=function(t){return this._shaderConfig[t.name]},GraphicsSettingsContext.prototype.setShaderConfig=function(t,e){this._shaderConfig[t.name]=e},GraphicsSettingsContext.prototype.getNumShadowMapSamples=function(){return this._getShaderComplexityDescriptor()[b.NUM_SHADOW_MAP_SAMPLES.name]},GraphicsSettingsContext.prototype.isShadowMappingAvailable=function(){return this._getShaderComplexityDescriptor()[b.SHADOW_MAPPING_AVAILABLE.name]},GraphicsSettingsContext.prototype.areLuminosityTexturesAvailable=function(){return this._luminosityTextureAreAvailable},GraphicsSettingsContext.prototype.isRevealAvailable=function(){return this._getShaderComplexityDescriptor()[b.REVEAL_AVAILABLE.name]},GraphicsSettingsContext.prototype.areDynamicLightsAvailable=function(){return this._getShaderComplexityDescriptor()[b.DYNAMIC_LIGHTS_AVAILABLE.name]},GraphicsSettingsContext.prototype.canEnableShadowMapping=function(){return this.isShadowMappingAvailable()&&this._shaderRequirementsAreSatisfied({numShadowRanges:this._shadowDistances.getFirstValue()})},GraphicsSettingsContext.prototype.getTexture=function(t,e){return e=e||{},e.qualityPreferenceList=this.getTextureQualityPreferenceList(),n.getTexture(t,e)},GraphicsSettingsContext.prototype.getCubemap=function(t,e){return e=e||{},e.qualityPreferenceList=this.getCubemapQualityPreferenceList(),n.getCubemap(t,e)},GraphicsSettingsContext.prototype.getShader=function(t){return t=n.getVariantShader(t,this.getShaderComplexity()).getName(),this._shadowMappingEnabled||(t=n.getVariantShader(t,q).getName()),0===this._pointLightAmount.getCurrentValue()&&(t=n.getVariantShader(t,z).getName()),n.getShader(t)},GraphicsSettingsContext.prototype.getManagedShader=function(t){var i,n={};return n[this.getShaderConfig(R.MAX_DIR_LIGHTS_DEFINE_NAME)]=this.getMaxDirLights(),n[this.getShaderConfig(R.MAX_POINT_LIGHTS_DEFINE_NAME)]=this.getMaxPointLights(),n[this.getShaderConfig(R.MAX_SPOT_LIGHTS_DEFINE_NAME)]=this.getMaxSpotLights(),n[this.getShaderConfig(R.MAX_SHADOW_MAP_RANGES_DEFINE_NAME)]=this.getNumShadowMapRanges(),n[this.getShaderConfig(R.MAX_SHADOW_MAPS_DEFINE_NAME)]=this.getMaxDirLights()*this.getNumShadowMapRanges(),n[this.getShaderConfig(R.NUM_SHADOW_MAP_SAMPLES_DEFINE_NAME)]=this.getNumShadowMapSamples(),n[this.getShaderConfig(R.DUST_LENGTH_DIVISOR_DEFINE_NAME)]=this.getShaderConfig(R.DUST_LENGTH_DIVISOR),n[this.getShaderConfig(R.MAX_LUMINOSITY_FACTORS_DEFINE_NAME)]=this.getShaderConfig(R.MAX_LUMINOSITY_FACTORS),n[this.getShaderConfig(R.MAX_GROUP_TRANSFORMS_DEFINE_NAME)]=this.getShaderConfig(R.MAX_GROUP_TRANSFORMS),n[this.getShaderConfig(R.DEPTH_TEXTURES_DEFINE_NAME)]=r.areDepthTexturesAvailable()?"1":"0",n[this.getShaderConfig(R.MAX_SHININESS_DEFINE_NAME)]=this.getShaderConfig(R.MAX_SHININESS),i=this.getShader(t).getManagedShader(n,!0),i.isAllowedByRequirements(this._getShaderRequirements())||e.showError("Shader '"+t+"' has too high requirements!"),i},GraphicsSettingsContext.prototype.getModel=function(t){return n.getModel(t,{maxLOD:this.getMaxLoadedLOD()})},a=new GraphicsSettingsContext,{SHADER_VARIANT_WITHOUT_SHADOWS_NAME:q,SHADER_VARIANT_WITHOUT_DYNAMIC_LIGHTS_NAME:z,loadConfigurationFromJSON:a.loadConfigurationFromJSON.bind(a),loadSettingsFromJSON:a.loadSettingsFromJSON.bind(a),loadSettingsFromLocalStorage:a.loadFromLocalStorage.bind(a),restoreDefaults:a.restoreDefaults.bind(a),getAntialiasing:a.getAntialiasing.bind(a),setAntialiasing:a.setAntialiasing.bind(a),getFiltering:a.getFiltering.bind(a),setFiltering:a.setFiltering.bind(a),getTextureQualities:a.getTextureQualities.bind(a),getTextureQuality:a.getTextureQuality.bind(a),setTextureQuality:a.setTextureQuality.bind(a),getTextureQualityPreferenceList:a.getTextureQualityPreferenceList.bind(a),getCubemapQualities:a.getCubemapQualities.bind(a),getCubemapQuality:a.getCubemapQuality.bind(a),setCubemapQuality:a.setCubemapQuality.bind(a),getCubemapQualityPreferenceList:a.getCubemapQualityPreferenceList.bind(a),getLODLevels:a.getLODLevels.bind(a),getLODLevel:a.getLODLevel.bind(a),getLOD:a.getLOD.bind(a),setLODLevel:a.setLODLevel.bind(a),getMaxLoadedLOD:a.getMaxLoadedLOD.bind(a),getLODContext:a.getLODContext.bind(a),getShaderComplexity:a.getShaderComplexity.bind(a),setShaderComplexity:a.setShaderComplexity.bind(a),getShaderComplexities:a.getShaderComplexities.bind(a),getMaxLuminosityFactors:a.getShaderConfig.bind(a,R.MAX_LUMINOSITY_FACTORS),getMaxGroupTransforms:a.getShaderConfig.bind(a,R.MAX_GROUP_TRANSFORMS),getShadowMappingShaderName:a.getShadowMappingShaderName.bind(a),isShadowMappingEnabled:a.isShadowMappingEnabled.bind(a),setShadowMapping:a.setShadowMapping.bind(a),getShadowMapQualities:a.getShadowMapQualities.bind(a),getShadowMapQuality:a.getShadowMapQuality.bind(a),getShadowMapTextureSize:a.getShadowMapTextureSize.bind(a),setShadowMapQuality:a.setShadowMapQuality.bind(a),getShadowDistances:a.getShadowDistances.bind(a),getShadowDistance:a.getShadowDistance.bind(a),setShadowDistance:a.setShadowDistance.bind(a),getShadowDepthRatio:a.getShadowDepthRatio.bind(a),getNumShadowMapSamples:a.getNumShadowMapSamples.bind(a),getMaxDirLights:a.getMaxDirLights.bind(a),getPointLightAmounts:a.getPointLightAmounts.bind(a),getPointLightAmount:a.getPointLightAmount.bind(a),getMaxPointLights:a.getMaxPointLights.bind(a),setPointLightAmount:a.setPointLightAmount.bind(a),getParticleAmounts:a.getParticleAmounts.bind(a),getParticleAmount:a.getParticleAmount.bind(a),getParticleCountFactor:a.getParticleCountFactor.bind(a),setParticleAmount:a.setParticleAmount.bind(a),getDustParticleAmounts:a.getDustParticleAmounts.bind(a),getDustParticleAmount:a.getDustParticleAmount.bind(a),getDustParticleCountFactor:a.getDustParticleCountFactor.bind(a),setDustParticleAmount:a.setDustParticleAmount.bind(a),getMaxSpotLights:a.getMaxSpotLights.bind(a),isShadowMappingAvailable:a.isShadowMappingAvailable.bind(a),areLuminosityTexturesAvailable:a.areLuminosityTexturesAvailable.bind(a),isRevealAvailable:a.isRevealAvailable.bind(a),areDynamicLightsAvailable:a.areDynamicLightsAvailable.bind(a),canEnableShadowMapping:a.canEnableShadowMapping.bind(a),getTexture:a.getTexture.bind(a),getCubemap:a.getCubemap.bind(a),getShader:a.getShader.bind(a),getManagedShader:a.getManagedShader.bind(a),getModel:a.getModel.bind(a),shouldUseShadowMapping:shouldUseShadowMapping,getShadowMappingShader:getShadowMappingShader,getShadowMappingSettings:getShadowMappingSettings,executeWhenReady:a.executeWhenReady.bind(a)}}),define("modules/physics",["utils/utils","utils/vectors","utils/matrices","modules/containers"],function(t,e,i,r){"use strict";function Force(t,i,r,n){this._id=t,this._strength=i,this._direction=e.normal3(r),this._duration=n,this._continuous=void 0===n,this.next=null,this.previous=null,this.list=null}function Torque(t,i,r,n){this._id=t,this._strength=i,this._axis=e.normal3(r),this._duration=n,this._continuous=void 0===n,this.next=null,this.previous=null,this.list=null}function Body(t,e,r){this._positionMatrix=t,this._positionVector=i.translationVector3(t),this._orientationMatrix=e,this._rotated=!i.equal4(e,i.IDENTITY4),this._modelMatrixInverse=null,this._halfWidth=.5*r[0],this._halfHeight=.5*r[1],this._halfDepth=.5*r[2]}function PhysicalObject(t,e,n,o,s,a,l){this._mass=0,this._positionMatrix=i.identity4(),this._orientationMatrix=i.identity4(),this._scalingMatrix=i.identity4(),this._rotationMatrixInverse=i.identity4(),this._rotationMatrixInverseValid=!1,this._scalingMatrixInverse=i.identity4(),this._scalingMatrixInverseValid=!1,this._modelMatrixInverse=i.identity4(),this._modelMatrixInverseValid=!1,this._velocityMatrix=i.identity4(),this._angularVelocityMatrix=i.identity4(),this._forces=new r.DirectDoubleLinkedList,this._torques=new r.DirectDoubleLinkedList,this._bodies=null,this._bodySize=-1,this._fixedOrientation=!1,e&&this.init(t,e,n,o,s,a,l)}var n=5,o=1e-4,s=1e-5,a=.1;return Force.prototype.getID=function(){return this._id},Force.prototype.renew=function(t,i,r){this._strength=t,this._direction=e.normal3(i),this._duration=r,this._continuous=void 0===r},Force.prototype.exert=function(t){if(this._continuous)return this._continuous=!1,this._duration=0,t;if(this._duration>=a){var e=Math.min(this._duration,t);return this._duration-=t,e}return 0},Force.prototype.getAccelerationVector=function(t){return e.scaled3(this._direction,this._strength/t)},Force.prototype.canBeReused=function(){return this._duration<a&&!this._continuous},Torque.prototype.getID=function(){return this._id},Torque.prototype.renew=function(t,e,i){this._strength=t,this._axis=e,this._duration=i,this._continuous=void 0===i},Torque.prototype.exert=function(t){if(this._continuous)return this._continuous=!1,this._duration=0,t;if(this._duration>=a){var e=Math.min(this._duration,t);return this._duration-=t,e}return 0},Torque.prototype.getAngularAccelerationMatrixOverTime=function(t,e){return i.rotation4Aux(this._axis,this._strength/t*e)},Torque.prototype.canBeReused=function(){return this._duration<a&&!this._continuous},Body.prototype.getPositionMatrix=function(){return this._positionMatrix},Body.prototype.getOrientationMatrix=function(){return this._orientationMatrix},Body.prototype.getWidth=function(){return 2*this._halfWidth},Body.prototype.getHeight=function(){return 2*this._halfHeight},Body.prototype.getDepth=function(){return 2*this._halfDepth},Body.prototype._modelTransform=function(t){return this._rotated?e.sum3(e.prodVec3Mat4Aux(t,this._orientationMatrix),this._positionVector).concat(1):e.sum3(t,this._positionVector).concat(1)},Body.prototype.getModelMatrixInverse=function(){return this._modelMatrixInverse=this._modelMatrixInverse||i.prodTranslationRotation4(i.inverseOfTranslation4Aux(this._positionMatrix),i.inverseOfRotation4Aux(this._orientationMatrix)),this._modelMatrixInverse},Body.prototype.getHalfDimensions=function(){return[this._halfWidth,this._halfHeight,this._halfDepth]},Body.prototype.checkHit=function(r,n,o,s){var a,l,h,u=this._halfWidth+s,c=this._halfHeight+s,p=this._halfDepth+s;if(this._rotated?(r=e.prodVec4Mat4Aux(r,this.getModelMatrixInverse()),n=e.prodVec3Mat3Aux(n,i.matrix3from4Aux(i.inverseOfRotation4Aux(this._orientationMatrix)))):r=e.diff3Aux(r,this._positionVector),0!==n[0])if(n[0]>0){if(a=(-u-r[0])/n[0],l=r[1]+n[1]*a,h=r[2]+n[2]*a,t.pointInRect(l,h,-c,-p,c,p))return 0>=a&&a>=-o?this._modelTransform([-u,l,h,1]):null}else if(a=(u-r[0])/n[0],l=r[1]+n[1]*a,h=r[2]+n[2]*a,t.pointInRect(l,h,-c,-p,c,p))return 0>=a&&a>=-o?this._modelTransform([u,l,h,1]):null;if(0!==n[1])if(n[1]>0){if(a=(-c-r[1])/n[1],l=r[0]+n[0]*a,h=r[2]+n[2]*a,t.pointInRect(l,h,-u,-p,u,p))return 0>=a&&a>=-o?this._modelTransform([l,-c,h,1]):null}else if(a=(c-r[1])/n[1],l=r[0]+n[0]*a,h=r[2]+n[2]*a,t.pointInRect(l,h,-u,-p,u,p))return 0>=a&&a>=-o?this._modelTransform([l,c,h,1]):null;if(0!==n[2])if(n[2]>0){if(a=(-p-r[2])/n[2],l=r[0]+n[0]*a,h=r[1]+n[1]*a,t.pointInRect(l,h,-u,-c,u,c))return 0>=a&&a>=-o?this._modelTransform([l,h,-p,1]):null}else if(a=(p-r[2])/n[2],l=r[0]+n[0]*a,h=r[1]+n[1]*a,t.pointInRect(l,h,-u,-c,u,c))return 0>=a&&a>=-o?this._modelTransform([l,h,p,1]):null;return null},PhysicalObject.prototype.init=function(t,e,r,n,o,s,a){this._mass=t,i.setMatrix4(this._positionMatrix,e),i.setMatrix4(this._orientationMatrix,r),i.setMatrix4(this._scalingMatrix,n),this._rotationMatrixInverseValid=!1,this._scalingMatrixInverseValid=!1,this._modelMatrixInverseValid=!1,i.setMatrix4(this._velocityMatrix,o),i.setIdentity4(this._angularVelocityMatrix),this._forces.clear(),this._torques.clear(),this._bodies=s||[],this._bodySize=-1,this._calculateBodySize(),this._fixedOrientation=!!a},PhysicalObject.prototype.getMass=function(){return this._mass},PhysicalObject.prototype.getPositionMatrix=function(){return this._positionMatrix},PhysicalObject.prototype.getOrientationMatrix=function(){return this._orientationMatrix},PhysicalObject.prototype.getScalingMatrix=function(){return this._scalingMatrix},PhysicalObject.prototype.getBodySize=function(){return this._bodySize},PhysicalObject.prototype.getSize=function(){return this._bodySize*this._scalingMatrix[0]},PhysicalObject.prototype.getVelocityMatrix=function(){return this._velocityMatrix},PhysicalObject.prototype.setVelocityMatrix=function(t){this._velocityMatrix=t},PhysicalObject.prototype.getAngularVelocityMatrix=function(){return this._angularVelocityMatrix},PhysicalObject.prototype.addForce=function(t){this._forces.add(t)},PhysicalObject.prototype.addTorque=function(t){this._torques.add(t)},PhysicalObject.prototype.setPositionMatrix=function(t){t&&(this._positionMatrix=t),this._modelMatrixInverseValid=!1},PhysicalObject.prototype.setOrientationMatrix=function(t){t&&(this._orientationMatrix=t),this._rotationMatrixInverseValid=!1,this._modelMatrixInverseValid=!1},PhysicalObject.prototype.setScalingMatrix=function(t){this._scalingMatrix=t,this._scalingMatrixInverseValid=!1,this._modelMatrixInverseValid=!1},PhysicalObject.prototype.getRotationMatrixInverse=function(){return this._rotationMatrixInverseValid||(i.setInverseOfRotation4(this._rotationMatrixInverse,this._orientationMatrix),this._rotationMatrixInverseValid=!0),this._rotationMatrixInverse},PhysicalObject.prototype.getScalingMatrixInverse=function(){return this._scalingMatrixInverseValid||(i.setInverseOfScaling4(this._scalingMatrixInverse,this._scalingMatrix),this._scalingMatrixInverseValid=!0),this._scalingMatrixInverse},PhysicalObject.prototype.getModelMatrixInverse=function(){return this._modelMatrixInverseValid||(i.setProdTranslationRotation4(this._modelMatrixInverse,i.inverseOfTranslation4Aux(this._positionMatrix),i.prod3x3SubOf4Aux(this.getRotationMatrixInverse(),this.getScalingMatrixInverse())),this._modelMatrixInverseValid=!0),this._modelMatrixInverse},PhysicalObject.prototype.moveByVector=function(t){i.translateByVector(this._positionMatrix,t),this._modelMatrixInverseValid=!1},PhysicalObject.prototype.addOrRenewForce=function(t,e,i,r){var n,o=!1;for(n=this._forces.getFirst();n;n=n.next)if(n.getID()===t){n.renew(e,i,r),o=!0;break}o===!1&&this.addForce(new Force(t,e,i,r))},PhysicalObject.prototype.addOrRenewTorque=function(t,e,i,r){var n,o=!1;for(n=this._torques.getFirst();n;n=n.next)if(n.getID()===t){n.renew(e,i,r),o=!0;break}o===!1&&this.addTorque(new Torque(t,e,i,r))},PhysicalObject.prototype.addForceAndTorque=function(i,r,n,o){var s=e.normal3(i),a=e.scaled3(s,e.dot3(r,s)),l=e.diff3Aux(r,a);this.addForce(new Force(t.EMPTY_STRING,n,r,o)),this.addTorque(new Torque(t.EMPTY_STRING,n*e.length3(l)*e.length3(i),e.normal3(e.cross3(l,s)),o))},PhysicalObject.prototype._calculateBodySize=function(){var t,r,n;for(this._bodySize=0,t=0;t<this._bodies.length;t++)r=i.translationVector3(this._bodies[t]._positionMatrix),n=e.prodVec3Mat3Aux(this._bodies[t].getHalfDimensions(),i.prod3x3SubOf43(this._orientationMatrix,this._bodies[t]._orientationMatrix)),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(r,n))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(r,[n[0],n[1],-n[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(r,[n[0],-n[1],n[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(r,[n[0],-n[1],-n[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(r,[-n[0],n[1],n[2]]))),
this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(r,[-n[0],n[1],-n[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(r,[-n[0],-n[1],n[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(r,[-n[0],-n[1],-n[2]])))},PhysicalObject.prototype.checkHit=function(t,r,n,o){var s,a,l,h,u=null;if(o=o||0,o/=this._scalingMatrix[0],s=e.prodVec4Mat4Aux(e.vector4From3Aux(t),this.getModelMatrixInverse()),a=e.diff3(r,i.translationVector3(this.getVelocityMatrix())),h=e.length3(a)*n*.001/this._scalingMatrix[0],Math.abs(s[0])-h<this._bodySize&&Math.abs(s[1])-h<this._bodySize&&Math.abs(s[2])-h<this._bodySize)for(e.mulVec3Mat3(a,i.matrix3from4Aux(this.getRotationMatrixInverse())),e.normalize3(a),l=0;null===u&&l<this._bodies.length;l++)u=this._bodies[l].checkHit(s,a,h,o);return u},PhysicalObject.prototype._correctMatrices=function(){i.correctOrthogonal4(this._orientationMatrix),this.setOrientationMatrix(),i.correctOrthogonal4(this._angularVelocityMatrix)},PhysicalObject.prototype.simulate=function(t){var r,a,l,h,u,c,p,d,_;if(t>0){if(i.translateByVector(this._positionMatrix,e.scaled3(i.translationVector3(this._velocityMatrix),.001*t)),this.setPositionMatrix(),this._forces.getLength()>0){for(h=i.identity4Aux(),c=this._forces.getFirst();c;c=p)p=c.next,c.canBeReused()?this._forces.remove(c):(l=.001*c.exert(t),l>0&&(a=c.getAccelerationVector(this._mass),i.translateByVector(this._positionMatrix,e.scaled3(a,.5*l*l)),i.translateByVector(h,e.scaled3(a,l))));i.translateByMatrix(this._velocityMatrix,h)}if(i.straighten(this._velocityMatrix,o),!this._fixedOrientation){for(r=0;t>r+.5*n;r+=n)i.mul4(this._orientationMatrix,this._angularVelocityMatrix);if(this.setOrientationMatrix(),this._torques.getLength()>0){for(u=i.identity4Aux(),d=this._torques.getFirst();d;d=_)_=d.next,d.canBeReused()?this._torques.remove(d):(l=.001*d.exert(t),l>0&&(i.mul4(this._orientationMatrix,d.getAngularAccelerationMatrixOverTime(this._mass,.5*l*l)),i.mul4(u,d.getAngularAccelerationMatrixOverTime(this._mass,n*l*.001))));i.mul4(this._angularVelocityMatrix,u)}i.straighten(this._angularVelocityMatrix,s),this._correctMatrices()}}},{Body:Body,Force:Force,Torque:Torque,PhysicalObject:PhysicalObject,ANGULAR_VELOCITY_MATRIX_DURATION:n,ANGULAR_VELOCITY_MATRIX_DURATION_S:n/1e3,VELOCITY_MATRIX_ERROR_THRESHOLD:o,ANGULAR_VELOCITY_MATRIX_ERROR_THRESHOLD:s}}),define("armada/strings",["modules/strings"],function(t){"use strict";function startsWithVowel(t){var e=t[0].toLowerCase();return"a"===e||"e"===e||"u"===e||"i"===e||"o"===e||"á"===e||"é"===e||"ú"===e||"ü"===e||"ű"===e||"í"===e||"ó"===e||"ö"===e||"ő"===e}return t.GRAMMAR={DEFINITE_ARTICLE_BEFORE_VOWEL:{name:"grammar.definiteArticle.beforeVowel"},DEFINITE_ARTICLE_BEFORE_CONSONANT:{name:"grammar.definiteArticle.beforeConsonant"},AND:{name:"grammar.and"}},t.FIRST_RUN_NOTE={HEADER:{name:"firstRunNote.header"},MESSAGE:{name:"firstRunNote.message"},BUTTON:{name:"firstRunNote.button"}},t.SCREEN={BACK:{name:"screen.back"},CANCEL:{name:"screen.cancel"}},t.MAIN_MENU={NEW_GAME:{name:"mainMenu.newGame"},DATABASE:{name:"mainMenu.database"},SETTINGS:{name:"mainMenu.settings"},ABOUT:{name:"mainMenu.about"},QUIT:{name:"mainMenu.quit"}},t.MISSIONS={BACK:{name:"missions.backButton"},TITLE:{name:"missions.title"},DIFFICULTY:{name:"missions.difficulty"},LAUNCH_BUTTON:{name:"missions.launchButton"},DEMO_BUTTON:{name:"missions.demoButton"},NOT_COMPLETED:{name:"missions.notCompleted"},BEST_SCORE:{name:"missions.bestScore"},SANDBOX_COMPLETED:{name:"missions.sandboxCompleted"},NO_SELECTED_NAME:{name:"missions.noSelectedName"},NO_SELECTED_DESCRIPTION:{name:"missions.noSelectedDescription"},LOCATION:{name:"missions.location"},LOADING_DESCRIPTION:{name:"missions.loadingDescription"},NO_TRANSLATED_DESCRIPTION:{name:"missions.noTranslatedDescription"},NO_DESCRIPTION:{name:"missions.noDescription"},OBJECTIVES_TITLE:{name:"missions.missionObjectivesTitle"},SPACECRAFT_TITLE:{name:"missions.playerSpacecraftTitle"},SPACECRAFT_DATA:{name:"missions.playerSpacecraftData"},OBJECTIVE_SUBJECTS_SQUAD:{name:"missions.objectiveSubjects.squad"},OBJECTIVE_SUBJECTS_SQUADS:{name:"missions.objectiveSubjects.squads"},OBJECTIVE_SUBJECTS_TEAM:{name:"missions.objectiveSubjects.team"},OBJECTIVE_SUBJECTS_TEAMS:{name:"missions.objectiveSubjects.teams"},OBJECTIVE_WIN_PREFIX:{name:"missions.winObjective.",optional:!0},OBJECTIVE_LOSE_PREFIX:{name:"missions.loseObjective.",optional:!0}},t.OBJECTIVE={DESTROY_ALL_SUFFIX:{name:"destroyAll",optional:!0},DESTROY_SUFFIX:{name:"destroy",optional:!0},COUNT_BELOW_SUFFIX:{name:"countBelow",optional:!0}},t.LOCATION={UNKNOWN:{name:"location.unknown"},SYSTEM:{name:"location.system"}},t.SETTINGS={GENERAL:{name:"settings.general"},GRAPHICS:{name:"settings.graphics"},AUDIO:{name:"settings.audio"},CONTROLS:{name:"settings.controls"},DEFAULTS:{name:"settings.defaults"}},t.INGAME_MENU={TITLE:{name:"ingameMenu.title"},RESUME:{name:"ingameMenu.resume"},RESTART:{name:"ingameMenu.restart"},RESTART_HEADER:{name:"ingameMenu.restartDialog.header"},RESTART_MESSAGE:{name:"ingameMenu.restartDialog.message"},RESTART_RESTART:{name:"ingameMenu.restartDialog.restartButton"},QUIT:{name:"ingameMenu.quit"},QUIT_HEADER:{name:"ingameMenu.quitDialog.header"},QUIT_MESSAGE:{name:"ingameMenu.quitDialog.message"},QUIT_TO_MISSIONS:{name:"ingameMenu.quitDialog.quitToMissionsButton"},QUIT_TO_MAIN_MENU:{name:"ingameMenu.quitDialog.quitToMainMenuButton"}},t.INFO_BOX={HEADER:{name:"infoBox.header"},OK_BUTTON:{name:"infoBox.okButton"}},t.LOADING={HEADER:{name:"loading.header"},RESOURCES_START:{name:"loading.resourcesStart"},RESOURCE_READY:{name:"loading.resourceReady"},INIT_WEBGL:{name:"loading.initWebGL"},READY:{name:"loading.ready"}},t.SPACECRAFT_STATS={ARMOR:{name:"spacecraftStats.armor"},ARMOR_RATING:{name:"spacecraftStats.armorRating"}},t.MISSION={PREFIX:{name:"mission.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0},MESSAGES_SUFFIX:{name:".messages.",optional:!0}},t.TEAM={PREFIX:{name:"team.",optional:!0}},t.SQUAD={PREFIX:{name:"squad.",optional:!0}},t.BATTLE={DEVELOPMENT_VERSION_NOTICE:{name:"battle.developmentVersionNotice"},SPECTATOR_MODE:{name:"battle.spectatorMode"},SCORE:{name:"battle.score"},HUD_FIREPOWER:{name:"battle.hud.firepower"},HUD_DISTANCE:{name:"battle.hud.distance"},HUD_VELOCITY:{name:"battle.hud.velocity"},HUD_SPACECRAFT_NAME_UNKNOWN:{name:"battle.hud.spacecraftNameUnknown"},HUD_TEAM_UNKNOWN:{name:"battle.hud.teamUnknown"},HUD_WINGMEN_HEADER:{name:"battle.hud.wingmenHeader"},HUD_FLIGHT_MODE:{name:"battle.hud.flightMode"},HUD_OBJECTIVES:{name:"battle.hud.objectives"},HUD_ESCORTED_SHIPS_HEADER:{name:"battle.hud.escortedShipsHeader"},OBJECTIVE_SUBJECTS_SPACECRAFTS:{name:"battle.objectiveSubjects.spacecrafts"},OBJECTIVE_SUBJECTS_SQUADS:{name:"battle.objectiveSubjects.squads"},OBJECTIVE_SUBJECTS_TEAMS:{name:"battle.objectiveSubjects.teams"},OBJECTIVE_WIN_PREFIX:{name:"battle.winObjective.",optional:!0},OBJECTIVE_LOSE_PREFIX:{name:"battle.loseObjective.",optional:!0},LOADING_BOX_LOADING_MISSION:{name:"battle.loadingBox.loadingMission"},LOADING_BOX_ADDING_RANDOM_ELEMENTS:{name:"battle.loadingBox.addingRandomElements"},LOADING_BOX_BUILDING_SCENE:{name:"battle.loadingBox.buildingScene"},MESSAGE_READY:{name:"battle.message.ready"},MESSAGE_PAUSED:{name:"battle.message.paused"},MESSAGE_VICTORY:{name:"battle.message.victory"},MESSAGE_FAIL:{name:"battle.message.fail"},MESSAGE_DEFEAT_HEADER:{name:"battle.message.defeat.header"},MESSAGE_DEFEAT_MESSAGE:{name:"battle.message.defeat.message"},MESSAGE_DEFEAT_DEBRIEFING:{name:"battle.message.defeat.debriefingButton"},MESSAGE_DEFEAT_RESTART:{name:"battle.message.defeat.restartButton"},MESSAGE_DEFEAT_SPECTATE:{name:"battle.message.defeat.spectateButton"},MESSAGE_JUMP_ENGAGED:{name:"battle.message.jump.engaged"},MESSAGE_JUMP_PREPARING:{name:"battle.message.jump.preparing"},MESSAGE_NEW_HOSTILES:{name:"battle.message.newHostiles"}},t.PERFORMANCE_LEVEL={PREFIX:{name:"performanceLevel.",optional:!0}},t.DEBRIEFING={BACK:{name:"debriefing.backButton"},VICTORY_TITLE:{name:"debriefing.victoryTitle"},DEFEAT_TITLE:{name:"debriefing.defeatTitle"},GENERIC_TITLE:{name:"debriefing.genericTitle"},SCORE:{name:"debriefing.score"},NEW_RECORD:{name:"debriefing.newRecord"},DESCRIPTION_VICTORY:{name:"debriefing.description.victory"},DESCRIPTION_NEXT_PERFORMANCE:{name:"debriefing.description.nextPerformance"},DESCRIPTION_FAIL:{name:"debriefing.description.fail"},DESCRIPTION_DEFEAT:{name:"debriefing.description.defeat"},DESCRIPTION_LEFT_EARLY:{name:"debriefing.description.leftEarly"},DESCRIPTION_GENERIC:{name:"debriefing.description.generic"},STATISTICS_HEADER:{name:"debriefing.statisticsHeader"},TIME_LABEL_CELL:{name:"debriefing.timeLabelCell"},KILLS_LABEL_CELL:{name:"debriefing.killsLabelCell"},DAMAGE_LABEL_CELL:{name:"debriefing.damageLabelCell"},HIT_RATIO_LABEL_CELL:{name:"debriefing.hitRatioLabelCell"},HULL_INTEGRITY_LABEL_CELL:{name:"debriefing.hullIntegrityLabelCell"},TEAM_SURVIVAL_LABEL_CELL:{name:"debriefing.teamSurvivalLabelCell"},BASE_SCORE_LABEL_CELL:{name:"debriefing.baseScoreLabelCell"},HIT_RATIO_BONUS_LABEL_CELL:{name:"debriefing.hitRatioBonusLabelCell"},HULL_INTEGRITY_BONUS_LABEL_CELL:{name:"debriefing.hullIntegrityBonusLabelCell"},TEAM_SURVIVAL_BONUS_LABEL_CELL:{name:"debriefing.teamSurvivalBonusLabelCell"},SCORE_BREAKDOWN_HEADER:{name:"debriefing.scoreBreakdownHeader"},RESTART_BUTTON:{name:"debriefing.restartButton"}},t.DATABASE={BACK:{name:"database.backButton"},TITLE:{name:"database.title"},PREV_BUTTON:{name:"database.prevButton"},NEXT_BUTTON:{name:"database.nextButton"},LOADING_BOX_INITIALIZING:{name:"database.loadingBox.initializing"},LENGTH:{name:"database.length"},MASS:{name:"database.mass"},WEAPON_SLOTS:{name:"database.weaponSlots"},THRUSTERS:{name:"database.thrusters"},MISSING_SPACECRAFT_TYPE_DESCRIPTION:{name:"database.missingSpacecraftTypeDescription"},MISSING_SPACECRAFT_CLASS_DESCRIPTION:{name:"database.missingSpacecraftClassDescription"}},t.ABOUT={BACK:{name:"about.backButton"},TITLE:{name:"about.title"},VERSION_PARAGRAPH:{name:"about.versionParagraph"},ABOUT_GAME_PARAGRAPH:{name:"about.aboutGameParagraph"},ABOUT_GAME_DEV_PARAGRAPH:{name:"about.aboutGameDevParagraph"},LICENSE_NOTE:{name:"about.licenseNote"},CREDITS_HEADER:{name:"about.creditsHeader"},CREDITS_GAME_DESIGN:{name:"about.creditsGameDesign"},CREDITS_PROGRAMMING:{name:"about.creditsProgramming"},CREDITS_REQUIREJS_NOTE:{name:"about.creditsRequireJSNote"},CREDITS_FONTS:{name:"about.creditsFonts"},CREDITS_MODELS:{name:"about.credits3DModels"},CREDITS_TEXTURES:{name:"about.creditsTextures"},CREDITS_MUSIC:{name:"about.creditsMusic"},CREDITS_SFX:{name:"about.creditsSoundEffects"},CREDITS_FREESOUND_NOTE:{name:"about.creditsFreesoundNote"},CREDITS_OTHER_SOUNDS_NOTE:{name:"about.creditsOtherSoundsNote"},CREDITS_SOUND_LICENSE_NOTE:{name:"about.creditsSoundLicenseNote"},CREDITS_TESTING:{name:"about.creditsTesting"},USED_SOFTWARE_HEADER:{name:"about.usedSoftwareHeader"},USED_SOFTWARE_PARAGRAPH:{name:"about.usedSoftwareParagraph"},LICENSE_HEADER:{name:"about.licenseHeader"},LICENSE_PARAGRAPH:{name:"about.licenseParagraph"},REQUIRE_JS_LICENSE:{name:"about.requireJSLicense"},HERE:{name:"about.here"}},t.SETTING={PREFIX:{name:"setting.",optional:!0},ON:{name:"setting.on"},OFF:{name:"setting.off"},VERY_LOW:{name:"setting.veryLow"},LOW:{name:"setting.low"},MEDIUM:{name:"setting.medium"},HIGH:{name:"setting.high"},VERY_HIGH:{name:"setting.veryHigh"},NORMAL:{name:"setting.normal"},MINIMUM:{name:"setting.minimum"},MAXIMUM:{name:"setting.maximum"},FEW:{name:"setting.few"},MANY:{name:"setting.many"},EASY:{name:"setting.easy"},HARD:{name:"setting.hard"}},t.GENERAL_SETTINGS={BACK:{name:"generalSettings.backButton"},TITLE:{name:"generalSettings.title"},LANGUAGE:{name:"generalSettings.language"}},t.GRAPHICS={PREFIX:{name:"graphics.",optional:!0},BACK:{name:"graphics.back"},TITLE:{name:"graphics.title"},ANTIALIASING:{name:"graphics.antialiasing"},FILTERING:{name:"graphics.filtering"},BILINEAR:{name:"graphics.bilinear"},TRILINEAR:{name:"graphics.trilinear"},ANISOTROPIC:{name:"graphics.anisotropic"},TEXTURE_QUALITY:{name:"graphics.textureQuality"},BACKGROUND_QUALITY:{name:"graphics.backgroundQuality"},MODEL_DETAILS:{name:"graphics.modelDetails"},SHADERS:{name:"graphics.shaders"},SHADOWS:{name:"graphics.shadows"},SHADOW_QUALITY:{name:"graphics.shadowQuality"},SHADOW_DISTANCE:{name:"graphics.shadowDistance"},MAX_DYNAMIC_LIGHTS:{name:"graphics.maxDynamicLights"},PARTICLE_AMOUNT:{name:"graphics.particleAmount"},DUST_PARTICLE_AMOUNT:{name:"graphics.dustParticleAmount"}},t.AUDIO={PREFIX:{name:"audio.",optional:!0},BACK:{name:"audio.backButton"},TITLE:{name:"audio.title"},MASTER_VOLUME:{name:"audio.masterVolume"},MUSIC_VOLUME:{name:"audio.musicVolume"},SFX_VOLUME:{name:"audio.sfxVolume"},UI_VOLUME:{name:"audio.uiVolume"}},t.CONTOLLER={PREFIX:{name:"controller.",optional:!0},GENERAL:{name:"controller.general"},FIGHTER:{name:"controller.fighter"},CAMERA:{name:"controller.camera"}},t.INPUT={DEVICE_NAME_PREFIX:{name:"inputDevice.",optional:!0},DEVICE_KEYBOARD:{name:"inputDevice.keyboard"},DEVICE_MOUSE:{name:"inputDevice.mouse"},DEVICE_JOYSTICK:{name:"inputDevice.joystick"}},t.CONTROLS={BACK:{name:"controls.back"},SETTINGS_TITLE:{name:"controls.settingsTitle"},TITLE:{name:"controls.title"},MOUSE_TURN_SENSITIVITY:{name:"controls.mouseTurnSensitivity"},CONTROLLER_TYPE_HEADING:{name:"controls.controllerHeading"},ACTION:{name:"controls.action"}},t.ACTION_DESCRIPTIONS={PREFIX:{name:"actionDescriptions.",optional:!0}},t.SPACECRAFT_CLASS={PREFIX:{name:"spacecraftClass.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},t.SPACECRAFT_TYPE={PREFIX:{name:"spacecraftType.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},t.OBJECT_VIEW={PREFIX:{name:"objectView.",optional:!0}},t.FLIGHT_MODE={PREFIX:{name:"flightMode.",optional:!0}},t.TIP={PREFIX:{name:"tip.",optional:!0}},t.getDefiniteArticleForWord=function(e){return t.get(startsWithVowel(e)?t.GRAMMAR.DEFINITE_ARTICLE_BEFORE_VOWEL:t.GRAMMAR.DEFINITE_ARTICLE_BEFORE_CONSONANT)},t.getList=function(e){var i,r;for(i=e[0],r=1;r<e.length-1;r++)i+=", "+e[r];return e.length>1&&(i+=" "+t.get(t.GRAMMAR.AND)+" "+e[e.length-1]),i},t}),define("armada/logic/classes",["utils/utils","utils/types","utils/vectors","utils/matrices","modules/application","modules/resource-manager","modules/egom-model","modules/physics","modules/media-resources","modules/scene/camera","modules/scene/renderable-objects","armada/graphics","armada/strings"],function(t,e,i,r,n,o,s,a,l,h,u,c,p){"use strict";function getSkyboxClass(t){return d.getResource(T,t)}function getBackgroundObjectClass(t){return d.getResource(E,t)}function getDustCloudClass(t){return d.getResource(C,t)}function getExplosionClass(t){return d.getResource(M,t)}function getProjectileClass(t){return d.getResource(x,t)}function getWeaponClass(t){return d.getResource(b,t)}function getPropulsionClass(t){return d.getResource(O,t)}function getJumpEngineClass(t){return d.getResource(R,t)}function getSpacecraftType(t){return d.getResource(A,t)}function getSpacecraftClass(t,e){return d.getResource(I,t,{allowNullResult:e})}function getSpacecraftClassesInArray(t){var e,i=[],r=d.getResourceNames(I);for(e=0;e<r.length;e++)(!t||getSpacecraftClass(r[e]).shouldShowInDatabase())&&i.push(getSpacecraftClass(r[e]));return i}function getClassCategories(){return d.getResourceTypes()}function getClassNames(t){return d.getResourceNames(t)}function getClass(t,e){return d.getResource(t,e)}function _showMissingPropertyError(t,e){n.showError("Cannot initialize "+t.constructor.name+" without correctly specifying its property '"+e+"'!",n.ErrorSeverity.SEVERE,"The property was either not specified, or it was specified with a wrong type or an invalid value."+("string"==typeof t._name?"The error happened while initializing '"+t._name+"'":""))}function _loadSoundEffect(t){t.resource=l.getSoundEffect(t.name)}function _playSoundEffect(t,e){t.resource.play(t.volume,e)}function _createSoundClip(t,e,i,r,n,o){return t.resource?t.resource.createSoundClip(l.SoundCategory.SOUND_EFFECT,t.volume,e,r,n,o,i):null}function GenericClass(t,e){o.JSONResource.call(this,t,_,e)}function ShadedClass(t,e){GenericClass.call(this,t,e)}function ShadedModelClass(t,e){ShadedClass.call(this,t,e)}function SkyboxClass(t){ShadedModelClass.call(this,t)}function TexturedModelClass(t,e){ShadedModelClass.call(this,t,e)}function ParticleDescriptor(t){TexturedModelClass.call(this,t,!0)}function BackgroundObjectClass(t){GenericClass.call(this,t)}function DustCloudClass(t){ShadedModelClass.call(this,t)}function ParticleEmitterDescriptor(t){TexturedModelClass.call(this,t,!0)}function ExplosionClass(t){GenericClass.call(this,t)}function ProjectileClass(t){TexturedModelClass.call(this,t)}function Barrel(t){this._projectileClass=t?getProjectileClass(t.projectile||_showMissingPropertyError(this,"projectile"))||n.crash():null,this._projectileVelocity=t?t.projectileVelocity||_showMissingPropertyError(this,"projectileVelocity"):0,this._positionVector=t?t.position.slice()||_showMissingPropertyError(this,"position"):null,this._positionVector&&this._positionVector.push(1)}function WeaponRotator(t){this.axis=e.getValueOfType("WeaponRotator.axis",e.VECTOR3,t.axis),this.center=e.getValueOfType("WeaponRotator.center",e.VECTOR3,t.center),this.range=e.getValueOfType("WeaponRotator.range",e.VECTOR2,t.range,null,!0),this.range&&(this.range[0]=Math.radians(this.range[0]),this.range[1]=Math.radians(this.range[1])),this.defaultAngle=Math.radians(e.getValueOfType("WeaponRotator.defaultAngle",e.NUMBER,t.defaultAngle)),this.restricted=!!this.range,this.rotationRate=Math.radians(e.getValueOfType("WeaponRotator.rotationRate",e.NUMBER,t.rotationRate)),this.transformGroupIndex=e.getValueOfType("WeaponRotator.transformGroupIndex",e.NUMBER,t.transformGroupIndex)}function WeaponClass(t){TexturedModelClass.call(this,t)}function PropulsionClass(t){GenericClass.call(this,t)}function JumpEngineClass(t){GenericClass.call(this,t)}function SpacecraftType(t){GenericClass.call(this,t)}function WeaponSlot(t){this.positionMatrix=t?r.translation4v(t.position||_showMissingPropertyError(this,"position")):null,this.orientationMatrix=t?r.rotation4FromJSON(t.rotations||[]):null,this.maxGrade=t?t.maxGrade||_showMissingPropertyError(this,"maxGrade"):0}function ThrusterSlot(t){this.positionVector=t?t.position.slice()||_showMissingPropertyError(this,"position"):null,this.positionVector&&this.positionVector.push(1),this.size=t?t.size||1:0,this.uses=t?t.uses||_showMissingPropertyError(this,"uses"):null,this.group=t?"number"==typeof t.groupIndex?t.groupIndex:_showMissingPropertyError(this,"groupIndex"):0}function WeaponDescriptor(t){this.className=t?t["class"]||_showMissingPropertyError(this,"class"):null,this.slotIndex=t?t.slotIndex:-1}function PropulsionDescriptor(t){this.className=t?t["class"]||_showMissingPropertyError(this,"class"):null}function JumpEngineDescriptor(t){this.className=t?t["class"]||_showMissingPropertyError(this,"class"):null}function EquipmentProfile(t){var e;if(this._name=t.name||"custom",this._weaponDescriptors=[],t.weapons)for(e=0;e<t.weapons.length;e++)this._weaponDescriptors.push(new WeaponDescriptor(t.weapons[e]));this._propulsionDescriptor=t.propulsion?new PropulsionDescriptor(t.propulsion):null,this._jumpEngineDescriptor=t.jumpEngine?new JumpEngineDescriptor(t.jumpEngine):null}function GenericView(e){this._name=e?e.name||_showMissingPropertyError(this,"name"):null,this._fps=e&&"boolean"==typeof e.fps?e.fps:!1,this._fov=e?e.fov||0:0,this._fovRange=e?e.fovRange||null:null,this._movable=e?"boolean"==typeof e.movable?e.movable:_showMissingPropertyError(this,"movable"):!1,this._turnable=e?"boolean"==typeof e.turnable?e.turnable:_showMissingPropertyError(this,"turnable"):!1,this._positionMatrix=e?r.translation4v(e.position||_showMissingPropertyError(this,"position")):null,this._orientationMatrix=e?r.rotation4FromJSON(e.rotations):null,this._alphaRange=e&&this._fps?e.alphaRange||[-360,360]:[0,0],this._betaRange=e&&this._fps?e.betaRange||[-90,90]:[0,0],this._span=e?e.span||0:0,this._spanRange=e?e.spanRange||null:null,this._confines=e?e.confines||null:null,this._resetsWhenLeavingConfines=e&&"boolean"==typeof e.resetsWhenLeavingConfines?e.resetsWhenLeavingConfines:!1,this._baseOrientation=e&&e.baseOrientation?t.getSafeEnumValue(h.CameraOrientationConfiguration.BaseOrientation,e.baseOrientation)||n.showError("Invalid value '"+e.baseOrientation+"' specified for view baseOrientation!",n.ErrorSeverity.MINOR,"Valid values are: "+t.getEnumValues(h.CameraOrientationConfiguration.BaseOrientation).join(", ")+"."):null,this._pointToFallback=e&&e.pointToFallback?t.getSafeEnumValue(h.CameraOrientationConfiguration.PointToFallback,e.pointToFallback)||n.showError("Invalid value '"+e.pointToFallback+"' specified for view pointToFallback!",n.ErrorSeverity.MINOR,"Valid values are: "+t.getEnumValues(h.CameraOrientationConfiguration.PointToFallback).join(", ")+"."):null,this._excludeFromCycle=e&&"boolean"==typeof e.excludeFromCycle?e.excludeFromCycle:!1}function ObjectView(e){GenericView.call(this,e),this._isAimingView="boolean"==typeof e.isAimingView?e.isAimingView:_showMissingPropertyError(this,"isAimingView"),this._followsPosition="boolean"==typeof e.followsPosition?e.followsPosition:_showMissingPropertyError(this,"followsPosition"),e.lookAt=t.getSafeEnumValue(m,e.lookAt,m.NONE),this._followsOrientation="boolean"==typeof e.followsOrientation?e.followsOrientation:e.lookAt===m.NONE,this._lookAtSelf=e.lookAt===m.SELF?this._followsPosition||this._followsOrientation||this._turnable?n.showError("Invalid view configuration ('"+this._name+"'): lookAt mode cannot be 'self' if followsPosition, followsOrientation or turnable are true!"):!0:!1,this._lookAtTarget=e.lookAt===m.TARGET?this._followsOrientation||this._turnable?n.showError("Invalid view configuration ('"+this._name+"'): lookAt mode cannot be 'target' if followsOrientation or turnable are true!"):!0:!1,this._rotationCenterIsObject="boolean"==typeof e.rotationCenterIsObject?e.rotationCenterIsObject?this._lookAtSelf||!this._followsPosition?n.showError("Invalid view configuration ('"+this._name+"'): rotationCenterIsObject with lookAtSelf or without followsPosition!"):!0:!1:this._lookAtSelf||!this._followsPosition?!1:_showMissingPropertyError(this,"rotationCenterIsObject"),this._startsWithRelativePosition=e.startsWithRelativePosition===!0?this._followsPosition||this._rotationCenterIsObject?n.showError("Invalid view configuration ('"+this._name+"'): startsWithRelativePosition cannot be set to true if followsPosition or rotationCenterIsObject are true!"):!0:!1,this._distanceRange=(this._rotationCenterIsObject||this._lookAtSelf||this._lookAtTarget)&&this._movable?e.distanceRange||_showMissingPropertyError(this,"distanceRange"):e.distanceRange||null,this._movesRelativeToObject=e.movesRelativeToObject===!0?!this._rotationCenterIsObject&&this._followsPosition&&this._followsOrientation?!0:n.showError("Invalid view configuration ('"+this._name+"'): movesRelativeToObject can only be set if both position and orientation is followed and rotationCenterIsObject is false!"):!1,this._resetsOnFocusChange="boolean"==typeof e.resetsOnFocusChange?e.resetsOnFocusChange:!1,!this._followsPosition&&!this._startsWithRelativePosition&&(this._lookAtSelf||this._lookAtTarget)&&this._confines&&this._distanceRange&&n.showError("Invalid view configuration ('"+this._name+"'): A lookAt configuration with absolute position cannot have both position and distance confines!",n.ErrorSeverity.SEVERE,"Setting this configuration will likely cause a crash as position confines are absolute (if the position is absolute) but distance confines are relative to the lookAt object."),this._followsPosition||this._startsWithRelativePosition||!this._resetsWhenLeavingConfines||n.showError("Invalid view configuration ('"+this._name+"'): resetsWhenLeavingConfines cannot be set if position is absolute!")}function SceneView(e){GenericView.call(this,e),this._turnAroundAll="boolean"==typeof e.turnAroundAll?e.turnAroundAll:!1,this._lookAtAll=t.getSafeEnumValue(f,e.lookAt,f.NONE)===f.ALL?this._turnAroundAll||this._turnable?n.showError("Invalid view configuration ('"+this._name+"'): lookAt mode cannot be 'all' if turnAroundAll or turnable are true!"):!0:!1,this._distanceRange=(this._turnAroundAll||this._lookAtAll)&&this._movable?e.distanceRange||_showMissingPropertyError(this,"distanceRange"):e.distanceRange||null,this._startsWithRelativePosition=e.startsWithRelativePosition===!0?this._turnAroundAll?n.showError("Invalid view configuration ('"+this._name+"'): startsWithRelativePosition cannot be true if the view is set to turn around the objects!"):!0:!1,!this._turnAroundAll&&!this._startsWithRelativePosition&&this._lookAtAll&&this._confines&&this._distanceRange&&n.showError("Invalid view configuration ('"+this._name+"'): A lookAt configuration with absolute position cannot have both position and distance confines!",n.ErrorSeverity.SEVERE,"Setting this configuration will likely cause a crash as position confines are absolute (if the position is absolute) but distance confines are relative to the lookAt object."),this._turnAroundAll||this._startsWithRelativePosition||!this._resetsWhenLeavingConfines||n.showError("Invalid view configuration ('"+this._name+"'): resetsWhenLeavingConfines cannot be set if position is absolute!")}function DamageIndicator(t){this.hullIntegrity=t?t.hullIntegrity||_showMissingPropertyError(this,"hullIntegrity"):0,this.explosionClass=t?getExplosionClass(t["class"]||_showMissingPropertyError(this,"class"))||n.crash():null}function LightSourceDescriptor(t){this.position=t?t.position||_showMissingPropertyError(this,"position"):null,this.color=t?t.color||_showMissingPropertyError(this,"color"):null,this.intensity=t?t.intensity||_showMissingPropertyError(this,"intensity"):0,this.spotDirection=t?t.spotDirection||null:null,this.spotCutoffAngle=t?t.spotCutoffAngle||0:0,this.spotFullIntensityAngle=t?t.spotFullIntensityAngle||0:0}function BlinkerDescriptor(t){this._particle=null,t.particle?this._particle=new ParticleDescriptor(t.particle):_showMissingPropertyError(this,"particle"),this._position=t?t.position||_showMissingPropertyError(this,"position"):null,this._period=t?t.period||_showMissingPropertyError(this,"period"):0,this._blinks=t?t.blinks||_showMissingPropertyError(this,"blinks"):null,this._intensity=t?t.intensity||_showMissingPropertyError(this,"intensity"):0}function SpacecraftClass(t){TexturedModelClass.call(this,t)}function requestLoad(t,e){var i={};i[T]=SkyboxClass,i[E]=BackgroundObjectClass,i[C]=DustCloudClass,i[M]=ExplosionClass,i[x]=ProjectileClass,i[b]=WeaponClass,i[O]=PropulsionClass,i[R]=JumpEngineClass,i[A]=SpacecraftType,i[I]=SpacecraftClass,d.requestConfigLoad(t.filename,t.folder,i,function(){d.requestAllResources(),d.requestResourceLoad(),e&&e()}),_=t.folder}function handleGraphicsSettingsChanged(){d.executeForAllResources(function(t){t.handleGraphicsSettingsChanged()})}var d,_,g={OMNIDIRECTIONAL:"omnidirectional",UNIDIRECTIONAL:"unidirectional",PLANAR:"planar"},m={NONE:"none",SELF:"self",TARGET:"target"},f={NONE:"none",ALL:"all"},S={NONE:"none",YAW_PITCH:"yawPitch",ROLL_YAW:"rollYaw"},y={YAW_PITCH:"yawPitch",ROLL_YAW:"rollYaw",ROLL_PITCH:"rollPitch"},T="skyboxClasses",E="backgroundObjectClasses",C="dustCloudClasses",M="explosionClasses",x="projectileClasses",b="weaponClasses",O="propulsionClasses",R="jumpEngineClasses",A="spacecraftTypes",I="spacecraftClasses",v="-",N="fvqModel",L="squareModel",D="dust",P="projectileModel-",w="-width-",V="instanced",F={NAME:{name:"name",type:"string"},VOLUME:{name:"volume",type:"number",range:[0,10],defaultValue:1},RESOURCE:{name:"resource",type:"object",optional:!0}},B={NAME:{name:"name",type:"string"},VOLUME:{name:"volume",type:"number",range:[0,50],defaultValue:1},RESOURCE:{name:"resource",type:"object",optional:!0}};return Object.freeze(g),Object.freeze(m),Object.freeze(f),GenericClass.prototype=new o.JSONResource,GenericClass.prototype.constructor=GenericClass,GenericClass.prototype.showResourceAccessError=function(t,e){n.showError("Attempting to access "+t+" ('"+e+"') of class '"+this._name+"' before it has been loaded!")},GenericClass.prototype.handleGraphicsSettingsChanged=function(){},ShadedClass.prototype=new GenericClass,ShadedClass.prototype.constructor=ShadedClass,ShadedClass.prototype._overrideData=function(t,e){GenericClass.prototype._loadData.call(this,e),this._shaderName=t?e&&e.shader?e.shader:t._shaderName:e?e.shader||_showMissingPropertyError(this,"shader"):null,this._shader=null,this._instancedShaderName=null,this._instancedShader=null,this._managedShader=null,this._managedInstancedShader=null},ShadedClass.prototype._loadData=function(t){return this._overrideData(null,t),!0},ShadedClass.prototype.acquireResources=function(t){t=t||{},t.omitShader||(this._shader=c.getShader(this._shaderName),this._instancedShaderName=l.getShader(this._shaderName).getVariantShaderName(V),this._instancedShaderName&&(this._instancedShader=c.getShader(this._instancedShaderName)))},ShadedClass.prototype.getShader=function(){return null===this._shader?(this.showResourceAccessError("shader",this._shaderName),null):(this._managedShader||(this._managedShader=c.getManagedShader(this._shaderName)),this._managedShader)},ShadedClass.prototype.getInstancedShader=function(){return null===this._instancedShader?(n.showError("Attempting to access the instanced shader of '"+this._name+"', which does not exist (or is not loaded)!"),null):(this._managedInstancedShader||(this._managedInstancedShader=c.getManagedShader(this._instancedShaderName)),this._managedInstancedShader)},ShadedClass.prototype.handleGraphicsSettingsChanged=function(){this._managedShader=null,this._managedInstancedShader=null},ShadedModelClass.prototype=new ShadedClass,ShadedModelClass.prototype.constructor=ShadedModelClass,ShadedModelClass.prototype._overrideData=function(t,e){ShadedClass.prototype._overrideData.call(this,t,e),this._modelName=t?e&&e.model?e.model:t._modelName:e?e.model||null:null,this._model=null},ShadedModelClass.prototype._loadData=function(t){return this._overrideData(null,t),!0},ShadedModelClass.prototype.acquireResources=function(t){ShadedClass.prototype.acquireResources.call(this,t),t&&t.model?(this._model=l.getOrAddModel(t.model),this._modelName=this._model.getName()):this._model=c.getModel(this._modelName)},ShadedModelClass.prototype.getModel=function(){return null===this._model?(this.showResourceAccessError("model",this._modelName),null):this._model.getEgomModel()},SkyboxClass.prototype=new ShadedModelClass,SkyboxClass.prototype.constructor=SkyboxClass,SkyboxClass.prototype._loadData=function(t){return ShadedModelClass.prototype._loadData.call(this,t),this._cubemapName=t?t.cubemap||_showMissingPropertyError(this,"cubemap"):null,this._cubemap=null,!0},SkyboxClass.prototype.acquireResources=function(){ShadedModelClass.prototype.acquireResources.call(this,{model:s.fvqModel(N)}),null===this._cubemap&&(this._cubemap=c.getCubemap(this._cubemapName))},SkyboxClass.prototype.getCubemap=function(t){return null===this._cubemap?(this.showResourceAccessError("cubemap",this._cubemapName),null):this._cubemap.getManagedCubemap(t)},SkyboxClass.prototype.handleGraphicsSettingsChanged=function(){ShadedModelClass.prototype.handleGraphicsSettingsChanged.call(this),this._cubemap=null},TexturedModelClass.prototype=new ShadedModelClass,TexturedModelClass.prototype.constructor=TexturedModelClass,TexturedModelClass.prototype._overrideData=function(t,e){var i,r,o;for(ShadedModelClass.prototype._overrideData.call(this,t,e),this._textureName=t?e&&e.texture?e.texture:t._textureName:e?e.texture||_showMissingPropertyError(this,"texture"):null,this._texture=null,this._defaultLuminosityFactors=[],i=0,o=c.getMaxLuminosityFactors();o>i;i++)this._defaultLuminosityFactors.push(0);
if(e.defaultLuminosityFactors)for(i=0;i<e.defaultLuminosityFactors.length;i++)r=e.defaultLuminosityFactors[i][0],r<c.getMaxLuminosityFactors()?this._defaultLuminosityFactors[r]=e.defaultLuminosityFactors[i][1]:n.showError("Attempting to set luminosity of group with index "+r+", while there are only "+c.getMaxLuminosityFactors()+" luminosity groups available. (and indices start with 0)",n.ErrorSeverity.MINOR,"Happened while creating textured model class '"+this.getName()+"'.");else t&&(this._defaultLuminosityFactors=t._defaultLuminosityFactors.slice())},TexturedModelClass.prototype._loadData=function(t){return this._overrideData(null,t),!0},TexturedModelClass.prototype.acquireResources=function(t){ShadedModelClass.prototype.acquireResources.call(this,t),null===this._texture&&(this._texture=c.getTexture(this._textureName))},TexturedModelClass.prototype.getTexture=function(t,e){return null===this._texture?(this.showResourceAccessError("texture",this._textureName),null):this._texture.getManagedTexture(t,e)},TexturedModelClass.prototype.getTexturesOfTypes=function(t,e){return null===this._texture?(this.showResourceAccessError("texture",this._textureName),null):this._texture.getManagedTexturesOfTypes(t,e)},TexturedModelClass.prototype.getTextures=function(t){return this.getTexturesOfTypes(this._texture.getTypes(),t)},TexturedModelClass.prototype.getDefaultGroupLuminosity=function(t){return this._defaultLuminosityFactors[t]},TexturedModelClass.prototype.handleGraphicsSettingsChanged=function(){ShadedModelClass.prototype.handleGraphicsSettingsChanged.call(this),this._texture=null},ParticleDescriptor.prototype=new TexturedModelClass,ParticleDescriptor.prototype.constructor=ParticleDescriptor,ParticleDescriptor.prototype._loadData=function(t){return TexturedModelClass.prototype._loadData.call(this,t),this._size=t?t.size||1:0,this._color=t?t.color||[1,1,1,1]:null,this._duration=t?t.duration:null,!0},ParticleDescriptor.prototype.acquireResources=function(){TexturedModelClass.prototype.acquireResources.call(this,{model:s.squareModel(L)})},ParticleDescriptor.prototype.getSize=function(){return this._size},ParticleDescriptor.prototype.getColor=function(){return this._color},ParticleDescriptor.prototype.getDuration=function(){return this._duration},BackgroundObjectClass.prototype=new GenericClass,BackgroundObjectClass.prototype.constructor=BackgroundObjectClass,BackgroundObjectClass.prototype._loadData=function(t){var e;if(GenericClass.prototype._loadData.call(this,t),this._lightColor=t?t.lightColor||[1,1,1]:null,this._layers=[],t)if(t.layers)for(e=0;e<t.layers.length;e++)this._layers.push(new ParticleDescriptor(t.layers[e]));else _showMissingPropertyError(this,"layers");return!0},BackgroundObjectClass.prototype.acquireResources=function(){var t;for(t=0;t<this._layers.length;t++)this._layers[t].acquireResources()},BackgroundObjectClass.prototype.getLightColor=function(){return this._lightColor},BackgroundObjectClass.prototype.getLayers=function(){return this._layers},BackgroundObjectClass.prototype.handleGraphicsSettingsChanged=function(){var t;for(GenericClass.prototype.handleGraphicsSettingsChanged.call(this),t=0;t<this._layers.length;t++)this._layers[t].handleGraphicsSettingsChanged()},DustCloudClass.prototype=new ShadedModelClass,DustCloudClass.prototype.constructor=DustCloudClass,DustCloudClass.prototype._loadData=function(t){return ShadedModelClass.prototype._loadData.call(this,t),this._numberOfParticles=t?t.numberOfParticles||_showMissingPropertyError(this,"numberOfParticles"):0,this._color=t?t.color||[1,1,1]:null,this._range=t?t.range||_showMissingPropertyError(this,"range"):0,!0},DustCloudClass.prototype.acquireResources=function(){ShadedModelClass.prototype.acquireResources.call(this,{model:s.lineModel(D,[1,1,1],[1,1,1,1])})},DustCloudClass.prototype.getNumberOfParticles=function(){return this._numberOfParticles*c.getDustParticleCountFactor()},DustCloudClass.prototype.getColor=function(){return this._color},DustCloudClass.prototype.getRange=function(){return this._range},ParticleEmitterDescriptor.prototype=new TexturedModelClass,ParticleEmitterDescriptor.prototype.constructor=ParticleEmitterDescriptor,ParticleEmitterDescriptor.prototype._loadData=function(e){return TexturedModelClass.prototype._loadData.call(this,e),this._type=e?t.getSafeEnumValue(g,e.type,g.OMNIDIRECTIONAL):null,this._hasProjectileModel=e?e.hasProjectileModel||!1:!1,this._projectileModelWidth=e?e.projectileModelWidth||1:0,this._projectileModelIntersection=e?e.projectileModelIntersection||0:0,this._dimensions=e?e.dimensions||[0,0,0]:null,this._directionSpread=!e||this._type!==g.UNIDIRECTIONAL&&this._type!==g.PLANAR?0:e.directionSpread||0,this._velocity=e?e.velocity||0:0,this._velocitySpread=e?e.velocitySpread||0:0,this._initialNumber=e?e.initialNumber||0:0,this._spawnNumber=e?e.spawnNumber||0:0,this._spawnTime=e?e.spawnTime||1:0,this._duration=e?void 0!==e.duration?e.duration:1:0,this._delay=e&&void 0!==e.delay?e.delay:0,this._particleStates=e?e.particleStates||[]:null,!0},ParticleEmitterDescriptor.prototype.acquireResources=function(){TexturedModelClass.prototype.acquireResources.call(this,{model:this._hasProjectileModel?s.turningBillboardModel(P+this._projectileModelIntersection+w+this._projectileModelWidth,[this._projectileModelIntersection],this._projectileModelWidth):s.squareModel(L)})},ParticleEmitterDescriptor.prototype.getType=function(){return this._type},ParticleEmitterDescriptor.prototype.getDimensions=function(){return this._dimensions},ParticleEmitterDescriptor.prototype.getDirectionSpread=function(){return this._directionSpread},ParticleEmitterDescriptor.prototype.getVelocity=function(){return this._velocity},ParticleEmitterDescriptor.prototype.getVelocitySpread=function(){return this._velocitySpread},ParticleEmitterDescriptor.prototype.getInitialNumber=function(){return this._initialNumber},ParticleEmitterDescriptor.prototype.getSpawnNumber=function(){return this._spawnNumber},ParticleEmitterDescriptor.prototype.getSpawnTime=function(){return this._spawnTime},ParticleEmitterDescriptor.prototype.getDuration=function(){return this._duration},ParticleEmitterDescriptor.prototype.getDelay=function(){return this._delay},ParticleEmitterDescriptor.prototype.getParticleStates=function(){return this._particleStates},ParticleEmitterDescriptor.prototype.getParticleDuration=function(){var t,e=0;for(t=0;t<this._particleStates.length;t++)e+=this._particleStates[t].timeToReach;return e},ParticleEmitterDescriptor.prototype.getTotalDuration=function(){var t=this._delay;return this._spawnNumber&&this._spawnTime&&(t+=Math.floor(this._duration/this._spawnTime)*this._spawnTime),t+=this.getParticleDuration()},ParticleEmitterDescriptor.prototype.getMaxParticleCount=function(){var t,e,i,r=this.getParticleDuration();return i=Math.floor(this._duration/this._spawnTime)+1,e=Math.ceil(r/this._spawnTime),t=this._spawnNumber*(this._duration?Math.min(i,e):e),this._initialNumber>this._spawnNumber?t+=this._initialNumber-this._spawnNumber:this._initialNumber<this._spawnNumber&&this._duration&&e>=i&&(t-=this._spawnNumber-this._initialNumber),t},ExplosionClass.prototype=new GenericClass,ExplosionClass.prototype.constructor=ExplosionClass,ExplosionClass.prototype._loadData=function(t){var i;if(GenericClass.prototype._loadData.call(this,t),this._particleEmitterDescriptors=null,t&&t.particleEmitters)for(this._particleEmitterDescriptors=[],i=0;i<t.particleEmitters.length;i++)this._particleEmitterDescriptors.push(new ParticleEmitterDescriptor(t.particleEmitters[i]));return this._lightStates=t?t.lightStates:null,this._soundEffect=t&&t.soundEffect?e.getVerifiedObject("explosionClasses['"+this._name+"'].soundEffect",t.soundEffect,B):null,!0},ExplosionClass.prototype.acquireResources=function(){var t;for(t=0;t<this._particleEmitterDescriptors.length;t++)this._particleEmitterDescriptors[t].acquireResources();this._soundEffect&&_loadSoundEffect(this._soundEffect)},ExplosionClass.prototype.getParticleEmitterDescriptors=function(){return this._particleEmitterDescriptors},ExplosionClass.prototype.getLightStates=function(){return this._lightStates},ExplosionClass.prototype.getTotalDuration=function(){var t,e,i=0;for(t=0;t<this._particleEmitterDescriptors.length;t++)e=this._particleEmitterDescriptors[t].getTotalDuration(),e>i&&(i=e);return i},ExplosionClass.prototype.getMaxParticleCount=function(){var t,e=0;for(t=0;t<this._particleEmitterDescriptors.length;t++)e+=this._particleEmitterDescriptors[t].getMaxParticleCount();return e},ExplosionClass.prototype.isContinuous=function(){var t;for(t=0;t<this._particleEmitterDescriptors.length;t++)if(0===this._particleEmitterDescriptors[t]._duration)return!0;return!1},ExplosionClass.prototype.playSound=function(t,e,i,r){var n;this._soundEffect&&(n=_createSoundClip(this._soundEffect,!1,t,e,i,r),n&&n.play())},ExplosionClass.prototype.handleGraphicsSettingsChanged=function(){var t;for(GenericClass.prototype.handleGraphicsSettingsChanged.call(this),t=0;t<this._particleEmitterDescriptors.length;t++)this._particleEmitterDescriptors[t].handleGraphicsSettingsChanged()},ProjectileClass.prototype=new TexturedModelClass,ProjectileClass.prototype.constructor=ProjectileClass,ProjectileClass.prototype._loadData=function(t){return TexturedModelClass.prototype._loadData.call(this,t),this._damage=t?t.damage||0:0,this._size=t?t.size||1:0,this._intersectionPositions=t?t.intersectionPositions||[]:null,this._width=t?t.width||1:0,this._mass=t?t.mass||_showMissingPropertyError(this,"mass"):0,this._duration=t?t.duration||_showMissingPropertyError(this,"duration"):0,this._muzzleFlash=null,t&&(t.muzzleFlash?this._muzzleFlash=new ParticleDescriptor(t.muzzleFlash):_showMissingPropertyError(this,"muzzleFlash")),this._lightColor=t?t.lightColor||_showMissingPropertyError(this,"lightColor"):null,this._lightIntensity=t?t.lightIntensity||_showMissingPropertyError(this,"lightIntensity"):0,this._explosionClass=t?getExplosionClass(t.explosion||_showMissingPropertyError(this,"explosion"))||n.crash():null,!0},ProjectileClass.prototype.acquireResources=function(){TexturedModelClass.prototype.acquireResources.call(this,{model:s.turningBillboardModel(P+this._intersectionPositions.join(v)+w+this._width,this._intersectionPositions,this._width)}),this._muzzleFlash.acquireResources(),this._explosionClass.acquireResources()},ProjectileClass.prototype.getDamage=function(){return this._damage},ProjectileClass.prototype.getSize=function(){return this._size},ProjectileClass.prototype.getMass=function(){return this._mass},ProjectileClass.prototype.getDuration=function(){return this._duration},ProjectileClass.prototype.getMuzzleFlash=function(){return this._muzzleFlash},ProjectileClass.prototype.getLightColor=function(){return this._lightColor},ProjectileClass.prototype.getLightIntensity=function(){return this._lightIntensity},ProjectileClass.prototype.getExplosionClass=function(){return this._explosionClass},ProjectileClass.prototype.handleGraphicsSettingsChanged=function(){TexturedModelClass.prototype.handleGraphicsSettingsChanged.call(this),this._muzzleFlash.handleGraphicsSettingsChanged()},Barrel.prototype.getProjectileClass=function(){return this._projectileClass},Barrel.prototype.getProjectileVelocity=function(){return this._projectileVelocity},Barrel.prototype.getForceForDuration=function(t){return this._projectileVelocity*this._projectileClass.getMass()/(t/1e3)},Barrel.prototype.getPositionVector=function(){return this._positionVector},Barrel.prototype.acquireResources=function(){this._projectileClass.acquireResources()},Barrel.prototype.getMaxProjectileCount=function(t){return Math.ceil(this._projectileClass._duration/t)},Barrel.prototype.getMaxExplosionCount=function(t){return Math.ceil(this._projectileClass.getExplosionClass().getTotalDuration()/t)},Barrel.prototype.getMaxParticleCount=function(t){return 1+this.getMaxExplosionCount(t)*this._projectileClass.getExplosionClass().getMaxParticleCount()},WeaponClass.prototype=new TexturedModelClass,WeaponClass.prototype.constructor=WeaponClass,WeaponClass.prototype._loadData=function(i){var r;if(TexturedModelClass.prototype._loadData.call(this,i),this._grade=i?i.grade||_showMissingPropertyError(this,"grade"):0,this._cooldown=i?i.cooldown||_showMissingPropertyError(this,"cooldown"):0,this._barrels=[],i)if(i.barrels)for(r=0;r<i.barrels.length;r++)this._barrels.push(new Barrel(i.barrels[r]));else _showMissingPropertyError(this,"barrels");if(this._attachmentPoint=i?i.attachmentPoint||_showMissingPropertyError(this,"attachmentPoint"):null,this._rotationStyle=i?t.getSafeEnumValue(S,i.rotationStyle,S.NONE):null,this._fixed=this._rotationStyle===S.NONE,this._basePoint=i&&!this._fixed?i.basePoint.slice()||_showMissingPropertyError(this,"basePoint"):null,this._basePoint&&this._basePoint.push(1),this._rotators=[],i&&!this._fixed)if(i.rotators)for(r=0;r<i.rotators.length;r++)this._rotators.push(new WeaponRotator(i.rotators[r]));else _showMissingPropertyError(this,"rotators");return this._fireSound=i?e.getVerifiedObject("weaponClasses['"+this._name+"'].fireSound",i.fireSound,B):null,this._scoreValue=i?i.scoreValue||_showMissingPropertyError(this,"scoreValue")||0:0,!0},WeaponClass.prototype.acquireResources=function(t){var e;for(TexturedModelClass.prototype.acquireResources.call(this,t),e=0;e<this._barrels.length;e++)this._barrels[e].acquireResources();_loadSoundEffect(this._fireSound)},WeaponClass.prototype.getGrade=function(){return this._grade},WeaponClass.prototype.getCooldown=function(){return this._cooldown},WeaponClass.prototype.getBarrel=function(t){return this._barrels[t]},WeaponClass.prototype.getBarrels=function(){return this._barrels},WeaponClass.prototype.getAttachmentPoint=function(){return this._attachmentPoint},WeaponClass.prototype.getRotationStyle=function(){return this._rotationStyle},WeaponClass.prototype.isFixed=function(){return this._fixed},WeaponClass.prototype.getBasePoint=function(){return this._basePoint},WeaponClass.prototype.getRotators=function(){return this._rotators},WeaponClass.prototype.getProjectileClass=function(){return this._barrels[0].getProjectileClass()},WeaponClass.prototype.getProjectileVelocity=function(){return this._barrels[0].getProjectileVelocity()},WeaponClass.prototype.getFirepower=function(t){var e,i=0;for(t=t||0,e=0;e<this._barrels.length;e++)i+=Math.max(0,this._barrels[e].getProjectileClass().getDamage()-t);return 1e3*i/this._cooldown},WeaponClass.prototype.playFireSound=function(t,e,i,r){t?_playSoundEffect(this._fireSound,t):_createSoundClip(this._fireSound,!1,e,!0,i,r).play()},WeaponClass.prototype.getScoreValue=function(){return this._scoreValue},WeaponClass.prototype.getMaxProjectileCount=function(){var t,e=0;for(t=0;t<this._barrels.length;t++)e+=this._barrels[t].getMaxProjectileCount(this._cooldown);return e},WeaponClass.prototype.getMaxExplosionCount=function(){var t,e=0;for(t=0;t<this._barrels.length;t++)e+=this._barrels[t].getMaxExplosionCount(this._cooldown);return e},WeaponClass.prototype.getMaxParticleCount=function(){var t,e=0;for(t=0;t<this._barrels.length;t++)e+=this._barrels[t].getMaxParticleCount(this._cooldown);return e},PropulsionClass.prototype=new GenericClass,PropulsionClass.prototype.constructor=PropulsionClass,PropulsionClass.prototype._loadData=function(t){var i;return GenericClass.prototype._loadData.call(this,t),i=t?t.referenceMass||1:null,this._thrusterBurnParticle=new ParticleDescriptor(t),this._grade=t?t.grade||_showMissingPropertyError(this,"grade"):0,this._thrust=t?i*t.thrust||_showMissingPropertyError(this,"thrust"):0,this._angularThrust=t?i*Math.radians(t.angularThrust)||_showMissingPropertyError(this,"angularThrust"):0,this._maxMoveBurnLevel=t?t.maxMoveBurnLevel||_showMissingPropertyError(this,"maxMoveBurnLevel"):0,this._maxTurnBurnLevel=t?t.maxTurnBurnLevel||_showMissingPropertyError(this,"maxTurnBurnLevel"):0,this._thrusterSound=t?e.getVerifiedObject("propulsionClasses['"+this._name+"'].thrusterSound",t.thrusterSound,B):null,this._scoreValue=t?t.scoreValue||_showMissingPropertyError(this,"scoreValue")||0:0,!0},PropulsionClass.prototype.acquireResources=function(){this._thrusterBurnParticle.acquireResources(),_loadSoundEffect(this._thrusterSound)},PropulsionClass.prototype.getThrusterBurnParticle=function(){return this._thrusterBurnParticle},PropulsionClass.prototype.getGrade=function(){return this._grade},PropulsionClass.prototype.getThrust=function(){return this._thrust},PropulsionClass.prototype.getAngularThrust=function(){return this._angularThrust},PropulsionClass.prototype.getMaxMoveBurnLevel=function(){return this._maxMoveBurnLevel},PropulsionClass.prototype.getMaxTurnBurnLevel=function(){return this._maxTurnBurnLevel},PropulsionClass.prototype.handleGraphicsSettingsChanged=function(){GenericClass.prototype.handleGraphicsSettingsChanged.call(this),this._thrusterBurnParticle.handleGraphicsSettingsChanged()},PropulsionClass.prototype.createThrusterSoundClip=function(t){return _createSoundClip(this._thrusterSound,!0,t)},PropulsionClass.prototype.getThrusterSoundVolume=function(){return this._thrusterSound.volume},PropulsionClass.prototype.getScoreValue=function(){return this._scoreValue},JumpEngineClass.prototype=new GenericClass,JumpEngineClass.prototype.constructor=JumpEngineClass,JumpEngineClass.prototype._loadData=function(t){return GenericClass.prototype._loadData.call(this,t),this._engageSound=t?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].engageSound",t.engageSound,F):null,this._disengageSound=t?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].disengageSound",t.disengageSound,F):null,this._prepareVelocity=t?t.prepareVelocity||_showMissingPropertyError(this,"prepareVelocity"):0,this._prepareDuration=t?t.prepareDuration||_showMissingPropertyError(this,"prepareDuration"):0,this._prepareSound=t?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].prepareSound",t.prepareSound,B):null,this._cancelSound=t?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].cancelSound",t.cancelSound,B):null,this._jumpOutAcceleration=t?t.jumpOutAcceleration||_showMissingPropertyError(this,"jumpOutAcceleration"):0,this._jumpOutScaling=t?t.jumpOutScaling||_showMissingPropertyError(this,"jumpOutScaling"):0,this._jumpOutDuration=t?t.jumpOutDuration||_showMissingPropertyError(this,"jumpOutDuration"):0,this._jumpOutSound=t?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].jumpOutSound",t.jumpOutSound,B):null,this._jumpOutExplosionClass=t?getExplosionClass(t.jumpOutExplosion||_showMissingPropertyError(this,"jumpOutExplosion"))||n.crash():null,this._jumpInDeceleration=t?t.jumpInDeceleration||_showMissingPropertyError(this,"jumpInDeceleration"):0,this._jumpInVelocity=t?t.jumpInVelocity||_showMissingPropertyError(this,"jumpInVelocity"):0,this._jumpInScaling=t?t.jumpInScaling||_showMissingPropertyError(this,"jumpInScaling"):0,this._jumpInDuration=t?t.jumpInDuration||_showMissingPropertyError(this,"jumpInDuration"):0,this._jumpInSound=t?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].jumpInSound",t.jumpInSound,B):null,this._jumpInExplosionClass=t?getExplosionClass(t.jumpInExplosion||_showMissingPropertyError(this,"jumpInExplosion"))||n.crash():null,!0},JumpEngineClass.prototype.acquireResources=function(){_loadSoundEffect(this._engageSound),_loadSoundEffect(this._disengageSound),_loadSoundEffect(this._prepareSound),_loadSoundEffect(this._cancelSound),_loadSoundEffect(this._jumpOutSound),_loadSoundEffect(this._jumpInSound),this._jumpOutExplosionClass.acquireResources(),this._jumpInExplosionClass.acquireResources()},JumpEngineClass.prototype.createEngageSoundClip=function(){return _createSoundClip(this._engageSound,!1)},JumpEngineClass.prototype.createDisengageSoundClip=function(){return _createSoundClip(this._disengageSound,!1)},JumpEngineClass.prototype.getPrepareVelocity=function(){return this._prepareVelocity},JumpEngineClass.prototype.getPrepareDuration=function(){return this._prepareDuration},JumpEngineClass.prototype.createPrepareSoundClip=function(t){return _createSoundClip(this._prepareSound,!1,t)},JumpEngineClass.prototype.createCancelSoundClip=function(t){return _createSoundClip(this._cancelSound,!1,t)},JumpEngineClass.prototype.getJumpOutDuration=function(){return this._jumpOutDuration},JumpEngineClass.prototype.getJumpOutAcceleration=function(){return this._jumpOutAcceleration},JumpEngineClass.prototype.getJumpOutScaling=function(){return this._jumpOutScaling},JumpEngineClass.prototype.createJumpOutSoundClip=function(t){return _createSoundClip(this._jumpOutSound,!1,t)},JumpEngineClass.prototype.getJumpOutExplosionClass=function(){return this._jumpOutExplosionClass},JumpEngineClass.prototype.getJumpInDuration=function(){return this._jumpInDuration},JumpEngineClass.prototype.getJumpInDeceleration=function(){return this._jumpInDeceleration},JumpEngineClass.prototype.getJumpInVelocity=function(){return this._jumpInVelocity},JumpEngineClass.prototype.getJumpInScaling=function(){return this._jumpInScaling},JumpEngineClass.prototype.createJumpInSoundClip=function(t){return _createSoundClip(this._jumpInSound,!1,t)},JumpEngineClass.prototype.getJumpInExplosionClass=function(){return this._jumpInExplosionClass},SpacecraftType.prototype=new GenericClass,SpacecraftType.prototype.constructor=SpacecraftType,SpacecraftType.prototype._loadData=function(t){return GenericClass.prototype._loadData.call(this,t),this._isFighterType=t?"boolean"==typeof t.isFighterType?t.isFighterType:_showMissingPropertyError(this,"isFighterType"):!1,this._fullName=t?t.fullName||_showMissingPropertyError(this,"fullName"):null,this._description=t?"string"==typeof t.description?t.description:_showMissingPropertyError(this,"description"):null,this._goodAgainstTypeNames=t?t.goodAgainst||[]:null,this._badAgainstTypeNames=t?t.badAgainst||[]:null,!0},SpacecraftType.prototype.isFighterType=function(){return this._isFighterType},SpacecraftType.prototype.getDisplayName=function(){return p.get(p.SPACECRAFT_TYPE.PREFIX,this.getName()+p.SPACECRAFT_TYPE.NAME_SUFFIX.name,this._fullName)},SpacecraftType.prototype.getDisplayDescription=function(){return p.get(p.SPACECRAFT_TYPE.PREFIX,this.getName()+p.SPACECRAFT_TYPE.DESCRIPTION_SUFFIX.name,t.formatString(p.get(p.DATABASE.MISSING_SPACECRAFT_TYPE_DESCRIPTION),{spacecraftType:this.getDisplayName(),originalDescription:this._description}))},SpacecraftType.prototype.getGoodAgainstTypes=function(){var t,e;for(e=[],t=0;t<this._goodAgainstTypeNames.length;t++)e.push(getSpacecraftType(this._goodAgainstTypeNames[t]))},SpacecraftType.prototype.getBadAgainstTypes=function(){var t,e;for(e=[],t=0;t<this._badAgainstTypeNames.length;t++)e.push(getSpacecraftType(this._badAgainstTypeNames[t]))},SpacecraftType.prototype.isGoodAgainst=function(t){return this._goodAgainstTypeNames.indexOf(t.getName())>=0},SpacecraftType.prototype.isBadAgainst=function(t){return this._badAgainstTypeNames.indexOf(t.getName())>=0},EquipmentProfile.prototype.getName=function(){return this._name},EquipmentProfile.prototype.getWeaponDescriptors=function(){return this._weaponDescriptors},EquipmentProfile.prototype.getPropulsionDescriptor=function(){return this._propulsionDescriptor},EquipmentProfile.prototype.getJumpEngineDescriptor=function(){return this._jumpEngineDescriptor},GenericView.prototype.getName=function(){return this._name},GenericView.prototype.isFPS=function(){return this._fps},GenericView.prototype.getFOV=function(){return this._fov},GenericView.prototype.getFOVRange=function(){return this._fovRange},GenericView.prototype.getSpan=function(){return this._span},GenericView.prototype.getSpanRange=function(){return this._spanRange},GenericView.prototype.isMovable=function(){return this._movable},GenericView.prototype.isTurnable=function(){return this._turnable},GenericView.prototype.getPositionMatrix=function(){return this._positionMatrix},GenericView.prototype.getOrientationMatrix=function(){return this._orientationMatrix},GenericView.prototype.getAlphaRange=function(){return this._alphaRange},GenericView.prototype.getBetaRange=function(){return this._betaRange},GenericView.prototype.getConfines=function(){return this._confines},GenericView.prototype.resetsWhenLeavingConfines=function(){return this._resetsWhenLeavingConfines},GenericView.prototype.getBaseOrientation=function(){return this._baseOrientation},GenericView.prototype.getPointToFallback=function(){return this._pointToFallback},GenericView.prototype.shouldExcludeFromCycle=function(){return this._excludeFromCycle},GenericView.prototype.destroy=function(){this._fovRange=null,this._positionMatrix=null,this._orientationMatrix=null,this._alphaRange=null,this._betaRange=null,this._spanRange=null,this._confines=null},ObjectView.prototype=new GenericView,ObjectView.prototype.constructor=ObjectView,ObjectView.prototype.isAimingView=function(){return this._isAimingView},ObjectView.prototype.turnsAroundObjects=function(){return this._rotationCenterIsObject},ObjectView.prototype.movesRelativeToObject=function(){return this._movesRelativeToObject},ObjectView.prototype.getPositionFollowedObjectsForObject=function(t){return this._followsPosition||this._startsWithRelativePosition?[t]:[]},ObjectView.prototype.startsWithRelativePosition=function(){return this._startsWithRelativePosition},ObjectView.prototype.getDistanceRange=function(){return this._distanceRange},ObjectView.prototype.pointsTowardsObjects=function(){return this._lookAtSelf||this._lookAtTarget},ObjectView.prototype.getOrientationFollowedObjectsForObject=function(t){return this._lookAtSelf||this._followsOrientation?[t]:[]},ObjectView.prototype.resetsOnFocusChange=function(){return this._resetsOnFocusChange},ObjectView.prototype.createCameraConfiguration=function(t,e,i,n,o,s,a){var l,u,c=r.getYawAndPitch(this._orientationMatrix);return l=new h.CameraPositionConfiguration(!this.isMovable(),this.turnsAroundObjects(),this.movesRelativeToObject(),this.getPositionFollowedObjectsForObject(t),this.startsWithRelativePosition(),r.matrix4(this._positionMatrix),this.getDistanceRange(),this.getConfines(),this.resetsWhenLeavingConfines()),u=new h.CameraOrientationConfiguration(!this.isTurnable(),this.pointsTowardsObjects(),this.isFPS(),this.getOrientationFollowedObjectsForObject(t),r.matrix4(this._orientationMatrix),Math.degrees(c.yaw),Math.degrees(c.pitch),this.getAlphaRange(),this.getBetaRange(),this.getBaseOrientation()||e,this.getPointToFallback()||i),new h.CameraConfiguration(this.getName(),l,u,this.getFOV()||n,this.getFOVRange()||o,this.getSpan()||s,this.getSpanRange()||a,this.resetsOnFocusChange(),this.shouldExcludeFromCycle())},ObjectView.prototype.destroy=function(){GenericView.prototype.destroy.call(this),this._distanceRange=null},SceneView.prototype=new GenericView,SceneView.prototype.constructor=SceneView,SceneView.prototype.turnsAroundObjects=function(){return this._turnAroundAll},SceneView.prototype.movesRelativeToObject=function(){return!1},SceneView.prototype.getPositionFollowedObjectsForScene=function(t){return this._turnAroundAll||this._startsWithRelativePosition?t.getAll3DObjects():[]},SceneView.prototype.startsWithRelativePosition=function(){return this._startsWithRelativePosition},SceneView.prototype.getDistanceRange=function(){return this._distanceRange},SceneView.prototype.pointsTowardsObjects=function(){return this._lookAtAll},SceneView.prototype.getOrientationFollowedObjectsForScene=function(t){return this._lookAtAll?t.getAll3DObjects():[]},SceneView.prototype.resetsOnFocusChange=function(){return!1},SceneView.prototype.destroy=function(){GenericView.prototype.destroy.call(this),this._distanceRange=null},BlinkerDescriptor.prototype.acquireResources=function(){this._particle.acquireResources()},BlinkerDescriptor.prototype.getParticle=function(){return this._particle},BlinkerDescriptor.prototype.getPosition=function(){return this._position},BlinkerDescriptor.prototype.getBlinks=function(){return this._blinks},BlinkerDescriptor.prototype.getPeriod=function(){return this._period},BlinkerDescriptor.prototype.getIntensity=function(){return this._intensity},BlinkerDescriptor.prototype.getLightColor=function(){return[this._particle.getColor()[0],this._particle.getColor()[1],this._particle.getColor()[2]]},BlinkerDescriptor.prototype.getParticleStates=function(){var t,e=0,i=[];if(this._blinks.length>0)for(this._blinks[0]>0&&(i.push(new u.ParticleState(this._particle.getColor(),0,0)),i.push(new u.ParticleState(this._particle.getColor(),0,this._blinks[0]))),t=0;t<this._blinks.length;t++)i.push(new u.ParticleState(this._particle.getColor(),this._particle.getSize(),0)),i.push(new u.ParticleState(this._particle.getColor(),0,this._particle._duration)),e=this._blinks[t]+this._particle._duration,i.push(new u.ParticleState(this._particle.getColor(),0,t<this._blinks.length-1?this._blinks[t+1]-e:this._period-e));else i.push(new u.ParticleState(this._particle.getColor(),0,0));return i},BlinkerDescriptor.prototype.getLightStates=function(){var t,e=0,i=[];if(this._blinks.length>0)for(this._blinks[0]>0&&(i.push({color:this.getLightColor(),intensity:0,timeToReach:0}),i.push({color:this.getLightColor(),intensity:0,timeToReach:this._blinks[0]})),t=0;t<this._blinks.length;t++)i.push({color:this.getLightColor(),intensity:this._intensity,timeToReach:0}),i.push({color:this.getLightColor(),intensity:0,timeToReach:this._particle._duration}),e=this._blinks[t]+this._particle._duration,i.push({color:this.getLightColor(),intensity:0,timeToReach:t<this._blinks.length-1?this._blinks[t+1]-e:this._period-e});else i.push({color:this.getLightColor(),intensity:0,timeToReach:0});return i},BlinkerDescriptor.prototype.handleGraphicsSettingsChanged=function(){this._particle.handleGraphicsSettingsChanged()},SpacecraftClass.prototype=new TexturedModelClass,SpacecraftClass.prototype.constructor=SpacecraftClass,SpacecraftClass.prototype._overrideData=function(o,s){var l,h,u,c,p,d,_,g,m,f,S,T;switch(TexturedModelClass.prototype._overrideData.call(this,o,s),this._spacecraftType=o?s.type?getSpacecraftType(s.type):o._spacecraftType:getSpacecraftType(s.type||_showMissingPropertyError(this,"type")),this._fullName=o?s.fullName||o._fullName:s.fullName||_showMissingPropertyError(this,"fullName"),this._description=o?s.description||o._description:s.description||_showMissingPropertyError(this,"description"),this._showInDatabase=o?"boolean"==typeof s.showInDatabase?s.showInDatabase:o._showInDatabase:"boolean"==typeof s.showInDatabase?s.showInDatabase:_showMissingPropertyError(this,"showInDatabase"),this._hitpoints=o?s.hitpoints||o._hitpoints:s.hitpoints||_showMissingPropertyError(this,"hitpoints")||0,this._armor="number"==typeof s.armor?s.armor:o?o._armor:_showMissingPropertyError(this,"armor")||0,this._factionColor=o?s.factionColor||o._factionColor:s.factionColor||_showMissingPropertyError(this,"factionColor")||[0,0,0,0],this._turnStyle=s.turnStyle?t.getSafeEnumValue(y,s.turnStyle,y.YAW_PITCH):o?o._turnStyle:y.YAW_PITCH,this._attackVector=s.attackVector?i.normal3(s.attackVector):o?o._attackVector:[0,1,0],this._attackVectorAngles=[0,0],this._turnStyle){case y.YAW_PITCH:T=i.getYawAndPitch(this._attackVector),this._attackVectorAngles[0]=T.yaw,this._attackVectorAngles[1]=T.pitch;break;case y.ROLL_YAW:T=i.getRollAndYaw(this._attackVector),this._attackVectorAngles[0]=T.roll,this._attackVectorAngles[1]=T.yaw;break;case y.ROLL_PITCH:T=i.getRollAndPitch(this._attackVector),this._attackVectorAngles[0]=T.roll,this._attackVectorAngles[1]=T.pitch;break;default:n.crash()}if(this._attackThresholdAngle=Math.radians(s.attackThresholdAngle)||(o?o._attackThresholdAngle:0),this._mass=o?s.mass||o._mass:s.mass||_showMissingPropertyError(this,"mass"),this._bodies=o&&!s.bodies?o._bodies:[],s.bodies)for(l=0;l<s.bodies.length;l++)this._bodies.push(new a.Body(r.translation4v(s.bodies[l].position||_showMissingPropertyError(this,"bodies[i].position")),r.rotation4FromJSON(s.bodies[l].rotations),s.bodies[l].size));else o||_showMissingPropertyError(this,"bodies");if(this._weaponSlots=o&&!s.weaponSlots?o._weaponSlots:[],
s.weaponSlots)for(l=0;l<s.weaponSlots.length;l++)if(s.weaponSlots[l].array)for(u=s.weaponSlots[l].startPosition||_showMissingPropertyError(this,"weaponSlot array startPosition"),c=s.weaponSlots[l].translationVector||_showMissingPropertyError(this,"weaponSlot array translationVector"),p=s.weaponSlots[l].rotations,d=s.weaponSlots[l].maxGrade||_showMissingPropertyError(this,"weaponSlot array maxGrade"),_=s.weaponSlots[l].count||_showMissingPropertyError(this,"weaponSlot array count"),h=0;_>h;h++)this._weaponSlots.push(new WeaponSlot({position:i.sum3(u,i.scaled3(c,h)),rotations:p,maxGrade:d}));else this._weaponSlots.push(new WeaponSlot(s.weaponSlots[l]));if(this._maxPropulsionGrade=o?s.maxPropulsionGrade||o._maxPropulsionGrade:s.maxPropulsionGrade||_showMissingPropertyError(this,"maxPropulsionGrade"),this._thrusterSlots=o&&!s.thrusterSlots?o._thrusterSlots:[],s.thrusterSlots)for(l=0;l<s.thrusterSlots.length;l++){if(g=s.thrusterSlots[l].group,m=s.thrusterSlots[l].uses,s.thrusterSlots[l].array)for(u=s.thrusterSlots[l].startPosition||_showMissingPropertyError(this,"thrusterSlot array startPosition"),c=s.thrusterSlots[l].translationVector||_showMissingPropertyError(this,"thrusterSlot array translationVector"),f=s.thrusterSlots[l].size||_showMissingPropertyError(this,"thrusterSlot array size"),_=s.thrusterSlots[l].count||_showMissingPropertyError(this,"thrusterSlot array count"),h=0;_>h;h++)this._thrusterSlots.push(new ThrusterSlot({position:i.sum3(u,i.scaled3(c,h)),size:f,groupIndex:g,uses:m}));if(s.thrusterSlots[l].thrusters)for(h=0;h<s.thrusterSlots[l].thrusters.length;h++)S=s.thrusterSlots[l].thrusters[h],S.groupIndex=g,S.uses=m,this._thrusterSlots.push(new ThrusterSlot(S))}if(this._views=o&&!s.views?o._views:[],s.views)for(l=0;l<s.views.length;l++)this._views.push(new ObjectView(s.views[l]));else o||_showMissingPropertyError(this,"views");if(this._equipmentProfiles=o&&!s.equipmentProfiles?o._equipmentProfiles:{},s.equipmentProfiles)for(l=0;l<s.equipmentProfiles.length;l++)this._equipmentProfiles[s.equipmentProfiles[l].name]=new EquipmentProfile(s.equipmentProfiles[l]);if(this._humSound=s.humSound?e.getVerifiedObject("spacecraftClasses['"+this._name+"'].humSound",s.humSound,B):o?o._humSound:null,this._explosionClass=o?s.explosion?getExplosionClass(s.explosion):o._explosionClass:getExplosionClass(s.explosion||_showMissingPropertyError(this,"explosion")),this._showTimeRatioDuringExplosion=o?s.showTimeRatioDuringExplosion||o._showTimeRatioDuringExplosion:s.showTimeRatioDuringExplosion||_showMissingPropertyError(this,"showTimeRatioDuringExplosion"),this._damageIndicators=o&&!s.damageIndicators?o._damageIndicators:[],s.damageIndicators)for(l=0;l<s.damageIndicators.length;l++)this._damageIndicators.push(new DamageIndicator(s.damageIndicators[l]));else o||_showMissingPropertyError(this,"damageIndicators");if(this._lightSources=o&&!s.lights?o._lightSources:[],s.lights)for(l=0;l<s.lights.length;l++)this._lightSources.push(new LightSourceDescriptor(s.lights[l]));else o||_showMissingPropertyError(this,"lights");if(this._blinkerDescriptors=o&&!s.blinkers?o._blinkerDescriptors:[],s.blinkers)for(l=0;l<s.blinkers.length;l++)this._blinkerDescriptors.push(new BlinkerDescriptor(s.blinkers[l]));else o||_showMissingPropertyError(this,"blinkers");this._scoreValue=o?s.scoreValue||o._scoreValue:s.scoreValue||_showMissingPropertyError(this,"scoreValue")||0},SpacecraftClass.prototype._loadData=function(t){var e;return t.basedOn?(e=getSpacecraftClass(t.basedOn),e.executeWhenReady(function(){this._overrideData(e,t)}.bind(this))):this._overrideData(null,t),!0},SpacecraftClass.prototype.getSpacecraftType=function(){return this._spacecraftType},SpacecraftClass.prototype.isFighterClass=function(){return this._spacecraftType.isFighterType()},SpacecraftClass.prototype.getDisplayName=function(){return p.get(p.SPACECRAFT_CLASS.PREFIX,this.getName()+p.SPACECRAFT_CLASS.NAME_SUFFIX.name,this._fullName)},SpacecraftClass.prototype.getDisplayDescription=function(){return p.get(p.SPACECRAFT_CLASS.PREFIX,this.getName()+p.SPACECRAFT_CLASS.DESCRIPTION_SUFFIX.name,t.formatString(p.get(p.DATABASE.MISSING_SPACECRAFT_CLASS_DESCRIPTION),{spacecraftClass:this.getDisplayName(),originalDescription:this._description}))},SpacecraftClass.prototype.shouldShowInDatabase=function(){return this._showInDatabase},SpacecraftClass.prototype.getHitpoints=function(){return this._hitpoints},SpacecraftClass.prototype.getArmor=function(){return this._armor},SpacecraftClass.prototype.getFactionColor=function(){return this._factionColor},SpacecraftClass.prototype.getTurnStyle=function(){return this._turnStyle},SpacecraftClass.prototype.getAttackVector=function(){return this._attackVector},SpacecraftClass.prototype.getAttackVectorAngles=function(){return this._attackVectorAngles},SpacecraftClass.prototype.getAttackThresholdAngle=function(){return this._attackThresholdAngle},SpacecraftClass.prototype.getMass=function(){return this._mass},SpacecraftClass.prototype.getBodies=function(){return this._bodies},SpacecraftClass.prototype.getWeaponSlots=function(){return this._weaponSlots},SpacecraftClass.prototype.getThrusterSlots=function(){return this._thrusterSlots},SpacecraftClass.prototype.getEquipmentProfile=function(t){return this._equipmentProfiles[t]},SpacecraftClass.prototype.getEquipmentProfileNames=function(){return Object.keys(this._equipmentProfiles)},SpacecraftClass.prototype.getViews=function(){return this._views},SpacecraftClass.prototype.getView=function(t){var e;for(e=0;e<this._views.length;e++)if(this._views[e].getName()===t)return this._views[e];return null},SpacecraftClass.prototype.getExplosionClass=function(){return this._explosionClass},SpacecraftClass.prototype.getShowTimeRatioDuringExplosion=function(){return this._showTimeRatioDuringExplosion},SpacecraftClass.prototype.getDamageIndicators=function(){return this._damageIndicators},SpacecraftClass.prototype.getLightSources=function(){return this._lightSources},SpacecraftClass.prototype.getBlinkerDescriptors=function(){return this._blinkerDescriptors},SpacecraftClass.prototype.acquireResources=function(t){var e;for(TexturedModelClass.prototype.acquireResources.call(this,t),this._explosionClass.acquireResources(),e=0;e<this._damageIndicators.length;e++)this._damageIndicators[e].explosionClass.acquireResources();for(e=0;e<this._blinkerDescriptors.length;e++)this._blinkerDescriptors[e].acquireResources();this._humSound&&_loadSoundEffect(this._humSound)},SpacecraftClass.prototype.handleGraphicsSettingsChanged=function(){var t;if(TexturedModelClass.prototype.handleGraphicsSettingsChanged.call(this),this._blinkerDescriptors)for(t=0;t<this._blinkerDescriptors.length;t++)this._blinkerDescriptors[t].handleGraphicsSettingsChanged()},SpacecraftClass.prototype.hasHumSound=function(){return!!this._humSound},SpacecraftClass.prototype.createHumSoundClip=function(t){return this._humSound?_createSoundClip(this._humSound,!0,t):null},SpacecraftClass.prototype.getScoreValue=function(){return this._scoreValue},d=new o.ResourceManager,{SHADER_VARIANT_INSTANCED_NAME:V,SOUND_EFFECT:F,ParticleEmitterType:g,ObjectViewLookAtMode:m,WeaponRotationStyle:S,SpacecraftTurnStyle:y,TexturedModelClass:TexturedModelClass,getSkyboxClass:getSkyboxClass,getBackgroundObjectClass:getBackgroundObjectClass,getDustCloudClass:getDustCloudClass,getExplosionClass:getExplosionClass,getProjectileClass:getProjectileClass,getWeaponClass:getWeaponClass,getPropulsionClass:getPropulsionClass,getJumpEngineClass:getJumpEngineClass,getSpacecraftType:getSpacecraftType,getSpacecraftClass:getSpacecraftClass,getSpacecraftClassesInArray:getSpacecraftClassesInArray,getClassCategories:getClassCategories,getClassNames:getClassNames,getClass:getClass,createClass:d.createResource.bind(d),EquipmentProfile:EquipmentProfile,ObjectView:ObjectView,SceneView:SceneView,requestLoad:requestLoad,handleGraphicsSettingsChanged:handleGraphicsSettingsChanged,executeForAllClasses:d.executeForAllResources.bind(d),renameClass:d.renameResource.bind(d),moveClassAfter:d.moveResourceAfter.bind(d)}}),define("armada/configuration",["utils/utils","utils/types","modules/async-resource","modules/scene/camera","armada/logic/classes"],function(t,e,i,r,n){"use strict";function ConfigurationContext(){i.AsyncResource.call(this),this._configuration=null,this._settings=null}var o,s,a,l,h,u,c,p={};return p.FILE_DESCRIPTOR={baseType:"object",properties:{FILENAME:{name:"filename",type:"string"},FOLDER:{name:"folder",type:"string"}}},p.LIGHT_SOURCE={baseType:"object",properties:{COLOR:{name:"color",type:e.COLOR3},DIRECTION:{name:"direction",type:e.VECTOR3}}},p.LAYOUT_DESCRIPTOR={baseType:"object",properties:{LEFT:{name:"left",type:"number",optional:!0},CENTER_X:{name:"centerX",type:"number",optional:!0},RIGHT:{name:"right",type:"number",optional:!0},TOP:{name:"top",type:"number",optional:!0},CENTER_Y:{name:"centerY",type:"number",optional:!0},BOTTOM:{name:"bottom",type:"number",optional:!0},WIDTH:{name:"width",type:"number",optional:!0},HEIGHT:{name:"height",type:"number",optional:!0},SCALE_MODE:{name:"scaleMode",type:"enum",values:t.ScaleMode},X_SCALE_MODE:{name:"xScaleMode",type:"enum",values:t.ScaleMode,optional:!0},Y_SCALE_MODE:{name:"yScaleMode",type:"enum",values:t.ScaleMode,optional:!0}}},p.TEXTURE_MAPPING={baseType:"array",elementType:e.VECTOR2,length:2},p.UI_IMAGE_DESCRIPTOR={baseType:"object",properties:{TEXTURE:{name:"texture",type:"string"},MAPPING:{name:"mapping",type:p.TEXTURE_MAPPING,optional:!0},SIZE:{name:"size",type:e.VECTOR2},SCALE_MODE:{name:"scaleMode",type:"enum",values:t.ScaleMode},COLOR:{name:"color",type:e.COLOR4}}},p.UI_LAID_OUT_IMAGE_DESCRIPTOR={baseType:"object",properties:{TEXTURE:{name:"texture",type:"string"},MAPPING:{name:"mapping",type:p.TEXTURE_MAPPING},LAYOUT:{name:"layout",type:p.LAYOUT_DESCRIPTOR},COLOR:{name:"color",type:e.COLOR4}}},p.TEXT_DESCRIPTOR={baseType:"object",properties:{COLOR:{name:"color",type:e.COLOR4},FONT_SIZE:{name:"fontSize",type:"number"},FONT_NAME:{name:"fontName",type:"string"},POSITION:{name:"position",type:e.VECTOR2},LAYOUT:{name:"layout",type:p.LAYOUT_DESCRIPTOR,optional:!0}}},p.CRAFT_INDICATOR_POSITIONS={baseType:"array",elementType:{baseType:"array",elementType:e.VECTOR2}},p.STRING_ARRAY={baseType:"array",elementType:"string"},p.getCustomDescriptor=function(e,i){var r,n,o,s,a=t.deepCopy(e);for(o=Object.keys(i),r=0;r<o.length;r++){for(s=a.properties[o[r]],a.properties[o[r]+"S"]={name:s.name+"s",type:{baseType:"object",properties:{}}},n=0;n<i[o[r]].length;n++)a.properties[o[r]+"S"].type.properties[i[o[r]][n].toUpperCase()]={name:i[o[r]][n],type:s.type};delete a.properties[o[r]]}return a},o={CLASSES_SOURCE_FILE:{name:"classes",type:p.FILE_DESCRIPTOR},ENVIRONMENTS_SOURCE_FILE:{name:"environments",type:p.FILE_DESCRIPTOR},MISSION_FILES:{name:"missions",type:{baseType:"object",properties:{FILENAME:{name:"filename",type:"string"},FOLDER:{name:"folder",type:"string"}}}}},s={USE_REQUEST_ANIM_FRAME:{name:"useRequestAnimFrame",type:"boolean",defaultValue:!0},DEFAULT_RANDOM_SEED:{name:"defaultRandomSeed",type:"number",defaultValue:4718},UNIFORM_LUMINOSITY_FACTORS_ARRAY_NAME:{name:"luminosityFactorsArrayName",type:"string",defaultValue:"luminosityFactors"},UNIFORM_GROUP_TRANSFORMS_ARRAY_NAME:{name:"groupTransformsArrayName",type:"string",defaultValue:"groupTransforms"},USE_VERTICAL_CAMERA_VALUES:{name:"useVerticalCameraValues",type:"boolean",defaultValue:!0},MENU_MUSIC:{name:"menuMusic",type:"string"},MUSIC_FADE_IN_DURATION:{name:"musicFadeInDuration",type:"number"},THEME_CROSSFADE_DURATION:{name:"themeCrossfadeDuration",type:"number"},MUSIC_FADE_OUT_DURATION:{name:"musicFadeOutDuration",type:"number"},BUTTON_SELECT_SOUND:{name:"buttonSelectSound",type:n.SOUND_EFFECT},BUTTON_CLICK_SOUND:{name:"buttonClickSound",type:n.SOUND_EFFECT}},a={SHOW_LOADING_BOX_FIRST_TIME:{name:"showLoadingBoxFirstTime",type:"boolean",defaultValue:!0},SHOW_LOADING_BOX_ON_ITEM_CHANGE:{name:"showLoadingBoxOnItemChange",type:"boolean",defaultValue:!0},BACKGROUND_COLOR:{name:"backgroundColor",type:e.COLOR4,defaultValue:[0,0,0,0]},ITEM_VIEW_DISTANCE:{name:"itemViewDistance",type:"number",defaultValue:2e3},ITEM_VIEW_FOV:{name:"itemViewFOV",type:"number",defaultValue:60},ITEM_VIEW_SPAN:{name:"itemViewSpan",type:"number",defaultValue:.2},SHOW_WIREFRAME_MODEL:{name:"showWireframeModel",type:"boolean",defaultValue:!0},WIREFRAME_SHADER_NAME:{name:"wireframeShaderName",type:"string",defaultValue:"oneColorReveal"},WIREFRAME_COLOR:{name:"wireframeColor",type:e.COLOR4,defaultValue:[1,0,0,1]},SHOW_SOLID_MODEL:{name:"showSolidModel",type:"boolean",defaultValue:!0},SOLID_SHADER_NAME:{name:"solidShaderName",type:"string",defaultValue:"shadowMapReveal"},LIGHT_SOURCES:{name:"lightSources",type:"array",elementType:p.LIGHT_SOURCE,minLength:1,maxLength:2},EQUIPMENT_PROFILE_NAME:{name:"equipmentProfileName",type:"string",defaultValue:"default"},START_SIZE_FACTOR:{name:"startSizeFactor",type:"number",defaultValue:"1"},MIN_SIZE_FACTOR:{name:"minimumSizeFactor",type:"number",defaultValue:"0.9"},MAX_SIZE_FACTOR:{name:"maximumSizeFactor",type:"number",defaultValue:"1.6"},MODEL_AUTO_ROTATION:{name:"modelAutoRotation",type:"boolean",defaultValue:!0},MODEL_MOUSE_ROTATION:{name:"modelMouseRotation",type:"boolean",defaultValue:!0},ROTATION_FPS:{name:"rotationFPS",type:"number",defaultValue:60},ROTATION_REVEAL_START_ANGLE:{name:"rotationRevealStartAngle",type:e.ANGLE_DEGREES,defaultValue:90},ROTATION_START_ANGLE:{name:"rotationStartAngle",type:e.ANGLE_DEGREES,defaultValue:180},ROTATION_VIEW_ANGLE:{name:"rotationViewAngle",type:e.ANGLE_DEGREES,defaultValue:60},ROTATION_DURATION:{name:"rotationDuration",type:"number",defaultValue:4e3},ROTATION_MOUSE_SENSITIVITY:{name:"rotationMouseSensitivity",type:"number",defaultValue:1},MODEL_REVEAL_ANIMATION:{name:"modelRevealAnimation",type:"boolean",defaultValue:!0},REVEAL_COLOR:{name:"revealColor",type:e.COLOR4,defaultValue:[1,1,1,1]},REVEAL_FPS:{name:"revealFPS",type:"number",defaultValue:60},REVEAL_DURATION:{name:"revealDuration",type:e.DURATION,defaultValue:2e3},REVEAL_SOLID_DELAY_DURATION:{name:"revealSolidDelayDuration",type:e.DURATION,defaultValue:2e3},REVEAL_TRANSITION_LENGTH_FACTOR:{name:"revealTransitionLengthFactor",type:"number",defaultValue:.15},RENDER_FPS:{name:"databaseRenderFPS",type:"number",defaultValue:60}},l={RENDER_FPS:{name:"battleRenderFPS",type:"number",defaultValue:60},SIMULATION_STEPS_PER_SECOND:{name:"simulationStepsPerSecond",type:"number",defaultValue:60},PARTICLE_POOL_PREFILL_FACTOR:{name:"particlePoolPrefillFactor",type:"number"},PROJECTILE_POOL_PREFILL_FACTOR:{name:"projectilePoolPrefillFactor",type:"number"},EXPLOSION_POOL_PREFILL_FACTOR:{name:"explosionPoolPrefillFactor",type:"number"},MINIMUM_DUST_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumDustParticleCountForInstancing",type:"number",defaultValue:1},MINIMUM_EXPLOSION_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumExplosionParticleCountForInstancing",type:"number",defaultValue:1},MINIMUM_MUZZLE_FLASH_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumMuzzleFlashParticleCountForInstancing",type:"number",defaultValue:1},MINIMUM_PROJECTILE_COUNT_FOR_INSTANCING:{name:"minimumProjectileCountForInstancing",type:"number",defaultValue:1},MINIMUM_THRUSTER_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumThrusterParticleCountForInstancing",type:"number",defaultValue:1},MINIMUM_BLINKER_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumBlinkerParticleCountForInstancing",type:"number",defaultValue:1},VIEW_DISTANCE:{name:"viewDistance",type:"number",defaultValue:5e3},MOVE_TO_ORIGO_DISTANCE:{name:"moveToOrigoDistance",type:"number"},CAMERA_DEFAULT_TRANSITION_DURATION:{name:"cameraDefaultTransitionDuration",type:"number",defaultValue:1e3},CAMERA_DEFAULT_TRANSITION_STYLE:{name:"cameraDefaultTransitionStyle",type:"enum",values:r.Camera.TransitionStyle,defaultValue:r.Camera.TransitionStyle.SMOOTH},CAMERA_PILOTING_SWITCH_TRANSITION_DURATION:{name:"cameraPilotingSwitchTransitionDuration",type:"number",defaultValue:1e3},CAMERA_PILOTING_SWITCH_TRANSITION_STYLE:{name:"cameraPilotingSwitchTransitionStyle",type:"enum",values:r.Camera.TransitionStyle,defaultValue:r.Camera.TransitionStyle.SMOOTH},MOMENT_DURATION:{name:"momentDuration",type:e.DURATION,defaultValue:1},BACKGROUND_OBJECT_DISTANCE:{name:"backgroundObjectDistance",type:"number",defaultValue:4500},TURN_ACCELERATION_DURATION_S:{name:"turnAccelerationDurationInSeconds",type:e.DURATION},MAX_COMBAT_FORWARD_SPEED_FACTOR:{name:"maxCombatForwardSpeedFactor",type:"number"},MAX_COMBAT_REVERSE_SPEED_FACTOR:{name:"maxCombatReverseSpeedFactor",type:"number"},MAX_CRUISE_FORWARD_SPEED_FACTOR:{name:"maxCruiseForwardSpeedFactor",type:"number"},MAX_CRUISE_REVERSE_SPEED_FACTOR:{name:"maxCruiseReverseSpeedFactor",type:"number"},STRAFE_SPEED_FACTOR:{name:"strafeSpeedFactor",type:"number"},DEFAULT_MUZZLE_FLASH_DURATION:{name:"defaultMuzzleFlashDuration",type:e.DURATION,defaultValue:500},SELF_FIRE:{name:"selfFire",type:"boolean",defaultValue:!0},DEFAULT_EQUIPMENT_PROFILE_NAME:{name:"defaultEquipmentProfileName",type:"string",defaultValue:"default"},HITBOX_COLOR:{name:"hitboxColor",type:e.COLOR4,defaultValue:[0,.5,.5,.5]},HITBOX_TEXTURE_NAME:{name:"hitboxTexture",type:"string",defaultValue:"white"},HITBOX_SHADER_NAME:{name:"hitboxShader",type:"string",defaultValue:"oneColor"},SHOW_HITBOXES_FOR_HITCHECKS:{name:"showHitboxesForHitchecks",type:"boolean"},TARGET_VIEW_NAME:{name:"targetViewName",type:"string",defaultValue:"target"},TARGET_CHANGE_TRANSITION_DURATION:{name:"targetChangeTransitonDuration",type:e.DURATION,defaultValue:300},TARGET_CHANGE_TRANSITION_STYLE:{name:"targetChangeTransitionStyle",type:"enum",values:r.Camera.TransitionStyle},TARGET_ORDER_DURATION:{name:"targetOrderDuration",type:"number"},JUMP_PREPARE_VIEW_NAME:{name:"jumpPrepareViewName",type:"string"},JUMP_OUT_VIEW_NAME:{name:"jumpOutViewName",type:"string"},GAME_STATE_DISPLAY_DELAY:{name:"gameStateDisplayDelay",type:"number"},QUIT_DELAY_AFTER_JUMP_OUT:{name:"quitDelayAfterJumpOut",type:"number"},HUD:{name:"hud",TARGET_SWITCH_ANIMATION_DURATION:{name:"targetSwitchAnimationDuration",type:"number"},AIM_ASSIST_APPEAR_ANIMATION_DURATION:{name:"aimAssistAppearAnimationDuration",type:"number"},HULL_INTEGRITY_DECREASE_ANIMATION_DURATION:{name:"hullIntegrityDecreaseAnimationDuration",type:"number"},TARGET_HULL_INTEGRITY_DECREASE_ANIMATION_DURATION:{name:"targetHullIntegrityDecreaseAnimationDuration",type:"number"},SHIP_INDICATOR_HIGHLIGHT_ANIMATION_INTERVAL:{name:"shipIndicatorHighlightAnimationInterval",type:"number"},CENTER_CROSSHAIR:{name:"centerCrosshair",type:p.UI_IMAGE_DESCRIPTOR},CURSOR:{name:"cursor",type:p.getCustomDescriptor(p.UI_IMAGE_DESCRIPTOR,{MAPPING:["still","turn"]})},SHIP_ARROW:{name:"shipArrow",type:p.getCustomDescriptor(p.UI_IMAGE_DESCRIPTOR,{COLOR:["hostile","friendly","hostileHighlight","friendlyHighlight","newHostile","hostileTarget","friendlyTarget"],SIZE:["default","target"]})},SHIP_ARROW_POSITION_RADIUS:{name:"shipArrowPositionRadius",type:"number"},TARGET_ARROW_SWITCH_SCALE:{name:"targetArrowSwitchScale",type:"number"},SHIP_INDICATOR:{name:"shipIndicator",type:p.getCustomDescriptor(p.UI_IMAGE_DESCRIPTOR,{COLOR:["hostile","friendly","hostileHighlight","friendlyHighlight","newHostile","hostileTarget","friendlyTarget"],SIZE:["minimum","targetMinimum","maximum"]})},SHIP_INDICATOR_SIZE_FACTOR:{name:"shipIndicatorSizeFactor",type:"number"},TARGET_INDICATOR_SWITCH_SCALE:{name:"targetIndicatorSwitchScale",type:"number"},DISTANCE_TEXT_LAYER_LAYOUT:{name:"distanceTextLayerLayout",type:p.LAYOUT_DESCRIPTOR},DISTANCE_TEXT:{name:"distanceText",type:p.getCustomDescriptor(p.TEXT_DESCRIPTOR,{COLOR:["hostile","friendly"]})},AIM_ASSIST_INDICATOR:{name:"aimAssistIndicator",type:p.getCustomDescriptor(p.UI_IMAGE_DESCRIPTOR,{COLOR:["hostile","friendly","appear"]})},AIM_ASSIST_INDICATOR_APPEAR_SCALE:{name:"aimAssistIndicatorAppearScale",type:"number"},WEAPON_IMPACT_INDICATOR:{name:"weaponImpactIndicator",type:p.getCustomDescriptor(p.UI_IMAGE_DESCRIPTOR,{COLOR:["normal","outOfRange"]})},WEAPON_IMPACT_INDICATOR_SWITCH_SCALE:{name:"weaponImpactIndicatorSwitchScale",type:"number"},TARGET_VIEW_LAYOUT:{name:"targetViewLayout",type:p.LAYOUT_DESCRIPTOR},TARGET_VIEW_CAMERA_DISTANCE:{name:"targetViewCameraDistance",type:"number"},TARGET_VIEW_VIEW_DISTANCE:{name:"targetViewViewDistance",type:"number"},TARGET_VIEW_FOV:{name:"targetViewFOV",type:"number"},TARGET_VIEW_TARGET_ITEM_SHADER:{name:"targetViewTargetItemShader",type:"string"},TARGET_VIEW_TARGET_ITEM_FULL_INTEGRITY_COLOR:{name:"targetViewTargetItemFullIntegrityColor",type:e.COLOR4},TARGET_VIEW_TARGET_ITEM_HALF_INTEGRITY_COLOR:{name:"targetViewTargetItemHalfIntegrityColor",type:e.COLOR4},TARGET_VIEW_TARGET_ITEM_ZERO_INTEGRITY_COLOR:{name:"targetViewTargetItemZeroIntegrityColor",type:e.COLOR4},TARGET_INFO_BACKGROUND:{name:"targetInfoBackground",type:p.UI_LAID_OUT_IMAGE_DESCRIPTOR},TARGET_HULL_INTEGRITY_BAR:{name:"targetHullIntegrityBar",type:p.getCustomDescriptor(p.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["filled","empty"]})},TARGET_INFO_TEXT_LAYER_LAYOUT:{name:"targetInfoTextLayerLayout",type:p.LAYOUT_DESCRIPTOR},TARGET_INFO_TEXT:{name:"targetInfoText",type:p.getCustomDescriptor(p.TEXT_DESCRIPTOR,{COLOR:["hostile","friendly"],FONT_SIZE:["name","others"],POSITION:["name","class","team","firepower","distance","velocity"]})},WINGMEN_STATUS_BACKGROUND:{name:"wingmenStatusBackground",type:p.UI_LAID_OUT_IMAGE_DESCRIPTOR},WINGMEN_STATUS_HEADER_TEXT:{name:"wingmenStatusHeaderText",type:p.TEXT_DESCRIPTOR},WINGMEN_STATUS_CRAFT_INDICATOR:{name:"wingmenStatusCraftIndicator",type:p.getCustomDescriptor(p.UI_IMAGE_DESCRIPTOR,{MAPPING:["player","general","interceptor","bomber"],COLOR:["fullIntegrity","halfIntegrity","zeroIntegrity","destroyed","away"]})},WINGMEN_STATUS_CRAFT_POSITIONS:{name:"wigmenStatusCraftPositions",type:p.CRAFT_INDICATOR_POSITIONS},WINGMEN_STATUS_SQUAD_LAYOUT:{name:"wigmenStatusSquadLayout",type:p.LAYOUT_DESCRIPTOR},WINGMEN_STATUS_SQUAD_TEXT:{name:"wingmenStatusSquadText",type:p.TEXT_DESCRIPTOR},SPEED_BAR:{name:"speedBar",type:p.getCustomDescriptor(p.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["filled","empty","reverseFilled","reverseEmpty"]})},SPEED_BAR_BASE_MAX_SPEED_FACTOR:{name:"speedBarBaseMaxSpeedFactor",type:"number"},SPEED_BAR_DEFAULT_BASE_MAX_SPEED:{name:"speedBarDefaultBaseMaxSpeed",type:"number"},SPEED_BAR_MAX_SPEED_STEP_FACTOR:{name:"speedBarMaxSpeedStepFactor",type:"number"},SPEED_BAR_MAX_SPEED_STEP_BUFFER:{name:"speedBarMaxSpeedStepBuffer",type:"number"},SPEED_TEXT_LAYER_LAYOUT:{name:"speedTextLayerLayout",type:p.LAYOUT_DESCRIPTOR},SPEED_TEXT:{name:"speedText",type:p.getCustomDescriptor(p.TEXT_DESCRIPTOR,{COLOR:["forward","reverse"],POSITION:["maxForward","maxReverse"]})},SPEED_TARGET_INDICATOR:{name:"speedTargetIndicator",type:p.UI_IMAGE_DESCRIPTOR},HULL_INTEGRITY_BAR:{name:"hullIntegrityBar",type:p.getCustomDescriptor(p.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["filled","empty","filledWhenDecreasing","emptyWhenDecreasing"]})},FLIGHT_MODE_INDICATOR_BACKGROUND:{name:"flightModeIndicatorBackground",type:p.UI_LAID_OUT_IMAGE_DESCRIPTOR},FLIGHT_MODE_HEADER_TEXT:{name:"flightModeHeaderText",type:p.TEXT_DESCRIPTOR},FLIGHT_MODE_TEXT:{name:"flightModeText",type:p.getCustomDescriptor(p.TEXT_DESCRIPTOR,{COLOR:["free","combat","cruise"]})},DRIFT_ARROW:{name:"driftArrow",type:p.getCustomDescriptor(p.UI_IMAGE_DESCRIPTOR,{COLOR:["minSpeed","maxSpeed"]})},DRIFT_ARROW_POSITION_RADIUS:{name:"driftArrowPositionRadius",type:"number"},DRIFT_ARROW_MIN_SPEED:{name:"driftArrowMinSpeed",type:"number"},DRIFT_ARROW_MAX_SPEED_FACTOR:{name:"driftArrowMaxSpeedFactor",type:"number"},TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR:{name:"targetHullIntegrityQuickViewBar",type:p.getCustomDescriptor(p.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["hostileFilled","hostileEmpty","friendlyFilled","friendlyEmpty","filledWhenDecreasing"]})},HEADER_TEXT_LAYER_LAYOUT:{name:"headerTextLayerLayout",type:p.LAYOUT_DESCRIPTOR},SMALL_HEADER_TEXT:{name:"smallHeaderText",type:p.TEXT_DESCRIPTOR},BIG_HEADER_TEXT:{name:"bigHeaderText",type:p.TEXT_DESCRIPTOR},SUBHEADER_TEXT:{name:"subheaderText",type:p.TEXT_DESCRIPTOR},MESSAGE_BACKGROUND:{name:"messageBackground",type:p.UI_LAID_OUT_IMAGE_DESCRIPTOR},MESSAGE_TEXT:{name:"messageText",type:p.getCustomDescriptor(p.TEXT_DESCRIPTOR,{COLOR:["default","jump","alert","controlString"]})},MESSAGE_TEXT_MARGIN:{name:"messageTextMargin",type:"number"},TOP_LEFT_TEXT_LAYER_LAYOUT:{name:"topLeftTextLayerLayout",type:p.LAYOUT_DESCRIPTOR},SCORE_TEXT:{name:"scoreText",type:p.TEXT_DESCRIPTOR},OBJECTIVES_BACKGROUND:{name:"objectivesBackground",type:p.UI_LAID_OUT_IMAGE_DESCRIPTOR},OBJECTIVES_HEADER_TEXT:{name:"objectivesHeaderText",type:p.TEXT_DESCRIPTOR},OBJECTIVES_TEXT:{name:"objectivesText",type:p.getCustomDescriptor(p.TEXT_DESCRIPTOR,{COLOR:["inProgress","completed","failed"]})},OBJECTIVES_TEXT_OFFSET:{name:"objectivesTextOffset",type:"number"},MAX_OBJECTIVES_DISPLAYED:{name:"maxObjectivesDisplayed",type:"number"},ESCORTS_BACKGROUND:{name:"escortsBackground",type:p.UI_LAID_OUT_IMAGE_DESCRIPTOR},ESCORTS_HEADER_TEXT:{name:"escortsHeaderText",type:p.TEXT_DESCRIPTOR},ESCORTS_TEXT:{name:"escortsText",type:p.getCustomDescriptor(p.TEXT_DESCRIPTOR,{COLOR:["alive","away","destroyed"]})},ESCORTS_HULL_INTEGRITY_BAR:{name:"escortsHullIntegrityBar",type:p.getCustomDescriptor(p.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["fullIntegrity","halfIntegrity","zeroIntegrity","destroyed"]})},ESCORTS_TEXT_OFFSET:{name:"escortsTextOffset",type:"number"},MAX_ESCORTS_DISPLAYED:{name:"maxEscortsDisplayed",type:"number"},TARGET_SWITCH_SOUND:{name:"targetSwitchSound",type:n.SOUND_EFFECT},TARGET_SWITCH_DENIED_SOUND:{name:"targetSwitchDeniedSound",type:n.SOUND_EFFECT},FLIGHT_MODE_SWITCH_SOUND:{name:"flightModeSwitchSound",type:n.SOUND_EFFECT},MESSAGE_SOUND:{name:"messageSound",type:n.SOUND_EFFECT},NEW_HOSTILES_ALERT_SOUND:{name:"newHostilesAlertSound",type:n.SOUND_EFFECT},NEW_HOSTILES_ALERT_DURATION:{name:"newHostilesAlertDuration",type:"number"},NEW_HOSTILES_ALERT_BLINK_INTERVAL:{name:"newHostilesAlertBlinkInterval",type:"number"}},WEAPON_FIRE_SOUND_STACK_MINIMUM_DISTANCE:{name:"weaponFireSoundStackMinimumDistance",type:"number"},HIT_SOUND_STACKING_TIME_THRESHOLD:{name:"hitSoundStackingTimeThreshold",type:"number"},HIT_SOUND_STACKING_VOLUME_FACTOR:{name:"hitSoundStackingVolumeFactor",type:"number"},FIRE_SOUND_STACKING_TIME_THRESHOLD:{name:"fireSoundStackingTimeThreshold",type:"number"},FIRE_SOUND_STACKING_VOLUME_FACTOR:{name:"fireSoundStackingVolumeFactor",type:"number"},DEMO_FIGHTER_AI_TYPE:{name:"demoFighterAI",type:"string"},DEMO_SHIP_AI_TYPE:{name:"demoShipAI",type:"string"},DEMO_VIEW_SWITCH_INTERVAL:{name:"demoViewSwitchInterval",type:"number"},DEMO_DOUBLE_VIEW_SWITCH_CHANCE:{name:"demoDoubleViewSwitchChance",type:"number"},MUSIC_VOLUME_IN_MENUS:{name:"musicVolumeInMenus",type:"number"},SFX_VOLUME_IN_MENUS:{name:"sfxVolumeInMenus",type:"number"},AMBIENT_MUSIC:{name:"ambientMusic",type:"string"},ANTICIPATION_MUSIC:{name:"anticipationMusic",type:"string"},COMBAT_MUSIC:{name:"combatMusic",type:p.STRING_ARRAY},VICTORY_MUSIC:{name:"victoryMusic",type:"string"},DEFEAT_MUSIC:{name:"defeatMusic",type:"string"},DEBRIEFING_VICTORY_MUSIC:{name:"debriefingVictoryMusic",type:"string"},DEBRIEFING_DEFEAT_MUSIC:{name:"debriefingDefeatMusic",type:"string"},COMBAT_THEME_DURATION_AFTER_FIRE:{name:"combatThemeDurationAfterFire",type:"number"},END_THEME_CROSSFADE_DURATION:{name:"endThemeCrossfadeDuration",type:"number"},DEBRIEFING_THEME_FADE_IN_DURATION:{name:"debriefingThemeFadeInDuration",type:"number"},SCORE_FRACTION_FOR_KILL:{name:"scoreFractionForKill",type:{baseType:"number",range:[0,1]}},SCORE_BONUS_FOR_HULL_INTEGRITY:{name:"scoreBonusForHullIntegrity",type:"number"},SCORE_BONUS_FOR_HULL_INTEGRITY_TEAM:{name:"scoreBonusForHullIntegrityTeam",type:"number"},SCORE_BONUS_FOR_TEAM_SURVIVAL:{name:"scoreBonusForTeamSurvival",type:"number"}},h={DEFAULT_FOV:{name:"defaultFOV",type:"number"},DEFAULT_FOV_RANGE:{name:"defaultFOVRange",type:e.VECTOR2},DEFAULT_SPAN:{name:"defaultSpan",type:"number"},DEFAULT_SPAN_RANGE:{name:"defaultSpanRange",type:e.VECTOR2},DEFAULT_BASE_ORIENTATION:{name:"defaultBaseOrientation",type:"enum",values:r.CameraOrientationConfiguration.BaseOrientation},DEFAULT_POINT_TO_FALLBACK:{name:"defaultPointToFallback",type:"enum",values:r.CameraOrientationConfiguration.PointToFallback}},u={DEFAULT_PARTICLE_SHADER:{name:"defaultParticleShader",type:"string"}},Object.freeze(p),ConfigurationContext.prototype=new i.AsyncResource,ConfigurationContext.prototype.constructor=ConfigurationContext,ConfigurationContext.prototype.loadConfigurationFromJSON=function(t){this._configuration=e.getVerifiedObject("configuration",t,o)},ConfigurationContext.prototype.getConfigurationSetting=function(t){return this._configuration[t.name]},ConfigurationContext.prototype.getSetting=function(t){return this._settings[t.name]},ConfigurationContext.prototype.getHUDSetting=function(t){return this._settings[l.HUD.name][t.name]},ConfigurationContext.prototype.getDefaultCameraFOV=function(){return this.getSetting(h.DEFAULT_FOV)},ConfigurationContext.prototype.getDefaultCameraFOVRange=function(){return this.getSetting(h.DEFAULT_FOV_RANGE)},ConfigurationContext.prototype.getDefaultCameraSpan=function(){return this.getSetting(h.DEFAULT_SPAN)},ConfigurationContext.prototype.getDefaultCameraSpanRange=function(){return this.getSetting(h.DEFAULT_SPAN_RANGE)},ConfigurationContext.prototype.getDefaultCameraBaseOrientation=function(){return this.getSetting(h.DEFAULT_BASE_ORIENTATION)},ConfigurationContext.prototype.getDefaultCameraPointToFallback=function(){return this.getSetting(h.DEFAULT_POINT_TO_FALLBACK)},ConfigurationContext.prototype.loadSettingsFromJSON=function(t){this._settings=e.getVerifiedObject("general",t.general,s),e.getVerifiedObject("database",t.database,a,this._settings),e.getVerifiedObject("battle",t.battle,l,this._settings),e.getVerifiedObject("camera",t.camera,h,this._settings),e.getVerifiedObject("editor",t.editor,u,this._settings),n.requestLoad(this.getConfigurationSetting(o.CLASSES_SOURCE_FILE),function(){this.setToReady()}.bind(this))},c=new ConfigurationContext,{CONFIGURATION:o,GENERAL_SETTINGS:s,BATTLE_SETTINGS:l,DATABASE_SETTINGS:a,CAMERA_SETTINGS:h,EDITOR_SETTINGS:u,loadConfigurationFromJSON:c.loadConfigurationFromJSON.bind(c),loadSettingsFromJSON:c.loadSettingsFromJSON.bind(c),getConfigurationSetting:c.getConfigurationSetting.bind(c),getSetting:c.getSetting.bind(c),getHUDSetting:c.getHUDSetting.bind(c),getDefaultCameraFOV:c.getDefaultCameraFOV.bind(c),getDefaultCameraFOVRange:c.getDefaultCameraFOVRange.bind(c),getDefaultCameraSpan:c.getDefaultCameraSpan.bind(c),getDefaultCameraSpanRange:c.getDefaultCameraSpanRange.bind(c),getDefaultCameraBaseOrientation:c.getDefaultCameraBaseOrientation.bind(c),getDefaultCameraPointToFallback:c.getDefaultCameraPointToFallback.bind(c),executeWhenReady:c.executeWhenReady.bind(c)}}),define("armada/audio",["utils/types","modules/application","modules/async-resource","modules/audio","modules/media-resources","armada/constants","armada/configuration","utils/polyfill"],function(t,e,i,r,n,o,s){"use strict";function AudioSettingsContext(){i.AsyncResource.call(this),this._dataJSON=null,this._masterVolume=1,this._musicVolume=1,this._sfxVolume=1,this._uiVolume=1,this._rolloffFactor=0,this._panningModel=null}function initMusic(t,i,r){var o;S[i]&&S[i].name===t||(o=n.getMusic(t),o&&!o.hasError()?n.executeWhenReady(function(){S[i]={name:t,clip:o.createSoundClip(1,r)}}):e.log("Could not initialize music from resource '"+t+"' for theme ID '"+i+"'!"))}function playMusic(t,i,r){void 0===r&&(r=f?t?l:h:t?a:0),t!==f&&(f&&S[f]&&(r>0?S[f].clip.rampVolume(0,r):S[f].clip.stopPlaying()),t&&(S[t]?(S[t].clip.play(!0,i?function(){f===t&&playMusic(i,null,r)}:null),r>0?(S[t].clip.setVolume(0),S[t].clip.rampVolume(1,r)):S[t].clip.setVolume(1)):e.log("Warning: music associated with theme '"+t+"' cannot be played, because it is not loaded!")),f=t)}function stopMusic(){var t,e=Object.keys(S);
for(t=0;t<e.length;t++)S[e[t]]&&S[e[t]].clip.stopPlaying();f=null}var a,l,h,u,c=o.LOCAL_STORAGE_PREFIX+"audio_",p=.1,d=c+"masterVolume",_=c+"musicVolume",g=c+"sfxVolume",m=c+"uiVolume",f=null,S={};return AudioSettingsContext.prototype=new i.AsyncResource,AudioSettingsContext.prototype.constructor=AudioSettingsContext,AudioSettingsContext.prototype.loadConfigurationFromJSON=function(e){e.rolloffFactor&&(this._rolloffFactor=t.getNumberValue("configuration.audio.rolloffFactor",e.rolloffFactor,0)),e.panningModel&&(this._panningModel=t.getEnumValue(r.PanningModel,e.panningModel,{name:"configuration.audio.panningModel"}))},AudioSettingsContext.prototype.loadSettingsFromJSON=function(i,r){return"object"!=typeof i?void e.showError("Cannot initialize audio settings from JSON: audio section missing or has wrong type ('"+typeof i+"')!"):(r=r||!1,r||(this._dataJSON=i),this.setMasterVolume(t.getNumberValue("settings.audio.masterVolume",i.masterVolume,1),!1),this.setMusicVolume(t.getNumberValue("settings.audio.musicVolume",i.musicVolume,1),!1),this.setSFXVolume(t.getNumberValue("settings.audio.sfxVolume",i.sfxVolume,1),!1),void this.setUIVolume(t.getNumberValue("settings.audio.uiVolume",i.uiVolume,1),!1))},AudioSettingsContext.prototype.loadFromLocalStorage=function(){var i,r,n=function(n,o,s,a){void 0!==localStorage[n]&&(r={silentFallback:e.hasVersionChanged(),defaultValue:s},i=t.getValueOfTypeFromLocalStorage(o,n,r),(!r.error||e.hasVersionChanged())&&a(i,!!r.error&&r.error!==t.Errors.INVALID_ENUM_OBJECT_ERROR))};n(d,"number",this.getMasterVolume(),this.setMasterVolume.bind(this)),n(_,"number",this.getMusicVolume(),this.setMusicVolume.bind(this)),n(g,"number",this.getSFXVolume(),this.setSFXVolume.bind(this)),n(m,"number",this.getUIVolume(),this.setUIVolume.bind(this)),this.setToReady()},AudioSettingsContext.prototype.restoreDefaults=function(){this.loadSettingsFromJSON(this._dataJSON,!0),localStorage.removeItem(d),localStorage.removeItem(_),localStorage.removeItem(g),localStorage.removeItem(m)},AudioSettingsContext.prototype.getMasterVolume=function(){return this._masterVolume},AudioSettingsContext.prototype.setMasterVolume=function(t,e){return void 0===e&&(e=!0),this._masterVolume=t,r.setMasterVolume(this._masterVolume),e&&(localStorage[d]=t.toString()),this._masterVolume===t},AudioSettingsContext.prototype.resetMasterVolume=function(){this.setMasterVolume(void 0!==localStorage[d]?localStorage[d]:this._dataJSON.masterVolume)},AudioSettingsContext.prototype.getMusicVolume=function(){return this._musicVolume},AudioSettingsContext.prototype.setMusicVolume=function(t,e){return void 0===e&&(e=!0),this._musicVolume=t,r.setMusicVolume(this._musicVolume),e&&(localStorage[_]=t.toString()),this._musicVolume===t},AudioSettingsContext.prototype.resetMusicVolume=function(){this.setMusicVolume(void 0!==localStorage[_]?localStorage[_]:this._dataJSON.musicVolume)},AudioSettingsContext.prototype.getSFXVolume=function(){return this._sfxVolume},AudioSettingsContext.prototype.setSFXVolume=function(t,e){return void 0===e&&(e=!0),this._sfxVolume=t,r.setEffectVolume(this._sfxVolume),e&&(localStorage[g]=t.toString()),this._sfxVolume===t},AudioSettingsContext.prototype.resetSFXVolume=function(){this.setSFXVolume(void 0!==localStorage[g]?localStorage[g]:this._dataJSON.sfxVolume)},AudioSettingsContext.prototype.getUIVolume=function(){return this._uiVolume},AudioSettingsContext.prototype.setUIVolume=function(t,e){return void 0===e&&(e=!0),this._uiVolume=t,r.setUIVolume(this._uiVolume),e&&(localStorage[m]=t.toString()),this._uiVolume===t},AudioSettingsContext.prototype.resetUIVolume=function(){this.setUIVolume(void 0!==localStorage[m]?localStorage[m]:this._dataJSON.uiVolume)},AudioSettingsContext.prototype.createSoundSource=function(t){return new r.SoundSource(t,this._rolloffFactor,this._panningModel)},u=new AudioSettingsContext,s.executeWhenReady(function(){a=s.getSetting(s.GENERAL_SETTINGS.MUSIC_FADE_IN_DURATION),l=s.getSetting(s.GENERAL_SETTINGS.THEME_CROSSFADE_DURATION),h=s.getSetting(s.GENERAL_SETTINGS.MUSIC_FADE_OUT_DURATION)}),{SOUND_RAMP_DURATION:p,SoundCategory:r.SoundCategory,loadConfigurationFromJSON:u.loadConfigurationFromJSON.bind(u),loadSettingsFromJSON:u.loadSettingsFromJSON.bind(u),loadSettingsFromLocalStorage:u.loadFromLocalStorage.bind(u),restoreDefaults:u.restoreDefaults.bind(u),getMasterVolume:u.getMasterVolume.bind(u),setMasterVolume:u.setMasterVolume.bind(u),resetMasterVolume:u.resetMasterVolume.bind(u),getMusicVolume:u.getMusicVolume.bind(u),setMusicVolume:u.setMusicVolume.bind(u),resetMusicVolume:u.resetMusicVolume.bind(u),getSFXVolume:u.getSFXVolume.bind(u),setSFXVolume:u.setSFXVolume.bind(u),resetSFXVolume:u.resetSFXVolume.bind(u),getUIVolume:u.getUIVolume.bind(u),setUIVolume:u.setUIVolume.bind(u),resetUIVolume:u.resetUIVolume.bind(u),createSoundSource:u.createSoundSource.bind(u),executeWhenReady:u.executeWhenReady.bind(u),initMusic:initMusic,playMusic:playMusic,stopMusic:stopMusic}}),define("armada/logic/environments",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/async-resource","modules/media-resources","modules/scene/renderable-objects","modules/scene/lights","modules/scene/scene-graph","armada/graphics","armada/logic/classes","armada/configuration","armada/strings","utils/polyfill"],function(t,e,i,r,n,o,s,a,l,h,u,c,p){"use strict";function getDebugInfo(){return g}function Skybox(t){this._class=t}function BackgroundObject(t,e,i,r,n){this._class=t,this._size=e,this._direction=[Math.cos(Math.radians(i))*Math.cos(Math.radians(r)),Math.sin(Math.radians(i))*Math.cos(Math.radians(r)),Math.sin(Math.radians(r))],this._angle=Math.radians(n)||0}function DustParticle(t,e){this._positionVector=e,this._visualModel=null,this._cloud=t,this._range=t.getRange()}function DustCloud(t){this._class=t,this._particles=null,this._visualModel=null}function Environment(t){this._name=null,this._location=null,this._skyboxes=null,this._backgroundObjects=null,this._dustClouds=null,this._camera=null,this._dataJSON=null,void 0!==t&&this.loadFromJSON(t)}function EnvironmentContext(){n.AsyncResource.call(this),this._environments=null}var d,_="environments",g="";return Skybox.prototype.addToScene=function(t){this._class.acquireResources(),o.executeWhenReady(function(){t.addBackgroundObject(new s.CubemapSampledFVQ(this._class.getModel(),this._class.getShader(),this._class.getShader().getCubemapNames()[0],this._class.getCubemap(h.getCubemapQualityPreferenceList()),t._camera))}.bind(this))},Skybox.prototype.destroy=function(){this._class=null},BackgroundObject.prototype.addToScene=function(t){t.addDirectionalLightSource(new a.DirectionalLightSource(this._class.getLightColor(),this._direction)),this._class.acquireResources(),o.executeWhenReady(function(){var r,n,o;for(n=this._class.getLayers(),r=0;r<n.length;r++)o=new s.BackgroundBillboard(n[r].getModel(),n[r].getShader(),n[r].getTexturesOfTypes(n[r].getShader().getTextureTypes(),h.getTextureQualityPreferenceList()),n[r].getColor(),n[r].getSize()*this._size,i.translation4v(e.scaled3(this._direction,c.getSetting(c.BATTLE_SETTINGS.BACKGROUND_OBJECT_DISTANCE))),this._angle),o.setRelativeSize(1),t.addBackgroundObject(o)}.bind(this))},BackgroundObject.prototype.destroy=function(){this._class=null,this._direction=null},DustParticle.prototype.addToScene=function(t,e){this._visualModel=new s.PointParticle(this._cloud.getClass().getModel(),this._cloud.getClass().getShader(),this._cloud.getClass().getInstancedShader(),this._positionVector,e?this._cloud.getClass().getColor():null,e?this._range:null),t.addSubnode(new l.RenderableNode(this._visualModel,!1,!1,c.getSetting(c.BATTLE_SETTINGS.MINIMUM_DUST_PARTICLE_COUNT_FOR_INSTANCING)))},DustParticle.prototype.getVisualModel=function(){return this._visualModel},DustParticle.prototype.simulate=function(t){this._visualModel.fitPositionWithinRange(t.getCameraPositionMatrix(),this._range)},DustParticle.prototype.destroy=function(){this._positionVector=null,this._visualModel&&(this._visualModel.getNode().markAsReusable(!0),this._visualModel=null),this._cloud=null},DustCloud.prototype.getClass=function(){return this._class},DustCloud.prototype.getColor=function(){return this._class.getColor().concat(1)},DustCloud.prototype.getRange=function(){return this._class.getRange()},DustCloud.prototype.addToScene=function(t){var e,i,r;for(this._class.acquireResources(),this._particles=[],i=this._class.getNumberOfParticles(),e=0;i>e;e++)r=new DustParticle(this,[2*(Math.random()-.5)*this._class.getRange(),2*(Math.random()-.5)*this._class.getRange(),2*(Math.random()-.5)*this._class.getRange()]),this._particles.push(r);o.executeWhenReady(function(){var e,r;for(this._visualModel=new s.RenderableObject(null,!1,!1,void 0,!1),r=t.addNode(new l.RenderableNode(this._visualModel,!1,!0)),e=0;i>e;e++)this._particles[e].addToScene(r,0===e)}.bind(this))},DustCloud.prototype.simulate=function(t){var e,i;for(i=this._class.getNumberOfParticles(),this._particles[0]._visualModel.setShift(t.getVelocityVector()[0],t.getVelocityVector()[1],t.getVelocityVector()[2]),e=0;i>e;e++)this._particles[e].simulate(t)},DustCloud.prototype.destroy=function(){var t,e;if(e=this._class.getNumberOfParticles(),this._class=null,this._particles){for(t=0;e>t;t++)this._particles[t].destroy(),this._particles[t]=null;this._particles=null}this._visualModel&&(this._visualModel.getNode().markAsReusable(!0),this._visualModel=null)},Environment.prototype.loadFromJSON=function(t){var e,i;for(this._dataJSON=t,this._name=t.name,this._location=t.location,this._skyboxes=[],e=0;e<t.skyboxes.length;e++)this._skyboxes.push(new Skybox(u.getSkyboxClass(t.skyboxes[e]["class"])));for(this._backgroundObjects=[],e=0;e<t.backgroundObjects.length;e++)i=u.getBackgroundObjectClass(t.backgroundObjects[e]["class"]),t.backgroundObjects[e].position||r.showError("No position specified for background object of class '"+i.getName()+"' in environment '"+this._name+"'!",r.ErrorSeverity.MINOR),this._backgroundObjects.push(new BackgroundObject(i,t.backgroundObjects[e].size||r.showError("No size specified for background object of class '"+i.getName()+"' in environment '"+this._name+"'!",r.ErrorSeverity.MINOR)||0,t.backgroundObjects[e].position&&t.backgroundObjects[e].position.angleAlpha||0,t.backgroundObjects[e].position&&t.backgroundObjects[e].position.angleBeta||0,t.backgroundObjects[e].position&&t.backgroundObjects[e].position.angleGamma||0));for(this._dustClouds=[],e=0;e<t.dustClouds.length;e++)this._dustClouds.push(new DustCloud(u.getDustCloudClass(t.dustClouds[e]["class"])))},Environment.prototype.getDisplayName=function(){return this._location?t.formatString(p.get(p.LOCATION.SYSTEM),{systemName:this._location}):p.get(p.LOCATION.UNKNOWN)},Environment.prototype.getData=function(){return this._dataJSON},Environment.prototype.reloadData=function(){this.loadFromJSON(this._dataJSON)},Environment.prototype.addToScene=function(t){var e;for(e=0;e<this._skyboxes.length;e++)this._skyboxes[e].addToScene(t);for(e=0;e<this._backgroundObjects.length;e++)this._backgroundObjects[e].addToScene(t);for(e=0;e<this._dustClouds.length;e++)this._dustClouds[e].addToScene(t);this._camera=t._camera},Environment.prototype.simulate=function(){var t;if(this._camera)for(t=0;t<this._dustClouds.length;t++)this._dustClouds[t].simulate(this._camera)},Environment.prototype.removeFromScene=function(){this._camera=null},Environment.prototype.destroy=function(){var t;if(this._skyboxes){for(t=0;t<this._skyboxes.length;t++)this._skyboxes[t].destroy(),this._skyboxes[t]=null;this._skyboxes=null}if(this._backgroundObjects){for(t=0;t<this._backgroundObjects.length;t++)this._backgroundObjects[t].destroy(),this._backgroundObjects[t]=null;this._backgroundObjects=null}if(this._dustClouds){for(t=0;t<this._dustClouds.length;t++)this._dustClouds[t].destroy(),this._dustClouds[t]=null;this._dustClouds=null}this._camera=null},EnvironmentContext.prototype=new n.AsyncResource,EnvironmentContext.prototype.constructor=EnvironmentContext,EnvironmentContext.prototype.getEnvironment=function(t){return this._environments[t]||null},EnvironmentContext.prototype.getEnvironmentNames=function(){return Object.keys(this._environments)},EnvironmentContext.prototype.createEnvironment=function(t){this._environments[t.name]=new Environment(t)},EnvironmentContext.prototype.executeForAllEnvironments=function(t){var e,i=this.getEnvironmentNames();for(e=0;e<i.length;e++)t(this._environments[i[e]],_)},EnvironmentContext.prototype.requestLoad=function(){r.requestTextFile(c.getConfigurationSetting(c.CONFIGURATION.ENVIRONMENTS_SOURCE_FILE).folder,c.getConfigurationSetting(c.CONFIGURATION.ENVIRONMENTS_SOURCE_FILE).filename,function(t){this.loadEnvironmentsFromJSON(JSON.parse(t)),this.setToReady()}.bind(this))},EnvironmentContext.prototype.loadEnvironmentsFromJSON=function(t){var e,i;for(this._environments={},e=0;e<t.environments.length;e++)i=new Environment(t.environments[e]),this._environments[t.environments[e].name]=i},d=new EnvironmentContext,{requestLoad:d.requestLoad.bind(d),executeWhenReady:d.executeWhenReady.bind(d),getDebugInfo:getDebugInfo,getEnvironment:d.getEnvironment.bind(d),getEnvironmentNames:d.getEnvironmentNames.bind(d),createEnvironment:d.createEnvironment.bind(d),executeForAllEnvironments:d.executeForAllEnvironments.bind(d),Skybox:Skybox,Environment:Environment}}),define("modules/pools",[],function(){"use strict";function Pool(t){this._objectConstructor=t,this._objects=[],this._objectsFree=[],this._freeIndices=[],this._firstFreeIndex=0,this._firstLockedIndex=0}function getPool(e){var i=t[e.name]||new Pool(e);return t[e.name]=i,i}var t={};return Pool.prototype.markAsFree=function(t){this._objectsFree[t]||(this._freeIndices[this._firstLockedIndex]=t,this._objectsFree[t]=!0,this._firstLockedIndex++,this._firstLockedIndex>=this._freeIndices.length&&(this._firstLockedIndex=0))},Pool.prototype.getFreeObject=function(){var t;return this._objectsFree[this._freeIndices[this._firstFreeIndex]]?(this._objectsFree[this._freeIndices[this._firstFreeIndex]]=!1,t=this._objects[this._freeIndices[this._firstFreeIndex]],this._firstFreeIndex++,this._firstFreeIndex>=this._freeIndices.length&&(this._firstFreeIndex=0),t):null},Pool.prototype.addObject=function(t){this._objects.push(t),this._objectsFree.push(!1),this._firstFreeIndex<this._firstLockedIndex||this._firstFreeIndex===this._firstLockedIndex&&!this._objectsFree[this._freeIndices[this._firstFreeIndex]]?this._freeIndices.push(-1):(this._freeIndices.splice(this._firstLockedIndex,0,-1),this._firstFreeIndex++,this._firstFreeIndex>=this._freeIndices.length&&(this._firstFreeIndex=0))},Pool.prototype.getObjects=function(){return this._objects},Pool.prototype.getObject=function(){var t=this.getFreeObject();return t||(t=new this._objectConstructor,this.addObject(t)),t},Pool.prototype.hasLockedObjects=function(){return this._firstFreeIndex!==this._firstLockedIndex||!this._objectsFree[this._freeIndices[this._firstFreeIndex]]},Pool.prototype.getLockedObjectCount=function(){return this._firstFreeIndex===this._firstLockedIndex?this._objectsFree[this._freeIndices[this._firstFreeIndex]]?0:this._objects.length:this._firstFreeIndex<this._firstLockedIndex?this._objects.length-(this._firstLockedIndex-this._firstFreeIndex):this._firstFreeIndex-this._firstLockedIndex},Pool.prototype.executeForLockedObjects=function(t){var e,i=this._freeIndices.length;if(i>0)for(e=0;i>e;e++)this._objectsFree[e]||t(this._objects[e],e)},Pool.prototype.clear=function(){this._objects=[],this._objectsFree=[],this._freeIndices=[],this._firstFreeIndex=0,this._firstLockedIndex=0},Pool.prototype.prefill=function(t,e){var i;for(this._objects.length>0&&this.clear(),this._objects=new Array(t),this._objectsFree=new Array(t),this._freeIndices=new Array(t),i=0;t>i;i++)this._objects[i]=new this._objectConstructor,this._objectsFree[i]=!0,this._freeIndices[i]=i;if(e)for(i=0;t>i;i++)e(this._objects[i],i);this._firstFreeIndex=0,this._firstLockedIndex=0},{Pool:Pool,getPool:getPool}}),define("armada/logic/SpacecraftEvents",[],function(){"use strict";return{BEING_TARGETED:"beingTargeted",BEING_HIT:"beingHit",TARGET_HIT:"targetHit",ANY_SPACECRAFT_HIT:"anySpacecraftHit",TARGET_FIRED:"targetFired",FIRED:"fired",DESTRUCTED:"destructed",JUMP_ENGAGED:"jumpEngaged",PREPARING_JUMP:"preparingJump",JUMP_OUT_STARTED:"jumpOutStarted",JUMPED_OUT:"jumpedOut",JUMPED_IN:"jumpedIn",ARRIVED:"arrived",JUMP_CANCELLED:"jumpCancelled",COMMAND_RECEIVED:"commandReceived"}}),define("armada/logic/constants",[],function(){"use strict";var t=0,e=1,i=2,r=3;return{SPACECRAFT_LIGHT_PRIORITY:t,EXPLOSION_LIGHT_PRIORITY:e,PROJECTILE_LIGHT_PRIORITY:i,BLINKER_LIGHT_PRIORITY:r}}),define("modules/scene/particle-system",["utils/vectors","utils/matrices","modules/scene/renderable-objects","modules/scene/scene-graph"],function(t,e,i,r){"use strict";function ParticleEmitter(t,e,i,r,n,o,s,a,l,h,u){this._positionMatrix=t,this._orientationMatrix=e,this._dimensions=i,this._velocity=r,this._velocitySpread=n,this._initialNumber=o,this._spawnNumber=s,this._spawnTime=a,this._age=0,this._duration=l,this._delay=h||0,this._lastSpawn=0,this._createParticleFunction=u,this._particleDuration=-1,this._size=0,t&&this._calculateSize()}function OmnidirectionalParticleEmitter(t,e,i,r,n,o,s,a,l,h,u){ParticleEmitter.call(this,t,e,i,r,n,o,s,a,l,h,u),this._calculateSize()}function UnidirectionalParticleEmitter(t,e,i,r,n,o,s,a,l,h,u,c,p){ParticleEmitter.call(this,t,e,i,o,s,a,l,h,u,c,p),this._direction=r,this._directionSpread=n}function PlanarParticleEmitter(t,e,i,r,n,o,s,a,l,h,u,c,p){ParticleEmitter.call(this,t,e,i,o,s,a,l,h,u,c,p),this._planeNormal=r,this._directionSpread=n}function ParticleSystem(t,e,r,n,o,s,a,l,h,u){i.RenderableObject3D.call(this,null,!1,!0,t,e,r,void 0,1,!0),this._velocityMatrix=n,this._emitters=o,this._age=0,this._duration=s,this._keepAlive=a===!0,this._carriesParticles=l===!0,this._minimumCountForInstancing=h,this._particleCountFactor=void 0!==u?u:1,this._calculateSize()}return ParticleEmitter.prototype._calculateSize=function(){var i=this._createParticleFunction();this._size=e.translationLength(this._positionMatrix)+t.length3(this._dimensions)+Math.max((this._velocity+.5*this._velocitySpread)*i._duration*.001+i.getFinalSize(),i.getMaxSize()),i.markAsReusable(!0)},ParticleEmitter.prototype.getSize=function(){return this._size},ParticleEmitter.prototype.getDuration=function(){return this._duration},ParticleEmitter.prototype.getParticleDuration=function(){var t;return-1===this._particleDuration&&(this._particleDuration=0,t=this._createParticleFunction(),this._particleDuration=t._duration,t.markAsReusable(!0)),this._particleDuration},ParticleEmitter.prototype._emitParticle=function(){var e,i;return e=this._createParticleFunction(),i=[this._positionMatrix[12]+(Math.random()-.5)*this._dimensions[0],this._positionMatrix[13]+(Math.random()-.5)*this._dimensions[1],this._positionMatrix[14]+(Math.random()-.5)*this._dimensions[2]],e.setPositionv(t.prodVec3Mat4Aux(i,this._orientationMatrix)),e},ParticleEmitter.prototype.emitParticles=function(t,e){var i,r,n;if(i=[],void 0===e&&(e=1),this._delay>0&&(this._delay-=t,this._delay<=0&&(t=-this._delay,this._delay=0)),0===this._delay){if(0===this._age)for(n=Math.round(this._initialNumber*e),this._initialNumber>0&&1>n&&(n=1),r=0;n>r;r++)i.push(this._emitParticle());for(this._age+=t;this._age-this._lastSpawn>this._spawnTime&&(this._lastSpawn<this._duration||0===this._duration);){for(n=Math.round(this._spawnNumber*e),this._spawnNumber>0&&1>n&&(n=1),r=0;n>r;r++)i.push(this._emitParticle());this._lastSpawn+=this._spawnTime}}return i},ParticleEmitter.prototype.addToContext=function(t){var e=this._createParticleFunction();e.addToContext(t),e.markAsReusable(!0)},OmnidirectionalParticleEmitter.prototype=new ParticleEmitter,OmnidirectionalParticleEmitter.prototype.constructor=OmnidirectionalParticleEmitter,OmnidirectionalParticleEmitter.prototype._emitParticle=function(){var i,r,n=ParticleEmitter.prototype._emitParticle.call(this);return i=this._velocity+(Math.random()-.5)*this._velocitySpread,r=e.translation4Aux(0,i,0),e.rotate4(r,t.UNIT3_X,2*Math.random()*Math.PI),e.rotate4(r,t.UNIT3_Z,2*Math.random()*Math.PI),n.setVelocityM(r),n},UnidirectionalParticleEmitter.prototype=new ParticleEmitter,UnidirectionalParticleEmitter.prototype.constructor=UnidirectionalParticleEmitter,UnidirectionalParticleEmitter.prototype._emitParticle=function(){var i,r,n,o=ParticleEmitter.prototype._emitParticle.call(this);return i=this._velocity+(Math.random()-.5)*this._velocitySpread,r=e.translation4vAux(t.scaled3(this._direction,i)),n=Math.abs(this._direction[0])<.75?[1,0,0]:Math.abs(this._direction[1])<.75?[0,1,0]:[0,0,1],t.mulCross3(n,this._direction),t.normalize3(n),e.rotate4(r,n,Math.random()*this._directionSpread/180*Math.PI),e.rotate4(r,this._direction,360*Math.random()/180*Math.PI),o.setVelocityM(r),o},PlanarParticleEmitter.prototype=new ParticleEmitter,PlanarParticleEmitter.prototype.constructor=UnidirectionalParticleEmitter,PlanarParticleEmitter.prototype._emitParticle=function(){var i,r,n,o=ParticleEmitter.prototype._emitParticle.call(this);return r=this._velocity+(Math.random()-.5)*this._velocitySpread,i=Math.abs(this._planeNormal[0])<.75?[1,0,0]:Math.abs(this._planeNormal[1])<.75?[0,1,0]:[0,0,1],t.mulCross3(i,this._planeNormal),t.normalize3(i),n=e.translation4vAux(t.scaled3(i,r)),e.rotate4(n,t.cross3(i,this._planeNormal),(Math.random()-.5)*this._directionSpread/180*Math.PI),e.rotate4(n,this._planeNormal,2*Math.random()*Math.PI),o.setVelocityM(n),o},ParticleSystem.prototype=new i.RenderableObject3D,ParticleSystem.prototype.constructor=ParticleSystem,ParticleSystem.prototype.init=function(t,e,r,n,o,s,a,l,h,u){i.RenderableObject3D.prototype.init.call(this,null,!1,!0,t,e,r,void 0,1,!0),this._velocityMatrix=n,this._emitters=o,this._age=0,this._duration=s,this._keepAlive=a===!0,this._carriesParticles=l===!0,this._minimumCountForInstancing=h,this._particleCountFactor=void 0!==u?u:1,this._calculateSize()},ParticleSystem.prototype._calculateSize=function(){var t,e=0;for(t=0;t<this._emitters.length;t++)e=Math.max(e,this._emitters[t].getSize());this.setSize(e)},ParticleSystem.prototype._handleOrientationChanged=function(){var t;if(this._carriesParticles&&this.getNode())for(t=this.getNode()._subnodes.getFirst();t;t=t.next)t._renderableObject.invalidateWorldVelocityDirectionVector()},ParticleSystem.prototype.shouldBeRendered=function(){return!1},ParticleSystem.prototype.performAnimate=function(i){var n,o,s,a,l,h;if(!this._keepAlive&&this._age>this._duration)return void this.getNode().markAsReusable(!0);if(this._age+=i,this._emitters)for(n=0;n<this._emitters.length;n++)if(s=this._emitters[n].emitParticles(i,this._particleCountFactor),this._carriesParticles)for(o=0;o<s.length;o++)this.getNode().addSubnode(new r.RenderableNode(s[o],!1,!1,this._minimumCountForInstancing));else for(a=this.getModelMatrix(),l=e.translation4m4(a),h=e.rotation4m4Aux(a),o=0;o<s.length;o++)s[o].translateByMatrix(l),s[o].rotateByMatrix(h),this.getNode()._scene.addNode(new r.RenderableNode(s[o],!1,!1,this._minimumCountForInstancing));this.translatev(t.scaled3(e.translationVector3(this._velocityMatrix),i/1e3))},ParticleSystem.prototype.finishEmitting=function(){var t,e,i=0;if(this._keepAlive=!1,this._carriesParticles){if(this._emitters){for(this._age=0,t=0;t<this._emitters.length;t++)e=this._emitters[t].getParticleDuration(),e>i&&(i=e);this._emitters=null,this._duration=i}}else this._duration=0,this.getNode().markAsReusable(!0)},ParticleSystem.prototype.addToContext=function(t){var e;for(e=0;e<this._emitters.length;e++)this._emitters[e].addToContext(t)},{ParticleEmitter:ParticleEmitter,OmnidirectionalParticleEmitter:OmnidirectionalParticleEmitter,UnidirectionalParticleEmitter:UnidirectionalParticleEmitter,PlanarParticleEmitter:PlanarParticleEmitter,ParticleSystem:ParticleSystem}}),define("armada/logic/explosion",["utils/vectors","utils/matrices","modules/application","modules/media-resources","modules/pools","modules/scene/renderable-objects","modules/scene/lights","modules/scene/scene-graph","modules/scene/particle-system","armada/graphics","armada/logic/classes","armada/configuration","armada/logic/constants","utils/polyfill"],function(t,e,i,r,n,o,s,a,l,h,u,c,p){"use strict";function getExplosion(){return m.getObject()}function Explosion(t,i,r,n,o,s){this._class=t,this._positionMatrix=i||e.identity4(),this._orientationMatrix=r||e.identity4(),this._direction=n,this._carriesParticles=o===!0,this._velocityMatrix=s||e.identity4(),this._visualModel=null}var d,_,g,m,f="explosion/";return Explosion.prototype.init=function(t,i,r,n,o,s){this._class=t,e.setMatrix4(this._positionMatrix,i),e.setMatrix4(this._orientationMatrix,r),this._direction=n,this._carriesParticles=o===!0,e.setMatrix4(this._velocityMatrix,s||e.IDENTITY4)},Explosion.prototype.createVisualModel=function(t,i){this._visualModel=new l.ParticleSystem(this._positionMatrix,this._orientationMatrix,t?e.scaling4(t):e.identity4(),this._velocityMatrix,i||[],this._class?this._class.getTotalDuration():0,this._class?this._class.isContinuous():!1,this._carriesParticles,c.getSetting(c.BATTLE_SETTINGS.MINIMUM_EXPLOSION_PARTICLE_COUNT_FOR_INSTANCING),h.getParticleCountFactor())},Explosion.prototype.canBeReused=function(){return this._visualModel&&this._visualModel.canBeReused()},Explosion.prototype.getEmitterParticleConstructor=function(t){var i=this._class.getParticleEmitterDescriptors()[t],r=i.getModel(),n=i.getShader(),o=i.getTexturesOfTypes(i.getShader().getTextureTypes(),h.getTextureQualityPreferenceList()),s=i.getParticleStates(),a=i.getInstancedShader();return function(){var t=g.getObject();return t.init(r,n,o,e.IDENTITY4,s,!1,a),t}.bind(this)},Explosion.prototype.getVisualModel=function(){return this._visualModel},Explosion.prototype._initVisualModel=function(t){var r,n,o,s;for(n=[],s=this._class.getParticleEmitterDescriptors(),r=0;r<s.length;r++){switch(s[r].getType()){case u.ParticleEmitterType.OMNIDIRECTIONAL:o=new l.OmnidirectionalParticleEmitter(e.IDENTITY4,e.IDENTITY4,s[r].getDimensions(),s[r].getVelocity(),s[r].getVelocitySpread(),s[r].getInitialNumber(),s[r].getSpawnNumber(),s[r].getSpawnTime(),s[r]._duration,s[r].getDelay(),this.getEmitterParticleConstructor(r));break;case u.ParticleEmitterType.UNIDIRECTIONAL:o=new l.UnidirectionalParticleEmitter(e.IDENTITY4,e.IDENTITY4,s[r].getDimensions(),this._direction,s[r].getDirectionSpread(),s[r].getVelocity(),s[r].getVelocitySpread(),s[r].getInitialNumber(),s[r].getSpawnNumber(),s[r].getSpawnTime(),s[r]._duration,s[r].getDelay(),this.getEmitterParticleConstructor(r));break;case u.ParticleEmitterType.PLANAR:o=new l.PlanarParticleEmitter(e.IDENTITY4,e.IDENTITY4,s[r].getDimensions(),this._direction,s[r].getDirectionSpread(),s[r].getVelocity(),s[r].getVelocitySpread(),s[r].getInitialNumber(),s[r].getSpawnNumber(),s[r].getSpawnTime(),s[r]._duration,s[r].getDelay(),this.getEmitterParticleConstructor(r));break;default:i.crash()}n.push(o)}this._visualModel?this._visualModel.init(this._positionMatrix,this._orientationMatrix,t?e.scaling4Aux(t):e.IDENTITY4,this._velocityMatrix,n,this._class.getTotalDuration(),this._class.isContinuous(),this._carriesParticles,c.getSetting(c.BATTLE_SETTINGS.MINIMUM_EXPLOSION_PARTICLE_COUNT_FOR_INSTANCING),h.getParticleCountFactor()):this.createVisualModel(t,n)},Explosion.prototype._addToSceneCallback=function(e,i,r,n){var o,l=e._scene;this._initVisualModel(1/e._renderableObject.getCascadeScalingMatrix()[0]),e.addSubnode(new a.RenderableNode(this._visualModel,!1)),o=this._class.getLightStates(),o&&l.addPointLightSource(new s.PointLightSource(o[0].color,o[0].intensity,t.NULL3,[this._visualModel],o),p.EXPLOSION_LIGHT_PRIORITY),this._class.playSound(i,r,d,_),n&&n(this._visualModel)},Explosion.prototype.addToScene=function(t,e,i,n){r.executeWhenReady(this._addToSceneCallback.bind(this,t,e,i,n))},Explosion.prototype.addResourcesToScene=function(t){var e=f+this._class.getName();this._class.acquireResources(),r.executeWhenReady(function(){t.hasResourcesOfObject(e)||(this._initVisualModel(),t.addResourcesOfObject(this._visualModel,e))}.bind(this))},Explosion.prototype.finish=function(){this._visualModel.finishEmitting()},Explosion.prototype.destroy=function(){this._class=null,this._positionMatrix=null,this._orientationMatrix=null,this._direction=null,this._visualModel&&this._visualModel.getNode().markAsReusable(!0),this._visualModel=null},g=n.getPool(o.Particle),m=n.getPool(Explosion),c.executeWhenReady(function(){d=c.getSetting(c.BATTLE_SETTINGS.HIT_SOUND_STACKING_TIME_THRESHOLD),_=c.getSetting(c.BATTLE_SETTINGS.HIT_SOUND_STACKING_VOLUME_FACTOR)}),{getExplosion:getExplosion,Explosion:Explosion}}),define("armada/logic/equipment",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/managed-gl","modules/physics","modules/media-resources","modules/pools","modules/scene/renderable-objects","modules/scene/lights","modules/scene/scene-graph","armada/graphics","armada/audio","armada/logic/classes","armada/logic/SpacecraftEvents","armada/configuration","armada/logic/constants","armada/logic/explosion","utils/polyfill"],function(t,e,i,r,n,o,s,a,l,h,u,c,p,d,_,g,m,f){"use strict";function Projectile(t,e,i,r,n){this._class=null,this._visualModel=null,this._physicalModel=new o.PhysicalObject,this._timeLeft=0,this._origin=null,t&&this.init(t,e,i,r,n)}function Weapon(t,e,r){this._class=t,this._spacecraft=e,this._slot=r,this._cooldown=0,this._visualModel=null,this._origoPositionMatrix=null,this._scaledOriMatrix=null,this._rotationAngles=[0,0],this._rotationChanged=!1,this._transformMatrix=i.identity4(),this._fixed=this._class.isFixed(),this._lastAimStatus=this._fixed?A.FIXED:A.NO_TARGET}function TargetingComputer(t,e){this._spacecraft=t,this._target=null,this._spacecraftArray=e||null,this._targetHitPosition=null,this._orderedHostileTargets=null,this._orderedNonHostileTargets=null,this._timeUntilHostileOrderReset=0,this._timeUntilNonHostileOrderReset=0}function Thruster(t,e){this._propulsionClass=t,this._slot=e,this._visualModel=null,this._shipModel=null,this._burnLevel=0,this._maxMoveBurnLevel=this._propulsionClass.getMaxMoveBurnLevel()}function Propulsion(t,e){var i;for(this._class=t,this._drivenPhysicalObject=e,this._thrusters=[],this._thrusterUses={},i=0;i<v.length;i++)this._thrusterUses[v[i]]={burn:0,thrusters:[]};this._thrusterSoundClip=null}function ManeuveringComputer(t){this._spacecraft=t,this._assisted=!0,this._restricted=!1,this._yawTarget=0,this._pitchTarget=0,this._rollTarget=0,this._speedTarget=0,this._strafeTarget=0,this._liftTarget=0,this._locked=!1,this._speedIncrementPerSecond=0,this._speedIncrement=0,this._maxCombatForwardSpeed=0,this._maxCombatReverseSpeed=0,this._maxCruiseForwardSpeed=0,this._maxCruiseReverseSpeed=0,this._turningLimit=0,this._maxMoveBurnLevel=0,this._maxTurnBurnLevel=0,this.updateForNewPropulsion()}function JumpEngine(t,e){this._class=t,this._spacecraft=e,this._state=JumpEngine.JumpState.NONE,this._timeLeft=0,this._soundClip=null,this._originalFlightMode=null,this._originalScalingMatrix=null}var S,y,T,E,C,M,x,b,O,R={FREE:"free",COMBAT:"combat",CRUISE:"cruise"},A={FIXED:0,NO_TARGET:1,AIMING_OUT_OF_REACH:2,AIMING:3,AIMED_OUT_OF_RANGE:4,AIMED_IN_RANGE:5},I={FORWARD:"forward",REVERSE:"reverse",STRAFE_LEFT:"strafeLeft",STRAFE_RIGHT:"strafeRight",RAISE:"raise",LOWER:"lower",YAW_LEFT:"yawLeft",YAW_RIGHT:"yawRight",PITCH_UP:"pitchUp",PITCH_DOWN:"pitchDown",ROLL_LEFT:"rollLeft",ROLL_RIGHT:"rollRight"},v=[I.FORWARD,I.REVERSE,I.STRAFE_LEFT,I.STRAFE_RIGHT,I.RAISE,I.LOWER,I.YAW_LEFT,I.YAW_RIGHT,I.PITCH_UP,I.PITCH_DOWN,I.ROLL_LEFT,I.ROLL_RIGHT],N="projectile/",L="weapon/",D=3,P=.02,w="jump",V=200,F=.5,B=2,U=!1,j=0,G=0,k=0,H=null,W=null;return Object.freeze(R),Object.freeze(A),Object.freeze(I),Projectile.prototype.init=function(t,e,r,n,o){this._class=t,this._physicalModel.init(t.getMass(),e||i.IDENTITY4,r||i.IDENTITY4,i.scaling4Aux(t.getSize()),n?n.getVelocityMatrix():i.NULL4,[],!0),
this._timeLeft=t._duration,this._origin=n,o&&this._physicalModel.addForce(o)},Projectile.prototype.canBeReused=function(){return this._timeLeft<=0},Projectile.prototype.createVisualModel=function(){this._visualModel=new l.Billboard},Projectile.prototype._initVisualModel=function(t){this._visualModel||this.createVisualModel(),this._visualModel.init(this._class.getModel(),this._class.getShader(),this._class.getTexturesOfTypes(this._class.getShader().getTextureTypes(),c.getTextureQualityPreferenceList()),this._class.getSize(),t,this._physicalModel._positionMatrix,this._physicalModel._orientationMatrix,this._class.getInstancedShader())},Projectile.prototype.getVisualModel=function(){return this._visualModel},Projectile.prototype.moveByVector=function(t){this._physicalModel.moveByVector(t)},Projectile.prototype._addToSceneCallback=function(t,e,i){this._initVisualModel(e),t.addObject(this._visualModel,!1,k),i&&i(this._visualModel)},Projectile.prototype.addToScene=function(t,e,i){s.executeWhenReady(this._addToSceneCallback.bind(this,t,e,i))},Projectile.prototype.addResourcesToScene=function(t,e){var r,n=N+this._class.getName();this._class.acquireResources(),s.executeWhenReady(function(){t.hasResourcesOfObject(n)||(this._initVisualModel(e),t.addResourcesOfObject(this._visualModel,n),r=new f.Explosion(this._class.getExplosionClass(),i.IDENTITY4,i.IDENTITY4,[0,0,0],!0),r.addResourcesToScene(t))}.bind(this))},Projectile.prototype.simulate=function(t,r){var n,o,s,a,l,h,u,c,p,d,_,g,m,S;if(!this.canBeReused())if(S=Math.min(t,this._class._duration-this._timeLeft),this._timeLeft-=t,this._timeLeft>0){for(this._physicalModel.simulate(t),this._visualModel.setPositionMatrix(this._physicalModel._positionMatrix),s=i.translationVector3(this._physicalModel._positionMatrix),l=i.translationVector3(this._physicalModel.getVelocityMatrix()),o=r.getObjects(Math.min(s[0],s[0]-l[0]*S*.001),Math.max(s[0],s[0]-l[0]*S*.001),Math.min(s[1],s[1]-l[1]*S*.001),Math.max(s[1],s[1]-l[1]*S*.001),Math.min(s[2],s[2]-l[2]*S*.001),Math.max(s[2],s[2]-l[2]*S*.001)),n=0;n<o.length;n++)if(C&&o[n].showHitbox(),d=o[n]._physicalModel,d&&(U||o[n]!==this._origin)&&(_=d.checkHit(s,l,S)))return h=e.diff3Aux(l,i.translationVector3(d.getVelocityMatrix())),c=e.normal3(h),u=e.length3(h),a=e.prodVec3Mat4Aux(c,i.inverseOfRotation4Aux(o[n]._visualModel._orientationMatrix)),g=e.prodVec4Mat4Aux(_,o[n]._visualModel.getModelMatrix()),m=e.diff3Aux(g,i.translationVector3(d._positionMatrix)),d.addForceAndTorque(m,c,u*this._physicalModel.getMass()*1e3/j,j),p=f.getExplosion(),p.init(this._class.getExplosionClass(),i.translation4vAux(g),i.IDENTITY4,e.scaled3(c,-1),!0,d.getVelocityMatrix()),p.addToScene(this._visualModel.getNode()._scene._rootNode,o[n].getSoundSource(),!0),o[n].damage(this._class.getDamage(),_,e.scaled3(a,-1),this._origin),this._timeLeft=0,void this._visualModel.markAsReusable(!0)}else this._visualModel.markAsReusable(!0)},Projectile.prototype.destroy=function(){this._timeLeft=0,this._class=null,this._origin=null,this._visualModel&&this._visualModel.getNode()&&this._visualModel.getNode().markAsReusable(!0),this._visualModel=null,this._physicalModel=null},Weapon.prototype.getSlot=function(){return this._slot},Weapon.prototype.getProjectileClass=function(){return this._class.getProjectileClass()},Weapon.prototype.getProjectileVelocity=function(){return this._class.getProjectileVelocity()},Weapon.prototype.getFirepower=function(t){return this._class.getFirepower(t)},Weapon.prototype.getRange=function(t){return(this._class.getProjectileVelocity()+(t||0))*this._class.getProjectileClass()._duration/1e3},Weapon.prototype.getCooldown=function(){return this._class.getCooldown()},Weapon.prototype.getOrigoPositionMatrix=function(){return this._origoPositionMatrix=this._origoPositionMatrix||i.translatedByVector(this._slot?this._slot.positionMatrix:i.IDENTITY4,e.prodVec3Mat4Aux(e.scaled3(this._class.getAttachmentPoint(),-1),i.prod3x3SubOf4Aux(i.scaling4(this._class.getModel().getScale()/(this._spacecraft?this._spacecraft.getPhysicalScalingMatrix()[0]:1)),this._slot?this._slot.orientationMatrix:i.IDENTITY4))),this._origoPositionMatrix},Weapon.prototype.getScaledOriMatrix=function(){return this._scaledOriMatrix=this._scaledOriMatrix||i.prod3x3SubOf4(this._visualModel._scalingMatrix,this._slot.orientationMatrix),this._scaledOriMatrix},Weapon.prototype.isFixed=function(){return this._fixed},Weapon.prototype.getBasePointPosVector=function(t){var r,n=e.prodVec3Mat4Aux(i.translationVector3(this.getOrigoPositionMatrix()),t);return e.add3(n,this._spacecraft.getPhysicalPositionVector()),r=e.prodVec4Mat4(this._class.getBasePoint(),this._transformMatrix),e.mulVec3Mat4(r,i.prod3x3SubOf4Aux(this.getScaledOriMatrix(),t)),e.add3(r,n),r},Weapon.prototype.getProjectileOrientationMatrix=function(){return i.setProd3x3SubOf4(Weapon._projectileOriMatrix,this._slot.orientationMatrix,this._spacecraft.getPhysicalOrientationMatrix()),this._fixed||i.setProd3x3SubOf4(Weapon._projectileOriMatrix,this._transformMatrix,i.matrix4Aux(Weapon._projectileOriMatrix)),Weapon._projectileOriMatrix},Weapon.prototype.acquireResources=function(t){this._class.acquireResources(t)},Weapon.prototype.addToScene=function(t,e,o,a,h){var p,d;this.acquireResources({omitShader:!!a.shaderName}),a.shaderName&&c.getShader(a.shaderName),s.executeWhenReady(function(){var s,_,g={};for(r.log_DEBUG("Adding weapon ("+this._class.getName()+") to scene...",2),_=this._class.getModel().getScale()/t._renderableObject._scalingMatrix[0],g[W]=n.ShaderVariableType.MAT4,c.areLuminosityTexturesAvailable()&&(g[H]=n.ShaderVariableType.FLOAT),s=new l.ParameterizedMesh(this._class.getModel(),a.shaderName?c.getManagedShader(a.shaderName):this._class.getShader(),this._class.getTexturesOfTypes(this._class.getShader().getTextureTypes(),c.getTextureQualityPreferenceList()),this._slot?this.getOrigoPositionMatrix():i.identity4(),a.orientationMatrix||(this._slot?this._slot.orientationMatrix:i.identity4()),i.scaling4(_),o===!0,e,g),t.addSubnode(new u.RenderableNode(s)),p=0,d=c.getMaxGroupTransforms();d>p;p++)s.setMat4Parameter(W,p,i.IDENTITY4);if(c.areLuminosityTexturesAvailable())for(p=0,d=c.getMaxLuminosityFactors();d>p;p++)s.setFloatParameter(H,p,this._class.getDefaultGroupLuminosity(p));this._visualModel||(this._visualModel=s),h&&h(s)}.bind(this))},Weapon.prototype._getMuzzleFlashForBarrel=function(t,e){var r=this._class.getBarrel(t).getProjectileClass(),n=i.translation4vAux(e),o=b.getObject();return l.initDynamicParticle(o,r.getMuzzleFlash().getModel(),r.getMuzzleFlash().getShader(),r.getMuzzleFlash().getTexturesOfTypes(r.getMuzzleFlash().getShader().getTextureTypes(),c.getTextureQualityPreferenceList()),r.getMuzzleFlash().getColor(),r.getMuzzleFlash().getSize(),n,r.getMuzzleFlash()._duration||g.getSetting(g.BATTLE_SETTINGS.DEFAULT_MUZZLE_FLASH_DURATION),r.getMuzzleFlash().getInstancedShader()),o},Weapon.prototype.getResourceAdderFunction=function(t,e,i){return function(){var r;t.hasResourcesOfObject(i)||(r=this._getMuzzleFlashForBarrel(e,[0,0,0]),t.addResourcesOfObject(r))}.bind(this)},Weapon.prototype.addProjectileResourcesToScene=function(t){var e,i,r,n=L+this._class.getName();for(r=this._class.getBarrels(),e=0;e<r.length;e++)i=new Projectile(r[e].getProjectileClass()),i.addResourcesToScene(t),s.executeWhenReady(this.getResourceAdderFunction(t,e,n).bind(this));s.executeWhenReady(function(){t.addResourcesOfObject(null,n)})},Weapon.prototype.simulate=function(t){var r,n;if(this._cooldown=Math.min(this._cooldown+t,this._class.getCooldown()),this._rotationChanged){for(i.setIdentity4(this._transformMatrix),n=this._class.getRotators(),r=0;r<n.length;r++)i.rotateAroundPoint4(this._transformMatrix,e.prodVec3Mat4Aux(n[r].center,this._transformMatrix),e.prodVec3Mat4Aux(n[r].axis,this._transformMatrix),this._rotationAngles[r]),this._visualModel.setMat4Parameter(W,n[r].transformGroupIndex,this._transformMatrix);this._rotationChanged=!1}},Weapon._weaponSlotPosMatrix=i.identity4(),Weapon._projectilePosMatrix=i.identity4(),Weapon._projectileOriMatrix=i.identity4(),Weapon.prototype.fire=function(r,n,s){var a,l,c,p,d,_,g,f,S,y,T,E,C=this._visualModel.getNode()._scene;if(n&&this._lastAimStatus!==A.FIXED&&this._lastAimStatus!==A.AIMED_IN_RANGE)return 0;if(this._cooldown>=this._class.getCooldown()){for(this._cooldown=0,p=e.prodVec3Mat4Aux(i.translationVector3(this.getOrigoPositionMatrix()),r),i.setTranslatedByVector(Weapon._weaponSlotPosMatrix,this._spacecraft.getPhysicalPositionMatrix(),p),d=this.getProjectileOrientationMatrix(),S=this._class.getBarrels(),y={},c=0,a=0;a<S.length;a++)_=S[a].getProjectileClass(),g=S[a].getPositionVector(),this._fixed||(g=e.prodVec4Mat4(g,this._transformMatrix)),f=this._getMuzzleFlashForBarrel(a,g),g=e.prodVec3Mat4(g,i.prod3x3SubOf4Aux(this.getScaledOriMatrix(),r)),i.setTranslatedByVector(Weapon._projectilePosMatrix,Weapon._weaponSlotPosMatrix,g),this._visualModel.getNode().addSubnode(new u.RenderableNode(f,!1),!1,G),l=O.getObject(),l.init(_,Weapon._projectilePosMatrix,d,this._spacecraft,new o.Force(t.EMPTY_STRING,S[a].getForceForDuration(j),[d[4],d[5],d[6]],j)),l.addToScene(C),y[_.getName()]?y[_.getName()].addEmittingObject(l._visualModel):y[_.getName()]=new h.PointLightSource(_.getLightColor(),_.getLightIntensity(),e.NULL3,[l._visualModel]),this._spacecraft._physicalModel.addForceAndTorque(e.diff3(i.translationVector3(Weapon._projectilePosMatrix),i.translationVector3(this._spacecraft.getPhysicalPositionMatrix())),i.getRowB43Neg(d),S[a].getForceForDuration(j),j),c++;for(T in y)y.hasOwnProperty(T)&&C.addPointLightSource(y[T],m.PROJECTILE_LIGHT_PRIORITY);return s||(E=i.translationVector3(l._visualModel.getPositionMatrixInCameraSpace(C._camera))),this._class.playFireSound(E,s,M,x),c}return 0},Weapon.prototype.setRotation=function(t,e){this._fixed||(this._rotationAngles[0]=Math.radians(t),this._rotationAngles[1]=Math.radians(e),this._rotationChanged=!0)},Weapon.prototype.rotateTo=function(t,e,i,n,o){var s,a,l,h;if(!this._fixed)for(this._lastAimStatus=A.AIMED_IN_RANGE,a=this._class.getRotators(),l=0;l<a.length;l++){switch(l){case 0:s=t-this._rotationAngles[0],this._class.getRotationStyle()===d.WeaponRotationStyle.ROLL_YAW&&Math.abs(s-Math.sign(s)*Math.PI)<Math.abs(s)&&(s-=Math.sign(s)*Math.PI,e=-e);break;case 1:s=e-this._rotationAngles[1];break;default:r.crash()}a[l].restricted||(s>Math.PI?s-=2*Math.PI:s<-Math.PI&&(s+=2*Math.PI)),h=0,Math.abs(s)>i&&(h=a[l].rotationRate*o/1e3,s>0?this._rotationAngles[l]+=Math.min(h,s):this._rotationAngles[l]-=Math.min(h,-s),this._rotationChanged=!0,Math.abs(s)-h>n&&(this._lastAimStatus=A.AIMING)),a[l].restricted?(this._rotationAngles[l]>a[l].range[1]&&(this._rotationAngles[l]=a[l].range[1],Math.abs(s)-h>n&&(this._lastAimStatus=A.AIMING_OUT_OF_REACH)),this._rotationAngles[l]<a[l].range[0]&&(this._rotationAngles[l]=a[l].range[0],Math.abs(s)-h>n&&(this._lastAimStatus=A.AIMING_OUT_OF_REACH))):(this._rotationAngles[l]>Math.PI&&(this._rotationAngles[l]-=2*Math.PI),this._rotationAngles[l]<-Math.PI&&(this._rotationAngles[l]+=2*Math.PI))}},Weapon.prototype.aimTowards=function(t,i,n,o,s){var a,l,h,u,c;if(!this._fixed){switch(a=this.getBasePointPosVector(o),l=e.diff3(t,a),l=e.prodMat4Vec3(this._spacecraft.getPhysicalOrientationMatrix(),l),l=e.prodMat4Vec3(this._slot.orientationMatrix,l),c=e.length3(l)<=this.getRange(),e.normalize3(l),this._class.getRotationStyle()){case d.WeaponRotationStyle.YAW_PITCH:h=e.getYawAndPitch(l),this.rotateTo(-h.yaw,-h.pitch,i,n,s);break;case d.WeaponRotationStyle.ROLL_YAW:u=e.getRollAndYaw(l),this.rotateTo(u.roll,u.yaw,i,n,s);break;default:r.crash()}c||this._lastAimStatus!==A.AIMED_IN_RANGE||(this._lastAimStatus=A.AIMED_OUT_OF_RANGE)}},Weapon.prototype.rotateToDefaultPosition=function(t,e){var i;this._fixed||(i=this._class.getRotators(),this.rotateTo(i[0].defaultAngle,i[1].defaultAngle,t,0,e),this._lastAimStatus=A.NO_TARGET)},Weapon.prototype.getScoreValue=function(){return this._class.getScoreValue()},Weapon.prototype.getMaxProjectileCount=function(){return this._class.getMaxProjectileCount()},Weapon.prototype.getMaxExplosionCount=function(){return this._class.getMaxExplosionCount()},Weapon.prototype.getMaxParticleCount=function(){return this._class.getMaxParticleCount()},Weapon.prototype.destroy=function(){this._class=null,this._spacecraft=null,this._slot=null,this._visualModel&&this._visualModel.markAsReusable(!0),this._visualModel=null},TargetingComputer.prototype.setTarget=function(t){var e,i,r,n;if(t!==this._target){if(this._target&&this._target.setBeingUntargeted(this._spacecraft),this._target=t,this._targetHitPosition=null,this._spacecraft._visualModel)for(r=this._spacecraft._visualModel.getNode(),n=r._scene._camera,i=r.getCameraConfigurationsWithName(g.getSetting(g.BATTLE_SETTINGS.TARGET_VIEW_NAME)),e=0;e<i.length;e++)n.getConfiguration()===i[e]&&n.transitionToSameConfiguration(g.getSetting(g.BATTLE_SETTINGS.TARGET_CHANGE_TRANSITION_DURATION),g.getSetting(g.BATTLE_SETTINGS.TARGET_CHANGE_TRANSITION_STYLE)),i[e].setOrientationFollowedObjects(this._target?[this._target._visualModel]:[],!0);this._target&&this._target.setBeingTargeted(this._spacecraft)}},TargetingComputer.prototype._filterHostileTarget=function(t){return this._spacecraft.isHostile(t)},TargetingComputer.prototype._filterNonHostileTarget=function(t){return t!==this._spacecraft&&!this._spacecraft.isHostile(t)},TargetingComputer.prototype._mapTargetByBearing=function(t,r){return{index:r,value:e.angle3u(i.getRowB43(this._spacecraft.getPhysicalOrientationMatrix()),e.normal3(e.diff3(t.getPhysicalPositionVector(),this._spacecraft.getPhysicalPositionVector())))}},TargetingComputer.prototype._mapTargetToCombinedValue=function(t,r){var n=e.diff3(t.getPhysicalPositionVector(),this._spacecraft.getPhysicalPositionVector()),o=e.length3(n);return{index:r,value:(o+V*e.angle3u(i.getRowB43(this._spacecraft.getPhysicalOrientationMatrix()),e.scaled3(n,1/o)))*(this._spacecraft.isGoodAgainst(t)?F:this._spacecraft.isBadAgainst(t)?B:1)}},TargetingComputer._compareMappedTargets=function(t,e){return t.value-e.value},TargetingComputer.prototype._updateHostileOrder=function(t){var e,i,r;if(this._spacecraftArray){if(e=this._spacecraftArray.filter(this._filterHostileTarget,this),this._timeUntilHostileOrderReset<=0){for(i=e.map(t,this).sort(TargetingComputer._compareMappedTargets),this._orderedHostileTargets=[],r=0;r<i.length;r++)this._orderedHostileTargets.push(e[i[r].index]);return!0}for(r=0;r<e.length;r++)this._orderedHostileTargets.indexOf(e[r])<0&&this._orderedHostileTargets.push(e[r])}return!1},TargetingComputer.prototype._updateNonHostileOrder=function(){var t,e,i;if(this._spacecraftArray){if(t=this._spacecraftArray.filter(this._filterNonHostileTarget,this),this._timeUntilNonHostileOrderReset<=0){for(e=t.map(this._mapTargetByBearing,this).sort(TargetingComputer._compareMappedTargets),this._orderedNonHostileTargets=[],i=0;i<e.length;i++)this._orderedNonHostileTargets.push(t[e[i].index]);return!0}for(i=0;i<t.length;i++)this._orderedNonHostileTargets.indexOf(t[i])<0&&this._orderedNonHostileTargets.push(t[i])}return!1},TargetingComputer.prototype._isValidNewTarget=function(t){return t.isAlive()&&!t.isAway()&&t!==this._target},TargetingComputer.prototype._targetNextHostile=function(t){var e,i,r,n=this._updateHostileOrder(t);return this._orderedHostileTargets&&this._orderedHostileTargets.length>0&&(r=this._orderedHostileTargets.length,e=n?0:(this._orderedHostileTargets.indexOf(this._target)+1)%r,i=0,r>i&&!this._isValidNewTarget(this._orderedHostileTargets[e])&&(e=(e+1)%r,i++),r>i)?(this.setTarget(this._orderedHostileTargets[e]),this._timeUntilHostileOrderReset=g.getSetting(g.BATTLE_SETTINGS.TARGET_ORDER_DURATION),!0):(this._timeUntilHostileOrderReset=0,!1)},TargetingComputer.prototype._targetPreviousHostile=function(t){var e,i,r,n=this._updateHostileOrder(t);return this._orderedHostileTargets&&this._orderedHostileTargets.length>0&&(r=this._orderedHostileTargets.length,e=n?r-1:(this._orderedHostileTargets.indexOf(this._target)+r-1)%r,i=0,r>i&&!this._isValidNewTarget(this._orderedHostileTargets[e])&&(e=(e+r-1)%r,i++),r>i)?(this.setTarget(this._orderedHostileTargets[e]),this._timeUntilHostileOrderReset=g.getSetting(g.BATTLE_SETTINGS.TARGET_ORDER_DURATION),!0):(this._timeUntilHostileOrderReset=0,!1)},TargetingComputer.prototype.targetNextNearestHostile=function(){return this._targetNextHostile(this._mapTargetByBearing)},TargetingComputer.prototype.targetPreviousNearestHostile=function(){return this._targetPreviousHostile(this._mapTargetByBearing)},TargetingComputer.prototype.targetNextBestHostile=function(){return this._targetNextHostile(this._mapTargetToCombinedValue)},TargetingComputer.prototype.targetNextNearestNonHostile=function(){var t,e,i,r=this._updateNonHostileOrder();return this._orderedNonHostileTargets&&this._orderedNonHostileTargets.length>0&&(i=this._orderedNonHostileTargets.length,t=r?0:(this._orderedNonHostileTargets.indexOf(this._target)+1)%i,e=0,i>e&&!this._isValidNewTarget(this._orderedNonHostileTargets[t])&&(t=(t+1)%i,e++),i>e)?(this.setTarget(this._orderedNonHostileTargets[t]),this._timeUntilNonHostileOrderReset=g.getSetting(g.BATTLE_SETTINGS.TARGET_ORDER_DURATION),!0):(this._timeUntilNonHostileOrderReset=0,!1)},TargetingComputer.prototype.getTarget=function(){return this._target&&(this._target.canBeReused()||this._target.isAway())&&this.setTarget(null),this._target},TargetingComputer.prototype.getTargetHitPosition=function(){var r,n,o,s,a,l,h,u,c,p;if(!this._targetHitPosition){if(n=this._target.getPhysicalPositionVector(),s=this._spacecraft.getWeapons(),0===s.length)return n;for(r=this._spacecraft.getPhysicalPositionVector(),o=e.diff3(i.translationVector3(this._target.getVelocityMatrix()),i.translationVector3(this._spacecraft.getVelocityMatrix())),a=s[0].getProjectileVelocity(),l=a*a-(o[0]*o[0]+o[1]*o[1]+o[2]*o[2]),h=0,c=0;3>c;c++)h+=2*o[c]*(r[c]-n[c]);for(u=0,c=0;3>c;c++)u+=-n[c]*n[c]-r[c]*r[c]+2*n[c]*r[c];p=t.getGreaterSolutionOfQuadraticEquation(l,h,u),this._targetHitPosition=[n[0]+p*o[0],n[1]+p*o[1],n[2]+p*o[2]]}return this._targetHitPosition},TargetingComputer.prototype.simulate=function(t){this._target&&(this._target.canBeReused()||this._target.isAway())&&this.setTarget(null),this._targetHitPosition=null,this._timeUntilHostileOrderReset>0&&(this._timeUntilHostileOrderReset-=t),this._timeUntilNonHostileOrderReset>0&&(this._timeUntilNonHostileOrderReset-=t)},TargetingComputer.prototype.destroy=function(){this._spacecraft=null,this._spacecraftArray=null,this._target=null,this._targetHitPosition=null,this._orderedHostileTargets=null,this._orderedNonHostileTargets=null},Thruster.prototype.addToScene=function(t){var e;this._propulsionClass.acquireResources(),s.executeWhenReady(function(){e=l.staticParticle(this._propulsionClass.getThrusterBurnParticle().getModel(),this._propulsionClass.getThrusterBurnParticle().getShader(),this._propulsionClass.getThrusterBurnParticle().getTexturesOfTypes(this._propulsionClass.getThrusterBurnParticle().getShader().getTextureTypes(),c.getTextureQualityPreferenceList()),this._propulsionClass.getThrusterBurnParticle().getColor(),this._slot.size,i.translation4v(this._slot.positionVector),this._propulsionClass.getThrusterBurnParticle().getInstancedShader()),e.setRelativeSize(0),t.addSubnode(new u.RenderableNode(e,!1,!1,g.getSetting(g.BATTLE_SETTINGS.MINIMUM_THRUSTER_PARTICLE_COUNT_FOR_INSTANCING))),this._visualModel||(this._visualModel=e,this._shipModel=t._renderableObject)}.bind(this))},Thruster.prototype.updateVisuals=function(){this._visualModel.setRelativeSize(this._burnLevel),c.areLuminosityTexturesAvailable()&&this._shipModel.setFloatParameter(H,this._slot.group,Math.min(1,this._burnLevel/this._maxMoveBurnLevel))},Thruster.prototype.resetBurn=function(){this._burnLevel=0},Thruster.prototype.addBurn=function(t){this._burnLevel+=t},Thruster.prototype.destroy=function(){this._propulsionClass=null,this._slot=null,this._visualModel=null,this._shipModel=null},Propulsion.prototype.acquireResources=function(){this._class.acquireResources()},Propulsion.prototype.getThrust=function(){return this._class.getThrust()},Propulsion.prototype.getAngularThrust=function(){return this._class.getAngularThrust()},Propulsion.prototype.getMaxMoveBurnLevel=function(){return this._class.getMaxMoveBurnLevel()},Propulsion.prototype.getMaxTurnBurnLevel=function(){return this._class.getMaxTurnBurnLevel()},Propulsion.prototype.addThrusters=function(t){var e,i,r;for(e=0;e<t.length;e++)for(r=new Thruster(this._class,t[e]),this._thrusters.push(r),i=0;i<t[e].uses.length;i++)this._thrusterUses[t[e].uses[i]].thrusters.push(r)},Propulsion.prototype.addToScene=function(t){var e;for(e=0;e<this._thrusters.length;e++)this._thrusters[e].addToScene(t)},Propulsion.prototype.getThrusterBurn=function(t){return this._thrusterUses[t].burn},Propulsion.prototype.addThrusterBurn=function(t,e){var i;for(this._thrusterUses[t].burn+=e,i=0;i<this._thrusterUses[t].thrusters.length;i++)this._thrusterUses[t].thrusters[i].addBurn(e)},Propulsion.prototype.resetThrusterBurn=function(){var t,e;for(e=v.length-1;e>=0;e--)t=v[e],this._thrusterUses[t].burn=0;for(e=0;e<this._thrusters.length;e++)this._thrusters[e].resetBurn()},Propulsion.prototype.updateVisuals=function(){var t;for(t=0;t<this._thrusters.length;t++)this._thrusters[t].updateVisuals()},Propulsion.prototype._getSoundVolume=function(){var t,e,i;return i=this._class.getMaxMoveBurnLevel(),t=i?Math.max(this._thrusterUses.forward.burn,this._thrusterUses.reverse.burn,this._thrusterUses.strafeRight.burn,this._thrusterUses.strafeLeft.burn,this._thrusterUses.raise.burn,this._thrusterUses.lower.burn)/i:0,i=this._class.getMaxTurnBurnLevel(),e=i?Math.max(this._thrusterUses.yawRight.burn,this._thrusterUses.yawLeft.burn,this._thrusterUses.pitchUp.burn,this._thrusterUses.pitchDown.burn,this._thrusterUses.rollRight.burn,this._thrusterUses.rollLeft.burn)/i:0,i=Math.round((t+e)*D)/D},Propulsion.prototype.simulate=function(t,e){var r,n,o;e!==!1&&(r=i.getRowB4(this._drivenPhysicalObject._orientationMatrix),n=i.getRowC4(this._drivenPhysicalObject._orientationMatrix),o=i.getRowA4(this._drivenPhysicalObject._orientationMatrix),this._thrusterUses.forward.burn>0&&this._drivenPhysicalObject.addOrRenewForce("forwardThrust",this._class.getThrust()*this._thrusterUses.forward.burn/this._class.getMaxMoveBurnLevel(),r),this._thrusterUses.reverse.burn>0&&this._drivenPhysicalObject.addOrRenewForce("reverseThrust",-this._class.getThrust()*this._thrusterUses.reverse.burn/this._class.getMaxMoveBurnLevel(),r),this._thrusterUses.strafeRight.burn>0&&this._drivenPhysicalObject.addOrRenewForce("strafeRightThrust",this._class.getThrust()*this._thrusterUses.strafeRight.burn/this._class.getMaxMoveBurnLevel(),o),this._thrusterUses.strafeLeft.burn>0&&this._drivenPhysicalObject.addOrRenewForce("strafeLeftThrust",-this._class.getThrust()*this._thrusterUses.strafeLeft.burn/this._class.getMaxMoveBurnLevel(),o),this._thrusterUses.raise.burn>0&&this._drivenPhysicalObject.addOrRenewForce("raiseThrust",this._class.getThrust()*this._thrusterUses.raise.burn/this._class.getMaxMoveBurnLevel(),n),this._thrusterUses.lower.burn>0&&this._drivenPhysicalObject.addOrRenewForce("lowerThrust",-this._class.getThrust()*this._thrusterUses.lower.burn/this._class.getMaxMoveBurnLevel(),n),this._thrusterUses.yawRight.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("yawRightThrust",this._class.getAngularThrust()*this._thrusterUses.yawRight.burn/this._class.getMaxTurnBurnLevel(),n),this._thrusterUses.yawLeft.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("yawLeftThrust",-this._class.getAngularThrust()*this._thrusterUses.yawLeft.burn/this._class.getMaxTurnBurnLevel(),n),this._thrusterUses.pitchUp.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("pitchUpThrust",-this._class.getAngularThrust()*this._thrusterUses.pitchUp.burn/this._class.getMaxTurnBurnLevel(),o),this._thrusterUses.pitchDown.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("pitchDownThrust",this._class.getAngularThrust()*this._thrusterUses.pitchDown.burn/this._class.getMaxTurnBurnLevel(),o),this._thrusterUses.rollRight.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("rollRightThrust",-this._class.getAngularThrust()*this._thrusterUses.rollRight.burn/this._class.getMaxTurnBurnLevel(),r),this._thrusterUses.rollLeft.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("rollLeftThrust",this._class.getAngularThrust()*this._thrusterUses.rollLeft.burn/this._class.getMaxTurnBurnLevel(),r)),this._thrusterSoundClip||(this._thrusterSoundClip=this._class.createThrusterSoundClip(t),this._thrusterSoundClip&&(this._thrusterSoundClip.setVolume(0),this._thrusterSoundClip.play())),this._thrusterSoundClip&&this._thrusterSoundClip.rampVolume(this._getSoundVolume()*this._class.getThrusterSoundVolume(),P,!0,!0)},Propulsion.prototype.getScoreValue=function(){return this._class.getScoreValue()},Propulsion.prototype.destroy=function(){this._class=null,this._drivenPhysicalObject=null,this._thrusters=null,this._thrusterUses=null,this._thrusterSoundClip&&(this._thrusterSoundClip.stopPlaying(p.SOUND_RAMP_DURATION),setTimeout(function(){this._thrusterSoundClip.destroy(),this._thrusterSoundClip=null}.bind(this),p.SOUND_RAMP_DURATION))},ManeuveringComputer.prototype.updateSpeedIncrementPerSecond=function(){this._speedIncrementPerSecond=this._spacecraft.getMaxAcceleration()||0},ManeuveringComputer.prototype.updateSpeedIncrement=function(t){this._speedIncrement=t*this._speedIncrementPerSecond/1e3},ManeuveringComputer.prototype.updateTurningLimit=function(){this._turningLimit=this._spacecraft.getMaxAngularAcceleration()*g.getSetting(g.BATTLE_SETTINGS.TURN_ACCELERATION_DURATION_S)*o.ANGULAR_VELOCITY_MATRIX_DURATION_S},ManeuveringComputer.prototype.updateForNewPropulsion=function(){var t=this._spacecraft.getMaxAcceleration();this.updateSpeedIncrementPerSecond(),this._maxCombatForwardSpeed=S*t,this._maxCombatReverseSpeed=y*-t,this._maxCruiseForwardSpeed=T*t,this._maxCruiseReverseSpeed=E*-t,this.updateTurningLimit(),this._maxMoveBurnLevel=this._spacecraft.getMaxThrusterMoveBurnLevel(),this._maxTurnBurnLevel=this._spacecraft.getMaxThrusterTurnBurnLevel()},ManeuveringComputer.prototype.getRestrictedTurningLimit=function(t){return Math.min(this._turningLimit,this._spacecraft.getMaxTurnRateAtSpeed(void 0===t?this._spacecraft.getRelativeVelocityMatrix()[13]:t)*o.ANGULAR_VELOCITY_MATRIX_DURATION_S)},ManeuveringComputer.prototype.isLocked=function(){return this._locked},ManeuveringComputer.prototype.setLocked=function(t){this._locked=t,this._locked&&(this._yawTarget=0,this._pitchTarget=0,this._rollTarget=0)},ManeuveringComputer.prototype.getFlightMode=function(){return this._assisted?this._restricted?R.CRUISE:R.COMBAT:R.FREE},ManeuveringComputer.prototype.changeFlightMode=function(t){if(this._locked)return!1;switch(t||(t=this._assisted?this._restricted?R.FREE:R.CRUISE:R.COMBAT),t){case R.COMBAT:this._speedTarget=Math.min(Math.max(this._maxCombatReverseSpeed,this._assisted?this._speedTarget:this._spacecraft.getRelativeVelocityMatrix()[13]),this._maxCombatForwardSpeed),this._assisted=!0,this._restricted=!1;break;case R.CRUISE:this._speedTarget=Math.min(Math.max(this._maxCruiseReverseSpeed,this._assisted?this._speedTarget:this._spacecraft.getRelativeVelocityMatrix()[13]),this._maxCruiseForwardSpeed),this._assisted=!0,this._restricted=!0;break;case R.FREE:this._assisted=!1,this._restricted=!1;break;default:return r.showError("Cannot switch to unknown flight mode: '"+t+"'!"),!1}return!0},ManeuveringComputer.prototype.toggleFlightAssist=function(){return this.changeFlightMode(this._assisted?R.FREE:R.COMBAT)},ManeuveringComputer.prototype.toggleCruise=function(){return this.changeFlightMode(this._restricted?R.COMBAT:R.CRUISE)},ManeuveringComputer.prototype.forward=function(t){this._locked||(this._speedTarget=this._assisted?Math.min(Math.max(this._spacecraft.getRelativeVelocityMatrix()[13],this._speedTarget)+(t||this._speedIncrement),this._restricted?this._maxCruiseForwardSpeed:this._maxCombatForwardSpeed):Number.MAX_VALUE)},ManeuveringComputer.prototype.stopForward=function(){if(!this._assisted){var t=this._spacecraft.getRelativeVelocityMatrix()[13];this._speedTarget>t&&(this._speedTarget=t)}},ManeuveringComputer.prototype.reverse=function(t){this._locked||(this._speedTarget=this._assisted?Math.max(Math.min(this._spacecraft.getRelativeVelocityMatrix()[13],this._speedTarget)-(t||this._speedIncrement),this._restricted?this._maxCruiseReverseSpeed:this._maxCombatReverseSpeed):-Number.MAX_VALUE)},ManeuveringComputer.prototype.stopReverse=function(){var t;this._assisted||(t=this._spacecraft.getRelativeVelocityMatrix()[13],this._speedTarget<t&&(this._speedTarget=t))},ManeuveringComputer.prototype.strafeLeft=function(t){this._locked||(this._strafeTarget=this._restricted?0:this._assisted&&t?-t:-Number.MAX_VALUE)},ManeuveringComputer.prototype.stopLeftStrafe=function(){this._strafeTarget<0&&(this._strafeTarget=0)},ManeuveringComputer.prototype.strafeRight=function(t){this._locked||(this._strafeTarget=this._restricted?0:this._assisted&&t||Number.MAX_VALUE)},ManeuveringComputer.prototype.stopRightStrafe=function(){this._strafeTarget>0&&(this._strafeTarget=0)},ManeuveringComputer.prototype.lower=function(t){this._locked||(this._liftTarget=this._restricted?0:this._assisted&&t?-t:-Number.MAX_VALUE)},ManeuveringComputer.prototype.stopLower=function(){this._liftTarget<0&&(this._liftTarget=0)},ManeuveringComputer.prototype.raise=function(t){this._locked||(this._liftTarget=this._restricted?0:this._assisted&&t||Number.MAX_VALUE)},ManeuveringComputer.prototype.stopRaise=function(){this._liftTarget>0&&(this._liftTarget=0)},ManeuveringComputer.prototype.resetSpeed=function(){this._locked||this._assisted&&(this._speedTarget=0)},ManeuveringComputer.prototype.setSpeedTarget=function(t){this._locked||this._assisted&&(this._speedTarget=t)},ManeuveringComputer.prototype.getSpeedTarget=function(){return this._speedTarget},ManeuveringComputer.prototype.hasSpeedTarget=function(){return this._assisted},ManeuveringComputer.prototype.getMaxSpeed=function(){return this._assisted?this._restricted?this._maxCruiseForwardSpeed:this._maxCombatForwardSpeed:void 0},ManeuveringComputer.prototype.yawLeft=function(t){this._locked||(void 0===t?this._yawTarget=-this._turningLimit:t>0?this._yawTarget=-t*(this._restricted?this.getRestrictedTurningLimit():this._turningLimit):this._yawTarget<0&&(this._yawTarget=0))},ManeuveringComputer.prototype.yawRight=function(t){this._locked||(void 0===t?this._yawTarget=this._turningLimit:t>0?this._yawTarget=t*(this._restricted?this.getRestrictedTurningLimit():this._turningLimit):this._yawTarget>0&&(this._yawTarget=0))},ManeuveringComputer.prototype.pitchDown=function(t){this._locked||(void 0===t?this._pitchTarget=-this._turningLimit:t>0?this._pitchTarget=-t*(this._restricted?this.getRestrictedTurningLimit():this._turningLimit):this._pitchTarget<0&&(this._pitchTarget=0))},ManeuveringComputer.prototype.pitchUp=function(t){this._locked||(void 0===t?this._pitchTarget=this._turningLimit:t>0?this._pitchTarget=t*(this._restricted?this.getRestrictedTurningLimit():this._turningLimit):this._pitchTarget>0&&(this._pitchTarget=0))},ManeuveringComputer.prototype.rollLeft=function(t){this._locked||(void 0===t?this._rollTarget=-this._turningLimit:t>0?this._rollTarget=-t*this._turningLimit:this._rollTarget<0&&(this._rollTarget=0))},ManeuveringComputer.prototype.rollRight=function(t){this._locked||(void 0===t?this._rollTarget=this._turningLimit:t>0?this._rollTarget=t*this._turningLimit:this._rollTarget>0&&(this._rollTarget=0))},ManeuveringComputer.prototype.controlThrusters=function(t){var i,r,n,s,a=this._spacecraft.getRelativeVelocityMatrix(),l=a[13],h=o.VELOCITY_MATRIX_ERROR_THRESHOLD,u=this._spacecraft.getTurningMatrix(),c=o.ANGULAR_VELOCITY_MATRIX_ERROR_THRESHOLD,p=this._yawTarget,d=this._pitchTarget;this._spacecraft.resetThrusterBurn(),
this._restricted&&0!==l&&(i=this.getRestrictedTurningLimit(l),p=Math.min(Math.max(p,-i),i),d=Math.min(Math.max(d,-i),i)),r=Math.sign(u[4])*e.angle2u([0,1],e.normal2([u[4],u[5]])),p-r>c?this._spacecraft.addThrusterBurn(I.YAW_RIGHT,Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(p-r,t))):-c>p-r&&this._spacecraft.addThrusterBurn(I.YAW_LEFT,Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(r-p,t))),n=Math.sign(u[6])*e.angle2u([1,0],e.normal2([u[5],u[6]])),d-n>c?this._spacecraft.addThrusterBurn(I.PITCH_UP,Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(d-n,t))):-c>d-n&&this._spacecraft.addThrusterBurn(I.PITCH_DOWN,Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(n-d,t))),s=Math.sign(-u[2])*e.angle2u([1,0],e.normal2([u[0],u[2]])),this._rollTarget-s>c?this._spacecraft.addThrusterBurn(I.ROLL_RIGHT,Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(this._rollTarget-s,t))):this._rollTarget-s<-c&&this._spacecraft.addThrusterBurn(I.ROLL_LEFT,Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(s-this._rollTarget,t))),this._speedTarget-l>h?this._spacecraft.addThrusterBurn(I.FORWARD,Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(this._speedTarget-l,t))):this._speedTarget-l<-h&&this._spacecraft.addThrusterBurn(I.REVERSE,Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(l-this._speedTarget,t))),(this._assisted||0!==this._strafeTarget)&&(l=a[12],this._strafeTarget-l>h?this._spacecraft.addThrusterBurn(I.STRAFE_RIGHT,Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(this._strafeTarget-l,t))):this._strafeTarget-l<-h&&this._spacecraft.addThrusterBurn(I.STRAFE_LEFT,Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(l-this._strafeTarget,t)))),(this._assisted||0!==this._liftTarget)&&(l=a[14],this._liftTarget-l>h?this._spacecraft.addThrusterBurn(I.RAISE,Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(this._liftTarget-l,t))):this._liftTarget-l<-h&&this._spacecraft.addThrusterBurn(I.LOWER,Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(l-this._liftTarget,t)))),this._spacecraft.updatePropulsionVisuals(),this._yawTarget=0,this._pitchTarget=0,this._rollTarget=0,this._strafeTarget=0,this._liftTarget=0},ManeuveringComputer.prototype.destroy=function(){this._spacecraft=null},JumpEngine.VELOCITY_TOLERANCE=.01,JumpEngine.JumpState={NONE:0,ALIGNING_VELOCITY:1,PREPARING:2,JUMPING_OUT:3,JUMPING_IN:4},Object.freeze(JumpEngine.JumpOutState),JumpEngine.prototype.acquireResources=function(){this._class.acquireResources()},JumpEngine.prototype.jumpOut=function(){var t;switch(this._state){case JumpEngine.JumpState.NONE:this._state=JumpEngine.JumpState.ALIGNING_VELOCITY,this._originalFlightMode=this._spacecraft.getFlightMode(),this._spacecraft.changeFlightMode(R.CRUISE),this._spacecraft.setSpeedTarget(this._class.getPrepareVelocity()),this._spacecraft.lockManeuvering(),this._spacecraft.disableFiring(),this._spacecraft.handleEvent(_.JUMP_ENGAGED)&&(this._soundClip=this._class.createEngageSoundClip(),this._soundClip&&this._soundClip.play());break;case JumpEngine.JumpState.ALIGNING_VELOCITY:case JumpEngine.JumpState.PREPARING:t=this._state===JumpEngine.JumpState.PREPARING,this._state=JumpEngine.JumpState.NONE,this._spacecraft.unlockManeuvering(),this._spacecraft.changeFlightMode(this._originalFlightMode),this._spacecraft.enableFiring(),this._soundClip&&(this._soundClip.stopPlaying(p.SOUND_RAMP_DURATION),this._soundClip=null),this._spacecraft.handleEvent(_.JUMP_CANCELLED)&&(this._soundClip=this._class.createDisengageSoundClip(),this._soundClip&&this._soundClip.play()),t&&(this._soundClip=this._class.createCancelSoundClip(),this._soundClip&&this._soundClip.play())}},JumpEngine.prototype.jumpIn=function(){var t,r,n;this._state===JumpEngine.JumpState.NONE&&(this._state=JumpEngine.JumpState.JUMPING_IN,this._timeLeft=this._class.getJumpInDuration(),this._spacecraft.lockManeuvering(),this._spacecraft.disableFiring(),r=f.getExplosion(),r.init(this._class.getJumpInExplosionClass(),this._spacecraft.getPhysicalPositionMatrix(),this._spacecraft.getPhysicalOrientationMatrix(),i.getRowC43(this._spacecraft.getPhysicalPositionMatrix()),!0,i.IDENTITY4),r.addToScene(this._spacecraft._visualModel.getNode()._scene._rootNode,this._spacecraft.getSoundSource()),this._originalScalingMatrix=i.matrix4(this._spacecraft._visualModel._scalingMatrix),n=this._spacecraft._physicalModel,t=i.getRowB4(n._orientationMatrix),n.setVelocityMatrix(i.translation4v(e.scaled3(t,this._class.getJumpInVelocity()+this._class.getJumpInDeceleration()*this._class.getJumpInDuration()/1e3))),n.addForce(new o.Force(w,n.getMass()*this._class.getJumpInDeceleration(),e.scaled3(t,-1),this._class.getJumpInDuration())),this._soundClip=this._class.createJumpInSoundClip(this._spacecraft.getSoundSource()),this._soundClip&&this._soundClip.play(),this._spacecraft.setAway(!1),this._spacecraft.handleEvent(_.JUMPED_IN))},JumpEngine.prototype.simulate=function(t){var e,r,n,s;switch(this._state){case JumpEngine.JumpState.ALIGNING_VELOCITY:e=this._spacecraft.getRelativeVelocityMatrix(),Math.abs(e[12])<JumpEngine.VELOCITY_TOLERANCE&&Math.abs(e[14])<JumpEngine.VELOCITY_TOLERANCE&&Math.abs(e[13]-this._class.getPrepareVelocity())<JumpEngine.VELOCITY_TOLERANCE&&(this._state=JumpEngine.JumpState.PREPARING,this._timeLeft=this._class.getPrepareDuration(),this._soundClip=this._class.createPrepareSoundClip(this._spacecraft.getSoundSource()),this._soundClip&&this._soundClip.play());break;case JumpEngine.JumpState.PREPARING:this._spacecraft.handleEvent(_.PREPARING_JUMP,{duration:this._class.getPrepareDuration(),timeLeft:this._timeLeft}),this._timeLeft<=0&&(this._state=JumpEngine.JumpState.JUMPING_OUT,this._timeLeft=this._class.getJumpOutDuration(),this._soundClip=this._class.createJumpOutSoundClip(this._spacecraft.getSoundSource()),this._soundClip&&this._soundClip.play(),s=this._spacecraft._physicalModel,r=i.getRowB4(s._orientationMatrix),s.addForce(new o.Force(w,s.getMass()*this._class.getJumpOutAcceleration(),r,this._class.getJumpOutDuration())),this._spacecraft.unlockManeuvering(),this._spacecraft.setSpeedTarget(Number.MAX_VALUE),this._spacecraft.lockManeuvering(),this._originalScalingMatrix=i.matrix4(this._spacecraft._visualModel._scalingMatrix),this._spacecraft.handleEvent(_.JUMP_OUT_STARTED)),this._timeLeft-=t;break;case JumpEngine.JumpState.JUMPING_OUT:this._spacecraft._visualModel.setScalingMatrix(i.prod3x3SubOf4(this._originalScalingMatrix,i.scaling4(1,1+(1-this._timeLeft/this._class.getJumpOutDuration())*(this._class.getJumpOutScaling()-1),1))),this._timeLeft<=0&&(this._state=JumpEngine.JumpState.NONE,n=f.getExplosion(),n.init(this._class.getJumpOutExplosionClass(),this._spacecraft.getPhysicalPositionMatrix(),this._spacecraft.getPhysicalOrientationMatrix(),i.getRowC43(this._spacecraft.getPhysicalPositionMatrix()),!0,i.IDENTITY4),n.addToScene(this._spacecraft._visualModel.getNode()._scene._rootNode,this._spacecraft.getSoundSource()),this._spacecraft.setAway(!0),this._spacecraft.handleEvent(_.JUMPED_OUT)),this._timeLeft-=t;break;case JumpEngine.JumpState.JUMPING_IN:this._timeLeft<0&&(this._timeLeft=0),this._spacecraft._visualModel.setScalingMatrix(i.prod3x3SubOf4(this._originalScalingMatrix,i.scaling4(1,1+this._timeLeft/this._class.getJumpInDuration()*(this._class.getJumpInScaling()-1),1))),this._timeLeft<=0&&(this._state=JumpEngine.JumpState.NONE,this._spacecraft.unlockManeuvering(),this._spacecraft.enableFiring(),this._spacecraft.handleEvent(_.ARRIVED)),this._timeLeft-=t}},JumpEngine.prototype.destroy=function(){this._class=null,this._spacecraft=null,this._soundClip&&(this._soundClip.destroy(),this._soundClip=null),this._originalScalingMatrix=null},b=a.getPool(l.Particle),O=a.getPool(Projectile),g.executeWhenReady(function(){U=g.getSetting(g.BATTLE_SETTINGS.SELF_FIRE),j=g.getSetting(g.BATTLE_SETTINGS.MOMENT_DURATION),G=g.getSetting(g.BATTLE_SETTINGS.MINIMUM_MUZZLE_FLASH_PARTICLE_COUNT_FOR_INSTANCING),k=g.getSetting(g.BATTLE_SETTINGS.MINIMUM_PROJECTILE_COUNT_FOR_INSTANCING),S=g.getSetting(g.BATTLE_SETTINGS.MAX_COMBAT_FORWARD_SPEED_FACTOR),y=g.getSetting(g.BATTLE_SETTINGS.MAX_COMBAT_REVERSE_SPEED_FACTOR),T=g.getSetting(g.BATTLE_SETTINGS.MAX_CRUISE_FORWARD_SPEED_FACTOR),E=g.getSetting(g.BATTLE_SETTINGS.MAX_CRUISE_REVERSE_SPEED_FACTOR),C=g.getSetting(g.BATTLE_SETTINGS.SHOW_HITBOXES_FOR_HITCHECKS),H=g.getSetting(g.GENERAL_SETTINGS.UNIFORM_LUMINOSITY_FACTORS_ARRAY_NAME),W=g.getSetting(g.GENERAL_SETTINGS.UNIFORM_GROUP_TRANSFORMS_ARRAY_NAME),M=g.getSetting(g.BATTLE_SETTINGS.FIRE_SOUND_STACKING_TIME_THRESHOLD),x=g.getSetting(g.BATTLE_SETTINGS.FIRE_SOUND_STACKING_VOLUME_FACTOR)}),{FlightMode:R,ThrusterUse:I,Projectile:Projectile,Weapon:Weapon,TargetingComputer:TargetingComputer,Propulsion:Propulsion,JumpEngine:JumpEngine,ManeuveringComputer:ManeuveringComputer}}),define("armada/logic/spacecraft",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/managed-gl","modules/egom-model","modules/physics","modules/media-resources","modules/scene/renderable-objects","modules/scene/lights","modules/scene/scene-graph","armada/graphics","armada/audio","armada/logic/classes","armada/configuration","armada/strings","armada/logic/constants","armada/logic/SpacecraftEvents","armada/logic/equipment","armada/logic/explosion","utils/polyfill"],function(t,e,i,r,n,o,s,a,l,h,u,c,p,d,_,g,m,f,S,y){"use strict";function Blinker(t){this._descriptor=t,this._visualModel=null,this._lightSource=null}function Spacecraft(t,e,r,n,o,s){this._class=null,this._id=null,this._name=null,this._displayName=null,this._alive=!0,this._away=!1,this._hitpoints=0,this._maxHitpoints=0,this._visualModel=null,this._hitbox=null,this._blinkers=null,this._physicalModel=null,this._relativeVelocityMatrix=i.identity4(),this._relativeVelocityMatrixValid=!1,this._turningMatrix=i.identity4(),this._turningMatrixValid=!1,this._scaledOriMatrix=i.identity4(),this._weapons=null,this._targetingComputer=null,this._firingDisabled=!1,this._propulsion=null,this._jumpEngine=null,this._maneuveringComputer=null,this._activeDamageIndicators=[],this._explosion=null,this._eventHandlers=null,this._targetedBy=null,this._team=null,this._squad=null,this._indexInSquad=0,this._humSoundClip=null,this._humSoundVolume=0,this._soundSource=null,this._kills=0,this._score=0,this._damageDealt=0,this._shotsFired=0,this._hitsOnEnemies=0,this._scoreValue=0,this._timeElapsedSinceDestruction=-1,t&&this._init(t,e,r,n,o,s)}var T,E,C,M="hitBox",x="originalFactionColor",b="replacementFactionColor",O=.02,R=null,A=null,I=null;return Blinker.prototype.addToScene=function(t,e){this._visualModel=new l.Particle(this._descriptor.getParticle().getModel(),this._descriptor.getParticle().getShader(),this._descriptor.getParticle().getTexturesOfTypes(this._descriptor.getParticle().getShader().getTextureTypes(),c.getTextureQualityPreferenceList()),i.translation4v(this._descriptor.getPosition()),this._descriptor.getParticleStates(),!0,this._descriptor.getParticle().getInstancedShader(),0),t.addSubnode(new u.RenderableNode(this._visualModel,!1,!1,_.getSetting(_.BATTLE_SETTINGS.MINIMUM_BLINKER_PARTICLE_COUNT_FOR_INSTANCING))),e===!0&&this._descriptor.getIntensity()>0&&(this._lightSource=new h.PointLightSource(this._descriptor.getLightColor(),0,this._descriptor.getPosition(),[t._renderableObject],this._descriptor.getLightStates(),!0),t._scene.addPointLightSource(this._lightSource,m.BLINKER_LIGHT_PRIORITY))},Blinker.prototype.setTime=function(t){this._visualModel.setAnimationTime(t),this._lightSource&&this._lightSource.setAnimationTime(t)},Blinker.prototype.setRandomTime=function(){var t=Math.round(Math.random()*this._descriptor.getPeriod());return this.setTime(t),t},Spacecraft.prototype._init=function(t,e,r,n,o,l){var h,u;for(this._class=t,this._name=e||"",this._alive=!0,this._away=!1,this._hitpoints=this._class.getHitpoints(),this._maxHitpoints=this._class.getHitpoints(),this._physicalModel=new s.PhysicalObject(this._class.getMass(),r||i.identity4(),n||i.identity4(),i.identity4(),i.identity4(),this._class.getBodies()),this._class.acquireResources(),a.executeWhenReady(function(){this.isAlive()&&this._physicalModel.setScalingMatrix(i.scaling4(this._class.getModel().getScale()))}.bind(this)),this._weapons=[],this._targetingComputer=new S.TargetingComputer(this,l),this._firingDisabled=!1,this._maneuveringComputer=new S.ManeuveringComputer(this),this._blinkers=[],u=this._class.getBlinkerDescriptors(),h=0;h<u.length;h++)this._blinkers.push(new Blinker(u[h]));o&&this.equipProfile(this._class.getEquipmentProfile(o)),this._targetedBy=[],this._eventHandlers={},this._team=null,this._kills=0,this._score=0,this._damageDealt=0,this._shotsFired=0,this._hitsOnEnemies=0,this._hitSounds={},this._hitSoundTimestamp=0,this._updateIDAndName(),this._updateScoreValue()},Spacecraft.prototype._updateIDAndName=function(){this._id=this._name||!this._squad?this._name:this._squad+" "+this._indexInSquad.toString(),this._displayName=this._name||!this._squad?this._name:g.get(g.SQUAD.PREFIX,this._squad)+" "+this._indexInSquad.toString()},Spacecraft.prototype.isAlive=function(){return this._alive},Spacecraft.prototype.isAway=function(){return this._away},Spacecraft.prototype.setAway=function(t){this._away!==t&&(this._away=t,this._away?(this.setTarget(null),this._visualModel&&this._visualModel.getNode().hide(),this._humSoundClip&&this._humSoundClip.stopPlaying(p.SOUND_RAMP_DURATION),this._propulsion&&(this._propulsion.resetThrusterBurn(),this._propulsion.simulate(this.getSoundSource(),!1))):this._visualModel&&this._visualModel.getNode().show())},Spacecraft.prototype.setTeam=function(t){this._team=t},Spacecraft.prototype.getTeam=function(){return this._team},Spacecraft.prototype.setSquad=function(t,e){this._squad=t,this._indexInSquad=e,this._updateIDAndName()},Spacecraft.prototype.getSquad=function(){return this._squad},Spacecraft.prototype.isFriendly=function(t){return t.getTeam()===this._team},Spacecraft.prototype.isHostile=function(t){return t.getTeam()!==this._team},Spacecraft.prototype.getClass=function(){return this._class},Spacecraft.prototype.isFighter=function(){return this._class.isFighterClass()},Spacecraft.prototype.getID=function(){return this._id},Spacecraft.prototype.getDisplayName=function(){return this._displayName},Spacecraft.prototype.getHitpoints=function(){return this._hitpoints},Spacecraft.prototype.getFullIntegrityHitpoints=function(){return this._maxHitpoints},Spacecraft.prototype.getHullIntegrity=function(){return this._hitpoints/this._maxHitpoints},Spacecraft.prototype.multiplyMaxHitpoints=function(t){this._hitpoints*=t,this._maxHitpoints*=t},Spacecraft.prototype.getVisualModel=function(){return this._visualModel},Spacecraft.prototype.getPhysicalModel=function(){return this._physicalModel},Spacecraft.prototype.getExplosion=function(){return this._explosion},Spacecraft.prototype.getClassName=function(){return this._class.getName()},Spacecraft.prototype.getTypeName=function(){return this._class.getSpacecraftType().getName()},Spacecraft.prototype.isGoodAgainst=function(t){return this._class.getSpacecraftType().isGoodAgainst(t.getClass().getSpacecraftType())},Spacecraft.prototype.isBadAgainst=function(t){return this._class.getSpacecraftType().isBadAgainst(t.getClass().getSpacecraftType())},Spacecraft.prototype.getView=function(t){return this._class.getView(t)},Spacecraft.prototype.enableFiring=function(){this._firingDisabled=!1},Spacecraft.prototype.disableFiring=function(){this._firingDisabled=!0},Spacecraft.prototype.getWeapons=function(){return this._weapons},Spacecraft.prototype.getFirepower=function(t){var e,i=0;for(e=0;e<this._weapons.length;e++)i+=this._weapons[e].getFirepower(t);return i},Spacecraft.prototype.canBeReused=function(){return!this._alive},Spacecraft.prototype.getHitRatio=function(){return this._shotsFired?this._hitsOnEnemies/this._shotsFired:0},Spacecraft.prototype.getKills=function(){return this._kills},Spacecraft.prototype.gainKill=function(){this._kills++},Spacecraft.prototype.getScore=function(){return this._score},Spacecraft.prototype.gainScore=function(t){this._score+=t},Spacecraft.prototype.getDamageDealt=function(){return this._damageDealt},Spacecraft.prototype.gainDamageDealt=function(t){this._damageDealt+=t},Spacecraft.prototype.getScoreValue=function(){return this._scoreValue},Spacecraft.prototype.setPhysicalPosition=function(t){this._physicalModel.setPositionMatrix(i.translation4v(t))},Spacecraft.prototype.setPhysicalPositionMatrix=function(t){this._physicalModel.setPositionMatrix(t)},Spacecraft.prototype.getPhysicalPositionMatrix=function(){return this._physicalModel._positionMatrix},Spacecraft.prototype.getPhysicalPositionVector=function(){return i.translationVector3(this._physicalModel._positionMatrix)},Spacecraft.prototype.setPhysicalOrientationMatrix=function(t){this._physicalModel.setOrientationMatrix(t)},Spacecraft.prototype.getPhysicalOrientationMatrix=function(){return this._physicalModel._orientationMatrix},Spacecraft.prototype.getPhysicalScalingMatrix=function(){return this._physicalModel._scalingMatrix},Spacecraft.prototype.updateScaledOriMatrix=function(){i.setProd3x3SubOf4(this._scaledOriMatrix,this.getPhysicalScalingMatrix(),this.getPhysicalOrientationMatrix())},Spacecraft.prototype.getScaledOriMatrix=function(){return this._scaledOriMatrix},Spacecraft.prototype.getPositionMatrixInCameraSpace=function(){return this._visualModel.getPositionMatrixInCameraSpace(this._visualModel.getNode()._scene._camera)},Spacecraft.prototype.getVelocityMatrix=function(){return this._physicalModel.getVelocityMatrix()},Spacecraft.prototype.getRelativeVelocityMatrix=function(){return this._relativeVelocityMatrixValid||(i.setProdTranslationRotation4(this._relativeVelocityMatrix,this._physicalModel.getVelocityMatrix(),i.rotation4m4Aux(this._physicalModel.getRotationMatrixInverse())),this._relativeVelocityMatrixValid=!0),this._relativeVelocityMatrix},Spacecraft.prototype.getTurningMatrix=function(){return this._turningMatrixValid||(i.setProd3x3SubOf4(this._turningMatrix,i.prod3x3SubOf4Aux(this._physicalModel._orientationMatrix,this._physicalModel.getAngularVelocityMatrix()),i.rotation4m4Aux(this._physicalModel.getRotationMatrixInverse())),this._turningMatrixValid=!0),this._turningMatrix},Spacecraft.prototype.getMaxAcceleration=function(){return this._propulsion?this._propulsion.getThrust()/this._physicalModel.getMass():null},Spacecraft.prototype.getMaxAngularAcceleration=function(){return this._propulsion?this._propulsion.getAngularThrust()/this._physicalModel.getMass():0},Spacecraft.prototype.getMaxThrusterMoveBurnLevel=function(){return this._propulsion?this._propulsion.getMaxMoveBurnLevel():0},Spacecraft.prototype.getMaxThrusterTurnBurnLevel=function(){return this._propulsion?this._propulsion.getMaxTurnBurnLevel():0},Spacecraft.prototype.getMaxTurnRateAtSpeed=function(t){var e=Math.abs(this._propulsion.getThrust()/(this._physicalModel.getMass()*t));return 1>=e?Math.asin(e):Number.MAX_VALUE},Spacecraft.prototype.getHitboxTextures=function(){var t=c.getManagedShader(_.getSetting(_.BATTLE_SETTINGS.HITBOX_SHADER_NAME)).getTextureTypes(),e=c.getTexture(_.getSetting(_.BATTLE_SETTINGS.HITBOX_TEXTURE_NAME),{types:t});return e.getManagedTexturesOfTypes(t,c.getTextureQualityPreferenceList())},Spacecraft.prototype.getNeededBurnForSpeedChange=function(t,e){return t*this._physicalModel.getMass()/this._propulsion.getThrust()*this._propulsion.getMaxMoveBurnLevel()/(e/1e3)},Spacecraft.prototype.getNeededBurnForAngularVelocityChange=function(t,e){return t/s.ANGULAR_VELOCITY_MATRIX_DURATION_S*this._physicalModel.getMass()/this._propulsion.getAngularThrust()*this._propulsion.getMaxTurnBurnLevel()/(e/1e3)},Spacecraft.prototype.loadFromJSON=function(t,e){var n,o;this._init(d.getSpacecraftClass(t["class"]),t.name,t.position?i.translation4v(t.position):null,i.rotation4FromJSON(t.rotations),void 0,e),t.squad&&("string"==typeof t.squad?(o=t.squad.split(" "),this.setSquad(o[0],parseInt(o[1],10))):"object"==typeof t.squad?this.setSquad(t.squad.name,t.squad.index):r.showError("Invalid squad property specified for spacecraft "+this.getID()+"!")),t.equipment?"string"==typeof t.equipment?this.equipProfile(this._class.getEquipmentProfile(t.equipment)):"object"==typeof t.equipment?(n=new d.EquipmentProfile(t.equipment),this.equipProfile(n)):r.showError("Invalid equipment property specified for spacecraft "+this.getID()+"!"):void 0!==this._class.getEquipmentProfile(_.getSetting(_.BATTLE_SETTINGS.DEFAULT_EQUIPMENT_PROFILE_NAME))&&this.equipProfile(this._class.getEquipmentProfile(_.getSetting(_.BATTLE_SETTINGS.DEFAULT_EQUIPMENT_PROFILE_NAME))),t.away&&this.setAway(!0)},Spacecraft.prototype.moveByVector=function(t){this._physicalModel.moveByVector(t)},Spacecraft.prototype.isManeuveringLocked=function(){return this._maneuveringComputer.isLocked()},Spacecraft.prototype.lockManeuvering=function(){this._maneuveringComputer.setLocked(!0)},Spacecraft.prototype.unlockManeuvering=function(){this._maneuveringComputer.setLocked(!1)},Spacecraft.prototype.getFlightMode=function(){return this._maneuveringComputer.getFlightMode()},Spacecraft.prototype.changeFlightMode=function(t){return this._maneuveringComputer.changeFlightMode(t)},Spacecraft.prototype.toggleFlightAssist=function(){return this._maneuveringComputer.toggleFlightAssist()},Spacecraft.prototype.toggleCruise=function(){return this._maneuveringComputer.toggleCruise()},Spacecraft.prototype.forward=function(t){this._maneuveringComputer.forward(t)},Spacecraft.prototype.stopForward=function(){this._maneuveringComputer.stopForward()},Spacecraft.prototype.reverse=function(t){this._maneuveringComputer.reverse(t)},Spacecraft.prototype.stopReverse=function(){this._maneuveringComputer.stopReverse()},Spacecraft.prototype.strafeLeft=function(t){this._maneuveringComputer.strafeLeft(t)},Spacecraft.prototype.stopLeftStrafe=function(){this._maneuveringComputer.stopLeftStrafe()},Spacecraft.prototype.strafeRight=function(t){this._maneuveringComputer.strafeRight(t)},Spacecraft.prototype.stopRightStrafe=function(){this._maneuveringComputer.stopRightStrafe()},Spacecraft.prototype.raise=function(t){this._maneuveringComputer.raise(t)},Spacecraft.prototype.stopRaise=function(){this._maneuveringComputer.stopRaise()},Spacecraft.prototype.lower=function(t){this._maneuveringComputer.lower(t)},Spacecraft.prototype.stopLower=function(){this._maneuveringComputer.stopLower()},Spacecraft.prototype.resetSpeed=function(){this._maneuveringComputer.resetSpeed()},Spacecraft.prototype.setSpeedTarget=function(t){this._maneuveringComputer.setSpeedTarget(t)},Spacecraft.prototype.getSpeedTarget=function(){return this._maneuveringComputer.getSpeedTarget()},Spacecraft.prototype.hasSpeedTarget=function(){return this._maneuveringComputer.hasSpeedTarget()},Spacecraft.prototype.getMaxSpeed=function(){return this._maneuveringComputer.getMaxSpeed()},Spacecraft.prototype.yawLeft=function(t){this._maneuveringComputer.yawLeft(t)},Spacecraft.prototype.yawRight=function(t){this._maneuveringComputer.yawRight(t)},Spacecraft.prototype.pitchUp=function(t){this._maneuveringComputer.pitchUp(t)},Spacecraft.prototype.pitchDown=function(t){this._maneuveringComputer.pitchDown(t)},Spacecraft.prototype.rollLeft=function(t){this._maneuveringComputer.rollLeft(t)},Spacecraft.prototype.rollRight=function(t){this._maneuveringComputer.rollRight(t)},Spacecraft.prototype._addHitboxModel=function(t){var e=a.getOrAddModel(o.cuboidModel(M,1,1,1,T)),r=new l.ShadedLODMesh(e.getEgomModel(),c.getManagedShader(_.getSetting(_.BATTLE_SETTINGS.HITBOX_SHADER_NAME)),this.getHitboxTextures(),i.translation4m4(this._class.getBodies()[t]._positionMatrix),this._class.getBodies()[t]._orientationMatrix,i.scaling4(this._class.getBodies()[t].getWidth(),this._class.getBodies()[t].getHeight(),this._class.getBodies()[t].getDepth()),!1);r.setUniformValueFunction(l.UNIFORM_COLOR_NAME,function(){return T}),r.setUniformValueFunction(A,function(){return I}),this._hitbox.addSubnode(new u.RenderableNode(r,!1))},Spacecraft.prototype.getHitbox=function(){return this._hitbox},Spacecraft.prototype.acquireResources=function(t,e,i){r.log_DEBUG("Requesting resources for spacecraft ("+this._class.getName()+")...",2);var n=void 0===t?{maxLOD:c.getMaxLoadedLOD()}:{lod:t};e&&(c.getShader(_.getSetting(_.BATTLE_SETTINGS.HITBOX_SHADER_NAME)),c.getTexture(_.getSetting(_.BATTLE_SETTINGS.HITBOX_TEXTURE_NAME))),n.omitShader=i,this._class.acquireResources(n)},Spacecraft.prototype.addToScene=function(t,o,s,p,d,_,g){var f,S,T,E;if(p=p||{},d=d||{},this.acquireResources(o,p&&p.hitboxes===!0,!!d.shaderName),d.shaderName&&c.getShader(d.shaderName),p.weapons===!0)for(f=0;f<this._weapons.length;f++)this._weapons[f].acquireResources(o,p.projectileResources);if(p.thrusterParticles===!0&&this._propulsion&&(this._propulsion.addThrusters(this._class.getThrusterSlots()),this._propulsion.acquireResources()),p.jumpEngine===!0&&this._jumpEngine&&this._jumpEngine.acquireResources(),p.explosion===!0&&this._class.getExplosionClass().acquireResources(),p.blinkers===!0)for(S=this._class.getBlinkerDescriptors(),f=0;f<S.length;f++)S[f].acquireResources();a.executeWhenReady(function(){var a,S,C,M,O,I,v,N={};if(!this._class)return void r.log("WARNING! Cannot add spacecraft to scene because it has already been destroyed!");if(r.log_DEBUG("Adding spacecraft ("+this._class.getName()+") to scene...",2),p.self!==!1){for(N[A]=n.ShaderVariableType.MAT4,c.areLuminosityTexturesAvailable()&&(N[R]=n.ShaderVariableType.FLOAT),T=new l.ParameterizedMesh(this._class.getModel(),d.shaderName?c.getManagedShader(d.shaderName):this._class.getShader(),this._class.getTexturesOfTypes(this._class.getShader().getTextureTypes(),c.getTextureQualityPreferenceList()),d.positionMatrix||this._physicalModel._positionMatrix,d.orientationMatrix||this._physicalModel._orientationMatrix,d.scalingMatrix||i.scaling4(this._class.getModel().getScale()),s===!0,o,N),(!this._visualModel||d.replaceVisualModel)&&(this._visualModel=T),this._name&&T.setName(this._name),I=this._class.getFactionColor(),v=d.factionColor||this._team&&this._team.getColor()||I,T.setUniformValueFunction(x,function(){return I}),T.setUniformValueFunction(b,function(){return v}),f=0,S=c.getMaxGroupTransforms();S>f;f++)T.setMat4Parameter(A,f,i.IDENTITY4);if(c.areLuminosityTexturesAvailable())for(a=0,S=c.getMaxLuminosityFactors();S>a;a++)T.setFloatParameter(R,a,this._class.getDefaultGroupLuminosity(a));C=t.addObject(T),d.visualModel&&r.showError("Attempting to specify a visual model for the Spacecraft.addToScene() operation while a new one is also created!",r.ErrorSeverity.MINOR)}else T=d.visualModel||this._visualModel,C=T.getNode();if(p.hitboxes===!0){for(this._hitbox=new u.RenderableNode(new l.RenderableObject3D(this._class.getShader(),!1,!1),!1),f=0;f<this._class.getBodies().length;f++)this._addHitboxModel(f);this._hitbox.hide(),C.addSubnode(this._hitbox)}if(p.weapons===!0)for(f=0;f<this._weapons.length;f++)this._weapons[f].addToScene(C,o,s,{shaderName:d.shaderName},g);if(p.thrusterParticles===!0&&this._propulsion&&this._propulsion.addToScene(C),p.projectileResources===!0)for(f=0;f<this._weapons.length;f++)this._weapons[f].addProjectileResourcesToScene(t);if(p.explosion===!0&&(M=new y.Explosion(this._class.getExplosionClass(),i.IDENTITY4,i.IDENTITY4,e.NULL3,!0),M.addResourcesToScene(t)),p.cameraConfigurations===!0&&this._addCameraConfigurationsForViews(),p.lightSources===!0)for(O=this._class.getLightSources(),f=0;f<O.length;f++)O[f].spotDirection?t.addSpotLightSource(new h.SpotLightSource(O[f].color,O[f].intensity,O[f].position,O[f].spotDirection,O[f].spotCutoffAngle,O[f].spotFullIntensityAngle,[T])):t.addPointLightSource(new h.PointLightSource(O[f].color,O[f].intensity,O[f].position,[T]),m.SPACECRAFT_LIGHT_PRIORITY);if(p.blinkers===!0)for(f=0;f<this._blinkers.length;f++)this._blinkers[f].addToScene(C,p.lightSources),d.randomAnimationTime&&(0===f?E=this._blinkers[f].setRandomTime():this._blinkers[f].setTime(E));this._away&&C.hide(),_&&_(T)}.bind(this))},Spacecraft.prototype.createCameraConfigurationForView=function(t){return t.createCameraConfiguration(this._visualModel,_.getDefaultCameraBaseOrientation(),_.getDefaultCameraPointToFallback(),_.getDefaultCameraFOV(),_.getDefaultCameraFOVRange(),_.getDefaultCameraSpan(),_.getDefaultCameraSpanRange())},Spacecraft.prototype._addCameraConfigurationsForViews=function(){var t;for(t=0;t<this._class.getViews().length;t++)this._visualModel.getNode().addCameraConfiguration(this.createCameraConfigurationForView(this._class.getViews()[t]))},Spacecraft.prototype._updateScoreValue=function(){var t;for(this._scoreValue=this._class.getScoreValue(),t=0;t<this._weapons.length;t++)this._scoreValue+=this._weapons[t].getScoreValue();this._propulsion&&(this._scoreValue+=this._propulsion.getScoreValue())},Spacecraft.prototype._addWeapon=function(t,e){var i,r=this._class.getWeaponSlots();(void 0===e||0>e)&&(e=this._weapons.length),e<r.length&&(i=r[e],this._weapons.push(new S.Weapon(t,this,i)))},Spacecraft.prototype._addPropulsion=function(t){this._propulsion=new S.Propulsion(t,this._physicalModel),this._maneuveringComputer.updateForNewPropulsion(),this._maneuveringComputer.updateTurningLimit()},Spacecraft.prototype._addJumpEngine=function(t){this._jumpEngine=new S.JumpEngine(t,this)},Spacecraft.prototype.unequip=function(){var t;for(t=0;t<this._weapons.length;t++)this._weapons[t].destroy();this._weapons=[],this._propulsion&&this._propulsion.destroy(),this._propulsion=null,this._maneuveringComputer.updateForNewPropulsion(),this._maneuveringComputer.updateTurningLimit(),this._updateScoreValue()},Spacecraft.prototype.equipProfile=function(t){var e,i;if(t){for(i=t.getWeaponDescriptors(),e=0;e<i.length;e++)this._addWeapon(d.getWeaponClass(i[e].className),i[e].slotIndex);null!==t.getPropulsionDescriptor()&&this._addPropulsion(d.getPropulsionClass(t.getPropulsionDescriptor().className)),null!==t.getJumpEngineDescriptor()&&this._addJumpEngine(d.getJumpEngineClass(t.getJumpEngineDescriptor().className))}else r.log("WARNING: equipping empty profile on "+this._class.getName()+"!");this._updateScoreValue()},Spacecraft.prototype.getEquipmentProfileNames=function(){return this._class.getEquipmentProfileNames()},Spacecraft.prototype.fire=function(t){var e,r,n,o,s=!1;if(!this._firingDisabled){for(r=this.getScaledOriMatrix(),o=i.translationVector3(this.getPositionMatrixInCameraSpace()),Math.abs(o[0])<=E&&Math.abs(o[1])<=E&&Math.abs(o[2])<=E&&(o=null),e=0;e<this._weapons.length;e++)n=this._weapons[e].fire(r,t,o?this.getSoundSource():null),s=n>0||s,this._shotsFired+=n;if(s){for(e=0;e<this._targetedBy.length;e++)this._targetedBy[e].handleEvent(f.TARGET_FIRED);this.handleEvent(f.FIRED)}}},Spacecraft.prototype.increaseHitsOnEnemies=function(){this._hitsOnEnemies++},Spacecraft.prototype.setBeingTargeted=function(t){this._targetedBy&&(this._targetedBy.push(t),this.handleEvent(f.BEING_TARGETED,{spacecraft:t}))},Spacecraft.prototype.setBeingUntargeted=function(t){this._targetedBy&&this._targetedBy.splice(this._targetedBy.indexOf(t),1)},Spacecraft.prototype.getTargetingSpacecrafts=function(){return this._targetedBy},Spacecraft.prototype.setTarget=function(t){this._targetingComputer.setTarget(t)},Spacecraft.prototype.targetNextNearestHostile=function(){return this._targetingComputer.targetNextNearestHostile()},Spacecraft.prototype.targetPreviousNearestHostile=function(){return this._targetingComputer.targetPreviousNearestHostile()},Spacecraft.prototype.targetNextBestHostile=function(){return this._targetingComputer.targetNextBestHostile()},Spacecraft.prototype.targetNextNearestNonHostile=function(){return this._targetingComputer.targetNextNearestNonHostile();
},Spacecraft.prototype.getTarget=function(){return this._targetingComputer.getTarget()},Spacecraft.prototype.getTargetHitPosition=function(){return this._targetingComputer.getTargetHitPosition()},Spacecraft.prototype.getPropulsion=function(){return this._propulsion},Spacecraft.prototype.resetThrusterBurn=function(){this._propulsion.resetThrusterBurn()},Spacecraft.prototype.addThrusterBurn=function(t,e){this._propulsion.addThrusterBurn(t,e)},Spacecraft.prototype.updatePropulsionVisuals=function(){this._propulsion.updateVisuals()},Spacecraft.prototype.showHitbox=function(){this._hitbox.show()},Spacecraft.prototype.hideHitbox=function(){this._hitbox.hide()},Spacecraft.prototype.toggleHitboxVisibility=function(){this._hitbox.toggleVisibility()},Spacecraft.prototype.resetViewCameras=function(){this._visualModel.getNode().resetCameraConfigurations()},Spacecraft.prototype.damage=function(t,e,r,n){var o,s,a,l,h,u;if(t=Math.max(0,t-this._class.getArmor()),h=this._hitpoints>0,this._hitpoints-=t,this._hitpoints<=0)h&&n&&this.isHostile(n)&&(u=this.getScoreValue(),t+=this._hitpoints,n.gainDamageDealt(t),n.gainScore((1-C)*t/this._maxHitpoints*u),n.gainScore(C*u),n.gainKill()),this._hitpoints=0;else{for(o=0;o<this._class.getDamageIndicators().length;o++)s=this._class.getDamageIndicators()[o],a=s.hullIntegrity/100*this._maxHitpoints,this._hitpoints<=a&&this._hitpoints+t>a&&(l=y.getExplosion(),l.init(s.explosionClass,i.translation4vAux(e),i.IDENTITY4,r,!0),l.addToScene(this._visualModel.getNode(),this.getSoundSource()),this._activeDamageIndicators.push(l));h&&n&&n.isAlive()&&this.isHostile(n)&&(n.gainDamageDealt(t),n.gainScore((1-C)*t/this._maxHitpoints*this.getScoreValue()))}this.handleEvent(f.BEING_HIT,{spacecraft:n,hitPosition:e}),n.isAlive()&&!n.isAway()&&(n.getTarget()===this&&n.handleEvent(f.TARGET_HIT),n.handleEvent(f.ANY_SPACECRAFT_HIT,{spacecraft:this})),this.isHostile(n)&&n.increaseHitsOnEnemies()},Spacecraft.prototype.aimWeapons=function(t,e,i){var r,n,o=this.getTarget();for(o&&this._weapons.length>0&&(r=this.getTargetHitPosition()),n=0;n<this._weapons.length;n++)o&&!this._firingDisabled?this._weapons[n].aimTowards(r,t,e,this.getScaledOriMatrix(),i):this._weapons[n].rotateToDefaultPosition(t,i)},Spacecraft.prototype.jumpOut=function(){!this._away&&this._jumpEngine?this._jumpEngine.jumpOut():r.log("Warning! Spacecraft '"+this.getDisplayName()+"' cannot jump out because it is already away or has no jump engines!")},Spacecraft.prototype.jumpIn=function(){this._away&&this._jumpEngine?this._jumpEngine.jumpIn():r.log("Warning! Spacecraft '"+this.getDisplayName()+"' cannot jump in because it is already present or has no jump engines!")},Spacecraft.prototype._getSoundSourcePosition=function(){var t=this.getPositionMatrixInCameraSpace();return t=[parseFloat(t[12].toPrecision(1)),parseFloat(t[13].toPrecision(1)),parseFloat(t[14].toPrecision(1))]},Spacecraft.prototype.getSoundSource=function(){return this._soundSource||(this._soundSource=p.createSoundSource([0,0,0])),this._soundSource},Spacecraft.prototype._startHumSound=function(){this._humSoundClip.setVolume(0),this._humSoundClip.play(),this._humSoundClip.rampVolume(this._humSoundVolume,O,!0,!0)},Spacecraft.prototype.respawn=function(t){var e;for(this._alive=!0,this._hitpoints=this._maxHitpoints,this._timeElapsedSinceDestruction=-1,this._humSoundClip&&this._startHumSound(),e=0;e<this._blinkers.length;e++)t?this._blinkers[e].setRandomTime():this._blinkers[e].setTime(0)},Spacecraft.prototype.setHitpointsToZero=function(){this._hitpoints=0},Spacecraft.DEFAULT_SIMULATE_PARAMS={controlThrusters:!0,applyThrusterForces:!0},Spacecraft.prototype.simulate=function(t,e){var r,n;if(this._alive&&!this._away){if(e=e||Spacecraft.DEFAULT_SIMULATE_PARAMS,this._targetingComputer.simulate(t),n=this._getSoundSourcePosition(),this.getSoundSource().setPosition(n[0],n[1],n[2]),this._hitpoints<=0){if(this._timeElapsedSinceDestruction<0)for(this._timeElapsedSinceDestruction=0,this._humSoundClip&&this._humSoundClip.stopPlaying(p.SOUND_RAMP_DURATION),this._propulsion&&(this._propulsion.resetThrusterBurn(),this._propulsion.simulate(this.getSoundSource(),!1)),this._explosion=y.getExplosion(),this._explosion.init(this._class.getExplosionClass(),this._physicalModel._positionMatrix,this._physicalModel._orientationMatrix,i.getRowC43(this._physicalModel._positionMatrix),!0,this._physicalModel.getVelocityMatrix()),this._explosion.addToScene(this._visualModel.getNode()._scene._rootNode,this.getSoundSource()),r=0;r<this._activeDamageIndicators;r++)this._activeDamageIndicators[r].finish();else if(this._timeElapsedSinceDestruction+=t,this._timeElapsedSinceDestruction>this._class.getExplosionClass().getTotalDuration()*this._class.getShowTimeRatioDuringExplosion())return this._alive=!1,void(this.handleEvent(f.DESTRUCTED)!==!1&&this.destroy(!0))}else{for(r=0;r<this._weapons.length;r++)this._weapons[r].simulate(t);this._propulsion&&(e.controlThrusters&&this._maneuveringComputer.controlThrusters(t),this._propulsion.simulate(this._soundSource,e.applyThrusterForces)),this._jumpEngine&&this._jumpEngine.simulate(t),this._class.hasHumSound()&&(this._humSoundClip||(this._humSoundClip=this._class.createHumSoundClip(this._soundSource),this._humSoundVolume=this._humSoundClip.getVolume(),this._humSoundClip&&this._startHumSound()))}this._physicalModel.simulate(t),this._relativeVelocityMatrixValid=!1,this._turningMatrixValid=!1,this.updateScaledOriMatrix(),this._visualModel.setPositionMatrix(this._physicalModel._positionMatrix),this._visualModel.setOrientationMatrix(this._physicalModel._orientationMatrix),this._propulsion&&this._maneuveringComputer.updateSpeedIncrement(t)}},Spacecraft.prototype.addEventHandler=function(t,e){this._eventHandlers[t]=this._eventHandlers[t]||[],this._eventHandlers[t].push(e)},Spacecraft.prototype.handleEvent=function(t,e){var i,r;if(this._eventHandlers&&this._eventHandlers[t])for(r=!0,i=0;i<this._eventHandlers[t].length;i++)r=this._eventHandlers[t][i](e)&&r;return r},Spacecraft.prototype.getMaxProjectileCount=function(){var t,e=0;for(t=0;t<this._weapons.length;t++)e+=this._weapons[t].getMaxProjectileCount();return e},Spacecraft.prototype.getMaxExplosionCount=function(){var t,e=0;for(e+=1,e+=this._class.getDamageIndicators().length,t=0;t<this._weapons.length;t++)e+=this._weapons[t].getMaxExplosionCount();return e},Spacecraft.prototype.getMaxParticleCount=function(){var t,e,i=0;for(i+=this._class.getExplosionClass().getMaxParticleCount(),e=this._class.getDamageIndicators(),t=0;t<e.length;t++)i+=e[t].explosionClass.getMaxParticleCount();for(t=0;t<this._weapons.length;t++)i+=this._weapons[t].getMaxParticleCount();return i},Spacecraft.prototype.destroy=function(t){var e;if(t||(this._class=null),this._weapons)for(e=0;e<this._weapons.length;e++)this._weapons[e]&&(this._weapons[e].destroy(),this._weapons[e]=null);this._weapons=null,this._propulsion&&(this._propulsion.destroy(),this._propulsion=null),this._jumpEngine&&(this._jumpEngine.destroy(),this._jumpEngine=null),this._maneuveringComputer&&(this._maneuveringComputer.destroy(),this._maneuveringComputer=null),this._targetingComputer&&(this._targetingComputer.destroy(),this._targetingComputer=null),this._targetedBy=null,this._eventHandlers=null,this._explosion=null,this._hitbox&&this._hitbox.markAsReusable(!0),this._hitbox=null,this._visualModel&&this._visualModel.getNode()&&!this._visualModel.getNode().canBeReused()&&this._visualModel.getNode().markAsReusable(!0),this._visualModel=null,this._physicalModel=null,this._activeDamageIndicators&&(this._activeDamageIndicators=null),this._alive=!1,this._humSoundClip&&(this._humSoundClip.destroy(),this._humSoundClip=null),this._soundSource&&(this._soundSource=null)},_.executeWhenReady(function(){var t;for(R=_.getSetting(_.GENERAL_SETTINGS.UNIFORM_LUMINOSITY_FACTORS_ARRAY_NAME),A=_.getSetting(_.GENERAL_SETTINGS.UNIFORM_GROUP_TRANSFORMS_ARRAY_NAME),I=new Float32Array(16*c.getMaxGroupTransforms()),t=0;t<I.length;t++)I[t]=i.IDENTITY4[t%16];T=_.getSetting(_.BATTLE_SETTINGS.HITBOX_COLOR),E=_.getSetting(_.BATTLE_SETTINGS.WEAPON_FIRE_SOUND_STACK_MINIMUM_DISTANCE),C=_.getSetting(_.BATTLE_SETTINGS.SCORE_FRACTION_FOR_KILL)}),{Spacecraft:Spacecraft}}),define("armada/logic/ai",["utils/vectors","utils/matrices","modules/application","modules/physics","armada/configuration","armada/logic/SpacecraftEvents","armada/logic/classes","armada/logic/equipment","utils/polyfill"],function(t,e,i,r,n,o,s,a){"use strict";function SpacecraftAI(t,e){this._spacecraft=t,this._mission=e,this._standingDown=!1,this._targetList=null,this._priorityTargets=!1,this._hitCountByNonTarget=0,this._weaponRange=this._spacecraft&&this._spacecraft.getWeapons().length>0?this._spacecraft.getWeapons()[0].getRange():0,this._attackingTarget=!1,this._spacecraft&&(this._spacecraft.addEventHandler(o.BEING_HIT,this._handleBeingHit.bind(this)),this._spacecraft.addEventHandler(o.COMMAND_RECEIVED,this._handleCommand.bind(this)))}function FighterAI(t,e){SpacecraftAI.call(this,t,e),this._timeSinceLastRoll=0,this._timeSinceLastTargetHit=0,this._timeSinceLastClosingIn=0,this._evasiveManeuverTime=-1,this._evasiveVelocityVector=[0,0],this._rollTime=-1,this._chargePhase=_.NONE,this._chargeDestination=[0,0,0],this._maxDistanceFactor=T,this._isBlockedBy=null,this._facingTarget=!1,this._targetDistance=0,this._targetOffset=[0,0,0],this._targetOffsetUpdateTimeLeft=0,this._maxAimError=0,this._aimError=[0,0],this._fireDelayLeft=0,this._spacecraft.addEventHandler(o.TARGET_HIT,this._handleTargetHit.bind(this)),this._spacecraft.addEventHandler(o.ANY_SPACECRAFT_HIT,this._handleAnySpacecraftHit.bind(this)),this._spacecraft.addEventHandler(o.TARGET_FIRED,this._handleTargetFired.bind(this))}function ShipAI(t,e){SpacecraftAI.call(this,t,e)}function AIContext(){this._ais=[]}var l,h,u,c={JUMP:"jump",TARGET:"target",STAND_DOWN:"standDown"},p={IN:"in",OUT:"out"},d={WEDGE:"wedge"},_={NONE:-1,APPROACH_ATTACK:0,EVADE:1},g="fighter",m="ship",f=.001,S=1e3/r.ANGULAR_VELOCITY_MATRIX_DURATION,y=Math.radians(45),T=.3,E=.125,C=.05,M=5,x=.06,b=.5,O=3,R=5,A=3,I=15,v=4,N=1,L=.25,D=3,P=Math.radians(45),w=1,V=1,F=1,B=1e3,U=1500,j=Math.radians(2),G=.5,k=625,H=350,W=.9,q=0,z=0;return SpacecraftAI.prototype.turn=function(e,i,r){var n,o,s,a,l;n=this._spacecraft.getTurningMatrix(),s=this._spacecraft.getMaxAngularAcceleration(),l=z/(s*r),o=Math.sign(n[4])*t.angle2u([0,1],t.normal2([n[4],n[5]]))*S,a=Math.max(o*o/(2*s),f),e>a?this._spacecraft.yawLeft(Math.min(Math.max(0,l*(e-a)),1)):-a>e&&this._spacecraft.yawRight(Math.min(Math.max(0,l*(-e-a)),1)),o=Math.sign(n[6])*t.angle2u([1,0],t.normal2([n[5],n[6]]))*S,a=Math.max(o*o/(2*s),f),i>a?this._spacecraft.pitchUp(Math.min(Math.max(0,l*(i-a)),1)):-a>i&&this._spacecraft.pitchDown(Math.min(Math.max(0,l*(-i-a)),1))},SpacecraftAI.prototype.rollAndYaw=function(e,i,r){var n,o,s,a,l;n=this._spacecraft.getTurningMatrix(),s=this._spacecraft.getMaxAngularAcceleration(),l=z/(s*r),o=Math.sign(n[2])*t.angle2u([1,0],t.normal2([n[0],n[2]]))*S,a=Math.max(o*o/(2*s),f),e>a?this._spacecraft.rollLeft(Math.min(Math.max(0,l*(e-a)),1)):-a>e&&this._spacecraft.rollRight(Math.min(Math.max(0,l*(-e-a)),1)),o=Math.sign(n[4])*t.angle2u([0,1],t.normal2([n[4],n[5]]))*S,a=Math.max(o*o/(2*s),f),i>a?this._spacecraft.yawLeft(Math.min(Math.max(0,l*(i-a)),1)):-a>i&&this._spacecraft.yawRight(Math.min(Math.max(0,l*(-i-a)),1))},SpacecraftAI.prototype.rollAndPitch=function(e,i,r){var n,o,s,a,l;n=this._spacecraft.getTurningMatrix(),s=this._spacecraft.getMaxAngularAcceleration(),l=z/(s*r),o=Math.sign(n[2])*t.angle2u([1,0],t.normal2([n[0],n[2]]))*S,a=Math.max(o*o/(2*s),f),e>a?this._spacecraft.rollLeft(Math.min(Math.max(0,l*(e-a)),1)):-a>e&&this._spacecraft.rollRight(Math.min(Math.max(0,l*(-e-a)),1)),o=Math.sign(n[6])*t.angle2u([1,0],t.normal2([n[5],n[6]]))*S,a=Math.max(o*o/(2*s),f),i>a?this._spacecraft.pitchUp(Math.min(Math.max(0,l*(i-a)),1)):-a>i&&this._spacecraft.pitchDown(Math.min(Math.max(0,l*(-i-a)),1))},SpacecraftAI.prototype.approach=function(t,e,i,r){var n,o;n=this._spacecraft.getRelativeVelocityMatrix()[13],o=n*n/(2*this._spacecraft.getMaxAcceleration()),0>n&&(o=-o),t-o>e?this._spacecraft.setSpeedTarget(r):i>=0&&i>t-o?this._spacecraft.setSpeedTarget(-r):this._spacecraft.resetSpeed()},SpacecraftAI.prototype._handleTargetSwitch=function(){this._hitCountByNonTarget=0},SpacecraftAI._targetListFilterFunction=function(t){return t.isAlive()},SpacecraftAI.prototype._updateTarget=function(t){var e,i;if(this._standingDown)return void this._spacecraft.setTarget(null);if(i=this._spacecraft.getTarget(),this._targetList&&(this._targetList=this._targetList.filter(SpacecraftAI._targetListFilterFunction)),this._targetList&&this._targetList.length>0){if(this._priorityTargets){if(t)this._targetList.indexOf(t)>=0&&this._spacecraft.setTarget(t);else if(!i||this._targetList.indexOf(i)<0){for(e=0;e<this._targetList.length;e++)if(!this._targetList[e].isAway()){this._spacecraft.setTarget(this._targetList[e]);break}!i&&e>=this._targetList.length&&this._spacecraft.targetNextBestHostile()}}else if(t)this._spacecraft.setTarget(t);else if(!i){for(e=0;e<this._targetList.length;e++)if(!this._targetList[e].isAway()){this._spacecraft.setTarget(this._targetList[e]);break}e>=this._targetList.length&&this._spacecraft.targetNextBestHostile()}}else t?this._spacecraft.setTarget(t):i||this._spacecraft.targetNextBestHostile();this._spacecraft.getTarget()!==i&&this._handleTargetSwitch()},SpacecraftAI.prototype._handleBeingHit=function(t){var e=t.spacecraft;this._spacecraft&&!this._spacecraft.canBeReused()&&!e.canBeReused()&&!e.isAway()&&e.isHostile(this._spacecraft)&&this._spacecraft.getTarget()&&this._spacecraft.getTarget()!==e&&(this._spacecraft.getTarget().getTarget()===this._spacecraft&&this._attackingTarget||this._updateTarget(e),this._hitCountByNonTarget++)},SpacecraftAI.prototype._getPositionInFormation=function(t,e){var r=Math.ceil(e/2);switch(t.type){case d.WEDGE:return[(e%2===1?1:-1)*r*t.spacing[0],r*t.spacing[1],r*t.spacing[2]];default:return i.showError("Unknown formation type specified: '"+t.type+"!"),[0,0,0]}},SpacecraftAI.prototype._handleCommand=function(r){var n,o,s,a;switch(r.command){case c.JUMP:o=r.jump&&r.jump.way?r.jump.way:this._spacecraft.isAway()?p.IN:p.OUT,o===p.IN?this._spacecraft.isAway()&&(r.jump&&(r.lead&&r.index>0&&r.jump.formation?(this._spacecraft.setPhysicalPosition(t.sum3(r.lead.getPhysicalPositionVector(),t.prodVec3Mat4Aux(this._getPositionInFormation(r.jump.formation,r.index),r.lead.getPhysicalOrientationMatrix()))),this._spacecraft.setPhysicalOrientationMatrix(e.matrix4(r.lead.getPhysicalOrientationMatrix()))):r.jump.anchor&&(r.clearCache&&(r.jump.anchorSpacecraft=null,r.clearCache=!1),s=r.jump.anchorSpacecraft||this._mission.getSpacecraft(r.jump.anchor),s?(r.jump.anchorSpacecraft=s,r.jump.distance?(this._spacecraft.setPhysicalOrientationMatrix(e.prod3x3SubOf4(e.rotationX4Aux((l()-.5)*Math.PI),e.rotationZ4Aux(2*l()*Math.PI))),this._spacecraft.setPhysicalPosition(t.scaled3(e.getRowB4(this._spacecraft.getPhysicalOrientationMatrix()),-r.jump.distance))):(r.jump.position&&this._spacecraft.setPhysicalPosition(r.jump.position),r.jump.rotations&&this._spacecraft.setPhysicalOrientationMatrix(e.rotation4FromJSON(r.jump.rotations))),r.jump.relative&&(this._spacecraft.setPhysicalPositionMatrix(e.prodTranslationRotation4(this._spacecraft.getPhysicalPositionMatrix(),s.getPhysicalOrientationMatrix())),this._spacecraft.setPhysicalOrientationMatrix(e.prod4(this._spacecraft.getPhysicalOrientationMatrix(),s.getPhysicalOrientationMatrix()))),this._spacecraft.setPhysicalPosition(t.sum3(this._spacecraft.getPhysicalPositionVector(),s.getPhysicalPositionVector()))):i.showError("'"+this._spacecraft.getDisplayName()+"' has an invalid anchor for inward jump: '"+r.jump.anchor+"'!"))),this._spacecraft.jumpIn()):this._spacecraft.jumpOut();break;case c.TARGET:if(r.target){if(r.clearCache&&(r.target.targetSpacecrafts=null,r.clearCache=!1),r.target.targetSpacecrafts)this._targetList=r.target.targetSpacecrafts.slice();else{if(r.target.single)a=this._mission.getSpacecraft(r.target.single),a?this._targetList=[a]:i.log("Warning: '"+this._spacecraft.getDisplayName()+"' has an invalid target specified: '"+r.target.single+"'. Might be because the ship is already destroyed.");else if(r.target.list)for(this._targetList=[],n=0;n<r.target.list.length;n++)a=this._mission.getSpacecraft(r.target.list[n]),a?this._targetList.push(a):i.log("Warning: '"+this._spacecraft.getDisplayName()+"' has an invalid target specified: '"+r.target.list[n]+"'. Might be because the ship is already destroyed.");else if(r.target.squads)for(this._targetList=[],n=0;n<r.target.squads.length;n++)this._targetList=this._targetList.concat(this._mission.getSpacecraftsInSquad(r.target.squads[n]));else i.showError("'"+this._spacecraft.getDisplayName()+"' has no target specified for targeting command!");this._targetList&&(r.target.targetSpacecrafts=this._targetList.slice())}this._targetList&&this._targetList.length>0&&this._spacecraft.setTarget(this._targetList[0]),this._priorityTargets=r.target.priority===!0}break;case c.STAND_DOWN:this._standingDown=!0;break;default:i.showError("Unknown spacecraft command: '"+r.command+"'!")}},FighterAI.prototype=new SpacecraftAI,FighterAI.prototype.constructor=FighterAI,FighterAI.prototype._updateAimError=function(){this._aimError[0]=2*(Math.random()-.5)*this._maxAimError,this._aimError[1]=2*(Math.random()-.5)*this._maxAimError},FighterAI.prototype._startNewAttackRun=function(){this._chargePhase=_.NONE,this._spacecraft.changeFlightMode(a.FlightMode.COMBAT),this._hitCountByNonTarget=0,this._timeSinceLastTargetHit=0,this._timeSinceLastClosingIn=0,this._timeSinceLastRoll=0,this._maxDistanceFactor=T,this._isBlockedBy=null,this._rollTime=-1,this._targetOffset=[0,0,0],this._targetOffsetUpdateTimeLeft=U,this._maxAimError=j,this._fireDelayLeft=H,this._updateAimError()},FighterAI.prototype._handleTargetSwitch=function(){SpacecraftAI.prototype._handleTargetSwitch.call(this),this._startNewAttackRun()},FighterAI.prototype._handleBeingHit=function(e){!this._isBlockedBy&&this._evasiveManeuverTime<0&&(this._evasiveManeuverTime=0,this._evasiveVelocityVector[0]=-e.hitPosition[0],this._evasiveVelocityVector[1]=-e.hitPosition[2],t.normalize2(this._evasiveVelocityVector)),SpacecraftAI.prototype._handleBeingHit.call(this,e)},FighterAI.prototype._handleTargetHit=function(){this._timeSinceLastTargetHit=0},FighterAI.prototype._handleAnySpacecraftHit=function(t){var e=t.spacecraft;!this._spacecraft||this._spacecraft.canBeReused()||e===this._spacecraft||this._chargePhase===_.EVADE||e===this._spacecraft.getTarget()||this._isBlockedBy&&!this._isBlockedBy.isHostile(this._spacecraft)||(this._isBlockedBy=e,this._evasiveManeuverTime=-1,this._chargePhase=_.NONE,this._spacecraft.changeFlightMode(a.FlightMode.COMBAT))},FighterAI.prototype._handleTargetFired=function(){var e;!this._isBlockedBy&&this._evasiveManeuverTime<0&&this._facingTarget&&this._spacecraft&&this._spacecraft.getTarget()&&this._spacecraft.getTarget().getTarget()===this._spacecraft&&this._targetDistance>this._weaponRange*b&&(this._evasiveManeuverTime=0,e=2*Math.random()*Math.PI,this._evasiveVelocityVector[0]=1,this._evasiveVelocityVector[1]=0,t.rotate2(this._evasiveVelocityVector,e))},FighterAI.prototype.handleSceneMoved=function(e){t.add3(this._chargeDestination,e)},FighterAI.prototype.control=function(i){var r,n,o,s,l,h,u,c,p,d,g,m,S,T,b,W,z,X,Y,J,Q,K,Z,$,tt,et,it,rt,nt,ot;if(this._spacecraft){if(this._spacecraft.canBeReused())return void(this._spacecraft=null);if(this._spacecraft.isAway())return;rt=!1,this._updateTarget(),S=this._spacecraft.getMaxAcceleration(),d=this._spacecraft._visualModel.getScaledSize(),n=e.translationVector3(this._spacecraft.getPhysicalPositionMatrix()),ot=e.inverseOfRotation4Aux(this._spacecraft.getPhysicalOrientationMatrix()),W=this._spacecraft.getRelativeVelocityMatrix()[13],r=this._spacecraft.getTarget(),this._attackingTarget=!1,this._chargePhase===_.EVADE?(this._attackingTarget=!!r,s=t.diff3(this._chargeDestination,n),u=t.prodVec3Mat4Aux(s,ot),this._targetDistance=t.length3(u),t.normalize3(u),et=t.getYawAndPitch(u),this.turn(et.yaw,et.pitch,i),this._spacecraft.setSpeedTarget(S*A),(this._targetDistance<=w||u[1]<0||0>W)&&this._startNewAttackRun()):r?(o=e.translationVector3(r.getPhysicalPositionMatrix()),this._targetOffsetUpdateTimeLeft<=0?(this._targetOffsetUpdateTimeLeft=U,l=t.diff3(this._spacecraft.getTargetHitPosition(),o),t.length3Squared(t.diff3(this._targetOffset,l))<k?this._maxAimError*=G:this._maxAimError=j,this._targetOffset=l,this._updateAimError()):this._targetOffsetUpdateTimeLeft-=i,t.add3(o,this._targetOffset),s=t.diff3(o,n),u=t.prodVec3Mat4Aux(s,ot),this._targetDistance=t.length3(u),t.normalize3(u),et=t.getYawAndPitch(u),et.yaw+=this._aimError[0],et.pitch+=this._aimError[1],this._facingTarget=Math.abs(et.yaw)<y&&Math.abs(et.pitch)<y,this.turn(et.yaw,et.pitch,i),this._isBlockedBy&&(it=!1,!this._isBlockedBy.canBeReused()&&this._facingTarget&&this._isBlockedBy._physicalModel.checkHit(o,s,1e3,d/2)&&(c=t.prodVec3Mat4Aux(t.diff3Aux(e.translationVector3(this._isBlockedBy.getPhysicalPositionMatrix()),n),ot),z=S*N,c[0]<0?(this._spacecraft.strafeRight(z),it=!0):(this._spacecraft.strafeLeft(z),it=!0),c[2]>0?(this._spacecraft.lower(z),it=!0):(this._spacecraft.raise(z),it=!0)),it||(this._isBlockedBy=null,this._spacecraft.stopLeftStrafe(),this._spacecraft.stopRightStrafe(),this._spacecraft.stopLower(),this._spacecraft.stopRaise()),rt=!0),nt=this._spacecraft.getWeapons(),nt&&nt.length>0?(g=r._visualModel.getScaledSize(),m=Math.atan(L*g/this._targetDistance),$=nt[0].getProjectileVelocity()+W,p=this._targetDistance/$*1e3,Y=nt[0].getCooldown(),this._spacecraft.aimWeapons(f,m,i),this._facingTarget||(this._timeSinceLastClosingIn=0,this._timeSinceLastTargetHit=0,this._hitCountByNonTarget=0),t.length3(t.diff3Aux(this._spacecraft.getTargetHitPosition(),n))<=nt[0].getRange(W)?(this._attackingTarget=!0,Math.abs(et.yaw)<m&&Math.abs(et.pitch)<m&&(!this._isBlockedBy||this._isBlockedBy.isHostile(this._spacecraft))?this._fireDelayLeft>0?this._fireDelayLeft-=i:(this._spacecraft.fire(),this._isBlockedBy||(this._timeSinceLastRoll+=i,this._timeSinceLastTargetHit+=i,this._timeSinceLastClosingIn+=i,Q=p+D*Y,this._timeSinceLastRoll>Q&&this._timeSinceLastTargetHit>Q&&(this._rollTime=0),this._rollTime>=0&&(this._spacecraft.rollLeft(),this._timeSinceLastRoll=0,this._rollTime+=i,K=this._spacecraft.getMaxAngularAcceleration(),Z=K*q,J=P>Z*q?q+(P-Z*q)/Z:Math.sqrt(4*P/K)/2,this._rollTime>1e3*J&&(this._rollTime=-1)))):(this._timeSinceLastRoll=0,this._fireDelayLeft=H)):(this._timeSinceLastRoll=0,this._fireDelayLeft=H),this._chargePhase===_.NONE&&(this._hitCountByNonTarget>=v||this._timeSinceLastTargetHit>p+I*Y)&&(this._chargePhase=_.APPROACH_ATTACK,this._spacecraft.changeFlightMode(a.FlightMode.CRUISE)),this._chargePhase===_.NONE?(tt=p+M*Y,this._timeSinceLastClosingIn>tt&&this._timeSinceLastTargetHit>tt&&this._maxDistanceFactor>E&&(this._maxDistanceFactor=Math.max(this._maxDistanceFactor-C,E),this._timeSinceLastClosingIn=0),X=.5*(d+g),b=X+this._maxDistanceFactor*this._weaponRange,T=X+x*this._weaponRange,this._facingTarget?this.approach(this._targetDistance,b,T,S*O):this._spacecraft.resetSpeed()):this._chargePhase===_.APPROACH_ATTACK&&(b=Math.sqrt(2*(g+.5*d)/S)*S*R,this._facingTarget?(this._spacecraft.setSpeedTarget(S*R),this._targetDistance<=b&&(this._chargePhase=_.EVADE,this._spacecraft.changeFlightMode(a.FlightMode.COMBAT),h=t.normal3(s),this._chargeDestination=t.sum3(n,t.scaled3(t.diff3(t.sum3(o,t.scaled3(t.normal3(t.prodVec3Mat4Aux(t.perpendicular3(h),e.rotation4Aux(h,Math.random()*Math.PI*2))),b)),n),V)))):(this._chargePhase=_.NONE,this._spacecraft.changeFlightMode(a.FlightMode.COMBAT),this._spacecraft.resetSpeed()))):this._spacecraft.resetSpeed()):(this._facingTarget=!1,this._targetDistance=0,this._spacecraft.resetSpeed(),this._spacecraft.aimWeapons(f,0,i)),rt||(this._evasiveManeuverTime>=0?(0===this._evasiveManeuverTime&&(this._evasiveVelocityVector[0]*=S*F,this._evasiveVelocityVector[1]*=S*F,t.rotate2(this._evasiveVelocityVector,(Math.random()-.5)*Math.PI)),this._evasiveVelocityVector[0]>0?this._spacecraft.strafeRight(this._evasiveVelocityVector[0]):this._evasiveVelocityVector[0]<0?this._spacecraft.strafeLeft(-this._evasiveVelocityVector[0]):(this._spacecraft.stopLeftStrafe(),this._spacecraft.stopRightStrafe()),this._evasiveVelocityVector[1]>0?this._spacecraft.raise(this._evasiveVelocityVector[1]):this._evasiveVelocityVector[1]<0?this._spacecraft.lower(-this._evasiveVelocityVector[1]):(this._spacecraft.stopLower(),this._spacecraft.stopRaise()),this._evasiveManeuverTime+=i,this._evasiveManeuverTime>B&&(this._evasiveManeuverTime=-1)):(this._spacecraft.stopLeftStrafe(),this._spacecraft.stopRightStrafe(),this._spacecraft.stopLower(),this._spacecraft.stopRaise()))}},ShipAI.prototype=new SpacecraftAI,ShipAI.prototype.constructor=ShipAI,ShipAI.prototype.handleSceneMoved=function(){},ShipAI.prototype.control=function(i){var r,n,o,a,l,h,u,c,p,d,_,g,m,S,T,E,C,M,x,b;if(this._spacecraft){if(this._spacecraft.canBeReused())return void(this._spacecraft=null);if(this._spacecraft.isAway())return;if(this._updateTarget(),g=this._spacecraft.getMaxAcceleration(),p=this._spacecraft._visualModel.getScaledSize(),n=e.translationVector3(this._spacecraft.getPhysicalPositionMatrix()),b=e.inverseOfRotation4Aux(this._spacecraft.getPhysicalOrientationMatrix()),r=this._spacecraft.getTarget(),this._attackingTarget=!1,r){if(o=e.translationVector3(r.getPhysicalPositionMatrix()),a=t.diff3(o,n),l=t.prodVec3Mat4(a,b),c=t.length3(l),t.normalize3(l),E=t.getYawAndPitch(l),M=Math.abs(E.yaw)<y&&Math.abs(E.pitch)<y,x=this._spacecraft.getWeapons(),x&&x.length>0){if(d=r._visualModel.getScaledSize(),S=.25*p,m=S+W*this._weaponRange,_=Math.atan(L*d/c),this._spacecraft.aimWeapons(f,_,i),M?this.approach(c,m,0,g*O):this._spacecraft.resetSpeed(),c>m)this.turn(E.yaw,E.pitch,i);else switch(h=this._spacecraft.getClass().getAttackVectorAngles(),T=this._spacecraft.getClass().getAttackThresholdAngle(),this._spacecraft.getClass().getTurnStyle()){case s.SpacecraftTurnStyle.YAW_PITCH:(Math.abs(E.yaw-h[0])>T||Math.abs(E.pitch-h[1])>T)&&this.turn(E.yaw-h[0],E.pitch-h[1],i);break;case s.SpacecraftTurnStyle.ROLL_YAW:C=t.getRollAndYaw(l,!0),u=[C.roll-h[0],C.yaw-h[1]],(Math.abs(u[0])>T||Math.abs(u[1])>T)&&(Math.abs(u[1])>Math.PI/2?u[0]=0:Math.abs(u[0])>Math.PI/2&&(u[1]=0),this.rollAndYaw(u[0],u[1],i));break;case s.SpacecraftTurnStyle.ROLL_PITCH:C=t.getRollAndPitch(l,!0),u=[C.roll-h[0],C.pitch-h[1]],(Math.abs(u[0])>T||Math.abs(u[1])>T)&&(Math.abs(u[1])>Math.PI/2?u[0]=0:Math.abs(u[0]-Math.sign(u[0])*Math.PI)<Math.abs(u[0])&&(u[0]-=Math.sign(u[0])*Math.PI,C.pitch=-C.pitch),this.rollAndPitch(u[0],C.pitch-h[1],i))}t.length3(t.diff3(this._spacecraft.getTargetHitPosition(),n))-S<=x[0].getRange(this._spacecraft.getRelativeVelocityMatrix()[13])&&(this._spacecraft.fire(!0),this._attackingTarget=!0)}}else this._spacecraft.resetSpeed(),this._spacecraft.aimWeapons(f,0,i)}},AIContext.prototype.clearAIs=function(){this._ais=[]},AIContext.prototype.addAI=function(t,e,i){this._ais.push(new h[t](e,i))},AIContext.prototype.control=function(t){var e;for(e=0;e<this._ais.length;e++)this._ais[e].control(t)},AIContext.prototype.handleSceneMoved=function(t){var e;for(e=0;e<this._ais.length;e++)this._ais[e].handleSceneMoved(t)},h={},h[g]=FighterAI,h[m]=ShipAI,u=new AIContext(h),n.executeWhenReady(function(){q=n.getSetting(n.BATTLE_SETTINGS.TURN_ACCELERATION_DURATION_S),z=1e3/q,l=Math.seed(Math.random())}),{FIGHTER_AI_NAME:g,SHIP_AI_NAME:m,clearAIs:u.clearAIs.bind(u),addAI:u.addAI.bind(u),control:u.control.bind(u),handleSceneMoved:u.handleSceneMoved.bind(u)}}),define("armada/logic/missions",["utils/utils","utils/types","utils/matrices","modules/application","modules/game","modules/async-resource","modules/resource-manager","modules/media-resources","modules/pools","modules/scene/camera","modules/scene/renderable-objects","armada/constants","armada/graphics","armada/logic/classes","armada/configuration","armada/strings","armada/logic/environments","armada/logic/SpacecraftEvents","armada/logic/spacecraft","armada/logic/equipment","armada/logic/explosion","armada/logic/ai","utils/polyfill"],function(t,e,i,r,n,o,s,a,l,h,u,c,p,d,_,g,m,f,S,y,T,E){"use strict";function getDebugInfo(){return k}function Team(t){this._id=null,this._name=null,this._color=null,"string"==typeof t?(this._id=t,this._name=t):"object"==typeof t?(this._id=t.id||t.name||r.showError("Team defined without a name or id!"),this._name=t.name||t.id,this._color=t.color||null):r.showError("Invalid parameter specified for Team constructor!"),this._initialCount=0,this._squads=[]}function Octree(t,e,i,r){this._objects=t,this._center=null,this._boundaries=null,this._objects.length>0&&this._calculateCenter(r),this._subnodes=e>0&&this._objects.length>i?this._generateSubnodes(e-1,i):null}function SubjectGroup(t){this._descriptor=t||{},this._spacecrafts=null,this._shortString=null}function Condition(e){this._type=e?t.getSafeEnumValue(N,e.type,null):null,this._subjects=e?new SubjectGroup(e.subjects):null,e&&this._checkParams(e.params)}function DestroyedCondition(t){Condition.call(this,t)}function CountCondition(t){Condition.call(this,t)}function TimeCondition(t){Condition.call(this,t),this._running=!this._params.start,this._trigger=null,this._timeElapsed=this._params.startOffset||0,this._count=0}function Trigger(e){var i;if(this._conditions=null,e.conditions)for(this._conditions=[],i=0;i<e.conditions.length;i++)this._conditions.push(new(R[e.conditions[i].type]||Condition)(e.conditions[i]));this._conditionsRequired=t.getSafeEnumValue(I,e.conditionsRequired,I.ALL),this._fireWhen=t.getSafeEnumValue(v,e.fireWhen,v.CHANGE_TO_TRUE),this._oneShot=e.oneShot||!1,this._delay=e.delay||0,this._countDown=!1,this._onFireHandlers=[],this._previousConditionState=!1,this._fired=!1,this._conditions||(this._fireWhen!==v.MISSION_STARTS&&(r.showError("A trigger has no conditions, and so its fireWhen state must be '"+v.MISSION_STARTS+"'!"),this._fireWhen=v.MISSION_STARTS),this._oneShot||(r.showError("A trigger has no conditions, and so it must be set as oneShot!"),this._oneShot=!0)),!this._oneShot&&this._delay&&(r.showError("Only oneShot triggers can have delays!"),this._delay=0)}function Action(e,i){this._type=e?t.getSafeEnumValue(P,e.type,null):null,this._trigger=i,this._trigger&&this._trigger.addFireHandler(this._execute.bind(this)),this._subjects=e?new SubjectGroup(e.subjects):null,e&&this._checkParams(e.params)}function WinAction(t,e){Action.call(this,t,e)}function LoseAction(t,e){Action.call(this,t,e)}function MessageAction(t,e){Action.call(this,t,e)}function ClearMessagesAction(t,e){Action.call(this,t,e)}function CommandAction(t,e){Action.call(this,t,e)}function MissionEvent(t){var e;for(this._name=t.name,this._trigger=new Trigger(t.trigger),this._actions=[],e=0;e<t.actions.length;e++)this._actions.push(new(A[t.actions[e].type]||Action)(t.actions[e],this._trigger))}function Mission(t){this._name=t,this._environment=null,this._ownsEnvironment=!1,this._combatTheme=null,this._views=null,this._teams=null,this._events=null,this._winActions=null,this._loseActions=null,this._spacecrafts=null,this._pilotedCraft=null,this._hitObjects=null,this._randomShips=null,this._randomShipsMapSize=0,this._randomShipsHeadingAngle=0,this._randomShipsRandomHeading=!1,this._randomShipsEquipmentProfileName=null,this._state=w.NONE,this._referenceScore=0,this._escortedSpacecrafts=null}function MissionDescriptor(t,e){s.JSONResource.call(this,t,e,!0),this._test=this._dataJSON.test===!0,this._localData=JSON.parse(localStorage[this._getLocalStorageID()]||"{}"),this._initLocalData()}function DifficultyLevel(t){this._name=t.name,this._playerHitpointsFactor=t.playerHitpointsFactor}function MissionPerformanceLevel(t){this._name=t.name,this._referenceBaseScoreFactor=t.referenceBaseScoreFactor,this._referenceHitRatio=t.referenceHitRatio,this._referenceHullIntegrity=t.referenceHullIntegrity,
this._referenceTeamSurvival=t.referenceTeamSurvival}function MissionContext(){o.AsyncResource.call(this),this._difficulty=null,this._difficultyLevels=null,this._missionPerformanceLevels=null,this._tipIDs=null,this._missionManager=new s.ResourceManager}var C,M,x,b,O,R,A,I={ALL:"all",ANY:"any"},v={MISSION_STARTS:"missionStarts",TRUE:"true",FALSE:"false",CHANGE:"change",CHANGE_TO_TRUE:"changeToTrue",CHANGE_TO_FALSE:"changeToFalse"},N={DESTROYED:"destroyed",COUNT:"count",TIME_ELAPSED:"timeElapsed"},L={BELOW:"below",ABOVE:"above",EQUALS:"equals"},D={BEFORE:"before",AFTER:"after",ONCE:"once",REPEAT:"repeat"},P={WIN:"win",LOSE:"lose",MESSAGE:"message",CLEAR_MESSAGES:"clearMessages",COMMAND:"command"},w={NONE:0,BATTLE:1,IN_PROGRESS:2,COMPLETED:3,FAILED:4,DEFEAT:5,ENDED:6},V={IN_PROGRESS:0,COMPLETED:1,FAILED:2},F="failed",B=c.LOCAL_STORAGE_PREFIX+"missions_",U=B+"difficulty",j="missions",G="team",k="";return Object.freeze(I),Object.freeze(v),Object.freeze(N),Object.freeze(D),Object.freeze(P),Object.freeze(w),Team.prototype.getID=function(){return this._id},Team.prototype.getDisplayName=function(){return t.formatString(g.get(g.TEAM.PREFIX,this._name),{id:this._id})},Team.prototype.getColor=function(){return this._color},Team.prototype.getInitialCount=function(){return this._initialCount},Team.prototype.addSpacecraft=function(t){var e,i,n=t.getSquad();if(t.setTeam(this),n){for(e=0;e<this._squads.length;e++)if(n===this._squads[e].name){this._squads[e].crafts.push(t);break}e>=this._squads.length&&this._squads.push({name:n,crafts:[t]}),i=_.getHUDSetting(_.BATTLE_SETTINGS.HUD.WINGMEN_STATUS_CRAFT_POSITIONS).length,this._squads[e].crafts.length>i&&r.showError("Warning: squad '"+n+"' of team '"+this._name+"' has more than "+i+" members, and thus cannot be displayed correctly in the wingmen status panel!")}this._initialCount++},Team.prototype.getSquads=function(){return this._squads},Octree.prototype._calculateCenter=function(t){var e,i,r,n,o=0,s=0,a=0;for(t&&(r=this._objects[0]._physicalModel._positionMatrix,n=this._objects[0]._physicalModel.getSize(),this._boundaries=[[r[0]-n,r[0]+n],[r[1]-n,r[1]+n],[r[2]-n,r[2]+n]]),e=0,i=this._objects.length;i>e;e++)r=this._objects[e]._physicalModel._positionMatrix,o+=r[12],s+=r[13],a+=r[14],t&&(n=this._objects[e]._physicalModel.getSize(),r[12]-n<this._boundaries[0][0]&&(this._boundaries[0][0]=r[12]-n),r[12]+n>this._boundaries[0][1]&&(this._boundaries[0][1]=r[12]+n),r[13]-n<this._boundaries[1][0]&&(this._boundaries[1][0]=r[13]-n),r[13]+n>this._boundaries[1][1]&&(this._boundaries[1][1]=r[13]+n),r[14]-n<this._boundaries[2][0]&&(this._boundaries[2][0]=r[14]-n),r[14]+n>this._boundaries[2][1]&&(this._boundaries[2][1]=r[14]+n));o/=i,s/=i,a/=i,this._center=[o,s,a]},Octree.prototype._generateSubnodes=function(e,i){var r,n,o,s,a,l,h,u,c,p,d,_,g,m;for(r=0,n=this._objects.length;n>r;r++)s=this._objects[r],a=s._physicalModel._positionMatrix,o=s._physicalModel.getSize(),a[12]-o<this._center[0]&&(a[13]-o<this._center[1]&&(a[14]-o<this._center[2]&&(l=l||[],l.push(s)),a[14]+o>=this._center[2]&&(h=h||[],h.push(s))),a[13]+o>=this._center[1]&&(a[14]-o<this._center[2]&&(u=u||[],u.push(s)),a[14]+o>=this._center[2]&&(c=c||[],c.push(s)))),a[12]+o>=this._center[0]&&(a[13]-o<this._center[1]&&(a[14]-o<this._center[2]&&(p=p||[],p.push(s)),a[14]+o>=this._center[2]&&(d=d||[],d.push(s))),a[13]+o>=this._center[1]&&(a[14]-o<this._center[2]&&(_=_||[],_.push(s)),a[14]+o>=this._center[2]&&(g=g||[],g.push(s))));return m=new Array(8),m[0]=new Octree(l||t.EMPTY_ARRAY,e,i,!1),m[1]=new Octree(h||t.EMPTY_ARRAY,e,i,!1),m[2]=new Octree(u||t.EMPTY_ARRAY,e,i,!1),m[3]=new Octree(c||t.EMPTY_ARRAY,e,i,!1),m[4]=new Octree(p||t.EMPTY_ARRAY,e,i,!1),m[5]=new Octree(d||t.EMPTY_ARRAY,e,i,!1),m[6]=new Octree(_||t.EMPTY_ARRAY,e,i,!1),m[7]=new Octree(g||t.EMPTY_ARRAY,e,i,!1),m},Octree.prototype.getObjects=function(e,i,r,n,o,s){var a;return this._subnodes?this._boundaries&&(i<this._boundaries[0][0]||e>this._boundaries[0][1]||n<this._boundaries[1][0]||r>this._boundaries[1][1]||s<this._boundaries[2][0]||o>this._boundaries[2][1])?t.EMPTY_ARRAY:(a=[],e<this._center[0]&&(r<this._center[1]&&(o<this._center[2]&&(a=a.concat(this._subnodes[0].getObjects(e,i,r,n,o,s))),s>=this._center[2]&&(a=a.concat(this._subnodes[1].getObjects(e,i,r,n,o,s)))),n>=this._center[1]&&(o<this._center[2]&&(a=a.concat(this._subnodes[2].getObjects(e,i,r,n,o,s))),s>=this._center[2]&&(a=a.concat(this._subnodes[3].getObjects(e,i,r,n,o,s))))),i>=this._center[0]&&(r<this._center[1]&&(o<this._center[2]&&(a=a.concat(this._subnodes[4].getObjects(e,i,r,n,o,s))),s>=this._center[2]&&(a=a.concat(this._subnodes[5].getObjects(e,i,r,n,o,s)))),n>=this._center[1]&&(o<this._center[2]&&(a=a.concat(this._subnodes[6].getObjects(e,i,r,n,o,s))),s>=this._center[2]&&(a=a.concat(this._subnodes[7].getObjects(e,i,r,n,o,s))))),a):this._objects},SubjectGroup.prototype.has=function(t){return this._descriptor.spacecrafts&&this._descriptor.spacecrafts.indexOf(t.getID())>=0||this._descriptor.squads&&this._descriptor.squads.indexOf(t.getSquad())>=0||this._descriptor.teams&&this._descriptor.teams.indexOf(t.getTeam().getID())>=0},SubjectGroup.prototype._cacheSpacecrafts=function(t){var e,i;for(this._spacecrafts=[],i=t.getSpacecrafts(),e=0;e<i.length;e++)this.has(i[e])&&this._spacecrafts.push(i[e])},SubjectGroup.prototype.getSpacecrafts=function(t){return!this._spacecrafts&&t&&this._cacheSpacecrafts(t),this._spacecrafts},SubjectGroup._mapSpacecraftID=function(t){return g.getDefiniteArticleForWord(t)+" <strong>"+t+"</strong>"},SubjectGroup._getMappedSpacecraftIDs=function(t){return g.getList(t.map(SubjectGroup._mapSpacecraftID))},SubjectGroup._mapSquadID=function(t){return t=g.get(g.SQUAD.PREFIX,t),g.getDefiniteArticleForWord(t)+" <strong>"+t+"</strong>"},SubjectGroup._getMappedSquadIDs=function(t){return g.getList(t.map(SubjectGroup._mapSquadID))},SubjectGroup._mapTeamID=function(t){return t=g.get(g.TEAM.PREFIX,t),g.getDefiniteArticleForWord(t)+" <strong>"+t+"</strong>"},SubjectGroup._getMappedTeamIDs=function(t){return g.getList(t.map(SubjectGroup._mapTeamID))},SubjectGroup.prototype.toString=function(){var e="";return this._descriptor.spacecrafts&&(e+=SubjectGroup._getMappedSpacecraftIDs(this._descriptor.spacecrafts)),this._descriptor.squads&&(e.length>0&&(e+="; "),e+=t.formatString(g.get(this._descriptor.squads.length>1?g.MISSIONS.OBJECTIVE_SUBJECTS_SQUADS:g.MISSIONS.OBJECTIVE_SUBJECTS_SQUAD),{ids:SubjectGroup._getMappedSquadIDs(this._descriptor.squads)})),this._descriptor.teams&&(e.length>0&&(e+="; "),e+=t.formatString(g.get(this._descriptor.teams.length>1?g.MISSIONS.OBJECTIVE_SUBJECTS_TEAMS:g.MISSIONS.OBJECTIVE_SUBJECTS_TEAM),{ids:SubjectGroup._getMappedTeamIDs(this._descriptor.teams)})),e},SubjectGroup.prototype.getLiveSubjectCount=function(){var t,e=0;for(t=0;t<this._spacecrafts.length;t++)this._spacecrafts[t].isAlive()&&e++;return e},SubjectGroup.prototype.getShortString=function(){return this._shortString||(!this._descriptor.spacecrafts||this._descriptor.squads||this._descriptor.teams?this._descriptor.spacecrafts||!this._descriptor.squads||this._descriptor.teams?this._descriptor.spacecrafts||this._descriptor.squads||!this._descriptor.teams?this._shortString=t.formatString(g.get(g.BATTLE.OBJECTIVE_SUBJECTS_SPACECRAFTS),{count:this._spacecrafts.length}):this._descriptor.teams.length>1?this._shortString=t.formatString(g.get(g.BATTLE.OBJECTIVE_SUBJECTS_TEAMS),{count:this._descriptor.teams.length}):this._shortString=g.get(g.TEAM.PREFIX,this._descriptor.teams[0]):this._descriptor.squads.length>1?this._shortString=t.formatString(g.get(g.BATTLE.OBJECTIVE_SUBJECTS_SQUADS),{count:this._descriptor.squads.length}):this._shortString=g.get(g.SQUAD.PREFIX,this._descriptor.squads[0]):this._spacecrafts.length>1?this._shortString=t.formatString(g.get(g.BATTLE.OBJECTIVE_SUBJECTS_SPACECRAFTS),{count:this._spacecrafts.length}):this._shortString=this._spacecrafts[0].getDisplayName()),this._shortString},Condition.prototype._handleWrongParams=function(){r.showError("Wrong parameters specified for condition of type: '"+this._type+"'!")},Condition.prototype._checkParams=function(){return r.showError("Unrecognized condition type: '"+this._type+"'!"),!1},Condition.prototype.isSatisfied=function(){return r.showError("Unrecognized condition type: '"+this._type+"'!"),!1},Condition.prototype.getObjectiveString=function(){return r.showError("No mission objective string associated with condition type: '"+this._type+"'!"),null},Condition.prototype.getObjectiveStateString=function(){return r.showError("No mission objective string associated with condition type: '"+this._type+"'!"),null},Condition.prototype.getEscortedSpacecrafts=function(){return r.showError("No escorted spacecrafts associated with condition type: '"+this._type+"'!"),null},DestroyedCondition.prototype=new Condition,DestroyedCondition.prototype.constructor=DestroyedCondition,DestroyedCondition.prototype._checkParams=function(){return!0},DestroyedCondition.prototype.isSatisfied=function(t){var e,i=this._subjects.getSpacecrafts(t);for(e=0;e<i.length;e++)if(i[e].isAlive())return!1;return!0},DestroyedCondition.prototype.getObjectiveString=function(e){var i=t.formatString(g.get(e,g.OBJECTIVE.DESTROY_SUFFIX.name),{subjects:this._subjects.toString()});return i=i.charAt(0).toUpperCase()+i.slice(1)},DestroyedCondition.prototype.getObjectiveStateString=function(e){var i,r,n;return this._subjects.getSpacecrafts()?(r=this._subjects.getLiveSubjectCount(),n=r>1?" ("+r+")":"",i=t.formatString(g.get(e,g.OBJECTIVE.DESTROY_SUFFIX.name),{subjects:this._subjects.getShortString()})+n,i=i.charAt(0).toUpperCase()+i.slice(1)):""},DestroyedCondition.prototype.getEscortedSpacecrafts=function(t){return this._subjects.getSpacecrafts(t)},CountCondition.prototype=new Condition,CountCondition.prototype.constructor=CountCondition,CountCondition.prototype._checkParams=function(e){return this._params=e,this._params&&"number"==typeof this._params.count&&t.getSafeEnumValue(L,this._params.relation)?!0:(this._handleWrongParams(),!1)},CountCondition.prototype.isSatisfied=function(t){var e,i,r=this._subjects.getSpacecrafts(t);for(i=0,e=0;e<r.length;e++)r[e].isAlive()&&i++;switch(this._params.relation){case L.BELOW:return i<this._params.count;case L.ABOVE:return i>this._params.count;case L.EQUALS:return i===this._params.count}return!1},CountCondition.prototype.getObjectiveString=function(e){var i;return this._params.relation!==L.BELOW?(r.showError("Count conditions for mission objectives must have relation set to '"+L.BELOW+"'!"),null):(i=t.formatString(g.get(e,g.OBJECTIVE.COUNT_BELOW_SUFFIX.name),{subjects:this._subjects.toString(),count:this._params.count}),i=i.charAt(0).toUpperCase()+i.slice(1))},CountCondition.prototype.getObjectiveStateString=function(e){var i,n,o;return this._params.relation!==L.BELOW?(r.showError("Count conditions for mission objectives must have relation set to '"+L.BELOW+"'!"),null):this._subjects.getSpacecrafts()?(n=this._subjects.getLiveSubjectCount(),o=" ("+n+")",i=t.formatString(g.get(e,g.OBJECTIVE.COUNT_BELOW_SUFFIX.name),{subjects:this._subjects.getShortString(),count:this._params.count})+o,i=i.charAt(0).toUpperCase()+i.slice(1)):""},CountCondition.prototype.getEscortedSpacecrafts=function(t){return this._params.relation!==L.BELOW?(r.showError("Count conditions for mission objectives must have relation set to '"+L.BELOW+"'!"),null):this._subjects.getSpacecrafts(t)},TimeCondition.prototype=new Condition,TimeCondition.prototype.constructor=TimeCondition,TimeCondition.prototype._checkParams=function(e){return this._params=e,!this._params||"number"!=typeof this._params.time||!t.getSafeEnumValue(D,this._params.satisfiedWhen)||void 0!==this._params.start&&"string"!=typeof this._params.start||this._params.satisfiedWhen!==D.REPEAT&&void 0!==this._params.maxCount||this._params.satisfiedWhen===D.REPEAT&&void 0!==this._params.maxCount&&"number"!=typeof this._params.maxCount||void 0!==this._params.startOffset&&"number"!=typeof this._params.startOffset?(this._handleWrongParams(),!1):!0},TimeCondition.prototype.isSatisfied=function(t,e){var i=!1;if(this._params.start&&!this._trigger&&(this._trigger=t.getEvent(this._params.start)&&t.getEvent(this._params.start).getTrigger(),this._trigger||(this._params.start=null)),!this._running&&this._trigger&&this._trigger.hasFired()&&(this._running=!0),this._running)switch(this._timeElapsed+=e,this._params.satisfiedWhen){case D.BEFORE:if(this._timeElapsed<this._params.time)return!0;break;case D.AFTER:if(this._timeElapsed>this._params.time)return!0;break;case D.ONCE:if(this._timeElapsed>=this._params.time&&0===this._count)return this._running=!1,this._count=1,!0;break;case D.REPEAT:if(!this._params.maxCount||this._count<this._params.maxCount){for(;this._timeElapsed>=this._params.time;)this._timeElapsed-=this._params.time,i=!0;if(i)return this._count++,!0}else this._running=!1}return!1},Trigger.prototype.addFireHandler=function(t){this._onFireHandlers.push(t)},Trigger.prototype.fire=function(t){var e;if(this._delay>0)return void(this._countDown=!0);for(e=0;e<this._onFireHandlers.length;e++)this._onFireHandlers[e](t);this._fired=!0},Trigger.prototype.hasFired=function(){return this._fired},Trigger.prototype.simulate=function(t,e){var i,n;if(this._oneShot){if(this._fired)return;if(this._countDown)return this._delay-=e,void(this._delay<=0&&this.fire(t))}if(this._fireWhen===v.MISSION_STARTS)return void this.fire(t);switch(this._conditionsRequired){case I.ALL:for(i=!0,n=0;n<this._conditions.length;n++)if(!this._conditions[n].isSatisfied(t,e)){i=!1;break}break;case I.ANY:for(i=!1,n=0;n<this._conditions.length;n++)if(this._conditions[n].isSatisfied(t,e)){i=!0;break}break;default:r.showError("Unrecognized trigger condition requirement: '"+this._conditionsRequired+"'!")}switch(this._fireWhen){case v.TRUE:i&&this.fire(t);break;case v.FALSE:i||this.fire(t);break;case v.CHANGE:i!==this._previousConditionState&&this.fire(t);break;case v.CHANGE_TO_TRUE:i&&!this._previousConditionState&&this.fire(t);break;case v.CHANGE_TO_FALSE:!i&&this._previousConditionState&&this.fire(t);break;default:r.showError("Unrecognized trigger firing requirement: '"+this._fireWhen+"'!")}this._previousConditionState=i},Trigger.prototype.getObjectiveStrings=function(t){var e,i=[];if(this._conditionsRequired!==I.ALL)return r.showError("Triggers for mission objectives must be set to conditionsRequired state of '"+I.ALL+"'!"),null;if(this._fireWhen!==v.CHANGE_TO_TRUE)return r.showError("Triggers for mission objectives must be set to fireWhen state of '"+v.CHANGE_TO_TRUE+"'!"),null;for(e=0;e<this._conditions.length;e++)i.push(this._conditions[e].getObjectiveString(t));return i},Trigger.prototype.getObjectivesState=function(t,e){var i,n=[];if(this._conditionsRequired!==I.ALL)return r.showError("Triggers for mission objectives must be set to conditionsRequired state of '"+I.ALL+"'!"),null;if(this._fireWhen!==v.CHANGE_TO_TRUE)return r.showError("Triggers for mission objectives must be set to fireWhen state of '"+v.CHANGE_TO_TRUE+"'!"),null;for(i=0;i<this._conditions.length;i++)n.push({text:this._conditions[i].getObjectiveStateString(t?g.BATTLE.OBJECTIVE_WIN_PREFIX:g.BATTLE.OBJECTIVE_LOSE_PREFIX),state:this._conditions[i].isSatisfied(e)?t?V.COMPLETED:V.FAILED:e.getState()===w.COMPLETED?V.COMPLETED:V.IN_PROGRESS});return n},Trigger.prototype.getEscortedSpacecrafts=function(t){var e,i=[];for(e=0;e<this._conditions.length;e++)i=i.concat(this._conditions[e].getEscortedSpacecrafts(t));return i},Action.prototype.getType=function(){return this._type},Action.prototype._handleWrongParams=function(){r.showError("Wrong parameters specified for action of type: '"+this._type+"'!")},Action.prototype._checkParams=function(){return r.showError("Unrecognized action type: '"+this._type+"'!"),!1},Action.prototype._execute=function(){r.showError("Unrecognized action type: '"+this._type+"'!")},Action.prototype.getObjectiveStrings=function(){return r.showError("Action of type '"+this._type+"' does no correspond to a mission objective!"),null},Action.prototype.getObjectivesState=function(){return r.showError("Action of type '"+this._type+"' does no correspond to a mission objective!"),null},WinAction.prototype=new Action,WinAction.prototype.constructor=WinAction,WinAction.prototype._checkParams=function(){return!0},WinAction.prototype._execute=function(t){t.completeMission()},WinAction.prototype.getObjectiveStrings=function(){return this._trigger.getObjectiveStrings(g.MISSIONS.OBJECTIVE_WIN_PREFIX)},WinAction.prototype.getObjectivesState=function(t){return this._trigger.getObjectivesState(!0,t)},LoseAction.prototype=new Action,LoseAction.prototype.constructor=LoseAction,LoseAction.prototype._checkParams=function(){return!0},LoseAction.prototype._execute=function(t){t.failMission()},LoseAction.prototype.getObjectiveStrings=function(){return this._trigger.getObjectiveStrings(g.MISSIONS.OBJECTIVE_LOSE_PREFIX)},LoseAction.prototype.getObjectivesState=function(t){return this._trigger.getObjectivesState(!1,t)},MessageAction.prototype=new Action,MessageAction.prototype.constructor=MessageAction,MessageAction.prototype._checkParams=function(t){return this._params=t,!this._params||!this._params.text&&!this._params.textID||void 0!==this._params.text&&"string"!=typeof this._params.text&&"object"!=typeof this._params.text||void 0!==this._params.textID&&"string"!=typeof this._params.textID||void 0!==this._params.duration&&"number"!=typeof this._params.duration||void 0!==this._params.permanent&&"boolean"!=typeof this._params.permanent||void 0!==this._params.urgent&&"boolean"!=typeof this._params.urgent||void 0!==this._params.color&&("object"!=typeof this._params.color||!(this._params.color instanceof Array))?(this._handleWrongParams(),!1):!0},MessageAction.prototype._execute=function(e){n.getScreen().queueHUDMessage({text:g.get(g.MISSION.PREFIX,t.getFilenameWithoutExtension(e.getName())+g.MISSION.MESSAGES_SUFFIX.name+this._params.textID,"object"==typeof this._params.text?this._params.text[g.getLanguage()]:this._params.text),duration:this._params.duration,permanent:this._params.permanent,color:this._params.color},this._params.urgent)},ClearMessagesAction.prototype=new Action,ClearMessagesAction.prototype.constructor=ClearMessagesAction,ClearMessagesAction.prototype._checkParams=function(){return!0},ClearMessagesAction.prototype._execute=function(){n.getScreen().clearHUDMessages()},CommandAction.prototype=new Action,CommandAction.prototype.constructor=CommandAction,CommandAction.prototype._checkParams=function(t){return this._params=t,!this._params||void 0!==this._params.command&&"string"!=typeof this._params.command?(this._handleWrongParams(),!1):!0},CommandAction.prototype._execute=function(t){var e,i=this._subjects.getSpacecrafts(t);if(i.length>0)for(this._params.lead=i[0],this._params.clearCache=!0,e=0;e<i.length;e++)this._params.index=e,i[e].handleEvent(f.COMMAND_RECEIVED,this._params)},MissionEvent.prototype.getName=function(){return this._name},MissionEvent.prototype.getTrigger=function(){return this._trigger},MissionEvent.prototype.getActions=function(){return this._actions},MissionEvent.prototype.simulate=function(t,e){this._trigger.simulate(t,e)},Mission.prototype.getName=function(){return this._name},Mission.prototype.getCombatTheme=function(){return this._combatTheme},Mission.prototype.getPilotedSpacecraft=function(){return this._pilotedCraft},Mission.prototype.getSpacecraft=function(t){var e;for(e=0;e<this._spacecrafts.length;e++)if(this._spacecrafts[e].getID()===t)return this._spacecrafts[e];return null},Mission.prototype.getSpacecrafts=function(){return this._spacecrafts},Mission.prototype.getSpacecraftsInSquad=function(t){var e,i=[];for(e=0;e<this._spacecrafts.length;e++)this._spacecrafts[e].getSquad()===t&&i.push(this._spacecrafts[e]);return i},Mission.prototype.applyToSpacecrafts=function(t){var e;for(e=0;e<this._spacecrafts.length;e++)t(this._spacecrafts[e])},Mission.prototype.getState=function(){return this._state},Mission.prototype.isFinished=function(){return this._state===w.COMPLETED||this._state===w.FAILED||this._state===w.DEFEAT||this._state===w.ENDED},Mission.prototype.getEscortedSpacecrafts=function(){return this._escortedSpacecrafts},Mission.prototype.completeMission=function(){this._state===w.IN_PROGRESS&&(this._state=w.COMPLETED)},Mission.prototype.failMission=function(){(this._state===w.IN_PROGRESS||this._state===w.COMPLETED)&&(this._state=w.FAILED)},Mission.prototype._updateState=function(){var t;if(this._pilotedCraft){if(this._pilotedCraft.canBeReused())return void(this._state=w.DEFEAT);if(this._state===w.BATTLE||this._state===w.IN_PROGRESS&&0===this._winActions.length){for(t=0;t<this._spacecrafts.length;t++)if(this._spacecrafts[t]&&!this._spacecrafts[t].canBeReused()&&this._pilotedCraft.isHostile(this._spacecrafts[t]))return;return void(this._state=w.COMPLETED)}}else if(this._state===w.BATTLE&&this.noHostilesPresent())return void(this._state=w.ENDED)},Mission.prototype.noHostilesPresent=function(){var t,e,i=null;for(t=0;t<this._spacecrafts.length;t++)if(this._spacecrafts[t]&&!this._spacecrafts[t].canBeReused()){if(e=this._spacecrafts[t].getTeam(),e&&i&&e!==i)return!1;i=e}return!0},Mission.prototype.getSpacecraftCountForTeam=function(t){var e,i=0;for(e=0;e<this._spacecrafts.length;e++)this._spacecrafts[e]&&!this._spacecrafts[e].canBeReused()&&this._spacecrafts[e].getTeam()===t&&i++;return i},Mission.prototype.getTotalHostileSpacecraftValue=function(t){var e,i=0;for(e=0;e<this._spacecrafts.length;e++)this._spacecrafts[e]&&!this._spacecrafts[e].canBeReused()&&this._spacecrafts[e].isHostile(t)&&(i+=this._spacecrafts[e].getScoreValue());return i},Mission.prototype.getHostileSpacecraftCount=function(t,e){var i,r=0;for(i=0;i<this._spacecrafts.length;i++)!this._spacecrafts[i]||this._spacecrafts[i].canBeReused()||e&&this._spacecrafts[i].isAway()||this._spacecrafts[i].isHostile(t)&&r++;return r},Mission.prototype._spacecraftHasVisualModel=function(t,e){return e._visualModel===t},Mission.prototype.getFollowedSpacecraftForScene=function(t){return t._camera.getFollowedNode()?this._spacecrafts.find(this._spacecraftHasVisualModel.bind(this,t._camera.getFollowedNode()._renderableObject)):null},Mission.prototype.getEnvironment=function(){return this._environment},Mission.prototype.getTeam=function(t){var e;for(e=0;e<this._teams.length;e++)if(this._teams[e].getID()===t)return this._teams[e];return r.showError("No team exists with ID '"+t+"'!"),null},Mission.prototype.getEvent=function(t){var e;for(e=0;e<this._events.length;e++)if(this._events[e].getName()===t)return this._events[e];return r.showError("No mission event exists with name '"+t+"'!"),null},Mission.prototype.getObjectives=function(){var t,e=[];if(0===this._winActions.length)e.push(g.get(g.MISSIONS.OBJECTIVE_WIN_PREFIX,g.OBJECTIVE.DESTROY_ALL_SUFFIX.name));else for(t=0;t<this._winActions.length;t++)e=e.concat(this._winActions[t].getObjectiveStrings());for(t=0;t<this._loseActions.length;t++)e=e.concat(this._loseActions[t].getObjectiveStrings());return e},Mission.prototype.getObjectivesState=function(){var t,e,i,r,n=[];if(0===this._winActions.length)r=this.getPilotedSpacecraft(),e="",r&&(i=this.getHostileSpacecraftCount(r,!0),i>0&&(e=" ("+i+")")),n.push({text:g.get(g.BATTLE.OBJECTIVE_WIN_PREFIX,g.OBJECTIVE.DESTROY_ALL_SUFFIX.name)+e,state:r&&r.isAlive()?this.getHostileSpacecraftCount(r,!1)>0?V.IN_PROGRESS:V.COMPLETED:V.FAILED});else for(t=0;t<this._winActions.length;t++)n=n.concat(this._winActions[t].getObjectivesState(this));for(t=0;t<this._loseActions.length;t++)n=n.concat(this._loseActions[t].getObjectivesState(this));return n},Mission.prototype.loadEnvironment=function(t){"string"==typeof t.environment?(this._environment=m.getEnvironment(t.environment),this._environment||r.showError("Cannot load environment '"+t.environment+"' for mission: no such environment exists!"),this._ownsEnvironment=!1):"object"==typeof t.environment?(this._environment=new m.Environment(t.environment),this._ownsEnvironment=!0):r.showError("Invalid environment specified for mission!")},Mission.prototype.loadObjectives=function(t){var e,i,r,n;if(this._events=[],t.events)for(e=0;e<t.events.length;e++)this._events.push(new MissionEvent(t.events[e],this));for(this._state=w.NONE,this._winActions=[],this._loseActions=[],e=0;e<this._events.length;e++)for(r=this._events[e].getActions(),i=0;i<r.length;i++)n=r[i].getType(),n===P.WIN?this._winActions.push(r[i]):n===P.LOSE&&this._loseActions.push(r[i]);(this._winActions.length>0||this._loseActions.length>0)&&(this._state=w.IN_PROGRESS)},Mission.prototype.getReferenceScore=function(){return this._referenceScore},Mission.prototype.loadFromJSON=function(t,e,i){var n,o,s,a,l,h,u,c;if(r.log("Loading mission from JSON file...",2),this.loadEnvironment(t),this._combatTheme=t.combatTheme,this._teams=[],t.teams)for(n=0;n<t.teams.length;n++)this._teams.push(new Team(t.teams[n]));if(this.loadObjectives(t),this._views=[],t.views)for(n=0;n<t.views.length;n++)this._views.push(new d.SceneView(t.views[n]));for(this._spacecrafts=[],this._hitObjects=[],E.clearAIs(),n=0;n<t.spacecrafts.length;n++)s=new S.Spacecraft,s.loadFromJSON(t.spacecrafts[n],this._hitObjects),!i&&t.spacecrafts[n].piloted&&(this._pilotedCraft=s,s.multiplyMaxHitpoints(O.getDifficultyLevel(e).getPlayerHitpointsFactor())),h=t.spacecrafts[n].ai,!h&&i&&(h=s.isFighter()?_.getSetting(_.BATTLE_SETTINGS.DEMO_FIGHTER_AI_TYPE):_.getSetting(_.BATTLE_SETTINGS.DEMO_SHIP_AI_TYPE)),h&&E.addAI(h,s,this),a=t.spacecrafts[n].team,a?(l=this.getTeam(a),l?l.addSpacecraft(s):r.showError("Invalid team ID '"+a+"' specified for "+s.getClassName()+"!")):i&&(l=new Team({name:G,id:(this._teams.length+1).toString()}),this._teams.push(l),s.setTeam(l)),this._spacecrafts.push(s);for(this._referenceScore=0,l=this._pilotedCraft&&this._pilotedCraft.getTeam(),c=0,n=0;n<t.spacecrafts.length;n++)t.spacecrafts[n].initialTarget&&this._spacecrafts[n].setTarget(this.getSpacecraft(t.spacecrafts[n].initialTarget)),this._pilotedCraft&&!t.spacecrafts[n].excludeFromReferenceScore&&(this._pilotedCraft.isHostile(this._spacecrafts[n])?this._referenceScore+=this._spacecrafts[n].getScoreValue():this._spacecrafts[n].getTeam()===l&&c++);for(c>0&&(this._referenceScore/=c),this._randomShips=t.randomShips||{},this._randomShipsMapSize=t.randomShipsMapSize,this._randomShipsHeadingAngle=t.randomShipsHeadingAngle||0,this._randomShipsRandomHeading=t.randomShipsRandomHeading||!1,this._randomShipsEquipmentProfileName=t.randomShipsEquipmentProfileName||_.BATTLE_SETTINGS.DEFAULT_EQUIPMENT_PROFILE_NAME,this._escortedSpacecrafts=[],n=0;n<this._events.length;n++)for(u=this._events[n].getActions(),o=0;o<u.length;o++)u[o].getType()===P.LOSE&&(this._escortedSpacecrafts=this._escortedSpacecrafts.concat(this._events[n].getTrigger().getEscortedSpacecrafts(this)));this._pilotedCraft||(this._state=w.NONE),this._state!==w.NONE||this.noHostilesPresent()||(this._state=w.BATTLE),r.log("Mission successfully loaded.",2)},Mission.prototype.addRandomShips=function(t,e){var r,n,o,s,a,l,h=i.rotationZ4(Math.radians(this._randomShipsHeadingAngle));t=t||_.getSetting(_.GENERAL_SETTINGS.DEFAULT_RANDOM_SEED),r=Math.seed(t);for(n in this._randomShips)if(this._randomShips.hasOwnProperty(n))for(a=0;a<this._randomShips[n];a++)l=h?i.matrix4(h):i.identity4(),this._randomShipsRandomHeading&&i.mul4(l,i.rotation4Aux(i.getRowC4(l),r()*Math.PI*2)),o=new S.Spacecraft(d.getSpacecraftClass(n),"",i.translation4(r()*this._randomShipsMapSize-this._randomShipsMapSize/2,r()*this._randomShipsMapSize-this._randomShipsMapSize/2,r()*this._randomShipsMapSize-this._randomShipsMapSize/2),l,this._randomShipsEquipmentProfileName,this._hitObjects),e&&(o.isFighter()?E.addAI(_.getSetting(_.BATTLE_SETTINGS.DEMO_FIGHTER_AI_TYPE),o,this):E.addAI(_.getSetting(_.BATTLE_SETTINGS.DEMO_SHIP_AI_TYPE),o,this),s=new Team({name:G,id:(this._teams.length+1).toString()}),this._teams.push(s),o.setTeam(s)),this._spacecrafts.push(o)},Mission.prototype.isTeamMission=function(){return this.getPilotedSpacecraft()&&this.getPilotedSpacecraft().getTeam()&&this.getPilotedSpacecraft().getTeam().getInitialCount()>1},Mission.prototype.getScoreStatistics=function(t,e,i,r){var n,o,s,a,l=this.isTeamMission();return t=Math.round(t),n=Math.round((t||0)*e),o=Math.round(i*(l?_.getSetting(_.BATTLE_SETTINGS.SCORE_BONUS_FOR_HULL_INTEGRITY_TEAM):_.getSetting(_.BATTLE_SETTINGS.SCORE_BONUS_FOR_HULL_INTEGRITY))),l&&(s=Math.round(r*_.getSetting(_.BATTLE_SETTINGS.SCORE_BONUS_FOR_TEAM_SURVIVAL))),a=t+n+o+(l?s:0),{baseScore:t,hitRatioBonus:n,hullIntegrityBonus:o,teamSurvivalBonus:s,score:a}},Mission.prototype.getPerformanceStatistics=function(){var t=this.getPilotedSpacecraft(),e=this.isTeamMission(),i=e?(this.getSpacecraftCountForTeam(t.getTeam())-(t.isAlive()?1:0))/(t.getTeam().getInitialCount()-1):0,r=this.getScoreStatistics(t.getScore(),t.getHitRatio(),t.getHullIntegrity(),i),n=O.getPerformanceInfo(this,r.score);return{baseScore:r.baseScore,hitRatioBonus:r.hitRatioBonus,hullIntegrityBonus:r.hullIntegrityBonus,teamSurvival:e?i:void 0,teamSurvivalBonus:r.teamSurvivalBonus,score:r.score,performance:n.performance,nextPerformance:n.nextPerformance,nextPerformanceScore:n.nextPerformanceScore}},Mission.prototype.createCameraConfigurationForSceneView=function(t,e){var r,n,o=i.getYawAndPitch(t._orientationMatrix);return r=new h.CameraPositionConfiguration(!t.isMovable(),t.turnsAroundObjects(),t.movesRelativeToObject(),t.getPositionFollowedObjectsForScene(e),t.startsWithRelativePosition(),i.matrix4(t._positionMatrix),t.getDistanceRange(),t.getConfines(),t.resetsWhenLeavingConfines()),n=new h.CameraOrientationConfiguration(!t.isTurnable(),t.pointsTowardsObjects(),t.isFPS(),t.getOrientationFollowedObjectsForScene(e),i.matrix4(t._orientationMatrix),Math.degrees(o.yaw),Math.degrees(o.pitch),t.getAlphaRange(),t.getBetaRange(),t.getBaseOrientation()||_.getDefaultCameraBaseOrientation(),t.getPointToFallback()||_.getDefaultCameraPointToFallback()),new h.CameraConfiguration(t.getName(),r,n,t.getFOV()||_.getDefaultCameraFOV(),t.getFOVRange()||_.getDefaultCameraFOVRange(),t.getSpan()||_.getDefaultCameraSpan(),t.getSpanRange()||_.getDefaultCameraSpanRange(),t.resetsOnFocusChange())},Mission.prototype._handleSpacecraftJumpIn=function(t){this._hitObjects.indexOf(t)<=0&&this._hitObjects.push(t)},Mission.prototype.getMaxProjectileCount=function(){var t,e=0;for(t=0;t<this._spacecrafts.length;t++)e+=this._spacecrafts[t].getMaxProjectileCount();return e},Mission.prototype.getMaxExplosionCount=function(){var t,e=0;for(t=0;t<this._spacecrafts.length;t++)e+=this._spacecrafts[t].getMaxExplosionCount();return e},Mission.prototype.getMaxParticleCount=function(){var t,e=0;for(t=0;t<this._spacecrafts.length;t++)e+=this._spacecrafts[t].getMaxParticleCount();return e},Mission.prototype.addToScene=function(t,e){var i;for(this._environment&&this._environment.addToScene(t),i=0;i<this._spacecrafts.length;i++)this._spacecrafts[i].addToScene(t,void 0,!1,{hitboxes:r.isDebugVersion(),weapons:!0,thrusterParticles:!0,projectileResources:!0,explosion:!0,cameraConfigurations:!0,lightSources:!0,blinkers:!0,jumpEngine:!0},{randomAnimationTime:!0}),e&&this._spacecrafts[i].addToScene(e,p.getMaxLoadedLOD(),!0,{weapons:!0},{shaderName:_.getHUDSetting(_.BATTLE_SETTINGS.HUD.TARGET_VIEW_TARGET_ITEM_SHADER)}),this._spacecrafts[i].isAway()?this._spacecrafts[i].addEventHandler(f.JUMPED_IN,this._handleSpacecraftJumpIn.bind(this,this._spacecrafts[i])):this._hitObjects.push(this._spacecrafts[i]);a.executeWhenReady(function(){for(i=0;i<this._views.length;i++)t.addCameraConfiguration(this.createCameraConfigurationForSceneView(this._views[i],t)),0===i&&(t._camera.followNode(null,!0,0),t._camera.update(0));M.prefill(Math.ceil(this.getMaxParticleCount()*_.getSetting(_.BATTLE_SETTINGS.PARTICLE_POOL_PREFILL_FACTOR))),x.prefill(Math.ceil(this.getMaxProjectileCount()*_.getSetting(_.BATTLE_SETTINGS.PROJECTILE_POOL_PREFILL_FACTOR)),function(t){t.createVisualModel();
}),b.prefill(Math.ceil(this.getMaxExplosionCount()*_.getSetting(_.BATTLE_SETTINGS.EXPLOSION_POOL_PREFILL_FACTOR)),function(t){t.createVisualModel()})}.bind(this))},Mission.prototype.toggleHitboxVisibility=function(){var t;for(t=0;t<this._spacecrafts.length;t++)this._spacecrafts[t].toggleHitboxVisibility()},Mission._handleProjectile=function(t,e,i,r){i.simulate(t,e),i.canBeReused()&&x.markAsFree(r)},Mission._handleExplosion=function(t,e){t.canBeReused()&&b.markAsFree(e)},Mission._handleParticle=function(t,e){t.canBeReused()&&M.markAsFree(e)},Mission.prototype.tick=function(t,e){var i,n,o,s;for(this._environment&&this._environment.simulate(),i=0;i<this._events.length;i++)this._events[i].simulate(this,t);for(i=0;i<this._spacecrafts.length;i++)this._spacecrafts[i].simulate(t),this._spacecrafts[i].canBeReused()||this._spacecrafts[i].isAway()?(s=this._hitObjects.indexOf(this._spacecrafts[i]),s>=0&&(this._hitObjects[s]=null,this._hitObjects.splice(s,1)),this._spacecrafts[i].canBeReused()&&(this._spacecrafts[i].destroy(!0),this._spacecrafts[i]=null,this._spacecrafts.splice(i,1),i--)):C&&this._spacecrafts[i].hideHitbox();x.hasLockedObjects()&&(o=new Octree(this._hitObjects,2,1,!0),x.executeForLockedObjects(Mission._handleProjectile.bind(this,t,o))),b.hasLockedObjects()&&b.executeForLockedObjects(Mission._handleExplosion),M.hasLockedObjects()&&M.executeForLockedObjects(Mission._handleParticle),e&&(n=e.moveCameraToOrigoIfNeeded(_.getSetting(_.BATTLE_SETTINGS.MOVE_TO_ORIGO_DISTANCE)),n&&E.handleSceneMoved(n)),this._updateState(),r.isDebugVersion()&&(k="Part: "+M.getLockedObjectCount()+" / "+M._objects.length+"<br/>Proj: "+x.getLockedObjectCount()+" / "+x._objects.length+"<br/>Expl: "+b.getLockedObjectCount()+" / "+b._objects.length)},Mission.prototype.destroy=function(){var t;if(this._environment&&(this._ownsEnvironment?this._environment.destroy():this._environment.removeFromScene()),this._environment=null,this._views){for(t=0;t<this._views.length;t++)this._views[t]&&(this._views[t].destroy(),this._views[t]=null);this._views=null}if(this._spacecrafts){for(t=0;t<this._spacecrafts.length;t++)this._spacecrafts[t]&&(this._spacecrafts[t].destroy(),this._spacecrafts[t]=null);this._spacecrafts=null}this._pilotedCraft=null,this._hitObjects=null,M.clear(),x.clear(),b.clear()},MissionDescriptor.prototype=new s.JSONResource,MissionDescriptor.prototype.constructor=MissionDescriptor,MissionDescriptor.prototype._initLocalData=function(){var t,e,i=O.getDifficultyNames();for(t=0;t<i.length;t++)this._localData[i[t]]=this._localData[i[t]]||{},e=this._localData[i[t]],e.winCount=e.winCount||0,e.loseCount=e.loseCount||0},MissionDescriptor.prototype._getLocalStorageID=function(){return B+this.getName()},MissionDescriptor.prototype._saveLocalData=function(){localStorage[this._getLocalStorageID()]=JSON.stringify(this._localData)},MissionDescriptor.prototype.isTest=function(){return this._test},MissionDescriptor.prototype.getDescription=function(){return this._dataJSON.description||""},MissionDescriptor.prototype.getDisplayDescription=function(){return g.get(g.MISSION.PREFIX,t.getFilenameWithoutExtension(this.getName())+g.MISSION.DESCRIPTION_SUFFIX.name,this.getDescription()?t.formatString(g.get(g.MISSIONS.NO_TRANSLATED_DESCRIPTION),{originalDescription:this.getDescription()}):g.get(g.MISSIONS.NO_DESCRIPTION))},MissionDescriptor.prototype.getPilotedSpacecraftDescriptor=function(){var t;for(t=0;t<this._dataJSON.spacecrafts.length;t++)if(this._dataJSON.spacecrafts[t].piloted)return this._dataJSON.spacecrafts[t];return null},MissionDescriptor.prototype.getEnvironment=function(){var t=null;return this.isReadyToUse()?(t=new Mission(this.getName()),t.loadEnvironment(this._dataJSON),t.getEnvironment()):(r.showError("Cannot get mission environment from mission descriptor that has not yet been initialized!"),null)},MissionDescriptor.prototype.getMissionObjectives=function(){var t=null;return this.isReadyToUse()?(t=new Mission(this.getName()),t.loadObjectives(this._dataJSON),t.getObjectives()):(r.showError("Cannot get mission objectives from mission descriptor that has not yet been initialized!"),null)},MissionDescriptor.prototype.getTipIDs=function(){return this._dataJSON.tips},MissionDescriptor.prototype.createMission=function(t,e){var i=null;return this.isReadyToUse()?(i=new Mission(this.getName()),i.loadFromJSON(this._dataJSON,t,e)):r.showError("Cannot create mission from descriptor that has not yet been initialized!"),i},MissionDescriptor.prototype.getBestScore=function(t){return t=t||O.getDifficulty(),this._localData[t].bestScore},MissionDescriptor.prototype.getBestPerformance=function(t){return t=t||O.getDifficulty(),this._localData[t].bestPerformance},MissionDescriptor.prototype.updateBestScore=function(t,e,i){i=i||O.getDifficulty();var r=this._localData[i];return void 0===r.bestScore||t>r.bestScore?(r.bestScore=t,r.bestPerformance=e,this._saveLocalData(),!0):!1},MissionDescriptor.prototype.increasePlaythroughCount=function(t,e){e=e||O.getDifficulty(),t?this._localData[e].winCount++:this._localData[e].loseCount++,this._saveLocalData()},MissionDescriptor.prototype.getWinCount=function(t){return t=t||O.getDifficulty(),this._localData[t].winCount},DifficultyLevel.prototype.getName=function(){return this._name},DifficultyLevel.prototype.getPlayerHitpointsFactor=function(){return this._playerHitpointsFactor},MissionPerformanceLevel.prototype.getName=function(){return this._name},MissionPerformanceLevel.prototype.getRequiredScore=function(t){return this._referenceBaseScoreFactor?t.getScoreStatistics(t.getReferenceScore()*(t.isTeamMission()?this._referenceBaseScoreFactor:1),this._referenceHitRatio,this._referenceHullIntegrity,this._referenceTeamSurvival).score:0},MissionContext.prototype=new o.AsyncResource,MissionContext.prototype.constructor=MissionContext,MissionContext.prototype.getPerformanceInfo=function(t,e){var i,r={},n=this._missionPerformanceLevels.length;for(i=0;n>i&&!(e<this._missionPerformanceLevels[i].getRequiredScore(t));i++);return r.performance=i>0?this._missionPerformanceLevels[i-1].getName():F,r.nextPerformance=n>i?this._missionPerformanceLevels[i].getName():null,r.nextPerformanceScore=r.nextPerformance?this._missionPerformanceLevels[i].getRequiredScore(t):0,r},MissionContext.prototype.loadConfigurationFromJSON=function(t){var e;for(this._difficultyLevels=[],e=0;e<t.difficultyLevels.length;e++)this._difficultyLevels.push(new DifficultyLevel(t.difficultyLevels[e]));for(this._missionPerformanceLevels=[],e=0;e<t.missionPerformanceLevels.length;e++)this._missionPerformanceLevels.push(new MissionPerformanceLevel(t.missionPerformanceLevels[e]));this._tipIDs=t.tips},MissionContext.prototype.loadSettingsFromLocalStorage=function(){var t,i;this._difficulty=O.getDifficultyNames()[0],void 0!==localStorage[U]&&(i={silentFallback:r.hasVersionChanged(),defaultValue:O.getDifficultyNames()[0]},t=e.getValueOfTypeFromLocalStorage({baseType:"enum",values:O.getDifficultyNames()},U,i),(!i.error||r.hasVersionChanged())&&this.setDifficulty(t,!!i.error&&i.error!==e.Errors.INVALID_ENUM_OBJECT_ERROR))},MissionContext.prototype.requestLoad=function(){var t={};t[j]=MissionDescriptor,this._missionManager.requestConfigLoad(_.getConfigurationSetting(_.CONFIGURATION.MISSION_FILES).filename,_.getConfigurationSetting(_.CONFIGURATION.MISSION_FILES).folder,t,this.setToReady.bind(this))},MissionContext.prototype.getDifficulty=function(){return this._difficulty},MissionContext.prototype.setDifficulty=function(t,e){void 0===e&&(e=!0),this._difficulty!==t&&(this._difficulty=t,e&&(localStorage[U]=t))},MissionContext.prototype.getDifficultyNames=function(){var t,e=[];for(t=0;t<this._difficultyLevels.length;t++)e.push(this._difficultyLevels[t].getName());return e},MissionContext.prototype.getDifficultyLevel=function(t){var e;for(e=0;e<this._difficultyLevels.length;e++)if(this._difficultyLevels[e].getName()===t)return this._difficultyLevels[e];return null},MissionContext.prototype.getTipIDs=function(){return this._tipIDs},MissionContext.prototype.getMissionNames=function(){var t=[];return this._missionManager.executeForAllResourcesOfType(j,function(e){(r.isDebugVersion()||!e.isTest())&&t.push(e.getName())}),t},MissionContext.prototype.getMissionDescriptors=function(){var t=[];return this._missionManager.executeForAllResourcesOfType(j,function(e){(r.isDebugVersion()||!e.isTest())&&t.push(e)}),t},MissionContext.prototype.getMissionDescriptor=function(t){return this._missionManager.getResource(j,t)},MissionContext.prototype.requestMissionDescriptor=function(t,e){var i=this._missionManager.getResource(j,t);i?(this._missionManager.requestResourceLoad(),this._missionManager.executeWhenReady(function(){e(i)})):e(null)},MissionContext.prototype.requestMission=function(t,e,i,r){var n=this._missionManager.getResource(j,t);n?(this._missionManager.requestResourceLoad(),this._missionManager.executeWhenReady(function(){r(n.createMission(e,i))})):r(null)},M=l.getPool(u.Particle),x=l.getPool(y.Projectile),b=l.getPool(T.Explosion),O=new MissionContext,R={},R[N.DESTROYED]=DestroyedCondition,R[N.COUNT]=CountCondition,R[N.TIME_ELAPSED]=TimeCondition,A={},A[P.WIN]=WinAction,A[P.LOSE]=LoseAction,A[P.MESSAGE]=MessageAction,A[P.CLEAR_MESSAGES]=ClearMessagesAction,A[P.COMMAND]=CommandAction,_.executeWhenReady(function(){C=_.getSetting(_.BATTLE_SETTINGS.SHOW_HITBOXES_FOR_HITCHECKS)}),{MissionState:w,ObjectiveState:V,FAILED_MISSION_PERFORMACE:F,loadConfigurationFromJSON:O.loadConfigurationFromJSON.bind(O),loadSettingsFromLocalStorage:O.loadSettingsFromLocalStorage.bind(O),requestLoad:O.requestLoad.bind(O),executeWhenReady:O.executeWhenReady.bind(O),getDebugInfo:getDebugInfo,getDifficulty:O.getDifficulty.bind(O),setDifficulty:O.setDifficulty.bind(O),getDifficultyNames:O.getDifficultyNames.bind(O),getTipIDs:O.getTipIDs.bind(O),getMissionNames:O.getMissionNames.bind(O),getMissionDescriptor:O.getMissionDescriptor.bind(O),getMissionDescriptors:O.getMissionDescriptors.bind(O),requestMissionDescriptor:O.requestMissionDescriptor.bind(O),requestMission:O.requestMission.bind(O)}}),define("modules/control",["utils/utils","modules/application","modules/async-resource","modules/strings"],function(t,e,i,r){"use strict";function setModulePrefix(t){H=t}function ControlBinding(t){this._actionName="string"==typeof t?t:null,"object"==typeof t&&this.loadFromJSON(t)}function InputInterpreter(t,e){this._listening=!1,this._enabled=!0,this._bindingClass=t,this._bindings={},this._disabledActions={},void 0!==e&&this.loadFromJSON(e)}function KeyBinding(i,r,n,l,h){this._key=r||null,this._keyCode=t.getKeyCodeOf(r),this._shiftState=void 0===n?!1:n||this._keyCode===o,this._ctrlState=void 0===l?!1:l||this._keyCode===s,this._altState=void 0===h?!1:h||this._keyCode===a,ControlBinding.call(this,i),e.log_DEBUG("Created key binding: "+this._actionName+" - "+this.getControlString(),3)}function KeyboardInputInterpreter(t){InputInterpreter.call(this,KeyBinding,t),this._currentlyPressedKeys=new Array(256)}function MouseBinding(t){this._buttonIndex=0,this._moveX=0,this._moveY=0,this._measuredFromCenter=!1,this._scrollX=0,this._scrollY=0,ControlBinding.call(this,t)}function MouseInputInterpreter(t){this._currentlyPressedButtons=[!1,!1,!1],this._screenCenter=[0,0],this._screenSize=0,this._mousePosition=[-1,-1],this._mousePositionChange=[0,0],this._scrollChange=[0,0],this._moveSensitivity=0,this._displacementAreaRelativeSize=0,this._displacementFactor=1,this._displacementDeadzone=0,InputInterpreter.call(this,MouseBinding,t)}function GamepadBinding(t){this._button=this.BUTTON_NONE,this._axisIndex=this.AXIS_NONE,this._axisPositive=!1,ControlBinding.call(this,t)}function GamepadSensitivityActionGroup(t){this._sensitivityFactor=t.sensitivityFactor||0,this._staticSensitivity=t.staticSensitivity===!0,this._quadraticIntensity=t.quadraticSensitivity===!0,this._actionNames=t.actionNames,this._sensitivityFactor&&this._staticSensitivity&&e.showError("Sensitivity action group defined with both factored and static sensitivity!",e.ErrorSeverity.MINOR)}function GamepadInputInterpreter(t){this._gamepad=null,this._sensitivityActionGroups=null,InputInterpreter.call(this,GamepadBinding,t)}function Action(t){this._name=null,this._description=null,this._continuous=!1,this._triggered=!1,this._intensity=this.INTENSITY_NOT_SPECIFIED,this._executed=!1,this._nonTriggeredExecuted=!0,this._executeTriggered=null,this._executeNonTriggered=null,this._source=null,void 0!==t&&this.loadFromJSON(t)}function Controller(t){this._context=null,this._actions={},void 0!==t&&this.loadFromJSON(t)}function ControlContext(){i.AsyncResource.call(this),this._dataJSON=null,this._inputInterpreterTypes={},this._inputInterpreters=null,this._inputInterpretersByType={},this._controllerTypes={},this._controllers=null,this._controllersPriorityQueue=null,this._controllersByType={},this._listening=!1,this._disabledActions={}}var n={NONE:"none",LEFT:"left",MIDDLE:"middle",RIGHT:"right"},o=16,s=17,a=18,l=" + ",h="_key",u="_shift",c="_ctrl",p="_alt",d=[n.NONE,n.LEFT,n.MIDDLE,n.RIGHT],_="left",g="right",m="up",f="down",S="_button",y="_moveX",T="_moveY",E="_measuredFromCenter",C="_scrollX",M="_scrollY",x="_gamepad_button",b="_gamepad_axisIndex",O="_gamepad_axisPositive",R={name:"key"+r.CATEGORY_SEPARATOR},A={name:"mouse"+r.CATEGORY_SEPARATOR+"leftButton",defaultValue:"left click"},I={name:"mouse"+r.CATEGORY_SEPARATOR+"rightButton",defaultValue:"right click"},v={name:"mouse"+r.CATEGORY_SEPARATOR+"middleButton",defaultValue:"middle click"},N={name:"mouse"+r.CATEGORY_SEPARATOR+"fromCenter",defaultValue:"{move} {toDirection} from center"},L={name:"mouse"+r.CATEGORY_SEPARATOR+"notFromCenter",defaultValue:"{move} {toDirection}"},D={name:"mouse"+r.CATEGORY_SEPARATOR+"move",defaultValue:"move"},P={name:"mouse"+r.CATEGORY_SEPARATOR+"leftDirection",defaultValue:"left"},w={name:"mouse"+r.CATEGORY_SEPARATOR+"rightDirection",defaultValue:"right"},V={name:"mouse"+r.CATEGORY_SEPARATOR+"upDirection",defaultValue:"up"},F={name:"mouse"+r.CATEGORY_SEPARATOR+"downDirection",defaultValue:"down"},B={name:"mouse"+r.CATEGORY_SEPARATOR+"scroll",defaultValue:"scroll"},U={name:"joystick"+r.CATEGORY_SEPARATOR+"button",defaultValue:"button {index}"},j={name:"joystick"+r.CATEGORY_SEPARATOR+"axis",defaultValue:"axis {index} {direction}"},G={name:"joystick"+r.CATEGORY_SEPARATOR+"positiveDirection",defaultValue:"positive"},k={name:"joystick"+r.CATEGORY_SEPARATOR+"negativeDirection",defaultValue:"negative"},H="";return ControlBinding.prototype.getActionName=function(){return this._actionName},ControlBinding.prototype.getControlString=function(){return e.showError("Cannot get control string of generic control binding!"),null},ControlBinding.prototype.loadFromJSON=function(t){this._actionName=t.action},ControlBinding.prototype.saveToLocalStorage=function(){e.showError("Cannot save generic control binding to local storage!")},ControlBinding.prototype.loadFromLocalStorage=function(){e.showError("Cannot load generic control binding from local storage!")},ControlBinding.prototype.removeFromLocalStorage=function(){e.showError("Cannot remove generic control binding from local storage!")},ControlBinding.prototype.bindsTheSameControls=function(){return e.showError("Cannot check if generic control binds the same controls as another binding!"),!0},InputInterpreter.prototype.getDeviceName=function(){return"Generic"},InputInterpreter.prototype.resetState=function(){e.showError("Cannot reset the state of a generic input interpreter!")},InputInterpreter.prototype.isListening=function(){return this._listening},InputInterpreter.prototype.startListening=function(){this._listening||(this.resetState(),this._listening=!0)},InputInterpreter.prototype.stopListening=function(){this._listening&&(this.resetState(),this._listening=!1)},InputInterpreter.prototype.toggleListening=function(){this._listening?this.stopListening():this.startListening()},InputInterpreter.prototype.isEnabled=function(){return this._enabled},InputInterpreter.prototype.enable=function(){this._enabled=!0},InputInterpreter.prototype.disable=function(){this._enabled=!1},InputInterpreter.prototype.toggleEnabled=function(){this._enabled?this.disable():this.enable()},InputInterpreter.prototype.setBinding=function(t){this._bindings[t.getActionName()]=t},InputInterpreter.prototype.setAndStoreBinding=function(t){this.setBinding(t),t.saveToLocalStorage()},InputInterpreter.prototype.loadFromJSON=function(t){var e;for(e=0;e<t.bindings.length;e++)this.setBinding(new this._bindingClass(t.bindings[e]))},InputInterpreter.prototype.loadFromLocalStorage=function(){var t;for(t in this._bindings)this._bindings.hasOwnProperty(t)&&this._bindings[t].loadFromLocalStorage()},InputInterpreter.prototype.removeFromLocalStorage=function(){var t;for(t in this._bindings)this._bindings.hasOwnProperty(t)&&this._bindings[t].removeFromLocalStorage()},InputInterpreter.prototype.getControlStringForAction=function(t){return void 0!==this._bindings[t]?this._bindings[t].getControlString():""},InputInterpreter.prototype._addActionByBinding=function(t,e,i){var r;if(e){for(r=0;r<t.length;r++)if(i.bindsTheSameControls(t[r].binding))return void t[r].actions.push(e);t.push({binding:i,actions:[e]})}},InputInterpreter.prototype.checkAction=function(t){e.showError("Cannot check if action '"+t+"' is triggered with a generic input interpreter!")},InputInterpreter.prototype.disableAction=function(t){this._disabledActions[t]=!0},InputInterpreter.prototype.enableAction=function(t){this._disabledActions[t]=!1},InputInterpreter.prototype.getTriggeredActions=function(t){var e,i,r=[],n=[];if(!this.isListening()||!this.isEnabled())return r;for(e in this._bindings)this._bindings.hasOwnProperty(e)&&(this._disabledActions[e]||t&&!t(e)||this._addActionByBinding(n,this.checkAction(e),this._bindings[e]));for(i=0;i<n.length;i++)r.push(n[i].actions);return r},KeyBinding.prototype=new ControlBinding,KeyBinding.prototype.constructor=KeyBinding,KeyBinding.prototype.loadFromJSON=function(t){ControlBinding.prototype.loadFromJSON.call(this,t),this.setKey(t.key),this._shiftState=t.shift===!0||this._keyCode===o,this._ctrlState=t.ctrl===!0||this._keyCode===s,this._altState=t.alt===!0||this._keyCode===a},KeyBinding.prototype.saveToLocalStorage=function(){localStorage[H+this._actionName+h]=this._key,localStorage[H+this._actionName+u]=this._shiftState,localStorage[H+this._actionName+c]=this._ctrlState,localStorage[H+this._actionName+p]=this._altState},KeyBinding.prototype.loadFromLocalStorage=function(){void 0!==localStorage[H+this._actionName+h]&&(this.setKey(localStorage[H+this._actionName+h]),this._shiftState="true"===localStorage[H+this._actionName+u],this._ctrlState="true"===localStorage[H+this._actionName+c],this._altState="true"===localStorage[H+this._actionName+p])},KeyBinding.prototype.removeFromLocalStorage=function(){localStorage.removeItem(H+this._actionName+h),localStorage.removeItem(H+this._actionName+u),localStorage.removeItem(H+this._actionName+c),localStorage.removeItem(H+this._actionName+p)},KeyBinding.prototype.getKey=function(){return this._key},KeyBinding.prototype.setKey=function(e){this._key=e,this._keyCode=t.getKeyCodeOf(this._key)},KeyBinding.prototype.getShiftState=function(){return this._shiftState},KeyBinding.prototype.getCtrlState=function(){return this._ctrlState},KeyBinding.prototype.getAltState=function(){return this._altState},KeyBinding.prototype.getControlString=function(){var e,i;return e=r.get(R,this._key,this._key),this._shiftState&&this._keyCode!==o&&(i=t.getKeyOfCode(o),i=r.get(R,i,i),e=i+l+e),this._ctrlState&&this._keyCode!==s&&(i=t.getKeyOfCode(s),i=r.get(R,i,i),e=i+l+e),this._altState&&this._keyCode!==a&&(i=t.getKeyOfCode(a),i=r.get(R,i,i),e=i+l+e),e},KeyBinding.prototype.isTriggered=function(t){return t[this._keyCode]&&(t[o]||!this._shiftState)&&(t[s]||!this._ctrlState)&&(t[a]||!this._altState)},KeyBinding.prototype.bindsTheSameControls=function(t){return this._keyCode===t._keyCode},KeyboardInputInterpreter.prototype=new InputInterpreter,KeyboardInputInterpreter.prototype.constructor=KeyboardInputInterpreter,KeyboardInputInterpreter.prototype.getDeviceName=function(){return"keyboard"},KeyboardInputInterpreter.prototype.resetState=function(){var t;for(t=0;t<this._currentlyPressedKeys.length;t++)this._currentlyPressedKeys[t]=!1},KeyboardInputInterpreter.prototype.defaultActionEnabledForKey=function(e){return["f5","f11","escape"].indexOf(t.getKeyOfCode(e))>=0},KeyboardInputInterpreter.prototype.handleKeyDown=function(t){this._currentlyPressedKeys[t.keyCode]=!0,this.defaultActionEnabledForKey(t.keyCode)||(t.preventDefault(),t.stopPropagation())},KeyboardInputInterpreter.prototype.handleKeyUp=function(t){this._currentlyPressedKeys[t.keyCode]=!1,this.defaultActionEnabledForKey(t.keyCode)||(t.preventDefault(),t.stopPropagation())},KeyboardInputInterpreter.prototype.startListening=function(){InputInterpreter.prototype.startListening.call(this),document.onkeydown=function(t){this.handleKeyDown(t)}.bind(this),document.onkeyup=function(t){this.handleKeyUp(t)}.bind(this),document.onkeypress=function(t){this.defaultActionEnabledForKey(t.keyCode)||(t.preventDefault(),t.stopPropagation())}.bind(this)},KeyboardInputInterpreter.prototype.stopListening=function(){InputInterpreter.prototype.stopListening.call(this),document.onkeydown=null,document.onkeyup=null},KeyboardInputInterpreter.prototype.checkAction=function(t){return this._bindings[t].isTriggered(this._currentlyPressedKeys)?{name:t,source:this}:null},MouseBinding.prototype=new ControlBinding,MouseBinding.prototype.constructor=MouseBinding,MouseBinding.prototype.loadFromJSON=function(t){switch(ControlBinding.prototype.loadFromJSON.call(this,t),this._buttonIndex=d.indexOf(t.button),this._moveX=0,this._moveY=0,t.move){case _:this._moveX=-1;break;case g:this._moveX=1;break;case m:this._moveY=-1;break;case f:this._moveY=1}switch(this._measuredFromCenter=t.fromCenter===!0,this._scrollX=0,this._scrollY=0,t.scroll){case _:this._scrollX=-1;break;case g:this._scrollX=1;break;case m:this._scrollY=-1;break;case f:this._scrollY=1}},MouseBinding.prototype.saveToLocalStorage=function(){localStorage[H+this._actionName+S]=this._buttonIndex,localStorage[H+this._actionName+y]=this._moveX,localStorage[H+this._actionName+T]=this._moveY,localStorage[H+this._actionName+E]=this._measuredFromCenter,localStorage[H+this._actionName+C]=this._scrollX,localStorage[H+this._actionName+M]=this._scrollY},MouseBinding.prototype.loadFromLocalStorage=function(){void 0!==localStorage[H+this._actionName+S]&&(this._buttonIndex=parseInt(localStorage[H+this._actionName+S],10),this._moveX=parseInt(localStorage[H+this._actionName+y],10),this._moveY=parseInt(localStorage[H+this._actionName+T],10),this._measuredFromCenter="true"===localStorage[H+this._actionName+E],this._scrollX=parseInt(localStorage[H+this._actionName+C],10),this._scrollY=parseInt(localStorage[H+this._actionName+M],10))},MouseBinding.prototype.removeFromLocalStorage=function(){localStorage.removeItem(H+this._actionName+S),localStorage.removeItem(H+this._actionName+y),localStorage.removeItem(H+this._actionName+T),localStorage.removeItem(H+this._actionName+E),localStorage.removeItem(H+this._actionName+C),localStorage.removeItem(H+this._actionName+M)},MouseBinding.prototype.isMeasuredFromCenter=function(){return this._measuredFromCenter},MouseBinding.prototype.getControlString=function(){var e="",i=null;switch(d[this._buttonIndex]){case n.LEFT:return r.get(A);case n.MIDDLE:return r.get(v);case n.RIGHT:return r.get(I)}return e=this._measuredFromCenter?r.get(N):r.get(L),this._moveX<0?i=r.get(P):this._moveX>0?i=r.get(w):this._moveY<0?i=r.get(V):this._moveY>0&&(i=r.get(F)),i?e=t.formatString(e,{move:r.get(D),toDirection:i}):(i=null,e=r.get(L),this._scrollX<0?i=r.get(P):this._scrollX>0?i=r.get(w):this._scrollY<0?i=r.get(V):this._scrollY>0&&(i=r.get(F)),i&&(e=t.formatString(e,{move:r.get(B),toDirection:i})),e)},MouseBinding.prototype.getTriggeredIntensity=function(t,e,i,r,n){var o,s;return this._buttonIndex>0?t[this._buttonIndex]===!0?1:-1:e?(o=this._measuredFromCenter?e[0]>=0?e[0]-r[0]:0:i[0],0!==this._moveX?o*this._moveX:(s=this._measuredFromCenter?e[1]>=0?e[1]-r[1]:0:i[1],0!==this._moveY?s*this._moveY:0!==this._scrollX?n[0]*this._scrollX:0!==this._scrollY?n[1]*this._scrollY:void 0)):0},MouseBinding.prototype.bindsTheSameControls=function(t){return this._buttonIndex===t._buttonIndex&&(0===this._moveX&&0===t._moveX||this._moveX*t._moveX!==0)&&(0===this._moveY&&0===t._moveY||this._moveY*t._moveY!==0)&&(0===this._scrollX&&0===t._scrollX||this._scrollX*t._scrollX!==0)&&(0===this._scrollY&&0===t._scrollY||this._scrollY*t._scrollY!==0)},MouseInputInterpreter.prototype=new InputInterpreter,MouseInputInterpreter.prototype.constructor=MouseInputInterpreter,MouseInputInterpreter.prototype._updateDisplacementFactor=function(){this._displacementFactor=1/((this._screenSize||1)*this._displacementAreaRelativeSize)},MouseInputInterpreter.prototype.setScreenCenter=function(t,e){this._screenCenter=[t,e],this._screenSize=Math.min(t,e),this._updateDisplacementFactor(),this._mousePosition=[t,e],this._mousePositionChange=[0,0],this._scrollChange=[0,0]},MouseInputInterpreter.prototype.getDeviceName=function(){return"mouse"},MouseInputInterpreter.prototype.resetState=function(){var t;for(t=0;t<this._currentlyPressedButtons.length;t++)this._currentlyPressedButtons[t]=!1;this._mousePosition=[-1,-1],this._mousePositionChange=[0,0],this._scrollChange=[0,0]},MouseInputInterpreter.prototype.setAndStoreMoveSensitivity=function(t){this._moveSensitivity=t,localStorage[H+"mouse_moveSensitivity"]=this._moveSensitivity},MouseInputInterpreter.prototype.getDisplacementAreaRelativeSize=function(){return this._displacementAreaRelativeSize},MouseInputInterpreter.prototype.setAndStoreDisplacementAreaRelativeSize=function(t){this._displacementAreaRelativeSize=t,this._updateDisplacementFactor(),localStorage[H+"mouse_displacementAreaRelativeSize"]=this._displacementAreaRelativeSize},MouseInputInterpreter.prototype.setAndStoreDisplacementDeadzone=function(t){this._displacementDeadzone=t,localStorage[H+"mouse_displacementDeadzone"]=this._displacementDeadzone},MouseInputInterpreter.prototype.loadFromJSON=function(t){InputInterpreter.prototype.loadFromJSON.call(this,t),this._moveSensitivity=t.sensitivityProfile.moveSensitivity,this._displacementAreaRelativeSize=t.sensitivityProfile.displacementAreaRelativeSize,this._updateDisplacementFactor(),this._displacementDeadzone=t.sensitivityProfile.displacementDeadzone},MouseInputInterpreter.prototype.loadFromLocalStorage=function(){InputInterpreter.prototype.loadFromLocalStorage.call(this),void 0!==localStorage[H+"mouse_moveSensitivity"]&&(this._moveSensitivity=parseFloat(localStorage[H+"mouse_moveSensitivity"])),void 0!==localStorage[H+"mouse_displacementAreaRelativeSize"]&&(this._displacementAreaRelativeSize=parseFloat(localStorage[H+"mouse_displacementAreaRelativeSize"]),this._updateDisplacementFactor()),void 0!==localStorage[H+"mouse_displacementDeadzone"]&&(this._displacementDeadzone=parseInt(localStorage[H+"mouse_displacementDeadzone"],10))},MouseInputInterpreter.prototype.removeFromLocalStorage=function(){InputInterpreter.prototype.removeFromLocalStorage.call(this),localStorage.removeItem(H+"mouse_moveSensitivity"),localStorage.removeItem(H+"mouse_displacementAreaRelativeSize"),localStorage.removeItem(H+"mouse_displacementDeadzone")},MouseInputInterpreter.prototype.handleMouseDown=function(t){return this._currentlyPressedButtons[t.which]=!0,t.preventDefault(),!1},MouseInputInterpreter.prototype.handleMouseUp=function(t){return this._currentlyPressedButtons[t.which]=!1,t.preventDefault(),!1},MouseInputInterpreter.prototype.handleMouseMove=function(t){this._mousePosition[0]>=0&&(this._mousePositionChange[0]+=t.clientX-this._mousePosition[0],this._mousePositionChange[1]+=t.clientY-this._mousePosition[1]),this._mousePosition=[t.clientX,t.clientY]},MouseInputInterpreter.prototype.handleWheel=function(t){this._scrollChange[0]+=t.deltaX,this._scrollChange[1]+=t.deltaY},MouseInputInterpreter.prototype.startListening=function(){InputInterpreter.prototype.startListening.call(this),document.onmousedown=function(t){this.handleMouseDown(t)}.bind(this),document.onmouseup=function(t){this.handleMouseUp(t)}.bind(this),document.onmousemove=function(t){this.handleMouseMove(t)}.bind(this),document.onwheel=function(t){this.handleWheel(t)}.bind(this),document.onclick=function(t){return t.preventDefault(),!1},document.oncontextmenu=function(t){return t.preventDefault(),!1}},MouseInputInterpreter.prototype.stopListening=function(){InputInterpreter.prototype.stopListening.call(this),document.onmousedown=null,document.onmouseup=null,document.onmousemove=null,document.onwheel=null,document.onclick=null,document.oncontextmenu=null},MouseInputInterpreter.prototype.checkAction=function(t){var e=this._bindings[t].getTriggeredIntensity(this._currentlyPressedButtons,this._mousePosition,this._mousePositionChange,this._screenCenter,this._scrollChange);return e>=0?{name:t,intensity:this._bindings[t].isMeasuredFromCenter()===!0?Math.min(1,Math.max(0,e-this._displacementDeadzone)*this._displacementFactor):e*this._moveSensitivity,source:this}:null},MouseInputInterpreter.prototype.getTriggeredActions=function(t){var e=InputInterpreter.prototype.getTriggeredActions.call(this,t);return this._mousePositionChange=[0,0],this._scrollChange=[0,0],e},MouseInputInterpreter.prototype.getMousePosition=function(){return this._mousePosition},MouseInputInterpreter.prototype.isMouseDisplaced=function(){return Math.abs(this._mousePosition[0]-this._screenCenter[0])>this._displacementDeadzone||Math.abs(this._mousePosition[1]-this._screenCenter[1])>this._displacementDeadzone},GamepadBinding.prototype=new ControlBinding,GamepadBinding.prototype.constructor=GamepadBinding,GamepadBinding.prototype.BUTTON_NONE=-1,GamepadBinding.prototype.AXIS_NONE=-1,GamepadBinding.prototype.loadFromJSON=function(t){ControlBinding.prototype.loadFromJSON.call(this,t),"number"==typeof t.button&&(this._button=t.button),"string"==typeof t.axis&&(this._axisIndex=Math.abs(parseInt(t.axis,10)),this._axisPositive="-"!==t.axis[0])},GamepadBinding.prototype.saveToLocalStorage=function(){localStorage[H+this._actionName+x]=this._button,localStorage[H+this._actionName+b]=this._axisIndex,localStorage[H+this._actionName+O]=this._axisPositive},GamepadBinding.prototype.loadFromLocalStorage=function(){void 0!==localStorage[H+this._actionName+x]&&(this._button=parseInt(localStorage[H+this._actionName+x],10),this._axisIndex=parseInt(localStorage[H+this._actionName+x],10),this._axisPositive="true"===localStorage[H+this._actionName+O])},GamepadBinding.prototype.removeFromLocalStorage=function(){localStorage.removeItem(H+this._actionName+x),localStorage.removeItem(H+this._actionName+b),localStorage.removeItem(H+this._actionName+O)},GamepadBinding.prototype.getTriggeredIntensity=function(t){return t?this._button!==this.BUTTON_NONE?1===t.buttons[this._button]||"object"==typeof t.buttons[this._button]&&t.buttons[this._button].pressed?1:0:this._axisIndex!==this.AXIS_NONE?Math.max(t.axes[this._axisIndex]*(this._axisPositive?1:-1),0):0:0},GamepadBinding.prototype.getControlString=function(){return this._button!==this.BUTTON_NONE?t.formatString(r.get(U),{index:this._button+1}):this._axisIndex!==this.AXIS_NONE?t.formatString(r.get(j),{index:this._axisIndex+1,direction:this._axisPositive?r.get(G):r.get(k)}):""},GamepadBinding.prototype.bindsTheSameControls=function(t){return this._button===t._button&&this._axisIndex===t._axisIndex},GamepadSensitivityActionGroup.prototype.getIntensityForAction=function(t,e){return this._actionNames.indexOf(e)>=0?this._staticSensitivity?void 0:t*(this._quadraticIntensity?t:1)*this._sensitivityFactor:-1},GamepadInputInterpreter.prototype=new InputInterpreter,GamepadInputInterpreter.prototype.constructor=GamepadInputInterpreter,GamepadInputInterpreter.prototype.getDeviceName=function(){return"joystick"},GamepadInputInterpreter.prototype.resetState=function(){
this._gamepad=null},GamepadInputInterpreter.prototype.loadFromJSON=function(t){var e;if(InputInterpreter.prototype.loadFromJSON.call(this,t),this._sensitivityActionGroups=[],t.sensitivityProfile&&t.sensitivityProfile.actionGroups)for(e=0;e<t.sensitivityProfile.actionGroups.length;e++)this._sensitivityActionGroups.push(new GamepadSensitivityActionGroup(t.sensitivityProfile.actionGroups[e]))},GamepadInputInterpreter.prototype.handleGamepadConnected=function(t){this._gamepad||(this._gamepad=t.gamepad)},GamepadInputInterpreter.prototype.startListening=function(){InputInterpreter.prototype.startListening.call(this),window.addEventListener("gamepadconnected",function(t){this.handleGamepadConnected(t)}.bind(this))},GamepadInputInterpreter.prototype.stopListening=function(){InputInterpreter.prototype.stopListening.call(this),window.ongamepadconnected=null},GamepadInputInterpreter.prototype.checkAction=function(t){var e,i,r;if(e=this._bindings[t].getTriggeredIntensity(this._gamepad),e>0){for(i=0;i<this._sensitivityActionGroups.length;i++)if(r=this._sensitivityActionGroups[i].getIntensityForAction(e,t),void 0===r||r>0)return{name:t,intensity:r,source:this};return{name:t,intensity:e,source:this}}return null},GamepadInputInterpreter.prototype.getTriggeredActions=function(t){var e;return this.isListening()?(e=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[],e&&e.length>0?this._gamepad=e[0]:this._gamepad=null,this._gamepad?InputInterpreter.prototype.getTriggeredActions.call(this,t):[]):[]},Action.prototype.INTENSITY_NOT_SPECIFIED=-3,Action.prototype.INTENSITY_KEYPRESS=-2,Action.prototype.getName=function(){return this._name},Action.prototype.getDescription=function(){return this._description},Action.prototype.loadFromJSON=function(t){this._name=t.name,this._description=t.description,this._continuous=t.continuous===!0,this._triggered=!1,this._intensity=this.INTENSITY_NOT_SPECIFIED,this._executed=!1,this._nonTriggeredExecuted=!0},Action.prototype.setTriggered=function(t,e,i){this._triggered=t,void 0!==e&&(this._intensity===this.INTENSITY_NOT_SPECIFIED||this._intensity>=0&&e>this._intensity)?this._intensity=e:void 0===e&&(this._intensity=this.INTENSITY_KEYPRESS),this._source=i},Action.prototype.setExecuteTriggered=function(t){this._executeTriggered=t},Action.prototype.setExecuteNonTriggered=function(t){this._executeNonTriggered=t},Action.prototype.execute=function(){this._continuous===!0?this._triggered===!0?null!==this._executeTriggered&&this._executeTriggered(this._intensity>=0?this._intensity:void 0,this._source):null!==this._executeNonTriggered&&this._executeNonTriggered():this._triggered===!0&&this._executed===!1?(null!==this._executeTriggered&&this._executeTriggered(this._intensity>=0?this._intensity:void 0,this._source),this._executed=!0):(this._triggered===!1&&this._nonTriggeredExecuted===!1&&(null!==this._executeNonTriggered&&this._executeNonTriggered(),this._nonTriggeredExecuted=!0),this._triggered===!1?this._executed=!1:this._nonTriggeredExecuted=!1),this._triggered=!1,this._intensity=this.INTENSITY_NOT_SPECIFIED},Controller.prototype.setContext=function(t){this._context=t},Controller.prototype.getType=function(){return e.showError("Attempting to get the type of a generic controller object!"),"none (generic)"},Controller.prototype.getActions=function(){var t,e=[];for(t in this._actions)this._actions.hasOwnProperty(t)&&e.push(this._actions[t]);return e},Controller.prototype.loadFromJSON=function(t){var i,r;for(i=0;i<t.actions.length;i++)r=t.actions[i],(!r.debug||e.isDebugVersion())&&(this._actions[r.name]=new Action(r))},Controller.prototype.setActionFunction=function(t,i,r){this._actions[t]?i===!0?this._actions[t].setExecuteTriggered(r):this._actions[t].setExecuteNonTriggered(r):e.showError("Attempting to initialize action '"+t+"', but no such action was defined for '"+this.getType()+"' type controllers.",e.ErrorSeverity.SEVERE,"The action definition might be missing from the settings file, or the settings file has not been loaded properly. The game is still playable, but this action will not work until the error with the settings file is corrected and the game is restarted.")},Controller.prototype.setActionFunctions=function(t,e,i){this.setActionFunction(t,!0,e),this.setActionFunction(t,!1,i)},Controller.prototype.executeActions=function(t){var e,i,r,n,o;for(e=0;e<t.length;e++){for(r=null,n=-1,o=null,i=0;i<t[e].length;i++)void 0!==this._actions[t[e][i].name]&&(void 0!==t[e][i].intensity&&void 0!==n&&t[e][i].intensity>n||void 0!==n&&void 0===t[e][i].intensity)&&(r=t[e][i].name,n=t[e][i].intensity,o=t[e][i].source);r&&((void 0===n||n>0)&&this._actions[r].setTriggered(!0,n,o),t[e]=[])}for(r in this._actions)this._actions.hasOwnProperty(r)&&this._actions[r].execute()},ControlContext.prototype=new i.AsyncResource,ControlContext.prototype.constructor=ControlContext,ControlContext.prototype.registerInputInterpreterType=function(t,e){this._inputInterpreterTypes[t]=e},ControlContext.prototype.addInputInterpreter=function(i){var r=t.getKeyOfValue(this._inputInterpreterTypes,i.constructor);r?(this._inputInterpreters.push(i),this._inputInterpretersByType[r]=i):e.showError("Attempting to add an input interpreter of an unregistered type to the control context!",e.ErrorSeverity.SEVERE,"Interpreter type: "+i.constructor.name)},ControlContext.prototype.getInputInterpreters=function(){return this._inputInterpreters},ControlContext.prototype.getInputInterpreter=function(t){return this._inputInterpretersByType[t]?this._inputInterpretersByType[t]:(e.showError("Asked for a interpreter of type '"+t+"', which does not exist!"),null)},ControlContext.prototype.registerControllerType=function(t,e){this._controllerTypes[t]=e},ControlContext.prototype.addController=function(i){var r=t.getKeyOfValue(this._controllerTypes,i.constructor);r?(this._controllers.push(i),this._controllersByType[r]=i,i.setContext(this)):e.showError("Attempting to add a controller of an unregistered type to the control context!",e.ErrorSeverity.SEVERE,"Controller type: "+i.prototype.constructor.name)},ControlContext.prototype.getControllers=function(){return this._controllers},ControlContext.prototype.getController=function(t){return this._controllersByType[t]?this._controllersByType[t]:(e.showError("Asked for a controller of type '"+t+"', which does not exist!"),null)},ControlContext.prototype.makeControllerPriority=function(t){var e;for(this._controllersPriorityQueue=[],e=0;e<this._controllers.length;e++)if(this._controllers[e]===t){this._controllersPriorityQueue.push(this._controllers[e]);break}for(e=0;e<this._controllers.length;e++)this._controllers[e]!==t&&this._controllersPriorityQueue.push(this._controllers[e])},ControlContext.prototype.isControllerPriority=function(t){return this._controllersPriorityQueue.length>0&&this._controllersPriorityQueue[0]===this.getController(t)},ControlContext.prototype.restoreDefaultControllerPriorityOrder=function(){this._controllersPriorityQueue=this._controllers},ControlContext.prototype.disableAction=function(t){this._disabledActions[t]=!0},ControlContext.prototype.enableAction=function(t){this._disabledActions[t]=!1},ControlContext.prototype.control=function(t){var e,i,r=function(t){return!this._disabledActions[t]}.bind(this);if(this._listening){for(i=[],e=0;e<this._inputInterpreters.length;e++)i=i.concat(this._inputInterpreters[e].getTriggeredActions(r));for(e=0;e<this._controllersPriorityQueue.length;e++)this._controllersPriorityQueue[e].executeActions(i,t)}},ControlContext.prototype.loadConfigurationFromJSON=function(t){var i,r;for(this._controllers=[],i=0,r=t.controllers.length;r>i;i++)this._controllerTypes[t.controllers[i].type]?this.addController(new this._controllerTypes[t.controllers[i].type](t.controllers[i])):e.showError("Attempting to load unregistered controller type: '"+t.controllers[i].type+"'!",e.ErrorSeverity.SEVERE,Object.keys(this._controllerTypes).length>0?"Every controller to be loaded must be of one of the registered types: "+Object.keys(this._controllerTypes).join(", ")+".":"There are no types registered and thus loading controllers is not possible.");this._controllersPriorityQueue=this._controllers},ControlContext.prototype.loadSettingsFromJSON=function(t,i){var r,n;if(i)for(r=0,n=t.inputDevices.length;n>r;r++)this._inputInterpreters[r].removeFromLocalStorage(),this._inputInterpreters[r].loadFromJSON(t.inputDevices[r]);else for(this._dataJSON=t,this._inputInterpreters=[],r=0,n=t.inputDevices.length;n>r;r++)this._inputInterpreterTypes[t.inputDevices[r].type]?this.addInputInterpreter(new this._inputInterpreterTypes[t.inputDevices[r].type](t.inputDevices[r])):e.showError("Attempting to load unregistered input device type: '"+t.inputDevices[r].type+"'!",e.ErrorSeverity.SEVERE,Object.keys(this._inputInterpreterTypes).length>0?"Every input device interpreter to be loaded must be of one of the registered types: "+Object.keys(this._inputInterpreterTypes).join(", ")+".":"There are no types registered and thus loading input interpreters is not possible.")},ControlContext.prototype.loadSettingsFromLocalStorage=function(){var t;for(t=0;t<this._inputInterpreters.length;t++)this._inputInterpreters[t].loadFromLocalStorage();this.setToReady()},ControlContext.prototype.restoreDefaults=function(){this.loadSettingsFromJSON(this._dataJSON,!0)},ControlContext.prototype.startListening=function(){this.executeWhenReady(function(){var t;for(t=0;t<this._inputInterpreters.length;t++)this._inputInterpreters[t].startListening();this._listening=!0})},ControlContext.prototype.stopListening=function(){this.executeWhenReady(function(){var t;for(t=0;t<this._inputInterpreters.length;t++)this._inputInterpreters[t].stopListening();this._listening=!1})},ControlContext.prototype.isListening=function(){return this._listening},ControlContext.prototype.setScreenCenter=function(t,e){this.executeWhenReady(function(){var i;for(i=0;i<this._inputInterpreters.length;i++)this._inputInterpreters[i].setScreenCenter&&this._inputInterpreters[i].setScreenCenter(t,e)})},{setModulePrefix:setModulePrefix,ControlBinding:ControlBinding,KeyBinding:KeyBinding,KeyboardInputInterpreter:KeyboardInputInterpreter,MouseBinding:MouseBinding,MouseInputInterpreter:MouseInputInterpreter,GamepadBinding:GamepadBinding,GamepadInputInterpreter:GamepadInputInterpreter,Controller:Controller,ControlContext:ControlContext}}),define("modules/camera-controller",["utils/types","modules/application","modules/control","modules/scene/camera"],function(t,e,i,r){"use strict";function CameraController(n){i.Controller.call(this,n),this._controlledCamera=null,this._controlledVelocityVector=[0,0,0],this._velocityTargetVector=[0,0,0],this._maxSpeed=n.maxSpeed||0,this._acceleration=n.acceleration||0,this._deceleration=n.deceleration||0,this._angularVelocityVector=[0,0,0],this._maxAngularVelocity=n.maxSpin||0,this._angularAcceleration=n.angularAcceleration||0,this._angularDeceleration=n.angularDeceleration||0,this._angularVelocityTargetVector=[0,0,0],this._objectChangeTransitionDuration=n.objectChangeTransitionDuration,this._viewChangeTransitionDuration=n.viewChangeTransitionDuration,this._viewResetTransitionDuration=n.viewResetTransitionDuration,this._transitionStyle=t.getEnumValue(r.Camera.TransitionStyle,n.transitionStyle,{name:"cameraController.transitionStyle"}),this.setActionFunctions("controlCamera",function(){this._context?this._context.makeControllerPriority(this):e.showError("Cannot make camera controller the priority controller because it is not added to any control context!")}.bind(this),function(){this._controlledCamera.getConfiguration().resetsOnFocusChange()&&this._controlledCamera.transitionToConfigurationDefaults(this._viewResetTransitionDuration,this._transitionStyle),this._context?this._context.restoreDefaultControllerPriorityOrder():e.showError("Cannot restore original priority order of the camera controller's context because it is not added to any!")}.bind(this)),this.setActionFunctions("cameraTurnLeft",function(t){void 0===t?this._angularVelocityTargetVector[1]>-this._maxAngularVelocity&&(this._angularVelocityTargetVector[1]=-this._maxAngularVelocity):(this._angularVelocityTargetVector[1]=-t,this._angularVelocityVector[1]=-t)}.bind(this),function(){this._angularVelocityTargetVector[1]<0&&(this._angularVelocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraTurnRight",function(t){void 0===t?this._angularVelocityTargetVector[1]<this._maxAngularVelocity&&(this._angularVelocityTargetVector[1]=this._maxAngularVelocity):(this._angularVelocityTargetVector[1]=t,this._angularVelocityVector[1]=t)}.bind(this),function(){this._angularVelocityTargetVector[1]>0&&(this._angularVelocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraTurnUp",function(t){void 0===t?this._angularVelocityTargetVector[0]>-this._maxAngularVelocity&&(this._angularVelocityTargetVector[0]=-this._maxAngularVelocity):(this._angularVelocityTargetVector[0]=-t,this._angularVelocityVector[0]=-t)}.bind(this),function(){this._angularVelocityTargetVector[0]<0&&(this._angularVelocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraTurnDown",function(t){void 0===t?this._angularVelocityTargetVector[0]<this._maxAngularVelocity&&(this._angularVelocityTargetVector[0]=this._maxAngularVelocity):(this._angularVelocityTargetVector[0]=t,this._angularVelocityVector[0]=t)}.bind(this),function(){this._angularVelocityTargetVector[0]>0&&(this._angularVelocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraRollLeft",function(t){void 0===t?this._angularVelocityTargetVector[2]>-this._maxAngularVelocity&&(this._angularVelocityTargetVector[2]=-this._maxAngularVelocity):(this._angularVelocityTargetVector[2]=-t,this._angularVelocityVector[2]=-t)}.bind(this),function(){this._angularVelocityTargetVector[2]<0&&(this._angularVelocityTargetVector[2]=0)}.bind(this)),this.setActionFunctions("cameraRollRight",function(t){void 0===t?this._angularVelocityTargetVector[2]<this._maxAngularVelocity&&(this._angularVelocityTargetVector[2]=this._maxAngularVelocity):(this._angularVelocityTargetVector[2]=t,this._angularVelocityVector[2]=t)}.bind(this),function(){this._angularVelocityTargetVector[2]>0&&(this._angularVelocityTargetVector[2]=0)}.bind(this)),this.setActionFunctions("cameraMoveLeft",function(){this._velocityTargetVector[0]>-this._maxSpeed&&(this._velocityTargetVector[0]=-this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[0]<0&&(this._velocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraMoveRight",function(){this._velocityTargetVector[0]<this._maxSpeed&&(this._velocityTargetVector[0]=this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[0]>0&&(this._velocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraMoveUp",function(){this._velocityTargetVector[1]<this._maxSpeed&&(this._velocityTargetVector[1]=this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[1]>0&&(this._velocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraMoveDown",function(){this._velocityTargetVector[1]>-this._maxSpeed&&(this._velocityTargetVector[1]=-this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[1]<0&&(this._velocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraMoveForward",function(t){var e=(void 0!==t?t:1)*this._maxSpeed;(this._velocityTargetVector[2]>-e||void 0!==t)&&(this._velocityTargetVector[2]=-e)}.bind(this),function(){this._velocityTargetVector[2]<0&&(this._velocityTargetVector[2]=0)}.bind(this)),this.setActionFunctions("cameraMoveBackward",function(){this._velocityTargetVector[2]<this._maxSpeed&&(this._velocityTargetVector[2]=this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[2]>0&&(this._velocityTargetVector[2]=0)}.bind(this)),this.setActionFunction("cameraDecreaseFOV",!0,function(){this._controlledCamera.decreaseFOV()}.bind(this)),this.setActionFunction("cameraIncreaseFOV",!0,function(){this._controlledCamera.increaseFOV()}.bind(this)),this.setActionFunction("nextView",!0,function(){this._controlledCamera.changeToNextView(this._viewChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("previousView",!0,function(){this._controlledCamera.changeToPreviousView(this._viewChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("followNext",!0,function(){this._controlledCamera.followNextNode(!0,this._objectChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("followPrevious",!0,function(){this._controlledCamera.followPreviousNode(!0,this._objectChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("resetView",!0,function(){this._controlledCamera.transitionToConfigurationDefaults(this._viewResetTransitionDuration,this._transitionStyle)}.bind(this))}return CameraController.prototype=new i.Controller,CameraController.prototype.constructor=CameraController,CameraController.prototype.getType=function(){return"camera"},CameraController.prototype.setControlledCamera=function(t){this._controlledCamera=t},CameraController.prototype.getMaxSpeed=function(){return this._maxSpeed},CameraController.prototype.setCameraToFollowObject=function(t,e,i){this._controlledCamera.followObject(t,!1,e,i)},CameraController.prototype.setToFreeCamera=function(){this._controlledCamera.setToFreeCamera(!1)},CameraController.prototype._updateAngularVelocity=function(t){var e;for(e=0;e<this._angularVelocityVector.length;e++)this._angularVelocityVector[e]>=0?this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]?(this._angularVelocityVector[e]+=this._angularAcceleration*t/1e3,this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])):this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]-=this._angularDeceleration*t/1e3,this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])):this._angularVelocityVector[e]<0&&(this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]?(this._angularVelocityVector[e]-=this._angularAcceleration*t/1e3,this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])):this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]+=this._angularDeceleration*t/1e3,this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])))},CameraController.prototype._updateVelocity=function(t){var e;for(e=0;e<this._controlledVelocityVector.length;e++)this._controlledVelocityVector[e]>=0?this._controlledVelocityVector[e]<this._velocityTargetVector[e]?(this._controlledVelocityVector[e]+=this._acceleration*t/1e3,this._controlledVelocityVector[e]>this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])):this._controlledVelocityVector[e]>this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]-=this._deceleration*t/1e3,this._controlledVelocityVector[e]<this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])):this._controlledVelocityVector[e]<0&&(this._controlledVelocityVector[e]>this._velocityTargetVector[e]?(this._controlledVelocityVector[e]-=this._acceleration*t/1e3,this._controlledVelocityVector[e]<this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])):this._controlledVelocityVector[e]<this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]+=this._deceleration*t/1e3,this._controlledVelocityVector[e]>this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])))},CameraController.prototype.executeActions=function(t,e){this._controlledCamera&&(i.Controller.prototype.executeActions.call(this,t),this._updateAngularVelocity(e),this._updateVelocity(e),this._controlledCamera.setControlledVelocityVector(this._controlledVelocityVector),this._controlledCamera.setAngularVelocityVector(this._angularVelocityVector))},{CameraController:CameraController}}),define("armada/screens/shared",["modules/game","modules/media-resources","modules/components","armada/configuration","armada/audio"],function(t,e,i,r,n){"use strict";var o,s,a={MENU_THEME:"menu",DEBRIEFING_VICTORY_THEME:"debriefing_victory",DEBRIEFING_DEFEAT_THEME:"debriefing_defeat",SELECTOR_SOURCE:"selector.html",SELECTOR_CSS:"selector.css",SLIDER_SOURCE:"slider.html",SLIDER_CSS:"slider.css",LOADING_BOX_SOURCE:"loadingbox.html",LOADING_BOX_CSS:"loadingbox.css",INFO_BOX_SOURCE:"infobox.html",INFO_BOX_CSS:"infobox.css",MENU_COMPONENT_SOURCE:"menucomponent.html",LIST_COMPONENT_SOURCE:"listcomponent.html",LIST_COMPONENT_CSS:"listcomponent.css",MENU_CLASS_NAME:"menu",MENU_BUTTON_CLASS_NAME:"button",MENU_BUTTON_CONTAINER_CLASS_NAME:"transparentContainer",LIST_CLASS_NAME:"list",LIST_ELEMENT_CLASS_NAME:"listElement",LIST_ELEMENT_CONTAINER_CLASS_NAME:"transparentContainer",CAPTION_CLASS_NAME:"caption",SUBCAPTION_CLASS_NAME:"subcaption",SUPERIMPOSE_BACKGROUND_COLOR:[.25,.25,.25,.5],SCREEN_BACKGROUND_CLASS_NAME:"fullScreenFix",SCREEN_CONTAINER_CLASS_NAME:"fullScreenContainer",MAIN_MENU_SCREEN_NAME:"mainMenu",MAIN_MENU_SCREEN_SOURCE:"menu.html",MAIN_MENU_CONTAINER_ID:"menuContainer",MISSIONS_SCREEN_NAME:"missions",MISSIONS_SCREEN_SOURCE:"missions.html",MISSIONS_SCREEN_CSS:"missions.css",MISSIONS_LIST_CONTAINER_ID:"missionListContainer",BATTLE_SCREEN_NAME:"battle",BATTLE_SCREEN_SOURCE:"battle.html",BATTLE_SCREEN_CSS:"battle.css",DEBRIEFING_SCREEN_NAME:"debriefing",DEBRIEFING_SCREEN_SOURCE:"debriefing.html",DEBRIEFING_SCREEN_CSS:"debriefing.css",DATABASE_SCREEN_NAME:"database",DATABASE_SCREEN_SOURCE:"database.html",DATABASE_SCREEN_CSS:"database.css",SETTINGS_SCREEN_NAME:"settings",SETTINGS_SCREEN_SOURCE:"menu.html",SETTINGS_MENU_CONTAINER_ID:"menuContainer",GENERAL_SETTINGS_SCREEN_NAME:"generalSettings",GENERAL_SETTINGS_SCREEN_SOURCE:"general-settings.html",GRAPHICS_SCREEN_NAME:"graphics",GRAPHICS_SCREEN_SOURCE:"graphics.html",GRAPHICS_SCREEN_CSS:"graphics.css",AUDIO_SCREEN_NAME:"audio",AUDIO_SCREEN_SOURCE:"audio.html",CONTROLS_SCREEN_NAME:"controls",CONTROLS_SCREEN_SOURCE:"controls.html",ABOUT_SCREEN_NAME:"about",ABOUT_SCREEN_SOURCE:"about.html",ABOUT_SCREEN_CSS:"about.css",INGAME_MENU_SCREEN_NAME:"ingameMenu",INGAME_MENU_SCREEN_SOURCE:"ingame-menu.html",INGAME_MENU_SCREEN_CSS:"ingame-menu.css",INGAME_MENU_CONTAINER_ID:"menuContainer",DIALOG_SCREEN_NAME:"dialog",DIALOG_SCREEN_SOURCE:"dialog.html",DIALOG_SCREEN_CSS:"dialog.css"};return a.initAudio=function(t){var i,l;i=e.getSoundEffect(r.getSetting(r.GENERAL_SETTINGS.BUTTON_SELECT_SOUND).name),l=e.getSoundEffect(r.getSetting(r.GENERAL_SETTINGS.BUTTON_CLICK_SOUND).name),n.initMusic(r.getSetting(r.GENERAL_SETTINGS.MENU_MUSIC),a.MENU_THEME,!0),(i&&!i.isLoaded()&&!i.hasError()||l&&!l.isLoaded()&&!l.hasError())&&e.executeWhenReady(function(){o=i&&i.createSoundClip(e.SoundCategory.UI,r.getSetting(r.GENERAL_SETTINGS.BUTTON_SELECT_SOUND).volume),s=l&&l.createSoundClip(e.SoundCategory.UI,r.getSetting(r.GENERAL_SETTINGS.BUTTON_CLICK_SOUND).volume)}),e.requestResourceLoad(),t&&e.executeWhenReady(t)},a.playButtonSelectSound=function(t){o&&t&&o.play()},a.playButtonClickSound=function(t){s&&t&&s.play()},a.openDialog=function(e){t.getScreen(a.DIALOG_SCREEN_NAME).setup(e),t.setScreen(a.DIALOG_SCREEN_NAME,!0,a.SUPERIMPOSE_BACKGROUND_COLOR)},a.getSubParagraph=function(t){return'<p class="sub fadedText">'+t+"</p>"},a.BUTTON_EVENT_HANDLERS={".button":{mouseenter:function(){a.playButtonSelectSound(!this.classList.contains(i.DISABLED_CLASS_NAME))},click:function(){a.playButtonClickSound(!this.classList.contains(i.DISABLED_CLASS_NAME))}}},a.MENU_EVENT_HANDLERS={optionselect:a.playButtonSelectSound,optionclick:a.playButtonClickSound},a.MENU_STYLE={menuClassName:a.MENU_CLASS_NAME,buttonClassName:a.MENU_BUTTON_CLASS_NAME,buttonContainerClassName:a.MENU_BUTTON_CONTAINER_CLASS_NAME,selectedButtonClassName:i.SELECTED_CLASS_NAME,disabledClassName:i.DISABLED_CLASS_NAME},a}),define("armada/control",["modules/application","modules/control","modules/camera-controller","modules/game","modules/media-resources","armada/screens/shared","armada/strings","armada/configuration"],function(t,e,i,r,n,o,s,a){"use strict";function GeneralController(i){e.Controller.call(this,i),this._mission=null,this._battle=null,this.setActionFunction("quit",!0,function(){this._battle.pauseBattle(),r.setScreen(o.INGAME_MENU_SCREEN_NAME,!0,o.SUPERIMPOSE_BACKGROUND_COLOR)}.bind(this)),this.setActionFunction("pause",!0,function(){r.getScreen().showMessage(s.get(s.BATTLE.MESSAGE_PAUSED))}),this.setActionFunction("stopTime",!0,function(){this._battle.toggleTime()}.bind(this)),this.setActionFunction("switchToPilotMode",!0,function(){p.switchToPilotMode(this._mission.getPilotedSpacecraft())}.bind(this)),this.setActionFunction("switchToSpectatorMode",!0,function(){p.switchToSpectatorMode(!0,!0)}),t.isDebugVersion()&&this.setActionFunction("toggleHitboxVisibility",!0,function(){this._mission.toggleHitboxVisibility()}.bind(this)),this.setActionFunction("toggleDevInfoVisibility",!0,function(){r.getScreen().toggleDevInfoVisibility()}),this.setActionFunction("toggleHUDVisibility",!0,function(){this._battle.toggleHUDVisibility()}.bind(this)),this.setActionFunction("toggleMouseControls",!0,function(){p.getInputInterpreter(g).toggleEnabled(),p.isInPilotMode()&&(p.getInputInterpreter(g).isEnabled()?(document.body.style.cursor="none",p.enableMouseTurning()):document.body.style.cursor=r.getDefaultCursor())}),this.setActionFunction("toggleJoystickControls",!0,function(){p.getInputInterpreter(m).toggleEnabled()})}function FighterController(t){e.Controller.call(this,t),this._controlledSpacecraft=null,this._strafeSpeed=0,this._autoTargeting=!0,this._weaponAimThreshold=t.weaponAimThreshold,this.setActionFunction("fire",!0,function(t,e){this._controlledSpacecraft.fire(!1,t),e===d&&p.enableMouseTurning()}.bind(this)),this.setActionFunction("changeFlightMode",!0,function(){this._controlledSpacecraft.changeFlightMode()&&c&&c.play()}.bind(this)),this.setActionFunction("toggleCruise",!0,function(){this._controlledSpacecraft.toggleCruise()&&c&&c.play()}.bind(this)),this.setActionFunction("toggleFlightAssist",!0,function(){this._controlledSpacecraft.toggleFlightAssist()&&c&&c.play()}.bind(this)),this.setActionFunction("nextNearestHostileTarget",!0,function(){this._controlledSpacecraft.targetNextNearestHostile()?h.play():u.play()}.bind(this)),this.setActionFunction("previousNearestHostileTarget",!0,function(){this._controlledSpacecraft.targetPreviousNearestHostile()?h.play():u.play()}.bind(this)),this.setActionFunction("nextNearestNonHostileTarget",!0,function(){this._controlledSpacecraft.targetNextNearestNonHostile()?h.play():u.play()}.bind(this)),this.setActionFunction("toggleAutoTargeting",!0,function(){this._autoTargeting=!this._autoTargeting}.bind(this)),this.setActionFunctions("forward",function(t){this._controlledSpacecraft.forward(t)}.bind(this),function(){this._controlledSpacecraft.stopForward()}.bind(this)),this.setActionFunctions("reverse",function(t){this._controlledSpacecraft.reverse(t)}.bind(this),function(){this._controlledSpacecraft.stopReverse()}.bind(this)),this.setActionFunctions("strafeLeft",function(t){this._controlledSpacecraft.strafeLeft((void 0!==t?t:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopLeftStrafe()}.bind(this)),this.setActionFunctions("strafeRight",function(t){this._controlledSpacecraft.strafeRight((void 0!==t?t:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopRightStrafe()}.bind(this)),this.setActionFunctions("raise",function(t){this._controlledSpacecraft.raise((void 0!==t?t:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopRaise()}.bind(this)),this.setActionFunctions("lower",function(t){this._controlledSpacecraft.lower((void 0!==t?t:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopLower()}.bind(this)),this.setActionFunction("resetSpeed",!0,function(){this._controlledSpacecraft.resetSpeed()}.bind(this)),this.setActionFunction("yawLeft",!0,function(t,e){this._controlledSpacecraft.yawLeft(t),e!==d&&p.disableMouseTurning()}.bind(this)),this.setActionFunction("yawRight",!0,function(t,e){this._controlledSpacecraft.yawRight(t),e!==d&&p.disableMouseTurning()}.bind(this)),this.setActionFunction("pitchUp",!0,function(t,e){this._controlledSpacecraft.pitchUp(t),e!==d&&p.disableMouseTurning()}.bind(this)),this.setActionFunction("pitchDown",!0,function(t,e){this._controlledSpacecraft.pitchDown(t),e!==d&&p.disableMouseTurning()}.bind(this)),this.setActionFunction("rollLeft",!0,function(t){this._controlledSpacecraft.rollLeft(t)}.bind(this)),this.setActionFunction("rollRight",!0,function(t){this._controlledSpacecraft.rollRight(t)}.bind(this)),this.setActionFunction("jumpOut",!0,function(){this._controlledSpacecraft.jumpOut()}.bind(this))}function _initSound(t){return n.getSoundEffect(a.getHUDSetting(t).name).createSoundClip(n.SoundCategory.SOUND_EFFECT,a.getHUDSetting(t).volume)}function ArmadaControlContext(){e.ControlContext.call(this),this._pilotingMode=!1,this._mouseTurningDisabled=!1,this.registerInputInterpreterType(_,e.KeyboardInputInterpreter),this.registerInputInterpreterType(g,e.MouseInputInterpreter),this.registerInputInterpreterType(m,e.GamepadInputInterpreter),this.registerControllerType(S,GeneralController),this.registerControllerType(y,FighterController),this.registerControllerType(T,i.CameraController)}var l,h,u,c,p,d,_="keyboard",g="mouse",m="joystick",f=m,S="general",y="fighter",T="camera";return e.setModulePrefix("interstellarArmada_control_"),GeneralController.prototype=new e.Controller,GeneralController.prototype.constructor=GeneralController,GeneralController.prototype.getType=function(){return"general"},GeneralController.prototype.setMission=function(t){this._mission=t},GeneralController.prototype.setBattle=function(t){this._battle=t},FighterController.prototype=new e.Controller,FighterController.prototype.constructor=FighterController,FighterController.prototype.getType=function(){return"fighter"},FighterController.prototype.setControlledSpacecraft=function(t){this._controlledSpacecraft=t,this._controlledSpacecraft&&(this._strafeSpeed=l*this._controlledSpacecraft.getMaxAcceleration())},FighterController.prototype.executeActions=function(t,i){this._controlledSpacecraft&&(this._controlledSpacecraft.canBeReused()?this._controlledSpacecraft=null:(e.Controller.prototype.executeActions.call(this,t),this._autoTargeting&&!this._controlledSpacecraft.getTarget()&&this._controlledSpacecraft.targetNextBestHostile()&&h.play(),this._controlledSpacecraft.aimWeapons(this._weaponAimThreshold,0,i)))},ArmadaControlContext.prototype=new e.ControlContext,ArmadaControlContext.prototype.constructor=ArmadaControlContext,ArmadaControlContext.prototype.isInPilotMode=function(){return this._pilotingMode},ArmadaControlContext.prototype.switchToPilotMode=function(t){t&&t.isAlive()&&!this._pilotingMode&&(this._pilotingMode=!0,h=_initSound(a.BATTLE_SETTINGS.HUD.TARGET_SWITCH_SOUND),u=_initSound(a.BATTLE_SETTINGS.HUD.TARGET_SWITCH_DENIED_SOUND),c=_initSound(a.BATTLE_SETTINGS.HUD.FLIGHT_MODE_SWITCH_SOUND),this.getController(y).setControlledSpacecraft(t),this.getController(T).setCameraToFollowObject(t._visualModel,a.getSetting(a.BATTLE_SETTINGS.CAMERA_PILOTING_SWITCH_TRANSITION_DURATION),a.getSetting(a.BATTLE_SETTINGS.CAMERA_PILOTING_SWITCH_TRANSITION_STYLE)),this.disableAction("followNext"),this.disableAction("followPrevious"),r.getScreen().setHeaderContent(""),this.getInputInterpreter(g).isEnabled()&&(document.body.style.cursor="none"))},ArmadaControlContext.prototype.switchToSpectatorMode=function(t,e){(this._pilotingMode||e)&&(this._pilotingMode=!1,
this.getController(y).setControlledSpacecraft(null),t&&this.getController(T).setToFreeCamera(!1),this.enableAction("followNext"),this.enableAction("followPrevious"),r.getScreen().setHeaderContent(s.get(s.BATTLE.SPECTATOR_MODE)),document.body.style.cursor=r.getDefaultCursor())},ArmadaControlContext.prototype.disableMouseTurning=function(){this._mouseTurningDisabled||(d.disableAction("yawLeft"),d.disableAction("yawRight"),d.disableAction("pitchUp"),d.disableAction("pitchDown"),d.disableAction("rollLeft"),d.disableAction("rollRight"),this._mouseTurningDisabled=!0)},ArmadaControlContext.prototype.enableMouseTurning=function(){this._mouseTurningDisabled&&(d.enableAction("yawLeft"),d.enableAction("yawRight"),d.enableAction("pitchUp"),d.enableAction("pitchDown"),d.enableAction("rollLeft"),d.enableAction("rollRight"),this._mouseTurningDisabled=!1)},ArmadaControlContext.prototype.isMouseTurningDisabled=function(){return this._mouseTurningDisabled},p=new ArmadaControlContext,p.executeWhenReady(function(){d=p.getInputInterpreter(g)}),a.executeWhenReady(function(){l=a.getSetting(a.BATTLE_SETTINGS.STRAFE_SPEED_FACTOR)}),{KEYBOARD_NAME:_,MOUSE_NAME:g,JOYSTICK_NAME:m,GAMEPAD_NAME:f,GENERAL_CONTROLLER_NAME:S,FIGHTER_CONTROLLER_NAME:y,CAMERA_CONTROLLER_NAME:T,KeyBinding:e.KeyBinding,loadConfigurationFromJSON:p.loadConfigurationFromJSON.bind(p),loadSettingsFromJSON:p.loadSettingsFromJSON.bind(p),loadSettingsFromLocalStorage:p.loadSettingsFromLocalStorage.bind(p),restoreDefaults:p.restoreDefaults.bind(p),getControllers:p.getControllers.bind(p),getController:p.getController.bind(p),isControllerPriority:p.isControllerPriority.bind(p),getInputInterpreters:p.getInputInterpreters.bind(p),getInputInterpreter:p.getInputInterpreter.bind(p),control:p.control.bind(p),startListening:p.startListening.bind(p),stopListening:p.stopListening.bind(p),isListening:p.isListening.bind(p),setScreenCenter:p.setScreenCenter.bind(p),executeWhenReady:p.executeWhenReady.bind(p),isInPilotMode:p.isInPilotMode.bind(p),switchToPilotMode:p.switchToPilotMode.bind(p),switchToSpectatorMode:p.switchToSpectatorMode.bind(p),isMouseTurningDisabled:p.isMouseTurningDisabled.bind(p)}}),define("armada/armada",["modules/game","modules/components","armada/constants","armada/graphics","armada/audio","armada/configuration","armada/logic/environments","armada/logic/missions","armada/control","armada/strings"],function(t,e,i,r,n,o,s,a,l,h){"use strict";var u=document.getElementById("splashProgress");return u.max=6,t.setGameName(i.GAME_NAME),t.setStartScreenName("mainMenu"),t.setConfigFolder("config/"),t.setConfigFileName("config.json"),t.setFileCacheBypassEnabled(0),t.setPreviouslyRunVersion(localStorage[i.VERSION_LOCAL_STORAGE_ID]),t._loadGameSettingsAndExecuteCallback=function(t,e){r.loadSettingsFromJSON(t.graphics),r.loadSettingsFromLocalStorage(),n.loadSettingsFromJSON(t.audio),n.loadSettingsFromLocalStorage(),o.loadSettingsFromJSON(t.logic),l.loadSettingsFromJSON(t.control),l.loadSettingsFromLocalStorage(),a.loadSettingsFromLocalStorage(),o.executeWhenReady(function(){s.requestLoad(),s.executeWhenReady(function(){u.value=2,a.requestLoad(),a.executeWhenReady(function(){u.value=3,e()})})})},t._loadGameConfigurationAndExecuteCallback=function(t,e){o.loadConfigurationFromJSON(t.dataFiles.logic),r.loadConfigurationFromJSON(t.graphics),n.loadConfigurationFromJSON(t.audio),a.loadConfigurationFromJSON(t.logic),l.loadConfigurationFromJSON(t.control),u.value=1,e()},t._buildScreensAndExecuteCallback=function(r){requirejs(["armada/screens/shared","armada/screens/menus","armada/screens/missions","armada/screens/battle","armada/screens/debriefing","armada/screens/database","armada/screens/general-settings","armada/screens/graphics-settings","armada/screens/audio-settings","armada/screens/control-settings","armada/screens/about","armada/screens/dialog"],function(n,o,s,a,l,c,p,d,_,g,m,f){t.addScreen(o.mainMenuScreen),t.addScreen(s.missionsScreen),t.addScreen(a.battleScreen),t.addScreen(l.debriefingScreen),t.addScreen(c.databaseScreen),t.addScreen(o.settingsMenuScreen),t.addScreen(p.generalSettingsScreen),t.addScreen(d.graphicsScreen),t.addScreen(_.audioScreen),t.addScreen(g.controlsScreen),t.addScreen(m.aboutScreen),t.addScreen(o.ingameMenuScreen),t.addScreen(f.dialogScreen),u.value=4,t.executeWhenAllScreensReady(function(){u.value=5,t.requestLanguageChange(localStorage.getItem(i.LANGUAGE_LOCAL_STORAGE_ID)||t.getDefaultLanguage(),h,function(){u.value=6,e.clearStoredDOMModels(),localStorage[i.VERSION_LOCAL_STORAGE_ID]=t.getVersion(),n.initAudio(r)})})})},t}),requirejs(["armada/armada"],function(t){"use strict";t.initialize({electron:!1})}),define("main",function(){});