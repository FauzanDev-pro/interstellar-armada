define("modules/application",[],function(){"use strict";var t,e,i={CRITICAL:"critical",SEVERE:"severe",MINOR:"minor"},n="text/plain; charset=utf-8",o=null,r=!0,s=0,a="",h=!0;return{ErrorSeverity:i,getFolder:function(t){return t.length>0&&"/"===t[t.length-1]?t:o?void 0!==o[t]?o[t]:(this.showError("Asked for folder for file type '"+t+"', and folder for such files is not registered!",i.SEVERE),null):(this.log("Looking for the folder assigned to file type '"+t+"', but there are no folders specified in the application configuration. Will use the folder with the same name as the file type."),t+"/")},setFolders:function(t){var e="",n=function(e,o,r){var s=-1,a=-1,h="",l="";for(r=r||[];e.indexOf("{{")>=0;){if(!(e.indexOf("}}")>=0))return this.showError("Invalid folder name specified! Cannot resolve: '"+e+"'",i.SEVERE,"References to other folders must be surrounded by {{ and }}."),null;if(s=e.indexOf("{{"),a=e.indexOf("}}"),l=e.substring(s+2,a),h=t[l],!h)return this.showError("Invalid folder name specified! Cannot find referenced folder '"+e.substring(s+2,a)+"' in "+e+"!",i.SEVERE),null;if(!(r.indexOf(l)<0))return this.showError("Circular reference detected among the following folders: "+r.concat(o).join(", "),i.SEVERE),null;e=e.replace(e.substring(s,Math.min(a+3,e.length)),n(h,l,r.concat(o)))}return e}.bind(this);o={};for(e in t)t.hasOwnProperty(e)&&(o[e]=n(t[e],e))},setFileCacheBypassEnabled:function(t){r=t},setLogVerbosity:function(t){s=t},getVersion:function(){return a},getVersionURLArg:function(){return"v="+this.getVersion().split(" ")[0]},setVersion:function(t){a=t,require.config({urlArgs:this.getVersionURLArg()})},setPreviouslyRunVersion:function(i){t=i,e=void 0===t},isFirstRun:function(){return e},hasVersionChanged:function(){return void 0!==e?t!==a:void this.showError("Cannot determine whether the game version has changed, because the previously ran version is not set!")},isDebugVersion:function(){return h},setDebugVersion:function(t){h=t},getFileURL:function(t,e){return this.getFolder(t)+(e+(r||!this.getVersion()?"?t="+performance.now():"?"+this.getVersionURLArg()))},showError:function(t,e,n){var o="Error: "+t+(n?"\n\n"+n+"\n\n":"\n\n");switch(e){case i.CRITICAL:o+="Unfortunately this is a critical error.\nThe application is not functional until this error is resolved.";break;case i.SEVERE:o+="This is a severe error.\nThe application might produce unexpected behaviour from this point on. It is recommended that you restart the application by refreshing the page in your browser.";break;case i.MINOR:o+="This is a minor error.\nThe application might be fully functional, but you might need to readjust some settings or take some other actions depending on the explanation of the error.";break;default:o+="The severity of this error cannot be determined.\nThe application might produce unexpected behaviour from this point on. It is recommended that you restart the application by refreshing the page in your browser."}alert(o)},log:function(t,e){(!e||s>=e)&&console.log(t)},requestFile:function(t,e,n,o){this.log("Requesting file: '"+e+"' from "+(""!==this.getFolder(t)?"folder: '"+this.getFolder(t):"root folder")+"'...",2);var r=new XMLHttpRequest;r.onload=function(){this.log("File: '"+e+"' successfully loaded.",2),n(r)}.bind(this),r.onerror=function(){this.showError("An error occured while trying to load file: '"+e+"'.",i.SEVERE,"The status of the request was: '"+r.statusText+"' when the error happened.")}.bind(this),r.ontimeout=function(){this.showError("Request to load the file: '"+e+"' timed out.",i.SEVERE)}.bind(this),o&&r.overrideMimeType(o),r.open("GET",this.getFileURL(t,e),!0),r.send(null)},requestTextFile:function(t,e,i,o){this.requestFile(t,e,function(t){i(t.responseText)},o||n)},requestXMLFile:function(t,e,n){this.requestFile(t,e,function(t){var o=null===t.responseXML?(new DOMParser).parseFromString(t.responseText,"application/xml"):t.responseXML;"parsererror"!==o.documentElement.nodeName?n(o):this.showError("Could not parse XML file: '"+e+"'.",i.SEVERE,"The file could be loaded, but for some reason the parsing of it has failed. \nThe status of the request was: '"+t.statusText+"' when the error happened.\nThe text content of the file:\n"+(t.responseText.length>120?t.responseText.slice(0,120)+"...":t.responseText))}.bind(this),"application/xml")},requestCSSFile:function(t,e,i){var n;0===document.head.querySelectorAll("link[href='"+this.getFileURL(t,e)+"']").length?(n=document.createElement("link"),n.setAttribute("rel","stylesheet"),n.setAttribute("type","text/css"),n.onload=i,n.href=this.getFileURL(t,e),document.head.appendChild(n)):i&&i()}}}),define("modules/async-resource",[],function(){"use strict";function t(){this._readyToUse=!1,this._onReadyQueue=[]}return t.prototype.addOnReadyFunction=function(t){this._onReadyQueue.push(t)},t.prototype.isReadyToUse=function(){return this._readyToUse},t.prototype.resetReadyState=function(){this._readyToUse=!1},t.prototype.resetResource=function(){this._readyToUse=!1,this._onReadyQueue=[]},t.prototype.executeOnReadyQueue=function(){var t;for(t=0;t<this._onReadyQueue.length;t++)this._onReadyQueue[t].call(this);this._onReadyQueue=[]},t.prototype.setToReady=function(){this._readyToUse===!1&&(this._readyToUse=!0,this.executeOnReadyQueue())},t.prototype.executeWhenReady=function(t,e,i){return this._readyToUse?i?(setTimeout(t.bind(this),0),!1):(t.call(this),!0):(this.addOnReadyFunction(t),void 0!==e&&e.call(this),!1)},{AsyncResource:t}}),define("modules/screen-manager",["modules/async-resource"],function(t){"use strict";function e(){t.AsyncResource.call(this),this._screens={},this._coveredScreens=[],this._currentScreen=null,this._screensLoaded=0,this._screensToLoad=0}var i;return e.prototype=new t.AsyncResource,e.prototype.constructor=e,e.prototype.getCurrentScreen=function(){return this._currentScreen},e.prototype.getScreen=function(t){return t?this._screens[t]:this.getCurrentScreen()},e.prototype.addScreen=function(t,e,i){var n,o=function(){this._screensLoaded++,this._screensLoaded===this._screensToLoad&&this.setToReady()}.bind(this);if(e===!0)for(n in this._screens)this._screens.hasOwnProperty(n)&&this._screens[n].removeFromPage();this._screensToLoad++,this._screens[t.getName()]=t,e===!0?t.replacePageWithScreen(o):t.addScreenToPage(o,i)},e.prototype.setCurrentScreen=function(t,e,i){var n,o;if(e!==!0&&null!==this._currentScreen)for(this._currentScreen.hide(),n=0;n<this._coveredScreens.length;n++)this._coveredScreens[n].hide();o=this.getScreen(t),e===!0?(this._coveredScreens.push(this._currentScreen),o.superimposeOnPage(i)):o.show(),this._currentScreen=o},e.prototype.closeSuperimposedScreen=function(){this._currentScreen.hide(),this._currentScreen=this._coveredScreens.pop()},e.prototype.closeOrNavitageTo=function(t){this.getCurrentScreen().isSuperimposed()?this.closeSuperimposedScreen():this.setCurrentScreen(t)},e.prototype.updateAllScreens=function(){var t;for(t in this._screens)this._screens.hasOwnProperty(t)&&this._screens[t].updateScreen()},i=new e,{getCurrentScreen:i.getCurrentScreen.bind(i),getScreen:i.getScreen.bind(i),addScreen:i.addScreen.bind(i),setCurrentScreen:i.setCurrentScreen.bind(i),closeSuperimposedScreen:i.closeSuperimposedScreen.bind(i),closeOrNavitageTo:i.closeOrNavitageTo.bind(i),updateAllScreens:i.updateAllScreens.bind(i),executeWhenReady:i.executeWhenReady.bind(i)}}),define("utils/utils",[],function(){"use strict";var t={WIDTH:"width",HEIGHT:"height",ASPECT:"aspect",MINIMUM:"minimum",MAXIMUM:"maximum"},e=[],i=" ",n={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,"caps lock":20,escape:27,space:32,"page up":33,"page down":34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,"delete":46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,"left window":91,"right window":92,select:93,"numpad 0":96,"numpad 1":97,"numpad 2":98,"numpad 3":99,"numpad 4":100,"numpad 5":101,"numpad 6":102,"numpad 7":103,"numpad 8":104,"numpad 9":105,"*":106,"numpad +":107,"numpad -":109,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,"-":173,",":188,".":190},o={};return o.EMPTY_ARRAY=e,o.ScaleMode=t,o.scalesWithWidth=function(e,i,n){return e===t.WIDTH||e===t.MINIMUM&&n>i||e===t.MAXIMUM&&i>=n},o.xScalesWithWidth=function(e,i,n){return e===t.ASPECT||e===t.WIDTH||e===t.MINIMUM&&n>i||e===t.MAXIMUM&&i>=n},o.yScalesWithHeight=function(e,i,n){return e===t.ASPECT||e===t.HEIGHT||e===t.MINIMUM&&i>n||e===t.MAXIMUM&&n>=i},o.getRGBColorFromXMLTag=function(t){return[parseFloat(t.getAttribute("r")),parseFloat(t.getAttribute("g")),parseFloat(t.getAttribute("b"))]},o.getDimensionsFromXMLTag=function(t){return[parseFloat(t.getAttribute("w")),parseFloat(t.getAttribute("h")),parseFloat(t.getAttribute("d"))]},o.evaluateProduct=function(t){var e,i,n;for(e=t.split("*"),i=1,n=0;n<e.length;n++)i*=parseFloat(e[n]);return i},o.getFirstXMLElement=function(t,e){var i=t.getElementsByTagName(e);return i.length>0?i[0]:null},o.getKeyCodeOf=function(t){return t?"#"===t[0]?parseInt(t.slice(1),10):n[t]:-1},o.getKeyOfCode=function(t){var e;for(e in n)if(n[e]===t)return e;return"#"+t},o.arraysEqual=function(t,e){var i,n;if(!e)return!1;if(t.length!==e.length)return!1;for(i=0,n=t.length;n>i;i++)if(t[i]instanceof Array&&e[i]instanceof Array){if(!t[i].equals(e[i]))return!1}else if(t[i]!==e[i])return!1;return!0},o.objectsEqual=function(t,e){var i,n,o;if(null===t&&null===e)return!0;if(!t)return!1;if(i=Object.keys(t),!e)return!1;if(n=Object.keys(e),i.length!==n.length)return!1;for(o=0;o<i.length;o++)if(i[o]!==n[o]||t[i[o]]!==e[n[o]])return!1;return!0},o.getSafeEnumValue=function(t,e,i){var n;i=i?o.getSafeEnumValue(t,i):null;for(n in t)if(t.hasOwnProperty(n)&&e===t[n])return e;return i||null},o.getEnumValues=function(t){var e,i=[];for(e in t)t.hasOwnProperty(e)&&i.push(t[e]);return i},o.getKeyOfValue=function(t,e){var i;for(i in t)if(t.hasOwnProperty(i)&&t[i]===e)return i;return null},o.getPaddedStringForNumber=function(t,e){var i,n=t.toString();for(i=n.length;e>i;i++)n="0"+n;return n},o.getDelimitedStringForNumber=function(t){return t>=1e3?o.getDelimitedStringForNumber(Math.floor(t/1e3))+i+o.getPaddedStringForNumber(t%1e3,3):t.toString()},o.getLengthString=function(t){return 2e3>t?100>t?t.toPrecision(3)+" m":Math.round(t)+" m":1e5>t?(t/1e3).toPrecision(3)+" km":o.getDelimitedStringForNumber(Math.round(t/1e3))+" km"},o.getMassString=function(t){return 2e3>t?100>t?t.toPrecision(3)+" kg":Math.round(t)+" kg":1e5>t?(t/1e3).toPrecision(3)+" t":o.getDelimitedStringForNumber(Math.round(t/1e3))+" t"},o.constantName=function(t){var e,i="";for(e=0;e<t.length;e++)t[e].match(/[A-Z]/)&&(i+="_"),i+=" "===t[e]?"_":t[e].toUpperCase();return i},o.formatString=function(t,e){var i,n=t.toString();for(i in e)e.hasOwnProperty(i)&&(n=n.replace(new RegExp("\\{"+i+"\\}","gi"),e[i]));return n},o.executeAsync=function(t){setTimeout(t,0)},o.pointInRect=function(t,e,i,n,o,r){return t>=i&&o>=t&&e>=n&&r>=e},o.getFilenameWithoutExtension=function(t){var e=t.lastIndexOf(".");return e>0?t.substr(0,e):t},o.getMixedColor=function(t,e,i){var n=1-i;return[t[0]*n+e[0]*i,t[1]*n+e[1]*i,t[2]*n+e[2]*i,t[3]*n+e[3]*i]},o.getCSSColor=function(t){return"rgba("+Math.round(255*t[0])+","+Math.round(255*t[1])+","+Math.round(255*t[2])+","+t[3]+")"},o.getGreaterSolutionOfQuadraticEquation=function(t,e,i){var n=e*e-4*t*i;return n>=0?(Math.sqrt(n)-e)/(2*t):NaN},o}),define("utils/types",["utils/utils","modules/application"],function(t,e){"use strict";function i(t,e,i,n){return"Invalid value for '"+t+"' ("+e+")"+(n?": "+n:".")+" Using default value "+i+" instead."}function n(t,n,o,r){e.showError(i(t,n,o,r))}function o(t,n,o,r,s){e.log(i(t,n,o,r),void 0!==s?s:_)}function r(t,e,i,n){return"Invalid value for '"+e+"'. Expected "+t+", got a(n) "+("object"==typeof i?i.constructor.name:typeof i)+" ("+i+"). Using default value "+(n instanceof Array?"["+n.join(", ")+"]":"'"+n+"'")+" instead."}function s(t,i,n,o){e.showError(r(t,i,n,o))}function a(t,i,n,o,s){e.log(r(t,i,n,o),void 0!==s?s:_)}function h(e,i,n,o){return"Unrecognized '"+e+"' value: '"+i+"'. Possible values are are: "+t.getEnumValues(n).join(", ")+". Default value '"+o+"' will be used instead."}function l(t,i,n,o){e.showError(h(t,i,n,o))}function u(t,i,n,o,r){e.log(h(t,i,n,o),void 0!==r?r:_)}var c={CHECK_FAIL_ERROR:"checkFailError",TYPE_ERROR:"typeError",ENUM_VALUE_ERROR:"enumValueError",INVALID_ENUM_OBJECT_ERROR:"invalidEnumObjectError"},_=1,p={Errors:c};return p.NUMBER="number",p.VECTOR2={baseType:"array",length:2,elementType:"number"},p.VECTOR3={baseType:"array",length:3,elementType:"number"},p.COLOR3={baseType:"array",length:3,elementType:"number",elementTypeParams:{range:[0,1]}},p.COLOR4={baseType:"array",length:4,elementType:"number",elementTypeParams:{range:[0,1]}},p.DURATION={baseType:"number",range:[0,void 0]},p.ANGLE_DEGREES={baseType:"number",range:[-360,360]},p.getBooleanValue=function(t,e){if(e=e||{},e.name=e.name||"unnamed boolean","boolean"==typeof t){if(!e.checkFunction||e.checkFunction(t,e.parentObject))return t;e.error=c.CHECK_FAIL_ERROR,e.silentFallback?o(e.name,t,e.defaultValue,e.checkFailMessage):n(e.name,t,e.defaultValue,e.checkFailMessage)}else e.error=c.TYPE_ERROR,e.silentFallback?a("a boolean",e.name,t,e.defaultValue):s("a boolean",e.name,t,e.defaultValue);return null!==e.defaultValue?(t=e.defaultValue,e.defaultValue=null,p.getBooleanValue(t,e)):null},p.getNumberValue=function(t,e,i,o,r,a){return"number"==typeof e?o&&!o(e,a)?(n(t,e,i,r),null!==i?p.getNumberValue(t,i,null,o,r,a):null):e:(s("a number",t,e,i),null!==i?p.getNumberValue(t,i,null,o,r,a):null)},p.getNumberValueInRange=function(t,i,o,r,a,h,l,u){return"number"==typeof i?((void 0!==o&&o>i||void 0!==r&&i>r)&&(e.showError("Invalid value for "+t+": out of range ("+(void 0!==o?o:"...")+"-"+(void 0!==r?r:"...")+"). The setting will be changed to fit the valid range."),void 0!==o&&(i=Math.max(o,i)),void 0!==r&&(i=Math.min(i,r))),h&&!h(i,u)?(n(t,i,a,l),null!==a?p.getNumberValueInRange(t,a,o,r,null,h,l,u):null):i):(s("a number",t,i,a),null!==a?p.getNumberValueInRange(t,a,o,r,null,h,l,u):null)},p.getStringValue=function(t,e,i,o,r,a){return"string"==typeof e?o&&!o(e,a)?(n(t,e,i,r),null!==i?p.getStringValue(t,i,null,o,r,a):null):e:(s("a string",t,e,i),null!==i?p.getStringValue(t,i,null,o,r,a):null)},p.getEnumValue=function(i,r,s){var a=t.getSafeEnumValue(i,r);if(s=s||{},s.name=s.name||"unnamed enum "+i.constructor.name,null!==a){if(!s.checkFunction||s.checkFunction(a,s.parentObject))return a;s.error=c.CHECK_FAIL_ERROR,s.silentFallback?o(s.name,a,s.defaultValue,s.checkFailMessage):n(s.name,a,s.defaultValue,s.checkFailMessage)}else{if("object"!=typeof i||0===Object.keys(i).length)return s.error=c.INVALID_ENUM_OBJECT_ERROR,e.showError("Invalid enum object specified for "+s.name+": "+i+", and thus its value ("+r+") cannot be verified!"),null;s.error=c.ENUM_VALUE_ERROR,s.silentFallback?u(s.name,r,i,s.defaultValue):l(s.name,r,i,s.defaultValue)}return null!==s.defaultValue?(r=s.defaultValue,s.defaultValue=null,p.getEnumValue(i,r,s)):null},p.getObjectValue=function(t,e,i,o,r,a){return"object"==typeof e?o&&!o(e,a)?(n(t,e,i,r),null!==i?p.getObjectValue(t,i,null,o,r,a):null):e:(s("an object",t,e,i),null!==i?p.getObjectValue(t,i,null,o,r,a):null)},p.getValueOfType=function(t,i,n,o,r,s,a,h,l){if(s=s||{},void 0===n)return void 0!==o?null!==o?p.getValueOfType(t,i,o,null,r,s,a,h,l):null:void(r||e.showError("Missing required value of '"+t+"'!"));if("object"==typeof i)return p.getValueOfType(t,i.baseType,n,o,r,i,a,h,l);switch(i){case"boolean":return p.getBooleanValue(n,{name:t,defaultValue:o,checkFunction:a,checkFailMessage:h,parentObject:l});case"number":return s.range?p.getNumberValueInRange(t,n,s.range[0],s.range[1],o,a,h,l):p.getNumberValue(t,n,o,a,h,l);case"string":return p.getStringValue(t,n,o,a,h,l);case"enum":return s.values?p.getEnumValue(s.values,n,{name:t,defaultValue:o,checkFunction:a,checkFailMessage:h,parentObject:l}):(e.showError("Missing enum definition object for '"+t+"'!"),null);case"object":return s.properties?p.getVerifiedObject(t,n,s.properties):p.getObjectValue(t,n,o,a,h,l);case"array":return p.getArrayValue(t,n,s.elementType,s.elementTypeParams,s,o,a,h,s.elementCheck,s.elementCheckFailMessage,l);default:return e.showError("Unknown type specified for '"+t+"': "+i),null}},p.getArrayValue=function(t,i,o,r,a,h,l,u,c,_,d){var g,f=[];if(i instanceof Array){if(void 0!==a){if(void 0!==a.length&&i.length!==a.length)return e.showError("Invalid array length for '"+t+"'! Expected a length of "+a.length+" and got "+i.length+(h?". Using default value ["+h.join(", ")+"] instead.":".")),h?p.getArrayValue(t,h,o,r,a,null,l,u,c,_,d):null;if(void 0!==a.minLength&&i.length<a.minLength)return e.showError("Invalid array length for '"+t+"'! Expected a minimum length of "+a.minLength+" and got "+i.length+(h?". Using default value ["+h.join(", ")+"] instead.":".")),h?p.getArrayValue(t,h,o,r,a,null,l,u,c,_,d):null;if(void 0!==a.maxLength&&i.length>a.maxLength)return e.showError("Invalid array length for '"+t+"'! Expected a maximum length of "+a.maxLength+" and got "+i.length+(h?". Using default value ["+h.join(", ")+"] instead.":".")),h?p.getArrayValue(t,h,o,r,a,null,l,u,c,_,d):null}return void 0!==o&&(i.forEach(function(e,i){g=p.getValueOfType(t+"["+i+"]",o,e,null,!1,r,c,_,d),null!==g&&f.push(g)}),i=f),l&&!l(i)?(n(t,i,"["+h.join(", ")+"]",u),null!==h?p.getArrayValue(t,h,o,r,a,null,l,u,c,_,d):null):i}return s("an array",t,i,h),null!==h?p.getArrayValue(t,h,o,r,a,null,l,u,c,_,d):null},p.getVerifiedObject=function(t,i,n,o,r,s,a){var h,l,u,c=o||{},_=[];if("object"==typeof i){for(l in n)n.hasOwnProperty(l)&&(u=n[l],c[u.name]&&e.showError("'"+t+"' already has a property named '"+u.name+"', which will be overridden by a new value!"),c[u.name]=p.getValueOfType(t+"."+u.name,u.type||a,i[u.name],u.defaultValue,u.optional,{range:u.range,values:u.values,elementType:u.elementType,elementEnumObject:u.elementEnum,length:u.length,minLength:u.minLength,maxLength:u.maxLength,elementCheck:u.elementCheck,elementCheckFailMessage:u.elementCheckFailMessage,properties:u.properties},u.check,u.checkFailMessage,i),_.push(u.name));if(!s||r)for(h in i)i.hasOwnProperty(h)&&_.indexOf(h)<0&&(s||e.showError("Unrecognized property '"+h+"' defined for '"+t+"'. The value of this property "+(a?"can be verified only against the default property type":"cannot be verified ")+(r?"but will be included.":"and will be discarded.")),r&&(a?c[h]=p.getValueOfType(t+"."+h,a,i[h]):c[h]=i[h]));return c}return e.showError("Invalid value for '"+t+"'. Expected an object, got a(n) "+typeof i+" ("+i+")."),null},p.getBooleanValueFromLocalStorage=function(t,e){var i;return i=localStorage[t]===(!0).toString()?!0:localStorage[t]===(!1).toString()?!1:localStorage[t],e=e||{},e.name=e.name||"localStorage."+t,p.getBooleanValue(i,e)},p.getEnumValueFromLocalStorage=function(t,e,i){return i=i||{},i.name=i.name||"localStorage."+e,p.getEnumValue(t,localStorage[e],i)},p.getValueOfTypeFromLocalStorage=function(t,i,n){if("object"==typeof t)return n.values=t.values,p.getValueOfTypeFromLocalStorage(t.baseType,i,n);switch(t){case"boolean":return p.getBooleanValueFromLocalStorage(i,n);case"enum":return p.getEnumValueFromLocalStorage(n.values,i,n);default:e.crash()}},p.getNameAndValueDefinitionObject=function(t){return{baseType:"object",properties:{NAME:{name:"name",type:"string"},VALUE:{name:t,type:"number"}}}},p.getEnumObjectForArray=function(t){var e,i={};for(e=0;e<t.length;e++)i[t[e]]=t[e];return i},p}),define("modules/strings",["utils/types","modules/application"],function(t,e){"use strict";function i(t){var e,o;for(e in t)if(t.hasOwnProperty(e)&&"object"==typeof t[e]){i(t[e]);for(o in t[e])t[e].hasOwnProperty(o)&&(t[e+n+o]=t[e][o]);delete t[e]}}var n=".",o={},r=null,s={},a={};return o.getLanguage=function(){return r},o.setLanguage=function(t){a.hasOwnProperty(t)?r=t:e.showError("Cannot set language to '"+t+"', as there are no strings loaded for that language!")},o.languageIsLoaded=function(t){return a.hasOwnProperty(t)},o.loadStrings=function(e,n,h){var l;s[e]={},i(n);for(l in h)h.hasOwnProperty(l)&&"object"==typeof h[l]&&t.getVerifiedObject("strings."+l,n,h[l],s[e],!1,!0,"string");a[e]=t.getVerifiedObject("strings."+l,n,{},null,!0,!0,"string"),r||o.setLanguage(e)},o.get=function(t,e,i){return a[r]&&a[r][t.name+(e||"")]||i||t.defaultValue||t.name+(e||"")},o.has=function(t,e){return a[r]&&void 0!==a[r][t.name+(e||"")]},o.CATEGORY_SEPARATOR=n,o}),define("modules/game",["modules/application","modules/screen-manager","modules/strings"],function(t,e,i){"use strict";var n=!1,o=!1,r=!1,s=null,a=null,h=null,l=null,u=null,c=null,_=function(){n&&o&&r&&(t.log("Initialization of "+s+" completed."),document.body.firstElementChild.style.display="none",e.setCurrentScreen(a))},p=function(){t._buildScreensAndExecuteCallback(function(){r=!0,_()})},d=function(e){t.requestTextFile(e.folder,e.filename,function(e){var i=JSON.parse(e);t.log("Loading game settings...",1),t._loadGameSettingsAndExecuteCallback(i,function(){t.log("Game settings loaded.",1),o=!0,p()})})},g=function(){t.requestTextFile(h,l,function(e){var i=JSON.parse(e);t.log("Loading game configuration..."),t.setFolders(i.folders),t.setLogVerbosity(i.logVerbosity),t.setVersion(i.version),t.setDebugVersion(i.debugVersion),t.log("Game version is: "+t.getVersion(),1),u=i.defaultLanguage,c=i.configFiles.strings,require(["modules/graphics-resources"],function(e){t._loadGameConfigurationAndExecuteCallback(i,function(){e.requestConfigLoad(i.dataFiles.graphics.resources,function(){t.log("Game configuration loaded."),n=!0}),d(i.configFiles.settings)})})})};return t._loadGameSettingsAndExecuteCallback=function(){t.showError("You need to override the _loadGameSettings method!")},t._loadGameConfigurationAndExecuteCallback=function(){t.showError("You need to override the _loadGameConfiguration method!")},t._buildScreensAndExecuteCallback=function(){t.showError("You need to override the _buildScreensAndExecuteCallback method!")},t.setGameName=function(t){s=t},t.setStartScreenName=function(t){a=t},t.setConfigFolder=function(t){h=t},t.setConfigFileName=function(t){l=t},t.getDefaultLanguage=function(){return u},t.getLanguage=function(){return i.getLanguage()||u},t.getLanguages=function(){return Object.keys(c)},t.requestLanguageChange=function(n,o,r){return c&&c[n]?(i.languageIsLoaded(n)?(i.setLanguage(n),e.updateAllScreens(),r(!1)):t.requestTextFile(c[n].folder,c[n].filename,function(t){i.loadStrings(n,JSON.parse(t),o),i.setLanguage(n),e.updateAllScreens(),r(!0)}),!0):(t.showError("Cannot change application language to '"+n+"' as there is no strings file set for this langauge!"),!1)},t.initialize=function(){return t.log("Initializing "+s+"..."),"file:"===location.protocol?void this.showError("Trying to run the game from the local filesystem!",t.ErrorSeverity.CRITICAL,"This application can only be run through a web server. If you wish to run it from your own computer, you have to install, set up and start a web server first. You have to put the folder containing the files of this game (assume it is called 'game') to the HTML serving folder of the web server, then you can start the game by entering 'localhost/game' in your browser's address bar."):void g()},t.getScreen=e.getScreen,t.setScreen=e.setCurrentScreen,t.addScreen=e.addScreen,t.closeSuperimposedScreen=e.closeSuperimposedScreen,t.closeOrNavigateTo=e.closeOrNavitageTo,t.updateAllScreens=e.updateAllScreens,t.executeWhenAllScreensReady=e.executeWhenReady,t}),define("modules/components",["utils/utils","modules/application","modules/async-resource","modules/strings"],function(t,e,i,n){"use strict";function o(t){return C[t]&&!!C[t].model}function r(t){return C[t]&&C[t].model}function s(t){return C[t]&&C[t].requested}function a(t,i){s(t)?o(t)?i&&i():C[t].onLoadQueue.push(i):(C[t]={},C[t].requested=!0,C[t].onLoadQueue=[i],e.requestTextFile(m,t,function(e){var i;for(C[t].model=document.implementation.createHTMLDocument(),C[t].model.documentElement.innerHTML=e,i=0;i<C[t].onLoadQueue.length;i++)C[t].onLoadQueue[i]()}))}function h(t){return t.caption||n.get({name:t.id})}function l(){C={}}function u(t,e){this._name=t,this._elementID=e||t,this._element=null,this._displayStyle=null}function c(t,e,n){i.AsyncResource.call(this),this._name=t,this._rootElementID=t,this._htmlFilename=e,this._style=n||{},this._rootElement=null,this._rootElementDefaultDisplayMode=null,this._cssLoaded=!1,this._simpleComponents=[],e&&this.requestModelLoad()}function _(t,e,i,n){c.call(this,t,e,i),this._progress=this.registerSimpleComponent(T),this._status=this.registerSimpleComponent(S),this._header=this.registerSimpleComponent(M),this._headerID=n}function p(t,e,i,n,o,r,s){c.call(this,t,e,i),this._message=this.registerSimpleComponent(x),this._okButton=this.registerSimpleComponent(E),this._header=this.registerSimpleComponent(b),this._headerID=r,this._okButtonID=s,this._onShow=void 0!==n?n:null,this._onHide=void 0!==o?o:null,this._handleKeyUp=function(t){t.keyCode===R&&this.hide()}.bind(this)}function d(t,e,i,n){c.call(this,t,e,i),this._menuOptions=n}function g(t,e,i,n,o){c.call(this,t,e,i),this._propertyLabelDescriptor=n,this._valueList=o,this._valueIndex=0,this._propertyLabel=this.registerSimpleComponent(A),this._valueSelector=this.registerSimpleComponent(O),this.onChange=null}var f="_",m="component",y="css",T="progress",S="status",M="header",x="message",E="okButton",b="header",A="property",O="value",R=13,v="disabled",C={};return u.prototype.getName=function(){return this._name},u.prototype.setElementID=function(t){this._elementID=t,this._element&&this._element.setAttribute("id",this._elementID)},u.prototype.getElement=function(){return this._element},u.prototype.getContent=function(){return this._element.innerHTML},u.prototype.setContent=function(e,i){this._element.innerHTML=i?t.formatString(e,i):e},u.prototype.customizeContent=function(e){this._element.innerHTML=t.formatString(this._element.innerHTML,e)},u.prototype.initComponent=function(){this._element=document.getElementById(this._elementID),this._element?this._displayStyle=this._element.style.display:e.showError("Cannot initialize component: '"+this._name+"'!",e.ErrorSeverity.SEVERE,"No element can be found on the page with a corresponding ID: '"+this._elementID+"'!")},u.prototype.resetComponent=function(){this._element=null,this._displayStyle=null},u.prototype.isVisible=function(){return"none"!==this._element.style.display},u.prototype.hide=function(){this._element.style.display="none"},u.prototype.show=function(){this._element.style.display=this._displayStyle},u.prototype.disable=function(){this._element.classList.add(v)},u.prototype.enable=function(){this._element.classList.remove(v)},c.prototype=new i.AsyncResource,c.prototype.constructor=c,c.prototype.getName=function(){return this._name},c.prototype.setRootElementID=function(t){var i;if(this._rootElement)e.showError("Attempting to change the root element ID for external component '"+this._name+"' after it has already been added to the page!");else for(this._rootElementID=t,i=0;i<this._simpleComponents.length;i++)this._simpleComponents[i].setElementID(this._getElementID(this._simpleComponents[i].getName()))},c.prototype.requestModelLoad=function(){this._style.cssFilename?(this._cssLoaded=!1,e.requestCSSFile(y,this._style.cssFilename,function(){this._cssLoaded=!0,o(this._htmlFilename)&&this.setToReady()}.bind(this))):this._cssLoaded=!0,a(this._htmlFilename,function(){this._cssLoaded===!0&&this.setToReady()}.bind(this))},c.prototype.appendToPage=function(t){var e,i;for(t=t||document.body,this._rootElement=t.appendChild(document.importNode(r(this._htmlFilename).body.firstElementChild,!0)),this._rootElement.setAttribute("id",this._rootElementID),this._rootElementDefaultDisplayMode=this._rootElement.style.display,e=this._rootElement.querySelectorAll("[id]"),i=0;i<e.length;i++)e[i].setAttribute("id",this._getElementID(e[i].getAttribute("id")));this._initializeComponents()},c.prototype._getElementID=function(t){return this._rootElementID+f+t},c.prototype._getOriginalElementID=function(t){return t.getAttribute("id").substr(this._rootElementID.length+f.length)},c.prototype._initializeComponents=function(){var t;if(this._rootElement)for(t=0;t<this._simpleComponents.length;t++)this._simpleComponents[t].initComponent();else e.log("WARNING! Attempting to initaialize external component "+this._name+" before appending it to the page! It will be initialized automatically once it is added.")},c.prototype.updateComponents=function(){var t,i;if(this._rootElement)for(i=this._rootElement.querySelectorAll("[id]"),t=0;t<i.length;t++)i[t].innerHTML=n.get({name:this._getOriginalElementID(i[t]),defaultValue:i[t].innerHTML});else e.log("WARNING! Attempting to update external component "+this._name+" before appending it to the page!")},c.prototype.registerSimpleComponent=function(t){var e=new u(t,this._getElementID(t));return this._simpleComponents.push(e),e},c.prototype.resetComponent=function(){var t;for(this.resetResource(),t=0;t<this._simpleComponents.length;t++)this._simpleComponents[t].resetComponent()},c.prototype.show=function(){this._rootElement?this._rootElement.style.display=this._rootElementDefaultDisplayMode:e.log("WARNING! Attempting to show external component "+this._name+" before appending it to the page!")},c.prototype.hide=function(){this._rootElement?this._rootElement.style.display="none":e.log("WARNING! Attempting to hide external component "+this._name+" before appending it to the page!")},_.prototype=new c,_.prototype.constructor=_,_.prototype._initializeComponents=function(){c.prototype._initializeComponents.call(this),this._rootElement&&(this._headerID&&this._header.setElementID(this._getElementID(this._headerID)),this.hide())},_.prototype.setMaxProgress=function(t){this._rootElement?this._progress.getElement().max=t:e.log("WARNING! Attempting to update the maximum progress value of loading box"+this._name+" before appending it to the page!")},_.prototype.updateProgress=function(t){this._rootElement?this._progress.getElement().value=t:e.log("WARNING! Attempting to update the progress value of loading box"+this._name+" before appending it to the page!")},_.prototype.updateStatus=function(t,i,n){this._rootElement?(this._status.setContent(t,i),void 0!==n&&this.updateProgress(n)):e.log("WARNING! Attempting to update the status message of loading box"+this._name+" before appending it to the page!")},p.prototype=new c,p.prototype.constructor=p,p.prototype._initializeComponents=function(){c.prototype._initializeComponents.call(this),this._rootElement&&(this._headerID&&this._header.setElementID(this._getElementID(this._headerID)),this._okButtonID&&this._okButton.setElementID(this._getElementID(this._okButtonID)),this._okButton.getElement().onclick=function(){return this.hide(),!1}.bind(this),c.prototype.hide.call(this))},p.prototype.show=function(){c.prototype.show.call(this),document.addEventListener("keyup",this._handleKeyUp),this._onShow&&this._onShow()},p.prototype.hide=function(){c.prototype.hide.call(this),document.removeEventListener("keyup",this._handleKeyUp),this._onHide&&this._onHide()},p.prototype.updateMessage=function(t,i){this._rootElement?this._message.setContent(t,i):e.log("WARNING! Attempting to update the message of info box"+this._name+" before appending it to the page!")},d.prototype=new c,d.prototype.constructor=d,d.prototype.getMenuClickHandler=function(t){return function(){return this._menuOptions[t].action(),!1}.bind(this)},d.prototype._initializeComponents=function(){var t,e,i;if(c.prototype._initializeComponents.call(this),this._rootElement)for(t=0;t<this._menuOptions.length;t++)e=document.createElement("a"),this._menuOptions[t].id&&(e.id=this._getElementID(this._menuOptions[t].id)),e.href="#",e.className=(this._style.menuClassName||"")+" "+(this._style.buttonClassName||""),
e.innerHTML=h(this._menuOptions[t]),e.onclick=this.getMenuClickHandler(t),i=document.createElement("li"),i.className=this._style.buttonContainerClassName||"",i.appendChild(e),this._rootElement.appendChild(i)},g.prototype=new c,g.prototype.constructor=g,g.prototype._initializeComponents=function(){c.prototype._initializeComponents.call(this),this._rootElement&&(this._propertyLabelDescriptor.id&&this._propertyLabel.setElementID(this._getElementID(this._propertyLabelDescriptor.id)),this._propertyLabel.setContent(h(this._propertyLabelDescriptor)),this._valueSelector.setContent(this._valueList[0]),this._valueIndex=0,this.setValueList(this._valueList),this._valueSelector.getElement().onclick=function(){return this.selectNextValue(),!1}.bind(this))},g.prototype.selectValue=function(t){if(this._rootElement){for(var i=0;i<this._valueList.length&&this._valueList[i]!==t;)i++;i<this._valueList.length?this.selectValueWithIndex(i):e.showError("Attempted to select value: '"+t+"' for '"+h(this._propertyLabelDescriptor)+"', which is not one of the available options.",e.ErrorSeverity.MINOR)}else e.showError("Attemted to select value for selector "+this._name+" which is not yet appended to the page!")},g.prototype.selectValueWithIndex=function(t){var i=this._valueIndex;this._rootElement?this._valueList.length>t?(this._valueIndex=t,this._valueSelector.setContent(this._valueList[this._valueIndex]),i!==t&&this.onChange&&this.onChange()):e.showError("Attempted to select value with index '"+t+"' for '"+h(this._propertyLabelDescriptor)+"', while the available range is: 0-"+(this._valueList.length-1),e.ErrorSeverity.MINOR):e.showError("Attemted to select value for selector "+this._name+" which is not yet appended to the page!")},g.prototype.getSelectedValue=function(){return this._valueList[this._valueIndex]},g.prototype.getSelectedIndex=function(){return this._valueIndex},g.prototype.selectNextValue=function(){this.selectValueWithIndex((this._valueIndex+1)%this._valueList.length)},g.prototype.setValueList=function(t){this._valueList=t,this._valueIndex>=this._valueList.length&&(this._valueIndex=0),this._valueList.length<2?this._valueSelector.disable():this._valueSelector.enable()},{ELEMENT_ID_SEPARATOR:f,clearStoredDOMModels:l,SimpleComponent:u,LoadingBox:_,InfoBox:p,MenuComponent:d,Selector:g}}),define("armada/constants",[],function(){"use strict";var t="Interstellar Armada",e="interstellarArmada_",i=e+"language",n=e+"version";return{GAME_NAME:t,LOCAL_STORAGE_PREFIX:e,LANGUAGE_LOCAL_STORAGE_ID:i,VERSION_LOCAL_STORAGE_ID:n}}),define("modules/managed-gl",["utils/utils","utils/types","modules/application","modules/async-resource"],function(t,e,i,n){"use strict";function o(t){switch(t){case m.NONE:return 0;case m.FLOAT:return 1;case m.VEC2:return 2;case m.VEC3:return 3;case m.VEC4:return 4;case m.MAT2:return 4;case m.MAT3:return 9;case m.MAT4:return 16;case m.SAMPLER2D:return 1;case m.SAMPLER_CUBE:return 1;case m.INT:return 1;case m.BOOL:return 1;default:return i.showError("Cannot determine vector size of GLSL type '"+t+"'!"),0}}function r(t){switch(t){case m.NONE:return 0;case m.FLOAT:return 1;case m.VEC2:return 1;case m.VEC3:return 1;case m.VEC4:return 1;case m.MAT2:return 2;case m.MAT3:return 3;case m.MAT4:return 4;case m.SAMPLER2D:return 1;case m.SAMPLER_CUBE:return 1;case m.INT:return 1;case m.BOOL:return 1;default:return i.showError("Cannot determine vector count of GLSL type '"+t+"'!"),0}}function s(t){return t===m.SAMPLER2D||t===m.SAMPLER_CUBE}function a(t){return t?1:0}function h(t,e,i){this._name=t,this._image=e,this._mipmap=void 0!==i?i:!0,this._ids={},this._locations={}}function l(t,e){this._name=t,this._images=e,this._ids={},this._locations={}}function u(t,e,i){this.name=t,this.size=e,this.role=i}function c(t,n,o,r){this._name=t,this._type=e.getEnumValue(m,n,{name:"uniform "+this._name+".type",defaultValue:m.NONE}),this._arraySize=o||0,this._unpacked=r,this._unpacked&&(!s(this._type)||this._arraySize<1)&&(i.showError("Uniform '"+this._name+"' cannot be declared as an unpacked array!"),this._unpacked=!1),this._members=this._type===m.STRUCT?[]:null,this._locations={},this._numericValues={}}function _(t,e,i,n){this._name=t,this._role=e,this._vectorSize=i,this._data=new Float32Array(n*this._vectorSize),this._ids={},this._locations={},this._filledVectors=0}function p(t,e,i,n){this._name=t,this._id=null,this._width=e,this._height=i,this._depthOnly=!!n,this._textureID=null,this._textureLocation=this.TEXTURE_LOCATION_NOT_SET,this._renderBufferID=null}function d(t,e,i,n,o,r,s,a){this._name=t,this._blendMode=n,this._vertexAttributes=[],this._instanceAttributes=[],this._uniforms=[],this._vertexShaderSource=e,this._fragmentShaderSource=i,this._ids={},this._instanceAttributeBuffers=[],this._uniformNamesForInstanceAttributeNames=r,this._numVertexUniformVectors=0,this._numAttributeVectors=0,this._numVaryingVectors=0,this._numTextureUnits=0,this._numFragmentUniformVectors=0,this._parseShaderSources(o,s,a)}function g(t,e,i,o,r){n.AsyncResource.call(this),this._name=t,this._canvas=e,this.gl=null,this._antialiasing=i===!0,this._filtering=null,this.anisotropicFilterExt=null,this.instancingExt=null,this.depthTextureExt=null,this._shaders=[],this._models=[],this._vertexBuffers=null,this._boundVertexBuffers=[],this._boundVertexBufferCount=0,this._frameBuffers={},this._currentShader=null,this._currentBlendMode=null,this._currentColorMask=null,this._currentDepthMask=!1,this._blendingEnabled=!1,this._textures=[],this._boundTextures=[],this._maxBoundTextures=0,this._nextTextureBindLocation=0,this._maxTextureSize=0,this._maxCubemapSize=0,this._maxRenderbufferSize=0,this._maxVertexAttributes=0,this._maxVertexShaderUniforms=0,this._maxFragmentShaderUniforms=0,this._maxVaryings=0,this._createContext(r),this.setFiltering(o)}var f={BILINEAR:"bilinear",TRILINEAR:"trilinear",ANISOTROPIC:"anisotropic"},m={NONE:"none",FLOAT:"float",VEC2:"vec2",VEC3:"vec3",VEC4:"vec4",MAT2:"mat2",MAT3:"mat3",MAT4:"mat4",SAMPLER2D:"sampler2D",SAMPLER_CUBE:"samplerCube",INT:"int",BOOL:"bool",STRUCT:"struct"},y={NONE:"none",MIX:"mix",ADD:"add"},T="u_",S="",M="",x="Texture",E="",b="Cubemap",A=null;return Object.freeze(f),Object.freeze(m),h.prototype.getName=function(){return this._name},h.prototype.getLastTextureBindLocation=function(t){return this._locations[t]},h.prototype.forgetLastTextureBindLocation=function(t){delete this._locations[t]},h.prototype.setMinFiltering=function(t,e,i){if(this._mipmap===!1)t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR);else{switch(e){case f.BILINEAR:t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST);break;case f.TRILINEAR:t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR);break;case f.ANISOTROPIC:t.texParameterf(t.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,4)}t.generateMipmap(t.TEXTURE_2D)}},h.prototype.createGLTexture=function(t,e){this._ids[t]=e.createTexture()},h.prototype.bindGLTexture=function(t,e,i){e.activeTexture(e.TEXTURE0+i),e.bindTexture(e.TEXTURE_2D,this._ids[t]),this._locations[t]=i},h.prototype.setupGLTexture=function(t,e,i){t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._image),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),this.setMinFiltering(t,e,i)},h.prototype.deleteGLTexture=function(t,e){this._ids[t]&&(e.deleteTexture(this._ids[t]),delete this._ids[t],delete this._locations[t])},l.prototype.getName=function(){return this._name},l.prototype.getLastTextureBindLocation=function(t){return this._locations[t]},l.prototype.forgetLastTextureBindLocation=function(t){delete this._locations[t]},l.prototype.createGLTexture=function(t,e){this._ids[t]=e.createTexture()},l.prototype.bindGLTexture=function(t,e,i){e.activeTexture(e.TEXTURE0+i),e.bindTexture(e.TEXTURE_CUBE_MAP,this._ids[t]),this._locations[t]=i},l.prototype.setupGLTexture=function(t){var e,i;for(t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.LINEAR),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),e=[t.TEXTURE_CUBE_MAP_POSITIVE_X,t.TEXTURE_CUBE_MAP_NEGATIVE_X,t.TEXTURE_CUBE_MAP_POSITIVE_Y,t.TEXTURE_CUBE_MAP_NEGATIVE_Y,t.TEXTURE_CUBE_MAP_POSITIVE_Z,t.TEXTURE_CUBE_MAP_NEGATIVE_Z],i=0;6>i;i++)t.texImage2D(e[i],0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._images[i])},l.prototype.deleteGLTexture=function(t,e){this._ids[t]&&(e.deleteTexture(this._ids[t]),delete this._ids[t],delete this._locations[t])},c.prototype.getName=function(){return this._name},c.prototype.addMember=function(t){this._type===m.STRUCT?this._members.push(t):i.showError("Attempting to add a member to uniform "+this._name+", which is not of struct type!")},c.prototype.saveLocation=function(t,e,i,n){n=n||this._name,this._locations[t]||(this._locations[t]={}),this._locations[t][n]=e.getUniformLocation(i.getIDForContext(t),n)},c.prototype.forgetLocations=function(t){var e,i;if(delete this._locations[t],this._numericValues={},this._members)for(e=0;e<this._arraySize;e++)for(i=0;i<this._members.length;i++)this._members[i].forgetLocations(t)},c.prototype.getLocation=function(t,e,i,n,o){var r=(n||"")+this._name+(o||"");return!n&&!o||this._locations[t]&&void 0!==this._locations[t][r]||this.saveLocation(t,e,i,r),this._locations[t][r]},c.prototype.getArraySize=function(){return this._arraySize},c.prototype.getRawName=function(){var t,e=this._name;return T.length>0&&(t=e.split(T),e=t[t.length-1]),S.length>0&&(e=e.split(S)[0]),e},c.prototype.getTextureType=function(){var t,e;if(this._type!==m.SAMPLER2D)return null;if(t=this.getRawName(),M.length>0){if(e=t.split(M),e.length<2)return null;t=e[e.length-1]}if(x.length>0){if(e=t.split(x),e.length<2)return null;t=e[0]}return t},c.prototype.getCubemapName=function(){var t,e;if(this._type!==m.SAMPLER_CUBE)return null;if(t=this.getRawName(),E.length>0){if(e=t.split(E),e.length<2)return null;t=e[e.length-1]}if(b.length>0){if(e=t.split(b),e.length<2)return null;t=e[0]}return t},c.prototype.getUniformName=function(t){return T+t+S},c.prototype.getTextureUniformRawName=function(t){return M+t+x},c.prototype.getCubemapUniformRawName=function(t){return E+t+b},c.prototype.setConstantValue=function(t,e,n,o,r){var s,h,l,u,c;switch(this._unpacked||(s=this.getLocation(t,e,n,r)),this._type){case m.FLOAT:this._arraySize>0?e.uniform1fv(s,o):(r||this._numericValues[t]!==o)&&(e.uniform1f(s,o),this._numericValues[t]=o);break;case m.VEC2:e.uniform2fv(s,o);break;case m.VEC3:e.uniform3fv(s,o);break;case m.VEC4:e.uniform4fv(s,o);break;case m.MAT2:e.uniformMatrix2fv(s,!1,o);break;case m.MAT3:e.uniformMatrix3fv(s,!1,o);break;case m.MAT4:e.uniformMatrix4fv(s,!1,o);break;case m.SAMPLER2D:case m.SAMPLER_CUBE:case m.INT:if(this._arraySize>0)if(this._unpacked)for(h=0;h<o.length;h++)e.uniform1i(this.getLocation(t,e,n,r,h.toString()),o[h]);else e.uniform1iv(s,o);else(r||this._numericValues[t]!==o)&&(e.uniform1i(s,o),this._numericValues[t]=o);break;case m.BOOL:this._arraySize>0?e.uniform1iv(s,o.map(a)):(c=o?1:0,(r||this._numericValues[t]!==c)&&(e.uniform1i(s,c),this._numericValues[t]=c));break;case m.STRUCT:if(this._arraySize>0)for(h=0;h<o.length;h++)for(l=0;l<this._members.length;l++)void 0!==o[h][this._members[l]._name]&&(u=this._members[l]._name,this._members[l].setConstantValue(t,e,n,o[h][u],this._name+"["+h+"]."));else for(h=0;h<this._members.length;h++)void 0!==o[this._members[h]._name]&&(u=this._members[h]._name,this._members[h].setConstantValue(t,e,n,o[u],this._name+"."));break;default:i.showError("Attempting to set uniform '"+this._name+"', but it has a type that cannot be handled! ("+(this._arraySize>0?"array ("+this._arraySize+") of ":"")+this._type+")")}},c.prototype.setValue=function(t,e,i,n,o){this.setConstantValue(t,e,i,n(),o)},c.prototype.getVectorCount=function(){var t,e;if(this._type===m.STRUCT){for(t=0,e=0;e<this._members.length;e++)t+=this._members[e].getVectorCount();return t}return r(this._type)*(this._arraySize||1)},c.prototype.isSamplerType=function(){return s(this._type)},_.prototype.getName=function(){return this._name},_.prototype.getRole=function(){return this._role},_.prototype.setData=function(t,e){this._data.set(t,e*this._vectorSize)},_.prototype.getSize=function(){return this._data.length/this._vectorSize},_.prototype.resize=function(t){this._data=new Float32Array(t*this._vectorSize)},_.prototype.addVector=function(t){this._data.set(t,this._filledVectors*this._vectorSize),this._filledVectors++},_.prototype.resetFilledVectors=function(){this._filledVectors=0},_.prototype.freeData=function(){this._data=null},_.prototype.loadToGPUMemory=function(t,e,i){this._ids[t]=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._ids[t]),e.bufferData(e.ARRAY_BUFFER,this._data,e.STATIC_DRAW),i||this.freeData()},_.prototype.bind=function(t,e,n){(void 0===this._locations[e.getName()]||-1===this._locations[e.getName()])&&(this._locations[e.getName()]=t.gl.getAttribLocation(e.getIDForContext(t.getName()),this._name));var o=this._locations[e.getName()];o>=0&&t.getBoundVertexBuffer(o)!==this&&(i.log("Binding "+(n?"instance":"vertex")+" buffer '"+this._name+"' to attribute location "+o+" in shader '"+e.getName()+"'.",3),n?this.loadToGPUMemory(t.getName(),t.gl,!0):t.gl.bindBuffer(t.gl.ARRAY_BUFFER,this._ids[t.getName()]),t.getBoundVertexBuffer(o)||t.gl.enableVertexAttribArray(o),t.gl.vertexAttribPointer(o,this._vectorSize,t.gl.FLOAT,!1,0,0),t.instancingExt&&(n?t.instancingExt.vertexAttribDivisorANGLE(o,1):t.instancingExt.vertexAttribDivisorANGLE(o,0)),t.setBoundVertexBuffer(o,this))},_.prototype["delete"]=function(t){var e,i;t.gl.deleteBuffer(this._ids[t.getName()]);for(e in this._locations)this._locations.hasOwnProperty(e)&&(i=this._locations[e],t.getBoundVertexBuffer(i)===this&&(t.setBoundVertexBuffer(i,null),t.gl.disableVertexAttribArray(i)));delete this._ids[t.getName()],0===Object.keys(this._ids).length&&(this.freeData(),this._locations={})},p.prototype.TEXTURE_LOCATION_NOT_SET=-1,p.prototype.getName=function(){return this._name},p.prototype.getLastTextureBindLocation=function(){return this._textureLocation},p.prototype.forgetLastTextureBindLocation=function(){this._textureLocation=this.TEXTURE_LOCATION_NOT_SET},p.prototype.setup=function(t){if(!this._id)switch(this._id=t.gl.createFramebuffer(),t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,this._id),this._textureID=t.gl.createTexture(),this._textureLocation=t.bindTexture(this),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MAG_FILTER,t.gl.NEAREST),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MIN_FILTER,t.gl.NEAREST),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_WRAP_S,t.gl.CLAMP_TO_EDGE),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_WRAP_T,t.gl.CLAMP_TO_EDGE),this._depthOnly&&t.areDepthTexturesAvailable()?(t.gl.texImage2D(t.gl.TEXTURE_2D,0,t.gl.DEPTH_COMPONENT,this._width,this._height,0,t.gl.DEPTH_COMPONENT,t.gl.UNSIGNED_SHORT,null),t.gl.framebufferTexture2D(t.gl.FRAMEBUFFER,t.gl.DEPTH_ATTACHMENT,t.gl.TEXTURE_2D,this._textureID,0)):(t.gl.texImage2D(t.gl.TEXTURE_2D,0,t.gl.RGBA,this._width,this._height,0,t.gl.RGBA,t.gl.UNSIGNED_BYTE,null),this._renderBufferID=t.gl.createRenderbuffer(),t.gl.bindRenderbuffer(t.gl.RENDERBUFFER,this._renderBufferID),t.gl.renderbufferStorage(t.gl.RENDERBUFFER,t.gl.DEPTH_COMPONENT16,this._width,this._height),t.gl.framebufferTexture2D(t.gl.FRAMEBUFFER,t.gl.COLOR_ATTACHMENT0,t.gl.TEXTURE_2D,this._textureID,0),t.gl.framebufferRenderbuffer(t.gl.FRAMEBUFFER,t.gl.DEPTH_ATTACHMENT,t.gl.RENDERBUFFER,this._renderBufferID)),t.gl.checkFramebufferStatus(t.gl.FRAMEBUFFER)){case t.gl.FRAMEBUFFER_COMPLETE:i.log("Framebuffer '"+this._name+"' successfully created.",2);break;case t.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete.");break;case t.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': Attachment missing.");break;case t.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': Height and width of the attachment are not the same.");break;case t.gl.FRAMEBUFFER_UNSUPPORTED:i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': The format of the attachment is not supported or depth and stencil attachments are not the same renderbuffer.");break;default:i.showGraphicsError("Unknown framebuffer status for '"+this._name+"'!")}},p.prototype.bind=function(t){t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,this._id)},p.prototype.bindGLTexture=function(t,e){t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_2D,this._textureID),this._textureLocation=e},p.prototype["delete"]=function(t){t.gl.deleteTexture(this._textureID),this._depthOnly&&t.areDepthTexturesAvailable()||t.gl.deleteRenderbuffer(this._renderBufferID),t.gl.deleteFramebuffer(this._id),this._id=null},d.prototype._hasUniform=function(t){var e;for(e=0;e<this._uniforms.length;e++)if(this._uniforms[e].getName()===t)return!0;return!1},d.prototype._getUniform=function(t){var e;for(e=0;e<this._uniforms.length;e++)if(this._uniforms[e].getName()===t)return this._uniforms[e];return null},d.prototype._parseShaderSources=function(e,n,a){var h,l,_,p,d,g,f,y,T,S,M,x,E,b,A,O,R,v,C,I=0,L=1,N={},w={},D=function(t){return""!==t},F=function(t){return"highp"===t||"mediump"===t||"lowp"===t},V=function(e){return t.getSafeEnumValue(m,e,m.NONE)!==m.NONE},P=function(t,e){var i,n,o,r;for(i=!1,o=0;o<d.length;o++)if(n=d[o].split(" "),i){if(n=n.filter(D),n.length>0&&"}"===n[n.length-1].split(";")[0])break;n.length>=2&&(r=F(n[0])?1:0,t.addMember(new c(n[r+1].split(";")[0],n[r],0)))}else"struct"===n[0]&&n[1].split("{")[0]===e&&(i=!0)};for(p=0;2>p;p++){switch(p){case I:d=this._vertexShaderSource.split("\n");break;case L:d=this._fragmentShaderSource.split("\n")}for(v=!1,h=0;h<d.length;h++)if(d[h].length>0)if(g=d[h].split(/\s+|[\(\)\[\]\{\}\+\?\-!<>=*\/\^\|\&,;]/),f=d[h].match(/\s+|[\(\)\[\]\{\}\+\?\-!<>=*\/\^\|\&,;]/g),"#define"===g[0])n&&void 0!==n[g[1]]?(N[g[1]]=n[g[1]],g[2]!==n[g[1]]&&(d[h]=d[h].replace(g[2],n[g[1]]),v=!0)):N[g[1]]=g[2];else if(p===I&&"attribute"===g[0])if(y=F(g[1])?3:2,T=g[y],b=g[y-1],S=o(b),M=e[T],this._numAttributeVectors+=r(b),void 0===M){if(!this._uniformNamesForInstanceAttributeNames.hasOwnProperty(T))return void i.showError("Role for attribute named '"+T+"' not found for shader '"+this._name+"'!");M=this._uniformNamesForInstanceAttributeNames[T],this._instanceAttributes.push(new u(T,S,M))}else this._vertexAttributes.push(new u(T,S,M));else if("uniform"===g[0]){if(y=F(g[1])?3:2,E=g[y],b=g[y-1],this._hasUniform(E)===!1){if("["===f[y]){if(R=!1,O=g[y+1],N[O]&&(O=N[O]),A=parseInt(O,10),s(b)&&a){for(d[h]="",l=0;A>l;l++){for(_=0;y>_;_++)d[h]+=g[_],d[h]+=f[_];d[h]+=E+l.toString()+";\n"}v=!0,R=!0}}else A=0;V(b)?this._uniforms.push(new c(E,b,A,R)):(x=new c(E,"struct",A),P(x,b),this._uniforms.push(x))}switch(p){case I:this._numVertexUniformVectors+=this._getUniform(E).getVectorCount();break;case L:this._numFragmentUniformVectors+=this._getUniform(E).getVectorCount(),s(b)&&(this._numTextureUnits+=this._getUniform(E).getVectorCount());break;default:i.crash()}}else if("varying"===g[0])y=F(g[1])?3:2,b=g[y-1],p===L&&("["===f[y]?(O=g[y+1],N[O]&&(O=N[O]),A=parseInt(O,10)):A=1,this._numVaryingVectors+=r(b)*A);else{for(y=0;""===g[y];)y++;if(V(g[y])||F(g[y]))y=F(g[y])?y+2:y+1,"["===f[y]&&(O=g[y+1],N[O]&&(O=N[O]),w[g[y]]=parseInt(O,10));else{for(l=0;l<this._uniforms.length;l++)if(y=g.indexOf(this._uniforms[l].getName()),y>=0&&this._uniforms[l].getArraySize()>0&&"["===f[y]){if(parseInt(g[y+1],10).toString()===g[y+1]&&parseInt(g[y+1],10)>=this._uniforms[l].getArraySize()){d[h]="",v=!0;break}if(this._uniforms[l].isSamplerType()&&a){for(d[h]="",_=0;y>_;_++)d[h]+=g[_],d[h]+=f[_];for(d[h]+=g[y]+g[y+1],_=y+2;_<f.length;_++)d[h]+=g[_],d[h]+=f[_];d[h]+=g[g.length-1],v=!0;break}}for(C=Object.keys(w),l=0;l<C.length;l++)if(y=g.indexOf(C[l]),y>=0&&"["===f[y]&&parseInt(g[y+1],10).toString()===g[y+1]&&parseInt(g[y+1],10)>=w[g[y]]){d[h]="",v=!0;break}}}if(v)switch(p){case I:this._vertexShaderSource=d.join("\n");break;case L:this._fragmentShaderSource=d.join("\n")}}},d.prototype.getName=function(){return this._name},d.prototype.getIDForContext=function(t){return this._ids[t]},d.prototype.getVertexAttributes=function(){return this._vertexAttributes},d.prototype.getVertexAttribute=function(t){var e;for(e=0;e<this._vertexAttributes.length;e++)if(this._vertexAttributes[e].name===t)return this._vertexAttributes[e];return null},d.prototype.getInstanceAttribute=function(t){var e;for(e=0;e<this._instanceAttributes.length;e++)if(this._instanceAttributes[e].name===t)return this._instanceAttributes[e];return null},d.prototype.setupGLProgram=function(t,e){var n,o,r,s,a;if(n=e.createShader(e.VERTEX_SHADER),e.shaderSource(n,this._vertexShaderSource),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS))return o=e.getShaderInfoLog(n),i.showGraphicsError("Compiling GLSL vertex shader of '"+this._name+"' failed.",i.ErrorSeverity.SEVERE,"More details:\n"+o,e),void(this._ids[t]=null);if(r=e.createShader(e.FRAGMENT_SHADER),e.shaderSource(r,this._fragmentShaderSource),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS))return o=e.getShaderInfoLog(r),i.showGraphicsError("Compiling GLSL fragment shader of '"+this._name+"' failed.",i.ErrorSeverity.SEVERE,"More details:\n"+o,e),void(this._ids[t]=null);if(this._ids[t]=e.createProgram(),s=this._ids[t],e.attachShader(s,n),e.attachShader(s,r),e.linkProgram(s),!e.getProgramParameter(s,e.LINK_STATUS))return o=e.getProgramInfoLog(s),i.showGraphicsError("Linking GLSL shader '"+this._name+"' failed.",i.ErrorSeverity.SEVERE,"More details: "+o,e),e.deleteProgram(s),void(this._ids[t]=null);for(a=0;a<this._uniforms.length;a++)this._uniforms[a].saveLocation(t,e,this)},d.prototype.getBlendMode=function(){return this._blendMode},d.prototype.assignUniforms=function(t,e){var i;if(t.setCurrentShader(this),e)for(i=0;i<this._uniforms.length;i++)void 0!==e[this._uniforms[i].getName()]&&this._uniforms[i].setValue(t.getName(),t.gl,this,e[this._uniforms[i].getName()])},d.prototype.bindVertexBuffers=function(t){var e;for(e=0;e<this._vertexAttributes.length;e++)t.getVertexBuffer(this._vertexAttributes[e].name).bind(t,this);t.disableUnusedVertexBuffers(this._vertexAttributes.length)},d.prototype.getUniformArrayLength=function(t){var e;for(e=0;e<this._uniforms.length;e++)if(this._uniforms[e].getName()===t)return this._uniforms[e].getArraySize();return 0},d.prototype.getTextureTypes=function(){var t,e,i=[];for(t=0;t<this._uniforms.length;t++)e=this._uniforms[t].getTextureType(),e&&i.push(e);return i},d.prototype.getCubemapNames=function(){var t,e,i=[];for(t=0;t<this._uniforms.length;t++)e=this._uniforms[t].getCubemapName(),e&&i.push(e);return i},d.prototype.createInstanceBuffers=function(t,e){var i;this._instanceAttributeBuffers.length<t+1&&(this._instanceAttributeBuffers=this._instanceAttributeBuffers.concat(new Array(t-this._instanceAttributeBuffers.length+1)));for(i in this._uniformNamesForInstanceAttributeNames)this._uniformNamesForInstanceAttributeNames.hasOwnProperty(i)&&(this._instanceAttributeBuffers[t]||(this._instanceAttributeBuffers[t]={}),this._instanceAttributeBuffers[t][i]?(this._instanceAttributeBuffers[t][i].resize(e),this._instanceAttributeBuffers[t][i].resetFilledVectors()):this._instanceAttributeBuffers[t][i]=new _(i,this._uniformNamesForInstanceAttributeNames[i],this.getInstanceAttribute(i).size,e))},d.prototype.addDataToInstanceBuffers=function(t,e){var i,n;for(i in this._instanceAttributeBuffers[t])this._instanceAttributeBuffers[t].hasOwnProperty(i)&&(n=this._instanceAttributeBuffers[t][i].getRole(),e.hasOwnProperty(n)&&this._instanceAttributeBuffers[t][i].addVector(e[n](!0)))},d.prototype.bindAndFillInstanceBuffers=function(t,e){var i;for(i in this._instanceAttributeBuffers[e])this._instanceAttributeBuffers[e].hasOwnProperty(i)&&this._instanceAttributeBuffers[e][i].bind(t,this,!0)},d.prototype.deleteInstanceBuffers=function(t){var e,i;for(e=0;e<this._instanceAttributeBuffers.length;e++)for(i in this._instanceAttributeBuffers[e])this._instanceAttributeBuffers[e].hasOwnProperty(i)&&this._instanceAttributeBuffers[e][i]["delete"](t);this._instanceAttributeBuffers=[]},d.prototype.deleteGLProgram=function(t,e){var i;if(this._ids[t]){for(i=0;i<this._uniforms.length;i++)this._uniforms[i].forgetLocations(t);e.deleteProgram(this._ids[t]),delete this._ids[t]}},d.prototype.isAllowedByRequirements=function(t){return this._numAttributeVectors<=t.requiredAttributeVectors&&this._numVertexUniformVectors<=t.requiredVertexUniformVectors&&this._numVaryingVectors<=t.requiredVaryingVectors&&this._numTextureUnits<=t.requiredTextureUnits&&this._numFragmentUniformVectors<=t.requiredFragmentUniformVectors},g.prototype=new n.AsyncResource,g.prototype.constructor=g,g.prototype._createContext=function(t){var e,n;i.log("Initializing WebGL context...",1),n={alpha:!0,antialias:this._antialiasing};try{this.gl=this._canvas.getContext("webgl",n)}catch(o){}if(!this.gl){i.log("Initializing a regular context failed, initializing experimental context...",1),n.alpha=!1;try{this.gl=this._canvas.getContext("experimental-webgl",n)}catch(o){}if(!this.gl)return void i.showError("Unable to initialize WebGL.",i.ErrorSeverity.CRITICAL,"It looks like your device, browser or graphics drivers do not support web 3D graphics. Make sure your browser and graphics drivers are updated to the latest version, and you are using a modern web browser (Firefox or Chrome are recommended).\nPlease note that some phones or handheld devices do not have 3D web capabilities, even if you use the latest software.");i.showError("Your device appears to only have experimental WebGL (web based 3D) support.",void 0,"This application relies on 3D web features, and without full support, the graphics of the application might be displayed with glitches or not at all. If you experience problems, it is recommended to use lower graphics quality settings.")}e=this.gl,this._antialiasing&&!e.getContextAttributes().antialias&&(t||i.showGraphicsError("Antialiasing is enabled in graphics settings but it is not supported.",i.ErrorSeverity.MINOR,"Your graphics driver, browser or device unfortunately does not support antialiasing. To avoid this error message showing up again, disable antialiasing in the graphics settings or try running the application in a different browser. Antialiasing will not work, but otherwise this error will have no consequences.",e),this._antialiasing=!1),this._maxBoundTextures=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextures=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this._maxCubemapSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this._maxRenderbufferSize=e.getParameter(e.MAX_RENDERBUFFER_SIZE),this._maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._maxVertexShaderUniforms=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentShaderUniforms=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxVaryings=e.getParameter(e.MAX_VARYING_VECTORS),i.log("WebGL context successfully created.\n"+this.getInfoString(),1),this.anisotropicFilterExt=e.getExtension("EXT_texture_filter_anisotropic"),null===this.anisotropicFilterExt?i.log("Anisotropic filtering not available.",1):i.log("Anisotropic filtering successfully initialized.",1),this.instancingExt=e.getExtension("ANGLE_instanced_arrays"),null===this.instancingExt?i.log("Instancing is not available, and so it will be disabled.",1):i.log("Instancing successfully initialized.",1),this.depthTextureExt=e.getExtension("WEBGL_depth_texture"),null===this.depthTextureExt?i.log("Depth textures not available, and so will be disabled.",1):i.log("Depth texture extension successfully initialized.",1),e.clearDepth(1),e.colorMask(!0,!0,!0,!0),this._currentColorMask=[!0,!0,!0,!0],e.depthMask(!0),this._currentDepthMask=!0,e.enable(e.BLEND),this._blendingEnabled=!0,e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW)},g.prototype.getInfoString=function(){return this.gl?"WebGL version: "+this.gl.getParameter(this.gl.VERSION)+"\nShading language version: "+this.gl.getParameter(this.gl.SHADING_LANGUAGE_VERSION)+"\nWebGL vendor: "+this.gl.getParameter(this.gl.VENDOR)+"\nWebGL renderer: "+this.gl.getParameter(this.gl.RENDERER)+"\nAvailable vertex shader uniform vectors: "+this._maxVertexShaderUniforms+"\nAvailable vertex attributes: "+this._maxVertexAttributes+"\nAvailable texture units in vertex shaders: "+this._maxVertexTextures+"\nAvailable varying vectors: "+this._maxVaryings+"\nAvailable fragment shader uniform vectors: "+this._maxFragmentShaderUniforms+"\nAvailable texture units: "+this._maxBoundTextures+"\nMaximum texture size: "+this._maxTextureSize+"\nMaximum cubemap size: "+this._maxCubemapSize+"\nMaximum renderbuffer size: "+this._maxRenderbufferSize:"N/A"},g.prototype.getName=function(){return this._name},g.prototype.isAntialiased=function(){return this._antialiasing},g.prototype.getFiltering=function(){return this._filtering},g.prototype.setFiltering=function(e){var n;if(e=t.getSafeEnumValue(f,e,this._filtering),e!==this._filtering)for(this._filtering=e,this._filtering===f.ANISOTROPIC&&(this.anisotropicFilterExt||(i.log("Anisotropic filtering is set, but the required extension is not available. Trilinear filtering will be used.",1),this._filtering=f.TRILINEAR)),n=0;n<this._textures.length;n++)this._textures[n].setMinFiltering&&(this.bindTexture(this._textures[n]),this._textures[n].setMinFiltering(this.gl,this._filtering,this.anisotropicFilterExt))},g.prototype.isAnisotropicFilteringAvailable=function(){return!!this.anisotropicFilterExt},g.prototype.isInstancingAvailable=function(){return!!this.instancingExt},g.prototype.areDepthTexturesAvailable=function(){return!!this.depthTextureExt},g.prototype.setColorMask=function(t){(this._currentColorMask[0]!==t[0]||this._currentColorMask[1]!==t[1]||this._currentColorMask[2]!==t[2]||this._currentColorMask[3]!==t[3])&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this._currentColorMask=t)},g.prototype.setDepthMask=function(t){this._currentDepthMask!==t&&(this.gl.depthMask(t),this._currentDepthMask=t)},g.prototype.enableBlending=function(){this._blendingEnabled||(this.gl.enable(this.gl.BLEND),this._blendingEnabled=!0)},g.prototype.disableBlending=function(){this._blendingEnabled&&(this.gl.disable(this.gl.BLEND),this._blendingEnabled=!1)},g.prototype.addShader=function(t){this._shaders.indexOf(t)<0&&(this._shaders.push(t),t.setupGLProgram(this._name,this.gl),this.resetReadyState())},g.prototype.addModel=function(t){this._models.indexOf(t)<0&&(this._models.push(t),this.resetReadyState())},g.prototype.getVertexBuffer=function(t){return this._vertexBuffers[t]},g.prototype.addVertexBuffer=function(t){void 0===this._vertexBuffers[t.getName()]&&(this._vertexBuffers[t.getName()]=t)},g.prototype.getBoundVertexBuffer=function(t){return this._boundVertexBuffers[t]},g.prototype.setBoundVertexBuffer=function(t,e){this._boundVertexBuffers[t]=e,e&&t>=this._boundVertexBufferCount&&(this._boundVertexBufferCount=t+1)},g.prototype.disableUnusedVertexBuffers=function(t){var e;for(e=t;e<this._boundVertexBufferCount;e++)this.gl.disableVertexAttribArray(e),this._boundVertexBuffers[e]=null;this._boundVertexBufferCount=t},g.prototype.setVertexBufferData=function(t,e){var i;for(i in this._vertexBuffers)this._vertexBuffers.hasOwnProperty(i)&&void 0!==t[this._vertexBuffers[i].getRole()]&&this._vertexBuffers[i].setData(t[this._vertexBuffers[i].getRole()],e)},g.prototype.setupVertexBuffers=function(){var t,e,i,n,o,r;if(this.isReadyToUse()!==!0){for(i in this._vertexBuffers)this._vertexBuffers.hasOwnProperty(i)&&this._vertexBuffers[i]["delete"](this);
for(n=0,t=0;t<this._models.length;t++)n+=this._models[t].getBufferSize(this);for(this._vertexBuffers={},t=0;t<this._shaders.length;t++)for(o=this._shaders[t].getVertexAttributes(),e=0;e<o.length;e++)this.addVertexBuffer(new _(o[e].name,o[e].role,o[e].size,n));for(r=0,t=0;t<this._models.length;t++)for(e=this._models[t].getMinLOD();e<=this._models[t].getMaxLOD();e++)r+=this._models[t].loadToVertexBuffers(this,r,e);for(i in this._vertexBuffers)this._vertexBuffers.hasOwnProperty(i)&&this._vertexBuffers[i].loadToGPUMemory(this._name,this.gl);for(this._currentShader=null,t=0;t<this._shaders.length;t++)this.setCurrentShader(this._shaders[t])}},g.prototype.getFrameBuffer=function(t){return this._frameBuffers[t]},g.prototype.addFrameBuffer=function(t){void 0===this._frameBuffers[t.getName()]&&(i.log("Adding new framebuffer '"+t.getName()+"' to context ("+this._name+")...",2),this._frameBuffers[t.getName()]=t,this.isReadyToUse()&&this._frameBuffers[t.getName()].setup(this))},g.prototype.setupFrameBuffers=function(){var t;if(!this.isReadyToUse())for(t in this._frameBuffers)this._frameBuffers.hasOwnProperty(t)&&this._frameBuffers[t].setup(this)},g.prototype.clearFrameBuffers=function(){var t;for(t in this._frameBuffers)this._frameBuffers.hasOwnProperty(t)&&this._frameBuffers[t]["delete"](this);this._frameBuffers={}},g.prototype.setup=function(){i.log("Setting up context '"+this._name+"'...",2),this.setupVertexBuffers(),this.setupFrameBuffers(),this.setToReady()},g.prototype.clear=function(){var t;for(i.log("Clearing context '"+this._name+"'...",2),this.clearFrameBuffers(),this._currentShader=null,t=0;t<this._boundTextures.length;t++)this.unbindTexture(this._boundTextures[t].texture);for(this._boundTextures=[],t=0;t<this._textures.length;t++)this._textures[t].forgetLastTextureBindLocation(this._name);for(t=0;t<this._boundVertexBuffers.length;t++)this.gl.disableVertexAttribArray(t);this._boundVertexBufferCount=0,this._boundVertexBuffers=[]},g.prototype.removeShaders=function(){var t;for(t=0;t<this._shaders.length;t++)this._shaders[t].deleteInstanceBuffers(this),this._shaders[t].deleteGLProgram(this._name,this.gl);this._shaders=[],this._currentShader=null},g.prototype.setCurrentFrameBuffer=function(t){t?this._frameBuffers[t].bind(this):this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)},g.prototype.getCurrentShader=function(){return this._currentShader},g.prototype.setCurrentShader=function(t){var e;if(this._currentShader!==t){switch(i.log("Switching to shader: "+t.getName(),3),this.gl.useProgram(t.getIDForContext(this._name)),e=t.getBlendMode()){case y.MIX:this._currentBlendMode!==e&&(this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this._currentBlendMode=e);break;case y.ADD:this._currentBlendMode!==e&&(this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE),this._currentBlendMode=e);break;case y.NONE:break;default:i.crash()}return t.bindVertexBuffers(this),this._currentShader=t,!0}return!1},g.prototype.addTexture=function(t){this._textures.indexOf(t)<0&&(this._textures.push(t),t.createGLTexture(this._name,this.gl),this.bindTexture(t),t.setupGLTexture(this.gl,this._filtering,this.anisotropicFilterExt))},g.prototype.bindTexture=function(t,e,n){var o=void 0!==e||n;if(void 0===e&&(e=t.getLastTextureBindLocation(this._name),void 0===e||e===p.prototype.TEXTURE_LOCATION_NOT_SET||this._boundTextures[e].texture!==t)){for(e=0;e<this._maxBoundTextures&&e<this._boundTextures.length&&this._boundTextures[e];)e++;if(e===this._maxBoundTextures){for(;this._boundTextures[this._nextTextureBindLocation].reserved;)this._nextTextureBindLocation=(this._nextTextureBindLocation+1)%this._maxBoundTextures;e=this._nextTextureBindLocation,this._nextTextureBindLocation=(this._nextTextureBindLocation+1)%this._maxBoundTextures}}return this._boundTextures[e]&&this._boundTextures[e].texture===t||(t instanceof h?(i.log("Binding texture: '"+t.getName()+"' to texture unit "+e+(o?", reserving place.":"."),3),t.bindGLTexture(this._name,this.gl,e)):t instanceof l?(i.log("Binding cubemap texture: '"+t.getName()+"' to texture unit "+e+(o?", reserving place.":"."),3),t.bindGLTexture(this._name,this.gl,e)):t instanceof p?(i.log("Binding framebuffer texture: '"+t.getName()+"' to texture unit "+e+(o?", reserving place.":"."),3),t.bindGLTexture(this.gl,e)):i.showError("Cannot set object: '"+t.toString()+"' as current texture, because it is not of an appropriate type."),this._boundTextures[e]={texture:t,reserved:o}),this._boundTextures[e].reserved!==o&&(this._boundTextures[e].reserved=o,i.log((o?"Reserved":"Freed")+" texture unit index "+e+".",3)),e},g.prototype.unbindTexture=function(t){var e=t&&t.getLastTextureBindLocation(this._name);void 0!==e&&e>=0&&this._boundTextures[e]===t&&(this.gl.activeTexture(this.gl.TEXTURE0+e),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,null),this._boundTextures[e]=null,t.forgetLastTextureBindLocation(this._name))},g.prototype.removeTexture=function(t){var e=this._textures.indexOf(t);e>=0&&(this.unbindTexture(t),t.deleteGLTexture(this._name,this.gl),this._textures.splice(e,1))},g.prototype.satisfiesRequirements=function(t){return this._maxVertexAttributes>=t.requiredAttributeVectors&&this._maxVertexShaderUniforms>=t.requiredVertexUniformVectors&&this._maxVaryings>=t.requiredVaryingVectors&&this._maxFragmentShaderUniforms>=t.requiredFragmentUniformVectors&&this._maxBoundTextures>=t.requiredTextureUnits},g.prototype.getMaxTextureSize=function(){return this._maxTextureSize},g.prototype.getMaxCubemapSize=function(){return this._maxCubemapSize},g.prototype.getMaxRenderbufferSize=function(){return this._maxRenderbufferSize},i.showGraphicsError=function(t,e,n){i.showError(t,e,n+"\n\nThis is a graphics related error.\nInformation about your graphics support:\n"+A.getInfoString())},A=new g("",document.createElement("canvas"),!0,f.BILINEAR,!0),{TextureFiltering:f,ShaderVariableType:m,ShaderBlendMode:y,getUniformName:c.prototype.getUniformName,getTextureUniformRawName:c.prototype.getTextureUniformRawName,getCubemapUniformRawName:c.prototype.getCubemapUniformRawName,ManagedTexture:h,ManagedCubemap:l,ManagedShader:d,FrameBuffer:p,ManagedGLContext:g,requirementsAreSatisfied:A.satisfiesRequirements.bind(A),getMaxTextureSize:A.getMaxTextureSize.bind(A),getMaxCubemapSize:A.getMaxCubemapSize.bind(A),getMaxRenderbufferSize:A.getMaxRenderbufferSize.bind(A),isAntialiasingAvailable:A.isAntialiased.bind(A),isAnisotropicFilteringAvailable:A.isAnisotropicFilteringAvailable.bind(A),isInstancingAvailable:A.isInstancingAvailable.bind(A),areDepthTexturesAvailable:A.areDepthTexturesAvailable.bind(A)}}),define("modules/resource-manager",["modules/application","modules/async-resource"],function(t,e){"use strict";function i(t){e.AsyncResource.call(this),this._name=t,this._requested=!1,this._requestParams={}}function n(t){e.AsyncResource.call(this),this._resourceType=t,this._resources={},this._numLoadedResources=0,this._numRequestedResources=0}function o(){e.AsyncResource.call(this),this._resourceHolders={},this._numLoadedResources=0,this._numRequestedResources=0,this._onResourceTypeLoadFunctionQueues={},this._onAnyResourceTypeLoadFunctionQueue=[],this._onResourceLoadFunctionQueue=[]}return i.prototype=new e.AsyncResource,i.prototype.constructor=i,i.prototype.getName=function(){return this._name},i.prototype.isRequested=function(t){var e;if(!this._requested)return!1;if(t){for(e in t)if(t.hasOwnProperty(e)&&t[e]!==this._requestParams[e])return!1;for(e in this._requestParams)if(this._requestParams.hasOwnProperty(e)&&this._requestParams[e]!==t[e])return!1}return!0},i.prototype.request=function(t){this._requested=!0,this._requestParams=t},i.prototype.requiresReload=function(){t.showError("Resource class does not implement requiresReload!")},i.prototype.isLoaded=function(){return this.isReadyToUse()},i.prototype._requestFiles=function(){t.showError("Attempting to request files for a resource type that has no file request function implemented!")},i.prototype._loadData=function(){t.showError("Attempting to load data for a resource type that has no data loading function implemented!")},i.prototype._onFilesLoad=function(t,e){this._loadData(e),t===!0&&(this.setToReady(),this._requested=!1)},i.prototype.requestLoadFromFile=function(){this.isReadyToUse()===!1&&this._requested===!0&&this._requestFiles(this._requestParams)},n.prototype=new e.AsyncResource,n.prototype.constructor=n,n.prototype.allResourcesAreLoaded=function(){return this._numLoadedResources===this._numRequestedResources},n.prototype.addResource=function(t){return this._resources[t.getName()]=t,this._resources[t.getName()]},n.prototype.getResource=function(e,i){var n;return this._resources[e]?(n=this._resources[e],i&&i.doNotLoad||n.requiresReload(i)&&(this._numRequestedResources++,this.resetReadyState(),n.resetReadyState(),n.executeWhenReady(function(){this._numLoadedResources++,this.allResourcesAreLoaded()&&this.setToReady()}.bind(this))),n):(i&&i.allowNullResult===!0||t.showError("Requested a resource named '"+e+"' from "+this._resourceType+", which does not exist."),null)},n.prototype.requestResourceLoad=function(){var t;for(t in this._resources)this._resources.hasOwnProperty(t)&&this._resources[t].requestLoadFromFile()},n.prototype.getResourceNames=function(){var t,e=[];for(t in this._resources)this._resources.hasOwnProperty(t)&&e.push(t);return e},o.prototype=new e.AsyncResource,o.prototype.constructor=o,o.prototype.setToReady=function(){e.AsyncResource.prototype.setToReady.call(this),this._onResourceTypeLoadFunctionQueues={},this._onAnyResourceTypeLoadFunctionQueue=[],this._onResourceLoadFunctionQueue=[],this._numRequestedResources=0,this._numLoadedResources=0},o.prototype.executeOnResourceTypeLoad=function(t,e){this._onResourceTypeLoadFunctionQueues[t]=this._onResourceTypeLoadFunctionQueues[t]||[],this._onResourceTypeLoadFunctionQueues[t].push(e)},o.prototype.executeOnAnyResourceTypeLoad=function(t){this._onAnyResourceTypeLoadFunctionQueue.push(t)},o.prototype.executeOnResourceLoad=function(t){this._onResourceLoadFunctionQueue.push(t)},o.prototype.addResource=function(t,e){return this._resourceHolders[t]=this._resourceHolders[t]||new n(t),this._resourceHolders[t].addResource(e)},o.prototype._onResourceLoad=function(t,e){var i,n;for(n=this._onResourceLoadFunctionQueue,i=0;i<n.length;i++)n[i](e,t,this._numRequestedResources,this._numLoadedResources);if(this.allResourcesOfTypeAreLoaded(t))for(n=this._onResourceTypeLoadFunctionQueues[t]||[],i=0;i<n.length;i++)n[i]();this.allResourcesAreLoaded()&&this.setToReady()},o.prototype.getResource=function(e,i,n){var o;return(o=this._resourceHolders[e]?this._resourceHolders[e].getResource(i,n):null)?(n&&n.doNotLoad||o.requiresReload(n)&&(this._numRequestedResources++,this.resetReadyState(),o.request(n),o.executeWhenReady(function(){this._numLoadedResources++,this._onResourceLoad(e,i)}.bind(this))),o):(n.allowNullResult!==!0&&t.showError("Requested a resource named '"+i+"' of type '"+e+"', which does not exist."),null)},o.prototype.requestAllResources=function(){var t,e,i;for(t in this._resourceHolders)if(this._resourceHolders.hasOwnProperty(t))for(e=this._resourceHolders[t].getResourceNames(),i=0;i<e.length;i++)this.getResource(t,e[i])},o.prototype.allResourcesOfTypeAreLoaded=function(t){return this._resourceHolders[t].isReadyToUse()},o.prototype.allResourcesAreLoaded=function(){return this._numLoadedResources===this._numRequestedResources},o.prototype.requestConfigLoad=function(e,i,n,o){t.requestTextFile(i,e,function(t){this._loadConfigFromJSON(JSON.parse(t),n),o&&o()}.bind(this))},o.prototype._loadConfigFromJSON=function(t,e){var i,n,o;for(i in e)if(e.hasOwnProperty(i))for(n=t[i],o=0;o<n.length;o++)this.addResource(i,new e[i](n[o]))},o.prototype.requestResourceLoad=function(){var e;if(t.log("Requesting loading of resources contained in the resource manager...",2),this.allResourcesAreLoaded()===!0)t.log("There are no resources to load, executing set up callback queue right away...",2),this.executeOnReadyQueue();else for(e in this._resourceHolders)this._resourceHolders.hasOwnProperty(e)&&(t.log("Requesting the loading of "+e+" from files...",2),this._resourceHolders[e].requestResourceLoad())},o.prototype.getResourceNames=function(e){return this._resourceHolders[e]?this._resourceHolders[e].getResourceNames():(t.showError("Asked for the names of resources of type: '"+e+"', but no such resource type exists!"),null)},o.prototype.executeForAllResources=function(t){var e,i,n,o=Object.keys(this._resourceHolders);for(e=0;e<o.length;e++)for(n=this._resourceHolders[o[e]].getResourceNames(),i=0;i<n.length;i++)t(this._resourceHolders[o[e]].getResource(n[i]))},{GenericResource:i,ResourceManager:o}}),define("utils/vectors",[],function(){"use strict";var t={},e=.99999,i=1e-7;return t.NULL3=[0,0,0],Object.freeze(t.NULL3),t.NULL4=[0,0,0,0],Object.freeze(t.NULL4),t.UNIT3_X=[1,0,0],Object.freeze(t.UNIT3_X),t.UNIT3_Y=[0,1,0],Object.freeze(t.UNIT3_Y),t.UNIT3_Z=[0,0,1],Object.freeze(t.UNIT3_Z),t.fromXMLTag3=function(t){return[parseFloat(t.getAttribute("x")),parseFloat(t.getAttribute("y")),parseFloat(t.getAttribute("z"))]},t.perpendicular3=function(t){return[t[1],-t[0],0]},t.length2=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])},t.length3=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},t.length3Squared=function(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]},t.toString3=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)},t.toString4=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)+" "+t[3].toFixed(e)},t.getYawAndPitch=function(i){var n,o={};return Math.abs(i[2])>e?(o.yaw=0,o.pitch=i[2]>0?-Math.PI/2:Math.PI/2):(o.yaw=t.angle2uCapped([0,1],t.normal2([i[0],i[1]])),i[0]>0&&(o.yaw=-o.yaw),n=t.rotated2(i,-o.yaw),o.pitch=t.angle2uCapped([1,0],t.normal2([n[1],i[2]])),i[2]<0&&(o.pitch=-o.pitch)),o},t.getRollAndYaw=function(i,n){var o,r={};return Math.abs(i[1])>e?(r.roll=0,r.yaw=i[1]>0?0:Math.PI):(r.roll=t.angle2uCapped([1,0],t.normal2([i[0],i[2]])),i[2]<0&&(r.roll=-r.roll),o=t.rotated2([i[0],i[2]],-r.roll),r.yaw=t.angle2uCapped([0,1],t.normal2([o[0],i[1]])),!n&&Math.abs(r.roll)>Math.PI/2&&(r.yaw=-r.yaw,r.roll-=Math.PI*Math.sign(r.roll))),r},t.getRollAndPitch=function(i,n){var o,r={};return Math.abs(i[1])>e?(r.roll=0,r.pitch=i[1]>0?0:Math.PI):(r.roll=t.angle2uCapped([0,1],t.normal2([i[0],i[2]])),i[0]>0&&(r.roll=-r.roll),o=t.rotated2([i[0],i[2]],-r.roll),r.pitch=t.angle2uCapped([1,0],t.normal2([i[1],o[1]])),!n&&Math.abs(r.roll)>Math.PI/2&&(r.pitch=-r.pitch,r.roll-=Math.PI*Math.sign(r.roll))),r},t.vector4From3=function(t,e){return[t[0],t[1],t[2],e]},t.normal2=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]),i=0===e?1:1/e;return[t[0]*i,t[1]*i]},t.normal3=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),i=0===e?1:1/e;return[t[0]*i,t[1]*i,t[2]*i]},t.scaled2=function(t,e){return[t[0]*e,t[1]*e]},t.scaled3=function(t,e){return[t[0]*e,t[1]*e,t[2]*e]},t.scaled4=function(t,e){return[t[0]*e,t[1]*e,t[2]*e,t[3]*e]},t.rotated2=function(t,e){var i=Math.cos(e),n=Math.sin(e),o=[0,0];return o[0]=t[0]*i+t[1]*-n,o[1]=t[0]*n+t[1]*i,o},t.sum3=function(t,e){return[t[0]+e[0],t[1]+e[1],t[2]+e[2]]},t.sumArray3=function(t){var e,i=[0,0,0];for(e=0;e<t.length;e++)i[0]+=t[e][0],i[1]+=t[e][1],i[2]+=t[e][2];return i},t.diff3=function(t,e){return[t[0]-e[0],t[1]-e[1],t[2]-e[2]]},t.dot3=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},t.cross3=function(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]},t.angle2u=function(t,e){return Math.acos(t[0]*e[0]+t[1]*e[1])},t.angle2uCapped=function(t,e){return Math.acos(Math.min(Math.max(-1,t[0]*e[0]+t[1]*e[1]),1))},t.angle3u=function(t,e){return Math.acos(t[0]*e[0]+t[1]*e[1]+t[2]*e[2])},t.angle3uCapped=function(t,e){return Math.acos(Math.min(Math.max(-1,t[0]*e[0]+t[1]*e[1]+t[2]*e[2]),1))},t.mulVec3Mat3=function(t,e){return new Float32Array([e[0]*t[0]+e[3]*t[1]+e[6]*t[2],e[1]*t[0]+e[4]*t[1]+e[7]*t[2],e[2]*t[0]+e[5]*t[1]+e[8]*t[2]])},t.mulVec3Mat4=function(t,e){return new Float32Array([e[0]*t[0]+e[4]*t[1]+e[8]*t[2],e[1]*t[0]+e[5]*t[1]+e[9]*t[2],e[2]*t[0]+e[6]*t[1]+e[10]*t[2]])},t.mulVec4Mat4=function(t,e){return new Float32Array([e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12]*t[3],e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13]*t[3],e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14]*t[3],e[3]*t[0]+e[7]*t[1]+e[11]*t[2]+e[15]*t[3]])},t.mulMat3Vec3=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[1]+t[2]*e[2],t[3]*e[0]+t[4]*e[1]+t[5]*e[2],t[6]*e[0]+t[7]*e[1]+t[8]*e[2]])},t.mulMat4Vec3=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[1]+t[2]*e[2],t[4]*e[0]+t[5]*e[1]+t[6]*e[2],t[8]*e[0]+t[9]*e[1]+t[10]*e[2]])},t.mulMat4Vec4=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3],t[4]*e[0]+t[5]*e[1]+t[6]*e[2]+t[7]*e[3],t[8]*e[0]+t[9]*e[1]+t[10]*e[2]+t[11]*e[3],t[12]*e[0]+t[13]*e[1]+t[14]*e[2]+t[15]*e[3]])},t.negate2=function(t){t[0]=-t[0],t[1]=-t[1]},t.normalize2=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]),i=0===e?1:1/e;t[0]*=i,t[1]*=i},t.normalize3=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),i=0===e?1:1/e;t[0]*=i,t[1]*=i,t[2]*=i},t.normalize4D=function(t){t[3]=t[3]||i,t[0]/=t[3],t[1]/=t[3],t[2]/=t[3],t[3]=1},t.add3=function(t,e){t[0]+=e[0],t[1]+=e[1],t[2]+=e[2]},t.mulCross3=function(t,e){var i=t[0],n=t[1],o=t[2];t[0]=n*e[2]-o*e[1],t[1]=o*e[0]-i*e[2],t[2]=i*e[1]-n*e[0]},t.rotate2=function(t,e){var i=Math.cos(e),n=Math.sin(e),o=t[0];t[0]=t[0]*i+t[1]*-n,t[1]=o*n+t[1]*i},t}),define("modules/egom-model",["utils/vectors","modules/application"],function(t,e){"use strict";function i(t,e){this.x=t[0],this.y=t[1],this.z=t[2],e=e||[this.x,this.y],this.u=e[0],this.v=e[1]}function n(t,e,i,n){this.a=t,this.b=e,this.color=i,this.normal=n}function o(e,i,n,o,r,s,a,h){this._mesh=e,this.a=i,this.b=n,this.c=o,this.color=r,this.texCoords=s,this._normals=a||t.normal3(t.cross3(this._mesh.getVector(i,n),this._mesh.getVector(i,o))),this.groupIndices=h||[0,0]}function r(){this.bufferStartWireframe=0,this.bufferStartSolid=0,this.bufferStartTransparent=0}function s(){this._vertices=[],this._lines=[],this._triangles=[],this._size=0,this._maxX=0,this._minX=0,this._maxY=0,this._minY=0,this._maxZ=0,this._minZ=0,this._nOpaqueTriangles=0,this._nTransparentTriangles=0,this._contextProperties={},this._texCoords=[[0,1],[1,1],[1,0],[0,0]],this._currentGroupIndices=[0,0],this._nullVertex=new i([0,0,0])}function a(t,e,i,n,o,r){var s=[0,0];return s[0]=t+(i-t)*o,s[1]=e+(n-e)*r,s}function h(){this.wireframe=!1,this.solid=!1,this.minLOD=0,this.maxLOD=0}function l(){this._meshes=[],this._minLOD=this.LOD_NOT_SET,this._maxLOD=this.LOD_NOT_SET,this._editedMesh=null,this._minEditedLOD=0,this._maxEditedLOD=0,this._name=null,this._infoProperties={},this._scale=1,this._contextProperties={}}var u=["2.0","2.1","2.2","3.0"];return i.prototype.getTexCoords=function(){return[this.u,this.v]},i.prototype.setX=function(t){this.x=t},i.prototype.setY=function(t){this.y=t},i.prototype.setZ=function(t){this.z=t},o.prototype.getNormal=function(t){return this._normals[t]||this._normals[0]},s.prototype.getNumOpaqueTriangles=function(){return this._nOpaqueTriangles},s.prototype.getNumTransparentTriangles=function(){return this._nTransparentTriangles},s.prototype.getNumTriangles=function(t){return void 0===t?this._triangles.length:t?this._nTransparentTriangles:this._nOpaqueTriangles},s.prototype.resetMesh=function(){this.resetVertices(),this.resetLines(),this.resetTriangles()},s.prototype.resetVertices=function(){this._vertices=[],this._maxX=0,this._minX=0,this._maxY=0,this._minY=0,this._maxZ=0,this._minZ=0},s.prototype.setVertex=function(t,e){var i;if(this._vertices.length<t)for(i=this._vertices.length;t>i;i++)this._vertices[i]=this._nullVertex;this._vertices[t]=e,Math.abs(2*this._vertices[t].x)>this._size&&(this._size=Math.abs(2*this._vertices[t].x)),Math.abs(2*this._vertices[t].y)>this._size&&(this._size=Math.abs(2*this._vertices[t].y)),Math.abs(2*this._vertices[t].z)>this._size&&(this._size=Math.abs(2*this._vertices[t].z)),this._vertices[t].x>this._maxX&&(this._maxX=this._vertices[t].x),this._vertices[t].x<this._minX&&(this._minX=this._vertices[t].x),this._vertices[t].y>this._maxY&&(this._maxY=this._vertices[t].y),this._vertices[t].y<this._minY&&(this._minY=this._vertices[t].y),this._vertices[t].z>this._maxZ&&(this._maxZ=this._vertices[t].z),this._vertices[t].z<this._minZ&&(this._minZ=this._vertices[t].z)},s.prototype.appendVertex=function(t,e){this.setVertex(this._vertices.length,new i(t,e))},s.prototype.resetLines=function(){this._lines=[]},s.prototype.addLine=function(t){this._lines.push(t)},s.prototype.setLine=function(t,e){this._lines[t]=e},s.prototype.resetTriangles=function(){this._triangles=[],this._nOpaqueTriangles=0,this._nTransparentTriangles=0},s.prototype.getVector=function(t,e){return[this._vertices[e].x-this._vertices[t].x,this._vertices[e].y-this._vertices[t].y,this._vertices[e].z-this._vertices[t].z]},s.prototype.addTriangle=function(t,e){this._triangles.push(t),e||(this._lines.push(new n(t.a,t.b,t.color,t.getNormal(0))),this._lines.push(new n(t.b,t.c,t.color,t.getNormal(0))),this._lines.push(new n(t.c,t.a,t.color,t.getNormal(0)))),t.color[3]<1?this._nTransparentTriangles++:this._nOpaqueTriangles++},s.prototype.addTriangleWithParams=function(t,e,i,n){var r,s,a,h,l;return r=n.color||[1,1,1,1],s=n.useVertexTexCoords?[this._vertices[t].getTexCoords(),this._vertices[e].getTexCoords(),this._vertices[i].getTexCoords()]:n.texCoords||[this._texCoords[0],this._texCoords[1],this._texCoords[2]],a=n.normals,h=n.groupIndices||this._currentGroupIndices,l=new o(this,t,e,i,r,s,a,h),this.addTriangle(l,n.withoutLines),l},s.prototype.addQuad=function(t,e,i,o,r){var s,a,h,l;r=r||{},s=Object.create(r),s.withoutLines=!0,s.texCoords=r.useVertexTexCoords?[this._vertices[t].getTexCoords(),this._vertices[e].getTexCoords(),this._vertices[i].getTexCoords()]:r.texCoords?[r.texCoords[0],r.texCoords[1],r.texCoords[2]]:[this._texCoords[0],this._texCoords[1],this._texCoords[2]],s.normals=r.normals?4===r.normals.length?[r.normals[0],r.normals[1],r.normals[2]]:r.normals:null,this.addTriangleWithParams(t,e,i,s),a=Object.create(r),a.texCoords=r.useVertexTexCoords?[this._vertices[i].getTexCoords(),this._vertices[o].getTexCoords(),this._vertices[t].getTexCoords()]:r.texCoords?[r.texCoords[2],r.texCoords[3],r.texCoords[0]]:[this._texCoords[2],this._texCoords[3],this._texCoords[0]],a.normals=r.normals?4===r.normals.length?[r.normals[2],r.normals[3],r.normals[0]]:r.normals:null,this.addTriangleWithParams(i,o,t,a),r.withoutLines||(h=r.color||[1,1,1,1],l=r.normals?r.normals[0]:null,this._lines.push(new n(t,e,h,l)),this._lines.push(new n(e,i,h,l)),this._lines.push(new n(i,o,h,l)),this._lines.push(new n(o,t,h,l)))},s.prototype.getSize=function(){return this._size},s.prototype.getMaxX=function(){return this._maxX},s.prototype.getMinX=function(){return this._minX},s.prototype.getMaxY=function(){return this._maxY},s.prototype.getMinY=function(){return this._minY},s.prototype.getMaxZ=function(){return this._maxZ},s.prototype.getMinZ=function(){return this._minZ},s.prototype.getWidth=function(){return this._maxX-this._minX},s.prototype.getHeight=function(){return this._maxY-this._minY},s.prototype.getDepth=function(){return this._maxZ-this._minZ},s.prototype.getBufferData=function(t,e){var i,n,o,r,s,a,h,l,u,c,_,p;if(e=e||0,t===!0){for(o=this._lines.length,h=new Float32Array(6*o),i=0;o>i;i++)h[6*i]=this._vertices[this._lines[i].a].x,h[6*i+1]=this._vertices[this._lines[i].a].y,h[6*i+2]=this._vertices[this._lines[i].a].z,h[6*i+3]=this._vertices[this._lines[i].b].x,h[6*i+4]=this._vertices[this._lines[i].b].y,h[6*i+5]=this._vertices[this._lines[i].b].z;for(l=new Float32Array(4*o),i=0;o>i;i++)l[4*i]=0,l[4*i+1]=1,l[4*i+2]=1,l[4*i+3]=1;for(u=new Float32Array(6*o),i=0;o>i;i++)u[6*i]=this._lines[i].normal[0],u[6*i+1]=this._lines[i].normal[1],u[6*i+2]=this._lines[i].normal[2],u[6*i+3]=this._lines[i].normal[0],u[6*i+4]=this._lines[i].normal[1],u[6*i+5]=this._lines[i].normal[2];for(c=new Float32Array(8*o),i=0;o>i;i++)c[8*i]=this._lines[i].color[0],c[8*i+1]=this._lines[i].color[1],c[8*i+2]=this._lines[i].color[2],c[8*i+3]=1,c[8*i+4]=this._lines[i].color[0],c[8*i+5]=this._lines[i].color[1],c[8*i+6]=this._lines[i].color[2],c[8*i+7]=1;for(_=new Float32Array(4*o),i=0;o>i;i++)_[4*i]=0,_[4*i+1]=0,_[4*i+2]=0,_[4*i+3]=0;for(r=this._triangles.length,p=new Float32Array(3*r),i=0;r>i;i++)p[12*i]=0,p[12*i+1]=0,p[12*i+2]=0,p[12*i+3]=0,p[12*i+4]=0,p[12*i+5]=0,p[12*i+6]=0,p[12*i+7]=0,p[12*i+8]=0,p[12*i+9]=0,p[12*i+10]=0,p[12*i+11]=0}else{for(r=this._triangles.length,h=new Float32Array(9*r),i=0;r>i;i++)h[9*i]=this._vertices[this._triangles[i].a].x,h[9*i+1]=this._vertices[this._triangles[i].a].y,h[9*i+2]=this._vertices[this._triangles[i].a].z,h[9*i+3]=this._vertices[this._triangles[i].b].x,h[9*i+4]=this._vertices[this._triangles[i].b].y,h[9*i+5]=this._vertices[this._triangles[i].b].z,h[9*i+6]=this._vertices[this._triangles[i].c].x,h[9*i+7]=this._vertices[this._triangles[i].c].y,h[9*i+8]=this._vertices[this._triangles[i].c].z;for(l=new Float32Array(6*r),i=0;r>i;i++)l[6*i]=this._triangles[i].texCoords[0][0],l[6*i+1]=this._triangles[i].texCoords[0][1],l[6*i+2]=this._triangles[i].texCoords[1][0],l[6*i+3]=this._triangles[i].texCoords[1][1],l[6*i+4]=this._triangles[i].texCoords[2][0],l[6*i+5]=this._triangles[i].texCoords[2][1];for(u=new Float32Array(9*r),i=0;r>i;i++)u[9*i]=this._triangles[i].getNormal(0)[0],u[9*i+1]=this._triangles[i].getNormal(0)[1],u[9*i+2]=this._triangles[i].getNormal(0)[2],u[9*i+3]=this._triangles[i].getNormal(1)[0],u[9*i+4]=this._triangles[i].getNormal(1)[1],u[9*i+5]=this._triangles[i].getNormal(1)[2],u[9*i+6]=this._triangles[i].getNormal(2)[0],u[9*i+7]=this._triangles[i].getNormal(2)[1],u[9*i+8]=this._triangles[i].getNormal(2)[2];for(c=new Float32Array(12*r),i=0;r>i;i++)c[12*i]=this._triangles[i].color[0],c[12*i+1]=this._triangles[i].color[1],c[12*i+2]=this._triangles[i].color[2],c[12*i+3]=this._triangles[i].color[3],c[12*i+4]=this._triangles[i].color[0],c[12*i+5]=this._triangles[i].color[1],c[12*i+6]=this._triangles[i].color[2],c[12*i+7]=this._triangles[i].color[3],c[12*i+8]=this._triangles[i].color[0],c[12*i+9]=this._triangles[i].color[1],c[12*i+10]=this._triangles[i].color[2],c[12*i+11]=this._triangles[i].color[3];for(_=new Float32Array(6*r),i=0;r>i;i++)_[6*i]=this._triangles[i].groupIndices[0],_[6*i+1]=this._triangles[i].groupIndices[1],_[6*i+2]=this._triangles[i].groupIndices[0],_[6*i+3]=this._triangles[i].groupIndices[1],_[6*i+4]=this._triangles[i].groupIndices[0],_[6*i+5]=this._triangles[i].groupIndices[1];for(p=new Float32Array(12*r),i=0;r>i;i++){for(s=e+i,a=[],n=0;4>n;n++)a[n]=s%256/255,s=Math.floor(s/256);p[12*i]=a[0],p[12*i+1]=a[1],p[12*i+2]=a[2],p[12*i+3]=a[3],p[12*i+4]=a[0],p[12*i+5]=a[1],p[12*i+6]=a[2],p[12*i+7]=a[3],p[12*i+8]=a[0],p[12*i+9]=a[1],p[12*i+10]=a[2],p[12*i+11]=a[3]}}return{position:h,texCoord:l,normal:u,color:c,groupIndices:_,triangleIndex:p,dataSize:t?2*this._lines.length:3*this._triangles.length}},s.prototype.getBufferSize=function(t,e){return(t?2*this._lines.length:0)+(e?3*this._triangles.length:0)},s.prototype.loadToVertexBuffers=function(t,e,i,n){var o=null,s=0,a=this._contextProperties[t.getName()]||new r;return i&&(o=this.getBufferData(!0,e),a.bufferStartWireframe=e,t.setVertexBufferData(o,e),s+=o.dataSize,e+=o.dataSize),n&&(o=this.getBufferData(!1,e),a.bufferStartSolid=e,a.bufferStartTransparent=e+3*this._nOpaqueTriangles,t.setVertexBufferData(o,e),s+=o.dataSize,e+=o.dataSize),this._contextProperties[t.getName()]=a,s},s.prototype.render=function(t,e,i){var n=this._contextProperties[t.getName()];if(e===!0)t.gl.drawArrays(t.gl.LINES,n.bufferStartWireframe,2*this._lines.length);else switch(i){case!0:t.gl.drawArrays(t.gl.TRIANGLES,n.bufferStartSolid,3*this._nOpaqueTriangles);break;case!1:t.gl.drawArrays(t.gl.TRIANGLES,n.bufferStartTransparent,3*this._nTransparentTriangles);break;case void 0:t.gl.drawArrays(t.gl.TRIANGLES,n.bufferStartSolid,3*this._triangles.length)}},s.prototype.renderInstances=function(t,e,i,n){var o=this._contextProperties[t.getName()];if(e===!0)t.instancingExt.drawArraysInstancedANGLE(t.gl.LINES,o.bufferStartWireframe,2*this._lines.length,n);else switch(i){case!0:t.instancingExt.drawArraysInstancedANGLE(t.gl.TRIANGLES,o.bufferStartSolid,3*this._nOpaqueTriangles,n);break;case!1:t.instancingExt.drawArraysInstancedANGLE(t.gl.TRIANGLES,o.bufferStartTransparent,3*this._nTransparentTriangles,n);break;case void 0:t.instancingExt.drawArraysInstancedANGLE(t.gl.TRIANGLES,o.bufferStartSolid,3*this._triangles.length,n)}},s.prototype.addCuboid=function(e,i,n,o,r,s,a,h,l){var u,c,_,p;for(c=+this._vertices.length,this.appendVertex([e-o/2,i-r/2,n+s/2]),this.appendVertex([e+o/2,i-r/2,n+s/2]),this.appendVertex([e+o/2,i+r/2,n+s/2]),this.appendVertex([e-o/2,i+r/2,n+s/2]),this.appendVertex([e-o/2,i+r/2,n-s/2]),this.appendVertex([e+o/2,i+r/2,n-s/2]),this.appendVertex([e+o/2,i-r/2,n-s/2]),this.appendVertex([e-o/2,i-r/2,n-s/2]),this.appendVertex([e+o/2,i+r/2,n-s/2]),this.appendVertex([e-o/2,i+r/2,n-s/2]),this.appendVertex([e-o/2,i+r/2,n+s/2]),this.appendVertex([e+o/2,i+r/2,n+s/2]),this.appendVertex([e-o/2,i-r/2,n-s/2]),this.appendVertex([e+o/2,i-r/2,n-s/2]),this.appendVertex([e+o/2,i-r/2,n+s/2]),this.appendVertex([e-o/2,i-r/2,n+s/2]),this.appendVertex([e+o/2,i-r/2,n-s/2]),this.appendVertex([e+o/2,i+r/2,n-s/2]),this.appendVertex([e+o/2,i+r/2,n+s/2]),this.appendVertex([e+o/2,i-r/2,n+s/2]),this.appendVertex([e-o/2,i+r/2,n-s/2]),this.appendVertex([e-o/2,i-r/2,n-s/2]),this.appendVertex([e-o/2,i-r/2,n+s/2]),this.appendVertex([e-o/2,i+r/2,n+s/2]),_=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],p={color:a,texCoords:h},u=0;6>u;u++)p.normals=[_[u]],this.addQuad(c+4*u,c+4*u+1,c+4*u+2,c+4*u+3,p),l||(p.normals=[t.scaled3(_[u],-1)],this.addQuad(c+4*u+2,c+4*u+1,c+4*u,c+4*u+3,p))},s.prototype.addSphere=function(e,i,n,o,r,s,h,l){var u,c,_,p,d,g,f,m,y,T;for(u=0;r>u;u++)for(_=0;r>_;_++)this.appendVertex([e+o*Math.sin(2*_*Math.PI/r)*Math.cos(2*u*Math.PI/r),i+o*Math.cos(2*_*Math.PI/r),n+o*Math.sin(2*u*Math.PI/r)*Math.sin(2*_*Math.PI/r)]);for(c=this._vertices.length-r*r,r%2===1&&(this._vertices[c+(r+1)/2].setX(e),this._vertices[c+(r+1)/2].setZ(n)),u=0;r>u;u++)for(p=[c+u*r,c+(u+1)%r*r+1,c+u*r+1],d=a(h[0][0],h[0][1],h[2][0],h[2][1],1/(2*r)+u/r,1),g=a(h[0][0],h[0][1],h[2][0],h[2][1],(u+1)/r,1-2/r),f=a(h[0][0],h[0][1],h[2][0],h[2][1],u/r,1-2/r),m=[(this._vertices[p[0]].x-e)/o,(this._vertices[p[0]].y-i)/o,(this._vertices[p[0]].z-n)/o],y=[(this._vertices[p[1]].x-e)/o,(this._vertices[p[1]].y-i)/o,(this._vertices[p[1]].z-n)/o],T=[(this._vertices[p[2]].x-e)/o,(this._vertices[p[2]].y-i)/o,(this._vertices[p[2]].z-n)/o],this.addTriangleWithParams(p[0],p[1],p[2],{color:s,texCoords:[d,g,f],normals:[m,y,T]}),l!==!0&&this.addTriangleWithParams(p[0],p[2],p[1],{color:s,texCoords:[d,f,g],normals:[t.scaled3(m,-1),t.scaled3(T,-1),t.scaled3(y,-1)]}),p=r%2===0?[c+u*r+r/2,c+u*r+r/2-1,c+(u+1)%r*r+r/2-1]:[c+(r+1)/2,c+u*r+(r-1)/2,c+(u+1)%r*r+(r-1)/2],d=a(h[0][0],h[0][1],h[2][0],h[2][1],1/(2*r)+u/r,0),g=a(h[0][0],h[0][1],h[2][0],h[2][1],u/r,r%2===0?2/r:1/r),f=a(h[0][0],h[0][1],h[2][0],h[2][1],(u+1)/r,r%2===0?2/r:1/r),m=[(this._vertices[p[0]].x-e)/o,(this._vertices[p[0]].y-i)/o,(this._vertices[p[0]].z-n)/o],y=[(this._vertices[p[1]].x-e)/o,(this._vertices[p[1]].y-i)/o,(this._vertices[p[1]].z-n)/o],T=[(this._vertices[p[2]].x-e)/o,(this._vertices[p[2]].y-i)/o,(this._vertices[p[2]].z-n)/o],this.addTriangleWithParams(p[0],p[1],p[2],{color:s,texCoords:[d,g,f],normals:[m,y,T]}),l!==!0&&this.addTriangleWithParams(p[0],p[2],p[1],{color:s,texCoords:[d,f,g],normals:[t.scaled3(m,-1),t.scaled3(T,-1),t.scaled3(y,-1)]}),_=1;r/2-1>_;_++)p=[c+u*r+_,c+(u+1)%r*r+_+1,c+u*r+_+1],d=a(h[0][0],h[0][1],h[2][0],h[2][1],u/r,1-2*_/r),g=a(h[0][0],h[0][1],h[2][0],h[2][1],(u+1)/r,1-2*(_+1)/r),f=a(h[0][0],h[0][1],h[2][0],h[2][1],u/r,1-2*(_+1)/r),m=[(this._vertices[p[0]].x-e)/o,(this._vertices[p[0]].y-i)/o,(this._vertices[p[0]].z-n)/o],y=[(this._vertices[p[1]].x-e)/o,(this._vertices[p[1]].y-i)/o,(this._vertices[p[1]].z-n)/o],
T=[(this._vertices[p[2]].x-e)/o,(this._vertices[p[2]].y-i)/o,(this._vertices[p[2]].z-n)/o],this.addTriangleWithParams(p[0],p[1],p[2],{color:s,texCoords:[d,g,f],normals:[m,y,T]}),l!==!0&&this.addTriangleWithParams(p[0],p[2],p[1],{color:s,texCoords:[d,f,g],normals:[t.scaled3(m,-1),t.scaled3(T,-1),t.scaled3(y,-1)]}),p=[c+(u+1)%r*r+_+1,c+u*r+_,c+(u+1)%r*r+_],d=a(h[0][0],h[0][1],h[2][0],h[2][1],(u+1)/r,1-2*(_+1)/r),g=a(h[0][0],h[0][1],h[2][0],h[2][1],u/r,1-2*_/r),f=a(h[0][0],h[0][1],h[2][0],h[2][1],(u+1)/r,1-2*_/r),m=[(this._vertices[p[0]].x-e)/o,(this._vertices[p[0]].y-i)/o,(this._vertices[p[0]].z-n)/o],y=[(this._vertices[p[1]].x-e)/o,(this._vertices[p[1]].y-i)/o,(this._vertices[p[1]].z-n)/o],T=[(this._vertices[p[2]].x-e)/o,(this._vertices[p[2]].y-i)/o,(this._vertices[p[2]].z-n)/o],this.addTriangleWithParams(p[0],p[1],p[2],{color:s,texCoords:[d,g,f],normals:[m,y,T]}),l!==!0&&this.addTriangleWithParams(p[0],p[2],p[1],{color:s,texCoords:[d,f,g],normals:[t.scaled3(m,-1),t.scaled3(T,-1),t.scaled3(y,-1)]})},l.prototype.LOD_NOT_SET=-1,l.prototype.getName=function(){return this._name},l.prototype.setName=function(t){this._name=t},l.prototype.getMinLOD=function(){return this._minLOD},l.prototype.getMaxLOD=function(){return this._maxLOD},l.prototype.getClosestAvailableLOD=function(t){return Math.min(Math.max(this.getMinLOD(),t),this.getMaxLOD())},l.prototype.updateLODInfo=function(t,e){this._minLOD=this._minLOD===this.LOD_NOT_SET?t:t<this._minLOD?t:this._minLOD,this._maxLOD=this._maxLOD===this.LOD_NOT_SET?e:e>this._maxLOD?e:this._maxLOD},l.prototype.getMeshWithLOD=function(t){var e;for(e=this._meshes.length;t>=e;e++)this._meshes.push(new s);return this._meshes[t]},l.prototype.startEditingMeshWithLOD=function(t){this._editedMesh=this.getMeshWithLOD(t),this._minEditedLOD=t,this._maxEditedLOD=t},l.prototype.getCurrentlyEditedMesh=function(){return this._editedMesh},l.prototype.setMinimumEditedLOD=function(t){this._minEditedLOD=t,this._editedMesh=this._minEditedLOD===this._maxEditedLOD?this.getMeshWithLOD(t):null},l.prototype.setMaximumEditedLOD=function(t){this._maxEditedLOD=t,this._editedMesh=this._minEditedLOD===this._maxEditedLOD?this.getMeshWithLOD(t):null},l.prototype.loadFromXML=function(t,o,r){var s,a,h,l,c,_,p,d,g,f,m,y,T,S,M,x,E,b,A,O,R,v,C,I,L,N=null,w=null,D=null,F=null,V=function(t,e){var i;if(null===N){for(i=t;e>=i;i++)this.getMeshWithLOD(i).resetMesh();N=t,w=e}else{for(i=t;N>i;i++)this.getMeshWithLOD(i).resetMesh();for(i=w+1;e>=i;i++)this.getMeshWithLOD(i).resetMesh();N=N>t?t:N,w=e>w?e:w}}.bind(this),P=function(t){return t.split(",").map(parseFloat)};if(r=r||0,e.log("Loading EgomModel data from file: "+t+" ...",2),!(o instanceof Document))return e.showError("'"+t+"' does not appear to be an XML document.",e.ErrorSeverity.SEVERE,"A model was supposed to be loaded from this file, but only models of EgomModel format are accepted. Such a file needs to be a valid XML document with an EgomModel root element or a valid JSON file."),!1;if("EgomModel"!==o.documentElement.nodeName)return e.showError("'"+t+"' does not appear to be an EgomModel file.",e.ErrorSeverity.SEVERE,"A model was supposed to be loaded from this file, but only models of EgomModel format are accepted. Such a file needs to have an EgomModel as root element, while this file has '"+o.documentElement.nodeName+"' instead."),!1;if(p=o.documentElement.getAttribute("version"),!p)return e.showError("Model from file: '"+t+"' could not be loaded, because the file version could not have been determined.",e.ErrorSeverity.SEVERE),!1;if(u.indexOf(p)<0)return e.showError("Model from file: '"+t+"' could not be loaded, because the version of the file ("+p+") is not supported.",e.ErrorSeverity.SEVERE,"Supported versions are: "+u.join(", ")+"."),!1;if(this._name=null,this._scale=1,d=null,this._infoProperties={},o.getElementsByTagName("info").length>0)for(g=o.getElementsByTagName("info")[0].getElementsByTagName("property"),s=0;s<g.length;s++)switch(f=g[s].getAttribute("name")){case"name":this._name=g[s].getAttribute("value");break;case"scale":this._scale=g[s].getAttribute("value");break;case"defaultLOD":m=g[s].getAttribute("value").split("-"),D=parseInt(m[0],10),F=parseInt(m[1],10);break;case"colorPalette":d=g[s].getAttribute("value").split(" ").map(P);break;default:this._infoProperties[f]=g[s].getAttribute("value")}switch("2.0"===p&&(this._scale=10*parseFloat(this._infoProperties["size of one unit in mm"])),y=null,T=null,S=null,p){case"2.0":y="vertex",T="line",S="triangle";break;case"2.1":case"2.2":y="v",T="l",S="t"}for(x=o.getElementsByTagName(y),E=x.length,s=0;E>s;s++)for(v=parseInt(x[s].getAttribute("i"),10),l=null===D?r:D,c=null===F?r:F,x[s].hasAttribute("lod")&&(_=x[s].getAttribute("lod").split("-"),l=parseInt(_[0],10),c=parseInt(_[1],10)),this.updateLODInfo(l,c),V(l,c),C=new i(parseFloat(p)>=2.1?[parseFloat(x[s].getAttribute("x")),parseFloat(x[s].getAttribute("y")),parseFloat(x[s].getAttribute("z"))]:[parseFloat(x[s].getAttribute("x"))/1e4,parseFloat(x[s].getAttribute("y"))/-1e4,parseFloat(x[s].getAttribute("z"))/-1e4]),a=l;c>=a;a++)this.getMeshWithLOD(a).setVertex(v,C);for(e.log("Loaded "+E+" vertices.",3),b=o.getElementsByTagName(T),A=b.length,s=0;A>s;s++)for(l=null===D?r:D,c=null===F?r:F,b[s].hasAttribute("lod")&&(_=b[s].getAttribute("lod").split("-"),l=parseInt(_[0],10),c=parseInt(_[1],10)),this.updateLODInfo(l,c),V(l,c),I=new n(parseInt(b[s].getAttribute("a"),10),parseInt(b[s].getAttribute("b"),10),parseFloat(p)>=2.1?d?d[parseInt(b[s].getAttribute("color"),10)]:b[s].getAttribute("color").split(",").map(parseFloat):[parseInt(b[s].getAttribute("red"),10)/255,parseInt(b[s].getAttribute("green"),10)/255,parseInt(b[s].getAttribute("blue"),10)/255],parseFloat(p)>=2.1?b[s].getAttribute("n").split(",").map(parseFloat):[parseFloat(b[s].getAttribute("nx")),-parseFloat(b[s].getAttribute("ny")),-parseFloat(b[s].getAttribute("nz"))]),a=l;c>=a;a++)this.getMeshWithLOD(a).addLine(I);for(e.log("Loaded "+A+" lines.",3),O=o.getElementsByTagName(S),R=O.length,M={},s=0;R>s;s++)for(l=null===D?r:D,c=null===F?r:F,O[s].hasAttribute("lod")&&(_=O[s].getAttribute("lod").split("-"),l=parseInt(_[0],10),c=parseInt(_[1],10)),this.updateLODInfo(l,c),V(l,c),M.color=parseFloat(p)>=2.1?d?d[parseInt(O[s].getAttribute("color"),10)]:O[s].getAttribute("color").split(",").map(parseFloat):[parseInt(O[s].getAttribute("red"),10)/255,parseInt(O[s].getAttribute("green"),10)/255,parseInt(O[s].getAttribute("blue"),10)/255,(255-parseInt(O[s].getAttribute("alpha"),10))/255],M.texCoords=parseFloat(p)>=2.1?[O[s].getAttribute("ta").split(",").map(parseFloat),O[s].getAttribute("tb").split(",").map(parseFloat),O[s].getAttribute("tc").split(",").map(parseFloat)]:[[parseFloat(O[s].getAttribute("tax")),parseFloat(O[s].getAttribute("tay"))],[parseFloat(O[s].getAttribute("tbx")),parseFloat(O[s].getAttribute("tby"))],[parseFloat(O[s].getAttribute("tcx")),parseFloat(O[s].getAttribute("tcy"))]],M.normals=parseFloat(p)>=2.1?O[s].hasAttribute("n")?[O[s].getAttribute("n").split(",").map(parseFloat)]:[O[s].getAttribute("na").split(",").map(parseFloat),O[s].getAttribute("nb").split(",").map(parseFloat),O[s].getAttribute("nc").split(",").map(parseFloat)]:[[parseFloat(O[s].getAttribute("nax"))/1e4,-parseFloat(O[s].getAttribute("nay"))/1e4,-parseFloat(O[s].getAttribute("naz"))/1e4],[parseFloat(O[s].getAttribute("nbx"))/1e4,-parseFloat(O[s].getAttribute("nby"))/1e4,-parseFloat(O[s].getAttribute("nbz"))/1e4],[parseFloat(O[s].getAttribute("ncx"))/1e4,-parseFloat(O[s].getAttribute("ncy"))/1e4,-parseFloat(O[s].getAttribute("ncz"))/1e4]],M.groupIndices=O[s].hasAttribute("groups")?O[s].getAttribute("groups"):null,M.withoutLines=!0,L=null,a=l;c>=a;a++)L?this.getMeshWithLOD(a).addTriangle(L,M.withoutLines):L=this.getMeshWithLOD(a).addTriangleWithParams(O[s].getAttribute("a"),O[s].getAttribute("b"),O[s].getAttribute("c"),M);for(e.log("Loaded "+O.length+" triangles.",3),e.log("Model loaded: "+this._name+". Details: "+this._minLOD+"-"+this._maxLOD,2),h="Number of triangles per LOD for "+this._name+": ",s=this._minLOD;s<=this._maxLOD;s++)h+=" ["+s+"]: "+this.getMeshWithLOD(s).getNumTriangles();return e.log(h,2),!0},l.prototype.loadFromJSON=function(t,o,r){var s,a,h,l,c,_,p,d,g,f,m,y,T,S,M,x=null,E=null,b=null,A=null,O=function(t,e){var i;if(null===x){for(i=t;e>=i;i++)this.getMeshWithLOD(i).resetMesh();x=t,E=e}else{for(i=t;x>i;i++)this.getMeshWithLOD(i).resetMesh();for(i=E+1;e>=i;i++)this.getMeshWithLOD(i).resetMesh();x=x>t?t:x,E=e>E?e:E}}.bind(this);if(r=r||0,e.log("Loading EgomModel data from file: "+t+" ...",2),"object"!=typeof o)return e.showError("'"+t+"' does not appear to be an JSON file.",e.ErrorSeverity.SEVERE,"A model was supposed to be loaded from this file, but only models of EgomModel format are accepted. Such a file needs to be a valid XML document with an EgomModel root element or a valid JSON file."),!1;if(_=o.version,!_)return e.showError("Model from file: '"+t+"' could not be loaded, because the file version could not have been determined.",e.ErrorSeverity.SEVERE),!1;if(u.indexOf(_)<0)return e.showError("Model from file: '"+t+"' could not be loaded, because the version of the file ("+_+") is not supported.",e.ErrorSeverity.SEVERE,"Supported versions are: "+u.join(", ")+"."),!1;for(p=null,this._infoProperties=o.info||{},this._name=o.info.name||null,this._scale=o.info.scale||1,b=o.info.defaultLOD[0],A=o.info.defaultLOD[1],p=o.info.colorPalette,g=o.vertices.length,s=0;g>s;s++)for(y=o.vertices[s].i,l=null===b?r:b,c=null===A?r:A,l=o.vertices[s].lod?o.vertices[s].lod[0]:l,c=o.vertices[s].lod?o.vertices[s].lod[1]:c,this.updateLODInfo(l,c),O(l,c),T=new i(o.vertices[s].p),a=l;c>=a;a++)this.getMeshWithLOD(a).setVertex(y,T);for(e.log("Loaded "+g+" vertices.",3),f=o.lines.length,s=0;f>s;s++)for(l=null===b?r:b,c=null===A?r:A,l=o.lines[s].lod?o.lines[s].lod[0]:l,c=o.lines[s].lod?o.lines[s].lod[1]:c,this.updateLODInfo(l,c),O(l,c),S=new n(o.lines[s].a,o.lines[s].b,p?p[o.lines[s].color]:o.lines[s].color,o.lines[s].lum||0,o.lines[s].n),a=l;c>=a;a++)this.getMeshWithLOD(a).addLine(S);for(e.log("Loaded "+f+" lines.",3),m=o.triangles.length,d={},s=0;m>s;s++)for(l=null===b?r:b,c=null===A?r:A,l=o.triangles[s].lod?o.triangles[s].lod[0]:l,c=o.triangles[s].lod?o.triangles[s].lod[1]:c,this.updateLODInfo(l,c),O(l,c),d.color=p?p[o.triangles[s].color]:o.triangles[s].color,d.texCoords=o.triangles[s].t,d.normals=o.triangles[s].n,d.groupIndices=void 0!==o.triangles[s].groups?o.triangles[s].groups:null,d.withoutLines=!0,M=null,a=l;c>=a;a++)M?this.getMeshWithLOD(a).addTriangle(M,d.withoutLines):M=this.getMeshWithLOD(a).addTriangleWithParams(o.triangles[s].a,o.triangles[s].b,o.triangles[s].c,d);for(e.log("Loaded "+m+" triangles.",3),e.log("Model loaded: "+this._name+". Details: "+this._minLOD+"-"+this._maxLOD,2),h="Number of triangles per LOD for "+this._name+": ",s=this._minLOD;s<=this._maxLOD;s++)h+=" ["+s+"]: "+this.getMeshWithLOD(s).getNumTriangles();return e.log(h,2),!0},l.prototype.getScale=function(){return this._scale},l.prototype._getLargestValueOfMeshes=function(t,e){var i,n;if(void 0!==t)return e(this.getMeshWithLOD(t));for(t=this._minLOD;t<this._maxLOD;t++)n=e(this.getMeshWithLOD(t)),(void 0===i||n>i)&&(i=n);return i},l.prototype._getLowestValueOfMeshes=function(t,e){var i,n;if(void 0!==t)return e(this.getMeshWithLOD(t));for(t=this._minLOD;t<this._maxLOD;t++)n=e(this.getMeshWithLOD(t)),(void 0===i||i>n)&&(i=n);return i},l.prototype.getSize=function(t){return this._getLargestValueOfMeshes(t,function(t){return t.getSize()})},l.prototype.getMaxX=function(t){return this._getLargestValueOfMeshes(t,function(t){return t.getMaxX()})},l.prototype.getMinX=function(t){return this._getLowestValueOfMeshes(t,function(t){return t.getMinX()})},l.prototype.getMaxY=function(t){return this._getLargestValueOfMeshes(t,function(t){return t.getMaxY()})},l.prototype.getMinY=function(t){return this._getLowestValueOfMeshes(t,function(t){return t.getMinY()})},l.prototype.getMaxZ=function(t){return this._getLargestValueOfMeshes(t,function(t){return t.getMaxZ()})},l.prototype.getMinZ=function(t){return this._getLowestValueOfMeshes(t,function(t){return t.getMinZ()})},l.prototype.getWidth=function(t){return this._getLargestValueOfMeshes(t,function(t){return t.getWidth()})},l.prototype.getHeight=function(t){return this._getLargestValueOfMeshes(t,function(t){return t.getHeight()})},l.prototype.getDepth=function(t){return this._getLargestValueOfMeshes(t,function(t){return t.getDepth()})},l.prototype.getWidthInMeters=function(t){return t=void 0!==t?t:this._minLOD,this.getWidth(t)*this._scale},l.prototype.getHeightInMeters=function(t){return t=void 0!==t?t:this._minLOD,this.getHeight(t)*this._scale},l.prototype.getDepthInMeters=function(t){return t=void 0!==t?t:this._minLOD,this.getDepth(t)*this._scale},l.prototype.getNumOpaqueTriangles=function(t){return t=void 0!==t?t:this._minLOD,this.getMeshWithLOD(t).getNumOpaqueTriangles()},l.prototype.getNumTransparentTriangles=function(t){return t=void 0!==t?t:this._minLOD,this.getMeshWithLOD(t).getNumTransparentTriangles()},l.prototype.getNumTriangles=function(t,e){return t=void 0!==t?t:this._minLOD,this.getMeshWithLOD(t).getNumTriangles(e)},l.prototype.addToContext=function(t,i){this._minLOD=this._minLOD!==this.LOD_NOT_SET?this._minLOD:0,this._maxLOD=this._maxLOD!==this.LOD_NOT_SET?this._maxLOD:0;var n=this._contextProperties[t.getName()];n?(!n.wireframe&&i&&(e.log("Adding model ("+this._name+") to context in wireframe mode)...",2),n.wireframe=!0,t.resetReadyState()),n.solid||i||(e.log("Adding model ("+this._name+") to context in solid mode)...",2),n.solid=!0,t.resetReadyState()),n.minLOD>this._minLOD&&(e.log("Adding model ("+this._name+") to context with minimum LOD "+this._minLOD+"...",2),n.minLOD=this._minLOD,t.resetReadyState()),n.maxLOD<this._maxLOD&&(e.log("Adding model ("+this._name+") to context with maximum LOD "+this._maxLOD+"...",2),n.maxLOD=this._maxLOD,t.resetReadyState())):(e.log("Adding model ("+this._name+") to context ("+(i?"wireframe":"solid")+" mode)...",2),n=new h,n.wireframe=i,n.solid=!i,n.minLOD=this._minLOD,n.maxLOD=this._maxLOD,t.addModel(this)),this._contextProperties[t.getName()]=n},l.prototype.clearContextBindings=function(){var t;for(t in this._contextProperties)this._contextProperties.hasOwnProperty(t)&&delete this._contextProperties[t]},l.prototype.getBufferData=function(t,e,i){return i=void 0!==i?i:this._minLOD,this.getMeshWithLOD(i).getBufferData(t,e)},l.prototype.getBufferSize=function(t){var e,i=this._contextProperties[t.getName()],n=0;for(e=i.minLOD;e<=i.maxLOD;e++)n+=this.getMeshWithLOD(e).getBufferSize(i.wireframe,i.solid);return n},l.prototype.loadToVertexBuffers=function(t,e,i){i=void 0!==i?i:this._minLOD;var n=this._contextProperties[t.getName()];return this.getMeshWithLOD(i).loadToVertexBuffers(t,e,n.wireframe,n.solid)},l.prototype.render=function(t,e,i,n){n=void 0!==n?n:this._minLOD,this.getMeshWithLOD(n).render(t,e,i)},l.prototype.renderInstances=function(t,e,i,n,o){n=void 0!==n?n:this._minLOD,this.getMeshWithLOD(n).renderInstances(t,e,i,o)},l.prototype.appendVertex=function(t,e){var i;if(this._editedMesh)this._editedMesh.appendVertex(t,e);else for(i=this._minEditedLOD;i<=this._maxEditedLOD;i++)this.getMeshWithLOD(i).appendVertex(t,e)},l.prototype.addLine=function(t){var e;if(this._editedMesh)this._editedMesh.addLine(t);else for(e=this._minEditedLOD;e<=this._maxEditedLOD;e++)this.getMeshWithLOD(e).addLine(t)},l.prototype.addQuad=function(t,e,i,n,o){var r;if(this._editedMesh)this._editedMesh.addQuad(t,e,i,n,o);else for(r=this._minEditedLOD;r<=this._maxEditedLOD;r++)this.getMeshWithLOD(r).addQuad(t,e,i,n,o)},l.prototype.addCuboid=function(t,e,i,n,o,r,s,a,h){var l;if(this._editedMesh)this._editedMesh.addCuboid(t,e,i,n,o,r,s,a,h);else for(l=this._minEditedLOD;l<=this._maxEditedLOD;l++)this.getMeshWithLOD(l).addCuboid(t,e,i,n,o,r,s,a,h)},{Model:l,fvqModel:function(t){var e=new l;return t&&e.setName(t),e.appendVertex([-1,-1,0]),e.appendVertex([1,-1,0]),e.appendVertex([1,1,0]),e.appendVertex([-1,1,0]),e.addQuad(0,1,2,3),e},squareModel:function(t){var e=new l;return t&&e.setName(t),e.appendVertex([-1,-1,0]),e.appendVertex([1,-1,0]),e.appendVertex([1,1,0]),e.appendVertex([-1,1,0]),e.addQuad(0,1,2,3),e.addQuad(2,1,0,3,{texCoords:[[0,1],[1,1],[1,0],[0,0]]}),e},turningBillboardModel:function(t,e,i){var n,o=.5-.5*i,r=.5+.5*i,s=.75-.25*i,a=.75+.25*i,h=new l;if(t&&h.setName(t),h.appendVertex([-i,-1,0]),h.appendVertex([i,-1,0]),h.appendVertex([i,1,0]),h.appendVertex([-i,1,0]),h.addQuad(0,1,2,3,{texCoords:[[o,.5],[r,.5],[r,0],[o,0]]}),e)for(n=0;n<e.length;n++)h.appendVertex([i,e[n],-i]),h.appendVertex([-i,e[n],-i]),h.appendVertex([-i,e[n],i]),h.appendVertex([i,e[n],i]),h.addQuad(4*(n+1),4*(n+1)+1,4*(n+1)+2,4*(n+1)+3,{texCoords:[[o,a],[r,a],[r,s],[o,s]]}),h.addQuad(4*(n+1)+3,4*(n+1)+2,4*(n+1)+1,4*(n+1),{texCoords:[[o,a],[r,a],[r,s],[o,s]]});return h},cuboidModel:function(t,e,i,n,o){var r=new l;return t&&r.setName(t),r.addCuboid(0,0,0,e,i,n,o,[[0,1],[1,1],[1,0],[0,0]],!1),r},lineModel:function(t,e,i){var o=new l;return t&&o.setName(t),o.appendVertex([0,0,0]),o.appendVertex(e),o.addLine(new n(0,1,i,e)),o}}}),define("modules/graphics-resources",["utils/utils","utils/types","modules/application","modules/resource-manager","modules/managed-gl","modules/egom-model"],function(t,e,i,n,o,r){"use strict";function s(t){n.GenericResource.call(this,t.name),this._basepath=t.basepath,this._format=t.format,this._useMipmap=t.useMipmap===!0,this._typeSuffixes=t.typeSuffixes,this._qualitySuffixes=t.qualitySuffixes,this._loadedImages=0,this._imagesToLoad=0,this._images={},this._managedTextures={},this._cachedManagedTexturesOfTypes=[]}function a(t){n.GenericResource.call(this,t.name),this._basepath=t.basepath,this._format=t.format,this._imageNames=t.imageNames,this._qualitySuffixes=t.qualitySuffixes,this._loadedImages=0,this._imagesToLoad=0,this._images={},this._cachedManagedCubemaps=[]}function h(t){n.GenericResource.call(this,t.name),this._variantShaderNames=t.variants||null,this._vertexShaderSourcePath=t.vertexShaderSource,this._fragmentShaderSourcePath=t.fragmentShaderSource,this._blendMode=e.getEnumValue(o.ShaderBlendMode,t.blendMode,{name:"shader.blendMode"}),this._vertexAttributeRoles=t.vertexAttributeRoles,this._instanceAttributeRoles=t.instanceAttributeRoles||{},this._vertexShaderSource=null,this._fragmentShaderSource=null,this._managedShaderBindings=[],this._shaderIncludesToLoad=0,this._shaderIncludesLoaded=0}function l(t){return n.GenericResource.call(this,t.name),t.model?(this._model=t.model,this._files=[],void this.setToReady()):(this._basepath=t.basepath,this._format=t.format,this._files=t.files,this._loadedFiles=0,this._filesToLoad=0,this._model=null,void(this._maxLoadedLOD=-1))}function u(){n.ResourceManager.call(this)}function c(t,e){var i={};i[d]=s,i[g]=a,i[f]=h,i[m]=l,_.requestConfigLoad(t.filename,t.folder,i,e)}var _,p={VERTEX:"vertex",FRAGMENT:"fragment"},d="textures",g="cubemaps",f="shaders",m="models",y="texture",T="texture",S="shader",M="model",x='#include "',E='"',b={};return Object.freeze(p),s.prototype=new n.GenericResource,s.prototype.constructor=s,s.prototype._getPath=function(t,e){return this._basepath+this._typeSuffixes[t]+this._qualitySuffixes[e]+"."+this._format},s.prototype._getOnLoadImageFunction=function(t,e){var i=this._getPath(t,e);return function(){this._loadedImages++,this._onFilesLoad(this._loadedImages===this._imagesToLoad,{path:i})}.bind(this)},s.prototype.requiresReload=function(t){var e,i,n,o;if(this.isRequested(t))return!1;t=t||{},e=t.types||this._typeSuffixes,n=t.qualities||this._qualitySuffixes;for(i in e)if(e.hasOwnProperty(i)){if(!this._images[i])return!0;for(o in n)if(n.hasOwnProperty(o)&&!this._images[i][o])return!0}return!1},s.prototype._requestFiles=function(t){var e,n,o,r;t=t||{},e=t.types||this._typeSuffixes,o=t.qualities||this._qualitySuffixes;for(n in e)if(e.hasOwnProperty(n)){this._images[n]=this._images[n]||{};for(r in o)o.hasOwnProperty(r)&&(this._images[n][r]||(this._imagesToLoad++,this._images[n][r]=new Image,this._images[n][r].onload=this._getOnLoadImageFunction(n,r).bind(this)))}for(n in e)if(e.hasOwnProperty(n))for(r in o)o.hasOwnProperty(r)&&(this._images[n][r].src||(this._images[n][r].src=i.getFileURL(y,this._getPath(n,r))))},s.prototype._loadData=function(t){i.log("Texture from file: "+t.path+" has been loaded.",2)},s.prototype.getTypes=function(){var t,e=[];for(t in this._typeSuffixes)this._typeSuffixes.hasOwnProperty(t)&&e.push(t);return e},s.prototype.getQualities=function(){var t,e=[];for(t in this._qualitySuffixes)this._qualitySuffixes.hasOwnProperty(t)&&e.push(t);return e},s.prototype.getManagedTexture=function(t,e){return this.isReadyToUse()===!1?(i.showError("Cannot get managed GL texture for '"+this.getName()+"', as it has not been loaded from file yet!"),null):this._images[t]?(this._managedTextures[t]=this._managedTextures[t]||{},this._managedTextures[t][e]=this._managedTextures[t][e]||new o.ManagedTexture(this.getName(),this._images[t][e],this._useMipmap),this._managedTextures[t][e]):(i.showError("The requested texture '"+this.getName()+"' has no type '"+t+"' available!"),null)},s.prototype.getManagedTexturesOfTypes=function(e,n){var o,r,s,a,h,l;for(e.sort(),o=0;o<this._cachedManagedTexturesOfTypes.length;o++)if(t.arraysEqual(e,this._cachedManagedTexturesOfTypes[o].types)&&t.arraysEqual(n,this._cachedManagedTexturesOfTypes[o].qualityPreferenceList))return this._cachedManagedTexturesOfTypes[o].textures;for(l={},r=this.getQualities(),h=-1,o=0;o<r.length;o++)s=n.indexOf(r[o]),s>=0&&(-1===h||h>s)&&(h=s,a=n[s]);if(-1===h)return i.showError("Texture '"+this.getName()+"' is not available in any of the qualities: ["+n.join(", ")+"]!"),null;for(o=0;o<e.length;o++)l[e[o]]=this.getManagedTexture(e[o],a);return this._cachedManagedTexturesOfTypes.push({types:e,qualityPreferenceList:n,textures:l}),l},s.prototype.getManagedTextures=function(t){return this.getManagedTexturesOfTypes(this.getTypes(),t)},a.prototype=new n.GenericResource,a.prototype.constructor=a,a.prototype._getPath=function(t,e){return this._basepath+this._imageNames[t]+this._qualitySuffixes[e]+"."+this._format},a.prototype._getOnLoadImageFunction=function(t,e){var i=this._getPath(t,e);return function(){this._loadedImages++,this._onFilesLoad(this._loadedImages===this._imagesToLoad,{path:i})}.bind(this)},a.prototype.requiresReload=function(t){var e,i,n;if(this.isRequested(t))return!1;t=t||{},i=t.qualities||this._qualitySuffixes;for(e in this._imageNames)if(this._imageNames.hasOwnProperty(e)){if(!this._images[e])return!0;for(n in i)if(i.hasOwnProperty(n)&&!this._images[e][n])return!0}return!1},a.prototype._requestFiles=function(t){var e,n,o;t=t||{},n=t.qualities||this._qualitySuffixes;for(e in this._imageNames)if(this._imageNames.hasOwnProperty(e)){this._images[e]=this._images[e]||{};for(o in n)n.hasOwnProperty(o)&&(this._images[e][o]||(this._imagesToLoad++,this._images[e][o]=new Image,this._images[e][o].onload=this._getOnLoadImageFunction(e,o).bind(this)))}for(e in this._imageNames)if(this._imageNames.hasOwnProperty(e))for(o in n)n.hasOwnProperty(o)&&(this._images[e][o].src||(this._images[e][o].src=i.getFileURL(T,this._getPath(e,o))))},a.prototype._loadData=function(){i.log("Cubemap named '"+this.getName()+"' has been loaded.",2)},a.prototype.getQualities=function(){var t,e=[];for(t in this._qualitySuffixes)this._qualitySuffixes.hasOwnProperty(t)&&e.push(t);return e},a.prototype.getManagedCubemap=function(e){var n,r,s,a,h,l;if(this.isReadyToUse()===!1)return i.showError("Cannot get managed GL cubemap for '"+this.getName()+"', as it has not been loaded from file yet!"),null;for(n=0;n<this._cachedManagedCubemaps.length;n++)if(t.arraysEqual(e,this._cachedManagedCubemaps[n].qualityPreferenceList))return this._cachedManagedCubemaps[n].cubemap;for(s=this.getQualities(),l=-1,n=0;n<s.length;n++)a=e.indexOf(s[n]),a>=0&&(-1===l||l>a)&&(l=a,h=e[a]);return-1===l?(i.showError("Cubemap '"+this.getName()+"' is not available in any of the qualities: ["+e.join(", ")+"]!"),null):(r=new o.ManagedCubemap(this.getName(),[this._images.posX[h],this._images.negX[h],this._images.posY[h],this._images.negY[h],this._images.posZ[h],this._images.negZ[h]]),this._cachedManagedCubemaps.push({qualityPreferenceList:e,cubemap:r}),r)},h.prototype=new n.GenericResource,h.prototype.constructor=h,h.prototype._allSourcesLoaded=function(){return this._vertexShaderSource&&this._fragmentShaderSource&&this._shaderIncludesLoaded===this._shaderIncludesToLoad},h.prototype._loadIncludeSource=function(t,e,i){var n;for(b[e].source=i,this._resolveInclude(t,e),n=0;n<b[e].onLoad.length;n++)b[e].onLoad[n]()},h.prototype._getIncludeFileName=function(t){return t.substr(x.length,t.length-(x.length+E.length))},h.prototype._resolveInclude=function(t,e){var n,o,r=b[e].source;switch(t){case p.VERTEX:o=this._vertexShaderSource.split("\n");break;case p.FRAGMENT:o=this._fragmentShaderSource.split("\n");break;default:i.crash()}for(n=0;n<o.length;n++)if(o[n].substr(0,x.length)===x&&e===this._getIncludeFileName(o[n])){switch(o[n]=r,t){case p.VERTEX:this._vertexShaderSource=o.join("\n");break;case p.FRAGMENT:this._fragmentShaderSource=o.join("\n");break;default:i.crash()}this._resolveSource(t,r);break}this._shaderIncludesLoaded++,this._allSourcesLoaded()&&this.setToReady()},h.prototype._resolveSource=function(t,e){var n,o=e.split("\n"),r=[];for(n=0;n<o.length;n++)o[n].substr(0,x.length)===x&&(r.push(this._getIncludeFileName(o[n])),this._shaderIncludesToLoad++);for(n=0;n<r.length;n++)b[r[n]]?b[r[n]].source?this._resolveInclude(t,r[n]):b[r[n]].onLoad.push(this._resolveInclude.bind(this,t,r[n])):(b[r[n]]={onLoad:[]},i.requestTextFile(S,r[n],this._loadIncludeSource.bind(this,t,r[n])))},h.prototype.requiresReload=function(){return this.isRequested()?!1:!this.isLoaded()},h.prototype._requestFiles=function(){i.requestTextFile(S,this._vertexShaderSourcePath,function(t){this._onFilesLoad(!1,{shaderType:p.VERTEX,text:t})}.bind(this)),i.requestTextFile(S,this._fragmentShaderSourcePath,function(t){this._onFilesLoad(!1,{shaderType:p.FRAGMENT,text:t})}.bind(this))},h.prototype._loadData=function(t){switch(e.getEnumValue(p,t.shaderType,{name:"shaderType",defaultValue:null})){case p.VERTEX:this._vertexShaderSource=t.text;break;case p.FRAGMENT:this._fragmentShaderSource=t.text;break;default:i.crash()}this._resolveSource(t.shaderType,t.text),this._allSourcesLoaded()&&this.setToReady()},h.prototype.getVariantShaderName=function(t){return this._variantShaderNames?this._variantShaderNames[t]:null},h.prototype.getManagedShader=function(e,n){var r;if(this.isReadyToUse()===!1)return i.showError("Cannot get managed GL shader for '"+this.getName()+"', as it has not been loaded from file yet!"),null;for(e=e||null,r=0;r<this._managedShaderBindings.length;r++)if(t.objectsEqual(this._managedShaderBindings[r].replacedDefines,e))return this._managedShaderBindings[r].managedShader;return this._managedShaderBindings.push({managedShader:new o.ManagedShader(this.getName(),this._vertexShaderSource,this._fragmentShaderSource,this._blendMode,this._vertexAttributeRoles,this._instanceAttributeRoles,e,n),replacedDefines:e}),this._managedShaderBindings[this._managedShaderBindings.length-1].managedShader},l.prototype=new n.GenericResource,l.prototype.constructor=l,l.prototype._getPath=function(t){var e;for(e=0;e<this._files.length;e++)if(this._files[e].maxLOD===t)return this._basepath+this._files[e].suffix+"."+this._format;return null},l.prototype.requiresReload=function(t){return this.isRequested(t)?!1:0===this._files.length?!1:t&&"number"==typeof t.maxLOD?t.maxLOD>this._maxLoadedLOD:null!==this.getMaxLOD()?this.requiresReload({maxLOD:this.getMaxLOD()}):!1},l.prototype.getMaxLOD=function(){var t,e=null;for(t=0;t<this._files.length;t++)(null===e||this._files[t].maxLOD>e)&&(e=this._files[t].maxLOD);return e},l.prototype._requestFile=function(t){this._filesToLoad++,i.requestTextFile(M,this._getPath(t),function(e){this._loadedFiles++,this._onFilesLoad(this._filesToLoad===this._loadedFiles,{maxLOD:t,text:e})}.bind(this))},l.prototype._requestFiles=function(t){var e,n;if(t=t||{},void 0!==t.maxLOD){for(e=t.maxLOD;e>=0;e--)if(null!==this._getPath(e))return void this._requestFile(e);if(0>e&&this._files.length>0)for(n=this.getMaxLOD(),e=t.maxLOD+1;n>=e;e++)if(null!==this._getPath(e))return void this._requestFile(e);i.showError("Could not find any files to load for model: '"+this._name+"'!")}else this._requestFiles({maxLOD:this.getMaxLOD()})},l.prototype._loadData=function(t){i.log("Model file of max LOD level "+t.maxLOD+" has been loaded for model '"+this.getName()+"'",2),this._model=new r.Model,"{"===t.text[0]?this._model.loadFromJSON(this._getPath(t.maxLOD),JSON.parse(t.text),t.maxLOD):"<"===t.text[0]?this._model.loadFromXML(this._getPath(t.maxLOD),(new window.DOMParser).parseFromString(t.text,"text/xml"),t.maxLOD):i.showError("Cannot load Egom Mode from file '"+this._getPath(t.maxLOD)+"', as it does no appear to be either an XML or a JSON file!"),this._maxLoadedLOD=t.maxLOD},l.prototype.getEgomModel=function(){return this.isReadyToUse()===!1?(i.showError("Cannot get model object for '"+this.getName()+"', as it has not been loaded from file yet!"),null):this._model},u.prototype=new n.ResourceManager,u.prototype.constructor=u,u.prototype.getTexture=function(t){return this.getResource(d,t)},u.prototype.getCubemap=function(t){return this.getResource(g,t)},u.prototype.getShader=function(t){return this.getResource(f,t)},u.prototype.getVariantShader=function(t,e){return this.getResource(f,this.getResource(f,t,{doNotLoad:!0}).getVariantShaderName(e),{allowNullResult:!0})||this.getShader(t)},u.prototype.getModel=function(t,e){return this.getResource(m,t,e)},u.prototype.getOrAddModel=function(t){var e=this.getResource(m,t.getName(),{allowNullResult:!0});return e||(e=this.addResource(m,new l({name:t.getName(),model:t}))),e},_=new u,{requestConfigLoad:c,requestResourceLoad:_.requestResourceLoad.bind(_),getTexture:_.getTexture.bind(_),getCubemap:_.getCubemap.bind(_),getShader:_.getShader.bind(_),getVariantShader:_.getVariantShader.bind(_),getModel:_.getModel.bind(_),getOrAddModel:_.getOrAddModel.bind(_),executeWhenReady:_.executeWhenReady.bind(_),executeOnResourceLoad:_.executeOnResourceLoad.bind(_)}}),define("utils/matrices",["utils/vectors"],function(t){"use strict";function e(){var t;for(t=0;t<s.length;t++)if(!s[t].used)return t;return s.push({used:!1,matrix:o.identity4()}),s.length-1}function i(t){return s[t].used=!0,s[t].matrix}function n(t){s[t].used=!1}var o={},r=.99999,s=[],a=0;return o.clearMatrixCount=function(){a=0},o.getMatrixCount=function(){return a},o.identity3=function(){return new Float32Array([1,0,0,0,1,0,0,0,1])},o.IDENTITY3=o.identity3(),o.identity4=function(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},o.IDENTITY4=o.identity4(),o.null3=function(){return new Float32Array([0,0,0,0,0,0,0,0,0])},o.null4=function(){return new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])},o.matrix3=function(t){return new Float32Array([t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]])},o.matrix4=function(t){return new Float32Array([t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]])},o.translation4=function(t,e,i){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t,e,i,1])},o.translation4v=function(t){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t[0],t[1],t[2],1])},o.translation4m4=function(t){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t[12],t[13],t[14],1])},o.rotation2=function(t){var e=Math.cos(t),i=Math.sin(t);return new Float32Array([e,-i,i,e])},o.rotation4=function(t,e){var i=Math.cos(e),n=Math.sin(e);return new Float32Array([i+(1-i)*t[0]*t[0],(1-i)*t[0]*t[1]-n*t[2],(1-i)*t[0]*t[2]+n*t[1],0,(1-i)*t[0]*t[1]+n*t[2],i+(1-i)*t[1]*t[1],(1-i)*t[1]*t[2]-n*t[0],0,(1-i)*t[0]*t[2]-n*t[1],(1-i)*t[1]*t[2]+n*t[0],i+(1-i)*t[2]*t[2],0,0,0,0,1])},o.rotationAroundPoint4=function(e,i,n){var r=o.rotation4(i,n),s=t.mulVec3Mat4(e,r);return r[12]=e[0]-s[0],r[13]=e[1]-s[1],
r[14]=e[2]-s[2],r},o.rotation4m4=function(t){return new Float32Array([t[0],t[1],t[2],0,t[4],t[5],t[6],0,t[8],t[9],t[10],0,0,0,0,1])},o.lookTowards4=function(e,i){var n,s;return i=i||[0,1,0],n=new Float32Array([1,0,0,0,0,1,0,0,e[0],e[1],e[2],0,0,0,0,1]),Math.abs(t.dot3(i,e))>r&&(i=t.perpendicular3(e)),s=t.cross3(i,e),n[0]=s[0],n[1]=s[1],n[2]=s[2],i=t.cross3(e,s),n[4]=i[0],n[5]=i[1],n[6]=i[2],o.correctedOrthogonal4(n)},o.scaling4=function(t,e,i){return e=e||t,i=i||t,new Float32Array([t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1])},o.translationRotation=function(t,e){return new Float32Array([e[0],e[1],e[2],0,e[4],e[5],e[6],0,e[8],e[9],e[10],0,t[12],t[13],t[14],1])},o.perspective4=function(t,e,i,n){return new Float32Array([i/t,0,0,0,0,i/e,0,0,0,0,(i+n)/(i-n),-1,0,0,2*i*n/(i-n),0])},o.orthographic4=function(t,e,i,n){return new Float32Array([1/t,0,0,0,0,1/e,0,0,0,0,-2/(n-i),0,0,0,-(i+n)/2,1])},o.translationFromXMLTag=function(e){return o.translation4v(t.fromXMLTag3(e))},o.rotation4FromXMLTags=function(t){var e,i,n=o.identity4();for(e=0;e<t.length;e++)i=[0,0,0],"x"===t[e].getAttribute("axis")?i=[1,0,0]:"y"===t[e].getAttribute("axis")?i=[0,1,0]:"z"===t[e].getAttribute("axis")&&(i=[0,0,1]),n=o.prod4(n,o.rotation4(i,parseFloat(t[e].getAttribute("degree"))/180*Math.PI));return n},o.rotation4FromJSON=function(t){var e,i,n=o.identity4();if(t)for(e=0;e<t.length;e++){if("string"==typeof t[e].axis)switch(t[e].axis){case"x":case"X":i=[1,0,0];break;case"y":case"Y":i=[0,1,0];break;case"z":case"Z":i=[0,0,1]}else t[e].axis instanceof Array&&(i=t[e].axis);n=o.prod4(n,o.rotation4(i,parseFloat(t[e].degrees)/180*Math.PI))}return n},o.fromVectorsTo3=function(t,e,i){return new Float32Array([t[0],t[1],t[2],e[0],e[1],e[2],i[0],i[1],i[2]])},o.fromVectorsTo4=function(t,e,i,n){return n=n||[0,0,0,1],new Float32Array([t[0],t[1],t[2],t.length>3?t[3]:0,e[0],e[1],e[2],e.length>3?e[3]:0,i[0],i[1],i[2],i.length>3?i[3]:0,n[0],n[1],n[2],n[3]])},o.getRowA3=function(t){return[t[0],t[1],t[2]]},o.getRowA3Neg=function(t){return[-t[0],-t[1],-t[2]]},o.getRowA4=function(t){return[t[0],t[1],t[2],t[3]]},o.getRowA4Neg=function(t){return[-t[0],-t[1],-t[2],-t[3]]},o.getRowA43=function(t){return[t[0],t[1],t[2]]},o.getRowA43Neg=function(t){return[-t[0],-t[1],-t[2]]},o.getRowB3=function(t){return[t[3],t[4],t[5]]},o.getRowB3Neg=function(t){return[-t[3],-t[4],-t[5]]},o.getRowB4=function(t){return[t[4],t[5],t[6],t[7]]},o.getRowB4Neg=function(t){return[-t[4],-t[5],-t[6],-t[7]]},o.getRowB43=function(t){return[t[4],t[5],t[6]]},o.getRowB43Neg=function(t){return[-t[4],-t[5],-t[6]]},o.getRowC4=function(t){return[t[8],t[9],t[10],t[11]]},o.getRowC43=function(t){return[t[8],t[9],t[10]]},o.getRowC43Neg=function(t){return[-t[8],-t[9],-t[10]]},o.getRowD4=function(t){return[t[12],t[13],t[14],t[15]]},o.determinant3=function(t){return t[0]*t[4]*t[8]+t[1]*t[5]*t[6]+t[2]*t[3]*t[7]-t[2]*t[4]*t[6]-t[1]*t[3]*t[8]-t[0]*t[5]*t[7]},o.translationVector3=function(t){return[t[12],t[13],t[14]]},o.translationVector4=function(t){return[t[12],t[13],t[14],t[15]]},o.translationLength=function(e){return t.length3([e[12],e[13],e[14]])},o.getVectorYawAndPitch=function(e){var i,n={};return Math.abs(e[2])>r?(n.yaw=0,n.pitch=e[2]>0?-Math.PI/2:Math.PI/2):(n.yaw=t.angle2uCapped([0,1],t.normal2([e[0],e[1]])),e[0]<0&&(n.yaw=-n.yaw),i=t.mulVec3Mat4(e,o.rotation4([0,0,1],-n.yaw)),n.pitch=t.angle2uCapped([1,0],t.normal2([i[1],i[2]])),i[2]>0&&(n.pitch=-n.pitch)),n},o.getYawAndPitch=function(e){var i,n={};return Math.abs(e[6])>r?(n.yaw=0,n.pitch=e[6]>0?-Math.PI/2:Math.PI/2):(n.yaw=t.angle2uCapped([0,1],t.normal2(e[10]>0?[e[4],e[5]]:[-e[4],-e[5]])),e[4]*e[10]<0&&(n.yaw=-n.yaw),i=o.correctedOrthogonal4(o.prod3x3SubOf4(e,o.rotation4([0,0,1],-n.yaw))),n.pitch=t.angle2uCapped([1,0],t.normal2([i[5],i[6]])),i[6]>0&&(n.pitch=-n.pitch)),n},o.getRotations=function(e){var i,n,s={};return i=t.dot3([0,1,0],o.getRowB43(e)),Math.abs(i)>r?(s.alphaAxis=[0,0,1],s.alpha=i>0?0:Math.PI):(s.alphaAxis=t.normal3(t.cross3(o.getRowB43(e),[0,1,0])),s.alpha=t.angle3u(o.getRowB43(e),[0,1,0])),s.alpha>Math.PI&&(s.alpha-=2*Math.PI),n=o.correctedOrthogonal4(o.prod3x3SubOf4(e,o.rotation4(s.alphaAxis,-s.alpha))),i=t.dot3([1,0,0],o.getRowA43(n)),Math.abs(i)>r?(s.gammaAxis=[0,1,0],s.gamma=i>0?0:Math.PI):(s.gammaAxis=t.normal3(t.cross3(o.getRowA43(n),[1,0,0])),s.gamma=t.angle3u(o.getRowA43(n),[1,0,0])),s.gamma>Math.PI&&(s.gamma-=2*Math.PI),s},o.toString3=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)+"\n"+t[3].toFixed(e)+" "+t[4].toFixed(e)+" "+t[5].toFixed(e)+"\n"+t[6].toFixed(e)+" "+t[7].toFixed(e)+" "+t[8].toFixed(e)},o.toString4=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)+" "+t[3].toFixed(e)+"\n"+t[4].toFixed(e)+" "+t[5].toFixed(e)+" "+t[6].toFixed(e)+" "+t[7].toFixed(e)+"\n"+t[8].toFixed(e)+" "+t[9].toFixed(e)+" "+t[10].toFixed(e)+" "+t[11].toFixed(e)+"\n"+t[12].toFixed(e)+" "+t[13].toFixed(e)+" "+t[14].toFixed(e)+" "+t[15].toFixed(e)},o.toHTMLString4=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)+" "+t[3].toFixed(e)+"<br/>"+t[4].toFixed(e)+" "+t[5].toFixed(e)+" "+t[6].toFixed(e)+" "+t[7].toFixed(e)+"<br/>"+t[8].toFixed(e)+" "+t[9].toFixed(e)+" "+t[10].toFixed(e)+" "+t[11].toFixed(e)+"<br/>"+t[12].toFixed(e)+" "+t[13].toFixed(e)+" "+t[14].toFixed(e)+" "+t[15].toFixed(e)},o.matrix3from4=function(t){return new Float32Array([t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]])},o.matrix4from3=function(t){return new Float32Array([t[0],t[1],t[2],0,t[3],t[4],t[5],0,t[6],t[7],t[8],0,0,0,0,1])},o.transposed3=function(t){return new Float32Array([t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8]])},o.transposed43=function(t){return new Float32Array([t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]])},o.transposed4=function(t){return new Float32Array([t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15]])},o.inverse3=function(t){var r,s,a,h,l,u,c,_,p=e();if(u=i(p),o.setMatrix3(u,t),c=o.identity3(),0===o.determinant3(u))return o.null3();for(r=0;3>r;r++){if(Math.abs(u[4*r])<=1e-4){for(s=r+1;Math.abs(u[3*s+r])<=1e-4;)s++;for(a=0;3>a;a++)_=u[3*r+a],u[3*r+a]=u[3*s+a],u[3*s+a]=_,_=c[3*r+a],c[3*r+a]=c[3*s+a],c[3*s+a]=_}for(h=u[4*r],s=0;3>s;s++)u[3*r+s]=u[3*r+s]/h,c[3*r+s]=c[3*r+s]/h;for(s=r+1;3>s;s++)for(l=u[3*s+r]/u[4*r],a=0;3>a;a++)u[3*s+a]=u[3*s+a]-l*u[3*r+a],c[3*s+a]=c[3*s+a]-l*c[3*r+a]}for(r=2;r>=1;r--)for(s=r-1;s>=0;s--)for(a=0;3>a;a++)c[3*s+a]=c[3*s+a]-u[3*s+r]*c[3*r+a];return n(p),c},o.inverse4=function(t){var r,s,a,h,l,u,c,_,p=e();for(u=i(p),o.setMatrix4(u,t),c=o.identity4(),r=0;4>r;r++){if(Math.abs(u[5*r])<=1e-4){for(s=r+1;Math.abs(u[4*s+r])<=1e-4;)s++;for(a=0;4>a;a++)_=u[4*r+a],u[4*r+a]=u[4*s+a],u[4*s+a]=_,_=c[4*r+a],c[4*r+a]=c[4*s+a],c[4*s+a]=_}for(h=u[5*r],s=0;4>s;s++)u[4*r+s]=u[4*r+s]/h,c[4*r+s]=c[4*r+s]/h;for(s=r+1;4>s;s++)for(l=u[4*s+r]/u[5*r],a=0;4>a;a++)u[4*s+a]=u[4*s+a]-l*u[4*r+a],c[4*s+a]=c[4*s+a]-l*c[4*r+a]}for(r=3;r>=1;r--)for(s=r-1;s>=0;s--)for(a=0;4>a;a++)c[4*s+a]=c[4*s+a]-u[4*s+r]*c[4*r+a];return n(p),c},o.inverseOfTranslation4=function(t){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,-t[12],-t[13],-t[14],1])},o.inverseOfRotation4=o.transposed4,o.inverseOfScaling4=function(t){return o.scaling4(1/t[0],1/t[5],1/t[10])},o.scaled3=function(t,e){return new Float32Array([t[0]*e,t[1]*e,t[2]*e,t[3]*e,t[4]*e,t[5]*e,t[6]*e,t[7]*e,t[8]*e])},o.scaled4=function(t,e){return new Float32Array([t[0]*e,t[1]*e,t[2]*e,t[3]*e,t[4]*e,t[5]*e,t[6]*e,t[7]*e,t[8]*e,t[9]*e,t[10]*e,t[11]*e,t[12]*e,t[13]*e,t[14]*e,t[15]*e])},o.correctedOrthogonal4=function(e){var i=t.normal3([e[0],e[1],e[2]]),n=t.normal3([e[4],e[5],e[6]]),o=t.cross3(i,n);return n=t.cross3(o,i),new Float32Array([i[0],i[1],i[2],0,n[0],n[1],n[2],0,o[0],o[1],o[2],0,0,0,0,1])},o.straightened=function(t,e){var i,n=new Float32Array(t);for(i=0;i<n.length;i++)n[i]=Math.abs(t[i])<e?0:Math.abs(1-t[i])<e?1:Math.abs(-1-t[i])<e?-1:t[i];return n},o.equal4=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]},o.sum4=function(t,e){return new Float32Array([t[0]+e[0],t[1]+e[1],t[2]+e[2],t[3]+e[3],t[4]+e[4],t[5]+e[5],t[6]+e[6],t[7]+e[7],t[8]+e[8],t[9]+e[9],t[10]+e[10],t[11]+e[11],t[12]+e[12],t[13]+e[13],t[14]+e[14],t[15]+e[15]])},o.prod3=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[3]+t[2]*e[6],t[0]*e[1]+t[1]*e[4]+t[2]*e[7],t[0]*e[2]+t[1]*e[5]+t[2]*e[8],t[3]*e[0]+t[4]*e[3]+t[5]*e[6],t[3]*e[1]+t[4]*e[4]+t[5]*e[7],t[3]*e[2]+t[4]*e[5]+t[5]*e[8],t[6]*e[0]+t[7]*e[3]+t[8]*e[6],t[6]*e[1]+t[7]*e[4]+t[8]*e[7],t[6]*e[2]+t[7]*e[5]+t[8]*e[8]])},o.prod4=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[4]+t[2]*e[8]+t[3]*e[12],t[0]*e[1]+t[1]*e[5]+t[2]*e[9]+t[3]*e[13],t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+t[3]*e[14],t[0]*e[3]+t[1]*e[7]+t[2]*e[11]+t[3]*e[15],t[4]*e[0]+t[5]*e[4]+t[6]*e[8]+t[7]*e[12],t[4]*e[1]+t[5]*e[5]+t[6]*e[9]+t[7]*e[13],t[4]*e[2]+t[5]*e[6]+t[6]*e[10]+t[7]*e[14],t[4]*e[3]+t[5]*e[7]+t[6]*e[11]+t[7]*e[15],t[8]*e[0]+t[9]*e[4]+t[10]*e[8]+t[11]*e[12],t[8]*e[1]+t[9]*e[5]+t[10]*e[9]+t[11]*e[13],t[8]*e[2]+t[9]*e[6]+t[10]*e[10]+t[11]*e[14],t[8]*e[3]+t[9]*e[7]+t[10]*e[11]+t[11]*e[15],t[12]*e[0]+t[13]*e[4]+t[14]*e[8]+t[15]*e[12],t[12]*e[1]+t[13]*e[5]+t[14]*e[9]+t[15]*e[13],t[12]*e[2]+t[13]*e[6]+t[14]*e[10]+t[15]*e[14],t[12]*e[3]+t[13]*e[7]+t[14]*e[11]+t[15]*e[15]])},o.prod3x3SubOf43=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[4]+t[2]*e[8],t[0]*e[1]+t[1]*e[5]+t[2]*e[9],t[0]*e[2]+t[1]*e[6]+t[2]*e[10],t[4]*e[0]+t[5]*e[4]+t[6]*e[8],t[4]*e[1]+t[5]*e[5]+t[6]*e[9],t[4]*e[2]+t[5]*e[6]+t[6]*e[10],t[8]*e[0]+t[9]*e[4]+t[10]*e[8],t[8]*e[1]+t[9]*e[5]+t[10]*e[9],t[8]*e[2]+t[9]*e[6]+t[10]*e[10]])},o.prod3x3SubOf4=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[4]+t[2]*e[8],t[0]*e[1]+t[1]*e[5]+t[2]*e[9],t[0]*e[2]+t[1]*e[6]+t[2]*e[10],0,t[4]*e[0]+t[5]*e[4]+t[6]*e[8],t[4]*e[1]+t[5]*e[5]+t[6]*e[9],t[4]*e[2]+t[5]*e[6]+t[6]*e[10],0,t[8]*e[0]+t[9]*e[4]+t[10]*e[8],t[8]*e[1]+t[9]*e[5]+t[10]*e[9],t[8]*e[2]+t[9]*e[6]+t[10]*e[10],0,0,0,0,1])},o.prodTranslationRotation4=function(t,e){return new Float32Array([e[0],e[1],e[2],0,e[4],e[5],e[6],0,e[8],e[9],e[10],0,e[0]*t[12]+e[4]*t[13]+e[8]*t[14],e[1]*t[12]+e[5]*t[13]+e[9]*t[14],e[2]*t[12]+e[6]*t[13]+e[10]*t[14],1])},o.prod34=function(t,e,i){var n=o.prod4(t,e);return o.mul4(n,i),n},o.translatedByVector=function(t,e){return new Float32Array([t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12]+e[0],t[13]+e[1],t[14]+e[2],t[15]])},o.translatedByM4=function(t,e){return new Float32Array([t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12]+e[12],t[13]+e[13],t[14]+e[14],t[15]])},o.distanceSquared=function(t,e){return(t[12]-e[12])*(t[12]-e[12])+(t[13]-e[13])*(t[13]-e[13])+(t[14]-e[14])*(t[14]-e[14])},o.setIdentity4=function(t){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1},o.setMatrix3=function(t,e){var i;for(i=0;9>i;i++)t[i]=e[i]},o.setMatrix4=function(t,e){var i;for(i=0;16>i;i++)t[i]=e[i]},o.setRotation4=function(t,e,i){var n=Math.cos(i),o=Math.sin(i);t[0]=n+(1-n)*e[0]*e[0],t[1]=(1-n)*e[0]*e[1]-o*e[2],t[2]=(1-n)*e[0]*e[2]+o*e[1],t[3]=0,t[4]=(1-n)*e[0]*e[1]+o*e[2],t[5]=n+(1-n)*e[1]*e[1],t[6]=(1-n)*e[1]*e[2]-o*e[0],t[7]=0,t[8]=(1-n)*e[0]*e[2]-o*e[1],t[9]=(1-n)*e[1]*e[2]+o*e[0],t[10]=n+(1-n)*e[2]*e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1},o.setRotationAroundPoint4=function(e,i,n,r){var s;o.setRotation4(e,n,r),s=t.mulVec3Mat4(i,e),e[12]=i[0]-s[0],e[13]=i[1]-s[1],e[14]=i[2]-s[2]},o.translateByVector=function(t,e){t[12]+=e[0],t[13]+=e[1],t[14]+=e[2]},o.translateByMatrix=function(t,e){t[12]+=e[12],t[13]+=e[13],t[14]+=e[14]},o.rotate4=function(t,r,s){var a=e(),h=i(a);o.setRotation4(h,r,s),o.mul4(t,h),n(a)},o.rotateAroundPoint4=function(t,r,s,a){var h=e(),l=i(h);o.setRotationAroundPoint4(l,r,s,a),o.mul4(t,l),n(h)},o.mul4=function(t,r){var s=e(),a=i(s);o.setMatrix4(a,t),t[0]=a[0]*r[0]+a[1]*r[4]+a[2]*r[8]+a[3]*r[12],t[1]=a[0]*r[1]+a[1]*r[5]+a[2]*r[9]+a[3]*r[13],t[2]=a[0]*r[2]+a[1]*r[6]+a[2]*r[10]+a[3]*r[14],t[3]=a[0]*r[3]+a[1]*r[7]+a[2]*r[11]+a[3]*r[15],t[4]=a[4]*r[0]+a[5]*r[4]+a[6]*r[8]+a[7]*r[12],t[5]=a[4]*r[1]+a[5]*r[5]+a[6]*r[9]+a[7]*r[13],t[6]=a[4]*r[2]+a[5]*r[6]+a[6]*r[10]+a[7]*r[14],t[7]=a[4]*r[3]+a[5]*r[7]+a[6]*r[11]+a[7]*r[15],t[8]=a[8]*r[0]+a[9]*r[4]+a[10]*r[8]+a[11]*r[12],t[9]=a[8]*r[1]+a[9]*r[5]+a[10]*r[9]+a[11]*r[13],t[10]=a[8]*r[2]+a[9]*r[6]+a[10]*r[10]+a[11]*r[14],t[11]=a[8]*r[3]+a[9]*r[7]+a[10]*r[11]+a[11]*r[15],t[12]=a[12]*r[0]+a[13]*r[4]+a[14]*r[8]+a[15]*r[12],t[13]=a[12]*r[1]+a[13]*r[5]+a[14]*r[9]+a[15]*r[13],t[14]=a[12]*r[2]+a[13]*r[6]+a[14]*r[10]+a[15]*r[14],t[15]=a[12]*r[3]+a[13]*r[7]+a[14]*r[11]+a[15]*r[15],n(s)},o.correctOrthogonal4=function(e){var i=t.normal3([e[0],e[1],e[2]]),n=t.normal3([e[4],e[5],e[6]]),o=t.cross3(i,n);n=t.cross3(o,i),e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=0,e[4]=n[0],e[5]=n[1],e[6]=n[2],e[7]=0,e[8]=o[0],e[9]=o[1],e[10]=o[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1},o.straighten=function(t,e){var i;for(i=0;i<t.length;i++)t[i]=Math.abs(t[i])<e?0:Math.abs(1-t[i])<e?1:Math.abs(-1-t[i])<e?-1:t[i]},o}),define("modules/buda-scene",["utils/utils","utils/types","utils/vectors","utils/matrices","modules/application","modules/managed-gl"],function(t,e,i,n,o,r){"use strict";function s(e){switch(e){case t.ScaleMode.WIDTH:return 0;case t.ScaleMode.HEIGHT:return 1;case t.ScaleMode.ASPECT:return 2;case t.ScaleMode.MINIMUM:return 3;case t.ScaleMode.MAXIMUM:return 4;default:o.crash()}}function a(){return Yt}function h(t,e,i,n,o){this.maxEnabledLOD=t,this.thresholds=e,this.compensateForObjectSize=i===!0,this.referenceSize=n||k,this.minimumRelativeSize=o||z}function l(t,e,i,o){this._parent=null,this._positionMatrix=t||n.identity4(),this._orientationMatrix=e||n.identity4(),this._scalingMatrix=i||n.identity4(),this._cascadeScalingMatrix=null,this._modelMatrix=null,this._modelMatrixForFrame=null,this._modelMatrixInverse=null,this._modelMatrixInverseForFrame=null,this._size=void 0!==o?o:1,this._insideParent=null,this._lastSizeInsideViewFrustum={width:-1,height:-1},this._positionMatrixInCameraSpace=null}function u(t,e,i,n,o,r,s,a,h,l,u,c,_,p){this.context=t,this.depthMask=e,this.scene=i,this.parent=n,this.camera=o,this.viewportWidth=r,this.viewportHeight=s,this.lodContext=a,this.dt=h||0,this.useInstancing=l||!1,this.instanceQueueIndex=u,this.lightMatrix=c,this.shadowMapRange=_,this.shadowMapDepthRatio=p}function c(t,e,i){this._renderableObject=t,t.setNode(this),this._scene=null,this._parent=null,this._subnodes=[],this._visible=!0,this._renderParameters=new u,this._cameraConfigurations=[],this._hasInstancedSubnodes=e,this._minimumCountForInstancing=i||0}function _(t,e,i,n,o){this._node=null,this._wasRendered=!1,this._shader=t,this._textures={},this._uniformValueFunctions={},this._isRenderedWithDepthMask=void 0===e?!0:e,this._isRenderedWithoutDepthMask=void 0===i?!0:i,this._instancedShader=n||null,this._canBeReused=!1,this._visible=!0,this._castsShadows=void 0!==o?o:!0,this._wasRenderedToShadowMap=!1,this._name=null}function p(t,e,i,n,o,r,s,a){_.call(this,t,e,i,s),l.call(this,n,o,r,a),this._visibleSize={width:-1,height:-1},this._insideShadowCastFrustum=null,this._smallestSizeWhenDrawn=0}function d(t,e,i,o,r){_.call(this,e,!1,!0),this._model=t,this._samplerName=i,this._camera=r,this.setTexture(i,o),this.setUniformValueFunction($,function(){return n.inverse4(n.prod4(this._camera.getInverseOrientationMatrix(),this._camera.getProjectionMatrix()))})}function g(t,e,i,o,r,s,a,h){p.call(this,e,!0,!0,o,r,s),this.setSmallestSizeWhenDrawn(5),this.setTextures(i),this._model=t,this._wireframe=a===!0,this._wireframe&&(this._isRenderedWithDepthMask=!1),this._currentLOD=this.LOD_NOT_SET,this._lastLOD=this.LOD_NOT_SET,this._modelSize=0,this._lodSizeFactors={},this._staticLOD=void 0!==h?h:this.LOD_NOT_SET,this.setUniformValueFunction(tt,function(){return this.getModelMatrix()}),this.setUniformValueFunction(et,function(){return n.transposed3(n.inverse3(n.matrix3from4(this.getModelMatrix())))})}function f(t,e,i,n,s,a,h,l,u){var c,_,p,d,f;for(g.call(this,t,e,i,n,s,a,h,l),this._parameterArrays={},f=Object.keys(u),c=0;c<f.length;c++)if(p=r.getUniformName(f[c]),d=e.getUniformArrayLength(p),d>0){switch(u[f[c]]){case r.ShaderVariableType.FLOAT:break;case r.ShaderVariableType.MAT4:d*=16;break;default:o.showError("Cannot create uniform parameter array with elements of type: '"+u[f[c]]+"'!")}for(this._parameterArrays[f[c]]=new Float32Array(d),_=0;d>_;_++)this._parameterArrays[f[c]][_]=0;this.setUniformValueFunction(f[c],this.createGetParameterArrayFunction(f[c]))}else o.log("Note: cannot initialize parameter array '"+f[c]+"' for parameterized mesh, as the given shader ("+e.getName()+") does not have a uniform array named '"+p+"'.",2),this._parameterArrays[f[c]]=new Float32Array}function m(t,e,i,n,o,r,s){p.call(this),this._model=null,t&&this.init(t,e,i,n,o,r,s)}function y(t,e,i){this.color=t,this.size=e,this.timeToReach=i}function T(t,e,i,n,o,r,s,a){p.call(this),this.setSmallestSizeWhenDrawn(.1),this._model=t,this._color=[0,0,0,0],this._size=0,this._relativeSize=0,this._calculatedSize=[0],this._positionVector=[0,0,0],this._states=null,this._currentStateIndex=0,this._looping=!1,this._timeSinceLastTransition=0,this._velocityVector=[0,0,0],this._shouldAnimate=!1,t&&this.init(t,e,i,n,o,r,s,a)}function S(t,e,i,n,o,r,s,a,h){t.init(e,i,n,s,[new y(o,r,0),new y(o,0,a)],!1,h)}function M(t,e,i,n,o,r,s,a){var h=new T;return S(h,t,e,i,n,o,r,s,a),h}function x(t,e,i,n,o,r,s){return new T(t,e,i,r,[new y(n,o,0)],!1,s)}function E(t,e,o,r,s,a,h){var l,u,c,_;T.call(this,t,e,o,a,[new y(r,s,0)],!1),_=[0,1],i.rotate2(_,h),l=[_[0],0,_[1]],u=i.normal3(n.translationVector3(a)),c=i.getYawAndPitch(u),_=[0,_[1]],i.rotate2(_,c.pitch),l=[l[0],_[0],_[1]],_=[l[0],_[0]],i.rotate2(_,c.yaw),l=[_[0],_[1],l[2]],this.setOrientationMatrix(n.lookTowards4(i.scaled3(u,-1),l)),this.setUniformValueFunction(tt,function(){return this.getModelMatrix()})}function b(t,e,i,n,o,r,s,a){this._positionMatrix=t,this._orientationMatrix=e,this._dimensions=i,this._initialNumber=n,this._spawnNumber=o,this._spawnTime=r,this._age=0,this._duration=s,this._lastSpawn=0,this._particleConstructor=a,this._particleDuration=-1}function A(t,e,i,n,o,r,s,a,h,l){b.call(this,t,e,i,r,s,a,h,l),this._velocity=n,this._velocitySpread=o}function O(t,e,i,n,o,r,s,a,h,l,u,c){b.call(this,t,e,i,a,h,l,u,c),this._direction=n,this._directionSpread=o,this._velocity=r,this._velocitySpread=s}function R(t,e,i,n,o,r,s,a,h,l,u,c){b.call(this,t,e,i,a,h,l,u,c),this._planeNormal=n,this._directionSpread=o,this._velocity=r,this._velocitySpread=s}function v(t,e,i,o,r,s,a,h){p.call(this,null,!1,!0,t,n.IDENTITY4,n.IDENTITY4),this._velocityMatrix=e,this._emitters=i,this._age=0,this._duration=o,this._keepAlive=r===!0,this._carriesParticles=s===!0,this._minimumCountForInstancing=a,this._particleCountFactor=void 0!==h?h:1}function C(t,e,n,o,r,s){_.call(this,e,!1,!0,n),this._positionVector=o,this._model=t,this._color=r,this._range=s,this._shift=[0,0,0],this.setUniformValueFunction(at,function(){return this._positionVector}),this._color&&(this.setUniformValueFunction(nt,function(){return this._color}),this.setUniformValueFunction(ot,function(){return this._shift}),this.setUniformValueFunction(rt,function(){return i.length3(this._shift)}),this.setUniformValueFunction(st,function(){return this._range}))}function I(t,e,i,o,r,a,h,l,u,c){_.call(this,e,!1,!0),this.setTextures(i),this._model=t,this._position=o,this._color=h,this._size=r,this._scaleMode=s(a),this._rotationMatrix=n.rotation2(Math.radians(l||0)),this._clipCoordinates=u||Xt.slice(),this._clipColor=c||[0,0,0,0],this.setUniformValueFunction(at,function(){return this._position}),this.setUniformValueFunction(lt,function(){return this._size}),this.setUniformValueFunction(ut,function(){return this._scaleMode}),this.setUniformValueFunction(nt,function(){return this._color}),this.setUniformValueFunction(ct,function(){return this._rotationMatrix}),this.setUniformValueFunction(_t,function(){return this._clipCoordinates}),this.setUniformValueFunction(pt,function(){return this._clipColor})}function L(t,e,i,o,r,s,a,h,l,u){this._fixed=t,this._turnsAroundObjects=e,this._movesRelativeToObject=i,this._followedObjects=o||[],this._startsWithRelativePosition=r,this._defaultRelativePositionMatrix=n.matrix4(s),this._relativePositionMatrix=s,this._worldPositionMatrix=null,this._distanceIsConfined=a?!0:!1,this._minimumDistance=a?a[0]:0,this._maximumDistance=a?a[1]:0,this._xIsConfined=h&&h[0]?!0:!1,this._minimumX=h&&h[0]?h[0][0]:0,this._maximumX=h&&h[0]?h[0][1]:0,this._yIsConfined=h&&h[1]?!0:!1,this._minimumY=h&&h[1]?h[1][0]:0,this._maximumY=h&&h[1]?h[1][1]:0,this._zIsConfined=h&&h[2]?!0:!1,this._minimumZ=h&&h[2]?h[2][0]:0,this._maximumZ=h&&h[2]?h[2][1]:0,this._resetsWhenLeavingConfines=l,this._isTransitionConfiguration=u,this._isStarting=!0,this._camera=null}function N(t,e,i,o,r,s,a,h,l,u,c,_){this._fixed=t,this._pointsTowardsObjects=e,this._fps=i,this._followedObjects=o||[],this._defaultRelativeOrientationMatrix=n.matrix4(r),this._relativeOrientationMatrix=r,this._worldOrientationMatrix=null,this._defaultAlpha=s||0,this._alpha=s||0,this._defaultBeta=a||0,this._beta=a||0,this._minAlpha=h&&void 0!==h[0]?h[0]:Q,this._maxAlpha=h&&void 0!==h[1]?h[1]:J,this._minBeta=l&&void 0!==l[0]?l[0]:K,this._maxBeta=l&&void 0!==l[1]?l[1]:Z,this._baseOrientation=u,this._pointToFallback=c,this._isTransitionConfiguration=_,this._camera=null}function w(t,e,i,n,o,r,s,a){l.call(this,e._positionMatrix,i._orientationMatrix),this._name=t,this._positionConfiguration=e,this._orientationConfiguration=i,this._defaultFOV=n,this._fov=n,this._minFOV=o?o[0]:0,this._maxFOV=o?o[1]:0,this._defaultSpan=r,this._span=r,this._minSpan=s?s[0]:0,this._maxSpan=s?s[1]:0,this._resetsOnFocusChange=a,this._camera=null}function D(t,e,i,o,r,s,a,h,l){var u=n.getYawAndPitch(i);return new w("",new L(!1,!1,!1,[],!1,n.matrix4(e),null,null,!1),new N(!1,!1,t,[],n.matrix4(i),Math.degrees(u.yaw),Math.degrees(u.pitch),void 0,void 0,N.prototype.BaseOrientation.WORLD,N.prototype.PointToFallback.POSITION_FOLLOWED_OBJECT_OR_WORLD),o,[r,s],a,[h,l])}function F(t,e,i,o,r,s,a){this._object3D=new l(n.identity4(),n.identity4(),n.identity4()),this._scene=t,this._aspect=e,this._usesVerticalValues=i,this._viewDistance=o,this._previousConfiguration=null,this._currentConfiguration=r,this._currentConfiguration.setCamera(this),this._transitionStyle=this.TransitionStyle.NONE,this._defaultTransitionStyle=a||this.TransitionStyle.NONE,this._transitionDuration=0,this._defaultTransitionDuration=s||0,this._transitionElapsedTime=0,this._velocityVector=[0,0,0],this._controlledVelocityVector=[0,0,0],this._angularVelocityVector=[0,0,0],this._previousFollowedPositionVector=null,this._projectionMatrix=null,this._followedNode=null,this._viewMatrix=null,this._inversePositionMatrix=null,this._inverseOrientationMatrix=null,this._fov=0,this._span=0,this._near=0,this._extendedCamera=null,this._combinedExtendedCamera=null}function V(t,e){this._color=t,this._direction=i.normal3(e),this._orientationMatrix=n.inverseOfRotation4(n.lookTowards4(this._direction)),this._baseMatrix=null,this._translationVector=null,this._translatedMatrix=null,this._shadowMapBufferNamePrefix=null}function P(t,e,i,n,o,r){this._color=t,this._objectIntensity=e,this._relativePositionVector=i,this._emittingObjects=n,this._totalIntensity=e*(n?n.length:1),this._positionVector=null,this._states=o,this._timeSinceLastTransition=0,this._currentStateIndex=0,this._looping=r,this._uniformColor=null,t&&this._updateUniformColor()}function U(t,e,i,n,o,r,s,a,h){P.call(this,t,e,i,s,a,h),this._relativeSpotDirection=n,this._spotCutoffCosine=Math.cos(Math.radians(o)),this._spotFullIntensityCosine=o>r?Math.cos(Math.radians(r)):0,this._spotDirection=null}function B(t,e,i,o,r,s,a,h,l,u,c,_,p){this._left=t,this._bottom=e,this._width=i,this._height=o,this._shouldClearColorOnRender=r,this._clearColorMask=s,this._clearColor=a,this._shouldClearDepthOnRender=h,this._rootBackgroundNode=null,this._rootNode=null,this._rootUINode=null,this._directionalLights=[],this._directionalLightUniformData=[],this._maxRenderedDirectionalLights=u||0,this._pointLightPriorityArrays=null,this._pointLightUniformData=[],this._maxRenderedPointLights=c||0,this._spotLights=[],this._spotLightUniformData=[],this._maxRenderedSpotLights=_||0,this._rootResourceNode=null,this._camera=new F(this,this._width/this._height,p.useVerticalValues,p.viewDistance,p.configuration||D(p.fps,p.positionMatrix||n.IDENTITY4,p.orientationMatrix||n.IDENTITY4,p.fov,p.fovRange&&p.fovRange[0]||p.fov,p.fovRange&&p.fovRange[1]||p.fov,p.span,p.spanRange&&p.spanRange[0]||p.span,p.spanRange&&p.spanRange[1]||p.span),p.transitionDuration,p.transitionStyle),this._lodContext=l,this._shadowMappingEnabled=!1,this._shadowMappingShader=null,this._shadowMapTextureSize=0,this._shadowMapRanges=[],this._shadowMapDepthRatio=0,this._numShadowMapSamples=0,this._shadowMapSampleOffsets=[],this._uniformValueFunctions={},this._contextUniformValueFunctions=[],this._shouldAnimate=!0,this._shouldUpdateCamera=!0,this._numDrawnTriangles=0,this._contexts=[],this._renderQueues=[],this._shadowQueue=null,this._uniformsUpdatedForFrame=!1,this._uniformsUpdated=null,this.clearNodes(),this.clearPointLights(),this._setGeneralUniformValueFunctions()}var G,H,j={NONE:0,FRONT_QUEUE_BIT:1,DISTANCE_QUEUE_BIT:2},k=100,z=.05,W=.95,q=1.05,X=.95,Y=1.05,Q=-360,J=360,K=-90,Z=90,$="viewDirectionProjectionInverse",tt="modelMatrix",et="normalMatrix",it="billboardSize",nt="color",ot="shift",rt="length",st="farthestZ",at="position",ht="direction",lt="size",ut="scaleMode",ct="rotationMatrix",_t="clipCoords",pt="clipColor",dt="shadow-map-buffer-",gt="-",ft="lightMatrix",mt="shadowMapDepth",yt="projMatrix",Tt=5,St="numDirLights",Mt="dirLights",xt="numPointLights",Et="pointLights",bt="numSpotLights",At="spotLights",Ot="cameraMatrix",Rt="viewProjMatrix",vt="cameraOrientationMatrix",Ct="aspect",It="viewportSize",Lt="eyePos",Nt="numRanges",wt="shadowMapRanges",Dt="shadowMapDepthRatio",Ft="shadowMapTextureSize",Vt="shadowMaps",Pt="shadowMapSampleOffsets",Ut=[0,0,1,0,0,1,-1,0,0,-1,1,1,1,-1,-1,1,-1,-1],Bt=5,Gt=.01,Ht=0,jt=1,kt=2,zt=3,Wt=[!0,!0,!0,!0],qt=0,Xt=[0,1,0,1],Yt="";return G=function(){function t(){this._positionMatrixInCameraSpace=null,this._modelMatrixForFrame=null,this._modelMatrixInverseForFrame=null}function e(){return this._parent}function o(t){this._parent=t}function r(){return this._positionMatrix}function s(t){t&&(this._positionMatrix=t),this._modelMatrix=null,this._modelMatrixInverse=null,this._insideParent=null}function a(){return[this._positionMatrix[12],this._positionMatrix[13],this._positionMatrix[14]]}function h(t,e,i){n.translateByVector(this._positionMatrix,[t,e,i]),this.setPositionMatrix()}function l(t){n.translateByVector(this._positionMatrix,t),this.setPositionMatrix()}function u(t){n.translateByMatrix(this._positionMatrix,t),this.setPositionMatrix()}function c(){return this._orientationMatrix}function _(t){t&&(this._orientationMatrix=t),this._modelMatrix=null,this._modelMatrixInverse=null}function p(){return[this._orientationMatrix[0],this._orientationMatrix[1],this._orientationMatrix[2]]}function d(){return[this._orientationMatrix[4],this._orientationMatrix[5],this._orientationMatrix[6]]}function g(){return[this._orientationMatrix[8],this._orientationMatrix[9],this._orientationMatrix[10]]}function f(t,e){0!==e&&(n.rotate4(this._orientationMatrix,t,e),this.setOrientationMatrix())}function m(t){n.mul4(this._orientationMatrix,t),this.setOrientationMatrix()}function y(){return this._scalingMatrix}function T(t){this._scalingMatrix=t,this._modelMatrix=null,this._modelMatrixInverse=null,this._cascadeScalingMatrix=null}function S(){return this._cascadeScalingMatrix||(this._cascadeScalingMatrix=this._parent?n.prod3x3SubOf4(this._parent.getCascadeScalingMatrix(),this._scalingMatrix):this._scalingMatrix),this._cascadeScalingMatrix}function M(){return this._modelMatrixForFrame||(this._modelMatrix=this._modelMatrix||n.translationRotation(this._positionMatrix,n.prod3x3SubOf4(this._scalingMatrix,this._orientationMatrix)),this._modelMatrixForFrame=this._parent?n.prod4(this._modelMatrix,this._parent.getModelMatrix()):this._modelMatrix),this._modelMatrixForFrame}function x(){return this._modelMatrixInverseForFrame||(this._modelMatrixInverse=this._modelMatrixInverse||n.inverse4(this.getModelMatrix()),this._modelMatrixInverseForFrame=this._parent?n.prod4(this._parent.getModelMatrixInverse(),this._modelMatrixInverse):this._modelMatrixInverse),this._modelMatrixInverseForFrame}function E(){return this._size}function b(){return this.getSize()*this.getCascadeScalingMatrix()[0]}function A(){return null===this._insideParent&&(this._insideParent=this._parent?Math.abs(this._positionMatrix[12])<this._parent.getSize()&&Math.abs(this._positionMatrix[13])<this._parent.getSize()&&Math.abs(this._positionMatrix[14])<this._parent.getSize():!1),this._insideParent}function O(t){return this._positionMatrixInCameraSpace||(this._positionMatrixInCameraSpace=n.translation4v(i.mulVec4Mat4(n.translationVector4(this.getModelMatrix()),t.getViewMatrix()))),this._positionMatrixInCameraSpace}function R(t,e){var o,r,s,a,h,l,u,c,_,p;return s=this.getPositionMatrixInCameraSpace(t),r=this.getCascadeScalingMatrix(),e&&(o=this.getSize()*r[0],s[14]-o>=-t.getNearDistance()||s[14]+o<-t.getViewDistance())?(this._lastSizeInsideViewFrustum.width=0,this._lastSizeInsideViewFrustum.height=0,this._lastSizeInsideViewFrustum):(a=n.prod34(r,s,t.getProjectionMatrix()),o=this.getSize(),p=1/a[15],h=[0===a[12]?0:a[12]*p,0===a[13]?0:a[13]*p,0===a[14]?0:a[14]*p],l=i.mulVec4Mat4([o,0,0,1],a),u=i.mulVec4Mat4([0,o,0,1],a),c=Math.abs((0===l[0]?0:l[0]/l[3])-h[0]),_=Math.abs((0===u[1]?0:u[1]/u[3])-h[1]),h[0]+c<-1||h[0]-c>1||h[1]+_<-1||h[1]-_>1?(this._lastSizeInsideViewFrustum.width=0,this._lastSizeInsideViewFrustum.height=0,this._lastSizeInsideViewFrustum):(this._lastSizeInsideViewFrustum.width=c,this._lastSizeInsideViewFrustum.height=_,this._lastSizeInsideViewFrustum))}function v(t,e,o){var r,s;return r=i.mulVec4Mat4(n.translationVector4(this.getModelMatrix()),t),s=this.getScaledSize(),Math.abs(r[0])-s<e&&Math.abs(r[1])-s<e&&Math.abs(r[2])-s<e*o}return function(){this.prototype.resetCachedValues=t,this.prototype.getParent=e,this.prototype.setParent=o,this.prototype.getPositionMatrix=r,this.prototype.setPositionMatrix=s,this.prototype.getOrientationMatrix=c,this.prototype.setOrientationMatrix=_,this.prototype.getScalingMatrix=y,this.prototype.setScalingMatrix=T,this.prototype.getPositionVector=a,this.prototype.translate=h,this.prototype.translatev=l,this.prototype.translateByMatrix=u,this.prototype.getXDirectionVector=p,this.prototype.getYDirectionVector=d,this.prototype.getZDirectionVector=g,this.prototype.rotate=f,this.prototype.rotateByMatrix=m,this.prototype.getCascadeScalingMatrix=S,this.prototype.getModelMatrix=M,this.prototype.getModelMatrixInverse=x,this.prototype.getSize=E,this.prototype.getScaledSize=b,this.prototype.isInsideParent=A,this.prototype.getPositionMatrixInCameraSpace=O,this.prototype.getSizeInsideViewFrustum=R,this.prototype.isInsideShadowRegion=v}},H=G(),H.call(l),c.prototype.canBeReused=function(){var t;if(this._renderableObject.canBeReused()){for(t=0;t<this._subnodes.length;t++)if(this._subnodes[t].canBeReused()===!1)return!1;return!0}return!1},c.prototype.getScene=function(){return this._scene},c.prototype.setScene=function(t){var e;for(this._scene=t,t&&t.addObjectToContexts(this._renderableObject),e=0;e<this._subnodes.length;e++)this._subnodes[e].setScene(t)},c.prototype.addToRenderQueue=function(t){var e;if(0===this._minimumCountForInstancing){for(e=0;e<t.length;e++)if(t[e].length>0&&0===t[e][0].getMinimumCountForInstancing()&&this._renderableObject.shouldGoInSameRenderQueue(t[e][0]._renderableObject))return t[e].push(this),e}else for(e=0;e<t.length;e++)if(t[e].length>0&&t[e][0].getMinimumCountForInstancing()>0&&this._renderableObject.shouldGoInSameRenderQueueInstanced(t[e][0]._renderableObject))return t[e].push(this),
e;return t.push([this]),t.length-1},c.prototype.animateAndAddToRenderQueues=function(t,e,i){var n,o,r,s,a;if(this._visible&&(this._scene.shouldAnimate()&&this._renderableObject.animate(i),s=this._renderableObject.isRenderedWithoutDepthMask(),a=this._renderableObject.isRenderedWithDepthMask(),(s||a)&&(n=this._renderableObject.getRenderQueueBits(e),n&j.FRONT_QUEUE_BIT&&(s&&this.addToRenderQueue(t[jt]),a&&this.addToRenderQueue(t[Ht])),n&j.DISTANCE_QUEUE_BIT&&(s&&this.addToRenderQueue(t[zt]),a&&this.addToRenderQueue(t[kt]))),this._subnodes.length>0))if(!this._hasInstancedSubnodes||this._subnodes.length<this._subnodes[0].getMinimumCountForInstancing())for(o=0;o<this._subnodes.length;o++)this._subnodes[o].animateAndAddToRenderQueues(t,e,i);else{if(this._scene.shouldAnimate())for(o=0;o<this._subnodes.length;o++)this._subnodes[o]._renderableObject.animate(i);s=this._subnodes[0]._renderableObject.isRenderedWithoutDepthMask(),a=this._subnodes[0]._renderableObject.isRenderedWithDepthMask(),(s||a)&&(n=this._subnodes[0]._renderableObject.getRenderQueueBits(e),n&j.FRONT_QUEUE_BIT&&(s&&(r=this._subnodes[0].addToRenderQueue(t[jt]),t[jt][r].pop(),t[jt][r]=t[jt][r].concat(this._subnodes)),a&&(r=this._subnodes[0].addToRenderQueue(t[Ht]),t[Ht][r].pop(),t[Ht][r]=t[Ht][r].concat(this._subnodes))),n&j.DISTANCE_QUEUE_BIT&&(s&&(r=this._subnodes[0].addToRenderQueue(t[zt]),t[zt][r].pop(),t[zt][r]=t[zt][r].concat(this._subnodes)),a&&(r=this._subnodes[0].addToRenderQueue(t[kt]),t[kt][r].pop(),t[kt][r]=t[kt][r].concat(this._subnodes))))}},c.prototype.getParent=function(){return this._parent},c.prototype.setParent=function(t){this._parent=t,this.setScene(t._scene),this._renderableObject.setParent&&this._renderableObject.setParent(t._renderableObject)},c.prototype.getRenderableObject=function(){return this._renderableObject},c.prototype.show=function(){this._visible=!0},c.prototype.hide=function(){this._visible=!1},c.prototype.toggleVisibility=function(){this._visible=!this._visible},c.prototype.addSubnode=function(t){return this._subnodes.push(t),t.setParent(this),this._scene&&t.setScene(this._scene),t},c.prototype.getSubnodes=function(){return this._subnodes},c.prototype.getFirstSubnode=function(){return this._subnodes[0]},c.prototype.getNextSubnode=function(t){var e,i;for(e=0,i=this._subnodes.length;i>e;e++)if(this._subnodes[e]===t)return e===this._subnodes.length-1?this._subnodes[0]:this._subnodes[e+1];return this._subnodes[0]},c.prototype.getPreviousSubnode=function(t){var e,i;for(e=0,i=this._subnodes.length;i>e;e++)if(this._subnodes[e]===t)return 0===e?this._subnodes[this._subnodes.length-1]:this._subnodes[e-1];return this._subnodes[this._subnodes.length-1]},c.prototype.addCameraConfiguration=function(t){this._cameraConfigurations.push(t)},c.prototype.hasCameraConfiguration=function(t){var e;for(e=0;e<this._cameraConfigurations.length;e++)if(this._cameraConfigurations[e]===t)return!0;return!1},c.prototype.getNextCameraConfiguration=function(t){var e;if(!t)return this._cameraConfigurations.length>0?this._cameraConfigurations[0]:null;for(e=0;e<this._cameraConfigurations.length;e++)if(this._cameraConfigurations[e]===t)return this._cameraConfigurations[(e+1)%this._cameraConfigurations.length];o.crash()},c.prototype.getPreviousCameraConfiguration=function(t){var e;if(!t)return this._cameraConfigurations.length>0?this._cameraConfigurations[this._cameraConfigurations.length-1]:null;for(e=this._cameraConfigurations.length-1;e>=0;e--)if(this._cameraConfigurations[e]===t)return 0===e?this._cameraConfigurations[this._cameraConfigurations.length-1]:this._cameraConfigurations[e-1];o.crash()},c.prototype.getCameraConfigurationsWithName=function(t){var e,i=[];for(e=0;e<this._cameraConfigurations.length;e++)this._cameraConfigurations[e].getName()===t&&i.push(this._cameraConfigurations[e]);return i},c.prototype.resetCameraConfigurations=function(){var t;for(t=0;t<this._cameraConfigurations.length;t++)this._cameraConfigurations[t].resetToDefaults()},c.prototype.resetForNewFrame=function(){var t;for(this._renderableObject.resetForNewFrame(),t=0;t<this._subnodes.length;t++)this._subnodes[t].resetForNewFrame()},c.prototype.setRenderParameters=function(t,e,i,n,o,r,s,a,h){this._renderParameters.context=t,this._renderParameters.depthMask=n,this._renderParameters.scene=this._scene,this._renderParameters.parent=this._parent?this._parent._renderableObject:null,this._renderParameters.camera=this._scene.getCamera(),this._renderParameters.viewportWidth=e,this._renderParameters.viewportHeight=i,this._renderParameters.lodContext=this._scene.getLODContext(),this._renderParameters.useInstancing=o,this._renderParameters.instanceQueueIndex=r,this._renderParameters.lightMatrix=s,this._renderParameters.shadowMapRange=a,this._renderParameters.shadowMapDepthRatio=h},c.prototype.render=function(t,e,i,n,o,r,s){var a,h;if(this._visible){if(this.setRenderParameters(t,e,i,n,r,s),h=this._renderableObject.render(this._renderParameters),!o)for(a=0;a<this._subnodes.length;a++)this._subnodes[a].render(t,e,i,n,r,s);return h}return!1},c.prototype.prepareForInstancedRender=function(t,e,i){this._renderableObject.prepareForInstancedRender(t,this._scene,e,i)},c.prototype.renderInstances=function(t,e,i){this._renderableObject.renderInstances(t,e,i)},c.prototype.renderToShadowMap=function(t,e,i,n,o,r){var s,a;if(this._visible){for(this.setRenderParameters(t,e,i,!0,void 0,void 0,n,o,r),a=this._renderableObject.renderToShadowMap(this._renderParameters),s=0;s<this._subnodes.length;s++)this._subnodes[s].renderToShadowMap(t,e,i,n,o,r);return a}return!1},c.prototype.addToContext=function(t){var e;for(this._renderableObject.addToContext(t),e=0;e<this._subnodes.length;e++)this._subnodes[e].addToContext(t)},c.prototype.getShader=function(){return this._renderableObject.getShader()},c.prototype.setShader=function(t){var e;for(this._renderableObject.setShader(t),e=0;e<this._subnodes.length;e++)this._subnodes[e].setShader(t)},c.prototype.markAsReusable=function(){var t;for(this._renderableObject.markAsReusable(),t=0;t<this._subnodes.length;t++)this._subnodes[t].markAsReusable()},c.prototype.cleanUp=function(){var t,e,i;for(t=0;t<this._subnodes.length;t++){for(this._subnodes[t].cleanUp(),e=t,i=0;e<this._subnodes.length&&(!this._subnodes[e]||this._subnodes[e].canBeReused()===!0);)e++,i++;this._subnodes.splice(t,i)}},c.prototype.getMinimumCountForInstancing=function(){return this._minimumCountForInstancing},c.prototype.getNumberOfDrawnTriangles=function(t){var e,i=0;for(this._renderableObject._wasRendered&&(i+=this._renderableObject.getNumberOfDrawnTriangles(t)),e=0;e<this._subnodes.length;e++)i+=this._subnodes[e].getNumberOfDrawnTriangles(t);return i},c.prototype.destroy=function(){var t;if(this._renderableObject.setNode(null),this._renderableObject=null,this._scene=null,this._parent=null,this._subnodes){for(t=0;t<this._subnodes.length;t++)this._subnodes[t].destroy(),this._subnodes[t]=null;this._subnodes=null}this._renderParameters=null,this._cameraConfigurations=null},_.prototype.getNode=function(){return null===this._node&&(this._node=new c(this)),this._node},_.prototype.setNode=function(t){this._node=t},_.prototype.getShader=function(){return this._shader},_.prototype.setShader=function(t){this._shader=t},_.prototype.setTexture=function(t,e){this._textures[t]=e},_.prototype.setTextures=function(t){this._textures=t},_.prototype.isRenderedWithoutDepthMask=function(){return this._isRenderedWithoutDepthMask},_.prototype.isRenderedWithDepthMask=function(){return this._isRenderedWithDepthMask},_.prototype.setUniformValueFunction=function(t,e,i){this._uniformValueFunctions[r.getUniformName(t)]=e.bind(i||this)},_.prototype.setName=function(t){this._name=t},_.prototype.getName=function(){return this._name},_.prototype.createTextureLocationGetter=function(t,e){var i=e.getName();return function(){return this._textures[t].getLastTextureBindLocation(i)}.bind(this)},_.prototype.addToContext=function(t){var e;this._shader&&t.addShader(this._shader),this._instancedShader&&t.addShader(this._instancedShader);for(e in this._textures)this._textures.hasOwnProperty(e)&&(t.addTexture(this._textures[e]),this._textures[e]instanceof r.ManagedTexture?this.setUniformValueFunction(r.getTextureUniformRawName(e),this.createTextureLocationGetter(e,t)):this._textures[e]instanceof r.ManagedCubemap?this.setUniformValueFunction(r.getCubemapUniformRawName(e),this.createTextureLocationGetter(e,t)):o.showError("Attemtping to add a texture of unknown type ("+this._textures[e].constructor.name+") to the GL context."))},_.prototype.bindTextures=function(t){var e;for(e in this._textures)this._textures.hasOwnProperty(e)&&t.bindTexture(this._textures[e])},_.prototype.markAsReusable=function(){this._canBeReused=!0},_.prototype.canBeReused=function(){return this._canBeReused},_.prototype.resetForNewFrame=function(){this._wasRendered=!1,this._wasRenderedToShadowMap=!1},_.prototype.getRenderQueueBits=function(){return this._visible?j.FRONT_QUEUE_BIT:j.NONE},_.prototype.prepareForInstancedRender=function(t,e,i,n){t.setCurrentShader(this._instancedShader)&&e.assignUniforms(t,this._instancedShader),this.bindTextures(t),this._instancedShader.assignUniforms(t,this._uniformValueFunctions),this._instancedShader.createInstanceBuffers(i,n)},_.prototype.shouldBeRendered=function(t){return this._canBeReused!==!0&&this._visible?t.depthMask&&this._isRenderedWithDepthMask||!t.depthMask&&this._isRenderedWithoutDepthMask:!1},_.prototype.prepareForRender=function(t){t.useInstancing?this._instancedShader.addDataToInstanceBuffers(t.instanceQueueIndex,this._uniformValueFunctions):(t.context.setCurrentShader(this._shader)&&t.scene.assignUniforms(t.context,this._shader),this.bindTextures(t.context),this._shader.assignUniforms(t.context,this._uniformValueFunctions))},_.prototype.performRender=function(){return!0},_.prototype.finishRender=function(){this._wasRendered=!0},_.prototype.render=function(t){return this.shouldBeRendered(t)?(this.prepareForRender(t),t.useInstancing||this.performRender(t),this.finishRender(t),!0):!1},_.prototype._peformRenderInstances=function(t,e){o.showError("Cannot render "+e+" instances of "+this.constructor.name+" to "+t.getName()+" in instanced mode, because no instanced render method was defined for it!")},_.prototype.renderInstances=function(t,e,i){this._instancedShader.bindAndFillInstanceBuffers(t,e),this._peformRenderInstances(t,i)},_.prototype.shouldBeRenderedToShadowMap=function(){return!this._canBeReused&&this._visible&&this._castsShadows},_.prototype.wasRenderedToShadowMap=function(){return this._wasRenderedToShadowMap},_.prototype.prepareForRenderToShadowMap=function(){return!0},_.prototype.performRenderToShadowMap=function(){return!0},_.prototype.renderToShadowMap=function(t){return this.shouldBeRenderedToShadowMap(t)?(this.prepareForRenderToShadowMap(t),this.performRenderToShadowMap(t),this._wasRenderedToShadowMap=!0,!0):(this._wasRenderedToShadowMap=!1,!1)},_.prototype.shouldAnimate=function(t){return t>0},_.prototype.performAnimate=function(){return!0},_.prototype.animate=function(t){this.shouldAnimate(t)&&this.performAnimate(t)},_.prototype.wasRendered=function(){return this._wasRendered},_.prototype.getNumberOfDrawnTriangles=function(){return 0},_.prototype.shouldGoInSameRenderQueue=function(t){return this._shader===t.getShader()},_.prototype.shouldGoInSameRenderQueueInstanced=function(t){return this.constructor===t.constructor&&this._shader===t._shader},p.prototype=new _,H.call(p),p.prototype.constructor=_,p.prototype.setSmallestSizeWhenDrawn=function(t){this._smallestSizeWhenDrawn=t},p.prototype.getVisibleSize=function(t){return this._visibleSize.width<0&&(this._visibleSize=this.getSizeInsideViewFrustum(t.camera)),this._visibleSize},p.prototype.isInsideViewFrustum=function(t){return this.getVisibleSize(t).width>0},p.prototype.getSizeInPixels=function(t){return this.getVisibleSize(t),this._visibleSize.width<0&&o.showError("Attempting to access the size of an object on the screen in pixels, before the size has been calculated."),Math.max(this._visibleSize.width*t.viewportWidth/2,this._visibleSize.height*t.viewportHeight/2)},p.prototype.resetForNewFrame=function(){_.prototype.resetForNewFrame.call(this),p.prototype.resetCachedValues.call(this),this._visibleSize.width=-1,this._visibleSize.height=-1,this._insideShadowCastFrustum=null},p.prototype.getRenderQueueBits=function(t){var e,i,n,o=j.NONE;return e=this.getPositionMatrixInCameraSpace(t),i=this.getCascadeScalingMatrix(),n=this.getSize()*i[0],e[14]-n<=-t.getNearDistance()&&e[14]+n>-t.getViewDistance()&&(o|=j.FRONT_QUEUE_BIT),e[14]-n<=-t.getViewDistance()&&e[14]+n>-t.getExtendedCamera().getViewDistance()&&(o|=j.DISTANCE_QUEUE_BIT),o},p.prototype.shouldBeRendered=function(t){var e,i;return _.prototype.shouldBeRendered.call(this,t)?this.isInsideParent()===!0?void 0===t.parent.isInsideViewFrustum||t.parent.isInsideViewFrustum(t)?(e=t.parent.getVisibleSize(t),i=Math.max(this.getSize()/t.parent.getSize(),t.lodContext.minimumRelativeSize),this._visibleSize.width=e.width*i,this._visibleSize.height=e.height*i,this.getSizeInPixels(t)<this._smallestSizeWhenDrawn?!1:!0):(this._visibleSize.width=0,this._visibleSize.height=0,!1):(e=this.getVisibleSize(t),this.getSizeInPixels(t)<this._smallestSizeWhenDrawn?!1:this.isInsideViewFrustum(t)):!1},p.prototype.shouldBeRenderedToShadowMap=function(t){return _.prototype.shouldBeRenderedToShadowMap.call(this,t)?this.isInsideParent()===!0?t.parent.wasRenderedToShadowMap():this.isInsideShadowRegion(t.lightMatrix,t.shadowMapRange,t.shadowMapDepthRatio):!1},d.prototype=new _,d.prototype.constructor=d,d.prototype.addToContext=function(t){_.prototype.addToContext.call(this,t),this._model.addToContext(t,!1)},d.prototype.performRender=function(t){this._model.render(t.context,!1)},d.prototype.getNumberOfDrawnTriangles=function(){return 2},g.prototype=new p,g.prototype.constructor=g,g.prototype.LOD_NOT_SET=-1,g.prototype.addToContext=function(t){var e;for(p.prototype.addToContext.call(this,t),this._model.addToContext(t,this._wireframe),e=this._model.getMinLOD();e<=this._model.getMaxLOD();e++)this._model.getSize(e)>this._modelSize&&(this._modelSize=this._model.getSize(e))},g.prototype.getSize=function(){return this._modelSize},g.prototype.getLODSize=function(t,e){return void 0===this._lodSizeFactors[e.toString()]&&(this._lodSizeFactors[e.toString()]=Math.log10(e+10)/Math.log10(this.getScaledSize()+10)),t*this._lodSizeFactors[e.toString()]},g.prototype.getHeight=function(){return this._model.getHeight()},g.prototype.getHeightInMeters=function(){return this._model.getHeightInMeters()},g.prototype.getMaxY=function(){return this._model.getMaxY()},g.prototype.getCurrentLOD=function(t){var e,i,n;if(this._currentLOD===this.LOD_NOT_SET)if(this._staticLOD!==this.LOD_NOT_SET)this._currentLOD=this._model.getClosestAvailableLOD(this._staticLOD);else if(e=this.getSizeInPixels(t),i=t.lodContext.compensateForObjectSize?this.getLODSize(e,t.lodContext.referenceSize):e,i>0)for(n=Math.min(this._model.getMaxLOD(),t.lodContext.maxEnabledLOD);n>=this._model.getMinLOD();n--)if(t.lodContext.thresholds[n]<=i){this._currentLOD=n;break}return this._currentLOD!==this.LOD_NOT_SET?(this._lastLOD=this._currentLOD,this._currentLOD):this._lastLOD!==this.LOD_NOT_SET?this._lastLOD:qt},g.prototype.resetForNewFrame=function(){p.prototype.resetForNewFrame.call(this),this._staticLOD===this.LOD_NOT_SET&&(this._currentLOD=this.LOD_NOT_SET)},g.prototype.shouldBeRendered=function(t){if(p.prototype.shouldBeRendered.call(this,t)){if(this._wireframe===!0)return!0;if(t.depthMask===!0){if(this._model.getNumOpaqueTriangles(this.getCurrentLOD(t))>0)return!0}else if(t.depthMask===!1&&this._model.getNumTransparentTriangles(this.getCurrentLOD(t))>0)return!0;return!1}return!1},g.prototype.performRender=function(t){this._model.render(t.context,this._wireframe,t.depthMask,this.getCurrentLOD(t))},g.prototype.shouldBeRenderedToShadowMap=function(t){return p.prototype.shouldBeRenderedToShadowMap.call(this,t)?this._model.getNumOpaqueTriangles(this.getCurrentLOD(t))>0:void 0},g.prototype.prepareForRenderToShadowMap=function(t){t.context.getCurrentShader().assignUniforms(t.context,this._uniformValueFunctions)},g.prototype.performRenderToShadowMap=function(t){this._model.render(t.context,this._wireframe,!0,this.getCurrentLOD(t)),o.log("Rendered model ("+this._model.getName()+") to shadow map.",5)},g.prototype.getNumberOfDrawnTriangles=function(t){return this._wireframe===!1&&this._currentLOD!==this.LOD_NOT_SET?this._model.getNumTriangles(this._currentLOD,t):0},f.prototype=new g([]),f.prototype.constructor=f,f.prototype.createGetParameterArrayFunction=function(t){return function(){return this._parameterArrays[t]}},f.prototype.setFloatParameter=function(t,e,i){this._parameterArrays[t][e]=i},f.prototype.setMat4Parameter=function(t,e,i){var n;for(n=0;16>n;n++)this._parameterArrays[t][16*e+n]=i[n]},m.prototype=new p,m.prototype.constructor=m,m.prototype.init=function(t,e,i,o,r,s,a){var h=[o];p.call(this,e,!1,!0,r,s,n.scaling4(o),a),this.setTextures(i),this._model=t,this.setUniformValueFunction(tt,function(){return this.getModelMatrix()}),this.setUniformValueFunction(at,function(){return this.getPositionVector()}),this.setUniformValueFunction(ht,function(){return n.getRowB43(this._orientationMatrix)}),this.setUniformValueFunction(lt,function(t){return t?h:o})},m.prototype.addToContext=function(t){p.prototype.addToContext.call(this,t),this._model.addToContext(t,!1)},m.prototype.isInsideViewFrustum=function(){return!0},m.prototype.performRender=function(t){this._model.render(t.context,!1)},m.prototype._peformRenderInstances=function(t,e){this._model.renderInstances(t,!1,void 0,void 0,e)},m.prototype.shouldBeRenderedToShadowMap=function(){return!1},m.prototype.getNumberOfDrawnTriangles=function(t){return t!==!1?this._model.getNumTriangles():0},m.prototype.shouldGoInSameRenderQueueInstanced=function(t){return p.prototype.shouldGoInSameRenderQueueInstanced.call(this,t)&&this._textures===t._textures&&this._model===t._model},T.prototype=new p,T.prototype.constructor=T,T.prototype.init=function(t,e,i,o,r,s,a,h){var l,u;if(p.call(this,e,!1,!0,o,n.IDENTITY4,n.IDENTITY4,a),this.setTextures(i),this._model=t,r)for(l=0;l<r[0].color.length;l++)this._color[l]=r[0].color[l];this._size=void 0!==h?h:r?r[0].size:0,this._relativeSize=1,this._calculateSize(),this._states=r||[],this._currentStateIndex=0,this._looping=s===!0,this._timeSinceLastTransition=0,this._velocityVector[0]=0,this._velocityVector[1]=0,this._velocityVector[2]=0,this._shouldAnimate=!1,this.setUniformValueFunction(at,function(){return u=this.getModelMatrix(),this._positionVector[0]=u[12],this._positionVector[1]=u[13],this._positionVector[2]=u[14],this._positionVector}),this.setUniformValueFunction(it,function(t){return t?this._calculatedSize:this._calculatedSize[0]}),this.setUniformValueFunction(nt,function(){return this._color}),this._updateShouldAnimate()},T.prototype._calculateSize=function(){this._calculatedSize[0]=this._size*this._relativeSize,this._visible=this._calculatedSize[0]>=Gt},T.prototype.getSize=function(){return this._calculatedSize[0]},T.prototype._hasVelocity=function(){return this._velocityVector&&(0!==this._velocityVector[0]||0!==this._velocityVector[1]||0!==this._velocityVector[2])},T.prototype._updateShouldAnimate=function(){this._shouldAnimate=this._states.length>1||this._hasVelocity()},T.prototype.getRelativeSize=function(){return this._relativeSize},T.prototype.setRelativeSize=function(t){this._relativeSize=t,this._calculateSize()},T.prototype.getVelocityVector=function(){return this._velocityMatrix},T.prototype.setVelocityVector=function(t){this._velocityVector=t,this._updateShouldAnimate()},T.prototype.getStates=function(){return this._states},T.prototype.addToContext=function(t){p.prototype.addToContext.call(this,t),this._model.addToContext(t,!1)},T.prototype.isInsideViewFrustum=function(){return this._parent&&this.isInsideParent()?this._parent.isInsideViewFrustum():!0},T.prototype.getRenderQueueBits=function(t){return this._visible?p.prototype.getRenderQueueBits.call(this,t):j.NONE},T.prototype.shouldBeRendered=function(t){return this._visible?p.prototype.shouldBeRendered.call(this,t):!1},T.prototype.performRender=function(t){this._model.render(t.context,!1)},T.prototype._peformRenderInstances=function(t,e){this._model.renderInstances(t,!1,void 0,void 0,e)},T.prototype.shouldBeRenderedToShadowMap=function(){return!1},T.prototype.shouldAnimate=function(t){return p.prototype.shouldAnimate.call(this,t)?this._shouldAnimate:!1},T.prototype.performAnimate=function(t){var e,n,o;if(this._states.length>1){for(this._timeSinceLastTransition+=t,e=(this._currentStateIndex+1)%this._states.length;this._timeSinceLastTransition>this._states[e].timeToReach;){if(0===e&&!this._looping)return this._size=0,void this.markAsReusable();this._timeSinceLastTransition-=this._states[e].timeToReach,e=(e+1)%this._states.length}for(this._currentStateIndex=0===e?this._states.length-1:e-1,n=this._timeSinceLastTransition/this._states[e].timeToReach,o=0;o<this._color.length;o++)this._color[o]=this._states[this._currentStateIndex].color[o]*(1-n)+this._states[e].color[o]*n;this._size=this._states[this._currentStateIndex].size*(1-n)+this._states[e].size*n,this._calculateSize()}this._hasVelocity()&&this.translatev(i.scaled3(this._velocityVector,t/1e3))},T.prototype.getNumberOfDrawnTriangles=function(t){return t!==!1?2:0},T.prototype.shouldGoInSameRenderQueueInstanced=function(t){return p.prototype.shouldGoInSameRenderQueueInstanced.call(this,t)&&this._textures===t._textures&&this._model===t._model},E.prototype=new T,E.prototype.constructor=E,E.prototype.isInsideViewFrustum=function(){return!0},E.prototype.shouldBeRendered=function(t){return _.prototype.shouldBeRendered.call(this,t)},b.prototype.getDuration=function(){return this._duration},b.prototype.getParticleDuration=function(){var t,e;if(-1===this._particleDuration)for(this._particleDuration=0,e=this._particleConstructor()._states,t=0;t<e.length;t++)this._particleDuration+=e[t].timeToReach;return this._particleDuration},b.prototype._createParticle=function(){var t,e;return t=this._particleConstructor(),e=[this._positionMatrix[12]+(Math.random()-.5)*this._dimensions[0],this._positionMatrix[13]+(Math.random()-.5)*this._dimensions[1],this._positionMatrix[14]+(Math.random()-.5)*this._dimensions[2]],t.setPositionMatrix(n.translation4v(i.mulVec3Mat4(e,this._orientationMatrix))),t},b.prototype.emitParticles=function(t,e){var i,n,o;if(i=[],void 0===e&&(e=1),0===this._age)for(o=Math.round(this._initialNumber*e),this._initialNumber>0&&1>o&&(o=1),n=0;o>n;n++)i.push(this._createParticle());for(this._age+=t;this._age-this._lastSpawn>this._spawnTime&&(this._lastSpawn<=this._duration||0===this._duration);){for(o=Math.round(this._spawnNumber*e),this._spawnNumber>0&&1>o&&(o=1),n=0;o>n;n++)i.push(this._createParticle());this._lastSpawn+=this._spawnTime}return i},A.prototype=new b,A.prototype.constructor=A,A.prototype._createParticle=function(){var t,e,o=b.prototype._createParticle.call(this);return t=this._velocity+(Math.random()-.5)*this._velocitySpread,e=n.translation4(0,t,0),n.rotate4(e,i.UNIT3_X,2*Math.random()*Math.PI),n.rotate4(e,i.UNIT3_Z,2*Math.random()*Math.PI),o.setVelocityVector(n.translationVector3(e)),o},O.prototype=new b,O.prototype.constructor=O,O.prototype._createParticle=function(){var t,e,o,r=b.prototype._createParticle.call(this);return t=this._velocity+(Math.random()-.5)*this._velocitySpread,e=n.translation4v(i.scaled3(this._direction,t)),o=Math.abs(this._direction[0])<.75?[1,0,0]:Math.abs(this._direction[1])<.75?[0,1,0]:[0,0,1],i.mulCross3(o,this._direction),i.normalize3(o),n.rotate4(e,o,Math.random()*this._directionSpread/180*Math.PI),n.rotate4(e,this._direction,360*Math.random()/180*Math.PI),r.setVelocityVector(n.translationVector3(e)),r},R.prototype=new b,R.prototype.constructor=O,R.prototype._createParticle=function(){var t,e,o,r=b.prototype._createParticle.call(this);return e=this._velocity+(Math.random()-.5)*this._velocitySpread,t=Math.abs(this._planeNormal[0])<.75?[1,0,0]:Math.abs(this._planeNormal[1])<.75?[0,1,0]:[0,0,1],i.mulCross3(t,this._planeNormal),i.normalize3(t),o=n.translation4v(i.scaled3(t,e)),n.rotate4(o,i.cross3(t,this._planeNormal),(Math.random()-.5)*this._directionSpread/180*Math.PI),n.rotate4(o,this._planeNormal,2*Math.random()*Math.PI),r.setVelocityVector(n.translationVector3(o)),r},v.prototype=new p,v.prototype.constructor=v,v.prototype.shouldBeRendered=function(){return!1},v.prototype.performAnimate=function(t){var e,o,r,s,a,h;if(!this._keepAlive&&this._age>this._duration)return void this.getNode().markAsReusable();if(this._age+=t,this._emitters)for(e=0;e<this._emitters.length;e++)if(r=this._emitters[e].emitParticles(t,this._particleCountFactor),this._carriesParticles)for(o=0;o<r.length;o++)this.getNode().addSubnode(new c(r[o],!1,this._minimumCountForInstancing));else for(s=this.getModelMatrix(),a=n.translation4m4(s),h=n.rotation4m4(s),o=0;o<r.length;o++)r[o].translateByMatrix(a),r[o].rotateByMatrix(h),this.getNode()._scene.addNode(new c(r[o],!1,this._minimumCountForInstancing));this.translatev(i.scaled3(n.translationVector3(this._velocityMatrix),t/1e3))},v.prototype.finishEmitting=function(){var t,e,i=0;if(this._keepAlive=!1,this._age=0,this._carriesParticles){if(this._emitters){for(t=0;t<this._emitters;t++)e=this._emitters[t]._duration+this._emitters[t].getParticleDuration(),e>i&&(i=e);this._emitters=null}this._duration=i}else this.getNode().markAsReusable()},C.prototype=new _,C.prototype.constructor=C,C.prototype.addToContext=function(t){_.prototype.addToContext.call(this,t),this._model.addToContext(t,!1)},C.prototype.setShift=function(t,e,i){this._shift[0]=t,this._shift[1]=e,this._shift[2]=i},C.prototype.fitPositionWithinRange=function(t,e){var i;for(i=0;3>i;i++){for(;this._positionVector[i]>t[12+i]+e;)this._positionVector[i]-=2*e;for(;this._positionVector[i]<t[12+i]-e;)this._positionVector[i]+=2*e}},C.prototype.performRender=function(t){this._model.render(t.context,!0)},C.prototype._peformRenderInstances=function(t,e){this._model.renderInstances(t,!0,!1,void 0,e)},C.prototype.shouldBeRenderedToShadowMap=function(){return!1},C.prototype.shouldAnimate=function(){return!1},C.prototype.shouldGoInSameRenderQueueInstanced=function(t){return _.prototype.shouldGoInSameRenderQueueInstanced.call(this,t)&&this._color===t._color&&this._range===t._range},I.prototype=new _,I.prototype.constructor=I,I.prototype.performRender=function(t){this._model.render(t.context)},I.prototype.setPosition=function(t){this._position=t},I.prototype.setSize=function(t){this._size=t},I.prototype.setColor=function(t){this._color=t},I.prototype.setAngle=function(t){this._rotationMatrix=n.rotation2(t)},I.prototype.setClipCoordinates=function(t){this._clipCoordinates=t},I.prototype.clipX=function(t,e){this._clipCoordinates[0]=t,this._clipCoordinates[1]=e},I.prototype.clipY=function(t,e){this._clipCoordinates[2]=1-e,this._clipCoordinates[3]=1-t},I.prototype.setClipColor=function(t){this._clipColor=t},L.prototype.copy=function(t){var e=new L(this._fixed,this._turnsAroundObjects,this._movesRelativeToObject,this._followedObjects.slice(),this._startsWithRelativePosition,n.matrix4(this._defaultRelativePositionMatrix),this._distanceIsConfined?[this._minimumDistance,this._maximumDistance]:null,[this._xIsConfined?[this._minimumX,this._maximumX]:null,this._yIsConfined?[this._minimumY,this._maximumY]:null,this._zIsConfined?[this._minimumZ,this._maximumZ]:null],this._resetsWhenLeavingConfines,t);return e._relativePositionMatrix=n.matrix4(this._relativePositionMatrix),e._worldPositionMatrix=n.matrix4(this._worldPositionMatrix),e._isStarting=this._isStarting,e},L.prototype.setCamera=function(t,e){t&&this._camera!==t&&this._startsWithRelativePosition&&!e&&this.resetToDefaults(!0),this._camera=t},L.prototype.resetToDefaults=function(t){this._camera&&!t&&this._camera.positionConfigurationWillChange(),n.setMatrix4(this._relativePositionMatrix,this._defaultRelativePositionMatrix),this._worldPositionMatrix=null,this._isStarting=!0},L.prototype.setRelativePositionMatrix=function(t,e){this._camera&&!e&&this._camera.positionConfigurationWillChange(),this._relativePositionMatrix=t},L.prototype.moveByVector=function(t,e){this._camera&&!e&&this._camera.positionConfigurationWillChange(),n.translateByVector(this._relativePositionMatrix,t)},L.prototype.followsObjects=function(e){return e?t.arraysEqual(this._followedObjects.sort(),e.sort()):this._followedObjects.length>0&&!this._startsWithRelativePosition},L.prototype.getFollowedPositionVector=function(){var t,e=[0,0,0];if(0===this._followedObjects.length)o.crash();else{for(t=0;t<this._followedObjects.length;t++)i.add3(e,this._followedObjects[t].getPositionVector());e=[e[0]/this._followedObjects.length,e[1]/this._followedObjects.length,e[2]/this._followedObjects.length]}return e},L.prototype.getFollowedPositionMatrix=function(){var t,e=n.identity4();if(0===this._followedObjects.length)o.crash();else{for(t=0;t<this._followedObjects.length;t++)n.translateByMatrix(e,this._followedObjects[t]._positionMatrix);e=n.translation4(e[12]/this._followedObjects.length,e[13]/this._followedObjects.length,e[14]/this._followedObjects.length)}return e},L.prototype.getFollowedObjectOrientationMatrix=function(){var t;return 0===this._followedObjects.length?o.crash():t=n.matrix4(this._followedObjects[0]._orientationMatrix),t},L.prototype._cleanupFollowedObjects=function(){var t,e,i;for(t=0;t<this._followedObjects.length;t++){for(e=t,i=0;e<this._followedObjects.length&&(!this._followedObjects[e]||this._followedObjects[e].canBeReused()===!0);)e++,i++;i>0&&(this._followedObjects.splice(t,i),0===this._followedObjects.length&&n.setMatrix4(this._relativePositionMatrix,this._worldPositionMatrix||this._relativePositionMatrix||this._defaultRelativePositionMatrix))}},L.prototype._calculateWorldPositionMatrix=function(t){this._followedObjects.length>0&&(!this._startsWithRelativePosition||this._isStarting)?(this._isStarting=!1,this._turnsAroundObjects?t?this._worldPositionMatrix=n.translatedByM4(n.translation4m4(n.prodTranslationRotation4(this._relativePositionMatrix,n.prod3x3SubOf4(n.rotation4([1,0,0],Math.PI/2),t))),this.getFollowedPositionMatrix()):o.crash():this._worldPositionMatrix=n.translatedByM4(n.translation4m4(n.prodTranslationRotation4(this._relativePositionMatrix,this.getFollowedObjectOrientationMatrix())),this.getFollowedPositionMatrix()),this._startsWithRelativePosition&&(this._relativePositionMatrix=n.matrix4(this._worldPositionMatrix))):this._worldPositionMatrix=n.matrix4(this._relativePositionMatrix)},L.prototype.getWorldPositionMatrix=function(t){return this._worldPositionMatrix||this._calculateWorldPositionMatrix(t),this._worldPositionMatrix},L.prototype._checkConfines=function(t){var e,r,s;if(s=this._startsWithRelativePosition&&!this._isStarting&&this._followedObjects.length>0?n.translation4m4(n.prodTranslationRotation4(n.translatedByM4(this._relativePositionMatrix,n.inverseOfTranslation4(this.getFollowedPositionMatrix())),n.inverseOfRotation4(this.getFollowedObjectOrientationMatrix()))):this._relativePositionMatrix,this._distanceIsConfined)if(this._followedObjects.length>0){if(e=n.translationVector3(s),r=i.length3(e),r<this._minimumDistance||r>this._maximumDistance){if(r>this._maximumDistance&&this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;r=Math.min(Math.max(r,this._minimumDistance),this._maximumDistance),s=n.translation4v(i.scaled3(i.normal3(e),r))}}else if(t&&(e=i.diff3(n.translationVector3(s),t),r=i.length3(e),r<this._minimumDistance||r>this._maximumDistance)){if(r>this._maximumDistance&&this._resetsWhenLeavingConfines)return o.crash(),!1;r=Math.min(Math.max(r,this._minimumDistance),this._maximumDistance),s=n.translation4v(i.sum3(t,i.scaled3(i.normal3(e),r)))}if(this._xIsConfined&&(s[12]<this._minimumX||s[12]>this._maximumX)){
if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;s[12]=Math.min(Math.max(s[12],this._minimumX),this._maximumX)}if(this._yIsConfined&&(s[13]<this._minimumY||s[13]>this._maximumY)){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;s[13]=Math.min(Math.max(s[13],this._minimumY),this._maximumY)}if(this._zIsConfined&&(s[14]<this._minimumZ||s[14]>this._maximumZ)){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;s[14]=Math.min(Math.max(s[14],this._minimumZ),this._maximumZ)}return this._startsWithRelativePosition&&!this._isStarting&&this._followedObjects.length>0?this._relativePositionMatrix=n.translatedByM4(n.translation4m4(n.prodTranslationRotation4(s,this.getFollowedObjectOrientationMatrix())),this.getFollowedPositionMatrix()):this._relativePositionMatrix=s,!0},L.prototype.update=function(t,e,o,r){var s,a;if(!this._fixed)if(0===this._followedObjects.length||this._startsWithRelativePosition)s=i.scaled3(i.mulVec3Mat4(o,t),r/1e3),n.translateByVector(this._relativePositionMatrix,s);else if(this._turnsAroundObjects){if(this._distanceIsConfined){if(s=n.translationVector3(this._relativePositionMatrix),a=i.length3(s)+o[2]*r/1e3,a<this._minimumDistance||a>this._maximumDistance){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;o[2]=0,a=Math.min(Math.max(a,this._minimumDistance),this._maximumDistance)}this._relativePositionMatrix=n.translation4v(i.scaled3(i.normal3(s),a))}}else this._movesRelativeToObject?n.translateByVector(this._relativePositionMatrix,i.scaled3(i.mulVec3Mat4(o,n.rotation4([1,0,0],-Math.PI/2)),r/1e3)):n.translateByVector(this._relativePositionMatrix,i.scaled3(i.mulVec3Mat4(o,n.prod3x3SubOf4(t,n.inverseOfRotation4(this.getFollowedObjectOrientationMatrix()))),r/1e3));if(!this._isTransitionConfiguration){if(!this._checkConfines(e))return!1;this._cleanupFollowedObjects()}return this._worldPositionMatrix=null,!0},N.prototype.BaseOrientation={WORLD:"world",POSITION_FOLLOWED_OBJECTS:"positionFollowedObjects",ORIENTATION_FOLLOWED_OBJECT:"orientationFollowedObject"},Object.freeze(N.prototype.BaseOrientation),N.prototype.PointToFallback={WORLD:"world",STATIONARY:"stationary",POSITION_FOLLOWED_OBJECT_OR_WORLD:"positionFollowedObjectOrWorld"},Object.freeze(N.prototype.PointToFallback),N.prototype.copy=function(t){var e=new N(this._fixed,this._pointsTowardsObjects,this._fps,this._followedObjects.slice(),n.matrix4(this._defaultRelativeOrientationMatrix),this._alpha,this._beta,[this._minAlpha,this._maxAlpha],[this._minBeta,this._maxBeta],this._baseOrientation,this._pointToFallback,t);return e._relativeOrientationMatrix=n.matrix4(this._relativeOrientationMatrix),e._worldOrientationMatrix=n.matrix4(this._worldOrientationMatrix),e},N.prototype.setCamera=function(t){this._camera=t},N.prototype.resetToDefaults=function(t){this._camera&&!t&&this._camera.orientationConfigurationWillChange(),n.setMatrix4(this._relativeOrientationMatrix,this._defaultRelativeOrientationMatrix),this._alpha=this._defaultAlpha,this._beta=this._defaultBeta,this._worldOrientationMatrix=null},N.prototype.setRelativeOrientationMatrix=function(t,e){this._camera&&!e&&this._camera.orientationConfigurationWillChange(),this._relativeOrientationMatrix=t},N.prototype.isFPS=function(){return this._fps},N.prototype.followsObjects=function(e){return e?t.arraysEqual(this._followedObjects.sort(),e.sort()):this._followedObjects.length>0},N.prototype.setFollowedObjects=function(t,e){(0!==this._followedObjects.length||0!==t.length)&&(this._camera&&!e&&this._camera.orientationConfigurationWillChange(),this._followedObjects=t)},N.prototype.setFollowedObject=function(t,e){(1!==this._followedObjects.length||this._followedObjects[0]!==t)&&this.setFollowedObjects([t],e)},N.prototype.getFollowedObjectsPositionVector=function(){var t,e=[0,0,0];if(0===this._followedObjects.length)o.crash();else{for(t=0;t<this._followedObjects.length;t++)i.add3(e,this._followedObjects[t].getPositionVector());e=[e[0]/this._followedObjects.length,e[1]/this._followedObjects.length,e[2]/this._followedObjects.length]}return e},N.prototype.getFollowedOrientationMatrix=function(){var t;return 0===this._followedObjects.length?o.crash():t=n.matrix4(this._followedObjects[0]._orientationMatrix),t},N.prototype._cleanupFollowedObjects=function(){var t,e,i;for(t=0;t<this._followedObjects.length;t++){for(e=t,i=0;e<this._followedObjects.length&&(!this._followedObjects[e]||this._followedObjects[e].canBeReused()===!0);)e++,i++;if(i>0){if(this._followedObjects.length===i)return this._camera&&this._camera.orientationConfigurationWillChange(),this._pointsTowardsObjects||(n.setMatrix4(this._relativeOrientationMatrix,this._worldOrientationMatrix||this._relativeOrientationMatrix||this._defaultRelativeOrientationMatrix),this._fps=!1),this._followedObjects.splice(t,i),!1;this._followedObjects.splice(t,i)}}return!0},N.prototype._calculateWorldOrientationMatrix=function(t,e){var r,s,a,h=function(t){this._worldOrientationMatrix=n.prod3x3SubOf4(n.prod3x3SubOf4(n.rotation4([1,0,0],-Math.PI/2),this._relativeOrientationMatrix),t)}.bind(this),l=function(){this._fps?this._worldOrientationMatrix=n.prod3x3SubOf4(n.rotation4([1,0,0],-Math.PI/2),this._relativeOrientationMatrix):this._worldOrientationMatrix=n.matrix4(this._relativeOrientationMatrix)}.bind(this);if(this._followedObjects.length>0)if(this._pointsTowardsObjects)if(t)if(s=i.normal3(i.diff3(this.getFollowedObjectsPositionVector(),n.translationVector3(t))),this._fps){switch(this._baseOrientation){case this.BaseOrientation.WORLD:r=null;break;case this.BaseOrientation.POSITION_FOLLOWED_OBJECTS:r=e||null;break;case this.BaseOrientation.ORIENTATION_FOLLOWED_OBJECT:r=this.followsObjects()?this.getFollowedOrientationMatrix():null;break;default:o.crash()}r?s=i.mulVec3Mat4(s,n.inverseOfRotation4(r)):r=n.IDENTITY4,this._alpha=i.angle2uCapped([0,1],i.normal2([s[0],s[1]])),s[0]<0&&(this._alpha=-this._alpha),this._worldOrientationMatrix=n.prod3x3SubOf4(n.rotation4([1,0,0],-Math.PI/2),n.rotation4([0,0,1],this._alpha)),this._beta=i.angle3uCapped(n.getRowC43Neg(this._worldOrientationMatrix),s),s[2]>0&&(this._beta=-this._beta),this._worldOrientationMatrix=n.prod3x3SubOf4(n.prod3x3SubOf4(n.rotation4([1,0,0],-Math.PI/2),n.rotation4([1,0,0],this._beta)),n.rotation4([0,0,1],this._alpha)),n.mul4(this._worldOrientationMatrix,r)}else this._worldOrientationMatrix||(this._worldOrientationMatrix=n.identity4()),this._worldOrientationMatrix[8]=s[0],this._worldOrientationMatrix[9]=s[1],this._worldOrientationMatrix[10]=s[2],a=i.cross3([1,0,0],s),this._worldOrientationMatrix[4]=a[0],this._worldOrientationMatrix[5]=a[1],this._worldOrientationMatrix[6]=a[2],a=i.cross3(s,a),this._worldOrientationMatrix[0]=a[0],this._worldOrientationMatrix[1]=a[1],this._worldOrientationMatrix[2]=a[2],this._worldOrientationMatrix=n.correctedOrthogonal4(this._worldOrientationMatrix);else o.crash();else h(this.getFollowedOrientationMatrix());else if(this._pointsTowardsObjects)switch(this._pointToFallback){case this.PointToFallback.WORLD:l();break;case this.PointToFallback.STATIONARY:this._worldOrientationMatrix||(this._worldOrientationMatrix=n.identity4());break;case this.PointToFallback.POSITION_FOLLOWED_OBJECT_OR_WORLD:e?h(e):l();break;default:o.crash()}else l()},N.prototype.getWorldOrientationMatrix=function(t,e){return this._worldOrientationMatrix||this._calculateWorldOrientationMatrix(t,e),this._worldOrientationMatrix},N.prototype.update=function(t,e){return!this._pointsTowardsObjects||this.followsObjects()||this._pointToFallback!==this.PointToFallback.STATIONARY?(this._fixed||(this._fps?(this._alpha+=t[1]*e/1e3,this._beta+=t[0]*e/1e3,this._alpha>=360&&(this._alpha-=360),this._alpha<=-360&&(this._alpha+=360),this._beta>=360&&(this._beta-=360),this._beta<=-360&&(this._beta+=360),this._alpha=Math.min(Math.max(this._minAlpha,this._alpha),this._maxAlpha),this._beta=Math.min(Math.max(this._minBeta,this._beta),this._maxBeta),this._relativeOrientationMatrix=n.prod3x3SubOf4(n.rotation4([1,0,0],this._beta*Math.PI/180),n.rotation4([0,0,1],this._alpha*Math.PI/180))):this._followedObjects.length>0?n.mul4(this._relativeOrientationMatrix,n.prod34(n.rotation4(i.normal3(n.getRowB43(this._relativeOrientationMatrix)),t[2]*Math.PI/180*e/1e3),n.rotation4(i.normal3(n.getRowA43(this._relativeOrientationMatrix)),t[0]*Math.PI/180*e/1e3),n.rotation4(i.normal3(n.getRowC43(this._relativeOrientationMatrix)),t[1]*Math.PI/180*e/1e3))):n.mul4(this._relativeOrientationMatrix,n.prod34(n.rotation4(i.normal3(n.getRowC43(this._relativeOrientationMatrix)),t[2]*Math.PI/180*e/1e3),n.rotation4(i.normal3(n.getRowA43(this._relativeOrientationMatrix)),t[0]*Math.PI/180*e/1e3),n.rotation4(i.normal3(n.getRowB43(this._relativeOrientationMatrix)),t[1]*Math.PI/180*e/1e3)))),this._isTransitionConfiguration||this._cleanupFollowedObjects()?(this._worldOrientationMatrix=null,!0):!1):void 0},H.call(w),w.prototype.copy=function(t,e){var i=new w(t||"",this._positionConfiguration.copy(e),this._orientationConfiguration.copy(e),this._fov,[this._minFOV,this._maxFOV],this._span,[this._minSpan,this._maxSpan]);return i.setPositionMatrix(n.matrix4(this._positionMatrix)),i.setOrientationMatrix(n.matrix4(this._orientationMatrix)),i},w.prototype.setCamera=function(t,e){this._camera=t,this._positionConfiguration.setCamera(t,e),this._orientationConfiguration.setCamera(t),this._camera&&this._resetsOnFocusChange&&!e&&this.resetToDefaults(!0)},w.prototype.setRelativePositionMatrix=function(t,e){this._positionConfiguration.setRelativePositionMatrix(t,e)},w.prototype.moveByVector=function(t,e){this._positionConfiguration.moveByVector(t,e)},w.prototype.setRelativeOrientationMatrix=function(t,e){this._orientationConfiguration.setRelativeOrientationMatrix(t,e)},w.prototype.getName=function(){return this._name},w.prototype.isFPS=function(){return this._orientationConfiguration.isFPS()},w.prototype.setFOV=function(t,e){this._camera&&!e&&this._camera.configurationWillChange(),this._fov=Math.min(Math.max(t,this._minFOV),this._maxFOV)},w.prototype.getFOV=function(){return this._fov},w.prototype.getMinFOV=function(){return this._minFOV},w.prototype.getMaxFOV=function(){return this._maxFOV},w.prototype.decreaseFOV=function(){return this.setFOV(this._fov*W,!0),this._fov},w.prototype.increaseFOV=function(){return this.setFOV(this._fov*q,!0),this._fov},w.prototype.setSpan=function(t,e){this._camera&&!e&&this._camera.configurationWillChange(),this._span=Math.min(Math.max(t,this._minSpan),this._maxSpan)},w.prototype.getSpan=function(){return this._span},w.prototype.getMinSpan=function(){return this._minSpan},w.prototype.getMaxSpan=function(){return this._maxSpan},w.prototype.decreaseSpan=function(){return this.setSpan(this._span*X,!0),this._span},w.prototype.increaseSpan=function(){return this.setSpan(this._span*Y,!0),this._span},w.prototype.resetsOnFocusChange=function(){return this._resetsOnFocusChange},w.prototype.resetToDefaults=function(t){this._camera&&!t&&this._camera.configurationWillChange(),this.setFOV(this._defaultFOV,!0),this.setSpan(this._defaultSpan,!0),this._positionConfiguration.resetToDefaults(!0),this._orientationConfiguration.resetToDefaults(!0)},w.prototype.update=function(t,e,i){var n=!0;return n=this._orientationConfiguration.update(e,i),this.setOrientationMatrix(this._orientationConfiguration.getWorldOrientationMatrix(this._positionMatrix,this._positionConfiguration.followsObjects()?this._positionConfiguration.getFollowedObjectOrientationMatrix():null)),n=this._positionConfiguration.update(this._orientationMatrix,this._orientationConfiguration.followsObjects()?this._orientationConfiguration.getFollowedObjectsPositionVector():null,t,i)&&n,this.setPositionMatrix(this._positionConfiguration.getWorldPositionMatrix(this._orientationMatrix)),n},w.prototype.positionFollowsObjects=function(){return this._positionConfiguration.followsObjects()},w.prototype.orientationFollowsObjects=function(){return this._orientationConfiguration.followsObjects()},w.prototype.getFollowedPositionVector=function(){return this._positionConfiguration.getFollowedPositionVector()},w.prototype.setOrientationFollowedObjects=function(t,e){this._orientationConfiguration.setFollowedObjects(t,e)},w.prototype.destroy=function(){this._positionConfiguration=null,this._orientationConfiguration=null,this._camera=null},F.prototype.TransitionStyle={NONE:"none",LINEAR:"linear",SMOOTH:"smooth"},Object.freeze(F.prototype.TransitionStyle),F.prototype.getViewDistance=function(){return this._viewDistance},F.prototype.getNearDistance=function(){return this._near},F.prototype.getCameraPositionMatrix=function(){return this._object3D._positionMatrix},F.prototype.getCameraPositionVector=function(){return this._object3D.getPositionVector()},F.prototype.getCameraOrientationMatrix=function(){return this._object3D._orientationMatrix},F.prototype._setPositionMatrix=function(t){this._object3D.setPositionMatrix(t),this._viewMatrix=null,this._inversePositionMatrix=null},F.prototype._setOrientationMatrix=function(t){this._object3D.setOrientationMatrix(t),this._viewMatrix=null,this._inverseOrientationMatrix=null},F.prototype._rotate=function(t,e){this._object3D.rotate(t,e),this._setOrientationMatrix(this._object3D._orientationMatrix)},F.prototype.moveToPosition=function(t,e,i){e=void 0===e?this._defaultTransitionDuration:e,e>0&&this.transitionToSameConfiguration(e,i),this._currentConfiguration.setRelativePositionMatrix(n.translation4v(t),!0)},F.prototype.getViewMatrix=function(){return this._viewMatrix||(this._viewMatrix=n.prodTranslationRotation4(this.getInversePositionMatrix(),this.getInverseOrientationMatrix())),this._viewMatrix},F.prototype.getInversePositionMatrix=function(){return this._inversePositionMatrix||(this._inversePositionMatrix=n.inverseOfTranslation4(this._object3D._positionMatrix)),this._inversePositionMatrix},F.prototype.getInverseOrientationMatrix=function(){return this._inverseOrientationMatrix||(this._inverseOrientationMatrix=n.inverseOfRotation4(this._object3D._orientationMatrix)),this._inverseOrientationMatrix},F.prototype.getConfiguration=function(){return this._currentConfiguration},F.prototype.getVelocityVector=function(){return this._velocityVector},F.prototype.getProjectionMatrix=function(){return this._projectionMatrix||this._updateProjectionMatrix(this._currentConfiguration.getFOV(),this._currentConfiguration.getSpan()),this._projectionMatrix},F.prototype._updateProjectionMatrix=function(t,e){this._near=e/2/Math.tan(Math.radians(t)/2),this._usesVerticalValues?this._projectionMatrix=n.perspective4(e*this._aspect/2,e/2,this._near,this._viewDistance):this._projectionMatrix=n.perspective4(e/2,e/this._aspect/2,this._near,this._viewDistance)},F.prototype.getAspect=function(){return this._aspect},F.prototype.setAspect=function(t){this._aspect=t,this._projectionMatrix=null},F.prototype.getFOV=function(){return this._fov||this._updateFOV(this._getTransitionProgress()),this._fov},F.prototype.setFOV=function(t,e,i){e=void 0===e?this._defaultTransitionDuration:e,e>0?this.transitionToSameConfiguration(e,i):this._fov=t,this._currentConfiguration.setFOV(t,!0),this._projectionMatrix=null},F.prototype.decreaseFOV=function(){this._fov=this._currentConfiguration.decreaseFOV(),this._projectionMatrix=null},F.prototype.increaseFOV=function(){this._fov=this._currentConfiguration.increaseFOV(),this._projectionMatrix=null},F.prototype.getSpan=function(){return this._span||this._updateSpan(this._getTransitionProgress()),this._span},F.prototype.setSpan=function(t,e,i){e=void 0===e?this._defaultTransitionDuration:e,e>0?this.transitionToSameConfiguration(e,i):this._span=t,this._currentConfiguration.setSpan(t,!0),this._projectionMatrix=null},F.prototype.decreaseSpan=function(){this._span=this._currentConfiguration.decreaseSpan(),this._projectionMatrix=null},F.prototype.increaseSpan=function(){this._span=this._currentConfiguration.increaseSpan(),this._projectionMatrix=null},F.prototype.setControlledVelocityVector=function(t){this._controlledVelocityVector=t},F.prototype.setAngularVelocityVector=function(t){this._angularVelocityVector=t},F.prototype._getFreeCameraConfiguration=function(t,e,i){return void 0===t&&(t=this._currentConfiguration.isFPS()),e=e||this.getCameraPositionMatrix(),i=i||this.getCameraOrientationMatrix(),t&&(i=n.prod3x3SubOf4(n.rotation4([1,0,0],Math.PI/2),i)),D(t,e,i,this.getFOV(),this._currentConfiguration.getMinFOV(),this._currentConfiguration.getMaxFOV(),this.getSpan(),this._currentConfiguration.getMinSpan(),this._currentConfiguration.getMaxSpan())},F.prototype.setConfiguration=function(t,e){this._currentConfiguration&&this._currentConfiguration.setCamera(null),this._currentConfiguration=t,this._currentConfiguration.setCamera(this,e),this._previousConfiguration=null},F.prototype.startTransitionToConfiguration=function(t,e,i){this._currentConfiguration!==t&&(0===e?this.setConfiguration(t):(this._previousConfiguration&&this._currentConfiguration?this._previousConfiguration=this._getFreeCameraConfiguration(!1):this._previousConfiguration=this._currentConfiguration,this._currentConfiguration&&this._currentConfiguration.setCamera(null),this._currentConfiguration=t,this._currentConfiguration.setCamera(this),this._transitionDuration=void 0===e?this._defaultTransitionDuration:e,this._transitionElapsedTime=0,this._transitionStyle=void 0===i?this._defaultTransitionStyle:i))},F.prototype.transitionToFreeCamera=function(t,e,i,n,o){this._followedNode=null,this.startTransitionToConfiguration(this._getFreeCameraConfiguration(t,e,i),n,o)},F.prototype.setToFreeCamera=function(t,e,i){this.transitionToFreeCamera(t,e,i,0)},F.prototype.transitionToSameConfiguration=function(t,e){var i=this._currentConfiguration;this.setConfiguration(this._previousConfiguration?this._getFreeCameraConfiguration(!1):this._currentConfiguration.copy("",!0),!0),this.startTransitionToConfiguration(i,t,e)},F.prototype.transitionToConfigurationDefaults=function(t,e){this.transitionToSameConfiguration(t,e),this._currentConfiguration.resetToDefaults(!0)},F.prototype.positionConfigurationWillChange=function(){this.transitionToSameConfiguration()},F.prototype.orientationConfigurationWillChange=function(){this.transitionToSameConfiguration()},F.prototype.configurationWillChange=function(){this.transitionToSameConfiguration()},F.prototype.getFollowedNode=function(){return this._followedNode},F.prototype.moveToOrigoIfNeeded=function(t){var e=this.getCameraPositionMatrix(),i=null;return(e[12]>t||e[12]<-t||e[13]>t||e[13]<-t||e[14]>t||e[14]<-t)&&(i=[-e[12],-e[13],-e[14]],this._currentConfiguration.positionFollowsObjects()||this._currentConfiguration.setRelativePositionMatrix(n.identity4(),!0),this._previousConfiguration&&!this._previousConfiguration.positionFollowsObjects()&&this._previousConfiguration.moveByVector(i,!0)),i},F.prototype.followNode=function(t,e,i,n){var o;return e||this._followedNode!==t?(this._followedNode=t,this._followedNode?(o=this._followedNode.getNextCameraConfiguration(),o?(this.startTransitionToConfiguration(o,i,n),!0):!1):(o=this._scene.getNextCameraConfiguration(),o?(this.startTransitionToConfiguration(o,i,n),!0):!1)):!0},F.prototype.followObject=function(t,e,i,n){return this.followNode(t.getNode(),e,i,n)},F.prototype.changeToNextView=function(t,e){this._followedNode?this.startTransitionToConfiguration(this._followedNode.getNextCameraConfiguration(this._currentConfiguration),t,e):this._scene.getNextCameraConfiguration()&&this.startTransitionToConfiguration(this._scene.getNextCameraConfiguration(this._scene.hasCameraConfiguration(this._currentConfiguration)?this._currentConfiguration:null),t,e)},F.prototype.changeToPreviousView=function(t,e){this._followedNode?this.startTransitionToConfiguration(this._followedNode.getPreviousCameraConfiguration(this._currentConfiguration),t,e):this._scene.getNextCameraConfiguration()&&this.startTransitionToConfiguration(this._scene.getPreviousCameraConfiguration(this._scene.hasCameraConfiguration(this._currentConfiguration)?this._currentConfiguration:null),t,e)},F.prototype.followNextNode=function(t,e,i){for(var n=this._scene.getNextNode(this._followedNode),o=this._followedNode;n!==o&&n&&!n.getNextCameraConfiguration();)if(o||(o=n),n=this._scene.getNextNode(n),t&&this._followedNode&&n===this._scene.getFirstNode()&&this.followNode(null,!0,e,i))return;n&&n.getNextCameraConfiguration()&&this.followNode(n,!0,e,i)},F.prototype.followPreviousNode=function(t,e,i){for(var n=this._scene.getFirstNode(),o=this._scene.getPreviousNode(this._followedNode),r=this._followedNode;o!==r&&o&&!o.getNextCameraConfiguration();){if(r||(r=o),t&&o===n&&this.followNode(null,!0,e,i))return;o=this._scene.getPreviousNode(o)}o&&o.getNextCameraConfiguration()&&this.followNode(o,!0,e,i)},F.prototype.followOrientationOfObjects=function(t,e,i){e=void 0===e?this._defaultTransitionDuration:e,e>0&&this.transitionToSameConfiguration(e,i),this._currentConfiguration.setOrientationFollowedObjects(t,!0)},F.prototype._getTransitionProgress=function(){var t;switch(this._transitionStyle){case this.TransitionStyle.LINEAR:return this._transitionElapsedTime/this._transitionDuration;case this.TransitionStyle.SMOOTH:return t=this._transitionElapsedTime/this._transitionDuration,t=3*t*t-2*t*t*t;default:o.crash()}return-1},F.prototype._updateFOV=function(t){this._fov=this._previousConfiguration?this._previousConfiguration.getFOV()+(this._currentConfiguration.getFOV()-this._previousConfiguration.getFOV())*t:this._currentConfiguration.getFOV()},F.prototype._updateSpan=function(t){this._span=this._previousConfiguration?this._previousConfiguration.getSpan()+(this._currentConfiguration.getSpan()-this._previousConfiguration.getSpan())*t:this._currentConfiguration.getSpan()},F.prototype.update=function(t){var e,o,r,s,a,h;if(this._extendedCamera=null,this._combinedExtendedCamera=null,this._previousConfiguration){if(!this._currentConfiguration.update([0,0,0],[0,0,0],t))return void this.update(t);if(this._transitionElapsedTime+=t,this._transitionElapsedTime>this._transitionDuration&&(this._transitionElapsedTime=this._transitionDuration),h=this._getTransitionProgress(),!this._previousConfiguration.update([0,0,0],[0,0,0],t))return void this.update(t);e=this._previousConfiguration.getPositionVector(),o=this._currentConfiguration.getPositionVector(),r=this.getCameraPositionVector(),this._setPositionMatrix(n.translation4v(i.sum3(i.scaled3(e,1-h),i.scaled3(o,h)))),this._velocityVector=i.scaled3(i.mulMat4Vec3(this.getCameraOrientationMatrix(),i.diff3(this.getCameraPositionVector(),r)),1e3/t),s=n.prod3x3SubOf4(n.inverseOfRotation4(this._previousConfiguration._orientationMatrix),this._currentConfiguration._orientationMatrix),a=n.getRotations(s),this._setOrientationMatrix(n.identity4()),this._rotate(a.gammaAxis,a.gamma*h),this._rotate(a.alphaAxis,a.alpha*h),this._setOrientationMatrix(n.correctedOrthogonal4(n.prod3x3SubOf4(this._previousConfiguration._orientationMatrix,this.getCameraOrientationMatrix()))),this._updateFOV(h),this._updateSpan(h),this._updateProjectionMatrix(this._fov,this._span),this._transitionElapsedTime===this._transitionDuration&&(this._previousConfiguration=null)}else{if(!this._currentConfiguration.update(this._controlledVelocityVector,this._angularVelocityVector,t))return void this.update(t);if(!this._currentConfiguration.update([0,0,0],[0,0,0],t))return void this.update(t);r=this.getCameraPositionVector(),this._setPositionMatrix(this._currentConfiguration._positionMatrix),this._setOrientationMatrix(this._currentConfiguration._orientationMatrix),this._currentConfiguration.positionFollowsObjects()?(this._previousFollowedPositionVector?this._velocityVector=i.scaled3(i.mulMat4Vec3(this.getCameraOrientationMatrix(),i.diff3(this._currentConfiguration.getFollowedPositionVector(),this._previousFollowedPositionVector)),1e3/t):this._velocityVector=[0,0,0],this._previousFollowedPositionVector=this._currentConfiguration.getFollowedPositionVector()):this._velocityVector=i.scaled3(i.mulMat4Vec3(this.getCameraOrientationMatrix(),i.diff3(this.getCameraPositionVector(),r)),1e3/t)}},F.prototype.getExtendedCamera=function(t){var e,i;return!t&&this._extendedCamera?this._extendedCamera:t&&this._combinedExtendedCamera?this._combinedExtendedCamera:(0===this._fov&&(this._updateFOV(),this._updateSpan()),e=t?this._span:this._span/this._near*this._viewDistance,i=new F(this._scene,this._aspect,this._usesVerticalValues,this._viewDistance*Bt,D(!1,this._object3D._positionMatrix,this._object3D._orientationMatrix,this._fov,this._fov,this._fov,e,e,e)),i.update(0),t?this._combinedExtendedCamera=i:this._extendedCamera=i,i)},V.prototype.getShadowMapBufferName=function(t){return this._shadowMapBufferNamePrefix+t.toString()},V.prototype.addToContext=function(t,e,i,n,o){var s;if(this._shadowMapBufferNamePrefix=i,e)for(s=0;n>s;s++)t.getFrameBuffer(this.getShadowMapBufferName(s))||t.addFrameBuffer(new r.FrameBuffer(this.getShadowMapBufferName(s),o,o,!0))},V.prototype.reset=function(){this._baseMatrix=null,this._translationVector=null,this._translatedMatrix=null},V.prototype.getTranslatedMatrix=function(){return this._translatedMatrix},V.prototype.startShadowMap=function(t,e,o,s,a,h){var l={};t.setCurrentFrameBuffer(this.getShadowMapBufferName(o)),this._translatedMatrix=n.prodTranslationRotation4(n.translatedByVector(e.getInversePositionMatrix(),i.scaled3(n.getRowC43(e.getCameraOrientationMatrix()),h)),this._orientationMatrix),this._baseMatrix=this._baseMatrix||n.prodTranslationRotation4(e.getInversePositionMatrix(),this._orientationMatrix),this._translationVector=this._translationVector||i.normal3(i.diff3(n.translationVector3(this._translatedMatrix),n.translationVector3(this._baseMatrix))),l[r.getUniformName(ft)]=function(){return this._translatedMatrix}.bind(this),l[r.getUniformName(mt)]=function(){return a},l[r.getUniformName(yt)]=function(){return n.orthographic4(s,s,-a,a)},t.getCurrentShader().assignUniforms(t,l)},V.prototype.getUniformData=function(){return{color:this._color,direction:this._direction,matrix:this._baseMatrix||n.IDENTITY4,translationVector:this._translationVector||i.NULL3}},P.prototype._updateUniformColor=function(){this._uniformColor=this._color.concat(this._totalIntensity)},P.prototype.updateState=function(t){var e,n;if(this._states&&this._states.length>1&&t>0){for(this._timeSinceLastTransition+=t,e=(this._currentStateIndex+1)%this._states.length;this._timeSinceLastTransition>this._states[e].timeToReach;){if(0===e&&!this._looping){e=this._states.length-1,this._timeSinceLastTransition=this._states[e].timeToReach;break}this._timeSinceLastTransition-=this._states[e].timeToReach,e=(e+1)%this._states.length}this._currentStateIndex=0===e?this._states.length-1:e-1,n=this._timeSinceLastTransition/this._states[e].timeToReach,this.setObjectIntensity(this._states[this._currentStateIndex].intensity*(1-n)+this._states[e].intensity*n),this.setColor(i.sum3(i.scaled3(this._states[this._currentStateIndex].color,1-n),i.scaled3(this._states[e].color,n)))}},P.prototype.update=function(t){var e,o,r=this._totalIntensity;if(this.updateState(t),this._emittingObjects)if(1===this._emittingObjects.length)this._totalIntensity=this._objectIntensity,this._positionVector=i.sum3(this._emittingObjects[0].getPositionVector(),i.mulVec3Mat4(this._relativePositionVector,n.prod3x3SubOf4(this._emittingObjects[0].getCascadeScalingMatrix(),this._emittingObjects[0]._orientationMatrix)));else{for(this._positionVector=[0,0,0],o=0,e=0;e<this._emittingObjects.length;e++)this._emittingObjects[e]&&!this._emittingObjects[e].canBeReused()&&(i.add3(this._positionVector,this._emittingObjects[e].getPositionVector()),o++);this._positionVector[0]/=o,this._positionVector[1]/=o,this._positionVector[2]/=o,this._totalIntensity=this._objectIntensity*o}else this._totalIntensity=this._objectIntensity,this._positionVector=this._relativePositionVector;this._totalIntensity!==r&&this._updateUniformColor()},P.prototype.getUniformData=function(){return{color:this._uniformColor,position:this._positionVector}},P.prototype.canBeReused=function(){var t;if(!this._emittingObjects)return!1;for(t=0;t<this._emittingObjects.length;t++)if(this._emittingObjects[t]&&!this._emittingObjects[t].canBeReused())return!1;return!0},P.prototype.setColor=function(t){this._color=t,this._updateUniformColor()},P.prototype.setObjectIntensity=function(t){this._objectIntensity=t},P.prototype.addEmittingObject=function(t){this._emittingObjects.push(t)},P.prototype.shouldBeRendered=function(t){var e=t.getViewMatrix();return this._positionVector[0]*e[2]+this._positionVector[1]*e[6]+this._positionVector[2]*e[10]+e[14]<this._totalIntensity},U.prototype=new P,U.prototype.constructor=U,U.prototype.setSpotDirection=function(t){this._relativeSpotDirection=t},U.prototype.setSpotCutoffAngle=function(t){this._spotCutoffCosine=Math.cos(Math.radians(t))},U.prototype.update=function(t){P.prototype.update.call(this,t),this._emittingObjects&&1===this._emittingObjects.length?this._spotDirection=i.mulVec3Mat4(this._relativeSpotDirection,this._emittingObjects[0]._orientationMatrix):this._spotDirection=this._relativeSpotDirection},U.prototype.getUniformData=function(){return{color:this._uniformColor,spot:[this._spotDirection[0],this._spotDirection[1],this._spotDirection[2],this._spotCutoffCosine],position:this._positionVector.concat(this._spotFullIntensityCosine)}},B.prototype._setGeneralUniformValueFunctions=function(){this.setUniformValueFunction(St,function(){return this._directionalLightUniformData.length}),this.setUniformValueFunction(Mt,function(){return this._directionalLightUniformData}),this.setUniformValueFunction(xt,function(){return this._pointLightUniformData.length}),this.setUniformValueFunction(Et,function(){return this._pointLightUniformData}),this.setUniformValueFunction(bt,function(){return this._spotLightUniformData.length}),this.setUniformValueFunction(At,function(){return this._spotLightUniformData}),this.setUniformValueFunction(Ot,function(){return this._camera.getViewMatrix()}),this.setUniformValueFunction(vt,function(){return this._camera.getInverseOrientationMatrix()}),this.setUniformValueFunction(Ct,function(){return this._camera.getAspect()}),this.setUniformValueFunction(yt,function(){return this._camera.getProjectionMatrix()}),this.setUniformValueFunction(Rt,function(){return n.prod4(this._camera.getViewMatrix(),this._camera.getProjectionMatrix())}),this.setUniformValueFunction(Lt,function(){return new Float32Array(this._camera.getCameraPositionVector())})},B.prototype._setContextUniformValueFunctions=function(t){var e=this._contexts[t].gl;this.setContextUniformValueFunction(t,It,function(){return[e.drawingBufferWidth*this._width,e.drawingBufferHeight*this._height]})},B.prototype._setShadowMappedShaderUniformValueFunctions=function(t){var e;if(0===t&&(this.setUniformValueFunction(Nt,function(){return this._shadowMapRanges.length}),this.setUniformValueFunction(wt,function(){return new Float32Array(this._shadowMapRanges)}),this.setUniformValueFunction(Dt,function(){return this._shadowMapDepthRatio}),this.setUniformValueFunction(Ft,function(){return this._shadowMapTextureSize}),this.setUniformValueFunction(Pt,function(){return this._shadowMapSampleOffsets})),void 0!==t)this.setContextUniformValueFunction(t,Vt,function(){var e,i,n=[];for(e=0;e<this._directionalLights.length&&e<this._maxRenderedDirectionalLights;e++)for(i=0;i<this._shadowMapRanges.length;i++)n.push(this._contexts[t].getFrameBuffer(this._directionalLights[e].getShadowMapBufferName(i)).getLastTextureBindLocation(this._contexts[t].getName()));return new Int32Array(n)});else for(e=0;e<this._contexts.length;e++)this._setShadowMappedShaderUniformValueFunctions(e)},B.prototype._updateStaticLightUniformData=function(){var t;for(this._directionalLightUniformData=[],t=0;t<this._directionalLights.length&&t<this._maxRenderedDirectionalLights;t++)this._directionalLightUniformData.push(this._directionalLights[t].getUniformData())},B.prototype._clearDynamicLightUniformData=function(){
this._pointLightUniformData=[],this._spotLightUniformData=[]},B.prototype._updateDynamicLightUniformData=function(t){var e,i,n,o;for(this._pointLightUniformData=[],e=0,n=0;e<this._pointLightPriorityArrays.length;e++){for(i=0;i<this._pointLightPriorityArrays[e].length&&n<this._maxRenderedPointLights;i++)this._pointLightPriorityArrays[e][i].update(t),this._pointLightPriorityArrays[e][i].shouldBeRendered(this._camera)&&(this._pointLightUniformData.push(this._pointLightPriorityArrays[e][i].getUniformData()),n++);for(;i<this._pointLightPriorityArrays[e].length;)this._pointLightPriorityArrays[e][i].updateState(t),i++}for(this._spotLightUniformData=[],e=0,o=Math.min(this._spotLights.length,this._maxRenderedSpotLights);o>e;e++)this._spotLights[e].update(t),this._spotLightUniformData.push(this._spotLights[e].getUniformData());for(;e<this._spotLights.length;)this._spotLights[e].updateState(t),e++},B.prototype._getShadowMapBufferNamePrefix=function(t){return dt+t+gt},B.prototype._setupContext=function(t){var e;if(void 0!==t)for(this._setContextUniformValueFunctions(t),this._shadowMappingEnabled&&(this._contexts[t].addShader(this._shadowMappingShader),this._setShadowMappedShaderUniformValueFunctions(t)),e=0;e<this._directionalLights.length&&e<this._maxRenderedDirectionalLights;e++)this._directionalLights[e].addToContext(this._contexts[t],this._shadowMappingEnabled,this._getShadowMapBufferNamePrefix(e),this._shadowMapRanges.length,this._shadowMapTextureSize);else for(e=0;e<this._contexts.length;e++)this._setupContext(e)},B.prototype.setRelativeViewport=function(t,e,i,n){this._left=t,this._bottom=e,this._width=i,this._height=n},B.prototype.addToContext=function(t){this._contexts.push(t),this._setupContext(this._contexts.length-1),this._rootBackgroundNode.addToContext(t),this._rootNode.addToContext(t),this._rootUINode.addToContext(t),this._rootResourceNode.addToContext(t)},B.prototype.enableShadowMapping=function(){this._shadowMappingShader&&this._shadowMapRanges.length>0?(this._shadowMappingEnabled=!0,this._setupContext()):o.showError("Cannot enable shadow mapping, as no shadow mapping shader or no shadow mapping ranges were specified")},B.prototype.disableShadowMapping=function(){this._shadowMappingEnabled=!1},B.prototype.toggleShadowMapping=function(){this._shadowMappingEnabled=!this._shadowMappingEnabled,this._shadowMappingEnabled?this.enableShadowMapping():this.disableShadowMapping()},B.prototype.setShadowMapRanges=function(t){this._shadowMapRanges=new Float32Array(t),this._setupContext()},B.prototype.setShadowMapping=function(t){t?(this._shadowMappingEnabled=void 0!==t.enable?t.enable:this._shadowMappingEnabled,this._shadowMappingShader=t.shader||this._shadowMappingShader,this._shadowMapTextureSize=t.textureSize||this._shadowMapTextureSize,this._shadowMapRanges=t.ranges?new Float32Array(t.ranges):this._shadowMapRanges,this._shadowMapDepthRatio=t.depthRatio||this._shadowMapDepthRatio,this._numShadowMapSamples=t.numSamples?e.getNumberValueInRange("shadowMappingParams.numSamples",t.numSamples,this._shadowMappingEnabled?1:0,this._shadowMappingEnabled?Ut.length/2:0,this._shadowMappingEnabled?1:0):t.numSamples,this._shadowMapSampleOffsets=Ut.slice(0,2*this._numShadowMapSamples),t.deferSetup||this._setupContext()):(this._shadowMappingEnabled=!1,this._shadowMappingShader=null,this._shadowMapTextureSize=0,this._shadowMapRanges=[],this._shadowMapDepthRatio=0,this._numShadowMapSamples=0,this._shadowMapSampleOffsets=[])},B.prototype.getCamera=function(){return this._camera},B.prototype.shouldAnimate=function(){return this._shouldAnimate},B.prototype.setShouldAnimate=function(t){this._shouldAnimate=t},B.prototype.shouldUpdateCamera=function(){return this._shouldUpdateCamera},B.prototype.setShouldUpdateCamera=function(t){this._shouldUpdateCamera=t},B.prototype.addBackgroundObject=function(t){var e=new c(t);return this._rootBackgroundNode.addSubnode(e),e},B.prototype.addObject=function(t,e){var i=new c(t,!1,e);return this._rootNode.addSubnode(i),i},B.prototype.addNode=function(t){return this._rootNode.addSubnode(t),t},B.prototype.addUIObject=function(t){var e=new c(t);return this._rootUINode.addSubnode(e),e},B.prototype.addObjectToContexts=function(t){var e;for(e=0;e<this._contexts.length;e++)t.addToContext(this._contexts[e])},B.prototype.clearNodes=function(){this._rootBackgroundNode&&this._rootBackgroundNode.destroy(),this._rootBackgroundNode=new c(new p(null,!1,!1,void 0,void 0,void 0,void 0,0)),this._rootBackgroundNode.setScene(this),this._rootNode&&this._rootNode.destroy(),this._rootNode=new c(new p(null,!1,!1,void 0,void 0,void 0,void 0,0)),this._rootNode.setScene(this),this._rootResourceNode&&this._rootResourceNode.destroy(),this._rootResourceNode=new c(new p(null,!1,!1)),this._rootResourceNode.setScene(this),this._rootUINode&&this._rootUINode.destroy(),this._rootUINode=new c(new p(null,!1,!1,void 0,void 0,void 0,void 0,0)),this._rootUINode.setScene(this)},B.prototype.clearPointLights=function(){var t;for(this._pointLightPriorityArrays=new Array(Tt),t=0;Tt>t;t++)this._pointLightPriorityArrays[t]=[]},B.prototype.getAllObjects=function(){var t,e=[],i=this._rootNode._subnodes;for(t=0;t<i.length;t++)e.push(i[t]._renderableObject);return e},B.prototype.getAll3DObjects=function(){var t,e,i=[],n=this._rootNode._subnodes;for(t=0;t<n.length;t++)e=n[t]._renderableObject,e.getPositionMatrix&&e.getOrientationMatrix&&i.push(e);return i},B.prototype.moveAllObjectsByVector=function(t){var e,i,n=this._rootNode._subnodes;for(e=0;e<n.length;e++)i=n[e]._renderableObject,i.translatev&&i.translatev(t)},B.prototype.moveCameraToOrigoIfNeeded=function(t){var e=this._camera.moveToOrigoIfNeeded(t);return e&&this.moveAllObjectsByVector(e),e},B.prototype.getFirstNode=function(){return this._rootNode.getFirstSubnode()},B.prototype.getNextNode=function(t){return this._rootNode.getNextSubnode(t)},B.prototype.getPreviousNode=function(t){return this._rootNode.getPreviousSubnode(t)},B.prototype.addResourcesOfObject=function(t){this._rootResourceNode.addSubnode(new c(t))},B.prototype.addDirectionalLightSource=function(t){this._directionalLights.push(t)},B.prototype.addPointLightSource=function(t,e){e=Math.min(e||0,Tt-1),this._pointLightPriorityArrays[e].push(t)},B.prototype.addSpotLightSource=function(t){this._spotLights.push(t)},B.prototype.getLODContext=function(){return this._lodContext},B.prototype.getNumberOfDrawnTriangles=function(){return this._numDrawnTriangles},B.prototype.setUniformValueFunction=function(t,e){this._uniformValueFunctions[r.getUniformName(t)]=e.bind(this)},B.prototype.setContextUniformValueFunction=function(t,e,i){this._contextUniformValueFunctions[t]||(this._contextUniformValueFunctions[t]={}),this._contextUniformValueFunctions[t][r.getUniformName(e)]=i.bind(this)},B.prototype.addCameraConfiguration=function(t){this._rootNode.addCameraConfiguration(t)},B.prototype.hasCameraConfiguration=function(t){return this._rootNode.hasCameraConfiguration(t)},B.prototype.getNextCameraConfiguration=function(t){return this._rootNode.getNextCameraConfiguration(t)},B.prototype.getPreviousCameraConfiguration=function(t){return this._rootNode.getPreviousCameraConfiguration(t)},B.prototype.getCameraConfigurationsWithName=function(t){return this._rootNode.getCameraConfigurationsWithName(t)},B.prototype.hideUI=function(){this._rootUINode.hide()},B.prototype.showUI=function(){this._rootUINode.show()},B.prototype.assignUniforms=function(t,e){this._uniformsUpdated[e.getName()]||(e.assignUniforms(t,this._uniformValueFunctions),e.assignUniforms(t,this._contextUniformValueFunctions[this._contexts.indexOf(t)]),this._uniformsUpdated[e.getName()]=!0,this._uniformsUpdatedForFrame=!0)},B.prototype.cleanUp=function(){var t,e,i,n;for(this._rootNode.cleanUp(),n=0;n<this._pointLightPriorityArrays.length;n++)for(t=0;t<this._pointLightPriorityArrays[n].length;t++){for(e=t,i=0;e<this._pointLightPriorityArrays[n].length&&(!this._pointLightPriorityArrays[n][e]||this._pointLightPriorityArrays[n][e].canBeReused()===!0);)e++,i++;this._pointLightPriorityArrays[n].splice(t,i)}for(t=0;t<this._spotLights.length;t++){for(e=t,i=0;e<this._spotLights.length&&(!this._spotLights[e]||this._spotLights[e].canBeReused()===!0);)e++,i++;this._spotLights.splice(t,i)}},B.prototype._renderShadowMap=function(t,e,i,n,s,a){var h,l,u=t.gl;if(o.log("Starting new shadow map...",4),this._shadowQueue.length>0){for(r.areDepthTexturesAvailable()?u.clear(u.DEPTH_BUFFER_BIT):u.clear(u.COLOR_BUFFER_BIT|u.DEPTH_BUFFER_BIT),l=[],h=0;h<this._shadowQueue.length;h++)this._shadowQueue[h].renderToShadowMap(t,e,i,n,s,a)&&l.push(this._shadowQueue[h]);this._shadowQueue=l}},B.prototype._renderShadowMaps=function(t,e,i){var n,r,s=t.gl;if(this._shadowMappingEnabled){for(o.log("Rendering shadow maps for scene...",4),s.viewport(0,0,this._shadowMapTextureSize,this._shadowMapTextureSize),s.clearColor(0,0,0,0),t.setColorMask(Wt),t.disableBlending(),t.setDepthMask(!0),t.setCurrentShader(this._shadowMappingShader),this.assignUniforms(t,this._shadowMappingShader),n=0;n<this._directionalLights.length&&n<this._maxRenderedDirectionalLights;n++)for(this._directionalLights[n].reset(),this._shadowQueue=[],this._shadowQueue=this._shadowQueue.concat(this._rootNode._subnodes),o.log("Rendering shadow maps for light "+n+"...",4),r=this._shadowMapRanges.length-1;r>=0;r--)this._directionalLights[n].startShadowMap(t,this._camera,r,this._shadowMapRanges[r],this._shadowMapRanges[r]*this._shadowMapDepthRatio,this._shadowMapRanges[r]),this._renderShadowMap(t,e,i,this._directionalLights[n].getTranslatedMatrix(),this._shadowMapRanges[r],this._shadowMapDepthRatio);for(n=0;n<this._directionalLights.length&&n<this._maxRenderedDirectionalLights;n++)for(r=0;r<this._shadowMapRanges.length;r++)t.bindTexture(t.getFrameBuffer(this._directionalLights[n].getShadowMapBufferName(r)),void 0,!0)}t.setCurrentFrameBuffer(null)},B.prototype._renderBackgroundObjects=function(t,e,i){o.log("Rendering background objects of scene...",4),t.enableBlending(),t.setDepthMask(!1),this._rootBackgroundNode.resetForNewFrame(),this._rootBackgroundNode.render(t,e,i,!1),o.isDebugVersion()&&(this._numDrawnTriangles+=this._rootBackgroundNode.getNumberOfDrawnTriangles())},B.prototype._renderQueue=function(t,e,i,n,o,r){var s,a,h,l=n.length;if(l>0)if(a=n[0].getMinimumCountForInstancing(),a>0&&l>=a&&t.instancingExt){for(h=0,n[0].prepareForInstancedRender(t,o,l),s=0;l>s;s++)n[s].render(t,e,i,r,!0,!0,o)&&h++;h>0&&n[0].renderInstances(t,o,h)}else for(s=0;l>s;s++)n[s].render(t,e,i,r,!0)},B.prototype._renderMainObjects=function(t,e,i,n,r,s){var a;if(o.log("Rendering opaque phase...",4),n.length>0){for(t.setDepthMask(!0),t.disableBlending(),a=0;a<n.length;a++)this._renderQueue(t,e,i,n[a],a,!0);o.isDebugVersion()&&(this._numDrawnTriangles+=this._rootNode.getNumberOfDrawnTriangles(!1))}if(s&&this._renderBackgroundObjects(t,e,i),o.log("Rendering transparent phase...",4),r.length>0){for(t.setDepthMask(!1),t.enableBlending(),a=0;a<r.length;a++)this._renderQueue(t,e,i,r[a],a,!1);o.isDebugVersion()&&(this._numDrawnTriangles+=this._rootNode.getNumberOfDrawnTriangles(!0))}},B.prototype._renderUIObjects=function(t,e,i){var n=t.gl;this._rootUINode._subnodes.length>0&&(t.enableBlending(),n.disable(n.DEPTH_TEST),t.setDepthMask(!1),this._rootUINode.resetForNewFrame(),this._rootUINode.render(t,e,i,!1),o.isDebugVersion()&&(this._numDrawnTriangles+=this._rootUINode.getNumberOfDrawnTriangles()),n.enable(n.DEPTH_TEST))},B.prototype.render=function(t,e){var i,n,r,s,a=t.gl,h=a.drawingBufferWidth,l=a.drawingBufferHeight,u=h*this._width,c=l*this._height;o.log("Rendering scene...",3),this._camera.setAspect(u/c),this._camera.update(this._shouldUpdateCamera?e:0),this._numDrawnTriangles=0,this._uniformsUpdated={},this._rootNode.resetForNewFrame(),this._renderQueues=[[],[],[],[]],this._rootNode.animateAndAddToRenderQueues(this._renderQueues,this._camera,e),r=this._renderQueues[Ht].length>0||this._renderQueues[jt].length>0,s=this._renderQueues[kt].length>0||this._renderQueues[zt].length>0,r&&this._renderShadowMaps(t,u,c),this._updateStaticLightUniformData(),a.viewport(this._left*h,this._bottom*l,u,c),this._shouldClearColorOnRender&&(t.setColorMask(this._clearColorMask),a.clearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3])),t.setDepthMask(!0),i=this._shouldClearColorOnRender?a.COLOR_BUFFER_BIT:0,i=this._shouldClearDepthOnRender?i|a.DEPTH_BUFFER_BIT:i,a.clear(i),this._uniformsUpdatedForFrame===!1&&t.getCurrentShader()&&this.assignUniforms(t,t.getCurrentShader()),this._uniformsUpdatedForFrame=!1,s&&(n=this._camera,this._camera=this._camera.getExtendedCamera(),this._clearDynamicLightUniformData(),this._renderMainObjects(t,u,c,this._renderQueues[kt],this._renderQueues[zt],!0),this._camera=n,t.setDepthMask(!0),a.clear(a.DEPTH_BUFFER_BIT),this._uniformsUpdated={}),r&&(this._updateDynamicLightUniformData(this._shouldAnimate?e:0),t.getCurrentShader()&&this.assignUniforms(t,t.getCurrentShader()),this._renderMainObjects(t,u,c,this._renderQueues[Ht],this._renderQueues[jt],!s)),n=this._camera,this._camera=this._camera.getExtendedCamera(!0),this._renderUIObjects(t,u,c),this._camera=n},{UNIFORM_COLOR_NAME:nt,CLIP_COORDINATES_NO_CLIP:Xt,getDebugInfo:a,LODContext:h,Scene:B,DirectionalLightSource:V,PointLightSource:P,SpotLightSource:U,RenderableObject:_,RenderableObject3D:p,RenderableNode:c,CubemapSampledFVQ:d,ShadedLODMesh:g,ParameterizedMesh:f,Billboard:m,ParticleState:y,Particle:T,staticParticle:x,initDynamicParticle:S,dynamicParticle:M,BackgroundBillboard:E,ParticleEmitter:b,OmnidirectionalParticleEmitter:A,UnidirectionalParticleEmitter:O,PlanarParticleEmitter:R,ParticleSystem:v,PointParticle:C,UIElement:I,CameraPositionConfiguration:L,CameraOrientationConfiguration:N,CameraConfiguration:w,Camera:F,getFreeCameraConfiguration:D}}),function(){"use strict";Math.sign=Math.sign||function(t){return t=+t,0===t||isNaN(t)?t:t>0?1:-1},Math.log10=Math.log10||function(t){return Math.log(t)/Math.LN10},Math.log2=Math.log2||function(t){return Math.log(t)/Math.LN2},Math.seed=function(t){return function(){return t=1e4*Math.sin(t),t-Math.floor(t)}},Math.radians=function(t){return t*Math.PI/180},Math.degrees=function(t){return 180*t/Math.PI},Number.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},Array.prototype.findIndex=Array.prototype.findIndex||function(t,e){var i;for(i=0;i<this.length;i++)if(t.call(e||t,this[i],i,this))return i;return-1},Array.prototype.find=Array.prototype.find||function(t,e){var i;for(i=0;i<this.length;i++)if(t.call(e||t,this[i],i,this))return this[i]}}(),define("utils/polyfill",function(){}),define("armada/graphics",["utils/types","modules/application","modules/async-resource","modules/managed-gl","modules/graphics-resources","modules/buda-scene","armada/constants","utils/polyfill"],function(t,e,i,n,o,r,s){"use strict";function a(t,e){var i,n,o=0;for(i in M)M.hasOwnProperty(i)&&(n=M[i],e.hasOwnProperty(n.name)&&(o+=t[n.name]*e[n.name]));return o}function h(t,e){return{requiredVertexUniformVectors:t[x]+a(t[E],e),requiredAttributeVectors:t[b]+a(t[A],e),requiredVaryingVectors:t[O]+a(t[R],e),requiredTextureUnits:t[v]+a(t[C],e),requiredFragmentUniformVectors:t[I]+a(t[L],e)}}function l(t,e){return{requiredVertexUniformVectors:t.requiredVertexUniformVectors+e.requiredVertexUniformVectors,requiredAttributeVectors:t.requiredAttributeVectors+e.requiredAttributeVectors,requiredVaryingVectors:t.requiredVaryingVectors+e.requiredVaryingVectors,requiredTextureUnits:t.requiredTextureUnits+e.requiredTextureUnits,requiredFragmentUniformVectors:t.requiredFragmentUniformVectors+e.requiredFragmentUniformVectors}}function u(e,i,n,o){this._list=e?t.getArrayValue(n||"OrderedNamedNumericOptions.list",e,i,null,{minLength:1},[]):[],this._optionNamePropertyName=i?i.properties.NAME.name:null,this._optionValuePropertyName=i?i.properties.VALUE.name:null,this._list.sort(function(t,e){return t[this._optionValuePropertyName]-e[this._optionValuePropertyName]}.bind(this)),this._currentIndex=this._list.length-1,o&&this.applyLimit(o)}function c(t,e,i){u.call(this,t,y,e,i),this._preferenceList=null,this._updatePreferenceList()}function _(){i.AsyncResource.call(this),this._dataJSON=null,this._antialiasing=!1,this._filtering=null,this._lodLevel=null,this._maxLoadedLOD=0,this._lodContext=null,this._textureQuality=null,this._cubemapQuality=null,this._shadowMappingEnabled=!1,this._shadowMapQuality=null,this._shadowRanges=null,this._shadowDistances=null,this._shadowDepthRatio=0,this._pointLightAmount=null,this._particleAmount=null,this._dustParticleAmount=null,this._shaderConfig=null,this._shaderComplexity=null,this._luminosityTextureAreAvailable=!1}function p(){return f.isShadowMappingEnabled()&&f.isShadowMappingAvailable()}function d(){return f.getShader(f.getShadowMappingShaderName())}function g(){return p()?{enable:!0,shader:f.getManagedShader(f.getShadowMappingShaderName()),textureSize:f.getShadowMapTextureSize(),ranges:f.getShadowRanges(),depthRatio:f.getShadowDepthRatio(),numSamples:f.getNumShadowMapSamples()}:null}var f,m=s.LOCAL_STORAGE_PREFIX+"graphics_",y=t.getNameAndValueDefinitionObject("maximumResolution"),T=t.getNameAndValueDefinitionObject("lod"),S={baseType:"object",properties:{LUMINOSITY_FACTOR:{name:"luminosityFactor",type:"number",defaultValue:0},GROUP_TRANSFORM:{name:"groupTransform",type:"number",defaultValue:0},DIR_LIGHT:{name:"dirLight",type:"number",defaultValue:0},POINT_LIGHT:{name:"pointLight",type:"number",defaultValue:0},SPOT_LIGHT:{name:"spotLight",type:"number",defaultValue:0},SHADOW_MAP:{name:"shadowMap",type:"number",defaultValue:0},SHADOW_MAP_RANGE:{name:"shadowMapRange",type:"number",defaultValue:0},SHADOW_MAP_SAMPLE:{name:"shadowMapSample",type:"number",defaultValue:0}}},M=S.properties,x="requiredVertexUniformVectors",E="requiredVertexUniformVectorsPer",b="requiredAttributeVectors",A="requiredAttributeVectorsPer",O="requiredVaryingVectors",R="requiredVaryingVectorsPer",v="requiredTextureUnits",C="requiredTextureUnitsPer",I="requiredFragmentUniformVectors",L="requiredFragmentUniformVectorsPer",N={baseType:"object",properties:{VERTEX_UNIFORM_VECTORS:{name:x,type:"number",defaultValue:0},VERTEX_UNIFORM_VECTORS_PER:{name:E,type:S,defaultValue:{}},ATTRIBUTE_VECTORS:{name:b,type:"number",defaultValue:0},ATTRIBUTE_VECTORS_PER:{name:A,type:S,defaultValue:{}},VARYING_VECTORS:{name:O,type:"number",defaultValue:0},VARYING_VECTORS_PER:{name:R,type:S,defaultValue:{}},TEXTURE_UNITS:{name:v,type:"number",defaultValue:0},TEXTURE_UNITS_PER:{name:C,type:S,defaultValue:{}},FRAGMENT_UNIFORM_VECTORS:{name:I,type:"number",defaultValue:0},FRAGMENT_UNIFORM_VECTORS_PER:{name:L,type:S,defaultValue:{}}}},w={baseType:"object",properties:{NAME:{name:"name",type:"string"},SHADOW_MAPPING_AVAILABLE:{name:"shadows",type:"boolean"},NUM_SHADOW_MAP_SAMPLES:{name:"numShadowMapSamples",type:"number",defaultValue:0},DYNAMIC_LIGHTS_AVAILABLE:{name:"dynamicLights",type:"boolean"},MAX_DIR_LIGHTS:{name:"maxDirLights",type:"number"},MAX_SPOT_LIGHTS:{name:"maxSpotLights",type:"number",defaultValue:0},LUMINOSITY_TEXTURES_AVAILABLE:{name:"luminosityTextures",type:"boolean"},REVEAL_AVAILABLE:{name:"reveal",type:"boolean"},REQUIREMENTS:{name:"requirements",type:N}}},D=w.properties,F="complexities",V={FEATURE_REQUIREMENTS:{name:"featureRequirements",type:"object",properties:{SHADOWS:{name:"shadows",type:N},DYNAMIC_LIGHTS:{name:"dynamicLights",type:N},REVEAL:{name:"reveal",type:N}}},COMPLEXITIES:{name:F,type:"array",elementType:w,minLength:1},SHADOW_MAPPING_SHADER_NAME:{name:"shadowMappingShaderName",type:"string"},MAX_DIR_LIGHTS_DEFINE_NAME:{name:"maxDirLightsDefineName",type:"string"},MAX_POINT_LIGHTS_DEFINE_NAME:{name:"maxPointLightsDefineName",type:"string"},MAX_SPOT_LIGHTS_DEFINE_NAME:{name:"maxSpotLightsDefineName",type:"string"},DUST_LENGTH_DIVISOR:{name:"dustLengthDivisor",type:"string"},DUST_LENGTH_DIVISOR_DEFINE_NAME:{name:"dustLengthDivisorDefineName",type:"string"},MAX_LUMINOSITY_FACTORS:{name:"maxLuminosityFactors",type:"number"},MAX_LUMINOSITY_FACTORS_DEFINE_NAME:{name:"maxLuminosityFactorsDefineName",type:"string"},MAX_GROUP_TRANSFORMS:{name:"maxGroupTransforms",type:"number"},MAX_GROUP_TRANSFORMS_DEFINE_NAME:{name:"maxGroupTransformsDefineName",type:"string"},MAX_SHADOW_MAP_RANGES_DEFINE_NAME:{name:"maxShadowMapRangesDefineName",type:"string"},MAX_SHADOW_MAPS_DEFINE_NAME:{name:"maxShadowMapsDefineName",type:"string"},NUM_SHADOW_MAP_SAMPLES_DEFINE_NAME:{name:"numShadowMapSamplesDefineName",type:"string"},DEPTH_TEXTURES_DEFINE_NAME:{name:"depthTexturesDefineName",type:"string"},MAX_SHININESS:{name:"maxShininess",type:"string"},MAX_SHININESS_DEFINE_NAME:{name:"maxShininessDefineName",type:"string"}},P=V.FEATURE_REQUIREMENTS.properties,U=t.getNameAndValueDefinitionObject("numRanges"),B=t.getNameAndValueDefinitionObject("maxLights"),G=t.getNameAndValueDefinitionObject("particleCountFactor"),H=m+"antialiasing",j=m+"filtering",k=n.TextureFiltering.TRILINEAR,z=m+"textureQuality",W=m+"cubemapQuality",q=m+"maxLOD",X=m+"shaderComplexity",Y=m+"shadowMapping",Q=m+"shadowQuality",J=m+"shadowDistance",K=m+"pointLightAmount",Z=m+"particleAmount",$=m+"dustParticleAmount",tt="withoutShadows",et="withoutDynamicLights";return u.prototype._getNameFunction=function(t){return t[this._optionNamePropertyName]},u.prototype._checkNameFunction=function(t,e){return e[this._optionNamePropertyName]===t},u.prototype._isWithinLimitFunction=function(t,e){return e[this._optionValuePropertyName]<=t},u.prototype._valueFilterFunction=function(t,e){return t(e[this._optionValuePropertyName])},u.prototype._getInvalidOptionAccessErrorMessage=function(t){return"Invalid option ("+this._optionValuePropertyName+") '"+t+"' specified! Valid values are: "+this.getNameList().join(", ")+"."},u.prototype.getNameList=function(){return this._list.map(this._getNameFunction.bind(this))},u.prototype.getFilteredNameList=function(t){return this._list.filter(this._valueFilterFunction.bind(this,t)).map(this._getNameFunction.bind(this))},u.prototype.setCurrent=function(t,i){return this._currentIndex=this._list.findIndex(this._checkNameFunction.bind(this,t)),this._currentIndex<0&&i&&(this._currentIndex=this._list.length-1),this._currentIndex<0?(e.showError(this._getInvalidOptionAccessErrorMessage(t)),!1):!0},u.prototype.getCurrentName=function(){return this._currentIndex>=0?this._list[this._currentIndex][this._optionNamePropertyName]:null},u.prototype.getCurrentValue=function(){return this._currentIndex>=0?this._list[this._currentIndex][this._optionValuePropertyName]:0},u.prototype.getValueForName=function(t){var i=this._list.findIndex(this._checkNameFunction.bind(this,t));return i>=0?this._list[i][this._optionValuePropertyName]:(e.showError(this._getInvalidOptionAccessErrorMessage(t)),0)},u.prototype.applyLimit=function(t){var i=this.getCurrentName();this._list=this._list.filter(this._isWithinLimitFunction.bind(this,t)),this._currentIndex>=this._list.length&&(this._currentIndex=this._list.length-1,e.log("Setting ("+this._optionValuePropertyName+") changed to '"+this.getCurrentName()+"' from '"+i+"' as a result of limiting the setting to "+t+".",1))},u.prototype.decrease=function(){return this._currentIndex>0?(this._currentIndex--,!0):!1},u.prototype.setLowest=function(){this._currentIndex=0},u.prototype.getFirstValue=function(){return this._list[0][this._optionValuePropertyName]},c.prototype=new u,c.prototype.constructor=c,c.prototype._updatePreferenceList=function(){var t;for(this._preferenceList=[],t=this._currentIndex;t>=0;t--)this._preferenceList.push(this._list[t]);for(t=this._currentIndex+1;t<this._list.length;t++)this._preferenceList.push(this._list[t])},c.prototype.setCurrent=function(t,e){var i;return i=u.prototype.setCurrent.call(this,t,e),this._updatePreferenceList(),i},c.prototype.getPreferenceNameList=function(){return this._preferenceList.map(this._getNameFunction.bind(this))},c.prototype.applyLimit=function(t){u.prototype.applyLimit.call(this,t),this._updatePreferenceList()},_.prototype=new i.AsyncResource,_.prototype.constructor=_,_.prototype._getShaderRequirements=function(t){t=t||{};var e,i=this._getShaderComplexityDescriptor(t.complexityLevelIndex),n=this.getShaderConfig(V.FEATURE_REQUIREMENTS),o=i[D.MAX_DIR_LIGHTS.name],r=void 0===t.numPointLights?this.getMaxPointLights():t.numPointLights,s=r>0?i[D.MAX_SPOT_LIGHTS.name]:0,a=void 0===t.numShadowRanges?this.getNumShadowMapRanges():t.numShadowRanges,u=o*a,c=i[D.NUM_SHADOW_MAP_SAMPLES.name],_={};return _[M.DIR_LIGHT.name]=o,_[M.POINT_LIGHT.name]=r,_[M.SPOT_LIGHT.name]=s,_[M.SHADOW_MAP.name]=u,_[M.SHADOW_MAP_RANGE.name]=a,_[M.SHADOW_MAP_SAMPLE.name]=c,_[M.LUMINOSITY_FACTOR.name]=this.getShaderConfig(V.MAX_LUMINOSITY_FACTORS),_[M.GROUP_TRANSFORM.name]=this.getShaderConfig(V.MAX_GROUP_TRANSFORMS),e=h(i[D.REQUIREMENTS.name],_),i[D.SHADOW_MAPPING_AVAILABLE.name]&&a>0&&(e=l(e,h(n[P.SHADOWS.name],_))),i[D.DYNAMIC_LIGHTS_AVAILABLE.name]&&r>0&&(e=l(e,h(n[P.DYNAMIC_LIGHTS.name],_))),i[D.REVEAL_AVAILABLE.name]&&(e=l(e,h(n[P.REVEAL.name],_))),e},_.prototype._shaderRequirementsAreSatisfied=function(t){return n.requirementsAreSatisfied(this._getShaderRequirements(t))},_.prototype._limitShaderComplexities=function(){var t,i=[],n=this.getShaderConfig(V.COMPLEXITIES);for(t=0;t<n.length;t++)this._shaderRequirementsAreSatisfied({numPointLights:0,numShadowRanges:0,complexityLevelIndex:t})?i.push(n[t]):e.log("Defined shader complexity level '"+n[t][D.NAME.name]+"', which has too high requirements and thus will be dropped from the available shader complexities.",1);this.setShaderConfig(V.COMPLEXITIES,i)},_.prototype._setFallbackShaderComplexity=function(t){var e;for(t&&!this._shaderRequirementsAreSatisfied()&&this._disableShaderFeatures(),e=this.getShaderComplexities().indexOf(this.getShaderComplexity());e>0&&!this._shaderRequirementsAreSatisfied({complexityLevelIndex:e});)e--;this.setShaderComplexity(this.getShaderComplexities()[e],!1)},_.prototype.loadConfigurationFromJSON=function(e){var i,o,s,a;for(this._shaderConfig=t.getVerifiedObject("config.graphics.shaders",e.shaders,V),this._limitShaderComplexities(),this._textureQuality=new c(e.context.textureQualities,"config.graphics.context.textureQualities",n.getMaxTextureSize()),this._cubemapQuality=new c(e.context.cubemapQualities,"config.graphics.context.cubemapQualities",n.getMaxCubemapSize()),this._shadowMapQuality=new c(e.context.shadows.qualities,"config.graphics.context.shadows.qualities",n.getMaxRenderbufferSize()),this._shadowRanges=t.getArrayValue("config.graphics.context.shadows.ranges",e.context.shadows.ranges,"number",null,{minLength:1}),this._shadowDistances=new u(e.context.shadows.distances,U,"config.graphics.context.shadows.distances",this._shadowRanges.length),this._shadowDepthRatio=t.getNumberValue("config.graphics.context.shadows.depthRatio",e.context.shadows.depthRatio),this._pointLightAmount=new u(e.context.pointLightAmounts,B,"config.graphics.context.pointLightAmounts"),this._particleAmount=new u(e.context.particleAmounts,G,"config.graphics.context.particleAmounts"),this._dustParticleAmount=new u(e.context.dustParticleAmounts,G,"config.graphics.context.dustParticleAmounts"),this._lodLevel=new u(e.levelOfDetailSettings.lodLevels,T,"config.graphics.levelOfDetailSettings.lodLevels"),a=new Array(e.levelOfDetailSettings.lodDisplayProfile.limits.length+1),a[0]=0,i=0,o=e.levelOfDetailSettings.lodDisplayProfile.limits.length;o>i;i++)s=e.levelOfDetailSettings.lodDisplayProfile.limits[i],a[this._lodLevel.getValueForName(s.level)+1]=s.objectSizeLessThan;this._lodContext=new r.LODContext(this._lodLevel.getFirstValue(),a,e.levelOfDetailSettings.lodDisplayProfile.compensateForObjectSize,e.levelOfDetailSettings.lodDisplayProfile.referenceSize,e.levelOfDetailSettings.lodDisplayProfile.minimumRelativeSize)},_.prototype.loadSettingsFromJSON=function(i,o){var r,s,a,h;if(o=o||!1,o||(this._dataJSON=i),"object"==typeof i.shaders?this.setShaderComplexity(i.shaders.complexity,!1,!0):e.showError("Missing required settings.graphics.shaders from the setting definition object!"),"object"==typeof i.context?(this.setAntialiasing(t.getBooleanValue(i.context.antialiasing,{name:"settings.graphics.context.antialiasing"}),!1),this.setFiltering(t.getEnumValue(n.TextureFiltering,i.context.filtering,{name:"settings.graphics.context.filtering"}),!1),this.setTextureQuality(i.context.textureQuality,!1,!0),this.setCubemapQuality(i.context.cubemapQuality,!1,!0),this.setShadowMapping(t.getBooleanValue(i.context.shadowMapping,{name:"settings.graphics.context.shadowMapping"}),!1,!0),"object"==typeof i.context.shadows&&(this.setShadowMapQuality(i.context.shadows.quality,!1,!0),this.setShadowDistance(i.context.shadows.distance,!1,!0)),this.setPointLightAmount(i.context.pointLightAmount,!1,!0)):e.showError("Missing required settings.graphics.context from the setting definition object!"),this.setLODLevel(i.levelOfDetail.maxLevel,!1),i.levelOfDetail.autoLimitByScreenSize===!0)for(r=Math.max(screen.width,screen.height),s=0,a=i.levelOfDetail.limits.length;a>s;s++)h=i.levelOfDetail.limits[s],r<h.screenSizeLessThan&&this.getMaxLoadedLOD()>this._lodLevel.getValueForName(h.level)&&this.setLODLevel(h.level,!1);if(this.setParticleAmount(i.particleAmount.amount,!1),i.particleAmount.autoLimitByScreenSize===!0)for(r=Math.max(screen.width,screen.height),s=0,a=i.particleAmount.limits.length;a>s;s++)h=i.particleAmount.limits[s],r<h.screenSizeLessThan&&this.getParticleCountFactor()>this._particleAmount.getValueForName(h.amount)&&this.setParticleAmount(h.amount,!1);if(i.particleAmount.autoDecreaseIfInstancingNotAvailable===!0&&(n.isInstancingAvailable()||this._particleAmount.decrease()),this.setDustParticleAmount(i.dustParticleAmount.amount,!1),i.dustParticleAmount.autoLimitByScreenSize===!0)for(r=Math.max(screen.width,screen.height),s=0,a=i.dustParticleAmount.limits.length;a>s;s++)h=i.dustParticleAmount.limits[s],r<h.screenSizeLessThan&&this.getDustParticleCountFactor()>this._dustParticleAmount.getValueForName(h.amount)&&this.setDustParticleAmount(h.amount,!1);i.dustParticleAmount.autoDecreaseIfInstancingNotAvailable===!0&&(n.isInstancingAvailable()||this._dustParticleAmount.decrease()),this._setFallbackShaderComplexity(!0)},_.prototype.loadFromLocalStorage=function(){var i,o,r=function(n,r,s,a){void 0!==localStorage[n]&&(o={silentFallback:e.hasVersionChanged(),defaultValue:s},i=t.getValueOfTypeFromLocalStorage(r,n,o),(!o.error||e.hasVersionChanged())&&a(i,!!o.error&&o.error!==t.Errors.INVALID_ENUM_OBJECT_ERROR))};r(H,"boolean",this.getAntialiasing(),this.setAntialiasing.bind(this)),r(j,{baseType:"enum",values:n.TextureFiltering},this.getFiltering(),this.setFiltering.bind(this)),r(z,{baseType:"enum",values:t.getEnumObjectForArray(this.getTextureQualities())},this.getTextureQuality(),this.setTextureQuality.bind(this)),r(W,{baseType:"enum",values:t.getEnumObjectForArray(this.getCubemapQualities())},this.getCubemapQuality(),this.setCubemapQuality.bind(this)),r(q,{baseType:"enum",values:t.getEnumObjectForArray(this.getLODLevels())},this.getLODLevel(),this.setLODLevel.bind(this)),r(X,{baseType:"enum",values:t.getEnumObjectForArray(this.getShaderComplexities())},this.getShaderComplexity(),this.setShaderComplexity.bind(this)),r(Y,"boolean",this.isShadowMappingEnabled(),this.setShadowMapping.bind(this)),r(Q,{baseType:"enum",values:t.getEnumObjectForArray(this.getShadowMapQualities())},this.getShadowMapQuality(),this.setShadowMapQuality.bind(this)),this.canEnableShadowMapping()&&r(J,{baseType:"enum",values:t.getEnumObjectForArray(this.getShadowDistances())},this.getShadowDistance(),this.setShadowDistance.bind(this)),r(K,{baseType:"enum",values:t.getEnumObjectForArray(this.getPointLightAmounts())},this.getPointLightAmount(),this.setPointLightAmount.bind(this)),r(Z,{baseType:"enum",values:t.getEnumObjectForArray(this.getParticleAmounts())},this.getParticleAmount(),this.setParticleAmount.bind(this)),r($,{baseType:"enum",values:t.getEnumObjectForArray(this.getDustParticleAmounts())
},this.getDustParticleAmount(),this.setDustParticleAmount.bind(this)),this.setToReady()},_.prototype.restoreDefaults=function(){this.loadSettingsFromJSON(this._dataJSON,!0),localStorage.removeItem(H),localStorage.removeItem(j),localStorage.removeItem(z),localStorage.removeItem(W),localStorage.removeItem(q),localStorage.removeItem(X),localStorage.removeItem(Y),localStorage.removeItem(Q),localStorage.removeItem(J),localStorage.removeItem(K)},_.prototype.getAntialiasing=function(){return this._antialiasing},_.prototype.setAntialiasing=function(t,i){return void 0===i&&(i=!0),n.isAntialiasingAvailable()?this._antialiasing=t:(this._antialiasing=!1,t&&e.log("Attempted to enable antialiasing, but it is not supported and so will be disabled.",1)),i&&(localStorage[H]=t.toString()),this._antialiasing===t},_.prototype.getFiltering=function(){return this._filtering},_.prototype.setFiltering=function(i,o){void 0===o&&(o=!0),i=t.getEnumValue(n.TextureFiltering,i,{name:"texture filtering",defaultValue:this._filtering}),this._filtering=i,n.isAnisotropicFilteringAvailable()||i!==n.TextureFiltering.ANISOTROPIC||(this._filtering=k,e.log("Attempted to set texture filtering to anisotropic, but it is not supported and so a fallback filtering will be applied instead.",1)),o&&(localStorage[j]=i.toString())},_.prototype.getTextureQualities=function(){return this._textureQuality.getNameList()},_.prototype.getTextureQualityPreferenceList=function(){return this._textureQuality.getPreferenceNameList()},_.prototype.getTextureQuality=function(){return this._textureQuality.getCurrentName()},_.prototype.setTextureQuality=function(t,e,i){void 0===e&&(e=!0),this._textureQuality.setCurrent(t,i)&&e&&(localStorage[z]=t)},_.prototype.getCubemapQualities=function(){return this._cubemapQuality.getNameList()},_.prototype.getCubemapQualityPreferenceList=function(){return this._cubemapQuality.getPreferenceNameList()},_.prototype.getCubemapQuality=function(){return this._cubemapQuality.getCurrentName()},_.prototype.setCubemapQuality=function(t,e,i){void 0===e&&(e=!0),this._cubemapQuality.setCurrent(t,i)&&e&&(localStorage[W]=t)},_.prototype.getMaxLoadedLOD=function(){return this._maxLoadedLOD},_.prototype.getLODLevels=function(){return this._lodLevel.getNameList()},_.prototype.getLODLevel=function(){return this._lodLevel.getCurrentName()},_.prototype.setLODLevel=function(t,e){void 0===e&&(e=!0),this._lodLevel.setCurrent(t)&&(this._maxLoadedLOD=this._lodLevel.getCurrentValue(),this._lodContext.maxEnabledLOD=this._lodLevel.getCurrentValue(),e&&(localStorage[q]=t))},_.prototype.getLODContext=function(){return this._lodContext},_.prototype.getShaderComplexity=function(){return this._shaderComplexity},_.prototype._limitShaderFeatures=function(){var t=this.isShadowMappingEnabled(),i=this.getNumShadowMapRanges(),n=this.getMaxPointLights();for(e.log("Checking requirements for current shader complexity...");!this._shaderRequirementsAreSatisfied();)if(this.isShadowMappingEnabled())this._shadowDistances.decrease()||this.setShadowMapping(!1,!1,!0);else if(!this._pointLightAmount.decrease())return void e.showError("Cannot satisfy shader requirements for current complexity!");this.isShadowMappingEnabled()!==t?e.log("Disabled shadow mapping to satisfy requirements of current shader complexity.",1):this.getNumShadowMapRanges()!==i&&e.log("Changed number of shadow map ranges from "+i+" to "+this.getNumShadowMapRanges()+" to satisfy requirements of current shader complexity.",1),this.getMaxPointLights()!==n&&e.log("Changed number of maximum point lights from "+n+" to "+this.getMaxPointLights()+" to satisfy requirements of current shader complexity.",1)},_.prototype._disableShaderFeatures=function(){this.isShadowMappingEnabled()&&this.setShadowMapping(!1,!1,!0),this._pointLightAmount.setLowest()},_.prototype.setShaderComplexity=function(t,i,n){var o=this.getShaderComplexities();void 0===i&&(i=!0),o.indexOf(t)>=0?(this._shaderComplexity!==t&&(this._shaderComplexity=t,this._limitShaderFeatures()),i&&(localStorage[X]=t)):n?(this._shaderComplexity=o[o.length-1],e.log("Attempted to set shader complexity to '"+t+"', which is not supported, and thus '"+this._shaderComplexity+"' has been selected instead.",1)):e.showError("Attempting to set shader complexity to '"+t+"', which is not one of the available options ("+this.getShaderComplexities().join(", ")+").",e.ErrorSeverity.MINOR,"The shader complexity will stay '"+this.getShaderComplexity()+"'."),this._luminosityTextureAreAvailable=this._getShaderComplexityDescriptor()[D.LUMINOSITY_TEXTURES_AVAILABLE.name]},_.prototype.getShaderComplexities=function(){return this.getShaderConfig(V.COMPLEXITIES).map(function(t){return t[D.NAME.name]})},_.prototype.getShadowMappingShaderName=function(){return this.getShaderConfig(V.SHADOW_MAPPING_SHADER_NAME)},_.prototype.isShadowMappingEnabled=function(){return this._shadowMappingEnabled},_.prototype.setShadowMapping=function(t,i,n){return void 0===i&&(i=!0),n||!t||this.canEnableShadowMapping()?this._shadowMappingEnabled!==t&&(this._shadowMappingEnabled=t,!n&&t&&this._limitShaderFeatures()):(this._shadowMappingEnabled=!1,e.log("Attempted to enable shadow mapping, but it is not supported (at the current shader complexity level) and so will be disabled.",1)),i&&(localStorage[Y]=t.toString()),this._shadowMappingEnabled===t},_.prototype.getShadowMapQualities=function(){return this._shadowMapQuality.getNameList()},_.prototype.getShadowMapQuality=function(){return this._shadowMapQuality.getCurrentName()},_.prototype.getShadowMapTextureSize=function(){return this._shadowMapQuality.getCurrentValue()},_.prototype.setShadowMapQuality=function(t,e,i){void 0===e&&(e=!0),this._shadowMapQuality.setCurrent(t,i)&&e&&(localStorage[Q]=t)},_.prototype.getShadowRanges=function(){var t,e=[],i=this.getNumShadowMapRanges();for(t=0;i>t;t++)e.push(this._shadowRanges[t]);return e},_.prototype.getShadowDistances=function(){return this._shadowDistances.getFilteredNameList(function(t){return this._shaderRequirementsAreSatisfied({numShadowRanges:t})}.bind(this))},_.prototype.getShadowDistance=function(){return this._shadowDistances.getCurrentName()},_.prototype.getNumShadowMapRanges=function(){return this._shadowMappingEnabled?this._shadowDistances.getCurrentValue():0},_.prototype.setShadowDistance=function(t,e,i){void 0===e&&(e=!0),this._shadowDistances.setCurrent(t,i)&&e&&(localStorage[J]=t)},_.prototype.getShadowDepthRatio=function(){return this._shadowDepthRatio},_.prototype._getShaderComplexityDescriptor=function(t){return void 0===t?this.getShaderConfig(V.COMPLEXITIES).find(function(t){return t[D.NAME.name]===this.getShaderComplexity()}.bind(this),this):this.getShaderConfig(V.COMPLEXITIES)[t]},_.prototype.getMaxDirLights=function(){return this._getShaderComplexityDescriptor()[D.MAX_DIR_LIGHTS.name]},_.prototype.getPointLightAmounts=function(){return this._pointLightAmount.getFilteredNameList(function(t){return this._shaderRequirementsAreSatisfied({numPointLights:t})}.bind(this))},_.prototype.getPointLightAmount=function(){return this._pointLightAmount.getCurrentName()},_.prototype.getMaxPointLights=function(){return this._pointLightAmount.getCurrentValue()},_.prototype.setPointLightAmount=function(t,e,i){void 0===e&&(e=!0),this._pointLightAmount.setCurrent(t,i)&&e&&(localStorage[K]=t)},_.prototype.getMaxSpotLights=function(){return this._getShaderComplexityDescriptor()[D.MAX_SPOT_LIGHTS.name]},_.prototype.getParticleAmounts=function(){return this._particleAmount.getNameList()},_.prototype.getParticleAmount=function(){return this._particleAmount.getCurrentName()},_.prototype.getParticleCountFactor=function(){return this._particleAmount.getCurrentValue()},_.prototype.setParticleAmount=function(t,e,i){void 0===e&&(e=!0),this._particleAmount.setCurrent(t,i)&&e&&(localStorage[Z]=t)},_.prototype.getDustParticleAmounts=function(){return this._dustParticleAmount.getNameList()},_.prototype.getDustParticleAmount=function(){return this._dustParticleAmount.getCurrentName()},_.prototype.getDustParticleCountFactor=function(){return this._dustParticleAmount.getCurrentValue()},_.prototype.setDustParticleAmount=function(t,e,i){void 0===e&&(e=!0),this._dustParticleAmount.setCurrent(t,i)&&e&&(localStorage[$]=t)},_.prototype.getShaderConfig=function(t){return this._shaderConfig[t.name]},_.prototype.setShaderConfig=function(t,e){this._shaderConfig[t.name]=e},_.prototype.getNumShadowMapSamples=function(){return this._getShaderComplexityDescriptor()[D.NUM_SHADOW_MAP_SAMPLES.name]},_.prototype.isShadowMappingAvailable=function(){return this._getShaderComplexityDescriptor()[D.SHADOW_MAPPING_AVAILABLE.name]},_.prototype.areLuminosityTexturesAvailable=function(){return this._luminosityTextureAreAvailable},_.prototype.isRevealAvailable=function(){return this._getShaderComplexityDescriptor()[D.REVEAL_AVAILABLE.name]},_.prototype.areDynamicLightsAvailable=function(){return this._getShaderComplexityDescriptor()[D.DYNAMIC_LIGHTS_AVAILABLE.name]},_.prototype.canEnableShadowMapping=function(){return this.isShadowMappingAvailable()&&this._shaderRequirementsAreSatisfied({numShadowRanges:this._shadowDistances.getFirstValue()})},_.prototype.getShader=function(t){return t=o.getVariantShader(t,this.getShaderComplexity()).getName(),this._shadowMappingEnabled||(t=o.getVariantShader(t,tt).getName()),0===this._pointLightAmount.getCurrentValue()&&(t=o.getVariantShader(t,et).getName()),o.getShader(t)},_.prototype.getManagedShader=function(t){var i,o={};return o[this.getShaderConfig(V.MAX_DIR_LIGHTS_DEFINE_NAME)]=this.getMaxDirLights(),o[this.getShaderConfig(V.MAX_POINT_LIGHTS_DEFINE_NAME)]=this.getMaxPointLights(),o[this.getShaderConfig(V.MAX_SPOT_LIGHTS_DEFINE_NAME)]=this.getMaxSpotLights(),o[this.getShaderConfig(V.MAX_SHADOW_MAP_RANGES_DEFINE_NAME)]=this.getNumShadowMapRanges(),o[this.getShaderConfig(V.MAX_SHADOW_MAPS_DEFINE_NAME)]=this.getMaxDirLights()*this.getNumShadowMapRanges(),o[this.getShaderConfig(V.NUM_SHADOW_MAP_SAMPLES_DEFINE_NAME)]=this.getNumShadowMapSamples(),o[this.getShaderConfig(V.DUST_LENGTH_DIVISOR_DEFINE_NAME)]=this.getShaderConfig(V.DUST_LENGTH_DIVISOR),o[this.getShaderConfig(V.MAX_LUMINOSITY_FACTORS_DEFINE_NAME)]=this.getShaderConfig(V.MAX_LUMINOSITY_FACTORS),o[this.getShaderConfig(V.MAX_GROUP_TRANSFORMS_DEFINE_NAME)]=this.getShaderConfig(V.MAX_GROUP_TRANSFORMS),o[this.getShaderConfig(V.DEPTH_TEXTURES_DEFINE_NAME)]=n.areDepthTexturesAvailable()?"1":"0",o[this.getShaderConfig(V.MAX_SHININESS_DEFINE_NAME)]=this.getShaderConfig(V.MAX_SHININESS),i=this.getShader(t).getManagedShader(o,!0),i.isAllowedByRequirements(this._getShaderRequirements())||e.showError("Shader '"+t+"' has too high requirements!"),i},_.prototype.getModel=function(t){return o.getModel(t,{maxLOD:this.getMaxLoadedLOD()})},f=new _,{loadConfigurationFromJSON:f.loadConfigurationFromJSON.bind(f),loadSettingsFromJSON:f.loadSettingsFromJSON.bind(f),loadSettingsFromLocalStorage:f.loadFromLocalStorage.bind(f),restoreDefaults:f.restoreDefaults.bind(f),getAntialiasing:f.getAntialiasing.bind(f),setAntialiasing:f.setAntialiasing.bind(f),getFiltering:f.getFiltering.bind(f),setFiltering:f.setFiltering.bind(f),getTextureQualities:f.getTextureQualities.bind(f),getTextureQuality:f.getTextureQuality.bind(f),setTextureQuality:f.setTextureQuality.bind(f),getTextureQualityPreferenceList:f.getTextureQualityPreferenceList.bind(f),getCubemapQualities:f.getCubemapQualities.bind(f),getCubemapQuality:f.getCubemapQuality.bind(f),setCubemapQuality:f.setCubemapQuality.bind(f),getCubemapQualityPreferenceList:f.getCubemapQualityPreferenceList.bind(f),getLODLevels:f.getLODLevels.bind(f),getLODLevel:f.getLODLevel.bind(f),setLODLevel:f.setLODLevel.bind(f),getMaxLoadedLOD:f.getMaxLoadedLOD.bind(f),getLODContext:f.getLODContext.bind(f),getShaderComplexity:f.getShaderComplexity.bind(f),setShaderComplexity:f.setShaderComplexity.bind(f),getShaderComplexities:f.getShaderComplexities.bind(f),getMaxLuminosityFactors:f.getShaderConfig.bind(f,V.MAX_LUMINOSITY_FACTORS),getMaxGroupTransforms:f.getShaderConfig.bind(f,V.MAX_GROUP_TRANSFORMS),getShadowMappingShaderName:f.getShadowMappingShaderName.bind(f),isShadowMappingEnabled:f.isShadowMappingEnabled.bind(f),setShadowMapping:f.setShadowMapping.bind(f),getShadowMapQualities:f.getShadowMapQualities.bind(f),getShadowMapQuality:f.getShadowMapQuality.bind(f),getShadowMapTextureSize:f.getShadowMapTextureSize.bind(f),setShadowMapQuality:f.setShadowMapQuality.bind(f),getShadowDistances:f.getShadowDistances.bind(f),getShadowDistance:f.getShadowDistance.bind(f),setShadowDistance:f.setShadowDistance.bind(f),getShadowDepthRatio:f.getShadowDepthRatio.bind(f),getNumShadowMapSamples:f.getNumShadowMapSamples.bind(f),getMaxDirLights:f.getMaxDirLights.bind(f),getPointLightAmounts:f.getPointLightAmounts.bind(f),getPointLightAmount:f.getPointLightAmount.bind(f),getMaxPointLights:f.getMaxPointLights.bind(f),setPointLightAmount:f.setPointLightAmount.bind(f),getParticleAmounts:f.getParticleAmounts.bind(f),getParticleAmount:f.getParticleAmount.bind(f),getParticleCountFactor:f.getParticleCountFactor.bind(f),setParticleAmount:f.setParticleAmount.bind(f),getDustParticleAmounts:f.getDustParticleAmounts.bind(f),getDustParticleAmount:f.getDustParticleAmount.bind(f),getDustParticleCountFactor:f.getDustParticleCountFactor.bind(f),setDustParticleAmount:f.setDustParticleAmount.bind(f),getMaxSpotLights:f.getMaxSpotLights.bind(f),isShadowMappingAvailable:f.isShadowMappingAvailable.bind(f),areLuminosityTexturesAvailable:f.areLuminosityTexturesAvailable.bind(f),isRevealAvailable:f.isRevealAvailable.bind(f),areDynamicLightsAvailable:f.areDynamicLightsAvailable.bind(f),canEnableShadowMapping:f.canEnableShadowMapping.bind(f),getShader:f.getShader.bind(f),getManagedShader:f.getManagedShader.bind(f),getModel:f.getModel.bind(f),shouldUseShadowMapping:p,getShadowMappingShader:d,getShadowMappingSettings:g,executeWhenReady:f.executeWhenReady.bind(f)}}),define("modules/physics",["utils/utils","utils/vectors","utils/matrices"],function(t,e,i){"use strict";function n(t,i,n,o){this._id=t,this._strength=i,this._direction=e.normal3(n),this._duration=o,this._continuous=void 0===o}function o(t,i,n,o){this._id=t,this._strength=i,this._axis=e.normal3(n),this._duration=o,this._continuous=void 0===o}function r(t,e,n){this._positionMatrix=t,this._positionVector=i.translationVector3(t),this._orientationMatrix=e,this._rotated=!i.equal4(e,i.IDENTITY4),this._modelMatrixInverse=null,this._halfWidth=.5*n[0],this._halfHeight=.5*n[1],this._halfDepth=.5*n[2]}function s(t,e,n,o,r,s,a){this._mass=0,this._positionMatrix=i.identity4(),this._orientationMatrix=i.identity4(),this._scalingMatrix=i.identity4(),this._rotationMatrixInverse=null,this._modelMatrixInverse=null,this._velocityMatrix=i.identity4(),this._angularVelocityMatrix=i.identity4(),this._forces=null,this._torques=null,this._bodies=null,this._bodySize=-1,this._fixedOrientation=!1,e&&this.init(t,e,n,o,r,s,a)}var a=5,h=1e-4,l=1e-5;return n.prototype.getID=function(){return this._id},n.prototype.renew=function(t,i,n){this._strength=t,this._direction=e.normal3(i),this._duration=n,this._continuous=void 0===n},n.prototype.exert=function(t){if(this._continuous)return this._continuous=!1,this._duration=0,t;if(this._duration>.1){var e=Math.min(this._duration,t);return this._duration-=t,e}return 0},n.prototype.getAccelerationVector=function(t){return e.scaled3(this._direction,this._strength/t)},o.prototype.getID=function(){return this._id},o.prototype.renew=function(t,e,i){this._strength=t,this._axis=e,this._duration=i,this._continuous=void 0===i},o.prototype.exert=function(t){if(this._continuous)return this._continuous=!1,this._duration=0,t;if(this._duration>.1){var e=Math.min(this._duration,t);return this._duration-=t,e}return 0},o.prototype.getAngularAccelerationMatrixOverTime=function(t,e){return i.rotation4(this._axis,this._strength/t*e)},r.prototype.getPositionMatrix=function(){return this._positionMatrix},r.prototype.getOrientationMatrix=function(){return this._orientationMatrix},r.prototype.getWidth=function(){return 2*this._halfWidth},r.prototype.getHeight=function(){return 2*this._halfHeight},r.prototype.getDepth=function(){return 2*this._halfDepth},r.prototype._modelTransform=function(t){return this._rotated?e.sum3(e.mulVec3Mat4(t,this._orientationMatrix),this._positionVector).concat(1):e.sum3(t,this._positionVector).concat(1)},r.prototype.getModelMatrixInverse=function(){return this._modelMatrixInverse=this._modelMatrixInverse||i.prodTranslationRotation4(i.inverseOfTranslation4(this._positionMatrix),i.inverseOfRotation4(this._orientationMatrix)),this._modelMatrixInverse},r.prototype.getHalfDimensions=function(){return[this._halfWidth,this._halfHeight,this._halfDepth]},r.prototype.checkHit=function(n,o,r,s){var a,h,l,u=this._halfWidth+s,c=this._halfHeight+s,_=this._halfDepth+s;if(n=this._rotated?e.mulVec4Mat4(n,this.getModelMatrixInverse()):e.diff3(n,this._positionVector),this._rotated&&(o=e.mulVec3Mat3(o,i.matrix3from4(i.inverseOfRotation4(this._orientationMatrix)))),0!==o[0])if(o[0]>0){if(a=(-u-n[0])/o[0],h=n[1]+o[1]*a,l=n[2]+o[2]*a,t.pointInRect(h,l,-c,-_,c,_))return 0>=a&&a>=-r?this._modelTransform([-u,h,l,1]):null}else if(a=(u-n[0])/o[0],h=n[1]+o[1]*a,l=n[2]+o[2]*a,t.pointInRect(h,l,-c,-_,c,_))return 0>=a&&a>=-r?this._modelTransform([u,h,l,1]):null;if(0!==o[1])if(o[1]>0){if(a=(-c-n[1])/o[1],h=n[0]+o[0]*a,l=n[2]+o[2]*a,t.pointInRect(h,l,-u,-_,u,_))return 0>=a&&a>=-r?this._modelTransform([h,-c,l,1]):null}else if(a=(c-n[1])/o[1],h=n[0]+o[0]*a,l=n[2]+o[2]*a,t.pointInRect(h,l,-u,-_,u,_))return 0>=a&&a>=-r?this._modelTransform([h,c,l,1]):null;if(0!==o[2])if(o[2]>0){if(a=(-_-n[2])/o[2],h=n[0]+o[0]*a,l=n[1]+o[1]*a,t.pointInRect(h,l,-u,-c,u,c))return 0>=a&&a>=-r?this._modelTransform([h,l,-_,1]):null}else if(a=(_-n[2])/o[2],h=n[0]+o[0]*a,l=n[1]+o[1]*a,t.pointInRect(h,l,-u,-c,u,c))return 0>=a&&a>=-r?this._modelTransform([h,l,_,1]):null;return null},s.prototype.init=function(t,e,n,o,r,s,a){this._mass=t,i.setMatrix4(this._positionMatrix,e),i.setMatrix4(this._orientationMatrix,n),i.setMatrix4(this._scalingMatrix,o),this._rotationMatrixInverse=null,this._modelMatrixInverse=null,i.setMatrix4(this._velocityMatrix,r),i.setIdentity4(this._angularVelocityMatrix),this._forces=[],this._torques=[],this._bodies=s||[],this._bodySize=-1,this._calculateBodySize(),this._fixedOrientation=!!a},s.prototype.getMass=function(){return this._mass},s.prototype.getPositionMatrix=function(){return this._positionMatrix},s.prototype.getOrientationMatrix=function(){return this._orientationMatrix},s.prototype.getScalingMatrix=function(){return this._scalingMatrix},s.prototype.getBodySize=function(){return this._bodySize},s.prototype.getSize=function(){return this._bodySize*this._scalingMatrix[0]},s.prototype.getVelocityMatrix=function(){return this._velocityMatrix},s.prototype.getAngularVelocityMatrix=function(){return this._angularVelocityMatrix},s.prototype.addForce=function(t){this._forces.push(t)},s.prototype.addTorque=function(t){this._torques.push(t)},s.prototype.setPositionMatrix=function(t){t&&(this._positionMatrix=t),this._modelMatrixInverse=null},s.prototype.setOrientationMatrix=function(t){t&&(this._orientationMatrix=t),this._rotationMatrixInverse=null,this._modelMatrixInverse=null},s.prototype.setScalingMatrix=function(t){this._scalingMatrix=t,this._modelMatrixInverse=null},s.prototype.getRotationMatrixInverse=function(){return this._rotationMatrixInverse=this._rotationMatrixInverse||i.inverseOfRotation4(this._orientationMatrix),this._rotationMatrixInverse},s.prototype.getModelMatrixInverse=function(){return this._modelMatrixInverse=this._modelMatrixInverse||i.prodTranslationRotation4(i.inverseOfTranslation4(this._positionMatrix),i.prod3x3SubOf4(this.getRotationMatrixInverse(),i.inverseOfScaling4(this._scalingMatrix))),this._modelMatrixInverse},s.prototype.moveByVector=function(t){i.translateByVector(this._positionMatrix,t),this._modelMatrixInverse=null},s.prototype.addOrRenewForce=function(t,e,i,o){var r,s=!1;for(r=0;r<this._forces.length;r++)if(this._forces[r].getID()===t){this._forces[r].renew(e,i,o),s=!0;break}s===!1&&this.addForce(new n(t,e,i,o))},s.prototype.addOrRenewTorque=function(t,e,i,n){var r,s=!1;for(r=0;r<this._torques.length;r++)if(this._torques[r].getID()===t){this._torques[r].renew(e,i,n),s=!0;break}s===!1&&this.addTorque(new o(t,e,i,n))},s.prototype.addForceAndTorque=function(t,i,r,s){var a=e.normal3(t),h=e.scaled3(a,e.dot3(i,a)),l=e.diff3(i,h);this.addForce(new n("",r,i,s)),this.addTorque(new o("",r*e.length3(l)*e.length3(t),e.normal3(e.cross3(l,a)),s))},s.prototype._calculateBodySize=function(){var t,n,o;for(this._bodySize=0,t=0;t<this._bodies.length;t++)n=i.translationVector3(this._bodies[t]._positionMatrix),o=e.mulVec3Mat3(this._bodies[t].getHalfDimensions(),i.prod3x3SubOf43(this._orientationMatrix,this._bodies[t]._orientationMatrix)),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(n,o))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(n,[o[0],o[1],-o[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(n,[o[0],-o[1],o[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(n,[o[0],-o[1],-o[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(n,[-o[0],o[1],o[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(n,[-o[0],o[1],-o[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(n,[-o[0],-o[1],o[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(n,[-o[0],-o[1],-o[2]])))},s.prototype.checkHit=function(t,n,o,r){var s,a,h,l,u=null;if(r=r||0,r/=this._scalingMatrix[0],t.push(1),s=e.mulVec4Mat4(t,this.getModelMatrixInverse()),a=e.diff3(n,i.translationVector3(this.getVelocityMatrix())),l=e.length3(a)*o/1e3/this._scalingMatrix[0],Math.abs(s[0])-l<this._bodySize&&Math.abs(s[1])-l<this._bodySize&&Math.abs(s[2])-l<this._bodySize)for(a=e.mulVec3Mat3(a,i.matrix3from4(this.getRotationMatrixInverse())),e.normalize3(a),h=0;null===u&&h<this._bodies.length;h++)u=this._bodies[h].checkHit(s,a,l,r);return u},s.prototype._correctMatrices=function(){i.correctOrthogonal4(this._orientationMatrix),this.setOrientationMatrix(),i.correctOrthogonal4(this._angularVelocityMatrix)},s.prototype.simulate=function(t){var n,o,r,s,u;if(t>0){if(i.translateByVector(this._positionMatrix,e.scaled3(i.translationVector3(this._velocityMatrix),t/1e3)),this.setPositionMatrix(),this._forces.length>0){for(s=i.identity4(),n=0;n<this._forces.length;n++)r=this._forces[n].exert(t)/1e3,r>0&&(o=this._forces[n].getAccelerationVector(this._mass),i.translateByVector(this._positionMatrix,e.scaled3(o,.5*r*r)),i.translateByVector(s,e.scaled3(o,r)));i.translateByMatrix(this._velocityMatrix,s)}if(i.straighten(this._velocityMatrix,h),!this._fixedOrientation){for(n=0;t>n+a/2;n+=a)i.mul4(this._orientationMatrix,this._angularVelocityMatrix);if(this.setOrientationMatrix(),this._torques.length>0){for(u=i.identity4(),n=0;n<this._torques.length;n++)r=this._torques[n].exert(t)/1e3,r>0&&(i.mul4(this._orientationMatrix,this._torques[n].getAngularAccelerationMatrixOverTime(this._mass,.5*r*r)),i.mul4(u,this._torques[n].getAngularAccelerationMatrixOverTime(this._mass,a*r/1e3)));i.mul4(this._angularVelocityMatrix,u)}i.straighten(this._angularVelocityMatrix,l),this._correctMatrices()}}},{Body:r,Force:n,Torque:o,PhysicalObject:s,ANGULAR_VELOCITY_MATRIX_DURATION:a,ANGULAR_VELOCITY_MATRIX_DURATION_S:a/1e3,VELOCITY_MATRIX_ERROR_THRESHOLD:h,ANGULAR_VELOCITY_MATRIX_ERROR_THRESHOLD:l}}),define("armada/strings",["modules/strings"],function(t){"use strict";return t.SCREEN={BACK:{name:"screen.back"}},t.MAIN_MENU={NEW_GAME:{name:"mainMenu.newGame"},DEMO:{name:"mainMenu.demo"},DATABASE:{name:"mainMenu.database"},SETTINGS:{name:"mainMenu.settings"},ABOUT:{name:"mainMenu.about"}},t.SETTINGS={GENERAL:{name:"settings.general"},GRAPHICS:{name:"settings.graphics"},CONTROLS:{name:"settings.controls"},DEFAULTS:{name:"settings.defaults"}},t.INGAME_MENU={TITLE:{name:"ingameMenu.title"},RESUME:{name:"ingameMenu.resume"},RESTART:{name:"ingameMenu.restart"},QUIT:{name:"ingameMenu.quit"}},t.INFO_BOX={HEADER:{name:"infoBox.header"},OK_BUTTON:{name:"infoBox.okButton"}},t.LOADING={HEADER:{name:"loading.header"},RESOURCES_START:{name:"loading.resourcesStart"},RESOURCE_READY:{name:"loading.resourceReady"},INIT_WEBGL:{name:"loading.initWebGL"},READY:{name:"loading.ready"}},t.SPACECRAFT_STATS={ARMOR:{name:"spacecraftStats.armor"},ARMOR_RATING:{name:"spacecraftStats.armorRating"}},t.LEVEL={PREFIX:{name:"level.",optional:!0}},t.TEAM={PREFIX:{name:"team.",optional:!0}},t.SQUAD={PREFIX:{name:"squad.",optional:!0}},t.BATTLE={DEVELOPMENT_VERSION_NOTICE:{name:"battle.developmentVersionNotice"},SPECTATOR_MODE:{name:"battle.spectatorMode"},HUD_TARGET:{name:"battle.hud.target"},HUD_DISTANCE:{name:"battle.hud.distance"},HUD_VELOCITY:{name:"battle.hud.velocity"},HUD_SPACECRAFT_NAME_UNKNOWN:{name:"battle.hud.spacecraftNameUnknown"},HUD_TEAM_UNKNOWN:{name:"battle.hud.teamUnknown"},HUD_VIEW:{name:"battle.hud.view"},HUD_FLIGHT_MODE:{name:"battle.hud.flightMode"},HUD_SPEED:{name:"battle.hud.speed"},LOADING_BOX_LOADING_LEVEL:{name:"battle.loadingBox.loadingLevel"},LOADING_BOX_ADDING_RANDOM_ELEMENTS:{name:"battle.loadingBox.addingRandomElements"},LOADING_BOX_BUILDING_SCENE:{name:"battle.loadingBox.buildingScene"},MESSAGE_READY:{name:"battle.message.ready"},MESSAGE_PAUSED:{name:"battle.message.paused"},MESSAGE_VICTORY:{name:"battle.message.victory"},MESSAGE_DEFEAT:{name:"battle.message.defeat"}},t.DATABASE={BACK:{name:"database.backButton"},TITLE:{name:"database.title"},PREV_BUTTON:{name:"database.prevButton"},NEXT_BUTTON:{name:"database.nextButton"},LOADING_BOX_INITIALIZING:{name:"database.loadingBox.initializing"},LENGTH:{name:"database.length"},MASS:{name:"database.mass"},WEAPON_SLOTS:{name:"database.weaponSlots"},THRUSTERS:{name:"database.thrusters"},MISSING_SPACECRAFT_TYPE_DESCRIPTION:{name:"database.missingSpacecraftTypeDescription"},MISSING_SPACECRAFT_CLASS_DESCRIPTION:{name:"database.missingSpacecraftClassDescription"}},t.ABOUT={BACK:{name:"about.backButton"},TITLE:{name:"about.title"},ABOUT_GAME_HEADER:{name:"about.aboutGameHeader"},VERSION_PARAGRAPH:{name:"about.versionParagraph"},ABOUT_GAME_PARAGRAPH:{name:"about.aboutGameParagraph"},ABOUT_AUTHOR_LICENSE_HEADER:{name:"about.aboutAuthorLicenseHeader"},ABOUT_AUTHOR_LICENSE_PARAGRAPH:{name:"about.aboutAuthorLicenseParagraph"},REQUIRE_JS_LICENSES:{name:"about.theNewBSDOrMITLicenses"},ABOUT_USED_SOFTWARE_HEADER:{name:"about.aboutUsedSoftwareHeader"},ABOUT_USED_SOFTWARE_PARAGRAPH:{name:"about.aboutUsedSoftwareParagraph"}},t.SETTING={PREFIX:{name:"setting.",optional:!0},ON:{name:"setting.on"},OFF:{name:"setting.off"},VERY_LOW:{name:"setting.veryLow"},LOW:{name:"setting.low"},MEDIUM:{name:"setting.medium"},HIGH:{name:"setting.high"},VERY_HIGH:{name:"setting.veryHigh"},NORMAL:{name:"setting.normal"},MINIMUM:{name:"setting.minimum"},MAXIMUM:{name:"setting.maximum"},FEW:{name:"setting.few"},MANY:{name:"setting.many"}},t.GENERAL_SETTINGS={BACK:{name:"generalSettings.backButton"},TITLE:{name:"generalSettings.title"},LANGUAGE:{name:"generalSettings.language"}},t.GRAPHICS={PREFIX:{name:"graphics.",optional:!0},BACK:{name:"graphics.back"},TITLE:{name:"graphics.title"},ANTIALIASING:{name:"graphics.antialiasing"},FILTERING:{name:"graphics.filtering"},BILINEAR:{name:"graphics.bilinear"},TRILINEAR:{name:"graphics.trilinear"},ANISOTROPIC:{name:"graphics.anisotropic"},TEXTURE_QUALITY:{name:"graphics.textureQuality"},BACKGROUND_QUALITY:{name:"graphics.backgroundQuality"},MODEL_DETAILS:{name:"graphics.modelDetails"},SHADERS:{name:"graphics.shaders"},SHADOWS:{name:"graphics.shadows"},SHADOW_QUALITY:{name:"graphics.shadowQuality"},SHADOW_DISTANCE:{name:"graphics.shadowDistance"},MAX_DYNAMIC_LIGHTS:{name:"graphics.maxDynamicLights"},PARTICLE_AMOUNT:{name:"graphics.particleAmount"},DUST_PARTICLE_AMOUNT:{name:"graphics.dustParticleAmount"}},t.CONTOLLER={PREFIX:{name:"controller.",optional:!0},GENERAL:{name:"controller.general"},FIGHTER:{name:"controller.fighter"},CAMERA:{name:"controller.camera"}},t.INPUT={DEVICE_NAME_PREFIX:{name:"inputDevice.",optional:!0},DEVICE_KEYBOARD:{name:"inputDevice.keyboard"},DEVICE_MOUSE:{name:"inputDevice.mouse"},DEVICE_JOYSTICK:{name:"inputDevice.joystick"}},t.CONTROLS={BACK:{name:"controls.back"},TITLE:{name:"controls.title"},CONTROLLER_TYPE_HEADING:{name:"controls.controllerHeading"},ACTION:{name:"controls.action"}},t.ACTION_DESCRIPTIONS={PREFIX:{name:"actionDescriptions.",optional:!0}},t.SPACECRAFT_CLASS={PREFIX:{name:"spacecraftClass.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},t.SPACECRAFT_TYPE={PREFIX:{name:"spacecraftType.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},t.OBJECT_VIEW={PREFIX:{name:"objectView.",optional:!0}},t.FLIGHT_MODE={PREFIX:{name:"flightMode.",optional:!0}},t}),define("armada/classes",["utils/utils","utils/types","utils/vectors","utils/matrices","modules/application","modules/resource-manager","modules/egom-model","modules/physics","modules/graphics-resources","modules/buda-scene","armada/graphics","armada/strings"],function(t,e,i,n,o,r,s,a,h,l,u,c){"use strict";function _(t){return $.getResource(st,t)}function p(t){return $.getResource(at,t)}function d(t){return $.getResource(ht,t)}function g(t){return $.getResource(lt,t)}function f(t){return $.getResource(ut,t)}function m(t){return $.getResource(ct,t)}function y(t){return $.getResource(_t,t)}function T(t){return $.getResource(pt,t)}function S(t,e){return $.getResource(dt,t,{allowNullResult:e})}function M(t){var e,i=[],n=$.getResourceNames(dt);for(e=0;e<n.length;e++)(!t||S(n[e]).shouldShowInDatabase())&&i.push(S(n[e]));return i}function x(t,e){o.showError("Cannot initialize "+t.constructor.name+" without correctly specifying its property '"+e+"'!",o.ErrorSeverity.SEVERE,"The property was either not specified, or it was specified with a wrong type or an invalid value."+("string"==typeof t._name?"The error happened while initializing '"+t._name+"'":""))}function E(t){r.GenericResource.call(this,t?t.name||x(this,"name"):null),this._source=t?t.source||null:null,t&&(this._source||(this._loadData(t),this.setToReady()))}function b(t){E.call(this,t)}function A(t){b.call(this,t)}function O(t){A.call(this,t)}function R(t){A.call(this,t)}function v(t){R.call(this,t)}function C(t){E.call(this,t)}function I(t){A.call(this,t)}function L(t){R.call(this,t)}function N(t){E.call(this,t)}function w(t){R.call(this,t)}function D(t){this._projectileClass=t?f(t.projectile||x(this,"projectile"))||o.crash():null,this._projectileVelocity=t?t.projectileVelocity||x(this,"projectileVelocity"):0,this._positionVector=t?t.position||x(this,"position"):null,this._positionVector&&this._positionVector.push(1)}function F(t){this.axis=e.getValueOfType("WeaponRotator.axis",e.VECTOR3,t.axis),this.center=e.getValueOfType("WeaponRotator.center",e.VECTOR3,t.center),this.range=e.getValueOfType("WeaponRotator.range",e.VECTOR2,t.range,null,!0),this.range&&(this.range[0]=Math.radians(this.range[0]),this.range[1]=Math.radians(this.range[1])),this.defaultAngle=Math.radians(e.getValueOfType("WeaponRotator.defaultAngle",e.NUMBER,t.defaultAngle)),this.restricted=!!this.range,this.rotationRate=Math.radians(e.getValueOfType("WeaponRotator.rotationRate",e.NUMBER,t.rotationRate)),this.transformGroupIndex=e.getValueOfType("WeaponRotator.transformGroupIndex",e.NUMBER,t.transformGroupIndex)}function V(t){R.call(this,t)}function P(t){E.call(this,t)}function U(t){E.call(this,t)}function B(t){this.positionMatrix=t?n.translation4v(t.position||x(this,"position")):null,this.orientationMatrix=t?n.rotation4FromJSON(t.rotations||[]):null,this.maxGrade=t?t.maxGrade||x(this,"maxGrade"):0}function G(t){this.positionVector=t?t.position||x(this,"position"):null,this.positionVector&&this.positionVector.push(1),this.size=t?t.size||1:0,this.uses=t?t.uses||x(this,"uses"):null,this.group=t?"number"==typeof t.groupIndex?t.groupIndex:x(this,"groupIndex"):0;
}function H(t){this.className=t?t["class"]||x(this,"class"):null}function j(t){this.className=t?t["class"]||x(this,"class"):null}function k(t){var e;if(this._name=t.name||"custom",this._weaponDescriptors=[],t.weapons)for(e=0;e<t.weapons.length;e++)this._weaponDescriptors.push(new H(t.weapons[e]));this._propulsionDescriptor=t.propulsion?new j(t.propulsion):null}function z(e){this._name=e?e.name||x(this,"name"):null,this._fps=e&&"boolean"==typeof e.fps?e.fps:!1,this._fov=e?e.fov||0:0,this._fovRange=e?e.fovRange||null:null,this._movable=e?"boolean"==typeof e.movable?e.movable:x(this,"movable"):!1,this._turnable=e?"boolean"==typeof e.turnable?e.turnable:x(this,"turnable"):!1,this._positionMatrix=e?n.translation4v(e.position||x(this,"position")):null,this._orientationMatrix=e?n.rotation4FromJSON(e.rotations):null,this._alphaRange=e&&this._fps?e.alphaRange||[-360,360]:[0,0],this._betaRange=e&&this._fps?e.betaRange||[-90,90]:[0,0],this._span=e?e.span||0:0,this._spanRange=e?e.spanRange||null:null,this._confines=e?e.confines||null:null,this._resetsWhenLeavingConfines=e&&"boolean"==typeof e.resetsWhenLeavingConfines?e.resetsWhenLeavingConfines:!1,this._baseOrientation=e&&e.baseOrientation?t.getSafeEnumValue(l.CameraOrientationConfiguration.prototype.BaseOrientation,e.baseOrientation)||o.showError("Invalid value '"+e.baseOrientation+"' specified for view baseOrientation!",o.ErrorSeverity.MINOR,"Valid values are: "+t.getEnumValues(l.CameraOrientationConfiguration.prototype.BaseOrientation).join(", ")+"."):null,this._pointToFallback=e&&e.pointToFallback?t.getSafeEnumValue(l.CameraOrientationConfiguration.prototype.PointToFallback,e.pointToFallback)||o.showError("Invalid value '"+e.pointToFallback+"' specified for view pointToFallback!",o.ErrorSeverity.MINOR,"Valid values are: "+t.getEnumValues(l.CameraOrientationConfiguration.prototype.PointToFallback).join(", ")+"."):null}function W(e){z.call(this,e),this._isAimingView="boolean"==typeof e.isAimingView?e.isAimingView:x(this,"isAimingView"),this._followsPosition="boolean"==typeof e.followsPosition?e.followsPosition:x(this,"followsPosition"),e.lookAt=t.getSafeEnumValue(it,e.lookAt,it.NONE),this._followsOrientation="boolean"==typeof e.followsOrientation?e.followsOrientation:e.lookAt===it.NONE,this._lookAtSelf=e.lookAt===it.SELF?this._followsPosition||this._followsOrientation||this._turnable?o.showError("Invalid view configuration ('"+this._name+"'): lookAt mode cannot be 'self' if followsPosition, followsOrientation or turnable are true!"):!0:!1,this._lookAtTarget=e.lookAt===it.TARGET?this._followsOrientation||this._turnable?o.showError("Invalid view configuration ('"+this._name+"'): lookAt mode cannot be 'target' if followsOrientation or turnable are true!"):!0:!1,this._rotationCenterIsObject="boolean"==typeof e.rotationCenterIsObject?e.rotationCenterIsObject?this._lookAtSelf||!this._followsPosition?o.showError("Invalid view configuration ('"+this._name+"'): rotationCenterIsObject with lookAtSelf or without followsPosition!"):!0:!1:this._lookAtSelf||!this._followsPosition?!1:x(this,"rotationCenterIsObject"),this._startsWithRelativePosition=e.startsWithRelativePosition===!0?this._followsPosition||this._rotationCenterIsObject?o.showError("Invalid view configuration ('"+this._name+"'): startsWithRelativePosition cannot be set to true if followsPosition or rotationCenterIsObject are true!"):!0:!1,this._distanceRange=(this._rotationCenterIsObject||this._lookAtSelf||this._lookAtTarget)&&this._movable?e.distanceRange||x(this,"distanceRange"):e.distanceRange||null,this._movesRelativeToObject=e.movesRelativeToObject===!0?!this._rotationCenterIsObject&&this._followsPosition&&this._followsOrientation?!0:o.showError("Invalid view configuration ('"+this._name+"'): movesRelativeToObject can only be set if both position and orientation is followed and rotationCenterIsObject is false!"):!1,this._resetsOnFocusChange="boolean"==typeof e.resetsOnFocusChange?e.resetsOnFocusChange:!1,!this._followsPosition&&!this._startsWithRelativePosition&&(this._lookAtSelf||this._lookAtTarget)&&this._confines&&this._distanceRange&&o.showError("Invalid view configuration ('"+this._name+"'): A lookAt configuration with absolute position cannot have both position and distance confines!",o.ErrorSeverity.SEVERE,"Setting this configuration will likely cause a crash as position confines are absolute (if the position is absolute) but distance confines are relative to the lookAt object."),this._followsPosition||this._startsWithRelativePosition||!this._resetsWhenLeavingConfines||o.showError("Invalid view configuration ('"+this._name+"'): resetsWhenLeavingConfines cannot be set if position is absolute!")}function q(e){z.call(this,e),this._turnAroundAll="boolean"==typeof e.turnAroundAll?e.turnAroundAll:!1,this._lookAtAll=t.getSafeEnumValue(nt,e.lookAt,nt.NONE)===nt.ALL?this._turnAroundAll||this._turnable?o.showError("Invalid view configuration ('"+this._name+"'): lookAt mode cannot be 'all' if turnAroundAll or turnable are true!"):!0:!1,this._distanceRange=(this._turnAroundAll||this._lookAtAll)&&this._movable?e.distanceRange||x(this,"distanceRange"):e.distanceRange||null,this._startsWithRelativePosition=e.startsWithRelativePosition===!0?this._turnAroundAll?o.showError("Invalid view configuration ('"+this._name+"'): startsWithRelativePosition cannot be true if the view is set to turn around the objects!"):!0:!1,!this._turnAroundAll&&!this._startsWithRelativePosition&&this._lookAtAll&&this._confines&&this._distanceRange&&o.showError("Invalid view configuration ('"+this._name+"'): A lookAt configuration with absolute position cannot have both position and distance confines!",o.ErrorSeverity.SEVERE,"Setting this configuration will likely cause a crash as position confines are absolute (if the position is absolute) but distance confines are relative to the lookAt object."),this._turnAroundAll||this._startsWithRelativePosition||!this._resetsWhenLeavingConfines||o.showError("Invalid view configuration ('"+this._name+"'): resetsWhenLeavingConfines cannot be set if position is absolute!")}function X(t){this.hullIntegrity=t?t.hullIntegrity||x(this,"hullIntegrity"):0,this.explosionClass=t?g(t["class"]||x(this,"class"))||o.crash():null}function Y(t){this.position=t?t.position||x(this,"position"):null,this.color=t?t.color||x(this,"color"):null,this.intensity=t?t.intensity||x(this,"intensity"):0,this.spotDirection=t?t.spotDirection||null:null,this.spotCutoffAngle=t?t.spotCutoffAngle||0:0,this.spotFullIntensityAngle=t?t.spotFullIntensityAngle||0:0}function Q(t){this._particle=null,t.particle?(t.particle.name="-",this._particle=new v(t.particle)):x(this,"particle"),this._position=t?t.position||x(this,"position"):null,this._period=t?t.period||x(this,"period"):0,this._blinks=t?t.blinks||x(this,"blinks"):null,this._intensity=t?t.intensity||x(this,"intensity"):0}function J(t){R.call(this,t)}function K(t,e){var i={};i[st]=O,i[at]=C,i[ht]=I,i[lt]=N,i[ut]=w,i[ct]=V,i[_t]=P,i[pt]=U,i[dt]=J,$.requestConfigLoad(t.filename,t.folder,i,function(){$.requestAllResources(),$.requestResourceLoad(),e&&e()}),tt=t.folder}function Z(){$.executeForAllResources(function(t){t.handleGraphicsSettingsChanged()})}var $,tt,et={OMNIDIRECTIONAL:"omnidirectional",UNIDIRECTIONAL:"unidirectional",PLANAR:"planar"},it={NONE:"none",SELF:"self",TARGET:"target"},nt={NONE:"none",ALL:"all"},ot={NONE:"none",YAW_PITCH:"yawPitch",ROLL_YAW:"rollYaw"},rt={YAW_PITCH:"yawPitch",ROLL_YAW:"rollYaw",ROLL_PITCH:"rollPitch"},st="skyboxClasses",at="backgroundObjectClasses",ht="dustCloudClasses",lt="explosionClasses",ut="projectileClasses",ct="weaponClasses",_t="propulsionClasses",pt="spacecraftTypes",dt="spacecraftClasses",gt="fvqModel",ft="squareModel",mt="dust",yt="projectileModel-";return Object.freeze(et),Object.freeze(it),Object.freeze(nt),E.prototype=new r.GenericResource,E.prototype.constructor=E,E.prototype.requiresReload=function(){return this.isRequested()?!1:!this.isLoaded()},E.prototype._requestFiles=function(){o.requestTextFile(tt,this._source,function(t){this._onFilesLoad(!0,JSON.parse(t))}.bind(this))},E.prototype._loadData=function(){this._source=this._source||""},E.prototype.showResourceAccessError=function(t,e){o.showError("Attempting to access "+t+" ('"+e+"') of class '"+this._name+"' before it has been loaded!")},E.prototype.handleGraphicsSettingsChanged=function(){},b.prototype=new E,b.prototype.constructor=b,b.prototype._overrideData=function(t,e){E.prototype._loadData.call(this,e),this._shaderName=t?e&&e.shader?e.shader:t._shaderName:e?e.shader||x(this,"shader"):null,this._shader=null,this._instancedShaderName=null,this._instancedShader=null,this._managedShader=null,this._managedInstancedShader=null},b.prototype._loadData=function(t){this._overrideData(null,t)},b.prototype.acquireResources=function(t){t=t||{},t.omitShader||(this._shader=u.getShader(this._shaderName),this._instancedShaderName=h.getShader(this._shaderName).getVariantShaderName("instanced"),this._instancedShaderName&&(this._instancedShader=u.getShader(this._instancedShaderName)))},b.prototype.getShader=function(){return null===this._shader?(this.showResourceAccessError("shader",this._shaderName),null):(this._managedShader||(this._managedShader=u.getManagedShader(this._shaderName)),this._managedShader)},b.prototype.getInstancedShader=function(){return null===this._instancedShader?(o.showError("Attempting to access the instanced shader of '"+this._name+"', which does not exist (or is not loaded)!"),null):(this._managedInstancedShader||(this._managedInstancedShader=u.getManagedShader(this._instancedShaderName)),this._managedInstancedShader)},b.prototype.handleGraphicsSettingsChanged=function(){this._managedShader=null,this._managedInstancedShader=null},A.prototype=new b,A.prototype.constructor=A,A.prototype._overrideData=function(t,e){b.prototype._overrideData.call(this,t,e),this._modelName=t?e&&e.model?e.model:t._modelName:e?e.model||null:null,this._model=null},A.prototype._loadData=function(t){this._overrideData(null,t)},A.prototype.acquireResources=function(t){b.prototype.acquireResources.call(this,t),t&&t.model?(this._model=h.getOrAddModel(t.model),this._modelName=this._model.getName()):this._model=u.getModel(this._modelName)},A.prototype.getModel=function(){return null===this._model?(this.showResourceAccessError("model",this._modelName),null):this._model.getEgomModel()},O.prototype=new A,O.prototype.constructor=O,O.prototype._loadData=function(t){A.prototype._loadData.call(this,t),this._cubemapName=t?t.cubemap||x(this,"cubemap"):null,this._cubemap=null},O.prototype.acquireResources=function(){A.prototype.acquireResources.call(this,{model:s.fvqModel(gt)}),null===this._cubemap&&(this._cubemap=h.getCubemap(this._cubemapName))},O.prototype.getCubemap=function(t){return null===this._cubemap?(this.showResourceAccessError("cubemap",this._cubemapName),null):this._cubemap.getManagedCubemap(t)},R.prototype=new A,R.prototype.constructor=R,R.prototype._overrideData=function(t,e){var i,n,r;for(A.prototype._overrideData.call(this,t,e),this._textureName=t?e&&e.texture?e.texture:t._textureName:e?e.texture||x(this,"texture"):null,this._texture=null,this._defaultLuminosityFactors=[],i=0,r=u.getMaxLuminosityFactors();r>i;i++)this._defaultLuminosityFactors.push(0);for(i=0;i<(e.defaultLuminosityFactors||[]).length;i++)n=e.defaultLuminosityFactors[i][0],n<u.getMaxLuminosityFactors()?this._defaultLuminosityFactors[n]=e.defaultLuminosityFactors[i][1]:o.showError("Attempting to set luminosity of group with index "+n+", while there are only "+u.getMaxLuminosityFactors()+" luminosity groups available. (and indices start with 0)",o.ErrorSeverity.MINOR,"Happened while creating textured model class '"+this.getName()+"'.")},R.prototype._loadData=function(t){this._overrideData(null,t)},R.prototype.acquireResources=function(t){A.prototype.acquireResources.call(this,t),null===this._texture&&(this._texture=h.getTexture(this._textureName))},R.prototype.getTexture=function(t,e){return null===this._texture?(this.showResourceAccessError("texture",this._textureName),null):this._texture.getManagedTexture(t,e)},R.prototype.getTexturesOfTypes=function(t,e){return null===this._texture?(this.showResourceAccessError("texture",this._textureName),null):this._texture.getManagedTexturesOfTypes(t,e)},R.prototype.getTextures=function(t){return this.getTexturesOfTypes(this._texture.getTypes(),t)},R.prototype.getDefaultGroupLuminosity=function(t){return this._defaultLuminosityFactors[t]},v.prototype=new R,v.prototype.constructor=v,v.prototype._loadData=function(t){R.prototype._loadData.call(this,t),this._size=t?t.size||1:0,this._color=t?t.color||[1,1,1,1]:null,this._duration=t?t.duration:null},v.prototype.acquireResources=function(){R.prototype.acquireResources.call(this,{model:s.squareModel(ft)})},v.prototype.getSize=function(){return this._size},v.prototype.getColor=function(){return this._color},v.prototype.getDuration=function(){return this._duration},C.prototype=new E,C.prototype.constructor=C,C.prototype._loadData=function(t){var e,i;if(E.prototype._loadData.call(this,t),this._lightColor=t?t.lightColor||[1,1,1]:null,this._layers=[],t)if(t.layers)for(e=0;e<t.layers.length;e++)i=t.layers[e],i.name="-",this._layers.push(new v(i));else x(this,"layers")},C.prototype.acquireResources=function(){var t;for(t=0;t<this._layers.length;t++)this._layers[t].acquireResources()},C.prototype.getLightColor=function(){return this._lightColor},C.prototype.getLayers=function(){return this._layers},C.prototype.handleGraphicsSettingsChanged=function(){var t;for(E.prototype.handleGraphicsSettingsChanged.call(this),t=0;t<this._layers.length;t++)this._layers[t].handleGraphicsSettingsChanged()},I.prototype=new A,I.prototype.constructor=I,I.prototype._loadData=function(t){A.prototype._loadData.call(this,t),this._numberOfParticles=t?t.numberOfParticles||x(this,"numberOfParticles"):0,this._color=t?t.color||[1,1,1]:null,this._range=t?t.range||x(this,"range"):0},I.prototype.acquireResources=function(){A.prototype.acquireResources.call(this,{model:s.lineModel(mt,[1,1,1],[1,1,1,1])})},I.prototype.getNumberOfParticles=function(){return this._numberOfParticles*u.getDustParticleCountFactor()},I.prototype.getColor=function(){return this._color},I.prototype.getRange=function(){return this._range},L.prototype=new R,L.prototype.constructor=L,L.prototype._loadData=function(e){R.prototype._loadData.call(this,e),this._type=e?t.getSafeEnumValue(et,e.type,et.OMNIDIRECTIONAL):null,this._dimensions=e?e.dimensions||[0,0,0]:null,this._directionSpread=!e||this._type!==et.UNIDIRECTIONAL&&this._type!==et.PLANAR?0:e.directionSpread||0,this._velocity=e?e.velocity||0:0,this._velocitySpread=e?e.velocitySpread||0:0,this._initialNumber=e?e.initialNumber||0:0,this._spawnNumber=e?e.spawnNumber||0:0,this._spawnTime=e?e.spawnTime||1:0,this._duration=e?void 0!==e.duration?e.duration:1:0,this._particleStates=e?e.particleStates||[]:null},L.prototype.acquireResources=function(){R.prototype.acquireResources.call(this,{model:s.squareModel(ft)})},L.prototype.getType=function(){return this._type},L.prototype.getDimensions=function(){return this._dimensions},L.prototype.getDirectionSpread=function(){return this._directionSpread},L.prototype.getVelocity=function(){return this._velocity},L.prototype.getVelocitySpread=function(){return this._velocitySpread},L.prototype.getInitialNumber=function(){return this._initialNumber},L.prototype.getSpawnNumber=function(){return this._spawnNumber},L.prototype.getSpawnTime=function(){return this._spawnTime},L.prototype.getDuration=function(){return this._duration},L.prototype.getParticleStates=function(){return this._particleStates},N.prototype=new E,N.prototype.constructor=N,N.prototype._loadData=function(t){var e;if(E.prototype._loadData.call(this,t),this._particleEmitterDescriptors=null,t&&t.particleEmitters)for(this._particleEmitterDescriptors=[],e=0;e<t.particleEmitters.length;e++)t.particleEmitters[e].name="-",this._particleEmitterDescriptors.push(new L(t.particleEmitters[e]));this._lightStates=t?t.lightStates:null},N.prototype.acquireResources=function(){var t;for(t=0;t<this._particleEmitterDescriptors.length;t++)this._particleEmitterDescriptors[t].acquireResources()},N.prototype.getParticleEmitterDescriptors=function(){return this._particleEmitterDescriptors},N.prototype.getLightStates=function(){return this._lightStates},N.prototype.getTotalDuration=function(){var t,e,i,n,o=0;for(t=0;t<this._particleEmitterDescriptors.length;t++){for(i=this._particleEmitterDescriptors[t]._duration,n=this._particleEmitterDescriptors[t].getParticleStates(),e=0;e<n.length;e++)i+=n[e].timeToReach;i>o&&(o=i)}return o},N.prototype.isContinuous=function(){var t;for(t=0;t<this._particleEmitterDescriptors.length;t++)if(0===this._particleEmitterDescriptors[t]._duration)return!0;return!1},N.prototype.handleGraphicsSettingsChanged=function(){var t;for(E.prototype.handleGraphicsSettingsChanged.call(this),t=0;t<this._particleEmitterDescriptors.length;t++)this._particleEmitterDescriptors[t].handleGraphicsSettingsChanged()},w.prototype=new R,w.prototype.constructor=w,w.prototype._loadData=function(t){R.prototype._loadData.call(this,t),this._damage=t?t.damage||0:0,this._size=t?t.size||1:0,this._intersectionPositions=t?t.intersectionPositions||[]:null,this._width=t?t.width||1:0,this._mass=t?t.mass||x(this,"mass"):0,this._duration=t?t.duration||x(this,"duration"):0,this._muzzleFlash=null,t&&(t.muzzleFlash?(t.muzzleFlash.name="-",this._muzzleFlash=new v(t.muzzleFlash)):x(this,"muzzleFlash")),this._lightColor=t?t.lightColor||x(this,"lightColor"):null,this._lightIntensity=t?t.lightIntensity||x(this,"lightIntensity"):0,this._explosionClass=t?g(t.explosion||x(this,"explosion"))||o.crash():null},w.prototype.acquireResources=function(){R.prototype.acquireResources.call(this,{model:s.turningBillboardModel(yt+this.getName(),this._intersectionPositions,this._width)}),this._muzzleFlash.acquireResources(),this._explosionClass.acquireResources()},w.prototype.getDamage=function(){return this._damage},w.prototype.getSize=function(){return this._size},w.prototype.getMass=function(){return this._mass},w.prototype.getDuration=function(){return this._duration},w.prototype.getMuzzleFlash=function(){return this._muzzleFlash},w.prototype.getLightColor=function(){return this._lightColor},w.prototype.getLightIntensity=function(){return this._lightIntensity},w.prototype.getExplosionClass=function(){return this._explosionClass},w.prototype.handleGraphicsSettingsChanged=function(){R.prototype.handleGraphicsSettingsChanged.call(this),this._muzzleFlash.handleGraphicsSettingsChanged()},D.prototype.getProjectileClass=function(){return this._projectileClass},D.prototype.getProjectileVelocity=function(){return this._projectileVelocity},D.prototype.getForceForDuration=function(t){return this._projectileVelocity*this._projectileClass.getMass()/(t/1e3)},D.prototype.getPositionVector=function(){return this._positionVector},D.prototype.acquireResources=function(){this._projectileClass.acquireResources()},V.prototype=new R,V.prototype.constructor=V,V.prototype._loadData=function(e){var i;if(R.prototype._loadData.call(this,e),this._grade=e?e.grade||x(this,"grade"):0,this._cooldown=e?e.cooldown||x(this,"cooldown"):0,this._barrels=[],e)if(e.barrels)for(i=0;i<e.barrels.length;i++)this._barrels.push(new D(e.barrels[i]));else x(this,"barrels");if(this._attachmentPoint=e?e.attachmentPoint||x(this,"attachmentPoint"):null,this._rotationStyle=e?t.getSafeEnumValue(ot,e.rotationStyle,ot.NONE):null,this._fixed=this._rotationStyle===ot.NONE,this._basePoint=e&&!this._fixed?e.basePoint||x(this,"basePoint"):null,this._basePoint&&this._basePoint.push(1),this._rotators=[],e&&!this._fixed)if(e.rotators)for(i=0;i<e.rotators.length;i++)this._rotators.push(new F(e.rotators[i]));else x(this,"rotators")},V.prototype.acquireResources=function(t){var e;for(R.prototype.acquireResources.call(this,t),e=0;e<this._barrels.length;e++)this._barrels[e].acquireResources()},V.prototype.getGrade=function(){return this._grade},V.prototype.getCooldown=function(){return this._cooldown},V.prototype.getBarrel=function(t){return this._barrels[t]},V.prototype.getBarrels=function(){return this._barrels},V.prototype.getAttachmentPoint=function(){return this._attachmentPoint},V.prototype.getRotationStyle=function(){return this._rotationStyle},V.prototype.isFixed=function(){return this._fixed},V.prototype.getBasePoint=function(){return this._basePoint},V.prototype.getRotators=function(){return this._rotators},V.prototype.getProjectileClass=function(){return this._barrels[0].getProjectileClass()},V.prototype.getProjectileVelocity=function(){return this._barrels[0].getProjectileVelocity()},P.prototype=new E,P.prototype.constructor=P,P.prototype._loadData=function(t){var e;E.prototype._loadData.call(this,t),e=t?t.referenceMass||1:null,this._thrusterBurnParticle=new v(t),this._grade=t?t.grade||x(this,"grade"):0,this._thrust=t?e*t.thrust||x(this,"thrust"):0,this._angularThrust=t?e*Math.radians(t.angularThrust)||x(this,"angularThrust"):0,this._maxMoveBurnLevel=t?t.maxMoveBurnLevel||x(this,"maxMoveBurnLevel"):0,this._maxTurnBurnLevel=t?t.maxTurnBurnLevel||x(this,"maxTurnBurnLevel"):0},P.prototype.acquireResources=function(){this._thrusterBurnParticle.acquireResources()},P.prototype.getThrusterBurnParticle=function(){return this._thrusterBurnParticle},P.prototype.getGrade=function(){return this._grade},P.prototype.getThrust=function(){return this._thrust},P.prototype.getAngularThrust=function(){return this._angularThrust},P.prototype.getMaxMoveBurnLevel=function(){return this._maxMoveBurnLevel},P.prototype.getMaxTurnBurnLevel=function(){return this._maxTurnBurnLevel},P.prototype.handleGraphicsSettingsChanged=function(){E.prototype.handleGraphicsSettingsChanged.call(this),this._thrusterBurnParticle.handleGraphicsSettingsChanged()},U.prototype=new E,U.prototype.constructor=U,U.prototype._loadData=function(t){E.prototype._loadData.call(this,t),this._isFighterType=t?"boolean"==typeof t.isFighterType?t.isFighterType:x(this,"isFighterType"):!1,this._fullName=t?t.fullName||x(this,"fullName"):null,this._description=t?"string"==typeof t.description?t.description:x(this,"description"):null,this._goodAgainstTypeNames=t?t.goodAgainst||[]:null,this._badAgainstTypeNames=t?t.badAgainst||[]:null},U.prototype.isFighterType=function(){return this._isFighterType},U.prototype.getDisplayName=function(){return c.get(c.SPACECRAFT_TYPE.PREFIX,this.getName()+c.SPACECRAFT_TYPE.NAME_SUFFIX.name,this._fullName)},U.prototype.getDisplayDescription=function(){return c.get(c.SPACECRAFT_TYPE.PREFIX,this.getName()+c.SPACECRAFT_TYPE.DESCRIPTION_SUFFIX.name,t.formatString(c.get(c.DATABASE.MISSING_SPACECRAFT_TYPE_DESCRIPTION),{spacecraftType:this.getDisplayName(),originalDescription:this._description}))},U.prototype.getGoodAgainstTypes=function(){var t,e;for(e=[],t=0;t<this._goodAgainstTypeNames.length;t++)e.push(T(this._goodAgainstTypeNames[t]))},U.prototype.getBadAgainstTypes=function(){var t,e;for(e=[],t=0;t<this._badAgainstTypeNames.length;t++)e.push(T(this._badAgainstTypeNames[t]))},k.prototype.getName=function(){return this._name},k.prototype.getWeaponDescriptors=function(){return this._weaponDescriptors},k.prototype.getPropulsionDescriptor=function(){return this._propulsionDescriptor},z.prototype.getName=function(){return this._name},z.prototype.isFPS=function(){return this._fps},z.prototype.getFOV=function(){return this._fov},z.prototype.getFOVRange=function(){return this._fovRange},z.prototype.getSpan=function(){return this._span},z.prototype.getSpanRange=function(){return this._spanRange},z.prototype.isMovable=function(){return this._movable},z.prototype.isTurnable=function(){return this._turnable},z.prototype.getPositionMatrix=function(){return this._positionMatrix},z.prototype.getOrientationMatrix=function(){return this._orientationMatrix},z.prototype.getAlphaRange=function(){return this._alphaRange},z.prototype.getBetaRange=function(){return this._betaRange},z.prototype.getConfines=function(){return this._confines},z.prototype.resetsWhenLeavingConfines=function(){return this._resetsWhenLeavingConfines},z.prototype.getBaseOrientation=function(){return this._baseOrientation},z.prototype.getPointToFallback=function(){return this._pointToFallback},z.prototype.destroy=function(){this._fovRange=null,this._positionMatrix=null,this._orientationMatrix=null,this._alphaRange=null,this._betaRange=null,this._spanRange=null,this._confines=null},W.prototype=new z,W.prototype.constructor=W,W.prototype.isAimingView=function(){return this._isAimingView},W.prototype.turnsAroundObjects=function(){return this._rotationCenterIsObject},W.prototype.movesRelativeToObject=function(){return this._movesRelativeToObject},W.prototype.getPositionFollowedObjectsForObject=function(t){return this._followsPosition||this._startsWithRelativePosition?[t]:[]},W.prototype.startsWithRelativePosition=function(){return this._startsWithRelativePosition},W.prototype.getDistanceRange=function(){return this._distanceRange},W.prototype.pointsTowardsObjects=function(){return this._lookAtSelf||this._lookAtTarget},W.prototype.getOrientationFollowedObjectsForObject=function(t){return this._lookAtSelf||this._followsOrientation?[t]:[]},W.prototype.resetsOnFocusChange=function(){return this._resetsOnFocusChange},W.prototype.destroy=function(){z.prototype.destroy.call(this),this._distanceRange=null},q.prototype=new z,q.prototype.constructor=q,q.prototype.turnsAroundObjects=function(){return this._turnAroundAll},q.prototype.movesRelativeToObject=function(){return!1},q.prototype.getPositionFollowedObjectsForScene=function(t){return this._turnAroundAll||this._startsWithRelativePosition?t.getAll3DObjects():[]},q.prototype.startsWithRelativePosition=function(){return this._startsWithRelativePosition},q.prototype.getDistanceRange=function(){return this._distanceRange},q.prototype.pointsTowardsObjects=function(){return this._lookAtAll},q.prototype.getOrientationFollowedObjectsForScene=function(t){return this._lookAtAll?t.getAll3DObjects():[]},q.prototype.resetsOnFocusChange=function(){return!1},q.prototype.destroy=function(){z.prototype.destroy.call(this),this._distanceRange=null},Q.prototype.acquireResources=function(){this._particle.acquireResources()},Q.prototype.getParticle=function(){return this._particle},Q.prototype.getPosition=function(){return this._position},Q.prototype.getBlinks=function(){return this._blinks},Q.prototype.getPeriod=function(){return this._period},Q.prototype.getIntensity=function(){return this._intensity},Q.prototype.getLightColor=function(){return[this._particle.getColor()[0],this._particle.getColor()[1],this._particle.getColor()[2]]},Q.prototype.getParticleStates=function(){var t,e=0,i=[];if(this._blinks.length>0)for(this._blinks[0]>0&&(i.push(new l.ParticleState(this._particle.getColor(),0,0)),i.push(new l.ParticleState(this._particle.getColor(),0,this._blinks[0]))),t=0;t<this._blinks.length;t++)i.push(new l.ParticleState(this._particle.getColor(),this._particle.getSize(),0)),i.push(new l.ParticleState(this._particle.getColor(),0,this._particle._duration)),e=this._blinks[t]+this._particle._duration,i.push(new l.ParticleState(this._particle.getColor(),0,t<this._blinks.length-1?this._blinks[t+1]-e:this._period-e));return i},Q.prototype.getLightStates=function(){var t,e=0,i=[];if(this._blinks.length>0)for(this._blinks[0]>0&&(i.push({color:this.getLightColor(),intensity:0,timeToReach:0}),i.push({color:this.getLightColor(),intensity:0,timeToReach:this._blinks[0]})),t=0;t<this._blinks.length;t++)i.push({color:this.getLightColor(),intensity:this._intensity,timeToReach:0}),i.push({color:this.getLightColor(),intensity:0,timeToReach:this._particle._duration}),e=this._blinks[t]+this._particle._duration,i.push({color:this.getLightColor(),intensity:0,timeToReach:t<this._blinks.length-1?this._blinks[t+1]-e:this._period-e});return i},Q.prototype.handleGraphicsSettingsChanged=function(){this._particle.handleGraphicsSettingsChanged()},J.prototype=new R,J.prototype.constructor=J,J.prototype._overrideData=function(e,r){var s,h,l,u,c,_,p,d,f,m,y,S;switch(R.prototype._overrideData.call(this,e,r),this._spacecraftType=e?r.type?T(r.type):e._spacecraftType:T(r.type||x(this,"type")),this._fullName=e?r.fullName||e._fullName:r.fullName||x(this,"fullName"),this._description=e?r.description||e._description:r.description||x(this,"description"),this._showInDatabase=e?"boolean"==typeof r.showInDatabase?r.showInDatabase:e._showInDatabase:"boolean"==typeof r.showInDatabase?r.showInDatabase:x(this,"showInDatabase"),this._hitpoints=e?r.hitpoints||e._hitpoints:r.hitpoints||x(this,"hitpoints")||0,this._armor="number"==typeof r.armor?r.armor:e?e._armor:x(this,"armor")||0,this._factionColor=e?r.factionColor||e._factionColor:r.factionColor||x(this,"factionColor")||[0,0,0,0],this._turnStyle=r.turnStyle?t.getSafeEnumValue(rt,r.turnStyle,rt.YAW_PITCH):e?e._turnStyle:rt.YAW_PITCH,this._attackVector=r.attackVector?i.normal3(r.attackVector):e?e._attackVector:[0,1,0],this._attackVectorAngles=[0,0],this._turnStyle){case rt.YAW_PITCH:S=i.getYawAndPitch(this._attackVector),this._attackVectorAngles[0]=S.yaw,this._attackVectorAngles[1]=S.pitch;break;case rt.ROLL_YAW:S=i.getRollAndYaw(this._attackVector),this._attackVectorAngles[0]=S.roll,this._attackVectorAngles[1]=S.yaw;break;case rt.ROLL_PITCH:S=i.getRollAndPitch(this._attackVector),this._attackVectorAngles[0]=S.roll,this._attackVectorAngles[1]=S.pitch;break;default:o.crash()}if(this._attackThresholdAngle=Math.radians(r.attackThresholdAngle)||(e?e._attackThresholdAngle:0),this._mass=e?r.mass||e._mass:r.mass||x(this,"mass"),this._bodies=e&&!r.bodies?e._bodies:[],r.bodies)for(s=0;s<r.bodies.length;s++)this._bodies.push(new a.Body(n.translation4v(r.bodies[s].position||x(this,"bodies[i].position")),n.rotation4FromJSON(r.bodies[s].rotations),r.bodies[s].size));else e||x(this,"bodies");if(this._weaponSlots=e&&!r.weaponSlots?e._weaponSlots:[],r.weaponSlots)for(s=0;s<r.weaponSlots.length;s++)if(r.weaponSlots[s].array)for(l=r.weaponSlots[s].startPosition||x(this,"weaponSlot array startPosition"),u=r.weaponSlots[s].translationVector||x(this,"weaponSlot array translationVector"),c=r.weaponSlots[s].rotations,_=r.weaponSlots[s].maxGrade||x(this,"weaponSlot array maxGrade"),p=r.weaponSlots[s].count||x(this,"weaponSlot array count"),h=0;p>h;h++)this._weaponSlots.push(new B({position:i.sum3(l,i.scaled3(u,h)),rotations:c,maxGrade:_}));else this._weaponSlots.push(new B(r.weaponSlots[s]));if(this._maxPropulsionGrade=e?r.maxPropulsionGrade||e._maxPropulsionGrade:r.maxPropulsionGrade||x(this,"maxPropulsionGrade"),this._thrusterSlots=e&&!r.thrusterSlots?e._thrusterSlots:[],r.thrusterSlots)for(s=0;s<r.thrusterSlots.length;s++){if(d=r.thrusterSlots[s].group,f=r.thrusterSlots[s].uses,r.thrusterSlots[s].array)for(l=r.thrusterSlots[s].startPosition||x(this,"thrusterSlot array startPosition"),u=r.thrusterSlots[s].translationVector||x(this,"thrusterSlot array translationVector"),m=r.thrusterSlots[s].size||x(this,"thrusterSlot array size"),p=r.thrusterSlots[s].count||x(this,"thrusterSlot array count"),h=0;p>h;h++)this._thrusterSlots.push(new G({position:i.sum3(l,i.scaled3(u,h)),size:m,groupIndex:d,uses:f}));if(r.thrusterSlots[s].thrusters)for(h=0;h<r.thrusterSlots[s].thrusters.length;h++)y=r.thrusterSlots[s].thrusters[h],y.groupIndex=d,y.uses=f,this._thrusterSlots.push(new G(y))}if(this._views=e&&!r.views?e._views:[],r.views)for(s=0;s<r.views.length;s++)this._views.push(new W(r.views[s]));else e||x(this,"views");if(this._equipmentProfiles=e&&!r.equipmentProfiles?e._equipmentProfiles:{},r.equipmentProfiles)for(s=0;s<r.equipmentProfiles.length;s++)this._equipmentProfiles[r.equipmentProfiles[s].name]=new k(r.equipmentProfiles[s]);if(this._explosionClass=e?r.explosion?g(r.explosion):e._explosionClass:g(r.explosion||x(this,"explosion")),this._showTimeRatioDuringExplosion=e?r.showTimeRatioDuringExplosion||e._showTimeRatioDuringExplosion:r.showTimeRatioDuringExplosion||x(this,"showTimeRatioDuringExplosion"),
this._damageIndicators=e&&!r.damageIndicators?e._damageIndicators:[],r.damageIndicators)for(s=0;s<r.damageIndicators.length;s++)this._damageIndicators.push(new X(r.damageIndicators[s]));else e||x(this,"damageIndicators");if(this._lightSources=e&&!r.lights?e._lightSources:[],r.lights)for(s=0;s<r.lights.length;s++)this._lightSources.push(new Y(r.lights[s]));else e||x(this,"lights");if(this._blinkers=e&&!r.blinkers?e._blinkers:[],r.blinkers)for(s=0;s<r.blinkers.length;s++)this._blinkers.push(new Q(r.blinkers[s]));else e||x(this,"blinkers")},J.prototype._loadData=function(t){var e;t.basedOn?(e=S(t.basedOn),e.executeWhenReady(function(){this._overrideData(e,t)}.bind(this))):this._overrideData(null,t)},J.prototype.getSpacecraftType=function(){return this._spacecraftType},J.prototype.isFighterClass=function(){return this._spacecraftType.isFighterType()},J.prototype.getDisplayName=function(){return c.get(c.SPACECRAFT_CLASS.PREFIX,this.getName()+c.SPACECRAFT_CLASS.NAME_SUFFIX.name,this._fullName)},J.prototype.getDisplayDescription=function(){return c.get(c.SPACECRAFT_CLASS.PREFIX,this.getName()+c.SPACECRAFT_CLASS.DESCRIPTION_SUFFIX.name,t.formatString(c.get(c.DATABASE.MISSING_SPACECRAFT_CLASS_DESCRIPTION),{spacecraftClass:this.getDisplayName(),originalDescription:this._description}))},J.prototype.shouldShowInDatabase=function(){return this._showInDatabase},J.prototype.getHitpoints=function(){return this._hitpoints},J.prototype.getArmor=function(){return this._armor},J.prototype.getFactionColor=function(){return this._factionColor},J.prototype.getTurnStyle=function(){return this._turnStyle},J.prototype.getAttackVector=function(){return this._attackVector},J.prototype.getAttackVectorAngles=function(){return this._attackVectorAngles},J.prototype.getAttackThresholdAngle=function(){return this._attackThresholdAngle},J.prototype.getMass=function(){return this._mass},J.prototype.getBodies=function(){return this._bodies},J.prototype.getWeaponSlots=function(){return this._weaponSlots},J.prototype.getThrusterSlots=function(){return this._thrusterSlots},J.prototype.getEquipmentProfile=function(t){return this._equipmentProfiles[t]},J.prototype.getViews=function(){return this._views},J.prototype.getView=function(t){var e;for(e=0;e<this._views.length;e++)if(this._views[e].getName()===t)return this._views[e];return null},J.prototype.getExplosionClass=function(){return this._explosionClass},J.prototype.getShowTimeRatioDuringExplosion=function(){return this._showTimeRatioDuringExplosion},J.prototype.getDamageIndicators=function(){return this._damageIndicators},J.prototype.getLightSources=function(){return this._lightSources},J.prototype.getBlinkers=function(){return this._blinkers},J.prototype.acquireResources=function(t){var e;for(R.prototype.acquireResources.call(this,t),this._explosionClass.acquireResources(),e=0;e<this._damageIndicators.length;e++)this._damageIndicators[e].explosionClass.acquireResources();for(e=0;e<this._blinkers.length;e++)this._blinkers[e].acquireResources()},J.prototype.handleGraphicsSettingsChanged=function(){var t;for(R.prototype.handleGraphicsSettingsChanged.call(this),t=0;t<this._blinkers.length;t++)this._blinkers[t].handleGraphicsSettingsChanged()},$=new r.ResourceManager,{ParticleEmitterType:et,WeaponRotationStyle:ot,SpacecraftTurnStyle:rt,TexturedModelClass:R,getSkyboxClass:_,getBackgroundObjectClass:p,getDustCloudClass:d,getExplosionClass:g,getProjectileClass:f,getWeaponClass:m,getPropulsionClass:y,getSpacecraftType:T,getSpacecraftClass:S,getSpacecraftClassesInArray:M,EquipmentProfile:k,SceneView:q,requestLoad:K,handleGraphicsSettingsChanged:Z}}),define("armada/configuration",["utils/utils","utils/types","modules/async-resource","modules/buda-scene","armada/classes"],function(t,e,i,n,o){"use strict";function r(){i.AsyncResource.call(this),this._configuration=null,this._settings=null}var s,a,h,l,u,c,_={};return _.FILE_DESCRIPTOR={baseType:"object",properties:{FILENAME:{name:"filename",type:"string"},FOLDER:{name:"folder",type:"string"}}},_.LIGHT_SOURCE={baseType:"object",properties:{COLOR:{name:"color",type:e.COLOR3},DIRECTION:{name:"direction",type:e.VECTOR3}}},_.LAYOUT_DESCRIPTOR={baseType:"object",properties:{LEFT:{name:"left",type:"number",optional:!0},CENTER_X:{name:"centerX",type:"number",optional:!0},RIGHT:{name:"right",type:"number",optional:!0},TOP:{name:"top",type:"number",optional:!0},CENTER_Y:{name:"centerY",type:"number",optional:!0},BOTTOM:{name:"bottom",type:"number",optional:!0},WIDTH:{name:"width",type:"number",optional:!0},HEIGHT:{name:"height",type:"number",optional:!0},SCALE_MODE:{name:"scaleMode",type:"enum",values:t.ScaleMode},X_SCALE_MODE:{name:"xScaleMode",type:"enum",values:t.ScaleMode,optional:!0},Y_SCALE_MODE:{name:"yScaleMode",type:"enum",values:t.ScaleMode,optional:!0}}},s={CLASSES_SOURCE_FILE:{name:"classes",type:_.FILE_DESCRIPTOR},ENVIRONMENTS_SOURCE_FILE:{name:"environments",type:_.FILE_DESCRIPTOR},LEVEL_FILES:{name:"levels",type:{baseType:"object",properties:{FOLDER:{name:"folder",type:"string"},FILENAMES:{name:"filenames",type:"array",elementType:"string"}}}}},a={USE_REQUEST_ANIM_FRAME:{name:"useRequestAnimFrame",type:"boolean",defaultValue:!0},DEFAULT_RANDOM_SEED:{name:"defaultRandomSeed",type:"number",defaultValue:4718},UNIFORM_LUMINOSITY_FACTORS_ARRAY_NAME:{name:"luminosityFactorsArrayName",type:"string",defaultValue:"luminosityFactors"},UNIFORM_GROUP_TRANSFORMS_ARRAY_NAME:{name:"groupTransformsArrayName",type:"string",defaultValue:"groupTransforms"},USE_VERTICAL_CAMERA_VALUES:{name:"useVerticalCameraValues",type:"boolean",defaultValue:!0}},h={SHOW_LOADING_BOX_FIRST_TIME:{name:"showLoadingBoxFirstTime",type:"boolean",defaultValue:!0},SHOW_LOADING_BOX_ON_ITEM_CHANGE:{name:"showLoadingBoxOnItemChange",type:"boolean",defaultValue:!0},BACKGROUND_COLOR:{name:"backgroundColor",type:e.COLOR4,defaultValue:[0,0,0,0]},ITEM_VIEW_DISTANCE:{name:"itemViewDistance",type:"number",defaultValue:2e3},ITEM_VIEW_FOV:{name:"itemViewFOV",type:"number",defaultValue:60},ITEM_VIEW_SPAN:{name:"itemViewSpan",type:"number",defaultValue:.2},SHOW_WIREFRAME_MODEL:{name:"showWireframeModel",type:"boolean",defaultValue:!0},WIREFRAME_SHADER_NAME:{name:"wireframeShaderName",type:"string",defaultValue:"oneColorReveal"},WIREFRAME_COLOR:{name:"wireframeColor",type:e.COLOR4,defaultValue:[1,0,0,1]},SHOW_SOLID_MODEL:{name:"showSolidModel",type:"boolean",defaultValue:!0},SOLID_SHADER_NAME:{name:"solidShaderName",type:"string",defaultValue:"shadowMapReveal"},LIGHT_SOURCES:{name:"lightSources",type:"array",elementType:_.LIGHT_SOURCE,minLength:1,maxLength:2},EQUIPMENT_PROFILE_NAME:{name:"equipmentProfileName",type:"string",defaultValue:"default"},START_SIZE_FACTOR:{name:"startSizeFactor",type:"number",defaultValue:"1"},MIN_SIZE_FACTOR:{name:"minimumSizeFactor",type:"number",defaultValue:"0.9"},MAX_SIZE_FACTOR:{name:"maximumSizeFactor",type:"number",defaultValue:"1.6"},MODEL_AUTO_ROTATION:{name:"modelAutoRotation",type:"boolean",defaultValue:!0},MODEL_MOUSE_ROTATION:{name:"modelMouseRotation",type:"boolean",defaultValue:!0},ROTATION_FPS:{name:"rotationFPS",type:"number",defaultValue:60},ROTATION_REVEAL_START_ANGLE:{name:"rotationRevealStartAngle",type:e.ANGLE_DEGREES,defaultValue:90},ROTATION_START_ANGLE:{name:"rotationStartAngle",type:e.ANGLE_DEGREES,defaultValue:180},ROTATION_VIEW_ANGLE:{name:"rotationViewAngle",type:e.ANGLE_DEGREES,defaultValue:60},ROTATION_DURATION:{name:"rotationDuration",type:"number",defaultValue:4e3},ROTATION_MOUSE_SENSITIVITY:{name:"rotationMouseSensitivity",type:"number",defaultValue:1},MODEL_REVEAL_ANIMATION:{name:"modelRevealAnimation",type:"boolean",defaultValue:!0},REVEAL_COLOR:{name:"revealColor",type:e.COLOR4,defaultValue:[1,1,1,1]},REVEAL_FPS:{name:"revealFPS",type:"number",defaultValue:60},REVEAL_DURATION:{name:"revealDuration",type:e.DURATION,defaultValue:2e3},REVEAL_SOLID_DELAY_DURATION:{name:"revealSolidDelayDuration",type:e.DURATION,defaultValue:2e3},REVEAL_TRANSITION_LENGTH_FACTOR:{name:"revealTransitionLengthFactor",type:"number",defaultValue:.15},RENDER_FPS:{name:"databaseRenderFPS",type:"number",defaultValue:60}},l={RENDER_FPS:{name:"battleRenderFPS",type:"number",defaultValue:60},SIMULATION_STEPS_PER_SECOND:{name:"simulationStepsPerSecond",type:"number",defaultValue:60},MINIMUM_DUST_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumDustParticleCountForInstancing",type:"number",defaultValue:1},MINIMUM_EXPLOSION_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumExplosionParticleCountForInstancing",type:"number",defaultValue:1},MINIMUM_MUZZLE_FLASH_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumMuzzleFlashParticleCountForInstancing",type:"number",defaultValue:1},MINIMUM_PROJECTILE_COUNT_FOR_INSTANCING:{name:"minimumProjectileCountForInstancing",type:"number",defaultValue:1},MINIMUM_THRUSTER_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumThrusterParticleCountForInstancing",type:"number",defaultValue:1},MINIMUM_BLINKER_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumBlinkerParticleCountForInstancing",type:"number",defaultValue:1},VIEW_DISTANCE:{name:"viewDistance",type:"number",defaultValue:5e3},MOVE_TO_ORIGO_DISTANCE:{name:"moveToOrigoDistance",type:"number"},CAMERA_DEFAULT_TRANSITION_DURATION:{name:"cameraDefaultTransitionDuration",type:"number",defaultValue:1e3},CAMERA_DEFAULT_TRANSITION_STYLE:{name:"cameraDefaultTransitionStyle",type:"enum",values:n.Camera.prototype.TransitionStyle,defaultValue:n.Camera.prototype.TransitionStyle.SMOOTH},CAMERA_PILOTING_SWITCH_TRANSITION_DURATION:{name:"cameraPilotingSwitchTransitionDuration",type:"number",defaultValue:1e3},CAMERA_PILOTING_SWITCH_TRANSITION_STYLE:{name:"cameraPilotingSwitchTransitionStyle",type:"enum",values:n.Camera.prototype.TransitionStyle,defaultValue:n.Camera.prototype.TransitionStyle.SMOOTH},MOMENT_DURATION:{name:"momentDuration",type:e.DURATION,defaultValue:1},BACKGROUND_OBJECT_DISTANCE:{name:"backgroundObjectDistance",type:"number",defaultValue:4500},TURN_ACCELERATION_DURATION_S:{name:"turnAccelerationDurationInSeconds",type:e.DURATION},COMPENSATED_FORWARD_SPEED_FACTOR:{name:"compensatedForwardSpeedFactor",type:"number"},COMPENSATED_REVERSE_SPEED_FACTOR:{name:"compensatedReverseSpeedFactor",type:"number"},STRAFE_SPEED_FACTOR:{name:"strafeSpeedFactor",type:"number"},DEFAULT_MUZZLE_FLASH_DURATION:{name:"defaultMuzzleFlashDuration",type:e.DURATION,defaultValue:500},SELF_FIRE:{name:"selfFire",type:"boolean",defaultValue:!0},DEFAULT_EQUIPMENT_PROFILE_NAME:{name:"defaultEquipmentProfileName",type:"string",defaultValue:"default"},HITBOX_COLOR:{name:"hitboxColor",type:e.COLOR4,defaultValue:[0,.5,.5,.5]},HITBOX_TEXTURE_NAME:{name:"hitboxTexture",type:"string",defaultValue:"white"},HITBOX_SHADER_NAME:{name:"hitboxShader",type:"string",defaultValue:"oneColor"},SHOW_HITBOXES_FOR_HITCHECKS:{name:"showHitboxesForHitchecks",type:"boolean"},TARGET_VIEW_NAME:{name:"targetViewName",type:"string",defaultValue:"target"},TARGET_CHANGE_TRANSITION_DURATION:{name:"targetChangeTransitonDuration",type:e.DURATION,defaultValue:300},TARGET_CHANGE_TRANSITION_STYLE:{name:"targetChangeTransitionStyle",type:"enum",values:n.Camera.prototype.TransitionStyle},GAME_STATE_DISPLAY_DELAY:{name:"gameStateDisplayDelay",type:"number"},HUD_CENTER_CROSSHAIR_TEXTURE:{name:"hudCenterCrosshairTexture",type:"string"},HUD_CENTER_CROSSHAIR_SIZE:{name:"hudCenterCrosshairSize",type:e.VECTOR2},HUD_CENTER_CROSSHAIR_SCALE_MODE:{name:"hudCenterCrosshairScaleMode",type:"enum",values:t.ScaleMode},HUD_CENTER_CROSSHAIR_COLOR:{name:"hudCenterCrosshairColor",type:e.COLOR4},HUD_CURSOR_STILL_TEXTURE:{name:"hudCursorStillTexture",type:"string"},HUD_CURSOR_TURN_TEXTURE:{name:"hudCursorTurnTexture",type:"string"},HUD_CURSOR_SIZE:{name:"hudCursorSize",type:e.VECTOR2},HUD_CURSOR_SCALE_MODE:{name:"hudCursorScaleMode",type:"enum",values:t.ScaleMode},HUD_CURSOR_COLOR:{name:"hudCursorColor",type:e.COLOR4},HUD_TARGET_ARROW_TEXTURE:{name:"hudTargetArrowTexture",type:"string"},HUD_TARGET_ARROW_POSITION_RADIUS:{name:"hudTargetArrowPositionRadius",type:"number"},HUD_TARGET_ARROW_SIZE:{name:"hudTargetArrowSize",type:e.VECTOR2},HUD_TARGET_ARROW_SCALE_MODE:{name:"hudTargetArrowScaleMode",type:"enum",values:t.ScaleMode},HUD_TARGET_ARROW_HOSTILE_COLOR:{name:"hudTargetArrowHostileColor",type:e.COLOR4},HUD_TARGET_ARROW_FRIENDLY_COLOR:{name:"hudTargetArrowFriendlyColor",type:e.COLOR4},HUD_TARGET_INDICATOR_TEXTURE:{name:"hudTargetIndicatorTexture",type:"string"},HUD_TARGET_INDICATOR_SIZE:{name:"hudTargetIndicatorSize",type:e.VECTOR2},HUD_TARGET_INDICATOR_SCALE_MODE:{name:"hudTargetIndicatorScaleMode",type:"enum",values:t.ScaleMode},HUD_TARGET_INDICATOR_HOSTILE_COLOR:{name:"hudTargetIndicatorHostileColor",type:e.COLOR4},HUD_TARGET_INDICATOR_FRIENDLY_COLOR:{name:"hudTargetIndicatorFriendlyColor",type:e.COLOR4},HUD_AIM_ASSIST_INDICATOR_TEXTURE:{name:"hudAimAssistIndicatorTexture",type:"string"},HUD_AIM_ASSIST_INDICATOR_SIZE:{name:"hudAimAssistIndicatorSize",type:e.VECTOR2},HUD_AIM_ASSIST_INDICATOR_SCALE_MODE:{name:"hudAimAssistIndicatorScaleMode",type:"enum",values:t.ScaleMode},HUD_AIM_ASSIST_INDICATOR_HOSTILE_COLOR:{name:"hudAimAssistIndicatorHostileColor",type:e.COLOR4},HUD_AIM_ASSIST_INDICATOR_FRIENDLY_COLOR:{name:"hudAimAssistIndicatorFriendlyColor",type:e.COLOR4},HUD_WEAPON_IMPACT_INDICATOR_TEXTURE:{name:"hudWeaponImpactIndicatorTexture",type:"string"},HUD_WEAPON_IMPACT_INDICATOR_SIZE:{name:"hudWeaponImpactIndicatorSize",type:e.VECTOR2},HUD_WEAPON_IMPACT_INDICATOR_SCALE_MODE:{name:"hudWeaponImpactIndicatorScaleMode",type:"enum",values:t.ScaleMode},HUD_WEAPON_IMPACT_INDICATOR_COLOR:{name:"hudWeaponImpactIndicatorColor",type:e.COLOR4},HUD_WEAPON_IMPACT_INDICATOR_OUT_OF_RANGE_COLOR:{name:"hudWeaponImpactIndicatorOutOfRangeColor",type:e.COLOR4},HUD_TARGET_VIEW_LAYOUT:{name:"hudTargetViewLayout",type:_.LAYOUT_DESCRIPTOR},HUD_TARGET_VIEW_VIEW_DISTANCE:{name:"hudTargetViewViewDistance",type:"number"},HUD_TARGET_VIEW_FOV:{name:"hudTargetViewFOV",type:"number"},HUD_TARGET_VIEW_TARGET_ITEM_SHADER:{name:"hudTargetViewTargetItemShader",type:"string"},HUD_TARGET_VIEW_TARGET_ITEM_FULL_INTEGRITY_COLOR:{name:"hudTargetViewTargetItemFullIntegrityColor",type:e.COLOR4},HUD_TARGET_VIEW_TARGET_ITEM_HALF_INTEGRITY_COLOR:{name:"hudTargetViewTargetItemHalfIntegrityColor",type:e.COLOR4},HUD_TARGET_VIEW_TARGET_ITEM_ZERO_INTEGRITY_COLOR:{name:"hudTargetViewTargetItemZeroIntegrityColor",type:e.COLOR4},HUD_TARGET_INFO_BACKGROUND_TEXTURE:{name:"hudTargetInfoBackgroundTexture",type:"string"},HUD_TARGET_INFO_BACKGROUND_LAYOUT:{name:"hudTargetInfoBackgroundLayout",type:_.LAYOUT_DESCRIPTOR},HUD_TARGET_INFO_BACKGROUND_COLOR:{name:"hudTargetInfoBackgroundColor",type:e.COLOR4},HUD_TARGET_HULL_INTEGRITY_BAR_TEXTURE:{name:"hudTargetHullIntegrityBarTexture",type:"string"},HUD_TARGET_HULL_INTEGRITY_BAR_LAYOUT:{name:"hudTargetHullIntegrityBarLayout",type:_.LAYOUT_DESCRIPTOR},HUD_TARGET_HULL_INTEGRITY_BAR_FILLED_COLOR:{name:"hudTargetHullIntegrityBarFilledColor",type:e.COLOR4},HUD_TARGET_HULL_INTEGRITY_BAR_EMPTY_COLOR:{name:"hudTargetHullIntegrityBarEmptyColor",type:e.COLOR4},HUD_TARGET_INFO_TEXT_LAYER_LAYOUT:{name:"hudTargetInfoTextLayerLayout",type:_.LAYOUT_DESCRIPTOR},HUD_TARGET_INFO_TEXT_HOSTILE_COLOR:{name:"hudTargetInfoTextHostileColor",type:e.COLOR4},HUD_TARGET_INFO_TEXT_FRIENDLY_COLOR:{name:"hudTargetInfoTextFriendlyColor",type:e.COLOR4},HUD_TARGET_INFO_TEXT_FONT_SIZE:{name:"hudTargetInfoTextFontSize",type:"number"},HUD_TARGET_INFO_TEXT_FONT_NAME:{name:"hudTargetInfoTextFontName",type:"string"},HUD_TARGET_INFO_NAME_TEXT_POSITION:{name:"hudTargetInfoNameTextPosition",type:e.VECTOR2},HUD_TARGET_INFO_CLASS_TEXT_POSITION:{name:"hudTargetInfoClassTextPosition",type:e.VECTOR2},HUD_TARGET_INFO_TEAM_TEXT_POSITION:{name:"hudTargetInfoTeamTextPosition",type:e.VECTOR2},HUD_TARGET_INFO_DISTANCE_TEXT_POSITION:{name:"hudTargetInfoDistanceTextPosition",type:e.VECTOR2},HUD_TARGET_INFO_VELOCITY_TEXT_POSITION:{name:"hudTargetInfoVelocityTextPosition",type:e.VECTOR2},HUD_SPEED_BAR_TEXTURE:{name:"hudSpeedBarTexture",type:"string"},HUD_SPEED_BAR_LAYOUT:{name:"hudSpeedBarLayout",type:_.LAYOUT_DESCRIPTOR},HUD_SPEED_BAR_FILLED_COLOR:{name:"hudSpeedBarFilledColor",type:e.COLOR4},HUD_SPEED_BAR_EMPTY_COLOR:{name:"hudSpeedBarEmptyColor",type:e.COLOR4},HUD_REVERSE_SPEED_BAR_FILLED_COLOR:{name:"hudReverseSpeedBarFilledColor",type:e.COLOR4},HUD_REVERSE_SPEED_BAR_EMPTY_COLOR:{name:"hudReverseSpeedBarEmptyColor",type:e.COLOR4},HUD_SPEED_BAR_BASE_MAX_SPEED_FACTOR:{name:"hudSpeedBarBaseMaxSpeedFactor",type:"number"},HUD_SPEED_BAR_DEFAULT_BASE_MAX_SPEED:{name:"hudSpeedBarDefaultBaseMaxSpeed",type:"number"},HUD_SPEED_BAR_MAX_SPEED_STEP_FACTOR:{name:"hudSpeedBarMaxSpeedStepFactor",type:"number"},HUD_SPEED_TEXT_LAYER_LAYOUT:{name:"hudSpeedTextLayerLayout",type:_.LAYOUT_DESCRIPTOR},HUD_SPEED_TEXT_COLOR:{name:"hudSpeedTextColor",type:e.COLOR4},HUD_REVERSE_SPEED_TEXT_COLOR:{name:"hudReverseSpeedTextColor",type:e.COLOR4},HUD_SPEED_TEXT_FONT_SIZE:{name:"hudSpeedTextFontSize",type:"number"},HUD_SPEED_TEXT_FONT_NAME:{name:"hudSpeedTextFontName",type:"string"},HUD_MAX_SPEED_TEXT_POSITION:{name:"hudMaxSpeedTextPosition",type:e.VECTOR2},HUD_MAX_REVERSE_SPEED_TEXT_POSITION:{name:"hudMaxReverseSpeedTextPosition",type:e.VECTOR2},HUD_SPEED_TARGET_INDICATOR_TEXTURE:{name:"hudSpeedTargetIndicatorTexture",type:"string"},HUD_SPEED_TARGET_INDICATOR_COLOR:{name:"hudSpeedTargetIndicatorColor",type:e.COLOR4},HUD_SPEED_TARGET_INDICATOR_SIZE:{name:"hudSpeedTargetIndicatorSize",type:e.VECTOR2},HUD_HULL_INTEGRITY_BAR_BACKGROUND_TEXTURE:{name:"hudHullIntegrityBarBackgroundTexture",type:"string"},HUD_HULL_INTEGRITY_BAR_BACKGROUND_LAYOUT:{name:"hudHullIntegrityBarBackgroundLayout",type:_.LAYOUT_DESCRIPTOR},HUD_HULL_INTEGRITY_BAR_BACKGROUND_COLOR:{name:"hudHullIntegrityBarBackgroundColor",type:e.COLOR4},HUD_HULL_INTEGRITY_BAR_TEXTURE:{name:"hudHullIntegrityBarTexture",type:"string"},HUD_HULL_INTEGRITY_BAR_LAYOUT:{name:"hudHullIntegrityBarLayout",type:_.LAYOUT_DESCRIPTOR},HUD_HULL_INTEGRITY_BAR_FILLED_COLOR:{name:"hudHullIntegrityBarFilledColor",type:e.COLOR4},HUD_HULL_INTEGRITY_BAR_EMPTY_COLOR:{name:"hudHullIntegrityBarEmptyColor",type:e.COLOR4},HUD_FLIGHT_MODE_INDICATOR_BACKGROUND_TEXTURE:{name:"hudFlightModeIndicatorBackgroundTexture",type:"string"},HUD_FLIGHT_MODE_INDICATOR_BACKGROUND_LAYOUT:{name:"hudFlightModeIndicatorBackgroundLayout",type:_.LAYOUT_DESCRIPTOR},HUD_FLIGHT_MODE_INDICATOR_BACKGROUND_COLOR:{name:"hudFlightModeIndicatorBackgroundColor",type:e.COLOR4},HUD_FLIGHT_MODE_HEADER_TEXT_COLOR:{name:"hudFlightModeHeaderTextColor",type:e.COLOR4},HUD_FLIGHT_MODE_HEADER_TEXT_FONT_SIZE:{name:"hudFlightModeHeaderTextFontSize",type:"number"},HUD_FLIGHT_MODE_HEADER_TEXT_FONT_NAME:{name:"hudFlightModeHeaderTextFontName",type:"string"},HUD_FLIGHT_MODE_HEADER_TEXT_POSITION:{name:"hudFlightModeHeaderTextPosition",type:e.VECTOR2},HUD_FREE_FLIGHT_MODE_TEXT_COLOR:{name:"hudFreeFlightModeTextColor",type:e.COLOR4},HUD_COMPENSATED_FLIGHT_MODE_TEXT_COLOR:{name:"hudCompensatedFlightModeTextColor",type:e.COLOR4},HUD_RESTRICTED_FLIGHT_MODE_TEXT_COLOR:{name:"hudRestrictedFlightModeTextColor",type:e.COLOR4},HUD_FLIGHT_MODE_TEXT_FONT_SIZE:{name:"hudFlightModeTextFontSize",type:"number"},HUD_FLIGHT_MODE_TEXT_FONT_NAME:{name:"hudFlightModeTextFontName",type:"string"},HUD_FLIGHT_MODE_TEXT_POSITION:{name:"hudFlightModeTextPosition",type:e.VECTOR2},HUD_DRIFT_ARROW_TEXTURE:{name:"hudDriftArrowTexture",type:"string"},HUD_DRIFT_ARROW_POSITION_RADIUS:{name:"hudDriftArrowPositionRadius",type:"number"},HUD_DRIFT_ARROW_SIZE:{name:"hudDriftArrowSize",type:e.VECTOR2},HUD_DRIFT_ARROW_SCALE_MODE:{name:"hudDriftArrowScaleMode",type:"enum",values:t.ScaleMode},HUD_DRIFT_ARROW_MIN_SPEED_COLOR:{name:"hudDriftArrowMinSpeedColor",type:e.COLOR4},HUD_DRIFT_ARROW_MAX_SPEED_COLOR:{name:"hudDriftArrowMaxSpeedColor",type:e.COLOR4},HUD_DRIFT_ARROW_MIN_SPEED:{name:"hudDriftArrowMinSpeed",type:"number"},HUD_DRIFT_ARROW_MAX_SPEED_FACTOR:{name:"hudDriftArrowMaxSpeedFactor",type:"number"},HUD_TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR_TEXTURE:{name:"hudTargetHullIntegrityQuickViewBarTexture",type:"string"},HUD_TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR_LAYOUT:{name:"hudTargetHullIntegrityQuickViewBarLayout",type:_.LAYOUT_DESCRIPTOR},HUD_TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR_HOSTILE_FILLED_COLOR:{name:"hudTargetHullIntegrityQuickViewBarHostileFilledColor",type:e.COLOR4},HUD_TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR_HOSTILE_EMPTY_COLOR:{name:"hudTargetHullIntegrityQuickViewBarHostileEmptyColor",type:e.COLOR4},HUD_TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR_FRIENDLY_FILLED_COLOR:{name:"hudTargetHullIntegrityQuickViewBarFriendlyFilledColor",type:e.COLOR4},HUD_TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR_FRIENDLY_EMPTY_COLOR:{name:"hudTargetHullIntegrityQuickViewBarFriendlyEmptyColor",type:e.COLOR4},HUD_HEADER_TEXT_LAYER_LAYOUT:{name:"hudHeaderTextLayerLayout",type:_.LAYOUT_DESCRIPTOR},HUD_SMALL_HEADER_TEXT_COLOR:{name:"hudSmallHeaderTextColor",type:e.COLOR4},HUD_SMALL_HEADER_TEXT_FONT_SIZE:{name:"hudSmallHeaderTextFontSize",type:"number"},HUD_SMALL_HEADER_TEXT_FONT_NAME:{name:"hudSmallHeaderTextFontName",type:"string"},HUD_SMALL_HEADER_TEXT_POSITION:{name:"hudSmallHeaderTextPosition",type:e.VECTOR2},HUD_BIG_HEADER_TEXT_COLOR:{name:"hudBigHeaderTextColor",type:e.COLOR4},HUD_BIG_HEADER_TEXT_FONT_SIZE:{name:"hudBigHeaderTextFontSize",type:"number"},HUD_BIG_HEADER_TEXT_FONT_NAME:{name:"hudBigHeaderTextFontName",type:"string"},HUD_BIG_HEADER_TEXT_POSITION:{name:"hudBigHeaderTextPosition",type:e.VECTOR2},HUD_SUBHEADER_TEXT_COLOR:{name:"hudSubheaderTextColor",type:e.COLOR4},HUD_SUBHEADER_TEXT_FONT_SIZE:{name:"hudSubheaderTextFontSize",type:"number"},HUD_SUBHEADER_TEXT_FONT_NAME:{name:"hudSubheaderTextFontName",type:"string"},HUD_SUBHEADER_TEXT_POSITION:{name:"hudSubheaderTextPosition",type:e.VECTOR2},DEMO_FIGHTER_AI_TYPE:{name:"demoFighterAI",type:"string"},DEMO_SHIP_AI_TYPE:{name:"demoShipAI",type:"string"},DEMO_VIEW_SWITCH_INTERVAL:{name:"demoViewSwitchInterval",type:"number"},DEMO_DOUBLE_VIEW_SWITCH_CHANCE:{name:"demoDoubleViewSwitchChance",type:"number"}},u={DEFAULT_FOV:{name:"defaultFOV",type:"number"},DEFAULT_FOV_RANGE:{name:"defaultFOVRange",type:e.VECTOR2},DEFAULT_SPAN:{name:"defaultSpan",type:"number"},DEFAULT_SPAN_RANGE:{name:"defaultSpanRange",type:e.VECTOR2},DEFAULT_BASE_ORIENTATION:{name:"defaultBaseOrientation",type:"enum",values:n.CameraOrientationConfiguration.prototype.BaseOrientation},DEFAULT_POINT_TO_FALLBACK:{name:"defaultPointToFallback",type:"enum",values:n.CameraOrientationConfiguration.prototype.PointToFallback}},Object.freeze(_),r.prototype=new i.AsyncResource,r.prototype.constructor=r,r.prototype.loadConfigurationFromJSON=function(t){this._configuration=e.getVerifiedObject("configuration",t,s)},r.prototype.getConfigurationSetting=function(t){return this._configuration[t.name]},r.prototype.getSetting=function(t){return this._settings[t.name]},r.prototype.getDefaultCameraFOV=function(){return this.getSetting(u.DEFAULT_FOV)},r.prototype.getDefaultCameraFOVRange=function(){return this.getSetting(u.DEFAULT_FOV_RANGE)},r.prototype.getDefaultCameraSpan=function(){return this.getSetting(u.DEFAULT_SPAN)},r.prototype.getDefaultCameraSpanRange=function(){return this.getSetting(u.DEFAULT_SPAN_RANGE)},r.prototype.getDefaultCameraBaseOrientation=function(){return this.getSetting(u.DEFAULT_BASE_ORIENTATION)},r.prototype.getDefaultCameraPointToFallback=function(){return this.getSetting(u.DEFAULT_POINT_TO_FALLBACK)},r.prototype.getLevelFileCount=function(){return this.getConfigurationSetting(s.LEVEL_FILES).filenames.length},r.prototype.getLevelFileName=function(t){return this.getConfigurationSetting(s.LEVEL_FILES).filenames[t]},r.prototype.loadSettingsFromJSON=function(t){this._settings=e.getVerifiedObject("general",t.general,a),e.getVerifiedObject("database",t.database,h,this._settings),e.getVerifiedObject("battle",t.battle,l,this._settings),e.getVerifiedObject("camera",t.camera,u,this._settings),o.requestLoad(this.getConfigurationSetting(s.CLASSES_SOURCE_FILE),function(){this.setToReady()}.bind(this))},c=new r,{CONFIGURATION:s,GENERAL_SETTINGS:a,BATTLE_SETTINGS:l,DATABASE_SETTINGS:h,CAMERA_SETTINGS:u,loadConfigurationFromJSON:c.loadConfigurationFromJSON.bind(c),loadSettingsFromJSON:c.loadSettingsFromJSON.bind(c),getLevelFileCount:c.getLevelFileCount.bind(c),getLevelFileName:c.getLevelFileName.bind(c),getConfigurationSetting:c.getConfigurationSetting.bind(c),getSetting:c.getSetting.bind(c),getDefaultCameraFOV:c.getDefaultCameraFOV.bind(c),getDefaultCameraFOVRange:c.getDefaultCameraFOVRange.bind(c),getDefaultCameraSpan:c.getDefaultCameraSpan.bind(c),getDefaultCameraSpanRange:c.getDefaultCameraSpanRange.bind(c),getDefaultCameraBaseOrientation:c.getDefaultCameraBaseOrientation.bind(c),getDefaultCameraPointToFallback:c.getDefaultCameraPointToFallback.bind(c),executeWhenReady:c.executeWhenReady.bind(c)}}),define("armada/ai",["utils/vectors","utils/matrices","modules/physics","armada/configuration","armada/classes"],function(t,e,i,n,o){"use strict";function r(t){this._spacecraft=t,this._weaponRange=this._spacecraft&&this._spacecraft.getWeapons().length>0?this._spacecraft.getWeapons()[0].getRange():0}function s(t){r.call(this,t),this._timeSinceLastRoll=0,this._timeSinceLastTargetHit=0,this._timeSinceLastClosingIn=0,this._hitCountByNonTarget=0,this._evasiveManeuverTime=-1,this._evasiveVelocityVector=[0,0],this._rollTime=-1,this._chargePhase=c.NONE,this._chargeDestination=[0,0,0],this._maxDistanceFactor=m,this._isBlockedBy=null,this._facingTarget=!1,this._targetDistance=0,this._spacecraft.setOnBeingHit(this._handleBeingHit.bind(this)),this._spacecraft.setOnTargetHit(this._handleTargetHit.bind(this)),this._spacecraft.setOnAnySpacecraftHit(this._handleAnySpacecraftHit.bind(this)),this._spacecraft.setOnTargetFired(this._handleTargetFired.bind(this))}function a(t){r.call(this,t),this._targetInRange=!1,this._spacecraft.setOnBeingHit(this._handleBeingHit.bind(this))}function h(){this._ais=[]}var l,u,c={NONE:-1,APPROACH_ATTACK:0,EVADE:1},_="fighter",p="ship",d=.001,g=1e3/i.ANGULAR_VELOCITY_MATRIX_DURATION,f=Math.radians(45),m=.3,y=.125,T=.05,S=5,M=.06,x=.5,E=4,b=6,A=15,O=4,R=1,v=.25,C=3,I=Math.radians(45),L=1,N=1,w=1,D=1e3,F=.9,V=0,P=0;return r.prototype.turn=function(e,i,n){var o,r,s,a,h;o=this._spacecraft.getTurningMatrix(),s=this._spacecraft.getMaxAngularAcceleration(),h=P/(s*n),r=Math.sign(o[4])*t.angle2u([0,1],t.normal2([o[4],o[5]]))*g,a=Math.max(r*r/(2*s),d),e>a?this._spacecraft.yawLeft(Math.min(Math.max(0,h*(e-a)),1)):-a>e&&this._spacecraft.yawRight(Math.min(Math.max(0,h*(-e-a)),1)),r=Math.sign(o[6])*t.angle2u([1,0],t.normal2([o[5],o[6]]))*g,a=Math.max(r*r/(2*s),d),i>a?this._spacecraft.pitchUp(Math.min(Math.max(0,h*(i-a)),1)):-a>i&&this._spacecraft.pitchDown(Math.min(Math.max(0,h*(-i-a)),1))},r.prototype.rollAndYaw=function(e,i,n){var o,r,s,a,h;o=this._spacecraft.getTurningMatrix(),s=this._spacecraft.getMaxAngularAcceleration(),h=P/(s*n),r=Math.sign(o[2])*t.angle2u([1,0],t.normal2([o[0],o[2]]))*g,a=Math.max(r*r/(2*s),d),e>a?this._spacecraft.rollLeft(Math.min(Math.max(0,h*(e-a)),1)):-a>e&&this._spacecraft.rollRight(Math.min(Math.max(0,h*(-e-a)),1)),r=Math.sign(o[4])*t.angle2u([0,1],t.normal2([o[4],o[5]]))*g,a=Math.max(r*r/(2*s),d),i>a?this._spacecraft.yawLeft(Math.min(Math.max(0,h*(i-a)),1)):-a>i&&this._spacecraft.yawRight(Math.min(Math.max(0,h*(-i-a)),1))},r.prototype.rollAndPitch=function(e,i,n){var o,r,s,a,h;o=this._spacecraft.getTurningMatrix(),s=this._spacecraft.getMaxAngularAcceleration(),h=P/(s*n),r=Math.sign(o[2])*t.angle2u([1,0],t.normal2([o[0],o[2]]))*g,a=Math.max(r*r/(2*s),d),e>a?this._spacecraft.rollLeft(Math.min(Math.max(0,h*(e-a)),1)):-a>e&&this._spacecraft.rollRight(Math.min(Math.max(0,h*(-e-a)),1)),r=Math.sign(o[6])*t.angle2u([1,0],t.normal2([o[5],o[6]]))*g,a=Math.max(r*r/(2*s),d),i>a?this._spacecraft.pitchUp(Math.min(Math.max(0,h*(i-a)),1)):-a>i&&this._spacecraft.pitchDown(Math.min(Math.max(0,h*(-i-a)),1))},r.prototype.approach=function(t,e,i,n){var o,r;o=this._spacecraft.getRelativeVelocityMatrix()[13],r=o*o/(2*this._spacecraft.getMaxAcceleration()),0>o&&(r=-r),t-r>e?this._spacecraft.setSpeedTarget(n):i>=0&&i>t-r?this._spacecraft.setSpeedTarget(-n):this._spacecraft.resetSpeed()},s.prototype=new r,s.prototype.constructor=s,s.prototype._startNewAttackRun=function(){this._chargePhase=c.NONE,this._hitCountByNonTarget=0,this._timeSinceLastTargetHit=0,this._timeSinceLastClosingIn=0,this._timeSinceLastRoll=0,this._maxDistanceFactor=m,this._isBlockedBy=null,this._rollTime=-1},s.prototype._handleTargetSwitch=function(){this._startNewAttackRun()},s.prototype._handleBeingHit=function(e,i){!this._isBlockedBy&&this._evasiveManeuverTime<0&&(this._evasiveManeuverTime=0,this._evasiveVelocityVector[0]=-i[0],this._evasiveVelocityVector[1]=-i[2],t.normalize2(this._evasiveVelocityVector)),this._spacecraft&&!this._spacecraft.canBeReused()&&!e.canBeReused()&&e.isHostile(this._spacecraft)&&this._spacecraft.getTarget()&&this._spacecraft.getTarget()!==e&&(this._spacecraft.getTarget().getTarget()!==this._spacecraft&&(this._spacecraft.setTarget(e),this._handleTargetSwitch()),this._hitCountByNonTarget++)},s.prototype._handleTargetHit=function(){this._timeSinceLastTargetHit=0},s.prototype._handleAnySpacecraftHit=function(t){!this._spacecraft||this._spacecraft.canBeReused()||t===this._spacecraft||this._chargePhase===c.EVADE||t===this._spacecraft.getTarget()||this._isBlockedBy&&!this._isBlockedBy.isHostile(this._spacecraft)||(this._isBlockedBy=t,this._evasiveManeuverTime=-1,this._chargePhase=c.NONE)},s.prototype._handleTargetFired=function(){var e;!this._isBlockedBy&&this._evasiveManeuverTime<0&&this._facingTarget&&this._spacecraft&&this._spacecraft.getTarget()&&this._spacecraft.getTarget().getTarget()===this._spacecraft&&this._targetDistance>this._weaponRange*x&&(this._evasiveManeuverTime=0,e=2*Math.random()*Math.PI,this._evasiveVelocityVector[0]=1,this._evasiveVelocityVector[1]=0,t.rotate2(this._evasiveVelocityVector,e))},s.prototype.handleSceneMoved=function(e){t.add3(this._chargeDestination,e)},s.prototype.control=function(i){var n,o,r,s,a,h,l,u,_,p,g,m,x,F,P,U,B,G,H,j,k,z,W,q,X,Y,Q,J,K;if(this._spacecraft){if(this._spacecraft.canBeReused())return void(this._spacecraft=null);Q=!1,this._spacecraft.getTarget()||(this._spacecraft.targetNextHostile(),this._handleTargetSwitch()),m=this._spacecraft.getMaxAcceleration(),_=this._spacecraft._visualModel.getScaledSize(),o=e.translationVector3(this._spacecraft.getPhysicalPositionMatrix()),K=e.inverseOfRotation4(this._spacecraft.getPhysicalOrientationMatrix()),P=this._spacecraft.getRelativeVelocityMatrix()[13],n=this._spacecraft.getTarget(),this._chargePhase===c.EVADE?(s=t.diff3(this._chargeDestination,o),h=t.mulVec3Mat4(s,K),this._targetDistance=t.length3(h),t.normalize3(h),X=t.getYawAndPitch(h),this.turn(X.yaw,X.pitch,i),this._spacecraft.setSpeedTarget(m*b),(this._targetDistance<=L||h[1]<0||0>P)&&this._startNewAttackRun()):n?(r=e.translationVector3(n.getPhysicalPositionMatrix()),s=t.diff3(r,o),h=t.mulVec3Mat4(s,K),this._targetDistance=t.length3(h),t.normalize3(h),X=t.getYawAndPitch(h),this._facingTarget=Math.abs(X.yaw)<f&&Math.abs(X.pitch)<f,this.turn(X.yaw,X.pitch,i),this._isBlockedBy&&(Y=!1,!this._isBlockedBy.canBeReused()&&this._facingTarget&&this._isBlockedBy._physicalModel.checkHit(r,s,1e3,_/2)&&(l=t.mulVec3Mat4(t.diff3(e.translationVector3(this._isBlockedBy.getPhysicalPositionMatrix()),o),K),U=m*R,l[0]<0?(this._spacecraft.strafeRight(U),Y=!0):(this._spacecraft.strafeLeft(U),Y=!0),l[2]>0?(this._spacecraft.lower(U),Y=!0):(this._spacecraft.raise(U),Y=!0)),Y||(this._isBlockedBy=null,this._spacecraft.stopLeftStrafe(),this._spacecraft.stopRightStrafe(),this._spacecraft.stopLower(),this._spacecraft.stopRaise()),Q=!0),J=this._spacecraft.getWeapons(),J&&J.length>0?(p=n._visualModel.getScaledSize(),g=Math.atan(v*p/this._targetDistance),W=J[0].getProjectileVelocity()+P,u=this._targetDistance/W*1e3,G=J[0].getCooldown(),this._spacecraft.aimWeapons(d,g,i),this._facingTarget||(this._timeSinceLastClosingIn=0,this._timeSinceLastTargetHit=0,this._hitCountByNonTarget=0),
t.length3(t.diff3(this._spacecraft.getTargetHitPosition(),o))<=J[0].getRange(P)&&Math.abs(X.yaw)<g&&Math.abs(X.pitch)<g&&(!this._isBlockedBy||this._isBlockedBy.isHostile(this._spacecraft))?(this._spacecraft.fire(),this._isBlockedBy||(this._timeSinceLastRoll+=i,this._timeSinceLastTargetHit+=i,this._timeSinceLastClosingIn+=i,j=u+C*G,this._timeSinceLastRoll>j&&this._timeSinceLastTargetHit>j&&(this._rollTime=0),this._rollTime>=0&&(this._spacecraft.rollLeft(),this._timeSinceLastRoll=0,this._rollTime+=i,k=this._spacecraft.getMaxAngularAcceleration(),z=k*V,H=I>z*V?V+(I-z*V)/z:Math.sqrt(4*I/k)/2,this._rollTime>1e3*H&&(this._rollTime=-1)))):this._timeSinceLastRoll=0,this._chargePhase===c.NONE&&(this._hitCountByNonTarget>=O||this._timeSinceLastTargetHit>u+A*G)&&(this._chargePhase=c.APPROACH_ATTACK),this._chargePhase===c.NONE?(q=u+S*G,this._timeSinceLastClosingIn>q&&this._timeSinceLastTargetHit>q&&this._maxDistanceFactor>y&&(this._maxDistanceFactor=Math.max(this._maxDistanceFactor-T,y),this._timeSinceLastClosingIn=0),B=.5*(_+p),F=B+this._maxDistanceFactor*this._weaponRange,x=B+M*this._weaponRange,this._facingTarget?this.approach(this._targetDistance,F,x,m*E):this._spacecraft.resetSpeed()):this._chargePhase===c.APPROACH_ATTACK&&(F=Math.sqrt(2*(p+.5*_)/m)*m*b,this._facingTarget?(this._spacecraft.setSpeedTarget(m*b),this._targetDistance<=F&&(this._chargePhase=c.EVADE,a=t.normal3(s),this._chargeDestination=t.sum3(o,t.scaled3(t.diff3(t.sum3(r,t.scaled3(t.normal3(t.mulVec3Mat4(t.perpendicular3(a),e.rotation4(a,Math.random()*Math.PI*2))),F)),o),N)))):(this._spacecraft.resetSpeed(),this._chargePhase=c.NONE))):this._spacecraft.resetSpeed()):(this._facingTarget=!1,this._targetDistance=0,this._spacecraft.resetSpeed(),this._spacecraft.aimWeapons(d,0,i)),Q||(this._evasiveManeuverTime>=0?(0===this._evasiveManeuverTime&&(this._evasiveVelocityVector[0]*=m*w,this._evasiveVelocityVector[1]*=m*w,t.rotate2(this._evasiveVelocityVector,(Math.random()-.5)*Math.PI)),this._evasiveVelocityVector[0]>0?this._spacecraft.strafeRight(this._evasiveVelocityVector[0]):this._evasiveVelocityVector[0]<0?this._spacecraft.strafeLeft(-this._evasiveVelocityVector[0]):(this._spacecraft.stopLeftStrafe(),this._spacecraft.stopRightStrafe()),this._evasiveVelocityVector[1]>0?this._spacecraft.raise(this._evasiveVelocityVector[1]):this._evasiveVelocityVector[1]<0?this._spacecraft.lower(-this._evasiveVelocityVector[1]):(this._spacecraft.stopLower(),this._spacecraft.stopRaise()),this._evasiveManeuverTime+=i,this._evasiveManeuverTime>D&&(this._evasiveManeuverTime=-1)):(this._spacecraft.stopLeftStrafe(),this._spacecraft.stopRightStrafe(),this._spacecraft.stopLower(),this._spacecraft.stopRaise()))}},a.prototype=new r,a.prototype.constructor=a,a.prototype._handleBeingHit=function(t){this._spacecraft&&!this._spacecraft.canBeReused()&&!t.canBeReused()&&t.isHostile(this._spacecraft)&&this._spacecraft.getTarget()&&this._spacecraft.getTarget()!==t&&(this._spacecraft.getTarget().getTarget()===this._spacecraft&&this._targetInRange||this._spacecraft.setTarget(t))},a.prototype.handleSceneMoved=function(){},a.prototype.control=function(i){var n,r,s,a,h,l,u,c,_,p,g,m,y,T,S,M,x,b,A,O;if(this._spacecraft){if(this._spacecraft.canBeReused())return void(this._spacecraft=null);if(this._spacecraft.getTarget()||this._spacecraft.targetNextHostile(),m=this._spacecraft.getMaxAcceleration(),_=this._spacecraft._visualModel.getScaledSize(),r=e.translationVector3(this._spacecraft.getPhysicalPositionMatrix()),O=e.inverseOfRotation4(this._spacecraft.getPhysicalOrientationMatrix()),n=this._spacecraft.getTarget(),this._targetInRange=!1,n){if(s=e.translationVector3(n.getPhysicalPositionMatrix()),a=t.diff3(s,r),h=t.mulVec3Mat4(a,O),c=t.length3(h),t.normalize3(h),M=t.getYawAndPitch(h),b=Math.abs(M.yaw)<f&&Math.abs(M.pitch)<f,A=this._spacecraft.getWeapons(),A&&A.length>0){if(p=n._visualModel.getScaledSize(),T=.25*_,y=T+F*this._weaponRange,g=Math.atan(v*p/c),this._spacecraft.aimWeapons(d,g,i),b?this.approach(c,y,0,m*E):this._spacecraft.resetSpeed(),c>y)this.turn(M.yaw,M.pitch,i);else switch(l=this._spacecraft.getClass().getAttackVectorAngles(),S=this._spacecraft.getClass().getAttackThresholdAngle(),this._spacecraft.getClass().getTurnStyle()){case o.SpacecraftTurnStyle.YAW_PITCH:(Math.abs(M.yaw-l[0])>S||Math.abs(M.pitch-l[1])>S)&&this.turn(M.yaw-l[0],M.pitch-l[1],i);break;case o.SpacecraftTurnStyle.ROLL_YAW:x=t.getRollAndYaw(h,!0),u=[x.roll-l[0],x.yaw-l[1]],(Math.abs(u[0])>S||Math.abs(u[1])>S)&&(Math.abs(u[1])>Math.PI/2?u[0]=0:Math.abs(u[0])>Math.PI/2&&(u[1]=0),this.rollAndYaw(u[0],u[1],i));break;case o.SpacecraftTurnStyle.ROLL_PITCH:x=t.getRollAndPitch(h,!0),u=[x.roll-l[0],x.pitch-l[1]],(Math.abs(u[0])>S||Math.abs(u[1])>S)&&(Math.abs(u[1])>Math.PI/2?u[0]=0:Math.abs(u[0]-Math.sign(u[0])*Math.PI)<Math.abs(u[0])&&(u[0]-=Math.sign(u[0])*Math.PI,x.pitch=-x.pitch),this.rollAndPitch(u[0],x.pitch-l[1],i))}t.length3(t.diff3(this._spacecraft.getTargetHitPosition(),r))-T<=A[0].getRange(this._spacecraft.getRelativeVelocityMatrix()[13])&&(this._spacecraft.fire(!0),this._targetInRange=!0)}}else this._spacecraft.resetSpeed(),this._spacecraft.aimWeapons(d,0,i)}},h.prototype.clearAIs=function(){this._ais=[]},h.prototype.addAI=function(t,e){this._ais.push(new l[t](e))},h.prototype.control=function(t){var e;for(e=0;e<this._ais.length;e++)this._ais[e].control(t)},h.prototype.handleSceneMoved=function(t){var e;for(e=0;e<this._ais.length;e++)this._ais[e].handleSceneMoved(t)},l={},l[_]=s,l[p]=a,u=new h(l),n.executeWhenReady(function(){V=n.getSetting(n.BATTLE_SETTINGS.TURN_ACCELERATION_DURATION_S),P=1e3/V}),{FIGHTER_AI_NAME:_,SHIP_AI_NAME:p,clearAIs:u.clearAIs.bind(u),addAI:u.addAI.bind(u),control:u.control.bind(u),handleSceneMoved:u.handleSceneMoved.bind(u)}}),define("armada/logic",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/async-resource","modules/managed-gl","modules/egom-model","modules/physics","modules/graphics-resources","modules/buda-scene","armada/graphics","armada/classes","armada/configuration","armada/strings","armada/ai","utils/polyfill"],function(t,e,i,n,o,r,s,a,h,l,u,c,_,p,d){"use strict";function g(){return it}function f(t){this._class=t}function m(t,e,i,n){this._class=t,this._direction=[Math.cos(Math.radians(e))*Math.cos(Math.radians(i)),Math.sin(Math.radians(e))*Math.cos(Math.radians(i)),Math.sin(Math.radians(i))],this._angle=Math.radians(n)||0}function y(t,e){this._positionVector=e,this._visualModel=null,this._cloud=t,this._range=t.getRange()}function T(t){this._class=t,this._particles=null,this._visualModel=null}function S(t){this._skyboxes=null,this._backgroundObjects=null,this._dustClouds=null,this._camera=null,void 0!==t&&this.loadFromJSON(t)}function M(){o.AsyncResource.call(this),this._environments=null}function x(t,e,n,o,r,s){this._class=t,this._positionMatrix=e,this._orientationMatrix=n,this._direction=o,this._carriesParticles=r===!0,this._velocityMatrix=s||i.identity4(),this._visualModel=null}function E(t,e,i,n,o){this._class=null,this._visualModel=null,this._physicalModel=null,this._timeLeft=0,this._origin=null,t&&this.init(t,e,i,n,o)}function b(t,e,n){this._class=t,this._spacecraft=e,this._slot=n,this._cooldown=0,this._visualModel=null,this._origoPositionMatrix=null,this._scaledOriMatrix=null,this._rotationAngles=[0,0],this._rotationChanged=!1,this._transformMatrix=i.identity4(),this._fixed=this._class.isFixed(),this._lastAimStatus=this._fixed?G.FIXED:G.NO_TARGET}function A(t,e){this._propulsionClass=t,this._slot=e,this._visualModel=null,this._shipModel=null,this._burnLevel=0,this._maxMoveBurnLevel=this._propulsionClass.getMaxMoveBurnLevel()}function O(t,e){this._class=t,this._drivenPhysicalObject=e,this._thrusterUses={forward:{burn:0,thrusters:[]},reverse:{burn:0,thrusters:[]},strafeLeft:{burn:0,thrusters:[]},strafeRight:{burn:0,thrusters:[]},raise:{burn:0,thrusters:[]},lower:{burn:0,thrusters:[]},yawLeft:{burn:0,thrusters:[]},yawRight:{burn:0,thrusters:[]},pitchUp:{burn:0,thrusters:[]},pitchDown:{burn:0,thrusters:[]},rollLeft:{burn:0,thrusters:[]},rollRight:{burn:0,thrusters:[]}}}function R(t){this._spacecraft=t,this._compensated=!0,this._restricted=!1,this._yawTarget=0,this._pitchTarget=0,this._rollTarget=0,this._speedTarget=0,this._strafeTarget=0,this._liftTarget=0,this._speedIncrementPerSecond=0,this._speedIncrement=0,this._maxCompensatedForwardSpeed=0,this._maxCompensatedReverseSpeed=0,this._turningLimit=0,this._maxMoveBurnLevel=0,this._maxTurnBurnLevel=0,this.updateForNewPropulsion()}function v(t){this._id=null,this._name=null,this._color=null,"string"==typeof t?(this._id=t,this._name=t):"object"==typeof t?(this._id=t.id||t.name||n.showError("Team defined without a name or id!"),this._name=t.name||t.id,this._color=t.color||null):n.showError("Invalid parameter specified for Team constructor!")}function C(t,e,i,n,o,r,s){this._class=null,this._id=null,this._name=null,this._displayName=null,this._hitpoints=0,this._visualModel=null,this._physicalModel=null,this._weapons=null,this._propulsion=null,this._maneuveringComputer=null,this._hitbox=null,this._projectilePool=null,this._alive=!0,this._timeElapsedSinceDestruction=-1,this._activeDamageIndicators=[],this._spacecraftArray=null,this._target=null,this._relativeVelocityMatrix=null,this._turningMatrix=null,this._targetedBy=[],this._onBeingTargeted=null,this._onBeingHit=null,this._onTargetHit=null,this._onAnySpacecraftHit=null,this._onTargetFired=null,this._team=null,this._squad=null,this._indexInSquad=0,this._targetHitPosition=null,t&&this._init(t,e,i,n,o,r,s)}function I(t,e,i,n){this._objects=t,this._center=null,this._boundaries=null,this._objects.length>0&&this._calculateCenter(n),this._subnodes=e>0&&this._objects.length>i?this._generateSubnodes(e-1,i):null}function L(){this._objects=[],this._objectsFree=[],this._freeIndices=[],this._firstFreeIndex=0,this._firstLockedIndex=0}function N(){this._environment=null,this._ownsEnvironment=!1,this._views=null,this._teams=null,this._spacecrafts=null,this._projectilePool=null,this._pilotedCraft=null,this._hitObjects=null,this._randomShips=null,this._randomShipsMapSize=0,this._randomShipsHeadingAngle=0,this._randomShipsRandomHeading=!1,this._randomShipsEquipmentProfileName=null}var w,D,F,V,P,U,B={FREE:"free",COMPENSATED:"compensated",RESTRICTED:"restricted"},G={FIXED:0,NO_TARGET:1,AIMING_OUT_OF_REACH:2,AIMING:3,AIMED_OUT_OF_RANGE:4,AIMED_IN_RANGE:5},H="-body-",j=0,k=1,z=2,W=3,q="team",X="originalFactionColor",Y="replacementFactionColor",Q=!1,J=0,K=null,Z=null,$=null,tt=0,et=0,it="";return Object.freeze(B),f.prototype.addToScene=function(t){this._class.acquireResources(),h.executeWhenReady(function(){t.addBackgroundObject(new l.CubemapSampledFVQ(this._class.getModel(),this._class.getShader(),this._class.getShader().getCubemapNames()[0],this._class.getCubemap(u.getCubemapQualityPreferenceList()),t.getCamera()))}.bind(this))},f.prototype.destroy=function(){this._class=null},m.prototype.addToScene=function(t){t.addDirectionalLightSource(new l.DirectionalLightSource(this._class.getLightColor(),this._direction)),this._class.acquireResources(),h.executeWhenReady(function(){var n,o,r;for(o=this._class.getLayers(),n=0;n<o.length;n++)r=new l.BackgroundBillboard(o[n].getModel(),o[n].getShader(),o[n].getTexturesOfTypes(o[n].getShader().getTextureTypes(),u.getTextureQualityPreferenceList()),o[n].getColor(),o[n].getSize(),i.translation4v(e.scaled3(this._direction,_.getSetting(_.BATTLE_SETTINGS.BACKGROUND_OBJECT_DISTANCE))),this._angle),r.setRelativeSize(1),t.addBackgroundObject(r)}.bind(this))},m.prototype.destroy=function(){this._class=null,this._direction=null},y.prototype.addToScene=function(t,e){this._visualModel=new l.PointParticle(this._cloud.getClass().getModel(),this._cloud.getClass().getShader(),this._cloud.getClass().getInstancedShader(),this._positionVector,e?this._cloud.getClass().getColor():null,e?this._range:null),t.addSubnode(new l.RenderableNode(this._visualModel,!1,_.getSetting(_.BATTLE_SETTINGS.MINIMUM_DUST_PARTICLE_COUNT_FOR_INSTANCING)))},y.prototype.getVisualModel=function(){return this._visualModel},y.prototype.simulate=function(t){this._visualModel.fitPositionWithinRange(t.getCameraPositionMatrix(),this._range)},y.prototype.destroy=function(){this._positionVector=null,this._visualModel&&(this._visualModel.getNode().markAsReusable(),this._visualModel=null),this._cloud=null},T.prototype.getClass=function(){return this._class},T.prototype.getColor=function(){return this._class.getColor().concat(1)},T.prototype.getRange=function(){return this._class.getRange()},T.prototype.addToScene=function(t){var e,i,n;for(this._class.acquireResources(),this._particles=[],i=this._class.getNumberOfParticles(),e=0;i>e;e++)n=new y(this,[2*(Math.random()-.5)*this._class.getRange(),2*(Math.random()-.5)*this._class.getRange(),2*(Math.random()-.5)*this._class.getRange()]),this._particles.push(n);h.executeWhenReady(function(){var e,n;for(this._visualModel=new l.RenderableObject(null,!1,!1,void 0,!1),n=t.addNode(new l.RenderableNode(this._visualModel,!0)),e=0;i>e;e++)this._particles[e].addToScene(n,0===e)}.bind(this))},T.prototype.simulate=function(t){var e,i;for(i=this._class.getNumberOfParticles(),this._particles[0]._visualModel.setShift(t.getVelocityVector()[0],t.getVelocityVector()[1],t.getVelocityVector()[2]),e=0;i>e;e++)this._particles[e].simulate(t)},T.prototype.destroy=function(){var t,e;if(e=this._class.getNumberOfParticles(),this._class=null,this._particles){for(t=0;e>t;t++)this._particles[t].destroy(),this._particles[t]=null;this._particles=null}this._visualModel&&(this._visualModel.getNode().markAsReusable(),this._visualModel=null)},S.prototype.loadFromJSON=function(t){var e;for(this._skyboxes=[],e=0;e<t.skyboxes.length;e++)this._skyboxes.push(new f(c.getSkyboxClass(t.skyboxes[e]["class"])));for(this._backgroundObjects=[],e=0;e<t.backgroundObjects.length;e++)this._backgroundObjects.push(new m(c.getBackgroundObjectClass(t.backgroundObjects[e]["class"]),t.backgroundObjects[e].position.angleAlpha,t.backgroundObjects[e].position.angleBeta,t.backgroundObjects[e].position.angleGamma||0));for(this._dustClouds=[],e=0;e<t.dustClouds.length;e++)this._dustClouds.push(new T(c.getDustCloudClass(t.dustClouds[e]["class"])))},S.prototype.addToScene=function(t){var e;for(e=0;e<this._skyboxes.length;e++)this._skyboxes[e].addToScene(t);for(e=0;e<this._backgroundObjects.length;e++)this._backgroundObjects[e].addToScene(t);for(e=0;e<this._dustClouds.length;e++)this._dustClouds[e].addToScene(t);this._camera=t.getCamera()},S.prototype.simulate=function(){var t;for(t=0;t<this._dustClouds.length;t++)this._dustClouds[t].simulate(this._camera)},S.prototype.destroy=function(){var t;if(this._skyboxes){for(t=0;t<this._skyboxes.length;t++)this._skyboxes[t].destroy(),this._skyboxes[t]=null;this._skyboxes=null}if(this._backgroundObjects){for(t=0;t<this._backgroundObjects.length;t++)this._backgroundObjects[t].destroy(),this._backgroundObjects[t]=null;this._backgroundObjects=null}if(this._dustClouds){for(t=0;t<this._dustClouds.length;t++)this._dustClouds[t].destroy(),this._dustClouds[t]=null;this._dustClouds=null}this._camera=null},M.prototype=new o.AsyncResource,M.prototype.constructor=M,M.prototype.getEnvironment=function(t){return this._environments[t]||null},M.prototype.requestEnvironmentsLoad=function(){n.requestTextFile(_.getConfigurationSetting(_.CONFIGURATION.ENVIRONMENTS_SOURCE_FILE).folder,_.getConfigurationSetting(_.CONFIGURATION.ENVIRONMENTS_SOURCE_FILE).filename,function(t){this.loadEnvironmentsFromJSON(JSON.parse(t)),this.setToReady()}.bind(this))},M.prototype.loadEnvironmentsFromJSON=function(t){var e,i;for(this._environments={},e=0;e<t.environments.length;e++)i=new S(t.environments[e]),this._environments[t.environments[e].name]=i},x.prototype.getEmitterParticleConstructor=function(t){var e=this._class.getParticleEmitterDescriptors()[t],n=e.getModel(),o=e.getShader(),r=e.getTexturesOfTypes(e.getShader().getTextureTypes(),u.getTextureQualityPreferenceList()),s=e.getParticleStates(),a=e.getInstancedShader();return function(){var t=P.getFreeObject();return t||(t=new l.Particle,P.addObject(t)),t.init(n,o,r,i.identity4(),s,!1,a),t}},x.prototype.getVisualModel=function(){return this._visualModel},x.prototype._createVisualModel=function(){var t,e,o=[],r=this._class.getParticleEmitterDescriptors();for(t=0;t<r.length;t++){switch(r[t].getType()){case c.ParticleEmitterType.OMNIDIRECTIONAL:e=new l.OmnidirectionalParticleEmitter(i.identity4(),this._orientationMatrix,r[t].getDimensions(),r[t].getVelocity(),r[t].getVelocitySpread(),r[t].getInitialNumber(),r[t].getSpawnNumber(),r[t].getSpawnTime(),r[t]._duration,this.getEmitterParticleConstructor(t));break;case c.ParticleEmitterType.UNIDIRECTIONAL:e=new l.UnidirectionalParticleEmitter(i.identity4(),this._orientationMatrix,r[t].getDimensions(),this._direction,r[t].getDirectionSpread(),r[t].getVelocity(),r[t].getVelocitySpread(),r[t].getInitialNumber(),r[t].getSpawnNumber(),r[t].getSpawnTime(),r[t]._duration,this.getEmitterParticleConstructor(t));break;case c.ParticleEmitterType.PLANAR:e=new l.PlanarParticleEmitter(i.identity4(),this._orientationMatrix,r[t].getDimensions(),this._direction,r[t].getDirectionSpread(),r[t].getVelocity(),r[t].getVelocitySpread(),r[t].getInitialNumber(),r[t].getSpawnNumber(),r[t].getSpawnTime(),r[t]._duration,this.getEmitterParticleConstructor(t));break;default:n.crash()}o.push(e)}this._visualModel=this._visualModel||new l.ParticleSystem(this._positionMatrix,this._velocityMatrix,o,this._class.getTotalDuration(),this._class.isContinuous(),this._carriesParticles,_.getSetting(_.BATTLE_SETTINGS.MINIMUM_EXPLOSION_PARTICLE_COUNT_FOR_INSTANCING),u.getParticleCountFactor())},x.prototype.addToScene=function(t,i){var n;h.executeWhenReady(function(){this._createVisualModel(),i?i.addSubnode(new l.RenderableNode(this._visualModel)):t.addObject(this._visualModel),n=this._class.getLightStates(),n&&t.addPointLightSource(new l.PointLightSource(n[0].color,n[0].intensity,e.NULL3,[this._visualModel],n),k)}.bind(this))},x.prototype.addResourcesToScene=function(t){this._class.acquireResources(),h.executeWhenReady(function(){this._createVisualModel(),t.addResourcesOfObject(this._visualModel)}.bind(this))},x.prototype.finish=function(){this._visualModel.finishEmitting()},x.prototype.destroy=function(){this._class=null,this._positionMatrix=null,this._orientationMatrix=null,this._direction=null,this._visualModel&&this._visualModel.markAsReusable(),this._visualModel=null},E.prototype.init=function(t,e,n,o,r){this._class=t,this._physicalModel||(this._physicalModel=new a.PhysicalObject),this._physicalModel.init(t.getMass(),e||i.identity4(),n||i.identity4(),i.scaling4(t.getSize()),o?o.getVelocityMatrix():i.null4(),[],!0),this._timeLeft=t._duration,this._origin=o,r&&this._physicalModel.addForce(r)},E.prototype.canBeReused=function(){return this._timeLeft<=0},E.prototype._createVisualModel=function(){this._visualModel||(this._visualModel=new l.Billboard),this._visualModel.init(this._class.getModel(),this._class.getShader(),this._class.getTexturesOfTypes(this._class.getShader().getTextureTypes(),u.getTextureQualityPreferenceList()),this._class.getSize(),this._physicalModel._positionMatrix,this._physicalModel._orientationMatrix,this._class.getInstancedShader())},E.prototype.getVisualModel=function(){return this._visualModel},E.prototype.moveByVector=function(t){this._physicalModel.moveByVector(t)},E.prototype.addToScene=function(t){h.executeWhenReady(function(){this._createVisualModel(),t.addObject(this._visualModel,et)}.bind(this))},E.prototype.addResourcesToScene=function(t){var e;this._class.acquireResources(),h.executeWhenReady(function(){this._createVisualModel(),t.addResourcesOfObject(this._visualModel),e=new x(this._class.getExplosionClass(),i.identity4(),i.identity4(),[0,0,0],!0),e.addResourcesToScene(t)}.bind(this))},E.prototype.simulate=function(t,n){var o,r,s,a,h,l,u,c,_,p,d,g,f,m;if(!this.canBeReused())if(m=Math.min(t,this._class._duration-this._timeLeft),this._timeLeft-=t,this._timeLeft>0){for(this._physicalModel.simulate(t),this._visualModel.setPositionMatrix(this._physicalModel._positionMatrix),this._visualModel.setOrientationMatrix(this._physicalModel._orientationMatrix),r=i.translationVector3(this._physicalModel._positionMatrix),h=i.translationVector3(this._physicalModel.getVelocityMatrix()),s=n.getObjects(Math.min(r[0],r[0]-h[0]*m/1e3),Math.max(r[0],r[0]-h[0]*m/1e3),Math.min(r[1],r[1]-h[1]*m/1e3),Math.max(r[1],r[1]-h[1]*m/1e3),Math.min(r[2],r[2]-h[2]*m/1e3),Math.max(r[2],r[2]-h[2]*m/1e3)),o=0;o<s.length;o++)if(V&&s[o].showHitbox(),p=s[o]._physicalModel,p&&(Q||s[o]!==this._origin)&&(d=p.checkHit(r,h,m)))return l=e.diff3(h,i.translationVector3(p.getVelocityMatrix())),c=e.normal3(l),u=e.length3(l),a=e.mulVec3Mat4(c,i.inverseOfRotation4(s[o]._visualModel._orientationMatrix)),g=e.mulVec4Mat4(d,s[o]._visualModel.getModelMatrix()),f=e.diff3(g,i.translationVector3(p._positionMatrix)),p.addForceAndTorque(f,c,u*this._physicalModel.getMass()*1e3/J,J),_=new x(this._class.getExplosionClass(),i.translation4v(g),i.identity4(),e.scaled3(c,-1),!0),_.addToScene(this._visualModel.getNode()._scene),s[o].damage(this._class.getDamage(),d,e.scaled3(a,-1),this._origin),this._timeLeft=0,void this._visualModel.markAsReusable()}else this._visualModel.markAsReusable()},E.prototype.destroy=function(){this._timeLeft=0,this._class=null,this._origin=null,this._visualModel&&this._visualModel.getNode()&&this._visualModel.getNode().markAsReusable(),this._visualModel=null,this._physicalModel=null},b.prototype.getSlot=function(){return this._slot},b.prototype.getProjectileClass=function(){return this._class.getProjectileClass()},b.prototype.getProjectileVelocity=function(){return this._class.getProjectileVelocity()},b.prototype.getRange=function(t){return(this._class.getProjectileVelocity()+(t||0))*this._class.getProjectileClass()._duration/1e3},b.prototype.getCooldown=function(){return this._class.getCooldown()},b.prototype.getOrigoPositionMatrix=function(){return this._origoPositionMatrix=this._origoPositionMatrix||i.translatedByVector(this._slot.positionMatrix,e.mulVec3Mat4(e.scaled3(this._class.getAttachmentPoint(),-1),i.prod3x3SubOf4(i.scaling4(this._class.getModel().getScale()/this._spacecraft.getPhysicalScalingMatrix()[0]),this._slot.orientationMatrix))),this._origoPositionMatrix},b.prototype.getScaledOriMatrix=function(){return this._scaledOriMatrix=this._scaledOriMatrix||i.prod3x3SubOf4(this._visualModel._scalingMatrix,this._slot.orientationMatrix),this._scaledOriMatrix},b.prototype.isFixed=function(){return this._fixed},b.prototype.getBasePointPosVector=function(t){var n=this._class.getBasePoint(),o=e.mulVec3Mat4(i.translationVector3(this.getOrigoPositionMatrix()),t);return e.add3(o,this._spacecraft.getPhysicalPositionVector()),n=e.mulVec4Mat4(n,this._transformMatrix),n=e.mulVec3Mat4(n,i.prod3x3SubOf4(this.getScaledOriMatrix(),t)),e.add3(n,o),n},b.prototype.getProjectileOrientationMatrix=function(){var t=i.prod3x3SubOf4(this._slot.orientationMatrix,this._spacecraft.getPhysicalOrientationMatrix());return this._fixed||(t=i.prod3x3SubOf4(this._transformMatrix,t)),t},b.prototype.acquireResources=function(t){this._class.acquireResources(t)},b.prototype.addToScene=function(t,e,o,s,a){var c,_;this.acquireResources({omitShader:!!s}),s&&u.getShader(s),h.executeWhenReady(function(){var h,p,d={};for(n.log("Adding weapon ("+this._class.getName()+") to scene...",2),p=this._class.getModel().getScale()/t._renderableObject._scalingMatrix[0],d[Z]=r.ShaderVariableType.MAT4,u.areLuminosityTexturesAvailable()&&(d[K]=r.ShaderVariableType.FLOAT),h=new l.ParameterizedMesh(this._class.getModel(),s?u.getManagedShader(s):this._class.getShader(),this._class.getTexturesOfTypes(this._class.getShader().getTextureTypes(),u.getTextureQualityPreferenceList()),this.getOrigoPositionMatrix(),this._slot.orientationMatrix,i.scaling4(p),o===!0,e,d),t.addSubnode(new l.RenderableNode(h)),c=0,_=u.getMaxGroupTransforms();_>c;c++)h.setMat4Parameter(Z,c,i.identity4());if(u.areLuminosityTexturesAvailable())for(c=0,_=u.getMaxLuminosityFactors();_>c;c++)h.setFloatParameter(K,c,this._class.getDefaultGroupLuminosity(c));this._visualModel||(this._visualModel=h),a&&a(h)}.bind(this))},b.prototype._getMuzzleFlashForBarrel=function(t,e){var n=this._class.getBarrel(t).getProjectileClass(),o=i.translation4v(e),r=P.getFreeObject();return r||(r=new l.Particle,P.addObject(r)),l.initDynamicParticle(r,n.getMuzzleFlash().getModel(),n.getMuzzleFlash().getShader(),n.getMuzzleFlash().getTexturesOfTypes(n.getMuzzleFlash().getShader().getTextureTypes(),u.getTextureQualityPreferenceList()),n.getMuzzleFlash().getColor(),n.getMuzzleFlash().getSize(),o,n.getMuzzleFlash()._duration||_.getSetting(_.BATTLE_SETTINGS.DEFAULT_MUZZLE_FLASH_DURATION),n.getMuzzleFlash().getInstancedShader()),r},b.prototype.getResourceAdderFunction=function(t,e){return function(){var i=this._getMuzzleFlashForBarrel(e,[0,0,0]);t.addResourcesOfObject(i),i.markAsReusable()}.bind(this)},b.prototype.addProjectileResourcesToScene=function(t){var e,i,n;for(n=this._class.getBarrels(),e=0;e<n.length;e++)i=new E(n[e].getProjectileClass()),i.addResourcesToScene(t),h.executeWhenReady(this.getResourceAdderFunction(t,e).bind(this))},b.prototype.simulate=function(t){var n,o;if(this._cooldown=Math.min(this._cooldown+t,this._class.getCooldown()),this._rotationChanged){for(i.setIdentity4(this._transformMatrix),o=this._class.getRotators(),n=0;n<o.length;n++)i.rotateAroundPoint4(this._transformMatrix,e.mulVec3Mat4(o[n].center,this._transformMatrix),e.mulVec3Mat4(o[n].axis,this._transformMatrix),this._rotationAngles[n]),this._visualModel.setMat4Parameter(Z,o[n].transformGroupIndex,this._transformMatrix);this._rotationChanged=!1}},b.prototype.fire=function(t,n,o){var r,s,h,u,c,_,p,d,g,f,m,y,T=this._visualModel.getNode()._scene;if(o&&this._lastAimStatus!==G.FIXED&&this._lastAimStatus!==G.AIMED_IN_RANGE)return!1;if(this._cooldown>=this._class.getCooldown()){for(this._cooldown=0,h=e.mulVec3Mat4(i.translationVector3(this.getOrigoPositionMatrix()),n),u=i.translatedByVector(this._spacecraft.getPhysicalPositionMatrix(),h),_=this.getProjectileOrientationMatrix(),f=this._class.getBarrels(),m={},r=0;r<f.length;r++)p=f[r].getProjectileClass(),d=f[r].getPositionVector(),this._fixed||(d=e.mulVec4Mat4(d,this._transformMatrix)),g=this._getMuzzleFlashForBarrel(r,d),d=e.mulVec3Mat4(d,i.prod3x3SubOf4(this.getScaledOriMatrix(),n)),c=i.translatedByVector(u,d),this._visualModel.getNode().addSubnode(new l.RenderableNode(g),!1,tt),s=t.getFreeObject(),s||(s=new E,t.addObject(s)),s.init(p,c,_,this._spacecraft,new a.Force("",f[r].getForceForDuration(J),[_[4],_[5],_[6]],J)),s.addToScene(T),m[p.getName()]?m[p.getName()].addEmittingObject(s._visualModel):m[p.getName()]=new l.PointLightSource(p.getLightColor(),p.getLightIntensity(),e.NULL3,[s._visualModel]),this._spacecraft._physicalModel.addForceAndTorque(e.diff3(i.translationVector3(c),i.translationVector3(this._spacecraft.getPhysicalPositionMatrix())),i.getRowB43Neg(_),f[r].getForceForDuration(J),J);for(y in m)m.hasOwnProperty(y)&&T.addPointLightSource(m[y],z);return!0}return!1},b.prototype.setRotation=function(t,e){this._fixed||(this._rotationAngles[0]=Math.radians(t),this._rotationAngles[1]=Math.radians(e),this._rotationChanged=!0)},b.prototype.rotateTo=function(t,e,i,o,r){var s,a,h,l;if(!this._fixed)for(this._lastAimStatus=G.AIMED_IN_RANGE,a=this._class.getRotators(),h=0;h<a.length;h++){switch(h){case 0:s=t-this._rotationAngles[0],this._class.getRotationStyle()===c.WeaponRotationStyle.ROLL_YAW&&Math.abs(s-Math.sign(s)*Math.PI)<Math.abs(s)&&(s-=Math.sign(s)*Math.PI,e=-e);break;case 1:s=e-this._rotationAngles[1];break;default:n.crash()}a[h].restricted||(s>Math.PI?s-=2*Math.PI:s<-Math.PI&&(s+=2*Math.PI)),l=0,Math.abs(s)>i&&(l=a[h].rotationRate*r/1e3,s>0?this._rotationAngles[h]+=Math.min(l,s):this._rotationAngles[h]-=Math.min(l,-s),this._rotationChanged=!0,Math.abs(s)-l>o&&(this._lastAimStatus=G.AIMING)),a[h].restricted?(this._rotationAngles[h]>a[h].range[1]&&(this._rotationAngles[h]=a[h].range[1],Math.abs(s)-l>o&&(this._lastAimStatus=G.AIMING_OUT_OF_REACH)),this._rotationAngles[h]<a[h].range[0]&&(this._rotationAngles[h]=a[h].range[0],Math.abs(s)-l>o&&(this._lastAimStatus=G.AIMING_OUT_OF_REACH))):(this._rotationAngles[h]>Math.PI&&(this._rotationAngles[h]-=2*Math.PI),this._rotationAngles[h]<-Math.PI&&(this._rotationAngles[h]+=2*Math.PI))}},b.prototype.aimTowards=function(t,i,o,r,s){var a,h,l,u,_;if(!this._fixed){switch(a=this.getBasePointPosVector(r),h=e.diff3(t,a),h=e.mulMat4Vec3(this._spacecraft.getPhysicalOrientationMatrix(),h),h=e.mulMat4Vec3(this._slot.orientationMatrix,h),_=e.length3(h)<=this.getRange(),e.normalize3(h),this._class.getRotationStyle()){case c.WeaponRotationStyle.YAW_PITCH:l=e.getYawAndPitch(h),this.rotateTo(-l.yaw,-l.pitch,i,o,s);break;case c.WeaponRotationStyle.ROLL_YAW:u=e.getRollAndYaw(h),this.rotateTo(u.roll,u.yaw,i,o,s);break;default:n.crash()}_||this._lastAimStatus!==G.AIMED_IN_RANGE||(this._lastAimStatus=G.AIMED_OUT_OF_RANGE)}},b.prototype.rotateToDefaultPosition=function(t,e){var i;this._fixed||(i=this._class.getRotators(),this.rotateTo(i[0].defaultAngle,i[1].defaultAngle,t,0,e),this._lastAimStatus=G.NO_TARGET)},b.prototype.destroy=function(){this._class=null,this._spacecraft=null,this._slot=null,this._visualModel=null},A.prototype.addToScene=function(t){var e;this._propulsionClass.acquireResources(),h.executeWhenReady(function(){e=l.staticParticle(this._propulsionClass.getThrusterBurnParticle().getModel(),this._propulsionClass.getThrusterBurnParticle().getShader(),this._propulsionClass.getThrusterBurnParticle().getTexturesOfTypes(this._propulsionClass.getThrusterBurnParticle().getShader().getTextureTypes(),u.getTextureQualityPreferenceList()),this._propulsionClass.getThrusterBurnParticle().getColor(),this._slot.size,i.translation4v(this._slot.positionVector),this._propulsionClass.getThrusterBurnParticle().getInstancedShader()),e.setRelativeSize(0),t.addSubnode(new l.RenderableNode(e,!1,_.getSetting(_.BATTLE_SETTINGS.MINIMUM_THRUSTER_PARTICLE_COUNT_FOR_INSTANCING))),this._visualModel||(this._visualModel=e,this._shipModel=t._renderableObject)}.bind(this))},A.prototype._updateVisuals=function(){this._visualModel.setRelativeSize(this._burnLevel),u.areLuminosityTexturesAvailable()&&this._shipModel.setFloatParameter(K,this._slot.group,Math.min(1,this._burnLevel/this._maxMoveBurnLevel))},A.prototype.resetBurn=function(){this._burnLevel=0,this._updateVisuals()},A.prototype.addBurn=function(t){this._burnLevel+=t,this._updateVisuals()},A.prototype.destroy=function(){this._propulsionClass=null,this._slot=null,this._visualModel=null,this._shipModel=null},O.prototype.acquireResources=function(){this._class.acquireResources()},O.prototype.getThrust=function(){return this._class.getThrust()},O.prototype.getAngularThrust=function(){return this._class.getAngularThrust()},O.prototype.getMaxMoveBurnLevel=function(){return this._class.getMaxMoveBurnLevel()},O.prototype.getMaxTurnBurnLevel=function(){return this._class.getMaxTurnBurnLevel()},O.prototype.addThrusters=function(t){var e,i,n;for(e=0;e<t.length;e++)for(n=new A(this._class,t[e]),i=0;i<t[e].uses.length;i++)this._thrusterUses[t[e].uses[i]].thrusters.push(n)},O.prototype.addToScene=function(t){var e,i;for(e in this._thrusterUses)if(this._thrusterUses.hasOwnProperty(e))for(i=0;i<this._thrusterUses[e].thrusters.length;i++)this._thrusterUses[e].thrusters[i].addToScene(t)},O.prototype.getThrusterBurn=function(t){return this._thrusterUses[t].burn},O.prototype.addThrusterBurn=function(t,e){var i;for(this._thrusterUses[t].burn+=e,i=0;i<this._thrusterUses[t].thrusters.length;i++)this._thrusterUses[t].thrusters[i].addBurn(e)},O.prototype.resetThrusterBurn=function(){var t,e;for(t in this._thrusterUses)if(this._thrusterUses.hasOwnProperty(t))for(this._thrusterUses[t].burn=0,e=0;e<this._thrusterUses[t].thrusters.length;e++)this._thrusterUses[t].thrusters[e].resetBurn();
},O.prototype.simulate=function(){var t=i.getRowB4(this._drivenPhysicalObject._orientationMatrix),e=i.getRowC4(this._drivenPhysicalObject._orientationMatrix),n=i.getRowA4(this._drivenPhysicalObject._orientationMatrix);this._thrusterUses.forward.burn>0&&this._drivenPhysicalObject.addOrRenewForce("forwardThrust",this._class.getThrust()*this._thrusterUses.forward.burn/this._class.getMaxMoveBurnLevel(),t),this._thrusterUses.reverse.burn>0&&this._drivenPhysicalObject.addOrRenewForce("reverseThrust",-this._class.getThrust()*this._thrusterUses.reverse.burn/this._class.getMaxMoveBurnLevel(),t),this._thrusterUses.strafeRight.burn>0&&this._drivenPhysicalObject.addOrRenewForce("strafeRightThrust",this._class.getThrust()*this._thrusterUses.strafeRight.burn/this._class.getMaxMoveBurnLevel(),n),this._thrusterUses.strafeLeft.burn>0&&this._drivenPhysicalObject.addOrRenewForce("strafeLeftThrust",-this._class.getThrust()*this._thrusterUses.strafeLeft.burn/this._class.getMaxMoveBurnLevel(),n),this._thrusterUses.raise.burn>0&&this._drivenPhysicalObject.addOrRenewForce("raiseThrust",this._class.getThrust()*this._thrusterUses.raise.burn/this._class.getMaxMoveBurnLevel(),e),this._thrusterUses.lower.burn>0&&this._drivenPhysicalObject.addOrRenewForce("lowerThrust",-this._class.getThrust()*this._thrusterUses.lower.burn/this._class.getMaxMoveBurnLevel(),e),this._thrusterUses.yawRight.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("yawRightThrust",this._class.getAngularThrust()*this._thrusterUses.yawRight.burn/this._class.getMaxTurnBurnLevel(),e),this._thrusterUses.yawLeft.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("yawLeftThrust",-this._class.getAngularThrust()*this._thrusterUses.yawLeft.burn/this._class.getMaxTurnBurnLevel(),e),this._thrusterUses.pitchUp.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("pitchUpThrust",-this._class.getAngularThrust()*this._thrusterUses.pitchUp.burn/this._class.getMaxTurnBurnLevel(),n),this._thrusterUses.pitchDown.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("pitchDownThrust",this._class.getAngularThrust()*this._thrusterUses.pitchDown.burn/this._class.getMaxTurnBurnLevel(),n),this._thrusterUses.rollRight.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("rollRightThrust",-this._class.getAngularThrust()*this._thrusterUses.rollRight.burn/this._class.getMaxTurnBurnLevel(),t),this._thrusterUses.rollLeft.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("rollLeftThrust",this._class.getAngularThrust()*this._thrusterUses.rollLeft.burn/this._class.getMaxTurnBurnLevel(),t)},O.prototype.destroy=function(){this._class=null,this._drivenPhysicalObject=null,this._thrusterUses=null},R.prototype.updateSpeedIncrementPerSecond=function(){this._speedIncrementPerSecond=this._spacecraft.getMaxAcceleration()||0},R.prototype.updateSpeedIncrement=function(t){this._speedIncrement=t*this._speedIncrementPerSecond/1e3},R.prototype.updateTurningLimit=function(){this._turningLimit=this._spacecraft.getMaxAngularAcceleration()*_.getSetting(_.BATTLE_SETTINGS.TURN_ACCELERATION_DURATION_S)*a.ANGULAR_VELOCITY_MATRIX_DURATION_S},R.prototype.updateForNewPropulsion=function(){this.updateSpeedIncrementPerSecond(),this._maxCompensatedForwardSpeed=w*this._spacecraft.getMaxAcceleration(),this._maxCompensatedReverseSpeed=D*-this._spacecraft.getMaxAcceleration(),this.updateTurningLimit(),this._maxMoveBurnLevel=this._spacecraft.getMaxThrusterMoveBurnLevel(),this._maxTurnBurnLevel=this._spacecraft.getMaxThrusterTurnBurnLevel()},R.prototype.getFlightMode=function(){return this._compensated?this._restricted?B.RESTRICTED:B.COMPENSATED:B.FREE},R.prototype.changeFlightMode=function(){this._compensated?this._restricted?(this._compensated=!1,this._restricted=!1):this._restricted=!0:(this._compensated=!0,this._speedTarget=Math.min(Math.max(this._maxCompensatedReverseSpeed,this._spacecraft.getRelativeVelocityMatrix()[13]),this._maxCompensatedForwardSpeed))},R.prototype.forward=function(t){this._speedTarget=this._compensated?Math.min(this._speedTarget+(t||this._speedIncrement),this._maxCompensatedForwardSpeed):Number.MAX_VALUE},R.prototype.stopForward=function(){if(!this._compensated){var t=this._spacecraft.getRelativeVelocityMatrix()[13];this._speedTarget>t&&(this._speedTarget=t)}},R.prototype.reverse=function(t){this._speedTarget=this._compensated?Math.max(this._speedTarget-(t||this._speedIncrement),this._maxCompensatedReverseSpeed):-Number.MAX_VALUE},R.prototype.stopReverse=function(){var t;this._compensated||(t=this._spacecraft.getRelativeVelocityMatrix()[13],this._speedTarget<t&&(this._speedTarget=t))},R.prototype.strafeLeft=function(t){this._strafeTarget=this._compensated&&t?-t:-Number.MAX_VALUE},R.prototype.stopLeftStrafe=function(){this._strafeTarget<0&&(this._strafeTarget=0)},R.prototype.strafeRight=function(t){this._strafeTarget=this._compensated&&t||Number.MAX_VALUE},R.prototype.stopRightStrafe=function(){this._strafeTarget>0&&(this._strafeTarget=0)},R.prototype.lower=function(t){this._liftTarget=this._compensated&&t?-t:-Number.MAX_VALUE},R.prototype.stopLower=function(){this._liftTarget<0&&(this._liftTarget=0)},R.prototype.raise=function(t){this._liftTarget=this._compensated&&t||Number.MAX_VALUE},R.prototype.stopRaise=function(){this._liftTarget>0&&(this._liftTarget=0)},R.prototype.resetSpeed=function(){this._compensated&&(this._speedTarget=0)},R.prototype.setSpeedTarget=function(t){this._compensated&&(this._speedTarget=t)},R.prototype.getSpeedTarget=function(){return this._speedTarget},R.prototype.hasSpeedTarget=function(){return this._compensated},R.prototype.yawLeft=function(t){void 0===t?this._yawTarget=-this._turningLimit:t>0?this._yawTarget=-t*this._turningLimit:this._yawTarget<0&&(this._yawTarget=0)},R.prototype.yawRight=function(t){void 0===t?this._yawTarget=this._turningLimit:t>0?this._yawTarget=t*this._turningLimit:this._yawTarget>0&&(this._yawTarget=0)},R.prototype.pitchDown=function(t){void 0===t?this._pitchTarget=-this._turningLimit:t>0?this._pitchTarget=-t*this._turningLimit:this._pitchTarget<0&&(this._pitchTarget=0)},R.prototype.pitchUp=function(t){void 0===t?this._pitchTarget=this._turningLimit:t>0?this._pitchTarget=t*this._turningLimit:this._pitchTarget>0&&(this._pitchTarget=0)},R.prototype.rollLeft=function(t){void 0===t?this._rollTarget=-this._turningLimit:t>0?this._rollTarget=-t*this._turningLimit:this._rollTarget<0&&(this._rollTarget=0)},R.prototype.rollRight=function(t){void 0===t?this._rollTarget=this._turningLimit:t>0?this._rollTarget=t*this._turningLimit:this._rollTarget>0&&(this._rollTarget=0)},R.prototype.controlThrusters=function(t){var i,n,o,r=this._spacecraft.getRelativeVelocityMatrix(),s=r[13],h=a.VELOCITY_MATRIX_ERROR_THRESHOLD,l=this._spacecraft.getTurningMatrix(),u=a.ANGULAR_VELOCITY_MATRIX_ERROR_THRESHOLD,c=this._turningLimit,_=this._yawTarget,p=this._pitchTarget;this._spacecraft.resetThrusterBurn(),this._restricted&&0!==s&&(c=Math.min(c,this._spacecraft.getMaxTurnRateAtSpeed(s)*a.ANGULAR_VELOCITY_MATRIX_DURATION_S),_=Math.min(Math.max(_,-c),c),p=Math.min(Math.max(p,-c),c)),i=Math.sign(l[4])*e.angle2u([0,1],e.normal2([l[4],l[5]])),_-i>u?this._spacecraft.addThrusterBurn("yawRight",Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(_-i,t))):-u>_-i&&this._spacecraft.addThrusterBurn("yawLeft",Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(i-_,t))),n=Math.sign(l[6])*e.angle2u([1,0],e.normal2([l[5],l[6]])),p-n>u?this._spacecraft.addThrusterBurn("pitchUp",Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(p-n,t))):-u>p-n&&this._spacecraft.addThrusterBurn("pitchDown",Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(n-p,t))),o=Math.sign(-l[2])*e.angle2u([1,0],e.normal2([l[0],l[2]])),this._rollTarget-o>u?this._spacecraft.addThrusterBurn("rollRight",Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(this._rollTarget-o,t))):this._rollTarget-o<-u&&this._spacecraft.addThrusterBurn("rollLeft",Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(o-this._rollTarget,t))),this._speedTarget-s>h?this._spacecraft.addThrusterBurn("forward",Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(this._speedTarget-s,t))):this._speedTarget-s<-h&&this._spacecraft.addThrusterBurn("reverse",Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(s-this._speedTarget,t))),(this._compensated||0!==this._strafeTarget)&&(s=r[12],this._strafeTarget-s>h?this._spacecraft.addThrusterBurn("strafeRight",Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(this._strafeTarget-s,t))):this._strafeTarget-s<-h&&this._spacecraft.addThrusterBurn("strafeLeft",Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(s-this._strafeTarget,t)))),(this._compensated||0!==this._liftTarget)&&(s=r[14],this._liftTarget-s>h?this._spacecraft.addThrusterBurn("raise",Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(this._liftTarget-s,t))):this._liftTarget-s<-h&&this._spacecraft.addThrusterBurn("lower",Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(s-this._liftTarget,t)))),this._yawTarget=0,this._pitchTarget=0,this._rollTarget=0,this._strafeTarget=0,this._liftTarget=0},R.prototype.destroy=function(){this._spacecraft=null},v.prototype.getID=function(){return this._id},v.prototype.getDisplayName=function(){return t.formatString(p.get(p.TEAM.PREFIX,this._name),{id:this._id})},v.prototype.getColor=function(){return this._color},C.prototype._init=function(t,e,n,o,r,s,l){this._class=t,this._name=e||"",this._hitpoints=this._class.getHitpoints(),this._physicalModel=new a.PhysicalObject(this._class.getMass(),n||i.identity4(),o||i.identity4(),i.identity4(),i.identity4(),this._class.getBodies()),this._class.acquireResources(),h.executeWhenReady(function(){this._physicalModel.setScalingMatrix(i.scaling4(this._class.getModel().getScale()))}.bind(this)),this._weapons=[],this._maneuveringComputer=new R(this),this._projectilePool=r||null,s&&this.equipProfile(this._class.getEquipmentProfile(s)),this._spacecraftArray=l||null,this._team=null,this._updateIDAndName()},C.prototype._updateIDAndName=function(){this._id=this._name||!this._squad?this._name:this._squad+" "+this._indexInSquad.toString(),this._displayName=this._name||!this._squad?this._name:p.get(p.SQUAD.PREFIX,this._squad)+" "+this._indexInSquad.toString()},C.prototype.setTeam=function(t){this._team=t},C.prototype.getTeam=function(){return this._team},C.prototype.setSquad=function(t,e){this._squad=t,this._indexInSquad=e,this._updateIDAndName()},C.prototype.isFriendly=function(t){return t.getTeam()===this._team},C.prototype.isHostile=function(t){return t.getTeam()!==this._team},C.prototype.getClass=function(){return this._class},C.prototype.isFighter=function(){return this._class.isFighterClass()},C.prototype.getID=function(){return this._id},C.prototype.getDisplayName=function(){return this._displayName},C.prototype.getHitpoints=function(){return this._hitpoints},C.prototype.getFullIntegrityHitpoints=function(){return this._class.getHitpoints()},C.prototype.getHullIntegrity=function(){return this._hitpoints/this._class.getHitpoints()},C.prototype.getVisualModel=function(){return this._visualModel},C.prototype.getPhysicalModel=function(){return this._physicalModel},C.prototype.getClassName=function(){return this._class.getName()},C.prototype.getTypeName=function(){return this._class.getSpacecraftType().getName()},C.prototype.getView=function(t){return this._class.getView(t)},C.prototype.getWeapons=function(){return this._weapons},C.prototype.canBeReused=function(){return!this._alive},C.prototype.getPhysicalPositionMatrix=function(){return this._physicalModel._positionMatrix},C.prototype.getPhysicalPositionVector=function(){return i.translationVector3(this._physicalModel._positionMatrix)},C.prototype.getPhysicalOrientationMatrix=function(){return this._physicalModel._orientationMatrix},C.prototype.getPhysicalScalingMatrix=function(){return this._physicalModel._scalingMatrix},C.prototype.getScaledOriMatrix=function(){return i.prod3x3SubOf4(this.getPhysicalScalingMatrix(),this.getPhysicalOrientationMatrix())},C.prototype.getVelocityMatrix=function(){return this._physicalModel.getVelocityMatrix()},C.prototype.getRelativeVelocityMatrix=function(){return this._relativeVelocityMatrix||(this._relativeVelocityMatrix=i.prodTranslationRotation4(this._physicalModel.getVelocityMatrix(),i.rotation4m4(this._physicalModel.getRotationMatrixInverse()))),this._relativeVelocityMatrix},C.prototype.getTurningMatrix=function(){return this._turningMatrix||(this._turningMatrix=i.prod3x3SubOf4(i.prod3x3SubOf4(this._physicalModel._orientationMatrix,this._physicalModel.getAngularVelocityMatrix()),i.rotation4m4(this._physicalModel.getRotationMatrixInverse()))),this._turningMatrix},C.prototype.getMaxAcceleration=function(){return this._propulsion?this._propulsion.getThrust()/this._physicalModel.getMass():null},C.prototype.getMaxAngularAcceleration=function(){return this._propulsion?this._propulsion.getAngularThrust()/this._physicalModel.getMass():0},C.prototype.getMaxThrusterMoveBurnLevel=function(){return this._propulsion?this._propulsion.getMaxMoveBurnLevel():0},C.prototype.getMaxThrusterTurnBurnLevel=function(){return this._propulsion?this._propulsion.getMaxTurnBurnLevel():0},C.prototype.getMaxTurnRateAtSpeed=function(t){var e=Math.abs(this._propulsion.getThrust()/(this._physicalModel.getMass()*t));return 1>=e?Math.asin(e):Number.MAX_VALUE},C.prototype.getHitboxTextures=function(){var t=h.getShader(_.getSetting(_.BATTLE_SETTINGS.HITBOX_SHADER_NAME)).getManagedShader().getTextureTypes(),e=h.getTexture(_.getSetting(_.BATTLE_SETTINGS.HITBOX_TEXTURE_NAME));return e.getManagedTexturesOfTypes(t,u.getTextureQualityPreferenceList())},C.prototype.getNeededBurnForSpeedChange=function(t,e){return t*this._physicalModel.getMass()/this._propulsion.getThrust()*this._propulsion.getMaxMoveBurnLevel()/(e/1e3)},C.prototype.getNeededBurnForAngularVelocityChange=function(t,e){return t/a.ANGULAR_VELOCITY_MATRIX_DURATION_S*this._physicalModel.getMass()/this._propulsion.getAngularThrust()*this._propulsion.getMaxTurnBurnLevel()/(e/1e3)},C.prototype.loadFromJSON=function(t,e,n){var o;this._init(c.getSpacecraftClass(t["class"]),t.name,i.translation4v(t.position),i.rotation4FromJSON(t.rotations),e,void 0,n),t.squad&&this.setSquad(t.squad.name,t.squad.index),t.equipment?t.equipment.profile?this.equipProfile(this._class.getEquipmentProfile(t.equipment.profile)):(o=new c.EquipmentProfile(t.equipment),this.equipProfile(o)):void 0!==this._class.getEquipmentProfile(_.getSetting(_.BATTLE_SETTINGS.DEFAULT_EQUIPMENT_PROFILE_NAME))&&this.equipProfile(this._class.getEquipmentProfile(_.getSetting(_.BATTLE_SETTINGS.DEFAULT_EQUIPMENT_PROFILE_NAME)))},C.prototype.setSpacecraftArray=function(t){this._spacecraftArray=t},C.prototype.moveByVector=function(t){this._physicalModel.moveByVector(t)},C.prototype.getFlightMode=function(){return this._maneuveringComputer.getFlightMode()},C.prototype.changeFlightMode=function(){this._maneuveringComputer.changeFlightMode()},C.prototype.forward=function(t){this._maneuveringComputer.forward(t)},C.prototype.stopForward=function(){this._maneuveringComputer.stopForward()},C.prototype.reverse=function(t){this._maneuveringComputer.reverse(t)},C.prototype.stopReverse=function(){this._maneuveringComputer.stopReverse()},C.prototype.strafeLeft=function(t){this._maneuveringComputer.strafeLeft(t)},C.prototype.stopLeftStrafe=function(){this._maneuveringComputer.stopLeftStrafe()},C.prototype.strafeRight=function(t){this._maneuveringComputer.strafeRight(t)},C.prototype.stopRightStrafe=function(){this._maneuveringComputer.stopRightStrafe()},C.prototype.raise=function(t){this._maneuveringComputer.raise(t)},C.prototype.stopRaise=function(){this._maneuveringComputer.stopRaise()},C.prototype.lower=function(t){this._maneuveringComputer.lower(t)},C.prototype.stopLower=function(){this._maneuveringComputer.stopLower()},C.prototype.resetSpeed=function(){this._maneuveringComputer.resetSpeed()},C.prototype.setSpeedTarget=function(t){this._maneuveringComputer.setSpeedTarget(t)},C.prototype.getSpeedTarget=function(){return this._maneuveringComputer.getSpeedTarget()},C.prototype.hasSpeedTarget=function(){return this._maneuveringComputer.hasSpeedTarget()},C.prototype.yawLeft=function(t){this._maneuveringComputer.yawLeft(t)},C.prototype.yawRight=function(t){this._maneuveringComputer.yawRight(t)},C.prototype.pitchUp=function(t){this._maneuveringComputer.pitchUp(t)},C.prototype.pitchDown=function(t){this._maneuveringComputer.pitchDown(t)},C.prototype.rollLeft=function(t){this._maneuveringComputer.rollLeft(t)},C.prototype.rollRight=function(t){this._maneuveringComputer.rollRight(t)},C.prototype._addHitboxModel=function(t){var e=h.getOrAddModel(s.cuboidModel(this._class.getName()+H+t,this._class.getBodies()[t].getWidth(),this._class.getBodies()[t].getHeight(),this._class.getBodies()[t].getDepth(),F)),n=new l.ShadedLODMesh(e.getEgomModel(),h.getShader(_.getSetting(_.BATTLE_SETTINGS.HITBOX_SHADER_NAME)).getManagedShader(),this.getHitboxTextures(),i.translation4m4(this._class.getBodies()[t]._positionMatrix),this._class.getBodies()[t]._orientationMatrix,i.identity4(),!1);n.setUniformValueFunction(l.UNIFORM_COLOR_NAME,function(){return F}),n.setUniformValueFunction(Z,function(){return $}),this._hitbox.addSubnode(new l.RenderableNode(n))},C.prototype.acquireResources=function(t,e,i){n.log("Requesting resources for spacecraft ("+this._class.getName()+")...",2);var o=void 0===t?{maxLOD:u.getMaxLoadedLOD()}:{lod:t};e&&(h.getShader(_.getSetting(_.BATTLE_SETTINGS.HITBOX_SHADER_NAME)),h.getTexture(_.getSetting(_.BATTLE_SETTINGS.HITBOX_TEXTURE_NAME))),o.omitShader=i,this._class.acquireResources(o)},C.prototype.addToScene=function(t,e,o,s,a,c,p){var d,g,f;if(s=s||{},a=a||{},this.acquireResources(e,s&&s.hitboxes===!0,!!a.shaderName),a.shaderName&&u.getShader(a.shaderName),s.weapons===!0)for(d=0;d<this._weapons.length;d++)this._weapons[d].acquireResources(e,s.projectileResources);if(s.thrusterParticles===!0&&this._propulsion&&(this._propulsion.addThrusters(this._class.getThrusterSlots()),this._propulsion.acquireResources()),s.explosion===!0&&this._class.getExplosionClass().acquireResources(),s.blinkers===!0)for(g=this._class.getBlinkers(),d=0;d<g.length;d++)g[d].acquireResources();h.executeWhenReady(function(){var h,m,y,T,S,M,E,b={};for(n.log("Adding spacecraft ("+this._class.getName()+") to scene...",2),b[Z]=r.ShaderVariableType.MAT4,u.areLuminosityTexturesAvailable()&&(b[K]=r.ShaderVariableType.FLOAT),f=new l.ParameterizedMesh(this._class.getModel(),a.shaderName?u.getManagedShader(a.shaderName):this._class.getShader(),this._class.getTexturesOfTypes(this._class.getShader().getTextureTypes(),u.getTextureQualityPreferenceList()),a.positionMatrix||this._physicalModel._positionMatrix,a.orientationMatrix||this._physicalModel._orientationMatrix,i.scaling4(this._class.getModel().getScale()),o===!0,e,b),this._visualModel||(this._visualModel=f),this._name&&f.setName(this._name),M=this._class.getFactionColor(),E=this._team&&this._team.getColor()||M,f.setUniformValueFunction(X,function(){return M}),f.setUniformValueFunction(Y,function(){return E}),d=0,m=u.getMaxGroupTransforms();m>d;d++)f.setMat4Parameter(Z,d,i.identity4());if(u.areLuminosityTexturesAvailable())for(h=0,m=u.getMaxLuminosityFactors();m>h;h++)f.setFloatParameter(K,h,this._class.getDefaultGroupLuminosity(h));if(y=t.addObject(f),s.hitboxes===!0){for(this._hitbox=new l.RenderableNode(new l.RenderableObject3D(this._class.getShader(),!1,!1)),d=0;d<this._class.getBodies().length;d++)this._addHitboxModel(d);this._hitbox.hide(),y.addSubnode(this._hitbox)}if(s.weapons===!0)for(d=0;d<this._weapons.length;d++)this._weapons[d].addToScene(y,e,o,a.shaderName,p);if(s.thrusterParticles===!0&&this._propulsion&&this._propulsion.addToScene(y),s.projectileResources===!0)for(d=0;d<this._weapons.length;d++)this._weapons[d].addProjectileResourcesToScene(t);if(s.explosion===!0&&(T=new x(this._class.getExplosionClass(),i.identity4(),i.identity4(),[0,0,0],!0),T.addResourcesToScene(t)),s.cameraConfigurations===!0&&this._addCameraConfigurationsForViews(),s.lightSources===!0)for(S=this._class.getLightSources(),d=0;d<S.length;d++)S[d].spotDirection?t.addSpotLightSource(new l.SpotLightSource(S[d].color,S[d].intensity,S[d].position,S[d].spotDirection,S[d].spotCutoffAngle,S[d].spotFullIntensityAngle,[f])):t.addPointLightSource(new l.PointLightSource(S[d].color,S[d].intensity,S[d].position,[f]),j);if(s.blinkers===!0)for(g=this._class.getBlinkers(),d=0;d<g.length;d++)y.addSubnode(new l.RenderableNode(new l.Particle(g[d].getParticle().getModel(),g[d].getParticle().getShader(),g[d].getParticle().getTexturesOfTypes(g[d].getParticle().getShader().getTextureTypes(),u.getTextureQualityPreferenceList()),i.translation4v(g[d].getPosition()),g[d].getParticleStates(),!0,g[d].getParticle().getInstancedShader(),0),!1,_.getSetting(_.BATTLE_SETTINGS.MINIMUM_BLINKER_PARTICLE_COUNT_FOR_INSTANCING))),s.lightSources===!0&&g[d].getIntensity()>0&&t.addPointLightSource(new l.PointLightSource(g[d].getLightColor(),0,g[d].getPosition(),[f],g[d].getLightStates(),!0),W);c&&c(f)}.bind(this))},C.prototype.createCameraConfigurationForView=function(t){var e,n,o=i.getYawAndPitch(t._orientationMatrix);return e=new l.CameraPositionConfiguration(!t.isMovable(),t.turnsAroundObjects(),t.movesRelativeToObject(),t.getPositionFollowedObjectsForObject(this._visualModel),t.startsWithRelativePosition(),i.matrix4(t._positionMatrix),t.getDistanceRange(),t.getConfines(),t.resetsWhenLeavingConfines()),n=new l.CameraOrientationConfiguration(!t.isTurnable(),t.pointsTowardsObjects(),t.isFPS(),t.getOrientationFollowedObjectsForObject(this._visualModel),i.matrix4(t._orientationMatrix),Math.degrees(o.yaw),Math.degrees(o.pitch),t.getAlphaRange(),t.getBetaRange(),t.getBaseOrientation()||_.getDefaultCameraBaseOrientation(),t.getPointToFallback()||_.getDefaultCameraPointToFallback()),new l.CameraConfiguration(t.getName(),e,n,t.getFOV()||_.getDefaultCameraFOV(),t.getFOVRange()||_.getDefaultCameraFOVRange(),t.getSpan()||_.getDefaultCameraSpan(),t.getSpanRange()||_.getDefaultCameraSpanRange(),t.resetsOnFocusChange())},C.prototype._addCameraConfigurationsForViews=function(){var t;for(t=0;t<this._class.getViews().length;t++)this._visualModel.getNode().addCameraConfiguration(this.createCameraConfigurationForView(this._class.getViews()[t]))},C.prototype.addWeapon=function(t){var e,i=this._class.getWeaponSlots();this._weapons.length<i.length&&(e=i[this._weapons.length],this._weapons.push(new b(t,this,e)))},C.prototype.addPropulsion=function(t){this._propulsion=new O(t,this._physicalModel),this._maneuveringComputer.updateForNewPropulsion(),this._maneuveringComputer.updateTurningLimit()},C.prototype.equipProfile=function(t){var e;if(t){for(e=0;e<t.getWeaponDescriptors().length;e++)this.addWeapon(c.getWeaponClass(t.getWeaponDescriptors()[e].className));null!==t.getPropulsionDescriptor()&&this.addPropulsion(c.getPropulsionClass(t.getPropulsionDescriptor().className))}else n.log("WARNING: equipping empty profile on "+this._class.getName()+"!")},C.prototype.fire=function(t){var e,i,n=!1;for(i=this.getScaledOriMatrix(),e=0;e<this._weapons.length;e++)n=this._weapons[e].fire(this._projectilePool,i,t)||n;if(n)for(e=0;e<this._targetedBy.length;e++)this._targetedBy[e].handleTargetFired()},C.prototype._setBeingTargeted=function(t){this._targetedBy.push(t),this.handleBeingTargeted(t)},C.prototype._setBeingUntargeted=function(t){this._targetedBy.splice(this._targetedBy.indexOf(t),1)},C.prototype.setTarget=function(t){var e,i;if(t!==this._target){if(this._target&&this._target._setBeingUntargeted(this),this._target=t,this._targetHitPosition=null,this._visualModel)for(i=this._visualModel.getNode().getCameraConfigurationsWithName(_.getSetting(_.BATTLE_SETTINGS.TARGET_VIEW_NAME)),e=0;e<i.length;e++)this._visualModel.getNode()._scene.getCamera().getConfiguration()===i[e]&&this._visualModel.getNode()._scene.getCamera().transitionToSameConfiguration(_.getSetting(_.BATTLE_SETTINGS.TARGET_CHANGE_TRANSITION_DURATION),_.getSetting(_.BATTLE_SETTINGS.TARGET_CHANGE_TRANSITION_STYLE)),i[e].setOrientationFollowedObjects(this._target?[this._target._visualModel]:[],!0);this._target&&this._target._setBeingTargeted(this)}},C.prototype.targetNext=function(){var t;this._spacecraftArray&&this._spacecraftArray.length>0&&(t=(this._spacecraftArray.indexOf(this._target)+1)%this._spacecraftArray.length,this._spacecraftArray[t]===this&&(t=(t+1)%this._spacecraftArray.length),this._spacecraftArray[t]!==this&&this.setTarget(this._spacecraftArray[t]))},C.prototype.targetNextHostile=function(){var t,e;if(this._spacecraftArray&&this._spacecraftArray.length>0)for(t=(this._spacecraftArray.indexOf(this._target)+1)%this._spacecraftArray.length,e=0;e<this._spacecraftArray.length;){if(this._spacecraftArray[t]!==this&&this._spacecraftArray[t].isHostile(this))return void this.setTarget(this._spacecraftArray[t]);t=(t+1)%this._spacecraftArray.length,e++}},C.prototype.targetNextNonHostile=function(){var t,e;if(this._spacecraftArray&&this._spacecraftArray.length>0)for(t=(this._spacecraftArray.indexOf(this._target)+1)%this._spacecraftArray.length,e=0;e<this._spacecraftArray.length;){if(this._spacecraftArray[t]!==this&&!this._spacecraftArray[t].isHostile(this))return void this.setTarget(this._spacecraftArray[t]);t=(t+1)%this._spacecraftArray.length,e++}},C.prototype.getTarget=function(){return this._target&&this._target.canBeReused()&&this.setTarget(null),this._target},C.prototype.getTargetHitPosition=function(){var n,o,r,s,a,h,l,u,c;if(!this._targetHitPosition){for(n=this.getPhysicalPositionVector(),o=this._target.getPhysicalPositionVector(),r=e.diff3(i.translationVector3(this._target.getVelocityMatrix()),i.translationVector3(this.getVelocityMatrix())),s=this._weapons[0].getProjectileVelocity(),a=s*s-(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]),h=0,u=0;3>u;u++)h+=2*r[u]*(n[u]-o[u]);for(l=0,u=0;3>u;u++)l+=-o[u]*o[u]-n[u]*n[u]+2*o[u]*n[u];c=t.getGreaterSolutionOfQuadraticEquation(a,h,l),this._targetHitPosition=[o[0]+c*r[0],o[1]+c*r[1],o[2]+c*r[2]]}return this._targetHitPosition},C.prototype.resetThrusterBurn=function(){this._propulsion.resetThrusterBurn()},C.prototype.addThrusterBurn=function(t,e){this._propulsion.addThrusterBurn(t,e)},C.prototype.showHitbox=function(){this._hitbox.show()},C.prototype.hideHitbox=function(){this._hitbox.hide()},C.prototype.toggleHitboxVisibility=function(){this._hitbox.toggleVisibility()},C.prototype.resetViewCameras=function(){this._visualModel.getNode().resetCameraConfigurations()},C.prototype.damage=function(t,e,n,o){var r,s,a,h;if(this._hitpoints-=Math.max(0,t-this._class.getArmor()),this._hitpoints<0)this._hitpoints=0;else for(r=0;r<this._class.getDamageIndicators().length;r++)s=this._class.getDamageIndicators()[r],a=s.hullIntegrity/100*this._class.getHitpoints(),this._hitpoints<=a&&this._hitpoints+t>a&&(h=new x(s.explosionClass,i.translation4v(e),i.identity4(),n,!0),h.addToScene(this._visualModel.getNode()._scene,this._visualModel.getNode()),this._activeDamageIndicators.push(h));this.handleBeingHit(o,e),o.getTarget()===this&&o.handleTargetHit(),o.handleAnySpacecraftHit(this)},C.prototype.aimWeapons=function(t,e,i){var n,o;for(this._target&&this._weapons.length>0&&(n=this.getTargetHitPosition()),o=0;o<this._weapons.length;o++)this._target?this._weapons[o].aimTowards(n,t,e,this.getScaledOriMatrix(),i):this._weapons[o].rotateToDefaultPosition(t,i)},C.prototype.simulate=function(t){var e,n;if(this._alive){if(this._target&&this._target.canBeReused()&&this.setTarget(null),this._hitpoints<=0){if(this._timeElapsedSinceDestruction<0)for(this._timeElapsedSinceDestruction=0,n=new x(this._class.getExplosionClass(),i.matrix4(this._physicalModel._positionMatrix),i.matrix4(this._physicalModel._orientationMatrix),i.getRowC43(this._physicalModel._positionMatrix),!0,i.matrix4(this._physicalModel.getVelocityMatrix())),n.addToScene(this._visualModel.getNode()._scene),e=0;e<this._activeDamageIndicators;e++)this._activeDamageIndicators[e].finish();else if(this._timeElapsedSinceDestruction+=t,this._timeElapsedSinceDestruction>this._class.getExplosionClass().getTotalDuration()*this._class.getShowTimeRatioDuringExplosion())return void this.destroy()}else{for(e=0;e<this._weapons.length;e++)this._weapons[e].simulate(t);this._propulsion&&(this._maneuveringComputer.controlThrusters(t),this._propulsion.simulate(t))}this._physicalModel.simulate(t),this._targetHitPosition=null,this._relativeVelocityMatrix=null,this._turningMatrix=null,this._visualModel.setPositionMatrix(this._physicalModel._positionMatrix),this._visualModel.setOrientationMatrix(this._physicalModel._orientationMatrix),this._propulsion&&this._maneuveringComputer.updateSpeedIncrement(t)}},C.prototype.setOnBeingTargeted=function(t){this._onBeingTargeted=t},C.prototype.handleBeingTargeted=function(){this._onBeingTargeted&&this._onBeingTargeted()},C.prototype.setOnBeingHit=function(t){this._onBeingHit=t},C.prototype.handleBeingHit=function(t,e){this._onBeingHit&&this._onBeingHit(t,e)},C.prototype.setOnTargetHit=function(t){this._onTargetHit=t},C.prototype.handleTargetHit=function(){this._onTargetHit&&this._onTargetHit()},C.prototype.setOnAnySpacecraftHit=function(t){this._onAnySpacecraftHit=t},C.prototype.handleAnySpacecraftHit=function(t){this._onAnySpacecraftHit&&this._onAnySpacecraftHit(t)},C.prototype.setOnTargetFired=function(t){this._onTargetFired=t},C.prototype.handleTargetFired=function(){this._onTargetFired&&this._onTargetFired()},C.prototype.destroy=function(){var t;if(this._class=null,this._weapons)for(t=0;t<this._weapons.length;t++)this._weapons[t]&&(this._weapons[t].destroy(),this._weapons[t]=null);if(this._weapons=null,this._propulsion&&(this._propulsion.destroy(),this._propulsion=null),this._maneuveringComputer&&(this._maneuveringComputer.destroy(),this._maneuveringComputer=null),this._projectilePool=null,this._spacecraftArray=null,this._target=null,this._targetHitPosition=null,this._hitbox&&this._hitbox.markAsReusable(),this._hitbox=null,this._visualModel&&this._visualModel.getNode()&&this._visualModel.getNode().markAsReusable(),this._visualModel=null,this._physicalModel=null,this._activeDamageIndicators){for(t=0;t<this._activeDamageIndicators.length;t++)this._activeDamageIndicators[t].destroy(),this._activeDamageIndicators[t]=null;this._activeDamageIndicators=null}this._alive=!1},I.prototype._calculateCenter=function(t){var e,i,n,o,r=0,s=0,a=0;for(t&&(n=this._objects[0]._physicalModel._positionMatrix,o=this._objects[0]._physicalModel.getSize(),this._boundaries=[[n[0]-o,n[0]+o],[n[1]-o,n[1]+o],[n[2]-o,n[2]+o]]),e=0,i=this._objects.length;i>e;e++)n=this._objects[e]._physicalModel._positionMatrix,r+=n[12],s+=n[13],a+=n[14],t&&(o=this._objects[e]._physicalModel.getSize(),n[12]-o<this._boundaries[0][0]&&(this._boundaries[0][0]=n[12]-o),n[12]+o>this._boundaries[0][1]&&(this._boundaries[0][1]=n[12]+o),n[13]-o<this._boundaries[1][0]&&(this._boundaries[1][0]=n[13]-o),n[13]+o>this._boundaries[1][1]&&(this._boundaries[1][1]=n[13]+o),n[14]-o<this._boundaries[2][0]&&(this._boundaries[2][0]=n[14]-o),n[14]+o>this._boundaries[2][1]&&(this._boundaries[2][1]=n[14]+o));r/=i,s/=i,a/=i,this._center=[r,s,a]},I.prototype._generateSubnodes=function(e,i){var n,o,r,s,a,h,l,u,c,_,p,d,g,f;for(n=0,o=this._objects.length;o>n;n++)s=this._objects[n],a=s._physicalModel._positionMatrix,r=s._physicalModel.getSize(),a[12]-r<this._center[0]&&(a[13]-r<this._center[1]&&(a[14]-r<this._center[2]&&(h=h||[],h.push(s)),a[14]+r>=this._center[2]&&(l=l||[],l.push(s))),a[13]+r>=this._center[1]&&(a[14]-r<this._center[2]&&(u=u||[],u.push(s)),a[14]+r>=this._center[2]&&(c=c||[],
c.push(s)))),a[12]+r>=this._center[0]&&(a[13]-r<this._center[1]&&(a[14]-r<this._center[2]&&(_=_||[],_.push(s)),a[14]+r>=this._center[2]&&(p=p||[],p.push(s))),a[13]+r>=this._center[1]&&(a[14]-r<this._center[2]&&(d=d||[],d.push(s)),a[14]+r>=this._center[2]&&(g=g||[],g.push(s))));return f=new Array(8),f[0]=new I(h||t.EMPTY_ARRAY,e,i,!1),f[1]=new I(l||t.EMPTY_ARRAY,e,i,!1),f[2]=new I(u||t.EMPTY_ARRAY,e,i,!1),f[3]=new I(c||t.EMPTY_ARRAY,e,i,!1),f[4]=new I(_||t.EMPTY_ARRAY,e,i,!1),f[5]=new I(p||t.EMPTY_ARRAY,e,i,!1),f[6]=new I(d||t.EMPTY_ARRAY,e,i,!1),f[7]=new I(g||t.EMPTY_ARRAY,e,i,!1),f},I.prototype.getObjects=function(e,i,n,o,r,s){var a;return this._subnodes?this._boundaries&&(i<this._boundaries[0][0]||e>this._boundaries[0][1]||o<this._boundaries[1][0]||n>this._boundaries[1][1]||s<this._boundaries[2][0]||r>this._boundaries[2][1])?t.EMPTY_ARRAY:(a=[],e<this._center[0]&&(n<this._center[1]&&(r<this._center[2]&&(a=a.concat(this._subnodes[0].getObjects(e,i,n,o,r,s))),s>=this._center[2]&&(a=a.concat(this._subnodes[1].getObjects(e,i,n,o,r,s)))),o>=this._center[1]&&(r<this._center[2]&&(a=a.concat(this._subnodes[2].getObjects(e,i,n,o,r,s))),s>=this._center[2]&&(a=a.concat(this._subnodes[3].getObjects(e,i,n,o,r,s))))),i>=this._center[0]&&(n<this._center[1]&&(r<this._center[2]&&(a=a.concat(this._subnodes[4].getObjects(e,i,n,o,r,s))),s>=this._center[2]&&(a=a.concat(this._subnodes[5].getObjects(e,i,n,o,r,s)))),o>=this._center[1]&&(r<this._center[2]&&(a=a.concat(this._subnodes[6].getObjects(e,i,n,o,r,s))),s>=this._center[2]&&(a=a.concat(this._subnodes[7].getObjects(e,i,n,o,r,s))))),a):this._objects},L.prototype.markAsFree=function(t){this._objectsFree[t]||(this._freeIndices[this._firstLockedIndex]=t,this._objectsFree[t]=!0,this._firstLockedIndex++,this._firstLockedIndex>=this._freeIndices.length&&(this._firstLockedIndex=0))},L.prototype.getFreeObject=function(){var t;return this._objectsFree[this._freeIndices[this._firstFreeIndex]]?(this._objectsFree[this._freeIndices[this._firstFreeIndex]]=!1,t=this._objects[this._freeIndices[this._firstFreeIndex]],this._firstFreeIndex++,this._firstFreeIndex>=this._freeIndices.length&&(this._firstFreeIndex=0),t):null},L.prototype.addObject=function(t){this._objects.push(t),this._objectsFree.push(!1),this._firstFreeIndex<this._firstLockedIndex||this._firstFreeIndex===this._firstLockedIndex&&!this._objectsFree[this._freeIndices[this._firstFreeIndex]]?this._freeIndices.push(-1):(this._freeIndices.splice(this._firstLockedIndex,0,-1),this._firstFreeIndex++,this._firstFreeIndex>=this._freeIndices.length&&(this._firstFreeIndex=0))},L.prototype.getObjects=function(){return this._objects},L.prototype.clear=function(){this._objects=[],this._objectsFree=[],this._freeIndices=[],this._firstFreeIndex=0,this._firstLockedIndex=0},N.prototype.getPilotedSpacecraft=function(){return null===this._pilotedCraft||this._pilotedCraft.canBeReused()?null:this._pilotedCraft},N.prototype.getSpacecraft=function(t){var e;for(e=0;e<this._spacecrafts.length;e++)if(this._spacecrafts[e].getID()===t)return this._spacecrafts[e];return null},N.prototype.isWon=function(){var t,e=this.getPilotedSpacecraft();if(e){for(t=0;t<this._spacecrafts.length;t++)if(this._spacecrafts[t]&&!this._spacecrafts[t].canBeReused()&&e.isHostile(this._spacecrafts[t]))return!1;return!0}return!1},N.prototype.isLost=function(){return!this._pilotedCraft||this._pilotedCraft.canBeReused()},N.prototype._spacecraftHasVisualModel=function(t,e){return e._visualModel===t},N.prototype.getFollowedSpacecraftForScene=function(t){return t.getCamera().getFollowedNode()?this._spacecrafts.find(this._spacecraftHasVisualModel.bind(this,t.getCamera().getFollowedNode()._renderableObject)):null},N.prototype.getTeam=function(t){var e;for(e=0;e<this._teams.length;e++)if(this._teams[e].getID()===t)return this._teams[e];return n.showError("No team exists with ID '"+t+"'!"),null},N.prototype.requestLoadFromFile=function(t,e,i){n.requestTextFile(_.getConfigurationSetting(_.CONFIGURATION.LEVEL_FILES).folder,t,function(t){this.loadFromJSON(JSON.parse(t),e),i&&i()}.bind(this))},N.prototype.loadFromJSON=function(t,e){var i,o,r,s,a;if(n.log("Loading level from JSON file...",2),t.environment.createFrom?(this._environment=U.getEnvironment(t.environment.createFrom),this._environment||n.showError("Cannot load environment '"+t.environment.createFrom+"' for level: no such environment exists!"),this._ownsEnvironment=!1):(this._environment=new S(t.environment),this._ownsEnvironment=!0),this._teams=[],t.teams)for(i=0;i<t.teams.length;i++)this._teams.push(new v(t.teams[i]));if(this._views=[],t.views)for(i=0;i<t.views.length;i++)this._views.push(new c.SceneView(t.views[i]));for(this._projectilePool=new L,this._spacecrafts=[],d.clearAIs(),i=0;i<t.spacecrafts.length;i++)o=new C,o.loadFromJSON(t.spacecrafts[i],this._projectilePool,this._spacecrafts),!e&&t.spacecrafts[i].piloted&&(this._pilotedCraft=o),a=t.spacecrafts[i].ai,!a&&e&&(a=o.isFighter()?_.getSetting(_.BATTLE_SETTINGS.DEMO_FIGHTER_AI_TYPE):_.getSetting(_.BATTLE_SETTINGS.DEMO_SHIP_AI_TYPE)),a&&d.addAI(a,o),r=t.spacecrafts[i].team,r?(s=this.getTeam(r),s?o.setTeam(s):n.showError("Invalid team ID '"+r+"' specified for "+o.getClassName()+"!")):e&&(s=new v({name:q,id:(this._teams.length+1).toString()}),this._teams.push(s),o.setTeam(s)),this._spacecrafts.push(o);for(i=0;i<t.spacecrafts.length;i++)t.spacecrafts[i].initialTarget&&this._spacecrafts[i].setTarget(this.getSpacecraft(t.spacecrafts[i].initialTarget));this._randomShips=t.randomShips||{},this._randomShipsMapSize=t.randomShipsMapSize,this._randomShipsHeadingAngle=t.randomShipsHeadingAngle||0,this._randomShipsRandomHeading=t.randomShipsRandomHeading||!1,this._randomShipsEquipmentProfileName=t.randomShipsEquipmentProfileName||_.BATTLE_SETTINGS.DEFAULT_EQUIPMENT_PROFILE_NAME,n.log("Level successfully loaded.",2)},N.prototype.addRandomShips=function(t,e){var n,o,r,s,a,h,l=i.rotation4([0,0,1],Math.radians(this._randomShipsHeadingAngle));t=t||_.getSetting(_.GENERAL_SETTINGS.DEFAULT_RANDOM_SEED),n=Math.seed(t);for(o in this._randomShips)if(this._randomShips.hasOwnProperty(o))for(a=0;a<this._randomShips[o];a++)h=l?i.matrix4(l):i.identity4(),this._randomShipsRandomHeading&&i.mul4(h,i.rotation4(i.getRowC4(h),n()*Math.PI*2)),r=new C(c.getSpacecraftClass(o),"",i.translation4(n()*this._randomShipsMapSize-this._randomShipsMapSize/2,n()*this._randomShipsMapSize-this._randomShipsMapSize/2,n()*this._randomShipsMapSize-this._randomShipsMapSize/2),h,this._projectilePool,this._randomShipsEquipmentProfileName,this._spacecrafts),e&&(r.isFighter()?d.addAI(_.getSetting(_.BATTLE_SETTINGS.DEMO_FIGHTER_AI_TYPE),r):d.addAI(_.getSetting(_.BATTLE_SETTINGS.DEMO_SHIP_AI_TYPE),r),s=new v({name:q,id:(this._teams.length+1).toString()}),this._teams.push(s),r.setTeam(s)),this._spacecrafts.push(r)},N.prototype.createCameraConfigurationForSceneView=function(t,e){var n,o,r=i.getYawAndPitch(t._orientationMatrix);return n=new l.CameraPositionConfiguration(!t.isMovable(),t.turnsAroundObjects(),t.movesRelativeToObject(),t.getPositionFollowedObjectsForScene(e),t.startsWithRelativePosition(),i.matrix4(t._positionMatrix),t.getDistanceRange(),t.getConfines(),t.resetsWhenLeavingConfines()),o=new l.CameraOrientationConfiguration(!t.isTurnable(),t.pointsTowardsObjects(),t.isFPS(),t.getOrientationFollowedObjectsForScene(e),i.matrix4(t._orientationMatrix),Math.degrees(r.yaw),Math.degrees(r.pitch),t.getAlphaRange(),t.getBetaRange(),t.getBaseOrientation()||_.getDefaultCameraBaseOrientation(),t.getPointToFallback()||_.getDefaultCameraPointToFallback()),new l.CameraConfiguration(t.getName(),n,o,t.getFOV()||_.getDefaultCameraFOV(),t.getFOVRange()||_.getDefaultCameraFOVRange(),t.getSpan()||_.getDefaultCameraSpan(),t.getSpanRange()||_.getDefaultCameraSpanRange(),t.resetsOnFocusChange())},N.prototype.addToScene=function(t,e){var i;for(this._environment&&this._environment.addToScene(t),this._hitObjects=[],i=0;i<this._spacecrafts.length;i++)this._spacecrafts[i].addToScene(t,void 0,!1,{hitboxes:!0,weapons:!0,thrusterParticles:!0,projectileResources:!0,explosion:!0,cameraConfigurations:!0,lightSources:!0,blinkers:!0}),e&&this._spacecrafts[i].addToScene(e,u.getMaxLoadedLOD(),!0,{weapons:!0},{shaderName:_.getSetting(_.BATTLE_SETTINGS.HUD_TARGET_VIEW_TARGET_ITEM_SHADER)}),this._hitObjects.push(this._spacecrafts[i]);h.executeWhenReady(function(){for(i=0;i<this._views.length;i++)t.addCameraConfiguration(this.createCameraConfigurationForSceneView(this._views[i],t)),0===i&&(t.getCamera().followNode(null,!0,0),t.getCamera().update(0))}.bind(this))},N.prototype.toggleHitboxVisibility=function(){var t;for(t=0;t<this._spacecrafts.length;t++)this._spacecrafts[t].toggleHitboxVisibility()},N.prototype.tick=function(t,e){var i,o,r,s,a;for(this._environment&&this._environment.simulate(),i=0;i<this._spacecrafts.length;i++)this._spacecrafts[i].simulate(t),void 0===this._spacecrafts[i]||this._spacecrafts[i].canBeReused()?(this._spacecrafts[i].destroy(),this._spacecrafts[i]=null,this._spacecrafts.splice(i,1),this._hitObjects[i]=null,this._hitObjects.splice(i,1),i--):V&&this._spacecrafts[i].hideHitbox();if(s=this._projectilePool.getObjects(),s.length>0)for(r=new I(this._hitObjects,2,1,!0),i=0;i<s.length;i++)s[i].simulate(t,r),s[i].canBeReused()&&this._projectilePool.markAsFree(i);for(a=P.getObjects(),i=0;i<a.length;i++)a[i].canBeReused()&&P.markAsFree(i);e&&(o=e.moveCameraToOrigoIfNeeded(_.getSetting(_.BATTLE_SETTINGS.MOVE_TO_ORIGO_DISTANCE)),o&&d.handleSceneMoved(o)),n.isDebugVersion()&&(it="Part: "+P._objects.length+"<br/>Proj: "+this._projectilePool._objects.length)},N.prototype.destroy=function(){var t,e;if(this._environment&&this._ownsEnvironment&&this._environment.destroy(),this._environment=null,this._views){for(t=0;t<this._views.length;t++)this._views[t]&&(this._views[t].destroy(),this._views[t]=null);this._spacecrafts=null}if(this._spacecrafts){for(t=0;t<this._spacecrafts.length;t++)this._spacecrafts[t]&&(this._spacecrafts[t].destroy(),this._spacecrafts[t]=null);this._spacecrafts=null}if(this._projectilePool){for(e=this._projectilePool.getObjects(),t=0;t<e.length;t++)e[t]&&(e[t].destroy(),e[t]=null);this._projectilePool=null}this._pilotedCraft=null,this._hitObjects=null,P.clear()},P=new L,U=new M,_.executeWhenReady(function(){var t;for(Q=_.getSetting(_.BATTLE_SETTINGS.SELF_FIRE),J=_.getSetting(_.BATTLE_SETTINGS.MOMENT_DURATION),K=_.getSetting(_.GENERAL_SETTINGS.UNIFORM_LUMINOSITY_FACTORS_ARRAY_NAME),Z=_.getSetting(_.GENERAL_SETTINGS.UNIFORM_GROUP_TRANSFORMS_ARRAY_NAME),$=new Float32Array(16*u.getMaxGroupTransforms()),t=0;t<$.length;t++)$[t]=i.IDENTITY4[t%16];tt=_.getSetting(_.BATTLE_SETTINGS.MINIMUM_MUZZLE_FLASH_PARTICLE_COUNT_FOR_INSTANCING),et=_.getSetting(_.BATTLE_SETTINGS.MINIMUM_PROJECTILE_COUNT_FOR_INSTANCING),w=_.getSetting(_.BATTLE_SETTINGS.COMPENSATED_FORWARD_SPEED_FACTOR),D=_.getSetting(_.BATTLE_SETTINGS.COMPENSATED_REVERSE_SPEED_FACTOR),F=_.getSetting(_.BATTLE_SETTINGS.HITBOX_COLOR),V=_.getSetting(_.BATTLE_SETTINGS.SHOW_HITBOXES_FOR_HITCHECKS)}),{FlightMode:B,requestEnvironmentsLoad:U.requestEnvironmentsLoad.bind(U),executeWhenReady:U.executeWhenReady.bind(U),getDebugInfo:g,Spacecraft:C,Level:N}}),define("modules/control",["utils/utils","modules/application","modules/async-resource","modules/strings"],function(t,e,i,n){"use strict";function o(t){it=t}function r(t){this._actionName="string"==typeof t?t:null,"object"==typeof t&&this.loadFromJSON(t)}function s(t,e){this._listening=!1,this._enabled=!0,this._bindingClass=t,this._bindings={},void 0!==e&&this.loadFromJSON(e)}function a(i,n,o,s,a){this._key=n||null,this._keyCode=t.getKeyCodeOf(n),this._shiftState=void 0===o?!1:o||this._keyCode===y,this._ctrlState=void 0===s?!1:s||this._keyCode===T,this._altState=void 0===a?!1:a||this._keyCode===S,r.call(this,i),e.log("Created key binding: "+this._actionName+" - "+this.getControlString(),3)}function h(t){s.call(this,a,t),this._currentlyPressedKeys=new Array(256)}function l(t){this._buttonIndex=0,this._moveX=0,this._moveY=0,this._measuredFromCenter=!1,this._scrollX=0,this._scrollY=0,r.call(this,t)}function u(t){this._currentlyPressedButtons=[!1,!1,!1],this._screenCenter=[0,0],this._screenSize=0,this._mousePosition=[-1,-1],this._mousePositionChange=[0,0],this._scrollChange=[0,0],this._moveSensitivity=0,this._displacementAreaRelativeSize=0,this._displacementFactor=1,this._displacementDeadzone=0,s.call(this,l,t)}function c(t){this._button=this.BUTTON_NONE,this._axisIndex=this.AXIS_NONE,this._axisPositive=!1,r.call(this,t)}function _(t){this._sensitivityFactor=t.sensitivityFactor||0,this._staticSensitivity=t.staticSensitivity===!0,this._quadraticIntensity=t.quadraticSensitivity===!0,this._actionNames=t.actionNames,this._sensitivityFactor&&this._staticSensitivity&&e.showError("Sensitivity action group defined with both factored and static sensitivity!",e.ErrorSeverity.MINOR)}function p(t){this._gamepad=null,this._sensitivityActionGroups=null,s.call(this,c,t)}function d(t){this._name=null,this._description=null,this._continuous=!1,this._triggered=!1,this._intensity=this.INTENSITY_NOT_SPECIFIED,this._executed=!1,this._nonTriggeredExecuted=!0,this._executeTriggered=null,this._executeNonTriggered=null,void 0!==t&&this.loadFromJSON(t)}function g(t){this._context=null,this._actions={},void 0!==t&&this.loadFromJSON(t)}function f(){i.AsyncResource.call(this),this._dataJSON=null,this._inputInterpreterTypes={},this._inputInterpreters=null,this._inputInterpretersByType={},this._controllerTypes={},this._controllers=null,this._controllersPriorityQueue=null,this._controllersByType={},this._listening=!1,this._disabledActions={}}var m={NONE:"none",LEFT:"left",MIDDLE:"middle",RIGHT:"right"},y=16,T=17,S=18,M=" + ",x="_key",E="_shift",b="_ctrl",A="_alt",O=[m.NONE,m.LEFT,m.MIDDLE,m.RIGHT],R="left",v="right",C="up",I="down",L="_button",N="_moveX",w="_moveY",D="_measuredFromCenter",F="_scrollX",V="_scrollY",P="_gamepad_button",U="_gamepad_axisIndex",B="_gamepad_axisPositive",G={name:"key"+n.CATEGORY_SEPARATOR},H={name:"mouse"+n.CATEGORY_SEPARATOR+"leftButton",defaultValue:"left click"},j={name:"mouse"+n.CATEGORY_SEPARATOR+"rightButton",defaultValue:"right click"},k={name:"mouse"+n.CATEGORY_SEPARATOR+"middleButton",defaultValue:"middle click"},z={name:"mouse"+n.CATEGORY_SEPARATOR+"fromCenter",defaultValue:"{move} {toDirection} from center"},W={name:"mouse"+n.CATEGORY_SEPARATOR+"notFromCenter",defaultValue:"{move} {toDirection}"},q={name:"mouse"+n.CATEGORY_SEPARATOR+"move",defaultValue:"move"},X={name:"mouse"+n.CATEGORY_SEPARATOR+"leftDirection",defaultValue:"left"},Y={name:"mouse"+n.CATEGORY_SEPARATOR+"rightDirection",defaultValue:"right"},Q={name:"mouse"+n.CATEGORY_SEPARATOR+"upDirection",defaultValue:"up"},J={name:"mouse"+n.CATEGORY_SEPARATOR+"downDirection",defaultValue:"down"},K={name:"mouse"+n.CATEGORY_SEPARATOR+"scroll",defaultValue:"scroll"},Z={name:"joystick"+n.CATEGORY_SEPARATOR+"button",defaultValue:"button {index}"},$={name:"joystick"+n.CATEGORY_SEPARATOR+"axis",defaultValue:"axis {index} {direction}"},tt={name:"joystick"+n.CATEGORY_SEPARATOR+"positiveDirection",defaultValue:"positive"},et={name:"joystick"+n.CATEGORY_SEPARATOR+"negativeDirection",defaultValue:"negative"},it="";return r.prototype.getActionName=function(){return this._actionName},r.prototype.getControlString=function(){return e.showError("Cannot get control string of generic control binding!"),null},r.prototype.loadFromJSON=function(t){this._actionName=t.action},r.prototype.saveToLocalStorage=function(){e.showError("Cannot save generic control binding to local storage!")},r.prototype.loadFromLocalStorage=function(){e.showError("Cannot load generic control binding from local storage!")},r.prototype.removeFromLocalStorage=function(){e.showError("Cannot remove generic control binding from local storage!")},r.prototype.bindsTheSameControls=function(){return e.showError("Cannot check if generic control binds the same controls as another binding!"),!0},s.prototype.getDeviceName=function(){return"Generic"},s.prototype.resetState=function(){e.showError("Cannot reset the state of a generic input interpreter!")},s.prototype.isListening=function(){return this._listening},s.prototype.startListening=function(){this._listening||(this.resetState(),this._listening=!0)},s.prototype.stopListening=function(){this._listening&&(this.resetState(),this._listening=!1)},s.prototype.toggleListening=function(){this._listening?this.stopListening():this.startListening()},s.prototype.isEnabled=function(){return this._enabled},s.prototype.enable=function(){this._enabled=!0},s.prototype.disable=function(){this._enabled=!1},s.prototype.toggleEnabled=function(){this._enabled?this.disable():this.enable()},s.prototype.setBinding=function(t){this._bindings[t.getActionName()]=t},s.prototype.setAndStoreBinding=function(t){this.setBinding(t),t.saveToLocalStorage()},s.prototype.loadFromJSON=function(t){var e;for(e=0;e<t.bindings.length;e++)this.setBinding(new this._bindingClass(t.bindings[e]))},s.prototype.loadFromLocalStorage=function(){var t;for(t in this._bindings)this._bindings.hasOwnProperty(t)&&this._bindings[t].loadFromLocalStorage()},s.prototype.removeFromLocalStorage=function(){var t;for(t in this._bindings)this._bindings.hasOwnProperty(t)&&this._bindings[t].removeFromLocalStorage()},s.prototype.getControlStringForAction=function(t){return void 0!==this._bindings[t]?this._bindings[t].getControlString():""},s.prototype._addActionByBinding=function(t,e,i){var n;if(e){for(n=0;n<t.length;n++)if(i.bindsTheSameControls(t[n].binding))return void t[n].actions.push(e);t.push({binding:i,actions:[e]})}},s.prototype.checkAction=function(t){e.showError("Cannot check if action '"+t+"' is triggered with a generic input interpreter!")},s.prototype.getTriggeredActions=function(t){var e,i,n=[],o=[];if(!this.isListening()||!this.isEnabled())return n;for(e in this._bindings)this._bindings.hasOwnProperty(e)&&(!t||t(e))&&this._addActionByBinding(o,this.checkAction(e),this._bindings[e]);for(i=0;i<o.length;i++)n.push(o[i].actions);return n},a.prototype=new r,a.prototype.constructor=a,a.prototype.loadFromJSON=function(t){r.prototype.loadFromJSON.call(this,t),this.setKey(t.key),this._shiftState=t.shift===!0||this._keyCode===y,this._ctrlState=t.ctrl===!0||this._keyCode===T,this._altState=t.alt===!0||this._keyCode===S},a.prototype.saveToLocalStorage=function(){localStorage[it+this._actionName+x]=this._key,localStorage[it+this._actionName+E]=this._shiftState,localStorage[it+this._actionName+b]=this._ctrlState,localStorage[it+this._actionName+A]=this._altState},a.prototype.loadFromLocalStorage=function(){void 0!==localStorage[it+this._actionName+x]&&(this.setKey(localStorage[it+this._actionName+x]),this._shiftState="true"===localStorage[it+this._actionName+E],this._ctrlState="true"===localStorage[it+this._actionName+b],this._altState="true"===localStorage[it+this._actionName+A])},a.prototype.removeFromLocalStorage=function(){localStorage.removeItem(it+this._actionName+x),localStorage.removeItem(it+this._actionName+E),localStorage.removeItem(it+this._actionName+b),localStorage.removeItem(it+this._actionName+A)},a.prototype.getKey=function(){return this._key},a.prototype.setKey=function(e){this._key=e,this._keyCode=t.getKeyCodeOf(this._key)},a.prototype.getShiftState=function(){return this._shiftState},a.prototype.getCtrlState=function(){return this._ctrlState},a.prototype.getAltState=function(){return this._altState},a.prototype.getControlString=function(){var e,i;return e=n.get(G,this._key,this._key),this._shiftState&&this._keyCode!==y&&(i=t.getKeyOfCode(y),i=n.get(G,i,i),e=i+M+e),this._ctrlState&&this._keyCode!==T&&(i=t.getKeyOfCode(T),i=n.get(G,i,i),e=i+M+e),this._altState&&this._keyCode!==S&&(i=t.getKeyOfCode(S),i=n.get(G,i,i),e=i+M+e),e},a.prototype.isTriggered=function(t){return t[this._keyCode]&&(t[y]||!this._shiftState)&&(t[T]||!this._ctrlState)&&(t[S]||!this._altState)},a.prototype.bindsTheSameControls=function(t){return this._keyCode===t._keyCode},h.prototype=new s,h.prototype.constructor=h,h.prototype.getDeviceName=function(){return"keyboard"},h.prototype.resetState=function(){var t;for(t=0;t<this._currentlyPressedKeys.length;t++)this._currentlyPressedKeys[t]=!1},h.prototype.defaultActionEnabledForKey=function(e){return["f5","f11","escape"].indexOf(t.getKeyOfCode(e))>=0},h.prototype.handleKeyDown=function(t){this._currentlyPressedKeys[t.keyCode]=!0,this.defaultActionEnabledForKey(t.keyCode)||(t.preventDefault(),t.stopPropagation())},h.prototype.handleKeyUp=function(t){this._currentlyPressedKeys[t.keyCode]=!1,this.defaultActionEnabledForKey(t.keyCode)||(t.preventDefault(),t.stopPropagation())},h.prototype.startListening=function(){s.prototype.startListening.call(this),document.onkeydown=function(t){this.handleKeyDown(t)}.bind(this),document.onkeyup=function(t){this.handleKeyUp(t)}.bind(this),document.onkeypress=function(t){this.defaultActionEnabledForKey(t.keyCode)||(t.preventDefault(),t.stopPropagation())}.bind(this)},h.prototype.stopListening=function(){s.prototype.stopListening.call(this),document.onkeydown=null,document.onkeyup=null},h.prototype.checkAction=function(t){return this._bindings[t].isTriggered(this._currentlyPressedKeys)?{name:t}:null},l.prototype=new r,l.prototype.constructor=l,l.prototype.loadFromJSON=function(t){switch(r.prototype.loadFromJSON.call(this,t),this._buttonIndex=O.indexOf(t.button),this._moveX=0,this._moveY=0,t.move){case R:this._moveX=-1;break;case v:this._moveX=1;break;case C:this._moveY=-1;break;case I:this._moveY=1}switch(this._measuredFromCenter=t.fromCenter===!0,this._scrollX=0,this._scrollY=0,t.scroll){case R:this._scrollX=-1;break;case v:this._scrollX=1;break;case C:this._scrollY=-1;break;case I:this._scrollY=1}},l.prototype.saveToLocalStorage=function(){localStorage[it+this._actionName+L]=this._buttonIndex,localStorage[it+this._actionName+N]=this._moveX,localStorage[it+this._actionName+w]=this._moveY,localStorage[it+this._actionName+D]=this._measuredFromCenter,localStorage[it+this._actionName+F]=this._scrollX,localStorage[it+this._actionName+V]=this._scrollY},l.prototype.loadFromLocalStorage=function(){void 0!==localStorage[it+this._actionName+L]&&(this._buttonIndex=parseInt(localStorage[it+this._actionName+L],10),this._moveX=parseInt(localStorage[it+this._actionName+N],10),this._moveY=parseInt(localStorage[it+this._actionName+w],10),this._measuredFromCenter="true"===localStorage[it+this._actionName+D],this._scrollX=parseInt(localStorage[it+this._actionName+F],10),this._scrollY=parseInt(localStorage[it+this._actionName+V],10))},l.prototype.removeFromLocalStorage=function(){localStorage.removeItem(it+this._actionName+L),localStorage.removeItem(it+this._actionName+N),localStorage.removeItem(it+this._actionName+w),localStorage.removeItem(it+this._actionName+D),localStorage.removeItem(it+this._actionName+F),localStorage.removeItem(it+this._actionName+V)},l.prototype.isMeasuredFromCenter=function(){return this._measuredFromCenter},l.prototype.getControlString=function(){var e="",i=null;switch(O[this._buttonIndex]){case m.LEFT:return n.get(H);case m.MIDDLE:return n.get(k);case m.RIGHT:return n.get(j)}return e=this._measuredFromCenter?n.get(z):n.get(W),this._moveX<0?i=n.get(X):this._moveX>0?i=n.get(Y):this._moveY<0?i=n.get(Q):this._moveY>0&&(i=n.get(J)),i?e=t.formatString(e,{move:n.get(q),toDirection:i}):(i=null,e=n.get(W),this._scrollX<0?i=n.get(X):this._scrollX>0?i=n.get(Y):this._scrollY<0?i=n.get(Q):this._scrollY>0&&(i=n.get(J)),i&&(e=t.formatString(e,{move:n.get(K),toDirection:i})),e)},l.prototype.getTriggeredIntensity=function(t,e,i,n,o){var r,s;return this._buttonIndex>0?t[this._buttonIndex]===!0?1:-1:e?(r=this._measuredFromCenter?e[0]>=0?e[0]-n[0]:0:i[0],0!==this._moveX?r*this._moveX:(s=this._measuredFromCenter?e[1]>=0?e[1]-n[1]:0:i[1],0!==this._moveY?s*this._moveY:0!==this._scrollX?o[0]*this._scrollX:0!==this._scrollY?o[1]*this._scrollY:void 0)):0},l.prototype.bindsTheSameControls=function(t){return this._buttonIndex===t._buttonIndex&&(0===this._moveX&&0===t._moveX||this._moveX*t._moveX!==0)&&(0===this._moveY&&0===t._moveY||this._moveY*t._moveY!==0)&&(0===this._scrollX&&0===t._scrollX||this._scrollX*t._scrollX!==0)&&(0===this._scrollY&&0===t._scrollY||this._scrollY*t._scrollY!==0)},u.prototype=new s,u.prototype.constructor=u,u.prototype._updateDisplacementFactor=function(){this._displacementFactor=1/((this._screenSize||1)*this._displacementAreaRelativeSize)},u.prototype.setScreenCenter=function(t,e){this._screenCenter=[t,e],this._screenSize=Math.min(t,e),this._updateDisplacementFactor(),this._mousePosition=[t,e],this._mousePositionChange=[0,0],this._scrollChange=[0,0]},u.prototype.getDeviceName=function(){return"mouse"},u.prototype.resetState=function(){var t;for(t=0;t<this._currentlyPressedButtons.length;t++)this._currentlyPressedButtons[t]=!1;this._mousePosition=[-1,-1],this._mousePositionChange=[0,0],this._scrollChange=[0,0]},u.prototype.setAndStoreMoveSensitivity=function(t){this._moveSensitivity=t,localStorage[it+"mouse_moveSensitivity"]=this._moveSensitivity},u.prototype.setAndStoreDisplacementAreaRelativeSize=function(t){this._displacementAreaRelativeSize=t,this._updateDisplacementFactor(),localStorage[it+"mouse_displacementAreaRelativeSize"]=this._displacementAreaRelativeSize},u.prototype.setAndStoreDisplacementDeadzone=function(t){this._displacementDeadzone=t,localStorage[it+"mouse_displacementDeadzone"]=this._displacementDeadzone},u.prototype.loadFromJSON=function(t){s.prototype.loadFromJSON.call(this,t),this._moveSensitivity=t.sensitivityProfile.moveSensitivity,this._displacementAreaRelativeSize=t.sensitivityProfile.displacementAreaRelativeSize,this._updateDisplacementFactor(),this._displacementDeadzone=t.sensitivityProfile.displacementDeadzone},u.prototype.loadFromLocalStorage=function(){s.prototype.loadFromLocalStorage.call(this),void 0!==localStorage[it+"mouse_moveSensitivity"]&&(this._moveSensitivity=parseFloat(localStorage[it+"mouse_moveSensitivity"])),void 0!==localStorage[it+"mouse_displacementAreaRelativeSize"]&&(this._displacementAreaRelativeSize=parseFloat(localStorage[it+"mouse_displacementAreaRelativeSize"]),this._updateDisplacementFactor()),void 0!==localStorage[it+"mouse_displacementDeadzone"]&&(this._displacementDeadzone=parseInt(localStorage[it+"mouse_displacementDeadzone"],10))},u.prototype.removeFromLocalStorage=function(){s.prototype.removeFromLocalStorage.call(this),localStorage.removeItem(it+"mouse_moveSensitivity"),localStorage.removeItem(it+"mouse_displacementAreaRelativeSize"),localStorage.removeItem(it+"mouse_displacementDeadzone")},u.prototype.handleMouseDown=function(t){return this._currentlyPressedButtons[t.which]=!0,t.preventDefault(),!1},u.prototype.handleMouseUp=function(t){return this._currentlyPressedButtons[t.which]=!1,t.preventDefault(),!1},u.prototype.handleMouseMove=function(t){this._mousePosition[0]>=0&&(this._mousePositionChange[0]+=t.clientX-this._mousePosition[0],this._mousePositionChange[1]+=t.clientY-this._mousePosition[1]),this._mousePosition=[t.clientX,t.clientY]},u.prototype.handleWheel=function(t){this._scrollChange[0]+=t.deltaX,this._scrollChange[1]+=t.deltaY},u.prototype.startListening=function(){s.prototype.startListening.call(this),document.onmousedown=function(t){this.handleMouseDown(t)}.bind(this),document.onmouseup=function(t){this.handleMouseUp(t)}.bind(this),document.onmousemove=function(t){this.handleMouseMove(t)}.bind(this),document.onwheel=function(t){this.handleWheel(t)}.bind(this),document.onclick=function(t){return t.preventDefault(),!1},document.oncontextmenu=function(t){return t.preventDefault(),!1}},u.prototype.stopListening=function(){s.prototype.stopListening.call(this),document.onmousedown=null,document.onmouseup=null,document.onmousemove=null,document.onwheel=null,document.onclick=null,document.oncontextmenu=null},u.prototype.checkAction=function(t){var e=this._bindings[t].getTriggeredIntensity(this._currentlyPressedButtons,this._mousePosition,this._mousePositionChange,this._screenCenter,this._scrollChange);return e>=0?{name:t,intensity:this._bindings[t].isMeasuredFromCenter()===!0?Math.min(1,Math.max(0,e-this._displacementDeadzone)*this._displacementFactor):e*this._moveSensitivity}:null},u.prototype.getTriggeredActions=function(t){var e=s.prototype.getTriggeredActions.call(this,t);return this._mousePositionChange=[0,0],this._scrollChange=[0,0],e},u.prototype.getMousePosition=function(){return this._mousePosition},u.prototype.isMouseDisplaced=function(){return Math.abs(this._mousePosition[0]-this._screenCenter[0])>this._displacementDeadzone||Math.abs(this._mousePosition[1]-this._screenCenter[1])>this._displacementDeadzone},c.prototype=new r,c.prototype.constructor=c,c.prototype.BUTTON_NONE=-1,c.prototype.AXIS_NONE=-1,c.prototype.loadFromJSON=function(t){r.prototype.loadFromJSON.call(this,t),"number"==typeof t.button&&(this._button=t.button),"string"==typeof t.axis&&(this._axisIndex=Math.abs(parseInt(t.axis,10)),this._axisPositive="-"!==t.axis[0])},c.prototype.saveToLocalStorage=function(){localStorage[it+this._actionName+P]=this._button,localStorage[it+this._actionName+U]=this._axisIndex,localStorage[it+this._actionName+B]=this._axisPositive},c.prototype.loadFromLocalStorage=function(){void 0!==localStorage[it+this._actionName+P]&&(this._button=parseInt(localStorage[it+this._actionName+P],10),this._axisIndex=parseInt(localStorage[it+this._actionName+P],10),this._axisPositive="true"===localStorage[it+this._actionName+B])},c.prototype.removeFromLocalStorage=function(){localStorage.removeItem(it+this._actionName+P),localStorage.removeItem(it+this._actionName+U),localStorage.removeItem(it+this._actionName+B)},c.prototype.getTriggeredIntensity=function(t){return t?this._button!==this.BUTTON_NONE?1===t.buttons[this._button]||"object"==typeof t.buttons[this._button]&&t.buttons[this._button].pressed?1:0:this._axisIndex!==this.AXIS_NONE?Math.max(t.axes[this._axisIndex]*(this._axisPositive?1:-1),0):0:0},c.prototype.getControlString=function(){return this._button!==this.BUTTON_NONE?t.formatString(n.get(Z),{index:this._button+1}):this._axisIndex!==this.AXIS_NONE?t.formatString(n.get($),{index:this._axisIndex+1,direction:this._axisPositive?n.get(tt):n.get(et)}):""},c.prototype.bindsTheSameControls=function(t){return this._button===t._button&&this._axisIndex===t._axisIndex},_.prototype.getIntensityForAction=function(t,e){return this._actionNames.indexOf(e)>=0?this._staticSensitivity?void 0:t*(this._quadraticIntensity?t:1)*this._sensitivityFactor:-1},p.prototype=new s,p.prototype.constructor=p,p.prototype.getDeviceName=function(){return"joystick"},p.prototype.resetState=function(){this._gamepad=null},p.prototype.loadFromJSON=function(t){var e;if(s.prototype.loadFromJSON.call(this,t),this._sensitivityActionGroups=[],t.sensitivityProfile&&t.sensitivityProfile.actionGroups)for(e=0;e<t.sensitivityProfile.actionGroups.length;e++)this._sensitivityActionGroups.push(new _(t.sensitivityProfile.actionGroups[e]))},p.prototype.handleGamepadConnected=function(t){this._gamepad||(this._gamepad=t.gamepad)},p.prototype.startListening=function(){s.prototype.startListening.call(this),window.addEventListener("gamepadconnected",function(t){this.handleGamepadConnected(t)}.bind(this))},p.prototype.stopListening=function(){s.prototype.stopListening.call(this),window.ongamepadconnected=null},p.prototype.checkAction=function(t){var e,i,n;if(e=this._bindings[t].getTriggeredIntensity(this._gamepad),e>0){for(i=0;i<this._sensitivityActionGroups.length;i++)if(n=this._sensitivityActionGroups[i].getIntensityForAction(e,t),void 0===n||n>0)return{name:t,intensity:n};return{name:t,intensity:e}}return null},p.prototype.getTriggeredActions=function(t){var e;return this.isListening()?(e=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[],e&&e.length>0?this._gamepad=e[0]:this._gamepad=null,this._gamepad?s.prototype.getTriggeredActions.call(this,t):[]):[]},d.prototype.INTENSITY_NOT_SPECIFIED=-3,d.prototype.INTENSITY_KEYPRESS=-2,
d.prototype.getName=function(){return this._name},d.prototype.getDescription=function(){return this._description},d.prototype.loadFromJSON=function(t){this._name=t.name,this._description=t.description,this._continuous=t.continuous===!0,this._triggered=!1,this._intensity=this.INTENSITY_NOT_SPECIFIED,this._executed=!1,this._nonTriggeredExecuted=!0},d.prototype.setTriggered=function(t,e){this._triggered=t,void 0!==e&&(this._intensity===this.INTENSITY_NOT_SPECIFIED||this._intensity>=0&&e>this._intensity)?this._intensity=e:void 0===e&&(this._intensity=this.INTENSITY_KEYPRESS)},d.prototype.setExecuteTriggered=function(t){this._executeTriggered=t},d.prototype.setExecuteNonTriggered=function(t){this._executeNonTriggered=t},d.prototype.execute=function(){this._continuous===!0?this._triggered===!0?null!==this._executeTriggered&&this._executeTriggered(this._intensity>=0?this._intensity:void 0):null!==this._executeNonTriggered&&this._executeNonTriggered():this._triggered===!0&&this._executed===!1?(null!==this._executeTriggered&&this._executeTriggered(this._intensity>=0?this._intensity:void 0),this._executed=!0):(this._triggered===!1&&this._nonTriggeredExecuted===!1&&(null!==this._executeNonTriggered&&this._executeNonTriggered(),this._nonTriggeredExecuted=!0),this._triggered===!1?this._executed=!1:this._nonTriggeredExecuted=!1),this._triggered=!1,this._intensity=this.INTENSITY_NOT_SPECIFIED},g.prototype.setContext=function(t){this._context=t},g.prototype.getType=function(){return e.showError("Attempting to get the type of a generic controller object!"),"none (generic)"},g.prototype.getActions=function(){var t,e=[];for(t in this._actions)this._actions.hasOwnProperty(t)&&e.push(this._actions[t]);return e},g.prototype.loadFromJSON=function(t){var e;for(e=0;e<t.actions.length;e++)this._actions[t.actions[e].name]=new d(t.actions[e])},g.prototype.setActionFunction=function(t,i,n){this._actions[t]?i===!0?this._actions[t].setExecuteTriggered(n):this._actions[t].setExecuteNonTriggered(n):e.showError("Attempting to initialize action '"+t+"', but no such action was defined for '"+this.getType()+"' type controllers.",e.ErrorSeverity.SEVERE,"The action definition might be missing from the settings file, or the settings file has not been loaded properly. The game is still playable, but this action will not work until the error with the settings file is corrected and the game is restarted.")},g.prototype.setActionFunctions=function(t,e,i){this.setActionFunction(t,!0,e),this.setActionFunction(t,!1,i)},g.prototype.executeActions=function(t){var e,i,n,o;for(e=0;e<t.length;e++){for(n=null,o=-1,i=0;i<t[e].length;i++)void 0!==this._actions[t[e][i].name]&&(void 0!==t[e][i].intensity&&void 0!==o&&t[e][i].intensity>o||void 0!==o&&void 0===t[e][i].intensity)&&(n=t[e][i].name,o=t[e][i].intensity);n&&((void 0===o||o>0)&&this._actions[n].setTriggered(!0,o),t[e]=[])}for(n in this._actions)this._actions.hasOwnProperty(n)&&this._actions[n].execute()},f.prototype=new i.AsyncResource,f.prototype.constructor=f,f.prototype.registerInputInterpreterType=function(t,e){this._inputInterpreterTypes[t]=e},f.prototype.addInputInterpreter=function(i){var n=t.getKeyOfValue(this._inputInterpreterTypes,i.constructor);n?(this._inputInterpreters.push(i),this._inputInterpretersByType[n]=i):e.showError("Attempting to add an input interpreter of an unregistered type to the control context!",e.ErrorSeverity.SEVERE,"Interpreter type: "+i.constructor.name)},f.prototype.getInputInterpreters=function(){return this._inputInterpreters},f.prototype.getInputInterpreter=function(t){return this._inputInterpretersByType[t]?this._inputInterpretersByType[t]:(e.showError("Asked for a interpreter of type '"+t+"', which does not exist!"),null)},f.prototype.registerControllerType=function(t,e){this._controllerTypes[t]=e},f.prototype.addController=function(i){var n=t.getKeyOfValue(this._controllerTypes,i.constructor);n?(this._controllers.push(i),this._controllersByType[n]=i,i.setContext(this)):e.showError("Attempting to add a controller of an unregistered type to the control context!",e.ErrorSeverity.SEVERE,"Controller type: "+i.prototype.constructor.name)},f.prototype.getControllers=function(){return this._controllers},f.prototype.getController=function(t){return this._controllersByType[t]?this._controllersByType[t]:(e.showError("Asked for a controller of type '"+t+"', which does not exist!"),null)},f.prototype.makeControllerPriority=function(t){var e;for(this._controllersPriorityQueue=[],e=0;e<this._controllers.length;e++)if(this._controllers[e]===t){this._controllersPriorityQueue.push(this._controllers[e]);break}for(e=0;e<this._controllers.length;e++)this._controllers[e]!==t&&this._controllersPriorityQueue.push(this._controllers[e])},f.prototype.isControllerPriority=function(t){return this._controllersPriorityQueue.length>0&&this._controllersPriorityQueue[0]===this.getController(t)},f.prototype.restoreDefaultControllerPriorityOrder=function(){this._controllersPriorityQueue=this._controllers},f.prototype.disableAction=function(t){this._disabledActions[t]=!0},f.prototype.enableAction=function(t){this._disabledActions[t]=!1},f.prototype.control=function(t){var e,i,n=function(t){return!this._disabledActions[t]}.bind(this);if(this._listening){for(i=[],e=0;e<this._inputInterpreters.length;e++)i=i.concat(this._inputInterpreters[e].getTriggeredActions(n));for(e=0;e<this._controllersPriorityQueue.length;e++)this._controllersPriorityQueue[e].executeActions(i,t)}},f.prototype.loadConfigurationFromJSON=function(t){var i,n;for(this._controllers=[],i=0,n=t.controllers.length;n>i;i++)this._controllerTypes[t.controllers[i].type]?this.addController(new this._controllerTypes[t.controllers[i].type](t.controllers[i])):e.showError("Attempting to load unregistered controller type: '"+t.controllers[i].type+"'!",e.ErrorSeverity.SEVERE,Object.keys(this._controllerTypes).length>0?"Every controller to be loaded must be of one of the registered types: "+Object.keys(this._controllerTypes).join(", ")+".":"There are no types registered and thus loading controllers is not possible.");this._controllersPriorityQueue=this._controllers},f.prototype.loadSettingsFromJSON=function(t,i){var n,o;if(i)for(n=0,o=t.inputDevices.length;o>n;n++)this._inputInterpreters[n].removeFromLocalStorage(),this._inputInterpreters[n].loadFromJSON(t.inputDevices[n]);else for(this._dataJSON=t,this._inputInterpreters=[],n=0,o=t.inputDevices.length;o>n;n++)this._inputInterpreterTypes[t.inputDevices[n].type]?this.addInputInterpreter(new this._inputInterpreterTypes[t.inputDevices[n].type](t.inputDevices[n])):e.showError("Attempting to load unregistered input device type: '"+t.inputDevices[n].type+"'!",e.ErrorSeverity.SEVERE,Object.keys(this._inputInterpreterTypes).length>0?"Every input device interpreter to be loaded must be of one of the registered types: "+Object.keys(this._inputInterpreterTypes).join(", ")+".":"There are no types registered and thus loading input interpreters is not possible.")},f.prototype.loadSettingsFromLocalStorage=function(){var t;for(t=0;t<this._inputInterpreters.length;t++)this._inputInterpreters[t].loadFromLocalStorage();this.setToReady()},f.prototype.restoreDefaults=function(){this.loadSettingsFromJSON(this._dataJSON,!0)},f.prototype.startListening=function(){this.executeWhenReady(function(){var t;for(t=0;t<this._inputInterpreters.length;t++)this._inputInterpreters[t].startListening();this._listening=!0})},f.prototype.stopListening=function(){this.executeWhenReady(function(){var t;for(t=0;t<this._inputInterpreters.length;t++)this._inputInterpreters[t].stopListening();this._listening=!1})},f.prototype.isListening=function(){return this._listening},f.prototype.setScreenCenter=function(t,e){this.executeWhenReady(function(){var i;for(i=0;i<this._inputInterpreters.length;i++)this._inputInterpreters[i].setScreenCenter&&this._inputInterpreters[i].setScreenCenter(t,e)})},{setModulePrefix:o,ControlBinding:r,KeyBinding:a,KeyboardInputInterpreter:h,MouseBinding:l,MouseInputInterpreter:u,GamepadBinding:c,GamepadInputInterpreter:p,Controller:g,ControlContext:f}}),define("modules/camera-controller",["utils/types","modules/application","modules/control","modules/buda-scene"],function(t,e,i,n){"use strict";function o(o){i.Controller.call(this,o),this._controlledCamera=null,this._controlledVelocityVector=[0,0,0],this._velocityTargetVector=[0,0,0],this._maxSpeed=o.maxSpeed||0,this._acceleration=o.acceleration||0,this._deceleration=o.deceleration||0,this._angularVelocityVector=[0,0,0],this._maxAngularVelocity=o.maxSpin||0,this._angularAcceleration=o.angularAcceleration||0,this._angularDeceleration=o.angularDeceleration||0,this._angularVelocityTargetVector=[0,0,0],this._objectChangeTransitionDuration=o.objectChangeTransitionDuration,this._viewChangeTransitionDuration=o.viewChangeTransitionDuration,this._viewResetTransitionDuration=o.viewResetTransitionDuration,this._transitionStyle=t.getEnumValue(n.Camera.prototype.TransitionStyle,o.transitionStyle,{name:"cameraController.transitionStyle"}),this.setActionFunctions("controlCamera",function(){this._context?this._context.makeControllerPriority(this):e.showError("Cannot make camera controller the priority controller because it is not added to any control context!")}.bind(this),function(){this._controlledCamera.getConfiguration().resetsOnFocusChange()&&this._controlledCamera.transitionToConfigurationDefaults(this._viewResetTransitionDuration,this._transitionStyle),this._context?this._context.restoreDefaultControllerPriorityOrder():e.showError("Cannot restore original priority order of the camera controller's context because it is not added to any!")}.bind(this)),this.setActionFunctions("cameraTurnLeft",function(t){void 0===t?this._angularVelocityTargetVector[1]>-this._maxAngularVelocity&&(this._angularVelocityTargetVector[1]=-this._maxAngularVelocity):(this._angularVelocityTargetVector[1]=-t,this._angularVelocityVector[1]=-t)}.bind(this),function(){this._angularVelocityTargetVector[1]<0&&(this._angularVelocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraTurnRight",function(t){void 0===t?this._angularVelocityTargetVector[1]<this._maxAngularVelocity&&(this._angularVelocityTargetVector[1]=this._maxAngularVelocity):(this._angularVelocityTargetVector[1]=t,this._angularVelocityVector[1]=t)}.bind(this),function(){this._angularVelocityTargetVector[1]>0&&(this._angularVelocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraTurnUp",function(t){void 0===t?this._angularVelocityTargetVector[0]>-this._maxAngularVelocity&&(this._angularVelocityTargetVector[0]=-this._maxAngularVelocity):(this._angularVelocityTargetVector[0]=-t,this._angularVelocityVector[0]=-t)}.bind(this),function(){this._angularVelocityTargetVector[0]<0&&(this._angularVelocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraTurnDown",function(t){void 0===t?this._angularVelocityTargetVector[0]<this._maxAngularVelocity&&(this._angularVelocityTargetVector[0]=this._maxAngularVelocity):(this._angularVelocityTargetVector[0]=t,this._angularVelocityVector[0]=t)}.bind(this),function(){this._angularVelocityTargetVector[0]>0&&(this._angularVelocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraRollLeft",function(t){void 0===t?this._angularVelocityTargetVector[2]>-this._maxAngularVelocity&&(this._angularVelocityTargetVector[2]=-this._maxAngularVelocity):(this._angularVelocityTargetVector[2]=-t,this._angularVelocityVector[2]=-t)}.bind(this),function(){this._angularVelocityTargetVector[2]<0&&(this._angularVelocityTargetVector[2]=0)}.bind(this)),this.setActionFunctions("cameraRollRight",function(t){void 0===t?this._angularVelocityTargetVector[2]<this._maxAngularVelocity&&(this._angularVelocityTargetVector[2]=this._maxAngularVelocity):(this._angularVelocityTargetVector[2]=t,this._angularVelocityVector[2]=t)}.bind(this),function(){this._angularVelocityTargetVector[2]>0&&(this._angularVelocityTargetVector[2]=0)}.bind(this)),this.setActionFunctions("cameraMoveLeft",function(){this._velocityTargetVector[0]>-this._maxSpeed&&(this._velocityTargetVector[0]=-this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[0]<0&&(this._velocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraMoveRight",function(){this._velocityTargetVector[0]<this._maxSpeed&&(this._velocityTargetVector[0]=this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[0]>0&&(this._velocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraMoveUp",function(){this._velocityTargetVector[1]<this._maxSpeed&&(this._velocityTargetVector[1]=this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[1]>0&&(this._velocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraMoveDown",function(){this._velocityTargetVector[1]>-this._maxSpeed&&(this._velocityTargetVector[1]=-this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[1]<0&&(this._velocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraMoveForward",function(){this._velocityTargetVector[2]>-this._maxSpeed&&(this._velocityTargetVector[2]=-this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[2]<0&&(this._velocityTargetVector[2]=0)}.bind(this)),this.setActionFunctions("cameraMoveBackward",function(){this._velocityTargetVector[2]<this._maxSpeed&&(this._velocityTargetVector[2]=this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[2]>0&&(this._velocityTargetVector[2]=0)}.bind(this)),this.setActionFunction("cameraDecreaseFOV",!0,function(){this._controlledCamera.decreaseFOV()}.bind(this)),this.setActionFunction("cameraIncreaseFOV",!0,function(){this._controlledCamera.increaseFOV()}.bind(this)),this.setActionFunction("nextView",!0,function(){this._controlledCamera.changeToNextView(this._viewChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("previousView",!0,function(){this._controlledCamera.changeToPreviousView(this._viewChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("followNext",!0,function(){this._controlledCamera.followNextNode(!0,this._objectChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("followPrevious",!0,function(){this._controlledCamera.followPreviousNode(!0,this._objectChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("resetView",!0,function(){this._controlledCamera.transitionToConfigurationDefaults(this._viewResetTransitionDuration,this._transitionStyle)}.bind(this))}return o.prototype=new i.Controller,o.prototype.constructor=o,o.prototype.getType=function(){return"camera"},o.prototype.setControlledCamera=function(t){this._controlledCamera=t},o.prototype.setCameraToFollowObject=function(t,e,i){this._controlledCamera.followObject(t,!1,e,i)},o.prototype.setToFreeCamera=function(){this._controlledCamera.setToFreeCamera(!1)},o.prototype._updateAngularVelocity=function(t){var e;for(e=0;e<this._angularVelocityVector.length;e++)this._angularVelocityVector[e]>=0?this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]?(this._angularVelocityVector[e]+=this._angularAcceleration*t/1e3,this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])):this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]-=this._angularDeceleration*t/1e3,this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])):this._angularVelocityVector[e]<0&&(this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]?(this._angularVelocityVector[e]-=this._angularAcceleration*t/1e3,this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])):this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]+=this._angularDeceleration*t/1e3,this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])))},o.prototype._updateVelocity=function(t){var e;for(e=0;e<this._controlledVelocityVector.length;e++)this._controlledVelocityVector[e]>=0?this._controlledVelocityVector[e]<this._velocityTargetVector[e]?(this._controlledVelocityVector[e]+=this._acceleration*t/1e3,this._controlledVelocityVector[e]>this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])):this._controlledVelocityVector[e]>this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]-=this._deceleration*t/1e3,this._controlledVelocityVector[e]<this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])):this._controlledVelocityVector[e]<0&&(this._controlledVelocityVector[e]>this._velocityTargetVector[e]?(this._controlledVelocityVector[e]-=this._acceleration*t/1e3,this._controlledVelocityVector[e]<this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])):this._controlledVelocityVector[e]<this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]+=this._deceleration*t/1e3,this._controlledVelocityVector[e]>this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])))},o.prototype.executeActions=function(t,e){this._controlledCamera&&(i.Controller.prototype.executeActions.call(this,t),this._updateAngularVelocity(e),this._updateVelocity(e),this._controlledCamera.setControlledVelocityVector(this._controlledVelocityVector),this._controlledCamera.setAngularVelocityVector(this._angularVelocityVector))},{CameraController:o}}),define("armada/screens/shared",[],function(){"use strict";return{SELECTOR_SOURCE:"selector.html",SELECTOR_CSS:"selector.css",LOADING_BOX_SOURCE:"loadingbox.html",LOADING_BOX_CSS:"loadingbox.css",INFO_BOX_SOURCE:"infobox.html",INFO_BOX_CSS:"infobox.css",MENU_COMPONENT_SOURCE:"menucomponent.html",MENU_CLASS_NAME:"menu",MENU_BUTTON_CLASS_NAME:"button",MENU_BUTTON_CONTAINER_CLASS_NAME:"transparentContainer",SUPERIMPOSE_BACKGROUND_COLOR:[.25,.25,.25,.5],SCREEN_BACKGROUND_CLASS_NAME:"fullScreenFix",SCREEN_CONTAINER_CLASS_NAME:"fullScreenContainer",MAIN_MENU_SCREEN_NAME:"mainMenu",MAIN_MENU_SCREEN_SOURCE:"menu.html",MAIN_MENU_CONTAINER_ID:"menuContainer",LEVEL_MENU_SCREEN_NAME:"levelMenu",LEVEL_MENU_SCREEN_SOURCE:"menu.html",LEVEL_MENU_CONTAINER_ID:"menuContainer",DEMO_LEVEL_MENU_SCREEN_NAME:"demoLevelMenu",DEMO_LEVEL_MENU_SCREEN_SOURCE:"menu.html",DEMO_LEVEL_MENU_CONTAINER_ID:"menuContainer",BATTLE_SCREEN_NAME:"battle",BATTLE_SCREEN_SOURCE:"battle.html",BATTLE_SCREEN_CSS:"battle.css",DATABASE_SCREEN_NAME:"database",DATABASE_SCREEN_SOURCE:"database.html",DATABASE_SCREEN_CSS:"database.css",SETTINGS_SCREEN_NAME:"settings",SETTINGS_SCREEN_SOURCE:"menu.html",SETTINGS_MENU_CONTAINER_ID:"menuContainer",GENERAL_SETTINGS_SCREEN_NAME:"generalSettings",GENERAL_SETTINGS_SCREEN_SOURCE:"general-settings.html",GRAPHICS_SCREEN_NAME:"graphics",GRAPHICS_SCREEN_SOURCE:"graphics.html",CONTROLS_SCREEN_NAME:"controls",CONTROLS_SCREEN_SOURCE:"controls.html",ABOUT_SCREEN_NAME:"about",ABOUT_SCREEN_SOURCE:"about.html",INGAME_MENU_SCREEN_NAME:"ingameMenu",INGAME_MENU_SCREEN_SOURCE:"ingame-menu.html",INGAME_MENU_SCREEN_CSS:"ingame-menu.css",INGAME_MENU_CONTAINER_ID:"menuContainer"}}),define("armada/control",["modules/control","modules/camera-controller","modules/game","armada/screens/shared","armada/strings","armada/configuration"],function(t,e,i,n,o,r){"use strict";function s(e){t.Controller.call(this,e),this._level=null,this._battle=null,this.setActionFunction("quit",!0,function(){this._battle.pauseBattle(),i.setScreen(n.INGAME_MENU_SCREEN_NAME,!0,n.SUPERIMPOSE_BACKGROUND_COLOR)}.bind(this)),this.setActionFunction("pause",!0,function(){i.getScreen().showMessage(o.get(o.BATTLE.MESSAGE_PAUSED))}),this.setActionFunction("stopTime",!0,function(){this._battle.toggleTime()}.bind(this)),this.setActionFunction("switchToPilotMode",!0,function(){u.switchToPilotMode(this._level.getPilotedSpacecraft())}.bind(this)),this.setActionFunction("switchToSpectatorMode",!0,function(){u.switchToSpectatorMode(!0,!0)}),this.setActionFunction("toggleHitboxVisibility",!0,function(){this._level.toggleHitboxVisibility()}.bind(this)),this.setActionFunction("toggleDevInfoVisibility",!0,function(){i.getScreen().toggleDevInfoVisibility()}),this.setActionFunction("toggleHUDVisibility",!0,function(){this._battle.toggleHUDVisibility()}.bind(this)),this.setActionFunction("toggleMouseControls",!0,function(){u.getInputInterpreter(_).toggleEnabled(),u.isInPilotMode()&&(u.getInputInterpreter(_).isEnabled()?document.body.style.cursor="none":document.body.style.cursor="default")}),this.setActionFunction("toggleJoystickControls",!0,function(){u.getInputInterpreter(p).toggleEnabled()})}function a(e){t.Controller.call(this,e),this._controlledSpacecraft=null,this._strafeSpeed=0,this._autoTargeting=!0,this._weaponAimThreshold=e.weaponAimThreshold,this.setActionFunction("fire",!0,function(){this._controlledSpacecraft.fire()}.bind(this)),this.setActionFunction("changeFlightMode",!0,function(){this._controlledSpacecraft.changeFlightMode()}.bind(this)),this.setActionFunction("nextHostileTarget",!0,function(){this._controlledSpacecraft.targetNextHostile()}.bind(this)),this.setActionFunction("nextNonHostileTarget",!0,function(){this._controlledSpacecraft.targetNextNonHostile()}.bind(this)),this.setActionFunction("toggleAutoTargeting",!0,function(){this._autoTargeting=!this._autoTargeting}.bind(this)),this.setActionFunctions("forward",function(t){this._controlledSpacecraft.forward(t)}.bind(this),function(){this._controlledSpacecraft.stopForward()}.bind(this)),this.setActionFunctions("reverse",function(t){this._controlledSpacecraft.reverse(t)}.bind(this),function(){this._controlledSpacecraft.stopReverse()}.bind(this)),this.setActionFunctions("strafeLeft",function(t){this._controlledSpacecraft.strafeLeft((void 0!==t?t:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopLeftStrafe()}.bind(this)),this.setActionFunctions("strafeRight",function(t){this._controlledSpacecraft.strafeRight((void 0!==t?t:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopRightStrafe()}.bind(this)),this.setActionFunctions("raise",function(t){this._controlledSpacecraft.raise((void 0!==t?t:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopRaise()}.bind(this)),this.setActionFunctions("lower",function(t){this._controlledSpacecraft.lower((void 0!==t?t:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopLower()}.bind(this)),this.setActionFunction("resetSpeed",!0,function(){this._controlledSpacecraft.resetSpeed()}.bind(this)),this.setActionFunction("yawLeft",!0,function(t){this._controlledSpacecraft.yawLeft(t)}.bind(this)),this.setActionFunction("yawRight",!0,function(t){this._controlledSpacecraft.yawRight(t)}.bind(this)),this.setActionFunction("pitchUp",!0,function(t){this._controlledSpacecraft.pitchUp(t)}.bind(this)),this.setActionFunction("pitchDown",!0,function(t){this._controlledSpacecraft.pitchDown(t)}.bind(this)),this.setActionFunction("rollLeft",!0,function(t){this._controlledSpacecraft.rollLeft(t)}.bind(this)),this.setActionFunction("rollRight",!0,function(t){this._controlledSpacecraft.rollRight(t)}.bind(this))}function h(){t.ControlContext.call(this),this._pilotingMode=!1,this.registerInputInterpreterType(c,t.KeyboardInputInterpreter),this.registerInputInterpreterType(_,t.MouseInputInterpreter),this.registerInputInterpreterType(p,t.GamepadInputInterpreter),this.registerControllerType(g,s),this.registerControllerType(f,a),this.registerControllerType(m,e.CameraController)}var l,u,c="keyboard",_="mouse",p="joystick",d=p,g="general",f="fighter",m="camera";return t.setModulePrefix("interstellarArmada_control_"),s.prototype=new t.Controller,s.prototype.constructor=s,s.prototype.getType=function(){return"general"},s.prototype.setLevel=function(t){this._level=t},s.prototype.setBattle=function(t){this._battle=t},a.prototype=new t.Controller,a.prototype.constructor=a,a.prototype.getType=function(){return"fighter"},a.prototype.setControlledSpacecraft=function(t){this._controlledSpacecraft=t,this._controlledSpacecraft&&(this._strafeSpeed=l*this._controlledSpacecraft.getMaxAcceleration())},a.prototype.executeActions=function(e,i){this._controlledSpacecraft&&(this._controlledSpacecraft.canBeReused()?this._controlledSpacecraft=null:(t.Controller.prototype.executeActions.call(this,e),this._autoTargeting&&!this._controlledSpacecraft.getTarget()&&this._controlledSpacecraft.targetNextHostile(),this._controlledSpacecraft.aimWeapons(this._weaponAimThreshold,0,i)))},h.prototype=new t.ControlContext,h.prototype.constructor=h,h.prototype.isInPilotMode=function(){return this._pilotingMode},h.prototype.switchToPilotMode=function(t){t&&!this._pilotingMode&&(this._pilotingMode=!0,this.getController(f).setControlledSpacecraft(t),this.getController(m).setCameraToFollowObject(t._visualModel,r.getSetting(r.BATTLE_SETTINGS.CAMERA_PILOTING_SWITCH_TRANSITION_DURATION),r.getSetting(r.BATTLE_SETTINGS.CAMERA_PILOTING_SWITCH_TRANSITION_STYLE)),this.disableAction("followNext"),this.disableAction("followPrevious"),i.getScreen().setHeaderContent(""),this.getInputInterpreter(_).isEnabled()&&(document.body.style.cursor="none"))},h.prototype.switchToSpectatorMode=function(t,e){(this._pilotingMode||e)&&(this._pilotingMode=!1,this.getController(f).setControlledSpacecraft(null),t&&this.getController(m).setToFreeCamera(!1),this.enableAction("followNext"),this.enableAction("followPrevious"),i.getScreen().setHeaderContent(o.get(o.BATTLE.SPECTATOR_MODE)),document.body.style.cursor="default")},u=new h,r.executeWhenReady(function(){l=r.getSetting(r.BATTLE_SETTINGS.STRAFE_SPEED_FACTOR)}),{KEYBOARD_NAME:c,MOUSE_NAME:_,JOYSTICK_NAME:p,GAMEPAD_NAME:d,GENERAL_CONTROLLER_NAME:g,FIGHTER_CONTROLLER_NAME:f,CAMERA_CONTROLLER_NAME:m,KeyBinding:t.KeyBinding,loadConfigurationFromJSON:u.loadConfigurationFromJSON.bind(u),loadSettingsFromJSON:u.loadSettingsFromJSON.bind(u),loadSettingsFromLocalStorage:u.loadSettingsFromLocalStorage.bind(u),restoreDefaults:u.restoreDefaults.bind(u),getControllers:u.getControllers.bind(u),getController:u.getController.bind(u),isControllerPriority:u.isControllerPriority.bind(u),getInputInterpreters:u.getInputInterpreters.bind(u),getInputInterpreter:u.getInputInterpreter.bind(u),control:u.control.bind(u),startListening:u.startListening.bind(u),stopListening:u.stopListening.bind(u),isListening:u.isListening.bind(u),setScreenCenter:u.setScreenCenter.bind(u),executeWhenReady:u.executeWhenReady.bind(u),isInPilotMode:u.isInPilotMode.bind(u),switchToPilotMode:u.switchToPilotMode.bind(u),switchToSpectatorMode:u.switchToSpectatorMode.bind(u)}}),define("armada/armada",["modules/game","modules/components","armada/constants","armada/graphics","armada/configuration","armada/logic","armada/control","armada/strings"],function(t,e,i,n,o,r,s,a){"use strict";var h=document.getElementById("progress");return h.max=5,t.setGameName(i.GAME_NAME),t.setStartScreenName("mainMenu"),t.setConfigFolder("config/"),t.setConfigFileName("config.json"),t.setFileCacheBypassEnabled(0),t.setPreviouslyRunVersion(localStorage[i.VERSION_LOCAL_STORAGE_ID]),t._loadGameSettingsAndExecuteCallback=function(t,e){n.loadSettingsFromJSON(t.graphics),n.loadSettingsFromLocalStorage(),o.loadSettingsFromJSON(t.logic),s.loadSettingsFromJSON(t.control),s.loadSettingsFromLocalStorage(),o.executeWhenReady(function(){r.requestEnvironmentsLoad(),r.executeWhenReady(function(){h.value=2,e()})})},t._loadGameConfigurationAndExecuteCallback=function(t,e){o.loadConfigurationFromJSON(t.dataFiles.logic),n.loadConfigurationFromJSON(t.graphics),s.loadConfigurationFromJSON(t.control),h.value=1,e()},t._buildScreensAndExecuteCallback=function(n){require(["armada/screens/menus","armada/screens/battle","armada/screens/database","armada/screens/general-settings","armada/screens/graphics-settings","armada/screens/control-settings","armada/screens/about"],function(o,r,s,l,u,c,_){t.addScreen(o.mainMenuScreen),t.addScreen(o.levelSelectionMenuScreen),t.addScreen(o.demoLevelSelectionMenuScreen),t.addScreen(r.battleScreen),t.addScreen(s.databaseScreen),t.addScreen(o.settingsMenuScreen),t.addScreen(l.generalSettingsScreen),t.addScreen(u.graphicsScreen),t.addScreen(c.controlsScreen),t.addScreen(_.aboutScreen),t.addScreen(o.ingameMenuScreen),h.value=3,t.executeWhenAllScreensReady(function(){h.value=4,t.requestLanguageChange(localStorage.getItem(i.LANGUAGE_LOCAL_STORAGE_ID)||t.getDefaultLanguage(),a,function(){h.value=5,e.clearStoredDOMModels(),localStorage[i.VERSION_LOCAL_STORAGE_ID]=t.getVersion(),n()})})})},t}),require(["armada/armada"],function(t){"use strict";t.initialize()}),define("main",function(){});