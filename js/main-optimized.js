define("modules/application",[],function(){"use strict";var t={CRITICAL:"critical",SEVERE:"severe",MINOR:"minor"},e="text/plain; charset=utf-8",i=null,o=!0,n=0,r="",s=!0;return{ErrorSeverity:t,getFolder:function(e){return e.length>0&&"/"===e[e.length-1]?e:i?void 0!==i[e]?i[e]:(this.showError("Asked for folder for file type '"+e+"', and folder for such files is not registered!",t.SEVERE),null):(this.log("Looking for the folder assigned to file type '"+e+"', but there are no folders specified in the application configuration. Will use the folder with the same name as the file type."),e+"/")},setFolders:function(e){var o="",n=function(i,o,r){var s=-1,a=-1,h="",l="";for(r=r||[];i.indexOf("{{")>=0;){if(!(i.indexOf("}}")>=0))return this.showError("Invalid folder name specified! Cannot resolve: '"+i+"'",t.SEVERE,"References to other folders must be surrounded by {{ and }}."),null;if(s=i.indexOf("{{"),a=i.indexOf("}}"),l=i.substring(s+2,a),h=e[l],!h)return this.showError("Invalid folder name specified! Cannot find referenced folder '"+i.substring(s+2,a)+"' in "+i+"!",t.SEVERE),null;if(!(r.indexOf(l)<0))return this.showError("Circular reference detected among the following folders: "+r.concat(o).join(", "),t.SEVERE),null;i=i.replace(i.substring(s,Math.min(a+3,i.length)),n(h,l,r.concat(o)))}return i}.bind(this);i={};for(o in e)e.hasOwnProperty(o)&&(i[o]=n(e[o],o))},setFileCacheBypassEnabled:function(t){o=t},setLogVerbosity:function(t){n=t},getVersion:function(){return r},setVersion:function(t){r=t},isDebugVersion:function(){return s},setDebugVersion:function(t){s=t},getFileURL:function(t,e){return this.getFolder(t)+(o?e+"?123":e)},showError:function(e,i,o){var n="Error: "+e+(o?"\n\n"+o+"\n\n":"\n\n");switch(i){case t.CRITICAL:n+="Unfortunately this is a critical error.\nThe application is not functional until this error is resolved.";break;case t.SEVERE:n+="This is a severe error.\nThe application might produce unexpected behaviour from this point on. It is recommended that you restart the application by refreshing the page in your browser.";break;case t.MINOR:n+="This is a minor error.\nThe application might be fully functional, but you might need to readjust some settings or take some other actions depending on the explanation of the error.";break;default:n+="The severity of this error cannot be determined.\nThe application might produce unexpected behaviour from this point on. It is recommended that you restart the application by refreshing the page in your browser."}alert(n)},log:function(t,e){(!e||n>=e)&&console.log(t)},requestFile:function(e,i,o,n){this.log("Requesting file: '"+i+"' from "+(""!==this.getFolder(e)?"folder: '"+this.getFolder(e):"root folder")+"'...",2);var r=new XMLHttpRequest;r.onload=function(){this.log("File: '"+i+"' successfully loaded.",2),o(r)}.bind(this),r.onerror=function(){this.showError("An error occured while trying to load file: '"+i+"'.",t.SEVERE,"The status of the request was: '"+r.statusText+"' when the error happened.")}.bind(this),r.ontimeout=function(){this.showError("Request to load the file: '"+i+"' timed out.",t.SEVERE)}.bind(this),n&&r.overrideMimeType(n),r.open("GET",this.getFileURL(e,i),!0),r.send(null)},requestTextFile:function(t,i,o,n){this.requestFile(t,i,function(t){o(t.responseText)},n||e)},requestXMLFile:function(e,i,o){this.requestFile(e,i,function(e){var n=null===e.responseXML?(new DOMParser).parseFromString(e.responseText,"application/xml"):e.responseXML;"parsererror"!==n.documentElement.nodeName?o(n):this.showError("Could not parse XML file: '"+i+"'.",t.SEVERE,"The file could be loaded, but for some reason the parsing of it has failed. \nThe status of the request was: '"+e.statusText+"' when the error happened.\nThe text content of the file:\n"+(e.responseText.length>120?e.responseText.slice(0,120)+"...":e.responseText))}.bind(this),"application/xml")},requestCSSFile:function(t,e,i){var o;0===document.head.querySelectorAll("link[href='"+this.getFileURL(t,e)+"']").length?(o=document.createElement("link"),o.setAttribute("rel","stylesheet"),o.setAttribute("type","text/css"),o.onload=i,o.href=this.getFileURL(t,e),document.head.appendChild(o)):i&&i()}}}),define("modules/async-resource",[],function(){"use strict";function t(){this._readyToUse=!1,this._onReadyQueue=[]}return t.prototype.addOnReadyFunction=function(t){this._onReadyQueue.push(t)},t.prototype.isReadyToUse=function(){return this._readyToUse},t.prototype.resetReadyState=function(){this._readyToUse=!1},t.prototype.resetResource=function(){this._readyToUse=!1,this._onReadyQueue=[]},t.prototype.executeOnReadyQueue=function(){var t;for(t=0;t<this._onReadyQueue.length;t++)this._onReadyQueue[t].call(this);this._onReadyQueue=[]},t.prototype.setToReady=function(){this._readyToUse===!1&&(this._readyToUse=!0,this.executeOnReadyQueue())},t.prototype.executeWhenReady=function(t,e,i){return this._readyToUse?i?(setTimeout(t.bind(this),0),!1):(t.call(this),!0):(this.addOnReadyFunction(t),void 0!==e&&e.call(this),!1)},{AsyncResource:t}}),define("modules/screen-manager",["modules/async-resource"],function(t){"use strict";function e(){t.AsyncResource.call(this),this._screens={},this._coveredScreens=[],this._currentScreen=null,this._screensLoaded=0,this._screensToLoad=0}var i;return e.prototype=new t.AsyncResource,e.prototype.constructor=e,e.prototype.getCurrentScreen=function(){return this._currentScreen},e.prototype.getScreen=function(t){return t?this._screens[t]:this.getCurrentScreen()},e.prototype.addScreen=function(t,e,i){var o,n=function(){this._screensLoaded++,this._screensLoaded===this._screensToLoad&&this.setToReady()}.bind(this);if(e===!0)for(o in this._screens)this._screens.hasOwnProperty(o)&&this._screens[o].removeFromPage();this._screensToLoad++,this._screens[t.getName()]=t,e===!0?t.replacePageWithScreen(n):t.addScreenToPage(n,i)},e.prototype.setCurrentScreen=function(t,e,i){var o,n;if(e!==!0&&null!==this._currentScreen)for(this._currentScreen.hide(),o=0;o<this._coveredScreens.length;o++)this._coveredScreens[o].hide();n=this.getScreen(t),e===!0?(this._coveredScreens.push(this._currentScreen),n.superimposeOnPage(i)):n.show(),this._currentScreen=n},e.prototype.closeSuperimposedScreen=function(){this._currentScreen.hide(),this._currentScreen=this._coveredScreens.pop()},e.prototype.closeOrNavitageTo=function(t){this.getCurrentScreen().isSuperimposed()?this.closeSuperimposedScreen():this.setCurrentScreen(t)},e.prototype.updateAllScreens=function(){var t;for(t in this._screens)this._screens.hasOwnProperty(t)&&this._screens[t].updateScreen()},i=new e,{getCurrentScreen:i.getCurrentScreen.bind(i),getScreen:i.getScreen.bind(i),addScreen:i.addScreen.bind(i),setCurrentScreen:i.setCurrentScreen.bind(i),closeSuperimposedScreen:i.closeSuperimposedScreen.bind(i),closeOrNavitageTo:i.closeOrNavitageTo.bind(i),updateAllScreens:i.updateAllScreens.bind(i),executeWhenReady:i.executeWhenReady.bind(i)}}),define("utils/utils",[],function(){"use strict";var t=" ",e={},i={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,"caps lock":20,escape:27,space:32,"page up":33,"page down":34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,"delete":46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,"left window":91,"right window":92,select:93,"numpad 0":96,"numpad 1":97,"numpad 2":98,"numpad 3":99,"numpad 4":100,"numpad 5":101,"numpad 6":102,"numpad 7":103,"numpad 8":104,"numpad 9":105,"*":106,"numpad '+'":107,"numpad '-'":109,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,"-":173,",":188,".":190};return e.getRGBColorFromXMLTag=function(t){return[parseFloat(t.getAttribute("r")),parseFloat(t.getAttribute("g")),parseFloat(t.getAttribute("b"))]},e.getDimensionsFromXMLTag=function(t){return[parseFloat(t.getAttribute("w")),parseFloat(t.getAttribute("h")),parseFloat(t.getAttribute("d"))]},e.evaluateProduct=function(t){var e,i,o;for(e=t.split("*"),i=1,o=0;o<e.length;o++)i*=parseFloat(e[o]);return i},e.getFirstXMLElement=function(t,e){var i=t.getElementsByTagName(e);return i.length>0?i[0]:null},e.getKeyCodeOf=function(t){return t?"#"===t[0]?parseInt(t.slice(1),10):i[t]:-1},e.getKeyOfCode=function(t){var e;for(e in i)if(i[e]===t)return e;return"#"+t},e.arraysEqual=function(t,e){var i,o;if(!e)return!1;if(t.length!==e.length)return!1;for(i=0,o=t.length;o>i;i++)if(t[i]instanceof Array&&e[i]instanceof Array){if(!t[i].equals(e[i]))return!1}else if(t[i]!==e[i])return!1;return!0},e.objectsEqual=function(t,e){var i,o,n;if(null===t&&null===e)return!0;if(!t)return!1;if(i=Object.keys(t),!e)return!1;if(o=Object.keys(e),i.length!==o.length)return!1;for(n=0;n<i.length;n++)if(i[n]!==o[n]||t[i[n]]!==e[o[n]])return!1;return!0},e.getSafeEnumValue=function(t,i,o){var n;o=o?e.getSafeEnumValue(t,o):null;for(n in t)if(t.hasOwnProperty(n)&&i===t[n])return i;return o||null},e.getEnumValues=function(t){var e,i=[];for(e in t)t.hasOwnProperty(e)&&i.push(t[e]);return i},e.getKeyOfValue=function(t,e){var i;for(i in t)if(t.hasOwnProperty(i)&&t[i]===e)return i;return null},e.getPaddedStringForNumber=function(t,e){var i,o=t.toString();for(i=o.length;e>i;i++)o="0"+o;return o},e.getDelimitedStringForNumber=function(i){return i>=1e3?e.getDelimitedStringForNumber(Math.floor(i/1e3))+t+e.getPaddedStringForNumber(i%1e3,3):i.toString()},e.getLengthString=function(t){return 2e3>t?100>t?t.toPrecision(3)+" m":Math.round(t)+" m":1e5>t?(t/1e3).toPrecision(3)+" km":e.getDelimitedStringForNumber(Math.round(t/1e3))+" km"},e.getMassString=function(t){return 2e3>t?100>t?t.toPrecision(3)+" kg":Math.round(t)+" kg":1e5>t?(t/1e3).toPrecision(3)+" t":e.getDelimitedStringForNumber(Math.round(t/1e3))+" t"},e.constantName=function(t){var e,i="";for(e=0;e<t.length;e++)t[e].match(/[A-Z]/)&&(i+="_"),i+=" "===t[e]?"_":t[e].toUpperCase();return i},e.formatString=function(t,e){var i,o=t.toString();for(i in e)e.hasOwnProperty(i)&&(o=o.replace(new RegExp("\\{"+i+"\\}","gi"),e[i]));return o},e.executeAsync=function(t){setTimeout(t,0)},e}),define("utils/types",["utils/utils","modules/application"],function(t,e){"use strict";function i(t,i,o,n){e.showError("Invalid value for '"+t+"' ("+i+")"+(n?": "+n:".")+" Using default value "+o+" instead.")}function o(t,i,o,n){e.showError("Invalid value for '"+i+"'. Expected "+t+", got a(n) "+("object"==typeof o?o.constructor.name:typeof o)+" ("+o+"). Using default value "+(n instanceof Array?"["+n.join(", ")+"]":"'"+n+"'")+" instead.")}var n={};return n.getBooleanValue=function(t,e,r,s,a,h){return"boolean"==typeof e?s&&!s(e,h)?(i(t,e,r,a),null!==r?n.getBooleanValue(t,r,null,s,a,h):null):e:(o("a boolean",t,e,r),null!==r?n.getBooleanValue(t,r,null,s,a,h):null)},n.getNumberValue=function(t,e,r,s,a,h){return"number"==typeof e?s&&!s(e,h)?(i(t,e,r,a),null!==r?n.getNumberValue(t,r,null,s,a,h):null):e:(o("a number",t,e,r),null!==r?n.getNumberValue(t,r,null,s,a,h):null)},n.getNumberValueInRange=function(t,r,s,a,h,l,u,c){return"number"==typeof r?((void 0!==s&&s>r||void 0!==a&&r>a)&&(e.showError("Invalid value for "+t+": out of range ("+(void 0!==s?s:"...")+"-"+(void 0!==a?a:"...")+"). The setting will be changed to fit the valid range."),void 0!==s&&(r=Math.max(s,r)),void 0!==a&&(r=Math.min(r,a))),l&&!l(r,c)?(i(t,r,h,u),null!==h?n.getNumberValueInRange(t,h,s,a,null,l,u,c):null):r):(o("a number",t,r,h),null!==h?n.getNumberValueInRange(t,h,s,a,null,l,u,c):null)},n.getStringValue=function(t,e,r,s,a,h){return"string"==typeof e?s&&!s(e,h)?(i(t,e,r,a),null!==r?n.getStringValue(t,r,null,s,a,h):null):e:(o("a string",t,e,r),null!==r?n.getStringValue(t,r,null,s,a,h):null)},n.getEnumValue=function(o,n,r,s,a,h,l){var u=t.getSafeEnumValue(n,r);return null!==u?a&&!a(u,l)?(i(o,u,s,h),s):u:(e.showError("Unrecognized '"+o+"' value: '"+r+"'. Possible values are are: "+t.getEnumValues(n).join(", ")+". Default value '"+s+"' will be used instead."),s)},n.getObjectValue=function(t,e,r,s,a,h){return"object"==typeof e?s&&!s(e,h)?(i(t,e,r,a),null!==r?n.getObjectValue(t,r,null,s,a,h):null):e:(o("an object",t,e,r),null!==r?n.getObjectValue(t,r,null,s,a,h):null)},n.getValueOfType=function(t,i,o,r,s,a,h,l,u){if(a=a||{},void 0===o)return void 0!==r?null!==r?n.getValueOfType(t,i,r,null,s,a,h,l,u):null:void(s||e.showError("Missing required value of '"+t+"'!"));if("object"==typeof i)return n.getValueOfType(t,i.baseType,o,r,s,i,h,l,u);switch(i){case"boolean":return n.getBooleanValue(t,o,r,h,l,u);case"number":return a.range?n.getNumberValueInRange(t,o,a.range[0],a.range[1],r,h,l,u):n.getNumberValue(t,o,r,h,l,u);case"string":return n.getStringValue(t,o,r,h,l,u);case"enum":return a.values?n.getEnumValue(t,a.values,o,r,h,l,u):(e.showError("Missing enum definition object for '"+t+"'!"),null);case"object":return a.properties?n.getVerifiedObject(t,o,a.properties):n.getObjectValue(t,o,r,h,l,u);case"array":return n.getArrayValue(t,o,a.elementType,a.elementTypeParams,a,r,h,l,null,null,u);default:return e.showError("Unknown type specified for '"+t+"': "+i),null}},n.getArrayValue=function(t,r,s,a,h,l,u,c,p,d,_){var g,f=[];if(r instanceof Array){if(void 0!==h){if(void 0!==h.length&&r.length!==h.length)return e.showError("Invalid array length for '"+t+"'! Expected a length of "+h.length+" and got "+r.length+(l?". Using default value ["+l.join(", ")+"] instead.":".")),l?n.getArrayValue(t,l,s,a,h,null,u,c,p,d,_):null;if(void 0!==h.minLength&&r.length<h.minLength)return e.showError("Invalid array length for '"+t+"'! Expected a minimum length of "+h.minLength+" and got "+r.length+(l?". Using default value ["+l.join(", ")+"] instead.":".")),l?n.getArrayValue(t,l,s,a,h,null,u,c,p,d,_):null;if(void 0!==h.maxLength&&r.length>h.maxLength)return e.showError("Invalid array length for '"+t+"'! Expected a maximum length of "+h.maxLength+" and got "+r.length+(l?". Using default value ["+l.join(", ")+"] instead.":".")),l?n.getArrayValue(t,l,s,a,h,null,u,c,p,d,_):null}return void 0!==s&&r.forEach(function(e,i){g=n.getValueOfType(t+"["+i+"]",s,e,null,!1,a,p,d,_),null!==g&&f.push(g)}),u&&!u(r)?(i(t,r,"["+l.join(", ")+"]",c),null!==l?n.getArrayValue(t,l,s,a,h,null,u,c,p,d,_):null):r}return o("an array",t,r,l),null!==l?n.getArrayValue(t,l,s,a,h,null,u,c,p,d,_):null},n.getVerifiedObject=function(t,i,o,r,s,a,h){var l,u,c,p=r||{},d=[];if("object"==typeof i){for(u in o)o.hasOwnProperty(u)&&(c=o[u],p[c.name]&&e.showError("'"+t+"' already has a property named '"+c.name+"', which will be overridden by a new value!"),p[c.name]=n.getValueOfType(t+"."+c.name,c.type||h,i[c.name],c.defaultValue,c.optional,{range:c.range,values:c.values,elementType:c.elementType,elementEnumObject:c.elementEnum,length:c.length,minLength:c.minLength,maxLength:c.maxLength,properties:c.properties},c.check,c.checkFailMessage,i),d.push(c.name));if(!a||s)for(l in i)i.hasOwnProperty(l)&&d.indexOf(l)<0&&(a||e.showError("Unrecognized property '"+l+"' defined for '"+t+"'. The value of this property "+(h?"can be verified only against the default property type":"cannot be verified ")+(s?"but will be included.":"and will be discarded.")),s&&(h?p[l]=n.getValueOfType(t+"."+l,h,i[l]):p[l]=i[l]));return p}return e.showError("Invalid value for '"+t+"'. Expected an object, got a(n) "+typeof i+" ("+i+")."),null},n}),define("modules/strings",["utils/types","modules/application"],function(t,e){"use strict";function i(t){var e,n;for(e in t)if(t.hasOwnProperty(e)&&"object"==typeof t[e]){i(t[e]);for(n in t[e])t[e].hasOwnProperty(n)&&(t[e+o+n]=t[e][n]);delete t[e]}}var o=".",n={},r=null,s={},a={};return n.getLanguage=function(){return r},n.setLanguage=function(t){a.hasOwnProperty(t)?r=t:e.showError("Cannot set language to '"+t+"', as there are no strings loaded for that language!")},n.languageIsLoaded=function(t){return a.hasOwnProperty(t)},n.loadStrings=function(e,o,h){var l;s[e]={},i(o);for(l in h)h.hasOwnProperty(l)&&"object"==typeof h[l]&&t.getVerifiedObject("strings."+l,o,h[l],s[e],!1,!0,"string");a[e]=t.getVerifiedObject("strings."+l,o,{},null,!0,!0,"string"),r||n.setLanguage(e)},n.get=function(t,e,i){return a[r]&&a[r][t.name+(e||"")]||i||t.defaultValue||t.name+(e||"")},n.has=function(t,e){return a[r]&&void 0!==a[r][t.name+(e||"")]},n.CATEGORY_SEPARATOR=o,n}),define("modules/game",["modules/application","modules/screen-manager","modules/strings"],function(t,e,i){"use strict";var o=!1,n=!1,r=!1,s=null,a=null,h=null,l=null,u=null,c=null,p=function(){o&&n&&r&&(t.log("Initialization of "+s+" completed."),document.body.firstElementChild.style.display="none",e.setCurrentScreen(a))},d=function(){t._buildScreensAndExecuteCallback(function(){r=!0,p()})},_=function(e){t.requestTextFile(e.folder,e.filename,function(e){var i=JSON.parse(e);t.log("Loading game settings...",1),t._loadGameSettingsAndExecuteCallback(i,function(){t.log("Game settings loaded.",1),n=!0,d()})})},g=function(){t.requestTextFile(h,l,function(e){var i=JSON.parse(e);t.log("Loading game configuration..."),t.setFolders(i.folders),t.setLogVerbosity(i.logVerbosity),t.setVersion(i.version),t.setDebugVersion(i.debugVersion),t.log("Game version is: "+t.getVersion(),1),u=i.defaultLanguage,c=i.configFiles.strings,require(["modules/graphics-resources"],function(e){t._loadGameConfigurationAndExecuteCallback(i,function(){e.requestConfigLoad(i.dataFiles.graphics.resources,function(){t.log("Game configuration loaded."),o=!0}),_(i.configFiles.settings)})})})};return t._loadGameSettingsAndExecuteCallback=function(){t.showError("You need to override the _loadGameSettings method!")},t._loadGameConfigurationAndExecuteCallback=function(){t.showError("You need to override the _loadGameConfiguration method!")},t._buildScreensAndExecuteCallback=function(){t.showError("You need to override the _buildScreensAndExecuteCallback method!")},t.setGameName=function(t){s=t},t.setStartScreenName=function(t){a=t},t.setConfigFolder=function(t){h=t},t.setConfigFileName=function(t){l=t},t.getDefaultLanguage=function(){return u},t.getLanguage=function(){return i.getLanguage()||u},t.getLanguages=function(){return Object.keys(c)},t.requestLanguageChange=function(o,n,r){return c&&c[o]?(i.languageIsLoaded(o)?(i.setLanguage(o),e.updateAllScreens(),r(!1)):t.requestTextFile(c[o].folder,c[o].filename,function(t){i.loadStrings(o,JSON.parse(t),n),i.setLanguage(o),e.updateAllScreens(),r(!0)}),!0):(t.showError("Cannot change application language to '"+o+"' as there is no strings file set for this langauge!"),!1)},t.initialize=function(){return t.log("Initializing "+s+"..."),"file:"===location.protocol?void this.showError("Trying to run the game from the local filesystem!",t.ErrorSeverity.CRITICAL,"This application can only be run through a web server. If you wish to run it from your own computer, you have to install, set up and start a web server first. You have to put the folder containing the files of this game (assume it is called 'game') to the HTML serving folder of the web server, then you can start the game by entering 'localhost/game' in your browser's address bar."):void g()},t.getScreen=e.getScreen,t.setScreen=e.setCurrentScreen,t.addScreen=e.addScreen,t.closeSuperimposedScreen=e.closeSuperimposedScreen,t.closeOrNavigateTo=e.closeOrNavitageTo,t.updateAllScreens=e.updateAllScreens,t.executeWhenAllScreensReady=e.executeWhenReady,t}),define("modules/components",["utils/utils","modules/application","modules/async-resource","modules/strings"],function(t,e,i,o){"use strict";function n(t){return R[t]&&!!R[t].model}function r(t){return R[t]&&R[t].model}function s(t){return R[t]&&R[t].requested}function a(t,i){s(t)?n(t)?i&&i():R[t].onLoadQueue.push(i):(R[t]={},R[t].requested=!0,R[t].onLoadQueue=[i],e.requestTextFile(m,t,function(e){var i;for(R[t].model=document.implementation.createHTMLDocument(),R[t].model.documentElement.innerHTML=e,i=0;i<R[t].onLoadQueue.length;i++)R[t].onLoadQueue[i]()}))}function h(t){return t.caption||o.get({name:t.id})}function l(){R={}}function u(t,e){this._name=t,this._elementID=e||t,this._element=null,this._displayStyle=null}function c(t,e,o){i.AsyncResource.call(this),this._name=t,this._rootElementID=t,this._htmlFilename=e,this._style=o||{},this._rootElement=null,this._rootElementDefaultDisplayMode=null,this._cssLoaded=!1,this._simpleComponents=[],e&&this.requestModelLoad()}function p(t,e,i,o){c.call(this,t,e,i),this._progress=this.registerSimpleComponent(S),this._status=this.registerSimpleComponent(T),this._header=this.registerSimpleComponent(x),this._headerID=o}function d(t,e,i,o,n,r,s){c.call(this,t,e,i),this._message=this.registerSimpleComponent(b),this._okButton=this.registerSimpleComponent(M),this._header=this.registerSimpleComponent(v),this._headerID=r,this._okButtonID=s,this._onShow=void 0!==o?o:null,this._onHide=void 0!==n?n:null,this._handleKeyUp=function(t){t.keyCode===A&&this.hide()}.bind(this)}function _(t,e,i,o){c.call(this,t,e,i),this._menuOptions=o}function g(t,e,i,o,n){c.call(this,t,e,i),this._propertyLabelDescriptor=o,this._valueList=n,this._valueIndex=0,this._propertyLabel=this.registerSimpleComponent(O),this._valueSelector=this.registerSimpleComponent(E),this.onChange=null}var f="_",m="component",y="css",S="progress",T="status",x="header",b="message",M="okButton",v="header",O="property",E="value",A=13,R={};return u.prototype.getName=function(){return this._name},u.prototype.setElementID=function(t){this._elementID=t,this._element&&this._element.setAttribute("id",this._elementID)},u.prototype.getElement=function(){return this._element},u.prototype.getContent=function(){return this._element.innerHTML},u.prototype.setContent=function(e,i){this._element.innerHTML=i?t.formatString(e,i):e},u.prototype.customizeContent=function(e){this._element.innerHTML=t.formatString(this._element.innerHTML,e)},u.prototype.initComponent=function(){this._element=document.getElementById(this._elementID),this._element?this._displayStyle=this._element.style.display:e.showError("Cannot initialize component: '"+this._name+"'!",e.ErrorSeverity.SEVERE,"No element can be found on the page with a corresponding ID: '"+this._elementID+"'!")},u.prototype.resetComponent=function(){this._element=null,this._displayStyle=null},u.prototype.isVisible=function(){return"none"!==this._element.style.display},u.prototype.hide=function(){this._element.style.display="none"},u.prototype.show=function(){this._element.style.display=this._displayStyle},c.prototype=new i.AsyncResource,c.prototype.constructor=c,c.prototype.getName=function(){return this._name},c.prototype.setRootElementID=function(t){var i;if(this._rootElement)e.showError("Attempting to change the root element ID for external component '"+this._name+"' after it has already been added to the page!");else for(this._rootElementID=t,i=0;i<this._simpleComponents.length;i++)this._simpleComponents[i].setElementID(this._getElementID(this._simpleComponents[i].getName()))},c.prototype.requestModelLoad=function(){this._style.cssFilename?(this._cssLoaded=!1,e.requestCSSFile(y,this._style.cssFilename,function(){this._cssLoaded=!0,n(this._htmlFilename)&&this.setToReady()}.bind(this))):this._cssLoaded=!0,a(this._htmlFilename,function(){this._cssLoaded===!0&&this.setToReady()}.bind(this))},c.prototype.appendToPage=function(t){var e,i;for(t=t||document.body,this._rootElement=t.appendChild(document.importNode(r(this._htmlFilename).body.firstElementChild,!0)),this._rootElement.setAttribute("id",this._rootElementID),this._rootElementDefaultDisplayMode=this._rootElement.style.display,e=this._rootElement.querySelectorAll("[id]"),i=0;i<e.length;i++)e[i].setAttribute("id",this._getElementID(e[i].getAttribute("id")));this._initializeComponents()},c.prototype._getElementID=function(t){return this._rootElementID+f+t},c.prototype._getOriginalElementID=function(t){return t.getAttribute("id").substr(this._rootElementID.length+f.length)},c.prototype._initializeComponents=function(){var t;if(this._rootElement)for(t=0;t<this._simpleComponents.length;t++)this._simpleComponents[t].initComponent();else e.log("WARNING! Attempting to initaialize external component "+this._name+" before appending it to the page! It will be initialized automatically once it is added.")},c.prototype.updateComponents=function(){var t,i;if(this._rootElement)for(i=this._rootElement.querySelectorAll("[id]"),t=0;t<i.length;t++)i[t].innerHTML=o.get({name:this._getOriginalElementID(i[t]),defaultValue:i[t].innerHTML});else e.log("WARNING! Attempting to update external component "+this._name+" before appending it to the page!")},c.prototype.registerSimpleComponent=function(t){var e=new u(t,this._getElementID(t));return this._simpleComponents.push(e),e},c.prototype.resetComponent=function(){var t;for(this.resetResource(),t=0;t<this._simpleComponents.length;t++)this._simpleComponents[t].resetComponent()},c.prototype.show=function(){this._rootElement?this._rootElement.style.display=this._rootElementDefaultDisplayMode:e.log("WARNING! Attempting to show external component "+this._name+" before appending it to the page!")},c.prototype.hide=function(){this._rootElement?this._rootElement.style.display="none":e.log("WARNING! Attempting to hide external component "+this._name+" before appending it to the page!")},p.prototype=new c,p.prototype.constructor=p,p.prototype._initializeComponents=function(){c.prototype._initializeComponents.call(this),this._rootElement&&(this._headerID&&this._header.setElementID(this._getElementID(this._headerID)),this.hide())},p.prototype.setMaxProgress=function(t){this._rootElement?this._progress.getElement().max=t:e.log("WARNING! Attempting to update the maximum progress value of loading box"+this._name+" before appending it to the page!")},p.prototype.updateProgress=function(t){this._rootElement?this._progress.getElement().value=t:e.log("WARNING! Attempting to update the progress value of loading box"+this._name+" before appending it to the page!")},p.prototype.updateStatus=function(t,i,o){this._rootElement?(this._status.setContent(t,i),void 0!==o&&this.updateProgress(o)):e.log("WARNING! Attempting to update the status message of loading box"+this._name+" before appending it to the page!")},d.prototype=new c,d.prototype.constructor=d,d.prototype._initializeComponents=function(){c.prototype._initializeComponents.call(this),this._rootElement&&(this._headerID&&this._header.setElementID(this._getElementID(this._headerID)),this._okButtonID&&this._okButton.setElementID(this._getElementID(this._okButtonID)),this._okButton.getElement().onclick=function(){return this.hide(),!1}.bind(this),c.prototype.hide.call(this))},d.prototype.show=function(){c.prototype.show.call(this),document.addEventListener("keyup",this._handleKeyUp),this._onShow&&this._onShow()},d.prototype.hide=function(){c.prototype.hide.call(this),document.removeEventListener("keyup",this._handleKeyUp),this._onHide&&this._onHide()},d.prototype.updateMessage=function(t,i){this._rootElement?this._message.setContent(t,i):e.log("WARNING! Attempting to update the message of info box"+this._name+" before appending it to the page!")},_.prototype=new c,_.prototype.constructor=_,_.prototype.getMenuClickHandler=function(t){return function(){return this._menuOptions[t].action(),!1}.bind(this)},_.prototype._initializeComponents=function(){var t,e,i;if(c.prototype._initializeComponents.call(this),this._rootElement)for(t=0;t<this._menuOptions.length;t++)e=document.createElement("a"),this._menuOptions[t].id&&(e.id=this._getElementID(this._menuOptions[t].id)),e.href="#",e.className=(this._style.menuClassName||"")+" "+(this._style.buttonClassName||""),e.innerHTML=h(this._menuOptions[t]),e.onclick=this.getMenuClickHandler(t),i=document.createElement("li"),i.className=this._style.buttonContainerClassName||"",i.appendChild(e),this._rootElement.appendChild(i)},g.prototype=new c,g.prototype.constructor=g,g.prototype._initializeComponents=function(){c.prototype._initializeComponents.call(this),this._rootElement&&(this._propertyLabelDescriptor.id&&this._propertyLabel.setElementID(this._getElementID(this._propertyLabelDescriptor.id)),this._propertyLabel.setContent(h(this._propertyLabelDescriptor)),this._valueSelector.setContent(this._valueList[0]),this._valueIndex=0,this._valueSelector.getElement().onclick=function(){return this.selectNextValue(),!1}.bind(this))},g.prototype.selectValue=function(t){if(this._rootElement){for(var i=0;i<this._valueList.length&&this._valueList[i]!==t;)i++;i<this._valueList.length?this.selectValueWithIndex(i):e.showError("Attempted to select value: '"+t+"' for '"+this._propertyLabelDescriptor.caption||o.get({name:this._propertyLabelDescriptor.id})+"', which is not one of the available options.",e.ErrorSeverity.MINOR)}else e.showError("Attemted to select value for selector "+this._name+" which is not yet appended to the page!")},g.prototype.selectValueWithIndex=function(t){this._rootElement?this._valueList.length>t?(this._valueIndex=t,this._valueSelector.setContent(this._valueList[this._valueIndex]),this.onChange&&this.onChange()):e.showError("Attempted to select value with index '"+t+"' for '"+this._propertyName+"', while the available range is: 0-"+(this._valueList.length-1),e.ErrorSeverity.MINOR):e.showError("Attemted to select value for selector "+this._name+" which is not yet appended to the page!")},g.prototype.getSelectedValue=function(){return this._valueList[this._valueIndex]},g.prototype.getSelectedIndex=function(){return this._valueIndex},g.prototype.selectNextValue=function(){this.selectValueWithIndex((this._valueIndex+1)%this._valueList.length)},g.prototype.setValueList=function(t){this._valueList=t,this._valueIndex>=this._valueList.length&&(this._valueIndex=0)},{ELEMENT_ID_SEPARATOR:f,clearStoredDOMModels:l,SimpleComponent:u,LoadingBox:p,InfoBox:d,MenuComponent:_,Selector:g}}),define("armada/constants",[],function(){"use strict";return{GAME_NAME:"Interstellar Armada",LANGUAGE_LOCAL_STORAGE_ID:"interstellarArmada_language"}}),define("modules/managed-gl",["utils/utils","utils/types","modules/application","modules/async-resource"],function(t,e,i,o){"use strict";function n(t){switch(t){case g.NONE:return 0;case g.FLOAT:return 1;case g.VEC2:return 2;case g.VEC3:return 3;case g.VEC4:return 4;case g.MAT2:return 4;case g.MAT3:return 9;case g.MAT4:return 16;case g.SAMPLER2D:return 1;case g.SAMPLER_CUBE:return 1;case g.INT:return 1;case g.BOOL:return 1;default:return i.showError("Cannot determine vector size of GLSL type '"+t+"'!"),0}}function r(t){return t?1:0}function s(t,e,i){this._name=t,this._image=e,this._mipmap=void 0!==i?i:!0,this._ids={},this._locations={}}function a(t,e){this._name=t,this._images=e,this._ids={},this._locations={}}function h(t,e,i){this.name=t,this.size=e,this.role=i}function l(t,i,o){this._name=t,this._type=e.getEnumValue("uniform "+this._name+".type",g,i,g.NONE),this._arraySize=o||0,this._members=this._type===g.STRUCT?[]:null,this._locations={}}function u(t,e,i,o){this._name=t,this._role=e,this._vectorSize=i,this._data=new Float32Array(o*this._vectorSize),this._ids={},this._locations={},this._filledVectors=0}function c(t,e,i){this._name=t,this._id=null,this._width=e,this._height=i,this._textureID=null,this._textureLocation=this.TEXTURE_LOCATION_NOT_SET,this._renderBufferID=null}function p(t,e,i,o,n,r,s){this._name=t,this._blendMode=o,this._vertexAttributes=[],this._instanceAttributes=[],this._uniforms=[],this._vertexShaderSource=e,this._fragmentShaderSource=i,this._ids={},this._instanceAttributeBuffers=[],this._uniformNamesForInstanceAttributeNames=r,this._parseShaderSources(n,s)}function d(t,e,i,n){o.AsyncResource.call(this),this._name=t,this._canvas=e,this.gl=null,this._antialiasing=i===!0,this._filtering=null,this.anisotropicFilterExt=null,this.instancingExt=null,this._shaders=[],this._models=[],this._vertexBuffers=null,this._boundVertexBuffers=[],this._frameBuffers={},this._currentShader=null,this._textures=[],this._boundTextures=[],this._maxBoundTextures=0,this._nextTextureBindLocation=0,this._maxTextureSize=0,this._maxCubemapSize=0,this._maxRenderbufferSize=0,this._maxVertexAttributes=0,
this._maxVertexShaderUniforms=0,this._maxFragmentShaderUniforms=0,this._maxVaryings=0,this._createContext(),this.setFiltering(n)}var _={BILINEAR:"bilinear",TRILINEAR:"trilinear",ANISOTROPIC:"anisotropic"},g={NONE:"none",FLOAT:"float",VEC2:"vec2",VEC3:"vec3",VEC4:"vec4",MAT2:"mat2",MAT3:"mat3",MAT4:"mat4",SAMPLER2D:"sampler2D",SAMPLER_CUBE:"samplerCube",INT:"int",BOOL:"bool",STRUCT:"struct"},f={NONE:"none",MIX:"mix",ADD:"add"},m="u_",y="",S="",T="Texture",x="",b="Cubemap";return Object.freeze(_),Object.freeze(g),i.showGraphicsError=function(t,e,o,n){n?i.showError(t,e,o+"\n\nThis is a graphics related error.\nInformation about your graphics support:\nWebGL version: "+n.getParameter(n.VERSION)+"\nShading language version: "+n.getParameter(n.SHADING_LANGUAGE_VERSION)+"\nWebGL vendor: "+n.getParameter(n.VENDOR)+"\nWebGL renderer: "+n.getParameter(n.RENDERER)):i.showError(t,e,o+"\n\nThis is a graphics related error. There is no information available about your graphics support.")},s.prototype.getName=function(){return this._name},s.prototype.getLastTextureBindLocation=function(t){return this._locations[t]},s.prototype.forgetLastTextureBindLocation=function(t){delete this._locations[t]},s.prototype.setMinFiltering=function(t,e,i){if(this._mipmap===!1)t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR);else{switch(e){case _.BILINEAR:t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST);break;case _.TRILINEAR:t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR);break;case _.ANISOTROPIC:t.texParameterf(t.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,4)}t.generateMipmap(t.TEXTURE_2D)}},s.prototype.createGLTexture=function(t,e){this._ids[t]=e.createTexture()},s.prototype.bindGLTexture=function(t,e,i){e.activeTexture(e.TEXTURE0+i),e.bindTexture(e.TEXTURE_2D,this._ids[t]),this._locations[t]=i},s.prototype.setupGLTexture=function(t,e,i){t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._image),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),this.setMinFiltering(t,e,i)},s.prototype.deleteGLTexture=function(t,e){this._ids[t]&&(e.deleteTexture(this._ids[t]),delete this._ids[t],delete this._locations[t])},a.prototype.getName=function(){return this._name},a.prototype.getLastTextureBindLocation=function(t){return this._locations[t]},a.prototype.forgetLastTextureBindLocation=function(t){delete this._locations[t]},a.prototype.createGLTexture=function(t,e){this._ids[t]=e.createTexture()},a.prototype.bindGLTexture=function(t,e,i){e.activeTexture(e.TEXTURE0+i),e.bindTexture(e.TEXTURE_CUBE_MAP,this._ids[t]),this._locations[t]=i},a.prototype.setupGLTexture=function(t){var e,i;for(t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.LINEAR),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),e=[t.TEXTURE_CUBE_MAP_POSITIVE_X,t.TEXTURE_CUBE_MAP_NEGATIVE_X,t.TEXTURE_CUBE_MAP_POSITIVE_Y,t.TEXTURE_CUBE_MAP_NEGATIVE_Y,t.TEXTURE_CUBE_MAP_POSITIVE_Z,t.TEXTURE_CUBE_MAP_NEGATIVE_Z],i=0;6>i;i++)t.texImage2D(e[i],0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._images[i])},a.prototype.deleteGLTexture=function(t,e){this._ids[t]&&(e.deleteTexture(this._ids[t]),delete this._ids[t],delete this._locations[t])},l.prototype.getName=function(){return this._name},l.prototype.addMember=function(t){this._type===g.STRUCT?this._members.push(t):i.showError("Attempting to add a member to uniform "+this._name+", which is not of struct type!")},l.prototype.saveLocation=function(t,e,i,o){this._locations[t]||(this._locations[t]={}),this._locations[t][o||"self"]=e.getUniformLocation(i.getIDForContext(t),(o||"")+this._name)},l.prototype.forgetLocations=function(t){var e,i;if(delete this._locations[t],this._members)for(e=0;e<this._arraySize;e++)for(i=0;i<this._members.length;i++)this._members[i].forgetLocations(t)},l.prototype.getLocation=function(t,e,i,o){return!o||this._locations[t]&&void 0!==this._locations[t][o]||this.saveLocation(t,e,i,o),this._locations[t][o||"self"]},l.prototype.getArraySize=function(){return this._arraySize},l.prototype.getRawName=function(){var t,e=this._name;return m.length>0&&(t=e.split(m),e=t[t.length-1]),y.length>0&&(e=e.split(y)[0]),e},l.prototype.getTextureType=function(){var t,e;if(this._type!==g.SAMPLER2D)return null;if(t=this.getRawName(),S.length>0){if(e=t.split(S),e.length<2)return null;t=e[e.length-1]}if(T.length>0){if(e=t.split(T),e.length<2)return null;t=e[0]}return t},l.prototype.getCubemapName=function(){var t,e;if(this._type!==g.SAMPLER_CUBE)return null;if(t=this.getRawName(),x.length>0){if(e=t.split(x),e.length<2)return null;t=e[e.length-1]}if(b.length>0){if(e=t.split(b),e.length<2)return null;t=e[0]}return t},l.prototype.getUniformName=function(t){return m+t+y},l.prototype.getTextureUniformRawName=function(t){return S+t+T},l.prototype.getCubemapUniformRawName=function(t){return x+t+b},l.prototype.setConstantValue=function(t,e,o,n,s){var a,h,l,u;switch(a=this.getLocation(t,e,o,s),this._type){case g.FLOAT:this._arraySize>0?e.uniform1fv(a,n):e.uniform1f(a,n);break;case g.VEC2:e.uniform2fv(a,n);break;case g.VEC3:e.uniform3fv(a,n);break;case g.VEC4:e.uniform4fv(a,n);break;case g.MAT2:e.uniformMatrix2fv(a,!1,n);break;case g.MAT3:e.uniformMatrix3fv(a,!1,n);break;case g.MAT4:e.uniformMatrix4fv(a,!1,n);break;case g.SAMPLER2D:case g.SAMPLER_CUBE:case g.INT:this._arraySize>0?e.uniform1iv(a,n):e.uniform1i(a,n);break;case g.BOOL:this._arraySize>0?e.uniform1iv(a,n.map(r)):e.uniform1i(a,n?1:0);break;case g.STRUCT:if(this._arraySize>0)for(h=0;h<n.length;h++)for(l=0;l<this._members.length;l++)void 0!==n[h][this._members[l]._name]&&(u=this._members[l]._name,this._members[l].setConstantValue(t,e,o,n[h][u],this._name+"["+h+"]."));else for(h=0;h<this._members.length;h++)void 0!==n[this._members[h]._name]&&(u=this._members[h]._name,this._members[h].setConstantValue(t,e,o,n[u],this._name+"."));break;default:i.showError("Attempting to set uniform '"+this._name+"', but it has a type that cannot be handled! ("+(this._arraySize>0?"array ("+this._arraySize+") of ":"")+this._type+")")}},l.prototype.setValue=function(t,e,i,o,n){this.setConstantValue(t,e,i,o(),n)},u.prototype.getName=function(){return this._name},u.prototype.getRole=function(){return this._role},u.prototype.setData=function(t,e){this._data.set(t,e*this._vectorSize)},u.prototype.getSize=function(){return this._data.length/this._vectorSize},u.prototype.resize=function(t){this._data=new Float32Array(t*this._vectorSize)},u.prototype.addVector=function(t){this._data.set(t,this._filledVectors*this._vectorSize),this._filledVectors++},u.prototype.resetFilledVectors=function(){this._filledVectors=0},u.prototype.freeData=function(){this._data=null},u.prototype.loadToGPUMemory=function(t,e,i){this._ids[t]=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._ids[t]),e.bufferData(e.ARRAY_BUFFER,this._data,e.STATIC_DRAW),i||this.freeData()},u.prototype.bind=function(t,e,o){(void 0===this._locations[e.getName()]||-1===this._locations[e.getName()])&&(this._locations[e.getName()]=t.gl.getAttribLocation(e.getIDForContext(t.getName()),this._name));var n=this._locations[e.getName()];n>=0&&t.getBoundVertexBuffer(n)!==this&&(i.log("Binding "+(o?"instance":"vertex")+" buffer '"+this._name+"' to attribute location "+n+" in shader '"+e.getName()+"'.",3),o?this.loadToGPUMemory(t.getName(),t.gl,!0):t.gl.bindBuffer(t.gl.ARRAY_BUFFER,this._ids[t.getName()]),t.gl.enableVertexAttribArray(n),t.gl.vertexAttribPointer(n,this._vectorSize,t.gl.FLOAT,!1,0,0),t.instancingExt&&(o?t.instancingExt.vertexAttribDivisorANGLE(n,1):t.instancingExt.vertexAttribDivisorANGLE(n,0)),t.setBoundVertexBuffer(n,this))},u.prototype["delete"]=function(t){var e,i;t.gl.deleteBuffer(this._ids[t.getName()]);for(e in this._locations)this._locations.hasOwnProperty(e)&&(i=this._locations[e],t.getBoundVertexBuffer(i)===this&&(t.setBoundVertexBuffer(i,null),t.gl.disableVertexAttribArray(i)));delete this._ids[t.getName()],0===Object.keys(this._ids).length&&(this.freeData(),this._locations={})},c.prototype.TEXTURE_LOCATION_NOT_SET=-1,c.prototype.getName=function(){return this._name},c.prototype.getLastTextureBindLocation=function(){return this._textureLocation},c.prototype.forgetLastTextureBindLocation=function(){this._textureLocation=this.TEXTURE_LOCATION_NOT_SET},c.prototype.setup=function(t){this._id||(this._id=t.gl.createFramebuffer(),t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,this._id),this._textureID=t.gl.createTexture(),this._textureLocation=t.bindTexture(this),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MAG_FILTER,t.gl.NEAREST),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MIN_FILTER,t.gl.NEAREST),t.gl.texImage2D(t.gl.TEXTURE_2D,0,t.gl.RGBA,this._width,this._height,0,t.gl.RGBA,t.gl.UNSIGNED_BYTE,null),this._renderBufferID=t.gl.createRenderbuffer(),t.gl.bindRenderbuffer(t.gl.RENDERBUFFER,this._renderBufferID),t.gl.renderbufferStorage(t.gl.RENDERBUFFER,t.gl.DEPTH_COMPONENT16,this._width,this._height),t.gl.framebufferTexture2D(t.gl.FRAMEBUFFER,t.gl.COLOR_ATTACHMENT0,t.gl.TEXTURE_2D,this._textureID,0),t.gl.framebufferRenderbuffer(t.gl.FRAMEBUFFER,t.gl.DEPTH_ATTACHMENT,t.gl.RENDERBUFFER,this._renderBufferID))},c.prototype.bind=function(t){t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,this._id)},c.prototype.bindGLTexture=function(t,e){t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_2D,this._textureID),this._textureLocation=e},c.prototype["delete"]=function(t){t.gl.deleteTexture(this._textureID),t.gl.deleteRenderbuffer(this._renderBufferID),t.gl.deleteFramebuffer(this._id),this._id=null},p.prototype._hasUniform=function(t){var e;for(e=0;e<this._uniforms.length;e++)if(this._uniforms[e].getName()===t)return!0;return!1},p.prototype._parseShaderSources=function(e,o){var r,s,a,u,c,p,d,_,f,m,y,S,T,x,b,M,v,O={},E={},A=function(t){return""!==t},R=function(t){return"highp"===t||"mediump"===t||"lowp"===t},C=function(e){return t.getSafeEnumValue(g,e,g.NONE)!==g.NONE},w=function(t,e){var i,o,n;for(i=!1,n=0;n<u.length;n++)if(o=u[n].split(" "),i){if(o=o.filter(A),o.length>0&&"}"===o[o.length-1].split(";")[0])break;o.length>=2&&t.addMember(new l(o[1].split(";")[0],o[0],0))}else"struct"===o[0]&&o[1].split("{")[0]===e&&(i=!0)};for(a=0;2>a;a++){switch(a){case 0:u=this._vertexShaderSource.split("\n");break;case 1:u=this._fragmentShaderSource.split("\n")}for(M=!1,r=0;r<u.length;r++)if(u[r].length>0)if(c=u[r].split(/\s+|[\(\)\[\]\{\}\+\?\-!<>=*\/\^\|\&,;]/),p=u[r].match(/\s+|[\(\)\[\]\{\}\+\?\-!<>=*\/\^\|\&,;]/g),"#define"===c[0])o&&void 0!==o[c[1]]?(O[c[1]]=o[c[1]],c[2]!==o[c[1]]&&(u[r]=u[r].replace(c[2],o[c[1]]),M=!0)):O[c[1]]=c[2];else if(0===a&&"attribute"===c[0])if(d=R(c[1])?3:2,_=c[d],f=n(c[d-1]),m=e[_],void 0===m){if(!this._uniformNamesForInstanceAttributeNames.hasOwnProperty(_))return void i.showError("Role for attribute named '"+_+"' not found for shader '"+this._name+"'!");m=this._uniformNamesForInstanceAttributeNames[_],this._instanceAttributes.push(new h(_,f,m))}else this._vertexAttributes.push(new h(_,f,m));else if("uniform"===c[0])d=R(c[1])?3:2,S=c[d],this._hasUniform(S)===!1&&("["===p[d]?(b=c[d+1],O[b]&&(b=O[b]),x=parseInt(b,10)):x=0,T=c[d-1],C(T)?this._uniforms.push(new l(S,T,x)):(y=new l(S,"struct",x),w(y,T),this._uniforms.push(y)));else{for(d=0;""===c[d];)d++;if(C(c[d])||R(c[d]))d=R(c[d])?d+2:d+1,"["===p[d]&&(b=c[d+1],O[b]&&(b=O[b]),E[c[d]]=parseInt(b,10));else{for(s=0;s<this._uniforms.length;s++)if(d=c.indexOf(this._uniforms[s].getName()),d>=0&&this._uniforms[s].getArraySize()>0&&"["===p[d]&&parseInt(c[d+1],10).toString()===c[d+1]&&parseInt(c[d+1],10)>=this._uniforms[s].getArraySize()){u[r]="",M=!0;break}for(v=Object.keys(E),s=0;s<v.length;s++)if(d=c.indexOf(v[s]),d>=0&&"["===p[d]&&parseInt(c[d+1],10).toString()===c[d+1]&&parseInt(c[d+1],10)>=E[c[d]]){u[r]="",M=!0;break}}}if(M)switch(a){case 0:this._vertexShaderSource=u.join("\n");break;case 1:this._fragmentShaderSource=u.join("\n")}}},p.prototype.getName=function(){return this._name},p.prototype.getIDForContext=function(t){return this._ids[t]},p.prototype.getVertexAttributes=function(){return this._vertexAttributes},p.prototype.getVertexAttribute=function(t){var e;for(e=0;e<this._vertexAttributes.length;e++)if(this._vertexAttributes[e].name===t)return this._vertexAttributes[e];return null},p.prototype.getInstanceAttribute=function(t){var e;for(e=0;e<this._instanceAttributes.length;e++)if(this._instanceAttributes[e].name===t)return this._instanceAttributes[e];return null},p.prototype.setupGLProgram=function(t,e){var o,n,r,s,a;if(o=e.createShader(e.VERTEX_SHADER),e.shaderSource(o,this._vertexShaderSource),e.compileShader(o),!e.getShaderParameter(o,e.COMPILE_STATUS))return n=e.getShaderInfoLog(o),i.showGraphicsError("Compiling GLSL vertex shader of '"+this._name+"' failed.",i.ErrorSeverity.SEVERE,"More details:\n"+n,e),void(this._ids[t]=null);if(r=e.createShader(e.FRAGMENT_SHADER),e.shaderSource(r,this._fragmentShaderSource),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS))return n=e.getShaderInfoLog(r),i.showGraphicsError("Compiling GLSL fragment shader of '"+this._name+"' failed.",i.ErrorSeverity.SEVERE,"More details:\n"+n,e),void(this._ids[t]=null);if(this._ids[t]=e.createProgram(),s=this._ids[t],e.attachShader(s,o),e.attachShader(s,r),e.linkProgram(s),!e.getProgramParameter(s,e.LINK_STATUS))return n=e.getProgramInfoLog(s),i.showGraphicsError("Linking GLSL shader '"+this._name+"' failed.",i.ErrorSeverity.SEVERE,"More details: "+n,e),e.deleteProgram(s),void(this._ids[t]=null);for(a=0;a<this._uniforms.length;a++)this._uniforms[a].saveLocation(t,e,this)},p.prototype.setBlending=function(t){switch(this._blendMode){case f.MIX:t.gl.blendFunc(t.gl.SRC_ALPHA,t.gl.ONE_MINUS_SRC_ALPHA);break;case f.ADD:t.gl.blendFunc(t.gl.SRC_ALPHA,t.gl.ONE);break;case f.NONE:break;default:i.crash()}},p.prototype.assignUniforms=function(t,e){var i;if(t.setCurrentShader(this),e)for(i=0;i<this._uniforms.length;i++)void 0!==e[this._uniforms[i].getName()]&&this._uniforms[i].setValue(t.getName(),t.gl,this,e[this._uniforms[i].getName()])},p.prototype.bindVertexBuffers=function(t){var e;for(e=0;e<this._vertexAttributes.length;e++)t.getVertexBuffer(this._vertexAttributes[e].name).bind(t,this)},p.prototype.getUniformArrayLength=function(t){var e;for(e=0;e<this._uniforms.length;e++)if(this._uniforms[e].getName()===t)return this._uniforms[e].getArraySize();return 0},p.prototype.getTextureTypes=function(){var t,e,i=[];for(t=0;t<this._uniforms.length;t++)e=this._uniforms[t].getTextureType(),e&&i.push(e);return i},p.prototype.getCubemapNames=function(){var t,e,i=[];for(t=0;t<this._uniforms.length;t++)e=this._uniforms[t].getCubemapName(),e&&i.push(e);return i},p.prototype.createInstanceBuffers=function(t,e){var i;this._instanceAttributeBuffers.length<t+1&&(this._instanceAttributeBuffers=this._instanceAttributeBuffers.concat(new Array(t-this._instanceAttributeBuffers.length+1)));for(i in this._uniformNamesForInstanceAttributeNames)this._uniformNamesForInstanceAttributeNames.hasOwnProperty(i)&&(this._instanceAttributeBuffers[t]||(this._instanceAttributeBuffers[t]={}),this._instanceAttributeBuffers[t][i]?(this._instanceAttributeBuffers[t][i].resize(e),this._instanceAttributeBuffers[t][i].resetFilledVectors()):this._instanceAttributeBuffers[t][i]=new u(i,this._uniformNamesForInstanceAttributeNames[i],this.getInstanceAttribute(i).size,e))},p.prototype.addDataToInstanceBuffers=function(t,e){var i,o;for(i in this._instanceAttributeBuffers[t])this._instanceAttributeBuffers[t].hasOwnProperty(i)&&(o=this._instanceAttributeBuffers[t][i].getRole(),e.hasOwnProperty(o)&&this._instanceAttributeBuffers[t][i].addVector(e[o](!0)))},p.prototype.bindAndFillInstanceBuffers=function(t,e){var i;for(i in this._instanceAttributeBuffers[e])this._instanceAttributeBuffers[e].hasOwnProperty(i)&&this._instanceAttributeBuffers[e][i].bind(t,this,!0)},p.prototype.deleteInstanceBuffers=function(t){var e,i;for(e=0;e<this._instanceAttributeBuffers.length;e++)for(i in this._instanceAttributeBuffers[e])this._instanceAttributeBuffers[e].hasOwnProperty(i)&&this._instanceAttributeBuffers[e][i]["delete"](t);this._instanceAttributeBuffers=[]},p.prototype.deleteGLProgram=function(t,e){var i;if(this._ids[t]){for(i=0;i<this._uniforms.length;i++)this._uniforms[i].forgetLocations(t);e.deleteProgram(this._ids[t]),delete this._ids[t]}},d.prototype=new o.AsyncResource,d.prototype.constructor=d,d.prototype._createContext=function(){var t,e;i.log("Initializing WebGL context...",1),e={alpha:!0,antialias:this._antialiasing};try{this.gl=this._canvas.getContext("webgl",e)}catch(o){}if(!this.gl){i.log("Initializing a regular context failed, initializing experimental context...",1),e.alpha=!1;try{this.gl=this._canvas.getContext("experimental-webgl",e)}catch(o){}if(!this.gl)return void i.showError("Unable to initialize WebGL.",i.ErrorSeverity.CRITICAL,"It looks like your device, browser or graphics drivers do not support web 3D graphics. Make sure your browser and graphics drivers are updated to the latest version, and you are using a modern web browser (Firefox or Chrome are recommended).\nPlease note that some phones or handheld devices do not have 3D web capabilities, even if you use the latest software.");i.showError("Your device appears to only have experimental WebGL (web based 3D) support.",void 0,"This application relies on 3D web features, and without full support, the graphics of the application might be displayed with glitches or not at all. If you experience problems, it is recommended to use lower graphics quality settings.")}t=this.gl,this._antialiasing&&!t.getContextAttributes().antialias&&i.showGraphicsError("Antialiasing is enabled in graphics settings but it is not supported.",i.ErrorSeverity.MINOR,"Your graphics driver, browser or device unfortunately does not support antialiasing. To avoid this error message showing up again, disable antialiasing in the graphics settings or try running the application in a different browser. Antialiasing will not work, but otherwise this error will have no consequences.",t),this._maxBoundTextures=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this._maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this._maxCubemapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this._maxRenderbufferSize=t.getParameter(t.MAX_RENDERBUFFER_SIZE),this._maxVertexAttributes=t.getParameter(t.MAX_VERTEX_ATTRIBS),this._maxVertexShaderUniforms=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentShaderUniforms=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxVaryings=t.getParameter(t.MAX_VARYING_VECTORS),i.log("WebGL context successfully created.\n Available texture units: "+this._maxBoundTextures+"\n Maximum texture size: "+this._maxTextureSize+"\n Maximum cubemap size: "+this._maxCubemapSize+"\n Maximum renderbuffer size: "+this._maxRenderbufferSize+"\n Available vertex attributes: "+this._maxVertexAttributes+"\n Available vertex shader uniform vectors: "+this._maxVertexShaderUniforms+"\n Available fragment shader uniform vectors: "+this._maxFragmentShaderUniforms+"\n Available varying vectors: "+this._maxVaryings,1),this.anisotropicFilterExt=t.getExtension("EXT_texture_filter_anisotropic"),null===this.anisotropicFilterExt?i.log("Anisotropic filtering not available.",1):i.log("Anisotropic filtering successfully initialized.",1),this.instancingExt=t.getExtension("ANGLE_instanced_arrays"),null===this.instancingExt?i.log("Instancing is not available, and so it will be disabled.",1):i.log("Instancing successfully initialized.",1),t.clearDepth(1),t.colorMask(!0,!0,!0,!0),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.frontFace(t.CCW)},d.prototype.getName=function(){return this._name},d.prototype.getFiltering=function(){return this._filtering},d.prototype.setFiltering=function(e){var o;if(e=t.getSafeEnumValue(_,e,this._filtering),e!==this._filtering)for(this._filtering=e,this._filtering===_.ANISOTROPIC&&(this.anisotropicFilterExt||(i.log("Anisotropic filtering is set, but the required extension is not available. Trilinear filtering will be used.",1),this._filtering=_.TRILINEAR)),o=0;o<this._textures.length;o++)this._textures[o].setMinFiltering&&(this.bindTexture(this._textures[o]),this._textures[o].setMinFiltering(this.gl,this._filtering,this.anisotropicFilterExt))},d.prototype.addShader=function(t){this._shaders.indexOf(t)<0&&(this._shaders.push(t),t.setupGLProgram(this._name,this.gl),this.resetReadyState())},d.prototype.addModel=function(t){this._models.indexOf(t)<0&&(this._models.push(t),this.resetReadyState())},d.prototype.getVertexBuffer=function(t){return this._vertexBuffers[t]},d.prototype.addVertexBuffer=function(t){void 0===this._vertexBuffers[t.getName()]&&(this._vertexBuffers[t.getName()]=t)},d.prototype.getBoundVertexBuffer=function(t){return this._boundVertexBuffers[t]},d.prototype.setBoundVertexBuffer=function(t,e){this._boundVertexBuffers[t]=e},d.prototype.setVertexBufferData=function(t,e){var i;for(i in this._vertexBuffers)this._vertexBuffers.hasOwnProperty(i)&&void 0!==t[this._vertexBuffers[i].getRole()]&&this._vertexBuffers[i].setData(t[this._vertexBuffers[i].getRole()],e)},d.prototype.setupVertexBuffers=function(){var t,e,i,o,n,r;if(this.isReadyToUse()!==!0){for(i in this._vertexBuffers)this._vertexBuffers.hasOwnProperty(i)&&this._vertexBuffers[i]["delete"](this);for(o=0,t=0;t<this._models.length;t++)o+=this._models[t].getBufferSize(this);for(this._vertexBuffers={},t=0;t<this._shaders.length;t++)for(n=this._shaders[t].getVertexAttributes(),e=0;e<n.length;e++)this.addVertexBuffer(new u(n[e].name,n[e].role,n[e].size,o));for(r=0,t=0;t<this._models.length;t++)for(e=this._models[t].getMinLOD();e<=this._models[t].getMaxLOD();e++)r+=this._models[t].loadToVertexBuffers(this,r,e);for(i in this._vertexBuffers)this._vertexBuffers.hasOwnProperty(i)&&this._vertexBuffers[i].loadToGPUMemory(this._name,this.gl);for(this._currentShader=null,t=0;t<this._shaders.length;t++)this.setCurrentShader(this._shaders[t])}},d.prototype.getFrameBuffer=function(t){return this._frameBuffers[t]},d.prototype.addFrameBuffer=function(t){void 0===this._frameBuffers[t.getName()]&&(i.log("Adding new framebuffer '"+t.getName()+"' to context ("+this._name+")...",2),this._frameBuffers[t.getName()]=t,this.isReadyToUse()&&this._frameBuffers[t.getName()].setup(this))},d.prototype.setupFrameBuffers=function(){var t;if(!this.isReadyToUse())for(t in this._frameBuffers)this._frameBuffers.hasOwnProperty(t)&&this._frameBuffers[t].setup(this)},d.prototype.clearFrameBuffers=function(){var t;for(t in this._frameBuffers)this._frameBuffers.hasOwnProperty(t)&&this._frameBuffers[t]["delete"](this);this._frameBuffers={}},d.prototype.setup=function(){i.log("Setting up context '"+this._name+"'...",2),this.setupVertexBuffers(),this.setupFrameBuffers(),this.setToReady()},d.prototype.clear=function(){var t;for(i.log("Clearing context '"+this._name+"'...",2),this.clearFrameBuffers(),this._currentShader=null,t=0;t<this._boundTextures.length;t++)this.unbindTexture(this._boundTextures[t].texture);for(this._boundTextures=[],t=0;t<this._textures.length;t++)this._textures[t].forgetLastTextureBindLocation(this._name);for(t=0;t<this._boundVertexBuffers.length;t++)this.gl.disableVertexAttribArray(t);this._boundVertexBuffers=[]},d.prototype.removeShaders=function(){var t;for(t=0;t<this._shaders.length;t++)this._shaders[t].deleteInstanceBuffers(this),this._shaders[t].deleteGLProgram(this._name,this.gl);this._shaders=[],this._currentShader=null},d.prototype.setCurrentFrameBuffer=function(t){t?this._frameBuffers[t].bind(this):this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)},d.prototype.getCurrentShader=function(){return this._currentShader},d.prototype.setCurrentShader=function(t){return this._currentShader!==t?(i.log("Switching to shader: "+t.getName(),3),this.gl.useProgram(t.getIDForContext(this._name)),t.setBlending(this),t.bindVertexBuffers(this),this._currentShader=t,!0):!1},d.prototype.addTexture=function(t){this._textures.indexOf(t)<0&&(this._textures.push(t),t.createGLTexture(this._name,this.gl),this.bindTexture(t),t.setupGLTexture(this.gl,this._filtering,this.anisotropicFilterExt))},d.prototype.bindTexture=function(t,e,o){var n=void 0!==e||o;if(void 0===e&&(e=t.getLastTextureBindLocation(this._name),void 0===e||e===c.prototype.TEXTURE_LOCATION_NOT_SET||this._boundTextures[e].texture!==t)){for(e=0;e<this._maxBoundTextures&&e<this._boundTextures.length&&this._boundTextures[e];)e++;if(e===this._maxBoundTextures){for(;this._boundTextures[this._nextTextureBindLocation].reserved;)this._nextTextureBindLocation=(this._nextTextureBindLocation+1)%this._maxBoundTextures;e=this._nextTextureBindLocation,this._nextTextureBindLocation=(this._nextTextureBindLocation+1)%this._maxBoundTextures}}return this._boundTextures[e]&&this._boundTextures[e].texture===t||(t instanceof s?(i.log("Binding texture: '"+t.getName()+"' to texture unit "+e+(n?", reserving place.":"."),3),t.bindGLTexture(this._name,this.gl,e)):t instanceof a?(i.log("Binding cubemap texture: '"+t.getName()+"' to texture unit "+e+(n?", reserving place.":"."),3),t.bindGLTexture(this._name,this.gl,e)):t instanceof c?(i.log("Binding framebuffer texture: '"+t.getName()+"' to texture unit "+e+(n?", reserving place.":"."),3),t.bindGLTexture(this.gl,e)):i.showError("Cannot set object: '"+t.toString()+"' as current texture, because it is not of an appropriate type."),this._boundTextures[e]={texture:t,reserved:n}),this._boundTextures[e].reserved!==n&&(this._boundTextures[e].reserved=n,i.log((n?"Reserved":"Freed")+" texture unit index "+e+".",3)),e},d.prototype.unbindTexture=function(t){var e=t&&t.getLastTextureBindLocation(this._name);void 0!==e&&e>=0&&this._boundTextures[e]===t&&(this.gl.activeTexture(this.gl.TEXTURE0+e),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,null),this._boundTextures[e]=null,t.forgetLastTextureBindLocation(this._name))},d.removeTexture=function(t){var e=this._textures.indexOf(t);e>=0&&(this.unbindTexture(t),t.deleteGLTexture(this._name,this.gl),this._textures.splice(e,1))},{TextureFiltering:_,ShaderBlendMode:f,getUniformName:l.prototype.getUniformName,getTextureUniformRawName:l.prototype.getTextureUniformRawName,getCubemapUniformRawName:l.prototype.getCubemapUniformRawName,ManagedTexture:s,ManagedCubemap:a,ManagedShader:p,FrameBuffer:c,ManagedGLContext:d}}),define("modules/resource-manager",["modules/application","modules/async-resource"],function(t,e){"use strict";function i(t){e.AsyncResource.call(this),this._name=t,this._requested=!1,this._requestParams={}}function o(t){e.AsyncResource.call(this),this._resourceType=t,this._resources={},this._numLoadedResources=0,this._numRequestedResources=0}function n(){e.AsyncResource.call(this),this._resourceHolders={},this._numLoadedResources=0,this._numRequestedResources=0,this._onResourceTypeLoadFunctionQueues={},this._onAnyResourceTypeLoadFunctionQueue=[],this._onResourceLoadFunctionQueue=[]}return i.prototype=new e.AsyncResource,i.prototype.constructor=i,i.prototype.getName=function(){return this._name},i.prototype.isRequested=function(t){var e;if(!this._requested)return!1;if(t){for(e in t)if(t.hasOwnProperty(e)&&t[e]!==this._requestParams[e])return!1;for(e in this._requestParams)if(this._requestParams.hasOwnProperty(e)&&this._requestParams[e]!==t[e])return!1}return!0},i.prototype.request=function(t){this._requested=!0,this._requestParams=t},i.prototype.requiresReload=function(){t.showError("Resource class does not implement requiresReload!")},i.prototype.isLoaded=function(){return this.isReadyToUse()},i.prototype._requestFiles=function(){t.showError("Attempting to request files for a resource type that has no file request function implemented!")},i.prototype._loadData=function(){t.showError("Attempting to load data for a resource type that has no data loading function implemented!")},i.prototype._onFilesLoad=function(t,e){this._loadData(e),t===!0&&(this.setToReady(),this._requested=!1)},i.prototype.requestLoadFromFile=function(){this.isReadyToUse()===!1&&this._requested===!0&&this._requestFiles(this._requestParams)},o.prototype=new e.AsyncResource,o.prototype.constructor=o,o.prototype.allResourcesAreLoaded=function(){return this._numLoadedResources===this._numRequestedResources},o.prototype.addResource=function(t){return this._resources[t.getName()]=t,this._resources[t.getName()]},o.prototype.getResource=function(e,i){var o;return this._resources[e]?(o=this._resources[e],i&&i.doNotLoad||o.requiresReload(i)&&(this._numRequestedResources++,this.resetReadyState(),o.resetReadyState(),o.executeWhenReady(function(){this._numLoadedResources++,this.allResourcesAreLoaded()&&this.setToReady()}.bind(this))),o):(i&&i.allowNullResult===!0||t.showError("Requested a resource named '"+e+"' from "+this._resourceType+", which does not exist."),null)},o.prototype.requestResourceLoad=function(){var t;for(t in this._resources)this._resources.hasOwnProperty(t)&&this._resources[t].requestLoadFromFile()},o.prototype.getResourceNames=function(){var t,e=[];for(t in this._resources)this._resources.hasOwnProperty(t)&&e.push(t);return e},n.prototype=new e.AsyncResource,n.prototype.constructor=n,n.prototype.setToReady=function(){e.AsyncResource.prototype.setToReady.call(this),this._onResourceTypeLoadFunctionQueues={},this._onAnyResourceTypeLoadFunctionQueue=[],this._onResourceLoadFunctionQueue=[],this._numRequestedResources=0,this._numLoadedResources=0},n.prototype.executeOnResourceTypeLoad=function(t,e){this._onResourceTypeLoadFunctionQueues[t]=this._onResourceTypeLoadFunctionQueues[t]||[],this._onResourceTypeLoadFunctionQueues[t].push(e)},n.prototype.executeOnAnyResourceTypeLoad=function(t){this._onAnyResourceTypeLoadFunctionQueue.push(t)},n.prototype.executeOnResourceLoad=function(t){this._onResourceLoadFunctionQueue.push(t)},n.prototype.addResource=function(t,e){return this._resourceHolders[t]=this._resourceHolders[t]||new o(t),this._resourceHolders[t].addResource(e)},n.prototype._onResourceLoad=function(t,e){var i,o;for(o=this._onResourceLoadFunctionQueue,i=0;i<o.length;i++)o[i](e,t,this._numRequestedResources,this._numLoadedResources);if(this.allResourcesOfTypeAreLoaded(t))for(o=this._onResourceTypeLoadFunctionQueues[t]||[],i=0;i<o.length;i++)o[i]();this.allResourcesAreLoaded()&&this.setToReady()},n.prototype.getResource=function(e,i,o){var n;return(n=this._resourceHolders[e]?this._resourceHolders[e].getResource(i,o):null)?(o&&o.doNotLoad||n.requiresReload(o)&&(this._numRequestedResources++,this.resetReadyState(),n.request(o),n.executeWhenReady(function(){this._numLoadedResources++,this._onResourceLoad(e,i)}.bind(this))),n):(o.allowNullResult!==!0&&t.showError("Requested a resource named '"+i+"' of type '"+e+"', which does not exist."),null)},n.prototype.requestAllResources=function(){var t,e,i;for(t in this._resourceHolders)if(this._resourceHolders.hasOwnProperty(t))for(e=this._resourceHolders[t].getResourceNames(),i=0;i<e.length;i++)this.getResource(t,e[i])},n.prototype.allResourcesOfTypeAreLoaded=function(t){return this._resourceHolders[t].isReadyToUse()},n.prototype.allResourcesAreLoaded=function(){return this._numLoadedResources===this._numRequestedResources},n.prototype.requestConfigLoad=function(e,i,o,n){t.requestTextFile(i,e,function(t){this._loadConfigFromJSON(JSON.parse(t),o),n&&n()}.bind(this))},n.prototype._loadConfigFromJSON=function(t,e){var i,o,n;for(i in e)if(e.hasOwnProperty(i))for(o=t[i],n=0;n<o.length;n++)this.addResource(i,new e[i](o[n]))},n.prototype.requestResourceLoad=function(){var e;if(t.log("Requesting loading of resources contained in the resource manager...",2),this.allResourcesAreLoaded()===!0)t.log("There are no resources to load, executing set up callback queue right away...",2),this.executeOnReadyQueue();else for(e in this._resourceHolders)this._resourceHolders.hasOwnProperty(e)&&(t.log("Requesting the loading of "+e+" from files...",2),
this._resourceHolders[e].requestResourceLoad())},n.prototype.getResourceNames=function(e){return this._resourceHolders[e]?this._resourceHolders[e].getResourceNames():(t.showError("Asked for the names of resources of type: '"+e+"', but no such resource type exists!"),null)},{GenericResource:i,ResourceManager:n}}),define("utils/vectors",[],function(){"use strict";var t={},e=1e-7;return t.NULL3=[0,0,0],Object.freeze(t.NULL3),t.NULL4=[0,0,0,0],Object.freeze(t.NULL4),t.fromXMLTag3=function(t){return[parseFloat(t.getAttribute("x")),parseFloat(t.getAttribute("y")),parseFloat(t.getAttribute("z"))]},t.perpendicular3=function(t){return[t[1],-t[0],0]},t.length3=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},t.length3Squared=function(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]},t.toString3=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)},t.toString4=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)+" "+t[3].toFixed(e)},t.vector4From3=function(t,e){return[t[0],t[1],t[2],e]},t.normal2=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]),i=0===e?1:1/e;return[t[0]*i,t[1]*i]},t.normal3=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),i=0===e?1:1/e;return[t[0]*i,t[1]*i,t[2]*i]},t.scaled2=function(t,e){return[t[0]*e,t[1]*e]},t.scaled3=function(t,e){return[t[0]*e,t[1]*e,t[2]*e]},t.scaled4=function(t,e){return[t[0]*e,t[1]*e,t[2]*e,t[3]*e]},t.sum3=function(t,e){return[t[0]+e[0],t[1]+e[1],t[2]+e[2]]},t.diff3=function(t,e){return[t[0]-e[0],t[1]-e[1],t[2]-e[2]]},t.dot3=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},t.cross3=function(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]},t.angle2u=function(t,e){return Math.acos(t[0]*e[0]+t[1]*e[1])},t.angle2uCapped=function(t,e){return Math.acos(Math.min(Math.max(-1,t[0]*e[0]+t[1]*e[1]),1))},t.angle3u=function(t,e){return Math.acos(t[0]*e[0]+t[1]*e[1]+t[2]*e[2])},t.angle3uCapped=function(t,e){return Math.acos(Math.min(Math.max(-1,t[0]*e[0]+t[1]*e[1]+t[2]*e[2]),1))},t.mulVec3Mat3=function(t,e){return new Float32Array([e[0]*t[0]+e[3]*t[1]+e[6]*t[2],e[1]*t[0]+e[4]*t[1]+e[7]*t[2],e[2]*t[0]+e[5]*t[1]+e[8]*t[2]])},t.mulVec3Mat4=function(t,e){return new Float32Array([e[0]*t[0]+e[4]*t[1]+e[8]*t[2],e[1]*t[0]+e[5]*t[1]+e[9]*t[2],e[2]*t[0]+e[6]*t[1]+e[10]*t[2]])},t.mulVec4Mat4=function(t,e){return new Float32Array([e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12]*t[3],e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13]*t[3],e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14]*t[3],e[3]*t[0]+e[7]*t[1]+e[11]*t[2]+e[15]*t[3]])},t.mulMat3Vec3=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[1]+t[2]*e[2],t[3]*e[0]+t[4]*e[1]+t[5]*e[2],t[6]*e[0]+t[7]*e[1]+t[8]*e[2]])},t.mulMat4Vec3=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[1]+t[2]*e[2],t[4]*e[0]+t[5]*e[1]+t[6]*e[2],t[8]*e[0]+t[9]*e[1]+t[10]*e[2]])},t.mulMat4Vec4=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3],t[4]*e[0]+t[5]*e[1]+t[6]*e[2]+t[7]*e[3],t[8]*e[0]+t[9]*e[1]+t[10]*e[2]+t[11]*e[3],t[12]*e[0]+t[13]*e[1]+t[14]*e[2]+t[15]*e[3]])},t.negate2=function(t){t[0]=-t[0],t[1]=-t[1]},t.normalize2=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]),i=0===e?1:1/e;t[0]*=i,t[1]*=i},t.normalize3=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),i=0===e?1:1/e;t[0]*=i,t[1]*=i,t[2]*=i},t.normalize4D=function(t){t[3]=t[3]||e,t[0]/=t[3],t[1]/=t[3],t[2]/=t[3],t[3]=1},t.add3=function(t,e){t[0]+=e[0],t[1]+=e[1],t[2]+=e[2]},t.mulCross3=function(t,e){var i=t[0],o=t[1],n=t[2];t[0]=o*e[2]-n*e[1],t[1]=n*e[0]-i*e[2],t[2]=i*e[1]-o*e[0]},t}),define("modules/egom-model",["utils/vectors","modules/application"],function(t,e){"use strict";function i(t,e){this.x=t[0],this.y=t[1],this.z=t[2],e=e||[this.x,this.y],this.u=e[0],this.v=e[1]}function o(t,e,i,o,n){this.a=t,this.b=e,this.color=i,this.luminosity=o,this.normal=n}function n(e,i,o,n,r,s,a,h,l,u){this._mesh=e,this.a=i,this.b=o,this.c=n,this.color=r,this.luminosity=s,this.shininess=a,this.texCoords=h,this._normals=l||t.normal3(t.cross3(this._mesh.getVector(i,o),this._mesh.getVector(i,n))),this.groupIndex=u||0}function r(){this.bufferStartWireframe=0,this.bufferStartSolid=0,this.bufferStartTransparent=0}function s(){this._vertices=[],this._lines=[],this._triangles=[],this._size=0,this._maxX=0,this._minX=0,this._maxY=0,this._minY=0,this._maxZ=0,this._minZ=0,this._nOpaqueTriangles=0,this._nTransparentTriangles=0,this._contextProperties={},this._texCoords=[[0,1],[1,1],[1,0],[0,0]],this._luminosity=0,this._shininess=0,this._currentGroupIndex=0,this._nullVertex=new i([0,0,0])}function a(t,e,i,o,n,r){var s=[0,0];return s[0]=t+(i-t)*n,s[1]=e+(o-e)*r,s}function h(){this.wireframe=!1,this.solid=!1,this.minLOD=0,this.maxLOD=0}function l(){this._meshes=[],this._minLOD=this.LOD_NOT_SET,this._maxLOD=this.LOD_NOT_SET,this._editedMesh=null,this._minEditedLOD=0,this._maxEditedLOD=0,this._name=null,this._infoProperties={},this._scale=1,this._contextProperties={}}var u=["2.0","2.1","2.2","3.0"];return i.prototype.getTexCoords=function(){return[this.u,this.v]},i.prototype.setX=function(t){this.x=t},i.prototype.setY=function(t){this.y=t},i.prototype.setZ=function(t){this.z=t},n.prototype.getNormal=function(t){return this._normals[t]||this._normals[0]},s.prototype.getNumOpaqueTriangles=function(){return this._nOpaqueTriangles},s.prototype.getNumTransparentTriangles=function(){return this._nTransparentTriangles},s.prototype.getNumTriangles=function(t){return void 0===t?this._triangles.length:t?this._nTransparentTriangles:this._nOpaqueTriangles},s.prototype.setDefaultProperties=function(t,e){this._luminosity=t,this._shininess=e},s.prototype.resetMesh=function(){this.resetVertices(),this.resetLines(),this.resetTriangles()},s.prototype.resetVertices=function(){this._vertices=[],this._maxX=0,this._minX=0,this._maxY=0,this._minY=0,this._maxZ=0,this._minZ=0},s.prototype.setVertex=function(t,e){var i;if(this._vertices.length<t)for(i=this._vertices.length;t>i;i++)this._vertices[i]=this._nullVertex;this._vertices[t]=e,Math.abs(2*this._vertices[t].x)>this._size&&(this._size=Math.abs(2*this._vertices[t].x)),Math.abs(2*this._vertices[t].y)>this._size&&(this._size=Math.abs(2*this._vertices[t].y)),Math.abs(2*this._vertices[t].z)>this._size&&(this._size=Math.abs(2*this._vertices[t].z)),this._vertices[t].x>this._maxX&&(this._maxX=this._vertices[t].x),this._vertices[t].x<this._minX&&(this._minX=this._vertices[t].x),this._vertices[t].y>this._maxY&&(this._maxY=this._vertices[t].y),this._vertices[t].y<this._minY&&(this._minY=this._vertices[t].y),this._vertices[t].z>this._maxZ&&(this._maxZ=this._vertices[t].z),this._vertices[t].z<this._minZ&&(this._minZ=this._vertices[t].z)},s.prototype.appendVertex=function(t,e){this.setVertex(this._vertices.length,new i(t,e))},s.prototype.resetLines=function(){this._lines=[]},s.prototype.addLine=function(t){this._lines.push(t)},s.prototype.setLine=function(t,e){this._lines[t]=e},s.prototype.resetTriangles=function(){this._triangles=[],this._nOpaqueTriangles=0,this._nTransparentTriangles=0},s.prototype.getVector=function(t,e){return[this._vertices[e].x-this._vertices[t].x,this._vertices[e].y-this._vertices[t].y,this._vertices[e].z-this._vertices[t].z]},s.prototype.addTriangle=function(t,e){this._triangles.push(t),e||(this._lines.push(new o(t.a,t.b,t.color,t.luminosity,t.getNormal(0))),this._lines.push(new o(t.b,t.c,t.color,t.luminosity,t.getNormal(0))),this._lines.push(new o(t.c,t.a,t.color,t.luminosity,t.getNormal(0)))),t.color[3]<1?this._nTransparentTriangles++:this._nOpaqueTriangles++},s.prototype.addTriangleWithParams=function(t,e,i,o){var r,s,a,h,l,u,c;return r=o.color||[1,1,1,1],s=o.luminosity||this._luminosity,a=o.shininess||this._shininess,h=o.useVertexTexCoords?[this._vertices[t].getTexCoords(),this._vertices[e].getTexCoords(),this._vertices[i].getTexCoords()]:o.texCoords||[this._texCoords[0],this._texCoords[1],this._texCoords[2]],l=o.normals,u=o.groupIndex||this._currentGroupIndex,c=new n(this,t,e,i,r,s,a,h,l,u),this.addTriangle(c,o.withoutLines),c},s.prototype.addQuad=function(t,e,i,n,r){var s,a,h,l,u;r=r||{},s=Object.create(r),s.withoutLines=!0,s.texCoords=r.useVertexTexCoords?[this._vertices[t].getTexCoords(),this._vertices[e].getTexCoords(),this._vertices[i].getTexCoords()]:r.texCoords?[r.texCoords[0],r.texCoords[1],r.texCoords[2]]:[this._texCoords[0],this._texCoords[1],this._texCoords[2]],s.normals=r.normals?4===r.normals.length?[r.normals[0],r.normals[1],r.normals[2]]:r.normals:null,this.addTriangleWithParams(t,e,i,s),a=Object.create(r),a.texCoords=r.useVertexTexCoords?[this._vertices[i].getTexCoords(),this._vertices[n].getTexCoords(),this._vertices[t].getTexCoords()]:r.texCoords?[r.texCoords[2],r.texCoords[3],r.texCoords[0]]:[this._texCoords[2],this._texCoords[3],this._texCoords[0]],a.normals=r.normals?4===r.normals.length?[r.normals[2],r.normals[3],r.normals[0]]:r.normals:null,this.addTriangleWithParams(i,n,t,a),r.withoutLines||(h=r.color||[1,1,1,1],l=r.luminosity||this._luminosity,u=r.normals?r.normals[0]:null,this._lines.push(new o(t,e,h,l,u)),this._lines.push(new o(e,i,h,l,u)),this._lines.push(new o(i,n,h,l,u)),this._lines.push(new o(n,t,h,l,u)))},s.prototype.getSize=function(){return this._size},s.prototype.getMaxX=function(){return this._maxX},s.prototype.getMinX=function(){return this._minX},s.prototype.getMaxY=function(){return this._maxY},s.prototype.getMinY=function(){return this._minY},s.prototype.getMaxZ=function(){return this._maxZ},s.prototype.getMinZ=function(){return this._minZ},s.prototype.getWidth=function(){return this._maxX-this._minX},s.prototype.getHeight=function(){return this._maxY-this._minY},s.prototype.getDepth=function(){return this._maxZ-this._minZ},s.prototype.getBufferData=function(t,e){var i,o,n,r,s,a,h,l,u,c,p,d,_,g;if(e=e||0,t===!0){for(n=this._lines.length,h=new Float32Array(6*n),i=0;n>i;i++)h[6*i]=this._vertices[this._lines[i].a].x,h[6*i+1]=this._vertices[this._lines[i].a].y,h[6*i+2]=this._vertices[this._lines[i].a].z,h[6*i+3]=this._vertices[this._lines[i].b].x,h[6*i+4]=this._vertices[this._lines[i].b].y,h[6*i+5]=this._vertices[this._lines[i].b].z;for(l=new Float32Array(4*n),i=0;n>i;i++)l[4*i]=0,l[4*i+1]=1,l[4*i+2]=1,l[4*i+3]=1;for(u=new Float32Array(6*n),i=0;n>i;i++)u[6*i]=this._lines[i].normal[0],u[6*i+1]=this._lines[i].normal[1],u[6*i+2]=this._lines[i].normal[2],u[6*i+3]=this._lines[i].normal[0],u[6*i+4]=this._lines[i].normal[1],u[6*i+5]=this._lines[i].normal[2];for(c=new Float32Array(8*n),i=0;n>i;i++)c[8*i]=this._lines[i].color[0],c[8*i+1]=this._lines[i].color[1],c[8*i+2]=this._lines[i].color[2],c[8*i+3]=1,c[8*i+4]=this._lines[i].color[0],c[8*i+5]=this._lines[i].color[1],c[8*i+6]=this._lines[i].color[2],c[8*i+7]=1;for(p=new Float32Array(2*n),i=0;n>i;i++)p[2*i]=this._lines[i].luminosity,p[2*i+1]=this._lines[i].luminosity;for(d=new Float32Array(2*n),i=0;n>i;i++)d[2*i]=0,d[2*i+1]=0;for(_=new Float32Array(2*n),i=0;n>i;i++)_[2*i]=0,_[2*i+1]=0;for(r=this._triangles.length,g=new Float32Array(3*r),i=0;r>i;i++)g[12*i]=0,g[12*i+1]=0,g[12*i+2]=0,g[12*i+3]=0,g[12*i+4]=0,g[12*i+5]=0,g[12*i+6]=0,g[12*i+7]=0,g[12*i+8]=0,g[12*i+9]=0,g[12*i+10]=0,g[12*i+11]=0}else{for(r=this._triangles.length,h=new Float32Array(9*r),i=0;r>i;i++)h[9*i]=this._vertices[this._triangles[i].a].x,h[9*i+1]=this._vertices[this._triangles[i].a].y,h[9*i+2]=this._vertices[this._triangles[i].a].z,h[9*i+3]=this._vertices[this._triangles[i].b].x,h[9*i+4]=this._vertices[this._triangles[i].b].y,h[9*i+5]=this._vertices[this._triangles[i].b].z,h[9*i+6]=this._vertices[this._triangles[i].c].x,h[9*i+7]=this._vertices[this._triangles[i].c].y,h[9*i+8]=this._vertices[this._triangles[i].c].z;for(l=new Float32Array(6*r),i=0;r>i;i++)l[6*i]=this._triangles[i].texCoords[0][0],l[6*i+1]=this._triangles[i].texCoords[0][1],l[6*i+2]=this._triangles[i].texCoords[1][0],l[6*i+3]=this._triangles[i].texCoords[1][1],l[6*i+4]=this._triangles[i].texCoords[2][0],l[6*i+5]=this._triangles[i].texCoords[2][1];for(u=new Float32Array(9*r),i=0;r>i;i++)u[9*i]=this._triangles[i].getNormal(0)[0],u[9*i+1]=this._triangles[i].getNormal(0)[1],u[9*i+2]=this._triangles[i].getNormal(0)[2],u[9*i+3]=this._triangles[i].getNormal(1)[0],u[9*i+4]=this._triangles[i].getNormal(1)[1],u[9*i+5]=this._triangles[i].getNormal(1)[2],u[9*i+6]=this._triangles[i].getNormal(2)[0],u[9*i+7]=this._triangles[i].getNormal(2)[1],u[9*i+8]=this._triangles[i].getNormal(2)[2];for(c=new Float32Array(12*r),i=0;r>i;i++)c[12*i]=this._triangles[i].color[0],c[12*i+1]=this._triangles[i].color[1],c[12*i+2]=this._triangles[i].color[2],c[12*i+3]=this._triangles[i].color[3],c[12*i+4]=this._triangles[i].color[0],c[12*i+5]=this._triangles[i].color[1],c[12*i+6]=this._triangles[i].color[2],c[12*i+7]=this._triangles[i].color[3],c[12*i+8]=this._triangles[i].color[0],c[12*i+9]=this._triangles[i].color[1],c[12*i+10]=this._triangles[i].color[2],c[12*i+11]=this._triangles[i].color[3];for(p=new Float32Array(3*r),i=0;r>i;i++)p[3*i]=this._triangles[i].luminosity,p[3*i+1]=this._triangles[i].luminosity,p[3*i+2]=this._triangles[i].luminosity;for(d=new Float32Array(3*r),i=0;r>i;i++)d[3*i]=this._triangles[i].shininess,d[3*i+1]=this._triangles[i].shininess,d[3*i+2]=this._triangles[i].shininess;for(_=new Float32Array(3*r),i=0;r>i;i++)_[3*i]=this._triangles[i].groupIndex,_[3*i+1]=this._triangles[i].groupIndex,_[3*i+2]=this._triangles[i].groupIndex;for(g=new Float32Array(12*r),i=0;r>i;i++){for(s=e+i,a=[],o=0;4>o;o++)a[o]=s%256/255,s=Math.floor(s/256);g[12*i]=a[0],g[12*i+1]=a[1],g[12*i+2]=a[2],g[12*i+3]=a[3],g[12*i+4]=a[0],g[12*i+5]=a[1],g[12*i+6]=a[2],g[12*i+7]=a[3],g[12*i+8]=a[0],g[12*i+9]=a[1],g[12*i+10]=a[2],g[12*i+11]=a[3]}}return{position:h,texCoord:l,normal:u,color:c,luminosity:p,shininess:d,groupIndex:_,triangleIndex:g,dataSize:t?2*this._lines.length:3*this._triangles.length}},s.prototype.getBufferSize=function(t,e){return(t?2*this._lines.length:0)+(e?3*this._triangles.length:0)},s.prototype.loadToVertexBuffers=function(t,e,i,o){var n=null,s=0,a=this._contextProperties[t.getName()]||new r;return i&&(n=this.getBufferData(!0,e),a.bufferStartWireframe=e,t.setVertexBufferData(n,e),s+=n.dataSize,e+=n.dataSize),o&&(n=this.getBufferData(!1,e),a.bufferStartSolid=e,a.bufferStartTransparent=e+3*this._nOpaqueTriangles,t.setVertexBufferData(n,e),s+=n.dataSize,e+=n.dataSize),this._contextProperties[t.getName()]=a,s},s.prototype.render=function(t,e,i){var o=this._contextProperties[t.getName()];if(e===!0)t.gl.drawArrays(t.gl.LINES,o.bufferStartWireframe,2*this._lines.length);else switch(i){case!0:t.gl.drawArrays(t.gl.TRIANGLES,o.bufferStartSolid,3*this._nOpaqueTriangles);break;case!1:t.gl.drawArrays(t.gl.TRIANGLES,o.bufferStartTransparent,3*this._nTransparentTriangles);break;case void 0:t.gl.drawArrays(t.gl.TRIANGLES,o.bufferStartSolid,3*this._triangles.length)}},s.prototype.renderInstances=function(t,e,i,o){var n=this._contextProperties[t.getName()];if(e===!0)t.instancingExt.drawArraysInstancedANGLE(t.gl.LINES,n.bufferStartWireframe,2*this._lines.length,o);else switch(i){case!0:t.instancingExt.drawArraysInstancedANGLE(t.gl.TRIANGLES,n.bufferStartSolid,3*this._nOpaqueTriangles,o);break;case!1:t.instancingExt.drawArraysInstancedANGLE(t.gl.TRIANGLES,n.bufferStartTransparent,3*this._nTransparentTriangles,o);break;case void 0:t.instancingExt.drawArraysInstancedANGLE(t.gl.TRIANGLES,n.bufferStartSolid,3*this._triangles.length,o)}},s.prototype.addCuboid=function(e,i,o,n,r,s,a,h,l,u){var c,p,d,_;for(p=+this._vertices.length,this.appendVertex([e-n/2,i-r/2,o+s/2]),this.appendVertex([e+n/2,i-r/2,o+s/2]),this.appendVertex([e+n/2,i+r/2,o+s/2]),this.appendVertex([e-n/2,i+r/2,o+s/2]),this.appendVertex([e-n/2,i+r/2,o-s/2]),this.appendVertex([e+n/2,i+r/2,o-s/2]),this.appendVertex([e+n/2,i-r/2,o-s/2]),this.appendVertex([e-n/2,i-r/2,o-s/2]),this.appendVertex([e+n/2,i+r/2,o-s/2]),this.appendVertex([e-n/2,i+r/2,o-s/2]),this.appendVertex([e-n/2,i+r/2,o+s/2]),this.appendVertex([e+n/2,i+r/2,o+s/2]),this.appendVertex([e-n/2,i-r/2,o-s/2]),this.appendVertex([e+n/2,i-r/2,o-s/2]),this.appendVertex([e+n/2,i-r/2,o+s/2]),this.appendVertex([e-n/2,i-r/2,o+s/2]),this.appendVertex([e+n/2,i-r/2,o-s/2]),this.appendVertex([e+n/2,i+r/2,o-s/2]),this.appendVertex([e+n/2,i+r/2,o+s/2]),this.appendVertex([e+n/2,i-r/2,o+s/2]),this.appendVertex([e-n/2,i+r/2,o-s/2]),this.appendVertex([e-n/2,i-r/2,o-s/2]),this.appendVertex([e-n/2,i-r/2,o+s/2]),this.appendVertex([e-n/2,i+r/2,o+s/2]),d=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],_={color:a,luminosity:h,texCoords:l},c=0;6>c;c++)_.normals=[d[c]],this.addQuad(p+4*c,p+4*c+1,p+4*c+2,p+4*c+3,_),u||(_.normals=[t.scaled3(d[c],-1)],this.addQuad(p+4*c+2,p+4*c+1,p+4*c,p+4*c+3,_))},s.prototype.addSphere=function(e,i,o,n,r,s,h,l,u,c){var p,d,_,g,f,m,y,S,T,x;for(p=0;r>p;p++)for(_=0;r>_;_++)this.appendVertex([e+n*Math.sin(2*_*Math.PI/r)*Math.cos(2*p*Math.PI/r),i+n*Math.cos(2*_*Math.PI/r),o+n*Math.sin(2*p*Math.PI/r)*Math.sin(2*_*Math.PI/r)]);for(d=this._vertices.length-r*r,r%2===1&&(this._vertices[d+(r+1)/2].setX(e),this._vertices[d+(r+1)/2].setZ(o)),p=0;r>p;p++)for(g=[d+p*r,d+(p+1)%r*r+1,d+p*r+1],f=a(u[0][0],u[0][1],u[2][0],u[2][1],1/(2*r)+p/r,1),m=a(u[0][0],u[0][1],u[2][0],u[2][1],(p+1)/r,1-2/r),y=a(u[0][0],u[0][1],u[2][0],u[2][1],p/r,1-2/r),S=[(this._vertices[g[0]].x-e)/n,(this._vertices[g[0]].y-i)/n,(this._vertices[g[0]].z-o)/n],T=[(this._vertices[g[1]].x-e)/n,(this._vertices[g[1]].y-i)/n,(this._vertices[g[1]].z-o)/n],x=[(this._vertices[g[2]].x-e)/n,(this._vertices[g[2]].y-i)/n,(this._vertices[g[2]].z-o)/n],this.addTriangleWithParams(g[0],g[1],g[2],{color:s,luminosity:h,shininess:l,texCoords:[f,m,y],normals:[S,T,x]}),c!==!0&&this.addTriangleWithParams(g[0],g[2],g[1],{color:s,luminosity:h,shininess:l,texCoords:[f,y,m],normals:[t.scaled3(S,-1),t.scaled3(x,-1),t.scaled3(T,-1)]}),g=r%2===0?[d+p*r+r/2,d+p*r+r/2-1,d+(p+1)%r*r+r/2-1]:[d+(r+1)/2,d+p*r+(r-1)/2,d+(p+1)%r*r+(r-1)/2],f=a(u[0][0],u[0][1],u[2][0],u[2][1],1/(2*r)+p/r,0),m=a(u[0][0],u[0][1],u[2][0],u[2][1],p/r,r%2===0?2/r:1/r),y=a(u[0][0],u[0][1],u[2][0],u[2][1],(p+1)/r,r%2===0?2/r:1/r),S=[(this._vertices[g[0]].x-e)/n,(this._vertices[g[0]].y-i)/n,(this._vertices[g[0]].z-o)/n],T=[(this._vertices[g[1]].x-e)/n,(this._vertices[g[1]].y-i)/n,(this._vertices[g[1]].z-o)/n],x=[(this._vertices[g[2]].x-e)/n,(this._vertices[g[2]].y-i)/n,(this._vertices[g[2]].z-o)/n],this.addTriangleWithParams(g[0],g[1],g[2],{color:s,luminosity:h,shininess:l,texCoords:[f,m,y],normals:[S,T,x]}),c!==!0&&this.addTriangleWithParams(g[0],g[2],g[1],{color:s,luminosity:h,shininess:l,texCoords:[f,y,m],normals:[t.scaled3(S,-1),t.scaled3(x,-1),t.scaled3(T,-1)]}),_=1;r/2-1>_;_++)g=[d+p*r+_,d+(p+1)%r*r+_+1,d+p*r+_+1],f=a(u[0][0],u[0][1],u[2][0],u[2][1],p/r,1-2*_/r),m=a(u[0][0],u[0][1],u[2][0],u[2][1],(p+1)/r,1-2*(_+1)/r),y=a(u[0][0],u[0][1],u[2][0],u[2][1],p/r,1-2*(_+1)/r),S=[(this._vertices[g[0]].x-e)/n,(this._vertices[g[0]].y-i)/n,(this._vertices[g[0]].z-o)/n],T=[(this._vertices[g[1]].x-e)/n,(this._vertices[g[1]].y-i)/n,(this._vertices[g[1]].z-o)/n],x=[(this._vertices[g[2]].x-e)/n,(this._vertices[g[2]].y-i)/n,(this._vertices[g[2]].z-o)/n],this.addTriangleWithParams(g[0],g[1],g[2],{color:s,luminosity:h,shininess:l,texCoords:[f,m,y],normals:[S,T,x]}),c!==!0&&this.addTriangleWithParams(g[0],g[2],g[1],{color:s,luminosity:h,shininess:l,texCoords:[f,y,m],normals:[t.scaled3(S,-1),t.scaled3(x,-1),t.scaled3(T,-1)]}),g=[d+(p+1)%r*r+_+1,d+p*r+_,d+(p+1)%r*r+_],f=a(u[0][0],u[0][1],u[2][0],u[2][1],(p+1)/r,1-2*(_+1)/r),m=a(u[0][0],u[0][1],u[2][0],u[2][1],p/r,1-2*_/r),y=a(u[0][0],u[0][1],u[2][0],u[2][1],(p+1)/r,1-2*_/r),S=[(this._vertices[g[0]].x-e)/n,(this._vertices[g[0]].y-i)/n,(this._vertices[g[0]].z-o)/n],T=[(this._vertices[g[1]].x-e)/n,(this._vertices[g[1]].y-i)/n,(this._vertices[g[1]].z-o)/n],x=[(this._vertices[g[2]].x-e)/n,(this._vertices[g[2]].y-i)/n,(this._vertices[g[2]].z-o)/n],this.addTriangleWithParams(g[0],g[1],g[2],{color:s,luminosity:h,shininess:l,texCoords:[f,m,y],normals:[S,T,x]}),c!==!0&&this.addTriangleWithParams(g[0],g[2],g[1],{color:s,luminosity:h,shininess:l,texCoords:[f,y,m],normals:[t.scaled3(S,-1),t.scaled3(x,-1),t.scaled3(T,-1)]})},l.prototype.LOD_NOT_SET=-1,l.prototype.getName=function(){return this._name},l.prototype.setName=function(t){this._name=t},l.prototype.setDefaultProperties=function(t,e){var i;for(i=0;i<this._meshes.length;i++)this._meshes[i].setDefaultProperties(t,e)},l.prototype.getMinLOD=function(){return this._minLOD},l.prototype.getMaxLOD=function(){return this._maxLOD},l.prototype.getClosestAvailableLOD=function(t){return Math.min(Math.max(this.getMinLOD(),t),this.getMaxLOD())},l.prototype.updateLODInfo=function(t,e){this._minLOD=this._minLOD===this.LOD_NOT_SET?t:t<this._minLOD?t:this._minLOD,this._maxLOD=this._maxLOD===this.LOD_NOT_SET?e:e>this._maxLOD?e:this._maxLOD},l.prototype.getMeshWithLOD=function(t){var e;for(e=this._meshes.length;t>=e;e++)this._meshes.push(new s);return this._meshes[t]},l.prototype.startEditingMeshWithLOD=function(t){this._editedMesh=this.getMeshWithLOD(t),this._minEditedLOD=t,this._maxEditedLOD=t},l.prototype.getCurrentlyEditedMesh=function(){return this._editedMesh},l.prototype.setMinimumEditedLOD=function(t){this._minEditedLOD=t,this._editedMesh=this._minEditedLOD===this._maxEditedLOD?this.getMeshWithLOD(t):null},l.prototype.setMaximumEditedLOD=function(t){this._maxEditedLOD=t,this._editedMesh=this._minEditedLOD===this._maxEditedLOD?this.getMeshWithLOD(t):null},l.prototype.loadFromXML=function(t,n,r){var s,a,h,l,c,p,d,_,g,f,m,y,S,T,x,b,M,v,O,E,A,R,C,w,N,L,I=null,D=null,F=null,V=null,P=function(t,e){var i;if(null===I){for(i=t;e>=i;i++)this.getMeshWithLOD(i).resetMesh();I=t,D=e}else{for(i=t;I>i;i++)this.getMeshWithLOD(i).resetMesh();for(i=D+1;e>=i;i++)this.getMeshWithLOD(i).resetMesh();I=I>t?t:I,D=e>D?e:D}}.bind(this),B=function(t){return t.split(",").map(parseFloat)};if(r=r||0,e.log("Loading EgomModel data from file: "+t+" ...",2),!(n instanceof Document))return e.showError("'"+t+"' does not appear to be an XML document.",e.ErrorSeverity.SEVERE,"A model was supposed to be loaded from this file, but only models of EgomModel format are accepted. Such a file needs to be a valid XML document with an EgomModel root element or a valid JSON file."),!1;if("EgomModel"!==n.documentElement.nodeName)return e.showError("'"+t+"' does not appear to be an EgomModel file.",e.ErrorSeverity.SEVERE,"A model was supposed to be loaded from this file, but only models of EgomModel format are accepted. Such a file needs to have an EgomModel as root element, while this file has '"+n.documentElement.nodeName+"' instead."),!1;if(d=n.documentElement.getAttribute("version"),!d)return e.showError("Model from file: '"+t+"' could not be loaded, because the file version could not have been determined.",e.ErrorSeverity.SEVERE),!1;if(u.indexOf(d)<0)return e.showError("Model from file: '"+t+"' could not be loaded, because the version of the file ("+d+") is not supported.",e.ErrorSeverity.SEVERE,"Supported versions are: "+u.join(", ")+"."),!1;if(this._name=null,this._scale=1,_=0,g=null,this._infoProperties={},n.getElementsByTagName("info").length>0)for(f=n.getElementsByTagName("info")[0].getElementsByTagName("property"),s=0;s<f.length;s++)switch(m=f[s].getAttribute("name")){case"name":this._name=f[s].getAttribute("value");break;case"scale":this._scale=f[s].getAttribute("value");break;case"defaultLOD":y=f[s].getAttribute("value").split("-"),F=parseInt(y[0],10),V=parseInt(y[1],10);break;case"defaultShininess":_=parseInt(f[s].getAttribute("value"),10);break;case"colorPalette":g=f[s].getAttribute("value").split(" ").map(B);break;default:this._infoProperties[m]=f[s].getAttribute("value")}switch("2.0"===d&&(this._scale=10*parseFloat(this._infoProperties["size of one unit in mm"])),S=null,T=null,x=null,d){case"2.0":S="vertex",T="line",x="triangle";break;case"2.1":case"2.2":S="v",T="l",x="t"}for(M=n.getElementsByTagName(S),v=M.length,s=0;v>s;s++)for(C=parseInt(M[s].getAttribute("i"),10),l=null===F?r:F,c=null===V?r:V,M[s].hasAttribute("lod")&&(p=M[s].getAttribute("lod").split("-"),l=parseInt(p[0],10),c=parseInt(p[1],10)),this.updateLODInfo(l,c),P(l,c),w=new i(parseFloat(d)>=2.1?[parseFloat(M[s].getAttribute("x")),parseFloat(M[s].getAttribute("y")),parseFloat(M[s].getAttribute("z"))]:[parseFloat(M[s].getAttribute("x"))/1e4,parseFloat(M[s].getAttribute("y"))/-1e4,parseFloat(M[s].getAttribute("z"))/-1e4]),a=l;c>=a;a++)this.getMeshWithLOD(a).setVertex(C,w);for(e.log("Loaded "+v+" vertices.",3),O=n.getElementsByTagName(T),E=O.length,s=0;E>s;s++)for(l=null===F?r:F,c=null===V?r:V,O[s].hasAttribute("lod")&&(p=O[s].getAttribute("lod").split("-"),l=parseInt(p[0],10),c=parseInt(p[1],10)),this.updateLODInfo(l,c),P(l,c),N=new o(parseInt(O[s].getAttribute("a"),10),parseInt(O[s].getAttribute("b"),10),parseFloat(d)>=2.1?g?g[parseInt(O[s].getAttribute("color"),10)]:O[s].getAttribute("color").split(",").map(parseFloat):[parseInt(O[s].getAttribute("red"),10)/255,parseInt(O[s].getAttribute("green"),10)/255,parseInt(O[s].getAttribute("blue"),10)/255],parseFloat(d)>=2.1?O[s].hasAttribute("lum")?parseFloat(O[s].getAttribute("lum")):0:parseInt(O[s].getAttribute("luminosity"),10)/255,parseFloat(d)>=2.1?O[s].getAttribute("n").split(",").map(parseFloat):[parseFloat(O[s].getAttribute("nx")),-parseFloat(O[s].getAttribute("ny")),-parseFloat(O[s].getAttribute("nz"))]),a=l;c>=a;a++)this.getMeshWithLOD(a).addLine(N);for(e.log("Loaded "+E+" lines.",3),A=n.getElementsByTagName(x),R=A.length,b={},s=0;R>s;s++)for(l=null===F?r:F,c=null===V?r:V,A[s].hasAttribute("lod")&&(p=A[s].getAttribute("lod").split("-"),l=parseInt(p[0],10),c=parseInt(p[1],10)),this.updateLODInfo(l,c),P(l,c),b.color=parseFloat(d)>=2.1?g?g[parseInt(A[s].getAttribute("color"),10)]:A[s].getAttribute("color").split(",").map(parseFloat):[parseInt(A[s].getAttribute("red"),10)/255,parseInt(A[s].getAttribute("green"),10)/255,parseInt(A[s].getAttribute("blue"),10)/255,(255-parseInt(A[s].getAttribute("alpha"),10))/255],b.luminosity=parseFloat(d)>=2.1?A[s].hasAttribute("lum")?parseFloat(A[s].getAttribute("lum")):0:parseInt(A[s].getAttribute("luminosity"),10)/255,b.shininess=parseFloat(d)>=2.1?A[s].hasAttribute("shi")?parseInt(A[s].getAttribute("shi"),10):_:parseInt(A[s].getAttribute("shininess"),10),b.texCoords=parseFloat(d)>=2.1?[A[s].getAttribute("ta").split(",").map(parseFloat),A[s].getAttribute("tb").split(",").map(parseFloat),A[s].getAttribute("tc").split(",").map(parseFloat)]:[[parseFloat(A[s].getAttribute("tax")),parseFloat(A[s].getAttribute("tay"))],[parseFloat(A[s].getAttribute("tbx")),parseFloat(A[s].getAttribute("tby"))],[parseFloat(A[s].getAttribute("tcx")),parseFloat(A[s].getAttribute("tcy"))]],b.normals=parseFloat(d)>=2.1?A[s].hasAttribute("n")?[A[s].getAttribute("n").split(",").map(parseFloat)]:[A[s].getAttribute("na").split(",").map(parseFloat),A[s].getAttribute("nb").split(",").map(parseFloat),A[s].getAttribute("nc").split(",").map(parseFloat)]:[[parseFloat(A[s].getAttribute("nax"))/1e4,-parseFloat(A[s].getAttribute("nay"))/1e4,-parseFloat(A[s].getAttribute("naz"))/1e4],[parseFloat(A[s].getAttribute("nbx"))/1e4,-parseFloat(A[s].getAttribute("nby"))/1e4,-parseFloat(A[s].getAttribute("nbz"))/1e4],[parseFloat(A[s].getAttribute("ncx"))/1e4,-parseFloat(A[s].getAttribute("ncy"))/1e4,-parseFloat(A[s].getAttribute("ncz"))/1e4]],b.groupIndex=A[s].hasAttribute("group")?A[s].getAttribute("group"):null,b.withoutLines=!0,L=null,a=l;c>=a;a++)L?this.getMeshWithLOD(a).addTriangle(L,b.withoutLines):L=this.getMeshWithLOD(a).addTriangleWithParams(A[s].getAttribute("a"),A[s].getAttribute("b"),A[s].getAttribute("c"),b);for(e.log("Loaded "+A.length+" triangles.",3),e.log("Model loaded: "+this._name+". Details: "+this._minLOD+"-"+this._maxLOD,2),h="Number of triangles per LOD for "+this._name+": ",s=this._minLOD;s<=this._maxLOD;s++)h+=" ["+s+"]: "+this.getMeshWithLOD(s).getNumTriangles();return e.log(h,2),!0},l.prototype.loadFromJSON=function(t,n,r){var s,a,h,l,c,p,d,_,g,f,m,y,S,T,x,b,M=null,v=null,O=null,E=null,A=function(t,e){var i;if(null===M){for(i=t;e>=i;i++)this.getMeshWithLOD(i).resetMesh();M=t,v=e}else{for(i=t;M>i;i++)this.getMeshWithLOD(i).resetMesh();for(i=v+1;e>=i;i++)this.getMeshWithLOD(i).resetMesh();M=M>t?t:M,v=e>v?e:v}}.bind(this);if(r=r||0,e.log("Loading EgomModel data from file: "+t+" ...",2),"object"!=typeof n)return e.showError("'"+t+"' does not appear to be an JSON file.",e.ErrorSeverity.SEVERE,"A model was supposed to be loaded from this file, but only models of EgomModel format are accepted. Such a file needs to be a valid XML document with an EgomModel root element or a valid JSON file."),!1;if(p=n.version,!p)return e.showError("Model from file: '"+t+"' could not be loaded, because the file version could not have been determined.",e.ErrorSeverity.SEVERE),!1;if(u.indexOf(p)<0)return e.showError("Model from file: '"+t+"' could not be loaded, because the version of the file ("+p+") is not supported.",e.ErrorSeverity.SEVERE,"Supported versions are: "+u.join(", ")+"."),!1;for(_=null,this._infoProperties=n.info||{},this._name=n.info.name||null,this._scale=n.info.scale||1,O=n.info.defaultLOD[0],E=n.info.defaultLOD[1],d=n.info.defaultShininess||0,_=n.info.colorPalette,f=n.vertices.length,s=0;f>s;s++)for(S=n.vertices[s].i,l=null===O?r:O,c=null===E?r:E,l=n.vertices[s].lod?n.vertices[s].lod[0]:l,c=n.vertices[s].lod?n.vertices[s].lod[1]:c,this.updateLODInfo(l,c),A(l,c),T=new i(n.vertices[s].p),a=l;c>=a;a++)this.getMeshWithLOD(a).setVertex(S,T);for(e.log("Loaded "+f+" vertices.",3),m=n.lines.length,s=0;m>s;s++)for(l=null===O?r:O,c=null===E?r:E,l=n.lines[s].lod?n.lines[s].lod[0]:l,c=n.lines[s].lod?n.lines[s].lod[1]:c,this.updateLODInfo(l,c),A(l,c),x=new o(n.lines[s].a,n.lines[s].b,_?_[n.lines[s].color]:n.lines[s].color,n.lines[s].lum||0,n.lines[s].n),a=l;c>=a;a++)this.getMeshWithLOD(a).addLine(x);for(e.log("Loaded "+m+" lines.",3),y=n.triangles.length,g={},s=0;y>s;s++)for(l=null===O?r:O,c=null===E?r:E,l=n.triangles[s].lod?n.triangles[s].lod[0]:l,c=n.triangles[s].lod?n.triangles[s].lod[1]:c,this.updateLODInfo(l,c),A(l,c),g.color=_?_[n.triangles[s].color]:n.triangles[s].color,g.luminosity=n.triangles[s].lum||0,g.shininess=n.triangles[s].shi||d,g.texCoords=n.triangles[s].t,g.normals=n.triangles[s].n,g.groupIndex=void 0!==n.triangles[s].group?n.triangles[s].group:null,g.withoutLines=!0,b=null,a=l;c>=a;a++)b?this.getMeshWithLOD(a).addTriangle(b,g.withoutLines):b=this.getMeshWithLOD(a).addTriangleWithParams(n.triangles[s].a,n.triangles[s].b,n.triangles[s].c,g);for(e.log("Loaded "+y+" triangles.",3),e.log("Model loaded: "+this._name+". Details: "+this._minLOD+"-"+this._maxLOD,2),h="Number of triangles per LOD for "+this._name+": ",s=this._minLOD;s<=this._maxLOD;s++)h+=" ["+s+"]: "+this.getMeshWithLOD(s).getNumTriangles();return e.log(h,2),!0},l.prototype.getScale=function(){return this._scale},l.prototype._getLargestValueOfMeshes=function(t,e){var i,o;if(void 0!==t)return e(this.getMeshWithLOD(t));for(t=this._minLOD;t<this._maxLOD;t++)o=e(this.getMeshWithLOD(t)),(void 0===i||o>i)&&(i=o);return i},l.prototype._getLowestValueOfMeshes=function(t,e){var i,o;if(void 0!==t)return e(this.getMeshWithLOD(t));for(t=this._minLOD;t<this._maxLOD;t++)o=e(this.getMeshWithLOD(t)),(void 0===i||i>o)&&(i=o);return i},l.prototype.getSize=function(t){return this._getLargestValueOfMeshes(t,function(t){return t.getSize()})},l.prototype.getMaxX=function(t){return this._getLargestValueOfMeshes(t,function(t){return t.getMaxX()})},l.prototype.getMinX=function(t){return this._getLowestValueOfMeshes(t,function(t){return t.getMinX()})},l.prototype.getMaxY=function(t){return this._getLargestValueOfMeshes(t,function(t){return t.getMaxY()})},l.prototype.getMinY=function(t){return this._getLowestValueOfMeshes(t,function(t){return t.getMinY()})},l.prototype.getMaxZ=function(t){return this._getLargestValueOfMeshes(t,function(t){return t.getMaxZ()})},l.prototype.getMinZ=function(t){return this._getLowestValueOfMeshes(t,function(t){return t.getMinZ()})},l.prototype.getWidth=function(t){return this._getLargestValueOfMeshes(t,function(t){return t.getWidth()})},l.prototype.getHeight=function(t){return this._getLargestValueOfMeshes(t,function(t){
return t.getHeight()})},l.prototype.getDepth=function(t){return this._getLargestValueOfMeshes(t,function(t){return t.getDepth()})},l.prototype.getWidthInMeters=function(t){return t=void 0!==t?t:this._minLOD,this.getWidth(t)*this._scale},l.prototype.getHeightInMeters=function(t){return t=void 0!==t?t:this._minLOD,this.getHeight(t)*this._scale},l.prototype.getDepthInMeters=function(t){return t=void 0!==t?t:this._minLOD,this.getDepth(t)*this._scale},l.prototype.getNumOpaqueTriangles=function(t){return t=void 0!==t?t:this._minLOD,this.getMeshWithLOD(t).getNumOpaqueTriangles()},l.prototype.getNumTransparentTriangles=function(t){return t=void 0!==t?t:this._minLOD,this.getMeshWithLOD(t).getNumTransparentTriangles()},l.prototype.getNumTriangles=function(t,e){return t=void 0!==t?t:this._minLOD,this.getMeshWithLOD(t).getNumTriangles(e)},l.prototype.addToContext=function(t,i){this._minLOD=this._minLOD!==this.LOD_NOT_SET?this._minLOD:0,this._maxLOD=this._maxLOD!==this.LOD_NOT_SET?this._maxLOD:0;var o=this._contextProperties[t.getName()];o?(!o.wireframe&&i&&(e.log("Adding model ("+this._name+") to context in wireframe mode)...",2),o.wireframe=!0,t.resetReadyState()),o.solid||i||(e.log("Adding model ("+this._name+") to context in solid mode)...",2),o.solid=!0,t.resetReadyState()),o.minLOD>this._minLOD&&(e.log("Adding model ("+this._name+") to context with minimum LOD "+this._minLOD+"...",2),o.minLOD=this._minLOD,t.resetReadyState()),o.maxLOD<this._maxLOD&&(e.log("Adding model ("+this._name+") to context with maximum LOD "+this._maxLOD+"...",2),o.maxLOD=this._maxLOD,t.resetReadyState())):(e.log("Adding model ("+this._name+") to context ("+(i?"wireframe":"solid")+" mode)...",2),o=new h,o.wireframe=i,o.solid=!i,o.minLOD=this._minLOD,o.maxLOD=this._maxLOD,t.addModel(this)),this._contextProperties[t.getName()]=o},l.prototype.clearContextBindings=function(){var t;for(t in this._contextProperties)this._contextProperties.hasOwnProperty(t)&&delete this._contextProperties[t]},l.prototype.getBufferData=function(t,e,i){return i=void 0!==i?i:this._minLOD,this.getMeshWithLOD(i).getBufferData(t,e)},l.prototype.getBufferSize=function(t){var e,i=this._contextProperties[t.getName()],o=0;for(e=i.minLOD;e<=i.maxLOD;e++)o+=this.getMeshWithLOD(e).getBufferSize(i.wireframe,i.solid);return o},l.prototype.loadToVertexBuffers=function(t,e,i){i=void 0!==i?i:this._minLOD;var o=this._contextProperties[t.getName()];return this.getMeshWithLOD(i).loadToVertexBuffers(t,e,o.wireframe,o.solid)},l.prototype.render=function(t,e,i,o){o=void 0!==o?o:this._minLOD,this.getMeshWithLOD(o).render(t,e,i)},l.prototype.renderInstances=function(t,e,i,o,n){o=void 0!==o?o:this._minLOD,this.getMeshWithLOD(o).renderInstances(t,e,i,n)},l.prototype.appendVertex=function(t,e){var i;if(this._editedMesh)this._editedMesh.appendVertex(t,e);else for(i=this._minEditedLOD;i<=this._maxEditedLOD;i++)this.getMeshWithLOD(i).appendVertex(t,e)},l.prototype.addLine=function(t){var e;if(this._editedMesh)this._editedMesh.addLine(t);else for(e=this._minEditedLOD;e<=this._maxEditedLOD;e++)this.getMeshWithLOD(e).addLine(t)},l.prototype.addQuad=function(t,e,i,o,n){var r;if(this._editedMesh)this._editedMesh.addQuad(t,e,i,o,n);else for(r=this._minEditedLOD;r<=this._maxEditedLOD;r++)this.getMeshWithLOD(r).addQuad(t,e,i,o,n)},l.prototype.addCuboid=function(t,e,i,o,n,r,s,a,h,l){var u;if(this._editedMesh)this._editedMesh.addCuboid(t,e,i,o,n,r,s,a,h,l);else for(u=this._minEditedLOD;u<=this._maxEditedLOD;u++)this.getMeshWithLOD(u).addCuboid(t,e,i,o,n,r,s,a,h,l)},{Model:l,fvqModel:function(t){var e=new l;return t&&e.setName(t),e.appendVertex([-1,-1,0]),e.appendVertex([1,-1,0]),e.appendVertex([1,1,0]),e.appendVertex([-1,1,0]),e.addQuad(0,1,2,3),e},squareModel:function(t){var e=new l;return t&&e.setName(t),e.appendVertex([-1,-1,0]),e.appendVertex([1,-1,0]),e.appendVertex([1,1,0]),e.appendVertex([-1,1,0]),e.addQuad(0,1,2,3),e.addQuad(2,1,0,3,{texCoords:[[0,1],[1,1],[1,0],[0,0]]}),e},turningBillboardModel:function(t,e){var i,o=new l;if(t&&o.setName(t),o.appendVertex([-1,-1,0]),o.appendVertex([1,-1,0]),o.appendVertex([1,1,0]),o.appendVertex([-1,1,0]),o.addQuad(0,1,2,3,{texCoords:[[0,.5],[1,.5],[1,0],[0,0]]}),e)for(i=0;i<e.length;i++)o.appendVertex([1,e[i],-1]),o.appendVertex([-1,e[i],-1]),o.appendVertex([-1,e[i],1]),o.appendVertex([1,e[i],1]),o.addQuad(4*(i+1),4*(i+1)+1,4*(i+1)+2,4*(i+1)+3,{texCoords:[[0,1],[1,1],[1,.5],[0,.5]]}),o.addQuad(4*(i+1)+3,4*(i+1)+2,4*(i+1)+1,4*(i+1),{texCoords:[[0,1],[1,1],[1,.5],[0,.5]]});return o},cuboidModel:function(t,e,i,o,n){var r=new l;return t&&r.setName(t),r.addCuboid(0,0,0,e,i,o,n,128,[[0,1],[1,1],[1,0],[0,0]],!1),r},lineModel:function(t,e,i){var n=new l;return t&&n.setName(t),n.appendVertex([0,0,0]),n.appendVertex(e),n.addLine(new o(0,1,i,1,e)),n}}}),define("modules/graphics-resources",["utils/utils","utils/types","modules/application","modules/resource-manager","modules/managed-gl","modules/egom-model"],function(t,e,i,o,n,r){"use strict";function s(t){o.GenericResource.call(this,t.name),this._basepath=t.basepath,this._format=t.format,this._useMipmap=t.useMipmap===!0,this._typeSuffixes=t.typeSuffixes,this._qualitySuffixes=t.qualitySuffixes,this._loadedImages=0,this._imagesToLoad=0,this._images={},this._managedTextures={},this._cachedManagedTexturesOfTypes=[]}function a(t){o.GenericResource.call(this,t.name),this._basepath=t.basepath,this._imageNames=t.imageNames,this._images={},this._managedCubemap=null}function h(t){o.GenericResource.call(this,t.name),this._variantShaderNames=t.variants||null,this._vertexShaderSourcePath=t.vertexShaderSource,this._fragmentShaderSourcePath=t.fragmentShaderSource,this._blendMode=e.getEnumValue("shader.blendMode",n.ShaderBlendMode,t.blendMode),this._vertexAttributeRoles=t.vertexAttributeRoles,this._instanceAttributeRoles=t.instanceAttributeRoles||{},this._vertexShaderSource=null,this._fragmentShaderSource=null,this._managedShaderBindings=[],this._shaderIncludesToLoad=0,this._shaderIncludesLoaded=0}function l(t){return o.GenericResource.call(this,t.name),t.model?(this._model=t.model,this._files=[],void this.setToReady()):(this._basepath=t.basepath,this._format=t.format,this._files=t.files,this._loadedFiles=0,this._filesToLoad=0,this._model=null,void(this._maxLoadedLOD=-1))}function u(){o.ResourceManager.call(this)}function c(t,e){var i={};i[_]=s,i[g]=a,i[f]=h,i[m]=l,p.requestConfigLoad(t.filename,t.folder,i,e)}var p,d={VERTEX:"vertex",FRAGMENT:"fragment"},_="textures",g="cubemaps",f="shaders",m="models",y="texture",S="texture",T="shader",x="model",b='#include "',M='"',v={};return Object.freeze(d),s.prototype=new o.GenericResource,s.prototype.constructor=s,s.prototype._getPath=function(t,e){return this._basepath+this._typeSuffixes[t]+this._qualitySuffixes[e]+"."+this._format},s.prototype._getOnLoadImageFunction=function(t,e){var i=this._getPath(t,e);return function(){this._loadedImages++,this._onFilesLoad(this._loadedImages===this._imagesToLoad,{path:i})}.bind(this)},s.prototype.requiresReload=function(t){var e,i,o,n;if(this.isRequested(t))return!1;t=t||{},e=t.types||this._typeSuffixes,o=t.qualities||this._qualitySuffixes;for(i in e)if(e.hasOwnProperty(i)){if(!this._images[i])return!0;for(n in o)if(o.hasOwnProperty(n)&&!this._images[i][n])return!0}return!1},s.prototype._requestFiles=function(t){var e,o,n,r;t=t||{},e=t.types||this._typeSuffixes,n=t.qualities||this._qualitySuffixes;for(o in e)if(e.hasOwnProperty(o)){this._images[o]=this._images[o]||{};for(r in n)n.hasOwnProperty(r)&&(this._images[o][r]||(this._imagesToLoad++,this._images[o][r]=new Image,this._images[o][r].onload=this._getOnLoadImageFunction(o,r).bind(this)))}for(o in e)if(e.hasOwnProperty(o))for(r in n)n.hasOwnProperty(r)&&(this._images[o][r].src||(this._images[o][r].src=i.getFileURL(y,this._getPath(o,r))))},s.prototype._loadData=function(t){i.log("Texture from file: "+t.path+" has been loaded.",2)},s.prototype.getTypes=function(){var t,e=[];for(t in this._typeSuffixes)this._typeSuffixes.hasOwnProperty(t)&&e.push(t);return e},s.prototype.getQualities=function(){var t,e=[];for(t in this._qualitySuffixes)this._qualitySuffixes.hasOwnProperty(t)&&e.push(t);return e},s.prototype.getManagedTexture=function(t,e){return this.isReadyToUse()===!1?(i.showError("Cannot get managed GL texture for '"+this.getName()+"', as it has not been loaded from file yet!"),null):this._images[t]?(this._managedTextures[t]=this._managedTextures[t]||{},this._managedTextures[t][e]=this._managedTextures[t][e]||new n.ManagedTexture(this.getName(),this._images[t][e],this._useMipmap),this._managedTextures[t][e]):(i.showError("The requested texture '"+this.getName()+"' has no type '"+t+"' available!"),null)},s.prototype.getManagedTexturesOfTypes=function(e,o){var n,r,s,a,h,l;for(e.sort(),n=0;n<this._cachedManagedTexturesOfTypes.length;n++)if(t.arraysEqual(e,this._cachedManagedTexturesOfTypes[n].types)&&t.arraysEqual(o,this._cachedManagedTexturesOfTypes[n].qualityPreferenceList))return this._cachedManagedTexturesOfTypes[n].textures;for(l={},r=this.getQualities(),h=-1,n=0;n<r.length;n++)s=o.indexOf(r[n]),s>=0&&(-1===h||h>s)&&(h=s,a=o[s]);if(-1===h)return i.showError("Texture '"+this.getName()+"' is not available in any of the qualities: ["+o.join(", ")+"]!"),null;for(n=0;n<e.length;n++)l[e[n]]=this.getManagedTexture(e[n],a);return this._cachedManagedTexturesOfTypes.push({types:e,qualityPreferenceList:o,textures:l}),l},s.prototype.getManagedTextures=function(t){return this.getManagedTexturesOfTypes(this.getTypes(),t)},a.prototype=new o.GenericResource,a.prototype.constructor=a,a.prototype.requiresReload=function(){return this.isRequested()?!1:!this.isLoaded()},a.prototype._requestFiles=function(){var t,e,o;t=0,o=function(){t+=1,6===t&&this._onFilesLoad(!0)}.bind(this);for(e in this._imageNames)this._imageNames.hasOwnProperty(e)&&(this._images[e]=new Image,this._images[e].onload=o,this._images[e].src=i.getFileURL(S,this._basepath+this._imageNames[e]))},a.prototype._loadData=function(){i.log("Cubemap named '"+this.getName()+"' has been loaded.",2)},a.prototype.getManagedCubemap=function(){return this.isReadyToUse()===!1?(i.showError("Cannot get managed GL cubemap for '"+this.getName()+"', as it has not been loaded from file yet!"),null):(this._managedCubemap=this._managedCubemap||new n.ManagedCubemap(this.getName(),[this._images.posX,this._images.negX,this._images.posY,this._images.negY,this._images.posZ,this._images.negZ]),this._managedCubemap)},h.prototype=new o.GenericResource,h.prototype.constructor=h,h.prototype._allSourcesLoaded=function(){return this._vertexShaderSource&&this._fragmentShaderSource&&this._shaderIncludesLoaded===this._shaderIncludesToLoad},h.prototype._loadIncludeSource=function(t,e,i){var o;for(v[e].source=i,this._resolveInclude(t,e),o=0;o<v[e].onLoad.length;o++)v[e].onLoad[o]()},h.prototype._getIncludeFileName=function(t){return t.substr(b.length,t.length-(b.length+M.length))},h.prototype._resolveInclude=function(t,e){var o,n,r=v[e].source;switch(t){case d.VERTEX:n=this._vertexShaderSource.split("\n");break;case d.FRAGMENT:n=this._fragmentShaderSource.split("\n");break;default:i.crash()}for(o=0;o<n.length;o++)if(n[o].substr(0,b.length)===b&&e===this._getIncludeFileName(n[o])){switch(n[o]=r,t){case d.VERTEX:this._vertexShaderSource=n.join("\n");break;case d.FRAGMENT:this._fragmentShaderSource=n.join("\n");break;default:i.crash()}this._resolveSource(t,r);break}this._shaderIncludesLoaded++,this._allSourcesLoaded()&&this.setToReady()},h.prototype._resolveSource=function(t,e){var o,n=e.split("\n"),r=[];for(o=0;o<n.length;o++)n[o].substr(0,b.length)===b&&(r.push(this._getIncludeFileName(n[o])),this._shaderIncludesToLoad++);for(o=0;o<r.length;o++)v[r[o]]?v[r[o]].source?this._resolveInclude(t,r[o]):v[r[o]].onLoad.push(this._resolveInclude.bind(this,t,r[o])):(v[r[o]]={onLoad:[]},i.requestTextFile(T,r[o],this._loadIncludeSource.bind(this,t,r[o])))},h.prototype.requiresReload=function(){return this.isRequested()?!1:!this.isLoaded()},h.prototype._requestFiles=function(){i.requestTextFile(T,this._vertexShaderSourcePath,function(t){this._onFilesLoad(!1,{shaderType:d.VERTEX,text:t})}.bind(this)),i.requestTextFile(T,this._fragmentShaderSourcePath,function(t){this._onFilesLoad(!1,{shaderType:d.FRAGMENT,text:t})}.bind(this))},h.prototype._loadData=function(t){switch(e.getEnumValue("shaderType",d,t.shaderType,null)){case d.VERTEX:this._vertexShaderSource=t.text;break;case d.FRAGMENT:this._fragmentShaderSource=t.text;break;default:i.crash()}this._resolveSource(t.shaderType,t.text),this._allSourcesLoaded()&&this.setToReady()},h.prototype.getVariantShaderName=function(t){return this._variantShaderNames?this._variantShaderNames[t]:null},h.prototype.getManagedShader=function(e){var o;if(this.isReadyToUse()===!1)return i.showError("Cannot get managed GL shader for '"+this.getName()+"', as it has not been loaded from file yet!"),null;for(e=e||null,o=0;o<this._managedShaderBindings.length;o++)if(t.objectsEqual(this._managedShaderBindings[o].replacedDefines,e))return this._managedShaderBindings[o].managedShader;return this._managedShaderBindings.push({managedShader:new n.ManagedShader(this.getName(),this._vertexShaderSource,this._fragmentShaderSource,this._blendMode,this._vertexAttributeRoles,this._instanceAttributeRoles,e),replacedDefines:e}),this._managedShaderBindings[this._managedShaderBindings.length-1].managedShader},l.prototype=new o.GenericResource,l.prototype.constructor=l,l.prototype._getPath=function(t){var e;for(e=0;e<this._files.length;e++)if(this._files[e].maxLOD===t)return this._basepath+this._files[e].suffix+"."+this._format;return null},l.prototype.requiresReload=function(t){return this.isRequested(t)?!1:0===this._files.length?!1:t&&"number"==typeof t.maxLOD?t.maxLOD>this._maxLoadedLOD:null!==this.getMaxLOD()?this.requiresReload({maxLOD:this.getMaxLOD()}):!1},l.prototype.getMaxLOD=function(){var t,e=null;for(t=0;t<this._files.length;t++)(null===e||this._files[t].maxLOD>e)&&(e=this._files[t].maxLOD);return e},l.prototype._requestFile=function(t){this._filesToLoad++,i.requestTextFile(x,this._getPath(t),function(e){this._loadedFiles++,this._onFilesLoad(this._filesToLoad===this._loadedFiles,{maxLOD:t,text:e})}.bind(this))},l.prototype._requestFiles=function(t){var e,o;if(t=t||{},void 0!==t.maxLOD){for(e=t.maxLOD;e>=0;e--)if(null!==this._getPath(e))return void this._requestFile(e);if(0>e&&this._files.length>0)for(o=this.getMaxLOD(),e=t.maxLOD+1;o>=e;e++)if(null!==this._getPath(e))return void this._requestFile(e);i.showError("Could not find any files to load for model: '"+this._name+"'!")}else this._requestFiles({maxLOD:this.getMaxLOD()})},l.prototype._loadData=function(t){i.log("Model file of max LOD level "+t.maxLOD+" has been loaded for model '"+this.getName()+"'",2),this._model=new r.Model,"{"===t.text[0]?this._model.loadFromJSON(this._getPath(t.maxLOD),JSON.parse(t.text),t.maxLOD):"<"===t.text[0]?this._model.loadFromXML(this._getPath(t.maxLOD),(new window.DOMParser).parseFromString(t.text,"text/xml"),t.maxLOD):i.showError("Cannot load Egom Mode from file '"+this._getPath(t.maxLOD)+"', as it does no appear to be either an XML or a JSON file!"),this._maxLoadedLOD=t.maxLOD},l.prototype.getEgomModel=function(){return this.isReadyToUse()===!1?(i.showError("Cannot get model object for '"+this.getName()+"', as it has not been loaded from file yet!"),null):this._model},u.prototype=new o.ResourceManager,u.prototype.constructor=u,u.prototype.getTexture=function(t){return this.getResource(_,t)},u.prototype.getCubemap=function(t){return this.getResource(g,t)},u.prototype.getShader=function(t){return this.getResource(f,t)},u.prototype.getVariantShader=function(t,e){return this.getResource(f,this.getResource(f,t,{doNotLoad:!0}).getVariantShaderName(e),{allowNullResult:!0})||this.getShader(t)},u.prototype.getModel=function(t,e){return this.getResource(m,t,e)},u.prototype.getOrAddModel=function(t){var e=this.getResource(m,t.getName(),{allowNullResult:!0});return e||(e=this.addResource(m,new l({name:t.getName(),model:t}))),e},p=new u,{requestConfigLoad:c,requestResourceLoad:p.requestResourceLoad.bind(p),getTexture:p.getTexture.bind(p),getCubemap:p.getCubemap.bind(p),getShader:p.getShader.bind(p),getVariantShader:p.getVariantShader.bind(p),getModel:p.getModel.bind(p),getOrAddModel:p.getOrAddModel.bind(p),executeWhenReady:p.executeWhenReady.bind(p),executeOnResourceLoad:p.executeOnResourceLoad.bind(p)}}),define("utils/matrices",["utils/vectors"],function(t){"use strict";function e(){var t;for(t=0;t<s.length;t++)if(!s[t].used)return t;return s.push({used:!1,matrix:n.identity4()}),s.length-1}function i(t){return s[t].used=!0,s[t].matrix}function o(t){s[t].used=!1}var n={},r=.99999,s=[],a=0;return n.clearMatrixCount=function(){a=0},n.getMatrixCount=function(){return a},n.identity3=function(){return new Float32Array([1,0,0,0,1,0,0,0,1])},n.IDENTITY3=n.identity3(),n.identity4=function(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},n.IDENTITY4=n.identity4(),n.null3=function(){return new Float32Array([0,0,0,0,0,0,0,0,0])},n.null4=function(){return new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])},n.matrix3=function(t){return new Float32Array([t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]])},n.matrix4=function(t){return new Float32Array([t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]])},n.translation4=function(t,e,i){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t,e,i,1])},n.translation4v=function(t){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t[0],t[1],t[2],1])},n.translation4m4=function(t){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t[12],t[13],t[14],1])},n.rotation2=function(t){var e=Math.cos(t),i=Math.sin(t);return new Float32Array([e,-i,i,e])},n.rotation4=function(t,e){var i=Math.cos(e),o=Math.sin(e);return new Float32Array([i+(1-i)*t[0]*t[0],(1-i)*t[0]*t[1]-o*t[2],(1-i)*t[0]*t[2]+o*t[1],0,(1-i)*t[0]*t[1]+o*t[2],i+(1-i)*t[1]*t[1],(1-i)*t[1]*t[2]-o*t[0],0,(1-i)*t[0]*t[2]-o*t[1],(1-i)*t[1]*t[2]+o*t[0],i+(1-i)*t[2]*t[2],0,0,0,0,1])},n.rotation4m4=function(t){return new Float32Array([t[0],t[1],t[2],0,t[4],t[5],t[6],0,t[8],t[9],t[10],0,0,0,0,1])},n.lookTowards4=function(e,i){var o,s;return i=i||[0,1,0],o=new Float32Array([1,0,0,0,0,1,0,0,e[0],e[1],e[2],0,0,0,0,1]),Math.abs(t.dot3(i,e))>r&&(i=t.perpendicular3(e)),s=t.cross3(i,e),o[0]=s[0],o[1]=s[1],o[2]=s[2],i=t.cross3(e,s),o[4]=i[0],o[5]=i[1],o[6]=i[2],n.correctedOrthogonal4(o)},n.scaling4=function(t,e,i){return e=e||t,i=i||t,new Float32Array([t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1])},n.translationRotation=function(t,e){return new Float32Array([e[0],e[1],e[2],0,e[4],e[5],e[6],0,e[8],e[9],e[10],0,t[12],t[13],t[14],1])},n.perspective4=function(t,e,i,o){return new Float32Array([i/t,0,0,0,0,i/e,0,0,0,0,(i+o)/(i-o),-1,0,0,2*i*o/(i-o),0])},n.orthographic4=function(t,e,i,o){return new Float32Array([1/t,0,0,0,0,1/e,0,0,0,0,-2/(o-i),0,0,0,-(i+o)/2,1])},n.translationFromXMLTag=function(e){return n.translation4v(t.fromXMLTag3(e))},n.rotation4FromXMLTags=function(t){var e,i,o=n.identity4();for(e=0;e<t.length;e++)i=[0,0,0],"x"===t[e].getAttribute("axis")?i=[1,0,0]:"y"===t[e].getAttribute("axis")?i=[0,1,0]:"z"===t[e].getAttribute("axis")&&(i=[0,0,1]),o=n.prod4(o,n.rotation4(i,parseFloat(t[e].getAttribute("degree"))/180*Math.PI));return o},n.rotation4FromJSON=function(t){var e,i,o=n.identity4();if(t)for(e=0;e<t.length;e++){if("string"==typeof t[e].axis)switch(t[e].axis){case"x":case"X":i=[1,0,0];break;case"y":case"Y":i=[0,1,0];break;case"z":case"Z":i=[0,0,1]}else t[e].axis instanceof Array&&(i=t[e].axis);o=n.prod4(o,n.rotation4(i,parseFloat(t[e].degrees)/180*Math.PI))}return o},n.fromVectorsTo3=function(t,e,i){return new Float32Array([t[0],t[1],t[2],e[0],e[1],e[2],i[0],i[1],i[2]])},n.fromVectorsTo4=function(t,e,i,o){return o=o||[0,0,0,1],new Float32Array([t[0],t[1],t[2],t.length>3?t[3]:0,e[0],e[1],e[2],e.length>3?e[3]:0,i[0],i[1],i[2],i.length>3?i[3]:0,o[0],o[1],o[2],o[3]])},n.getRowA3=function(t){return[t[0],t[1],t[2]]},n.getRowA3Neg=function(t){return[-t[0],-t[1],-t[2]]},n.getRowA4=function(t){return[t[0],t[1],t[2],t[3]]},n.getRowA4Neg=function(t){return[-t[0],-t[1],-t[2],-t[3]]},n.getRowA43=function(t){return[t[0],t[1],t[2]]},n.getRowA43Neg=function(t){return[-t[0],-t[1],-t[2]]},n.getRowB3=function(t){return[t[3],t[4],t[5]]},n.getRowB3Neg=function(t){return[-t[3],-t[4],-t[5]]},n.getRowB4=function(t){return[t[4],t[5],t[6],t[7]]},n.getRowB4Neg=function(t){return[-t[4],-t[5],-t[6],-t[7]]},n.getRowB43=function(t){return[t[4],t[5],t[6]]},n.getRowB43Neg=function(t){return[-t[4],-t[5],-t[6]]},n.getRowC4=function(t){return[t[8],t[9],t[10],t[11]]},n.getRowC43=function(t){return[t[8],t[9],t[10]]},n.getRowC43Neg=function(t){return[-t[8],-t[9],-t[10]]},n.getRowD4=function(t){return[t[12],t[13],t[14],t[15]]},n.determinant3=function(t){return t[0]*t[4]*t[8]+t[1]*t[5]*t[6]+t[2]*t[3]*t[7]-t[2]*t[4]*t[6]-t[1]*t[3]*t[8]-t[0]*t[5]*t[7]},n.translationVector3=function(t){return[t[12],t[13],t[14]]},n.translationVector4=function(t){return[t[12],t[13],t[14],t[15]]},n.translationLength=function(e){return t.length3([e[12],e[13],e[14]])},n.getVectorYawAndPitch=function(e){var i,o={};return Math.abs(e[2])>r?(o.yaw=0,o.pitch=e[2]>0?-Math.PI/2:Math.PI/2):(o.yaw=t.angle2uCapped([0,1],t.normal2([e[0],e[1]])),e[0]<0&&(o.yaw=-o.yaw),i=t.mulVec3Mat4(e,n.rotation4([0,0,1],-o.yaw)),o.pitch=t.angle2uCapped([1,0],t.normal2([i[1],i[2]])),i[2]>0&&(o.pitch=-o.pitch)),o},n.getYawAndPitch=function(e){var i,o={};return Math.abs(e[6])>r?(o.yaw=0,o.pitch=e[6]>0?-Math.PI/2:Math.PI/2):(o.yaw=t.angle2uCapped([0,1],t.normal2(e[10]>0?[e[4],e[5]]:[-e[4],-e[5]])),e[4]*e[10]<0&&(o.yaw=-o.yaw),i=n.correctedOrthogonal4(n.prod4(e,n.rotation4([0,0,1],-o.yaw))),o.pitch=t.angle2uCapped([1,0],t.normal2([i[5],i[6]])),i[6]>0&&(o.pitch=-o.pitch)),o},n.getRotations=function(e){var i,o,s={};return i=t.dot3([0,1,0],n.getRowB43(e)),Math.abs(i)>r?(s.alphaAxis=[0,0,1],s.alpha=i>0?0:Math.PI):(s.alphaAxis=t.normal3(t.cross3(n.getRowB43(e),[0,1,0])),s.alpha=t.angle3u(n.getRowB43(e),[0,1,0])),s.alpha>Math.PI&&(s.alpha-=2*Math.PI),o=n.correctedOrthogonal4(n.prod4(e,n.rotation4(s.alphaAxis,-s.alpha))),i=t.dot3([1,0,0],n.getRowA43(o)),Math.abs(i)>r?(s.gammaAxis=[0,1,0],s.gamma=i>0?0:Math.PI):(s.gammaAxis=t.normal3(t.cross3(n.getRowA43(o),[1,0,0])),s.gamma=t.angle3u(n.getRowA43(o),[1,0,0])),s.gamma>Math.PI&&(s.gamma-=2*Math.PI),s},n.toString3=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)+"\n"+t[3].toFixed(e)+" "+t[4].toFixed(e)+" "+t[5].toFixed(e)+"\n"+t[6].toFixed(e)+" "+t[7].toFixed(e)+" "+t[8].toFixed(e)},n.toString4=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)+" "+t[3].toFixed(e)+"\n"+t[4].toFixed(e)+" "+t[5].toFixed(e)+" "+t[6].toFixed(e)+" "+t[7].toFixed(e)+"\n"+t[8].toFixed(e)+" "+t[9].toFixed(e)+" "+t[10].toFixed(e)+" "+t[11].toFixed(e)+"\n"+t[12].toFixed(e)+" "+t[13].toFixed(e)+" "+t[14].toFixed(e)+" "+t[15].toFixed(e)},n.toHTMLString4=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)+" "+t[3].toFixed(e)+"<br/>"+t[4].toFixed(e)+" "+t[5].toFixed(e)+" "+t[6].toFixed(e)+" "+t[7].toFixed(e)+"<br/>"+t[8].toFixed(e)+" "+t[9].toFixed(e)+" "+t[10].toFixed(e)+" "+t[11].toFixed(e)+"<br/>"+t[12].toFixed(e)+" "+t[13].toFixed(e)+" "+t[14].toFixed(e)+" "+t[15].toFixed(e)},n.matrix3from4=function(t){return new Float32Array([t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]])},n.matrix4from3=function(t){return new Float32Array([t[0],t[1],t[2],0,t[3],t[4],t[5],0,t[6],t[7],t[8],0,0,0,0,1])},n.transposed3=function(t){return new Float32Array([t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8]])},n.transposed4=function(t){return new Float32Array([t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15]])},n.inverse3=function(t){var r,s,a,h,l,u,c,p,d=e();if(u=i(d),n.setMatrix3(u,t),c=n.identity3(),0===n.determinant3(u))return n.null3();for(r=0;3>r;r++){if(Math.abs(u[4*r])<=1e-4){for(s=r+1;Math.abs(u[3*s+r])<=1e-4;)s++;for(a=0;3>a;a++)p=u[3*r+a],u[3*r+a]=u[3*s+a],u[3*s+a]=p,p=c[3*r+a],c[3*r+a]=c[3*s+a],c[3*s+a]=p}for(h=u[4*r],s=0;3>s;s++)u[3*r+s]=u[3*r+s]/h,c[3*r+s]=c[3*r+s]/h;for(s=r+1;3>s;s++)for(l=u[3*s+r]/u[4*r],a=0;3>a;a++)u[3*s+a]=u[3*s+a]-l*u[3*r+a],c[3*s+a]=c[3*s+a]-l*c[3*r+a]}for(r=2;r>=1;r--)for(s=r-1;s>=0;s--)for(a=0;3>a;a++)c[3*s+a]=c[3*s+a]-u[3*s+r]*c[3*r+a];return o(d),c},n.inverse4=function(t){var r,s,a,h,l,u,c,p,d=e();for(u=i(d),n.setMatrix4(u,t),c=n.identity4(),r=0;4>r;r++){if(Math.abs(u[5*r])<=1e-4){for(s=r+1;Math.abs(u[4*s+r])<=1e-4;)s++;for(a=0;4>a;a++)p=u[4*r+a],u[4*r+a]=u[4*s+a],u[4*s+a]=p,p=c[4*r+a],c[4*r+a]=c[4*s+a],c[4*s+a]=p}for(h=u[5*r],s=0;4>s;s++)u[4*r+s]=u[4*r+s]/h,c[4*r+s]=c[4*r+s]/h;for(s=r+1;4>s;s++)for(l=u[4*s+r]/u[5*r],a=0;4>a;a++)u[4*s+a]=u[4*s+a]-l*u[4*r+a],c[4*s+a]=c[4*s+a]-l*c[4*r+a]}for(r=3;r>=1;r--)for(s=r-1;s>=0;s--)for(a=0;4>a;a++)c[4*s+a]=c[4*s+a]-u[4*s+r]*c[4*r+a];return o(d),c},n.inverseOfTranslation4=function(t){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,-t[12],-t[13],-t[14],1])},n.inverseOfRotation4=n.transposed4,n.inverseOfScaling4=function(t){return n.scaling4(1/t[0],1/t[5],1/t[10])},n.scaled3=function(t,e){return new Float32Array([t[0]*e,t[1]*e,t[2]*e,t[3]*e,t[4]*e,t[5]*e,t[6]*e,t[7]*e,t[8]*e])},n.scaled4=function(t,e){return new Float32Array([t[0]*e,t[1]*e,t[2]*e,t[3]*e,t[4]*e,t[5]*e,t[6]*e,t[7]*e,t[8]*e,t[9]*e,t[10]*e,t[11]*e,t[12]*e,t[13]*e,t[14]*e,t[15]*e])},n.correctedOrthogonal4=function(e){var i=t.normal3([e[0],e[1],e[2]]),o=t.normal3([e[4],e[5],e[6]]),n=t.cross3(i,o);return o=t.cross3(n,i),new Float32Array([i[0],i[1],i[2],0,o[0],o[1],o[2],0,n[0],n[1],n[2],0,0,0,0,1])},n.straightened=function(t,e){var i,o=new Float32Array(t);for(i=0;i<o.length;i++)o[i]=Math.abs(t[i])<e?0:Math.abs(1-t[i])<e?1:Math.abs(-1-t[i])<e?-1:t[i];return o},n.equal4=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]},n.sum4=function(t,e){return new Float32Array([t[0]+e[0],t[1]+e[1],t[2]+e[2],t[3]+e[3],t[4]+e[4],t[5]+e[5],t[6]+e[6],t[7]+e[7],t[8]+e[8],t[9]+e[9],t[10]+e[10],t[11]+e[11],t[12]+e[12],t[13]+e[13],t[14]+e[14],t[15]+e[15]])},n.prod3=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[3]+t[2]*e[6],t[0]*e[1]+t[1]*e[4]+t[2]*e[7],t[0]*e[2]+t[1]*e[5]+t[2]*e[8],t[3]*e[0]+t[4]*e[3]+t[5]*e[6],t[3]*e[1]+t[4]*e[4]+t[5]*e[7],t[3]*e[2]+t[4]*e[5]+t[5]*e[8],t[6]*e[0]+t[7]*e[3]+t[8]*e[6],t[6]*e[1]+t[7]*e[4]+t[8]*e[7],t[6]*e[2]+t[7]*e[5]+t[8]*e[8]])},n.prod4=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[4]+t[2]*e[8]+t[3]*e[12],t[0]*e[1]+t[1]*e[5]+t[2]*e[9]+t[3]*e[13],t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+t[3]*e[14],t[0]*e[3]+t[1]*e[7]+t[2]*e[11]+t[3]*e[15],t[4]*e[0]+t[5]*e[4]+t[6]*e[8]+t[7]*e[12],t[4]*e[1]+t[5]*e[5]+t[6]*e[9]+t[7]*e[13],t[4]*e[2]+t[5]*e[6]+t[6]*e[10]+t[7]*e[14],t[4]*e[3]+t[5]*e[7]+t[6]*e[11]+t[7]*e[15],t[8]*e[0]+t[9]*e[4]+t[10]*e[8]+t[11]*e[12],t[8]*e[1]+t[9]*e[5]+t[10]*e[9]+t[11]*e[13],t[8]*e[2]+t[9]*e[6]+t[10]*e[10]+t[11]*e[14],t[8]*e[3]+t[9]*e[7]+t[10]*e[11]+t[11]*e[15],t[12]*e[0]+t[13]*e[4]+t[14]*e[8]+t[15]*e[12],t[12]*e[1]+t[13]*e[5]+t[14]*e[9]+t[15]*e[13],t[12]*e[2]+t[13]*e[6]+t[14]*e[10]+t[15]*e[14],t[12]*e[3]+t[13]*e[7]+t[14]*e[11]+t[15]*e[15]])},n.prod34=function(t,e,i){var o=n.prod4(t,e);return n.mul4(o,i),o},n.translatedByM4=function(t,e){return new Float32Array([t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12]+e[12],t[13]+e[13],t[14]+e[14],t[15]])},n.distanceSquared=function(t,e){return(t[12]-e[12])*(t[12]-e[12])+(t[13]-e[13])*(t[13]-e[13])+(t[14]-e[14])*(t[14]-e[14])},n.setMatrix3=function(t,e){var i;for(i=0;9>i;i++)t[i]=e[i]},n.setMatrix4=function(t,e){var i;for(i=0;16>i;i++)t[i]=e[i]},n.setRotation4=function(t,e,i){var o=Math.cos(i),n=Math.sin(i);t[0]=o+(1-o)*e[0]*e[0],t[1]=(1-o)*e[0]*e[1]-n*e[2],t[2]=(1-o)*e[0]*e[2]+n*e[1],t[3]=0,t[4]=(1-o)*e[0]*e[1]+n*e[2],t[5]=o+(1-o)*e[1]*e[1],t[6]=(1-o)*e[1]*e[2]-n*e[0],t[7]=0,t[8]=(1-o)*e[0]*e[2]-n*e[1],t[9]=(1-o)*e[1]*e[2]+n*e[0],t[10]=o+(1-o)*e[2]*e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1},n.translateByVector=function(t,e){t[12]+=e[0],t[13]+=e[1],t[14]+=e[2]},n.translateByMatrix=function(t,e){t[12]+=e[12],t[13]+=e[13],t[14]+=e[14]},n.rotate4=function(t,r,s){var a=e(),h=i(a);n.setRotation4(h,r,s),n.mul4(t,h),o(a)},n.mul4=function(t,r){var s=e(),a=i(s);n.setMatrix4(a,t),t[0]=a[0]*r[0]+a[1]*r[4]+a[2]*r[8]+a[3]*r[12],t[1]=a[0]*r[1]+a[1]*r[5]+a[2]*r[9]+a[3]*r[13],t[2]=a[0]*r[2]+a[1]*r[6]+a[2]*r[10]+a[3]*r[14],t[3]=a[0]*r[3]+a[1]*r[7]+a[2]*r[11]+a[3]*r[15],t[4]=a[4]*r[0]+a[5]*r[4]+a[6]*r[8]+a[7]*r[12],t[5]=a[4]*r[1]+a[5]*r[5]+a[6]*r[9]+a[7]*r[13],t[6]=a[4]*r[2]+a[5]*r[6]+a[6]*r[10]+a[7]*r[14],t[7]=a[4]*r[3]+a[5]*r[7]+a[6]*r[11]+a[7]*r[15],t[8]=a[8]*r[0]+a[9]*r[4]+a[10]*r[8]+a[11]*r[12],t[9]=a[8]*r[1]+a[9]*r[5]+a[10]*r[9]+a[11]*r[13],t[10]=a[8]*r[2]+a[9]*r[6]+a[10]*r[10]+a[11]*r[14],t[11]=a[8]*r[3]+a[9]*r[7]+a[10]*r[11]+a[11]*r[15],t[12]=a[12]*r[0]+a[13]*r[4]+a[14]*r[8]+a[15]*r[12],t[13]=a[12]*r[1]+a[13]*r[5]+a[14]*r[9]+a[15]*r[13],t[14]=a[12]*r[2]+a[13]*r[6]+a[14]*r[10]+a[15]*r[14],t[15]=a[12]*r[3]+a[13]*r[7]+a[14]*r[11]+a[15]*r[15],o(s)},n.correctOrthogonal4=function(e){var i=t.normal3([e[0],e[1],e[2]]),o=t.normal3([e[4],e[5],e[6]]),n=t.cross3(i,o);o=t.cross3(n,i),e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=0,e[4]=o[0],e[5]=o[1],e[6]=o[2],e[7]=0,e[8]=n[0],e[9]=n[1],e[10]=n[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1},n.straighten=function(t,e){var i;for(i=0;i<t.length;i++)t[i]=Math.abs(t[i])<e?0:Math.abs(1-t[i])<e?1:Math.abs(-1-t[i])<e?-1:t[i]},n}),define("modules/buda-scene",["utils/utils","utils/types","utils/vectors","utils/matrices","modules/application","modules/managed-gl"],function(t,e,i,o,n,r){"use strict";function s(t,e,i,o,n){this.maxEnabledLOD=t,this.thresholds=e,this.compensateForObjectSize=i===!0,this.referenceSize=o||j,this.minimumRelativeSize=n||k}function a(t,e,i,n){this._parent=null,this._positionMatrix=t||o.identity4(),this._orientationMatrix=e||o.identity4(),this._scalingMatrix=i||o.identity4(),this._modelMatrix=null,this._modelMatrixInverse=null,this._size=void 0!==n?n:1,this._insideParent=null,this._lastSizeInsideViewFrustum={width:-1,height:-1},this._positionMatrixInCameraSpace=null}function h(t,e,i,o,n,r,s,a,h,l,u){this.context=t,this.depthMask=e,this.scene=i,this.parent=o,this.camera=n,this.viewportWidth=r,this.viewportHeight=s,this.lodContext=a,this.dt=h||0,this.useInstancing=l||!1,this.instanceQueueIndex=u}function l(t,e,i){this._renderableObject=t,t.setNode(this),this._scene=null,this._parent=null,this._subnodes=[],this._visible=!0,this._renderParameters=new h,this._cameraConfigurations=[],this._hasInstancedSubnodes=e,this._minimumCountForInstancing=i||0}function u(t,e,i,o){this._node=null,this._wasRendered=!1,this._shader=t,this._textures={},this._uniformValueFunctions={},this._isRenderedWithDepthMask=void 0===e?!0:e,this._isRenderedWithoutDepthMask=void 0===i?!0:i,this._instancedShader=o||null,this._canBeReused=!1,this._visible=!0}function c(t,e,i,o,n,r,s){u.call(this,t,e,i,s),a.call(this,o,n,r),this._visibleSize={width:-1,height:-1},this._insideShadowCastFrustum=null,this._smallestSizeWhenDrawn=0}function p(t,e,i,n,r){u.call(this,e,!1,!0),this._model=t,this._samplerName=i,this._camera=r,this.setTexture(i,n),this.setUniformValueFunction(J,function(){return o.inverse4(o.prod4(this._camera.getInverseOrientationMatrix(),this._camera.getProjectionMatrix()))})}function d(t,e,i,n,r,s,a,h){c.call(this,e,!0,!0,n,r,s),this.setSmallestSizeWhenDrawn(5),this.setTextures(i),this._model=t,this._wireframe=a===!0,this._currentLOD=this.LOD_NOT_SET,this._modelSize=0,this._lodSizeFactors={},this._staticLOD=void 0!==h?h:this.LOD_NOT_SET,this.setUniformValueFunction(K,function(){return this.getModelMatrix()}),this.setUniformValueFunction(Z,function(){return o.transposed3(o.inverse3(o.matrix3from4(this.getModelMatrix())))})}function _(t,e,i,o,s,a,h,l,u){var c,p,_,g;
for(d.call(this,t,e,i,o,s,a,h,l),this._parameterArrays={},c=0;c<u.length;c++)if(_=r.getUniformName(u[c]),g=e.getUniformArrayLength(_),g>0){for(this._parameterArrays[u[c]]=new Float32Array(g),p=0;g>p;p++)this._parameterArrays[u[c]][p]=0;this.setUniformValueFunction(u[c],this.createGetParameterArrayFunction(u[c]))}else n.showError("Cannot initialize parameter array '"+u[c]+"' for parameterized mesh, as the given shader ("+e.getName()+") does not have a uniform array named '"+_+"'!")}function g(t,e,i,n,r,s){c.call(this,e,!1,!0,r,s,o.scaling4(n)),this.setTextures(i),this._model=t,this.setUniformValueFunction(K,function(){return this.getModelMatrix()})}function f(t,e,i){this.color=t,this.size=e,this.timeToReach=i}function m(t,e,i,n,r,s,a,h){var l;if(c.call(this,e,!1,!0,n,o.IDENTITY4,o.IDENTITY4,a),this.setSmallestSizeWhenDrawn(.1),this.setTextures(i),this._model=t,this._color=[],r)for(l=0;l<r[0].color.length;l++)this._color.push(r[0].color[l]);this._size=void 0!==h?h:r?r[0].size:0,this._relativeSize=1,this._states=r||[],this._currentStateIndex=0,this._looping=s===!0,this._timeSinceLastTransition=0,this._velocityVector=[0,0,0],this._shouldAnimate=!1,this.setUniformValueFunction(nt,function(){return o.translationVector3(this.getModelMatrix())}),this.setUniformValueFunction($,function(t){return t?[this._size*this._relativeSize]:this._size*this._relativeSize}),this.setUniformValueFunction(tt,function(){return this._color}),this._updateShouldAnimate()}function y(t,e,i,o,n,r,s,a){return new m(t,e,i,r,[new f(o,n,0),new f(o,0,s)],!1,a)}function S(t,e,i,o,n,r,s){return new m(t,e,i,r,[new f(o,n,0)],!1,s)}function T(t,e,i,o,n,r){m.call(this,t,e,i,r,[new f(o,n,0)],!1)}function x(t,e,i,o,n,r,s,a){this._positionMatrix=t,this._orientationMatrix=e,this._dimensions=i,this._initialNumber=o,this._spawnNumber=n,this._spawnTime=r,this._age=0,this._duration=s,this._lastSpawn=0,this._particleConstructor=a,this._particleDuration=-1}function b(t,e,i,o,n,r,s,a,h,l){x.call(this,t,e,i,r,s,a,h,l),this._velocity=o,this._velocitySpread=n}function M(t,e,i,o,n,r,s,a,h,l,u,c){x.call(this,t,e,i,a,h,l,u,c),this._direction=o,this._directionSpread=n,this._velocity=r,this._velocitySpread=s}function v(t,e,i,o,n,r,s,a,h,l,u,c){x.call(this,t,e,i,a,h,l,u,c),this._planeNormal=o,this._directionSpread=n,this._velocity=r,this._velocitySpread=s}function O(t,e,i,n,r,s,a){c.call(this,null,!1,!0,t,o.IDENTITY4,o.IDENTITY4),this._velocityMatrix=e,this._emitters=i,this._age=0,this._duration=n,this._keepAlive=r===!0,this._carriesParticles=s===!0,this._minimumCountForInstancing=a}function E(t,e,o,n,r,s){u.call(this,e,!1,!0,o),this._positionVector=n,this._model=t,this._color=r,this._range=s,this._shift=[0,0,0],this.setUniformValueFunction(nt,function(){return this._positionVector}),this._color&&(this.setUniformValueFunction(tt,function(){return this._color}),this.setUniformValueFunction(et,function(){return this._shift}),this.setUniformValueFunction(it,function(){return i.length3(this._shift)}),this.setUniformValueFunction(ot,function(){return this._range}))}function A(t,e,i,n,r,s,a){u.call(this,e,!1,!0),this.setTextures(i),this._model=t,this._position=n,this._color=s,this._size=r,this._rotationMatrix=o.rotation2(Math.radians(a||0)),this.setUniformValueFunction(nt,function(){return this._position}),this.setUniformValueFunction(rt,function(){return this._size}),this.setUniformValueFunction(tt,function(){return this._color}),this.setUniformValueFunction(st,function(){return this._rotationMatrix})}function R(t,e,i,n,r,s,a,h,l,u){this._fixed=t,this._turnsAroundObjects=e,this._movesRelativeToObject=i,this._followedObjects=n||[],this._startsWithRelativePosition=r,this._defaultRelativePositionMatrix=o.matrix4(s),this._relativePositionMatrix=s,this._worldPositionMatrix=null,this._distanceIsConfined=a?!0:!1,this._minimumDistance=a?a[0]:0,this._maximumDistance=a?a[1]:0,this._xIsConfined=h&&h[0]?!0:!1,this._minimumX=h&&h[0]?h[0][0]:0,this._maximumX=h&&h[0]?h[0][1]:0,this._yIsConfined=h&&h[1]?!0:!1,this._minimumY=h&&h[1]?h[1][0]:0,this._maximumY=h&&h[1]?h[1][1]:0,this._zIsConfined=h&&h[2]?!0:!1,this._minimumZ=h&&h[2]?h[2][0]:0,this._maximumZ=h&&h[2]?h[2][1]:0,this._resetsWhenLeavingConfines=l,this._isTransitionConfiguration=u,this._isStarting=!0,this._camera=null}function C(t,e,i,n,r,s,a,h,l,u,c,p){this._fixed=t,this._pointsTowardsObjects=e,this._fps=i,this._followedObjects=n||[],this._defaultRelativeOrientationMatrix=o.matrix4(r),this._relativeOrientationMatrix=r,this._worldOrientationMatrix=null,this._defaultAlpha=s||0,this._alpha=s||0,this._defaultBeta=a||0,this._beta=a||0,this._minAlpha=h&&void 0!==h[0]?h[0]:X,this._maxAlpha=h&&void 0!==h[1]?h[1]:H,this._minBeta=l&&void 0!==l[0]?l[0]:Q,this._maxBeta=l&&void 0!==l[1]?l[1]:Y,this._baseOrientation=u,this._pointToFallback=c,this._isTransitionConfiguration=p,this._camera=null}function w(t,e,i,o,n,r,s,h){a.call(this,e._positionMatrix,i._orientationMatrix),this._name=t,this._positionConfiguration=e,this._orientationConfiguration=i,this._defaultFOV=o,this._fov=o,this._minFOV=n?n[0]:0,this._maxFOV=n?n[1]:0,this._defaultSpan=r,this._span=r,this._minSpan=s?s[0]:0,this._maxSpan=s?s[1]:0,this._shouldAutoReset=h,this._camera=null}function N(t,e,i,n,r,s,a,h,l){var u=o.getYawAndPitch(i);return new w("",new R(!1,!1,!1,[],!1,o.matrix4(e),null,null,!1),new C(!1,!1,t,[],o.matrix4(i),Math.degrees(u.yaw),Math.degrees(u.pitch),void 0,void 0,C.prototype.BaseOrientation.WORLD,C.prototype.PointToFallback.POSITION_FOLLOWED_OBJECT_OR_WORLD),n,[r,s],a,[h,l])}function L(t,e,i,n,r,s,h){this._object3D=new a(o.identity4(),o.identity4(),o.identity4()),this._scene=t,this._aspect=e,this._usesVerticalValues=i,this._viewDistance=n,this._previousConfiguration=null,this._currentConfiguration=r,this._currentConfiguration.setCamera(this),this._transitionStyle=this.TransitionStyle.NONE,this._defaultTransitionStyle=h||this.TransitionStyle.NONE,this._transitionDuration=0,this._defaultTransitionDuration=s||0,this._transitionElapsedTime=0,this._velocityVector=[0,0,0],this._controlledVelocityVector=[0,0,0],this._angularVelocityVector=[0,0,0],this._previousFollowedPositionVector=null,this._projectionMatrix=null,this._followedNode=null,this._viewMatrix=null,this._inversePositionMatrix=null,this._inverseOrientationMatrix=null,this._fov=0,this._span=0,this._near=0,this._extendedCamera=null,this._combinedExtendedCamera=null}function I(t,e){this._color=t,this._direction=i.normal3(e),this._orientationMatrix=o.inverseOfRotation4(o.lookTowards4(this._direction)),this._matrix=null,this._translationVector=null,this._shadowMapBufferNamePrefix=null}function D(t,e,i,o,n,r){this._color=t,this._objectIntensity=e,this._relativePositionVector=i,this._emittingObjects=o,this._totalIntensity=e*(o?o.length:1),this._positionVector=null,this._states=n,this._timeSinceLastTransition=0,this._currentStateIndex=0,this._looping=r}function F(t,e,i,o,n,r,s,a,h){D.call(this,t,e,i,s,a,h),this._relativeSpotDirection=o,this._spotCutoffCosine=Math.cos(Math.radians(n)),this._spotFullIntensityCosine=n>r?Math.cos(Math.radians(r)):0,this._spotDirection=null}function V(t,e,i,n,r,s,a,h,l,u,c,p){this._left=t,this._top=e,this._width=i,this._height=n,this._shouldClearColorOnRender=r,this._clearColorMask=s,this._clearColor=a,this._shouldClearDepthOnRender=h,this._rootBackgroundNode=null,this._rootNode=null,this._rootUINode=null,this._directionalLights=[],this._directionalLightUniformData=[],this._pointLightPriorityArrays=null,this._pointLightUniformData=[],this._maxRenderedPointLights=u||0,this._spotLights=[],this._spotLightUniformData=[],this._maxRenderedSpotLights=c||0,this._rootResourceNode=null,this._camera=new L(this,this._width/this._height,p.useVerticalValues,p.viewDistance,p.configuration||N(p.fps,p.positionMatrix||o.IDENTITY4,p.orientationMatrix||o.IDENTITY4,p.fov,p.fovRange&&p.fovRange[0]||p.fov,p.fovRange&&p.fovRange[1]||p.fov,p.span,p.spanRange&&p.spanRange[0]||p.span,p.spanRange&&p.spanRange[1]||p.span),p.transitionDuration,p.transitionStyle),this._lodContext=l,this._shadowMappingEnabled=!1,this._shadowMappingShader=null,this._shadowMapTextureSize=0,this._shadowMapRanges=[],this._shadowMapDepthRatio=0,this._numShadowMapSamples=0,this._shadowMapSampleOffsets=[],this._uniformValueFunctions={},this._contextUniformValueFunctions=[],this._shouldAnimate=!0,this._shouldUpdateCamera=!0,this._numDrawnTriangles=0,this._contexts=[],this._renderQueues=[],this._uniformsUpdatedForFrame=!1,this.clearNodes(),this.clearPointLights(),this._setGeneralUniformValueFunctions()}var P,B,U={NONE:0,FRONT_QUEUE_BIT:1,DISTANCE_QUEUE_BIT:2},j=100,k=.05,G=.95,z=1.05,W=.95,q=1.05,X=-360,H=360,Q=-90,Y=90,J="viewDirectionProjectionInverse",K="modelMatrix",Z="normalMatrix",$="billboardSize",tt="color",et="shift",it="length",ot="farthestZ",nt="position",rt="size",st="rotationMatrix",at="shadow-map-buffer-",ht="-",lt="lightMatrix",ut="shadowMapDepth",ct="projMatrix",pt=5,dt="numDirLights",_t="dirLights",gt="numPointLights",ft="pointLights",mt="numSpotLights",yt="spotLights",St="cameraMatrix",Tt="viewProjMatrix",xt="cameraOrientationMatrix",bt="aspect",Mt="eyePos",vt="shadows",Ot="numRanges",Et="shadowMapRanges",At="shadowMapDepthRatio",Rt="shadowMapTextureSize",Ct="shadowMaps",wt="shadowMapSampleOffsets",Nt=[0,0,1,0,0,1,-1,0,0,-1,1,1,1,-1,-1,1,-1,-1],Lt=5,It=.01,Dt=0,Ft=1,Vt=2,Pt=3;return P=function(){function t(){this._positionMatrixInCameraSpace=null}function e(){return this._parent}function n(t){this._parent=t}function r(){return this._positionMatrix}function s(t){t&&(this._positionMatrix=t),this._modelMatrix=null,this._modelMatrixInverse=null,this._insideParent=null}function a(){return[this._positionMatrix[12],this._positionMatrix[13],this._positionMatrix[14]]}function h(t,e,i){o.translateByVector(this._positionMatrix,[t,e,i]),this.setPositionMatrix()}function l(t){o.translateByVector(this._positionMatrix,t),this.setPositionMatrix()}function u(t){o.translateByMatrix(this._positionMatrix,t),this.setPositionMatrix()}function c(){return this._orientationMatrix}function p(t){t&&(this._orientationMatrix=t),this._modelMatrix=null,this._modelMatrixInverse=null}function d(){return[this._orientationMatrix[0],this._orientationMatrix[1],this._orientationMatrix[2]]}function _(){return[this._orientationMatrix[4],this._orientationMatrix[5],this._orientationMatrix[6]]}function g(){return[this._orientationMatrix[8],this._orientationMatrix[9],this._orientationMatrix[10]]}function f(t,e){0!==e&&(o.rotate4(this._orientationMatrix,t,e),this.setOrientationMatrix())}function m(t){o.mul4(this._orientationMatrix,t),this.setOrientationMatrix()}function y(){return this._scalingMatrix}function S(t){this._scalingMatrix=t,this._modelMatrix=null,this._modelMatrixInverse=null}function T(){return this._parent?o.prod4(this._parent.getCascadeScalingMatrix(),this._scalingMatrix):this._scalingMatrix}function x(){return this._modelMatrix=this._modelMatrix||o.prod34(this._scalingMatrix,this._orientationMatrix,this._positionMatrix),this._parent?o.prod4(this._modelMatrix,this._parent.getModelMatrix()):this._modelMatrix}function b(){return this._modelMatrixInverse=this._modelMatrixInverse||o.inverse4(this.getModelMatrix()),this._parent?o.prod4(this._parent.getModelMatrixInverse(),this._modelMatrixInverse):this._modelMatrixInverse}function M(){return this._size}function v(){return this.getSize()*this.getCascadeScalingMatrix()[0]}function O(){return null===this._insideParent&&(this._insideParent=this._parent?Math.abs(this._positionMatrix[12])<this._parent.getSize()&&Math.abs(this._positionMatrix[13])<this._parent.getSize()&&Math.abs(this._positionMatrix[14])<this._parent.getSize():!1),this._insideParent}function E(t){return this._positionMatrixInCameraSpace?this._positionMatrixInCameraSpace:(this._positionMatrixInCameraSpace=o.translation4m4(o.prod4(this.getModelMatrix(),t.getViewMatrix())),this._positionMatrixInCameraSpace)}function A(t,e){var n,r,s,a,h,l,u,c,p;return s=this.getPositionMatrixInCameraSpace(t),r=this.getCascadeScalingMatrix(),e&&(n=this.getSize()*r[0],s[14]-n>=-t.getNearDistance()||s[14]+n<-t.getViewDistance())?(this._lastSizeInsideViewFrustum.width=0,this._lastSizeInsideViewFrustum.height=0,this._lastSizeInsideViewFrustum):(a=o.prod34(r,s,t.getProjectionMatrix()),n=this.getSize(),h=i.mulVec4Mat4([0,0,0,1],a),h[0]=0===h[0]?0:h[0]/h[3],h[1]=0===h[1]?0:h[1]/h[3],h[2]=0===h[2]?0:h[2]/h[3],l=i.mulVec4Mat4([n,0,0,1],a),u=i.mulVec4Mat4([0,n,0,1],a),c=Math.abs((0===l[0]?0:l[0]/l[3])-h[0]),p=Math.abs((0===u[1]?0:u[1]/u[3])-h[1]),h[0]+c<-1&&h[0]-c<-1||h[0]+c>1&&h[0]-c>1||h[1]+p<-1&&h[1]-p<-1||h[1]+p>1&&h[1]-p>1?(this._lastSizeInsideViewFrustum.width=0,this._lastSizeInsideViewFrustum.height=0,this._lastSizeInsideViewFrustum):(this._lastSizeInsideViewFrustum.width=c,this._lastSizeInsideViewFrustum.height=p,this._lastSizeInsideViewFrustum))}return function(){this.prototype.resetCachedValues=t,this.prototype.getParent=e,this.prototype.setParent=n,this.prototype.getPositionMatrix=r,this.prototype.setPositionMatrix=s,this.prototype.getOrientationMatrix=c,this.prototype.setOrientationMatrix=p,this.prototype.getScalingMatrix=y,this.prototype.setScalingMatrix=S,this.prototype.getPositionVector=a,this.prototype.translate=h,this.prototype.translatev=l,this.prototype.translateByMatrix=u,this.prototype.getXDirectionVector=d,this.prototype.getYDirectionVector=_,this.prototype.getZDirectionVector=g,this.prototype.rotate=f,this.prototype.rotateByMatrix=m,this.prototype.getCascadeScalingMatrix=T,this.prototype.getModelMatrix=x,this.prototype.getModelMatrixInverse=b,this.prototype.getSize=M,this.prototype.getScaledSize=v,this.prototype.isInsideParent=O,this.prototype.getPositionMatrixInCameraSpace=E,this.prototype.getSizeInsideViewFrustum=A}},B=P(),B.call(a),l.prototype.canBeReused=function(){var t;if(this._renderableObject.canBeReused()){for(t=0;t<this._subnodes.length;t++)if(this._subnodes[t].canBeReused()===!1)return!1;return!0}return!1},l.prototype.getScene=function(){return this._scene},l.prototype.setScene=function(t){var e;for(this._scene=t,t&&t.addObjectToContexts(this._renderableObject),e=0;e<this._subnodes.length;e++)this._subnodes[e].setScene(t)},l.prototype.addToRenderQueue=function(t){var e;if(0===this._minimumCountForInstancing){for(e=0;e<t.length;e++)if(t[e].length>0&&0===t[e][0].getMinimumCountForInstancing()&&this._renderableObject.shouldGoInSameRenderQueue(t[e][0]._renderableObject))return t[e].push(this),e}else for(e=0;e<t.length;e++)if(t[e].length>0&&t[e][0].getMinimumCountForInstancing()>0&&this._renderableObject.shouldGoInSameRenderQueueInstanced(t[e][0]._renderableObject))return t[e].push(this),e;return t.push([this]),t.length-1},l.prototype.animateAndAddToRenderQueues=function(t,e,i){var o,n,r,s,a;if(this._visible&&(this._scene.shouldAnimate()&&this._renderableObject.animate(i),s=this._renderableObject.isRenderedWithoutDepthMask(),a=this._renderableObject.isRenderedWithDepthMask(),(s||a)&&(o=this._renderableObject.getRenderQueueBits(e),o&U.FRONT_QUEUE_BIT&&(s&&this.addToRenderQueue(t[Ft]),a&&this.addToRenderQueue(t[Dt])),o&U.DISTANCE_QUEUE_BIT&&(s&&this.addToRenderQueue(t[Pt]),a&&this.addToRenderQueue(t[Vt]))),this._subnodes.length>0))if(!this._hasInstancedSubnodes||this._subnodes.length<this._subnodes[0].getMinimumCountForInstancing())for(n=0;n<this._subnodes.length;n++)this._subnodes[n].animateAndAddToRenderQueues(t,e,i);else{if(this._scene.shouldAnimate())for(n=0;n<this._subnodes.length;n++)this._subnodes[n]._renderableObject.animate(i);s=this._subnodes[0]._renderableObject.isRenderedWithoutDepthMask(),a=this._subnodes[0]._renderableObject.isRenderedWithDepthMask(),(s||a)&&(o=this._subnodes[0]._renderableObject.getRenderQueueBits(e),o&U.FRONT_QUEUE_BIT&&(s&&(r=this._subnodes[0].addToRenderQueue(t[Ft]),t[Ft][r].pop(),t[Ft][r]=t[Ft][r].concat(this._subnodes)),a&&(r=this._subnodes[0].addToRenderQueue(t[Dt]),t[Dt][r].pop(),t[Dt][r]=t[Dt][r].concat(this._subnodes))),o&U.DISTANCE_QUEUE_BIT&&(s&&(r=this._subnodes[0].addToRenderQueue(t[Pt]),t[Pt][r].pop(),t[Pt][r]=t[Pt][r].concat(this._subnodes)),a&&(r=this._subnodes[0].addToRenderQueue(t[Vt]),t[Vt][r].pop(),t[Vt][r]=t[Vt][r].concat(this._subnodes))))}},l.prototype.getParent=function(){return this._parent},l.prototype.setParent=function(t){this._parent=t,this.setScene(t._scene),this._renderableObject.setParent&&this._renderableObject.setParent(t._renderableObject)},l.prototype.getRenderableObject=function(){return this._renderableObject},l.prototype.show=function(){this._visible=!0},l.prototype.hide=function(){this._visible=!1},l.prototype.toggleVisibility=function(){this._visible=!this._visible},l.prototype.addSubnode=function(t){return this._subnodes.push(t),t.setParent(this),this._scene&&t.setScene(this._scene),t},l.prototype.getSubnodes=function(){return this._subnodes},l.prototype.getFirstSubnode=function(){return this._subnodes[0]},l.prototype.getNextSubnode=function(t){var e,i;for(e=0,i=this._subnodes.length;i>e;e++)if(this._subnodes[e]===t)return e===this._subnodes.length-1?this._subnodes[0]:this._subnodes[e+1];return this._subnodes[0]},l.prototype.getPreviousSubnode=function(t){var e,i;for(e=0,i=this._subnodes.length;i>e;e++)if(this._subnodes[e]===t)return 0===e?this._subnodes[this._subnodes.length-1]:this._subnodes[e-1];return this._subnodes[this._subnodes.length-1]},l.prototype.addCameraConfiguration=function(t){this._cameraConfigurations.push(t)},l.prototype.hasCameraConfiguration=function(t){var e;for(e=0;e<this._cameraConfigurations.length;e++)if(this._cameraConfigurations[e]===t)return!0;return!1},l.prototype.getNextCameraConfiguration=function(t){var e;if(!t)return this._cameraConfigurations.length>0?this._cameraConfigurations[0]:null;for(e=0;e<this._cameraConfigurations.length;e++)if(this._cameraConfigurations[e]===t)return this._cameraConfigurations[(e+1)%this._cameraConfigurations.length];n.crash()},l.prototype.getPreviousCameraConfiguration=function(t){var e;if(!t)return this._cameraConfigurations.length>0?this._cameraConfigurations[this._cameraConfigurations.length-1]:null;for(e=this._cameraConfigurations.length-1;e>=0;e--)if(this._cameraConfigurations[e]===t)return 0===e?this._cameraConfigurations[this._cameraConfigurations.length-1]:this._cameraConfigurations[e-1];n.crash()},l.prototype.getCameraConfigurationsWithName=function(t){var e,i=[];for(e=0;e<this._cameraConfigurations.length;e++)this._cameraConfigurations[e].getName()===t&&i.push(this._cameraConfigurations[e]);return i},l.prototype.resetCameraConfigurations=function(){var t;for(t=0;t<this._cameraConfigurations.length;t++)this._cameraConfigurations[t].resetToDefaults()},l.prototype.resetForNewFrame=function(){var t;for(this._renderableObject.resetForNewFrame(),t=0;t<this._subnodes.length;t++)this._subnodes[t].resetForNewFrame()},l.prototype.setRenderParameters=function(t,e,i,o,n,r){this._renderParameters.context=t,this._renderParameters.depthMask=o,this._renderParameters.scene=this._scene,this._renderParameters.parent=this._parent?this._parent._renderableObject:null,this._renderParameters.camera=this._scene.getCamera(),this._renderParameters.viewportWidth=e,this._renderParameters.viewportHeight=i,this._renderParameters.lodContext=this._scene.getLODContext(),this._renderParameters.useInstancing=n,this._renderParameters.instanceQueueIndex=r},l.prototype.render=function(t,e,i,o,n,r,s){var a,h;if(this._visible){if(this.setRenderParameters(t,e,i,o,r,s),h=this._renderableObject.render(this._renderParameters),!n)for(a=0;a<this._subnodes.length;a++)this._subnodes[a].render(t,e,i,o,r,s);return h}return!1},l.prototype.prepareForInstancedRender=function(t,e,i){this._renderableObject.prepareForInstancedRender(t,this._scene,e,i)},l.prototype.renderInstances=function(t,e,i){this._renderableObject.renderInstances(t,e,i)},l.prototype.renderToShadowMap=function(t,e,i){var o;if(this._visible)for(this.setRenderParameters(t,e,i,!0),this._renderableObject.renderToShadowMap(this._renderParameters),o=0;o<this._subnodes.length;o++)this._subnodes[o].renderToShadowMap(t,e,i)},l.prototype.addToContext=function(t){var e;for(this._renderableObject.addToContext(t),e=0;e<this._subnodes.length;e++)this._subnodes[e].addToContext(t)},l.prototype.getShader=function(){return this._renderableObject.getShader()},l.prototype.setShader=function(t){var e;for(this._renderableObject.setShader(t),e=0;e<this._subnodes.length;e++)this._subnodes[e].setShader(t)},l.prototype.markAsReusable=function(){var t;for(this._renderableObject.markAsReusable(),t=0;t<this._subnodes.length;t++)this._subnodes[t].markAsReusable()},l.prototype.cleanUp=function(){var t,e,i;for(t=0;t<this._subnodes.length;t++){for(this._subnodes[t].cleanUp(),e=t,i=0;e<this._subnodes.length&&(!this._subnodes[e]||this._subnodes[e].canBeReused()===!0);)e++,i++;this._subnodes.splice(t,i)}},l.prototype.getMinimumCountForInstancing=function(){return this._minimumCountForInstancing},l.prototype.getNumberOfDrawnTriangles=function(t){var e,i=0;for(this._renderableObject._wasRendered&&(i+=this._renderableObject.getNumberOfDrawnTriangles(t)),e=0;e<this._subnodes.length;e++)i+=this._subnodes[e].getNumberOfDrawnTriangles(t);return i},l.prototype.destroy=function(){var t;if(this._renderableObject.setNode(null),this._renderableObject=null,this._scene=null,this._parent=null,this._subnodes){for(t=0;t<this._subnodes.length;t++)this._subnodes[t].destroy(),this._subnodes[t]=null;this._subnodes=null}this._renderParameters=null,this._cameraConfigurations=null},u.prototype.getNode=function(){return null===this._node&&(this._node=new l(this)),this._node},u.prototype.setNode=function(t){this._node=t},u.prototype.getShader=function(){return this._shader},u.prototype.setShader=function(t){this._shader=t},u.prototype.setTexture=function(t,e){this._textures[t]=e},u.prototype.setTextures=function(t){this._textures=t},u.prototype.isRenderedWithoutDepthMask=function(){return this._isRenderedWithoutDepthMask},u.prototype.isRenderedWithDepthMask=function(){return this._isRenderedWithDepthMask},u.prototype.setUniformValueFunction=function(t,e,i){this._uniformValueFunctions[r.getUniformName(t)]=e.bind(i||this)},u.prototype.createTextureLocationGetter=function(t,e){var i=e.getName();return function(){return this._textures[t].getLastTextureBindLocation(i)}.bind(this)},u.prototype.addToContext=function(t){var e;this._shader&&t.addShader(this._shader),this._instancedShader&&t.addShader(this._instancedShader);for(e in this._textures)this._textures.hasOwnProperty(e)&&(t.addTexture(this._textures[e]),this._textures[e]instanceof r.ManagedTexture?this.setUniformValueFunction(r.getTextureUniformRawName(e),this.createTextureLocationGetter(e,t)):this._textures[e]instanceof r.ManagedCubemap?this.setUniformValueFunction(r.getCubemapUniformRawName(e),this.createTextureLocationGetter(e,t)):n.showError("Attemtping to add a texture of unknown type ("+this._textures[e].constructor.name+") to the GL context."))},u.prototype.bindTextures=function(t){var e;for(e in this._textures)this._textures.hasOwnProperty(e)&&t.bindTexture(this._textures[e])},u.prototype.markAsReusable=function(){this._canBeReused=!0},u.prototype.canBeReused=function(){return this._canBeReused},u.prototype.resetForNewFrame=function(){this._wasRendered=!1},u.prototype.getRenderQueueBits=function(){return this._visible?U.FRONT_QUEUE_BIT:U.NONE},u.prototype.prepareForInstancedRender=function(t,e,i,o){t.setCurrentShader(this._instancedShader)&&e.assignUniforms(t,this._instancedShader),this.bindTextures(t),this._instancedShader.assignUniforms(t,this._uniformValueFunctions),this._instancedShader.createInstanceBuffers(i,o)},u.prototype.shouldBeRendered=function(t){return this._canBeReused!==!0&&this._visible?t.depthMask&&this._isRenderedWithDepthMask||!t.depthMask&&this._isRenderedWithoutDepthMask:!1},u.prototype.prepareForRender=function(t){t.useInstancing?this._instancedShader.addDataToInstanceBuffers(t.instanceQueueIndex,this._uniformValueFunctions):(t.context.setCurrentShader(this._shader)&&t.scene.assignUniforms(t.context,this._shader),this.bindTextures(t.context),this._shader.assignUniforms(t.context,this._uniformValueFunctions))},u.prototype.performRender=function(){return!0},u.prototype.finishRender=function(){this._wasRendered=!0},u.prototype.render=function(t){return this.shouldBeRendered(t)?(this.prepareForRender(t),t.useInstancing||this.performRender(t),this.finishRender(t),!0):!1},u.prototype._peformRenderInstances=function(t,e){n.showError("Cannot render "+e+" instances of "+this.constructor.name+" to "+t.getName()+" in instanced mode, because no instanced render method was defined for it!")},u.prototype.renderInstances=function(t,e,i){this._instancedShader.bindAndFillInstanceBuffers(t,e),this._peformRenderInstances(t,i)},u.prototype.shouldBeRenderedToShadowMap=function(){return!this._canBeReused},u.prototype.prepareForRenderToShadowMap=function(){return!0},u.prototype.performRenderToShadowMap=function(){return!0},u.prototype.renderToShadowMap=function(t){this.shouldBeRenderedToShadowMap(t)&&(this.prepareForRenderToShadowMap(t),this.performRenderToShadowMap(t))},u.prototype.shouldAnimate=function(t){return t>0},u.prototype.performAnimate=function(){return!0},u.prototype.animate=function(t){this.shouldAnimate(t)&&this.performAnimate(t)},u.prototype.wasRendered=function(){return this._wasRendered},u.prototype.getNumberOfDrawnTriangles=function(){return 0},u.prototype.shouldGoInSameRenderQueue=function(t){return this._shader===t.getShader()},u.prototype.shouldGoInSameRenderQueueInstanced=function(t){return this.constructor===t.constructor&&this._shader===t._shader},c.prototype=new u,B.call(c),c.prototype.constructor=u,c.prototype.setSmallestSizeWhenDrawn=function(t){this._smallestSizeWhenDrawn=t},c.prototype.getVisibleSize=function(t){return this._visibleSize.width<0&&(this._visibleSize=this.getSizeInsideViewFrustum(t.camera)),this._visibleSize},c.prototype.isInsideViewFrustum=function(t){return this.getVisibleSize(t).width>0},c.prototype.getSizeInPixels=function(t){return this.getVisibleSize(t),this._visibleSize.width<0&&n.showError("Attempting to access the size of an object on the screen in pixels, before the size has been calculated."),Math.max(this._visibleSize.width*t.viewportWidth/2,this._visibleSize.height*t.viewportHeight/2)},c.prototype.isInsideShadowCastFrustum=function(t){return null===this._insideShadowCastFrustum&&(this._insideShadowCastFrustum=this.getSizeInsideViewFrustum(t).width>0),this._insideShadowCastFrustum},c.prototype.resetForNewFrame=function(){u.prototype.resetForNewFrame.call(this),c.prototype.resetCachedValues.call(this),this._visibleSize.width=-1,this._visibleSize.height=-1,this._insideShadowCastFrustum=null},c.prototype.getRenderQueueBits=function(t){var e,i,o,n=U.NONE;return e=this.getPositionMatrixInCameraSpace(t),i=this.getCascadeScalingMatrix(),o=this.getSize()*i[0],e[14]-o<=-t.getNearDistance()&&e[14]+o>-t.getViewDistance()&&(n|=U.FRONT_QUEUE_BIT),e[14]-o<=-t.getViewDistance()&&e[14]+o>-t.getExtendedCamera().getViewDistance()&&(n|=U.DISTANCE_QUEUE_BIT),n},c.prototype.shouldBeRendered=function(t){var e,i;return u.prototype.shouldBeRendered.call(this,t)?this.isInsideParent()===!0?void 0===t.parent.isInsideViewFrustum||t.parent.isInsideViewFrustum(t)?(e=t.parent.getVisibleSize(t),i=Math.max(this.getSize()/t.parent.getSize(),t.lodContext.minimumRelativeSize),this._visibleSize.width=e.width*i,this._visibleSize.height=e.height*i,this.getSizeInPixels(t)<this._smallestSizeWhenDrawn?!1:!0):(this._visibleSize.width=0,this._visibleSize.height=0,!1):(e=this.getVisibleSize(t),this.getSizeInPixels(t)<this._smallestSizeWhenDrawn?!1:this.isInsideViewFrustum(t)):!1},p.prototype=new u,p.prototype.constructor=p,p.prototype.addToContext=function(t){u.prototype.addToContext.call(this,t),this._model.addToContext(t,!1)},p.prototype.performRender=function(t){this._model.render(t.context,!1)},p.prototype.getNumberOfDrawnTriangles=function(){return 2},d.prototype=new c,d.prototype.constructor=d,d.prototype.LOD_NOT_SET=-1,d.prototype.addToContext=function(t){var e;for(c.prototype.addToContext.call(this,t),this._model.addToContext(t,this._wireframe),e=this._model.getMinLOD();e<=this._model.getMaxLOD();e++)this._model.getSize(e)>this._modelSize&&(this._modelSize=this._model.getSize(e))},d.prototype.getSize=function(){return this._modelSize},d.prototype.getLODSize=function(t,e){return void 0===this._lodSizeFactors[e.toString()]&&(this._lodSizeFactors[e.toString()]=Math.log10(e+10)/Math.log10(this.getScaledSize()+10)),t*this._lodSizeFactors[e.toString()]},d.prototype.getHeight=function(){return this._model.getHeight()},d.prototype.getHeightInMeters=function(){return this._model.getHeightInMeters()},d.prototype.getMaxY=function(){return this._model.getMaxY()},d.prototype.getCurrentLOD=function(t){var e,i,o;if(this._currentLOD===this.LOD_NOT_SET)if(this._staticLOD!==this.LOD_NOT_SET)this._currentLOD=this._model.getClosestAvailableLOD(this._staticLOD);else for(e=this.getSizeInPixels(t),i=t.lodContext.compensateForObjectSize?this.getLODSize(e,t.lodContext.referenceSize):e,o=this._model.getMinLOD();o<=this._model.getMaxLOD();o++)(this._currentLOD===this.LOD_NOT_SET||o<=t.lodContext.maxEnabledLOD&&(this._currentLOD>t.lodContext.maxEnabledLOD||t.lodContext.thresholds[this._currentLOD]>i&&t.lodContext.thresholds[o]<=i||t.lodContext.thresholds[this._currentLOD]<=i&&t.lodContext.thresholds[o]<=i&&o>this._currentLOD||t.lodContext.thresholds[this._currentLOD]>i&&t.lodContext.thresholds[o]>i&&o<this._currentLOD))&&(this._currentLOD=o);return this._currentLOD},d.prototype.resetForNewFrame=function(){c.prototype.resetForNewFrame.call(this),this._staticLOD===this.LOD_NOT_SET&&(this._currentLOD=this.LOD_NOT_SET)},d.prototype.shouldBeRendered=function(t){if(c.prototype.shouldBeRendered.call(this,t)){if(this._wireframe===!0)return!0;if(t.depthMask===!0){if(this._model.getNumOpaqueTriangles(this.getCurrentLOD(t))>0)return!0}else if(t.depthMask===!1&&this._model.getNumTransparentTriangles(this.getCurrentLOD(t))>0)return!0;return!1}return!1},d.prototype.performRender=function(t){this._model.render(t.context,this._wireframe,t.depthMask,this.getCurrentLOD(t))},d.prototype.shouldBeRenderedToShadowMap=function(t){return c.prototype.shouldBeRenderedToShadowMap.call(this,t)?this.shouldBeRendered(t):void 0},d.prototype.prepareForRenderToShadowMap=function(t){t.context.getCurrentShader().assignUniforms(t.context,this._uniformValueFunctions)},d.prototype.performRenderToShadowMap=function(t){this._model.render(t.context,this._wireframe,!0,this.getCurrentLOD(t))},d.prototype.getNumberOfDrawnTriangles=function(t){return this._wireframe===!1&&this._currentLOD!==this.LOD_NOT_SET?this._model.getNumTriangles(this._currentLOD,t):0},_.prototype=new d([]),_.prototype.constructor=_,_.prototype.createGetParameterArrayFunction=function(t){return function(){return this._parameterArrays[t]}},_.prototype.setParameter=function(t,e,i){this._parameterArrays[t][e]=i},g.prototype=new c,g.prototype.constructor=g,g.prototype.addToContext=function(t){c.prototype.addToContext.call(this,t),this._model.addToContext(t,!1)},g.prototype.isInsideViewFrustum=function(){return!0},g.prototype.performRender=function(t){this._model.render(t.context,!1)},g.prototype.getNumberOfDrawnTriangles=function(t){return t!==!1?this._model.getNumTriangles():0},m.prototype=new c,m.prototype.constructor=m,m.prototype.getSize=function(){return this._size*this._relativeSize},m.prototype._hasVelocity=function(){return this._velocityVector&&(0!==this._velocityVector[0]||0!==this._velocityVector[1]||0!==this._velocityVector[2])},m.prototype._updateShouldAnimate=function(){this._shouldAnimate=this._states.length>1||this._hasVelocity()},m.prototype.getRelativeSize=function(){return this._relativeSize},m.prototype._updateVisible=function(){this._visible=this._size*this._relativeSize>=It},m.prototype.setRelativeSize=function(t){this._relativeSize=t,this._updateVisible()},m.prototype.getVelocityVector=function(){return this._velocityMatrix;
},m.prototype.setVelocityVector=function(t){this._velocityVector=t,this._updateShouldAnimate()},m.prototype.getStates=function(){return this._states},m.prototype.addToContext=function(t){c.prototype.addToContext.call(this,t),this._model.addToContext(t,!1)},m.prototype.isInsideViewFrustum=function(){return this._parent&&this.isInsideParent()?this._parent.isInsideViewFrustum():!0},m.prototype.getRenderQueueBits=function(t){return this._visible?c.prototype.getRenderQueueBits.call(this,t):U.NONE},m.prototype.shouldBeRendered=function(t){return this._visible?c.prototype.shouldBeRendered.call(this,t):!1},m.prototype.performRender=function(t){this._model.render(t.context,!1)},m.prototype._peformRenderInstances=function(t,e){this._model.renderInstances(t,!1,void 0,void 0,e)},m.prototype.shouldAnimate=function(t){return c.prototype.shouldAnimate.call(this,t)?this._shouldAnimate:!1},m.prototype.performAnimate=function(t){var e,o,n;if(this._states.length>1){for(this._timeSinceLastTransition+=t,e=(this._currentStateIndex+1)%this._states.length;this._timeSinceLastTransition>this._states[e].timeToReach;){if(0===e&&!this._looping)return this._size=0,void this.markAsReusable();this._timeSinceLastTransition-=this._states[e].timeToReach,e=(e+1)%this._states.length}for(this._currentStateIndex=0===e?this._states.length-1:e-1,o=this._timeSinceLastTransition/this._states[e].timeToReach,n=0;n<this._color.length;n++)this._color[n]=this._states[this._currentStateIndex].color[n]*(1-o)+this._states[e].color[n]*o;this._size=this._states[this._currentStateIndex].size*(1-o)+this._states[e].size*o,this._visible=this._size*this._relativeSize>.01}this._hasVelocity()&&this.translatev(i.scaled3(this._velocityVector,t/1e3))},m.prototype.getNumberOfDrawnTriangles=function(t){return t!==!1?2:0},m.prototype.shouldGoInSameRenderQueueInstanced=function(t){return c.prototype.shouldGoInSameRenderQueueInstanced.call(this,t)&&this._textures===t._textures&&this._model===t._model},T.prototype=new m,T.prototype.constructor=T,T.prototype.isInsideViewFrustum=function(){return!0},T.prototype.shouldBeRendered=function(t){return u.prototype.shouldBeRendered.call(this,t)},x.prototype.getDuration=function(){return this._duration},x.prototype.getParticleDuration=function(){var t,e;if(-1===this._particleDuration)for(this._particleDuration=0,e=this._particleConstructor()._states,t=0;t<e.length;t++)this._particleDuration+=e[t].timeToReach;return this._particleDuration},x.prototype._createParticle=function(){var t,e;return t=this._particleConstructor(),e=o.translation4(this._positionMatrix[12]+(Math.random()-.5)*this._dimensions[0],this._positionMatrix[13]+(Math.random()-.5)*this._dimensions[1],this._positionMatrix[14]+(Math.random()-.5)*this._dimensions[2]),t.setPositionMatrix(o.translation4m4(o.prod4(e,this._orientationMatrix))),t},x.prototype.emitParticles=function(t){var e,i;if(e=[],0===this._age)for(i=0;i<this._initialNumber;i++)e.push(this._createParticle());for(this._age+=t;this._age-this._lastSpawn>this._spawnTime&&(this._lastSpawn<=this._duration||0===this._duration);){for(i=0;i<this._spawnNumber;i++)e.push(this._createParticle());this._lastSpawn+=this._spawnTime}return e},b.prototype=new x,b.prototype.constructor=b,b.prototype._createParticle=function(){var t,e,i=x.prototype._createParticle.call(this);return t=this._velocity+(Math.random()-.5)*this._velocitySpread,e=o.translation4v([0,t,0]),o.rotate4(e,[1,0,0],2*Math.random()*Math.PI),o.rotate4(e,[0,0,1],2*Math.random()*Math.PI),i.setVelocityVector(o.translationVector3(e)),i},M.prototype=new x,M.prototype.constructor=M,M.prototype._createParticle=function(){var t,e,n,r=x.prototype._createParticle.call(this);return t=this._velocity+(Math.random()-.5)*this._velocitySpread,e=o.translation4v(i.scaled3(this._direction,t)),n=Math.abs(this._direction[0])<.75?[1,0,0]:Math.abs(this._direction[1])<.75?[0,1,0]:[0,0,1],i.mulCross3(n,this._direction),i.normalize3(n),o.rotate4(e,n,Math.random()*this._directionSpread/180*Math.PI),o.rotate4(e,this._direction,360*Math.random()/180*Math.PI),r.setVelocityVector(o.translationVector3(e)),r},v.prototype=new x,v.prototype.constructor=M,v.prototype._createParticle=function(){var t,e,n,r=x.prototype._createParticle.call(this);return e=this._velocity+(Math.random()-.5)*this._velocitySpread,t=Math.abs(this._planeNormal[0])<.75?[1,0,0]:Math.abs(this._planeNormal[1])<.75?[0,1,0]:[0,0,1],i.mulCross3(t,this._planeNormal),i.normalize3(t),n=o.translation4v(i.scaled3(t,e)),o.rotate4(n,i.cross3(t,this._planeNormal),(Math.random()-.5)*this._directionSpread/180*Math.PI),o.rotate4(n,this._planeNormal,2*Math.random()*Math.PI),r.setVelocityVector(o.translationVector3(n)),r},O.prototype=new c,O.prototype.constructor=O,O.prototype.shouldBeRendered=function(){return!1},O.prototype.performAnimate=function(t){var e,n,r,s,a,h;if(!this._keepAlive&&this._age>this._duration)return void this.getNode().markAsReusable();if(this._age+=t,this._emitters)for(e=0;e<this._emitters.length;e++)if(r=this._emitters[e].emitParticles(t),this._carriesParticles)for(n=0;n<r.length;n++)this.getNode().addSubnode(new l(r[n],!1,this._minimumCountForInstancing));else for(s=this.getModelMatrix(),a=o.translation4m4(s),h=o.rotation4m4(s),n=0;n<r.length;n++)r[n].translateByMatrix(a),r[n].rotateByMatrix(h),this.getNode()._scene.addNode(new l(r[n],!1,this._minimumCountForInstancing));this.translatev(i.scaled3(o.translationVector3(this._velocityMatrix),t/1e3))},O.prototype.finishEmitting=function(){var t,e,i=0;if(this._keepAlive=!1,this._age=0,this._carriesParticles){if(this._emitters){for(t=0;t<this._emitters;t++)e=this._emitters[t]._duration+this._emitters[t].getParticleDuration(),e>i&&(i=e);this._emitters=null}this._duration=i}else this.getNode().markAsReusable()},E.prototype=new u,E.prototype.constructor=E,E.prototype.addToContext=function(t){u.prototype.addToContext.call(this,t),this._model.addToContext(t,!1)},E.prototype.setShift=function(t,e,i){this._shift[0]=t,this._shift[1]=e,this._shift[2]=i},E.prototype.fitPositionWithinRange=function(t,e){var i;for(i=0;3>i;i++){for(;this._positionVector[i]>t[12+i]+e;)this._positionVector[i]-=2*e;for(;this._positionVector[i]<t[12+i]-e;)this._positionVector[i]+=2*e}},E.prototype.performRender=function(t){this._model.render(t.context,!0)},E.prototype._peformRenderInstances=function(t,e){this._model.renderInstances(t,!0,!1,void 0,e)},E.prototype.shouldAnimate=function(){return!1},E.prototype.shouldGoInSameRenderQueueInstanced=function(t){return u.prototype.shouldGoInSameRenderQueueInstanced.call(this,t)&&this._color===t._color&&this._range===t._range},A.prototype=new u,A.prototype.constructor=A,A.prototype.performRender=function(t){this._model.render(t.context)},A.prototype.setPosition=function(t){this._position=t},A.prototype.setAngle=function(t){this._rotationMatrix=o.rotation2(t)},R.prototype.copy=function(t){var e=new R(this._fixed,this._turnsAroundObjects,this._movesRelativeToObject,this._followedObjects.slice(),this._startsWithRelativePosition,o.matrix4(this._defaultRelativePositionMatrix),this._distanceIsConfined?[this._minimumDistance,this._maximumDistance]:null,[this._xIsConfined?[this._minimumX,this._maximumX]:null,this._yIsConfined?[this._minimumY,this._maximumY]:null,this._zIsConfined?[this._minimumZ,this._maximumZ]:null],this._resetsWhenLeavingConfines,t);return e._relativePositionMatrix=o.matrix4(this._relativePositionMatrix),e._worldPositionMatrix=o.matrix4(this._worldPositionMatrix),e._isStarting=this._isStarting,e},R.prototype.setCamera=function(t,e){t&&this._camera!==t&&this._startsWithRelativePosition&&!e&&this.resetToDefaults(!0),this._camera=t},R.prototype.resetToDefaults=function(t){this._camera&&!t&&this._camera.positionConfigurationWillChange(),o.setMatrix4(this._relativePositionMatrix,this._defaultRelativePositionMatrix),this._worldPositionMatrix=null,this._isStarting=!0},R.prototype.setRelativePositionMatrix=function(t,e){this._camera&&!e&&this._camera.positionConfigurationWillChange(),this._relativePositionMatrix=t},R.prototype.followsObjects=function(e){return e?t.arraysEqual(this._followedObjects.sort(),e.sort()):this._followedObjects.length>0&&!this._startsWithRelativePosition},R.prototype.getFollowedPositionVector=function(){var t,e=[0,0,0];if(0===this._followedObjects.length)n.crash();else{for(t=0;t<this._followedObjects.length;t++)i.add3(e,this._followedObjects[t].getPositionVector());e=[e[0]/this._followedObjects.length,e[1]/this._followedObjects.length,e[2]/this._followedObjects.length]}return e},R.prototype.getFollowedPositionMatrix=function(){var t,e=o.identity4();if(0===this._followedObjects.length)n.crash();else{for(t=0;t<this._followedObjects.length;t++)o.translateByMatrix(e,this._followedObjects[t]._positionMatrix);e=o.translation4(e[12]/this._followedObjects.length,e[13]/this._followedObjects.length,e[14]/this._followedObjects.length)}return e},R.prototype.getFollowedObjectOrientationMatrix=function(){var t;return 0===this._followedObjects.length?n.crash():t=o.matrix4(this._followedObjects[0]._orientationMatrix),t},R.prototype._cleanupFollowedObjects=function(){var t,e,i;for(t=0;t<this._followedObjects.length;t++){for(e=t,i=0;e<this._followedObjects.length&&(!this._followedObjects[e]||this._followedObjects[e].canBeReused()===!0);)e++,i++;i>0&&(this._followedObjects.splice(t,i),0===this._followedObjects.length&&(this._relativePositionMatrix=o.matrix4(this._worldPositionMatrix)))}},R.prototype._calculateWorldPositionMatrix=function(t){this._followedObjects.length>0&&(!this._startsWithRelativePosition||this._isStarting)?(this._isStarting=!1,this._turnsAroundObjects?t?this._worldPositionMatrix=o.prod4(o.translation4m4(o.prod4(this._relativePositionMatrix,o.prod4(o.rotation4([1,0,0],Math.PI/2),t))),this.getFollowedPositionMatrix()):n.crash():this._worldPositionMatrix=o.prod4(o.translation4m4(o.prod4(this._relativePositionMatrix,this.getFollowedObjectOrientationMatrix())),this.getFollowedPositionMatrix()),this._startsWithRelativePosition&&(this._relativePositionMatrix=o.matrix4(this._worldPositionMatrix))):this._worldPositionMatrix=o.matrix4(this._relativePositionMatrix)},R.prototype.getWorldPositionMatrix=function(t){return this._worldPositionMatrix||this._calculateWorldPositionMatrix(t),this._worldPositionMatrix},R.prototype._checkConfines=function(t){var e,r,s;if(s=this._startsWithRelativePosition&&!this._isStarting&&this._followedObjects.length>0?o.translation4m4(o.prod34(this._relativePositionMatrix,o.inverseOfTranslation4(this.getFollowedPositionMatrix()),o.inverseOfRotation4(this.getFollowedObjectOrientationMatrix()))):this._relativePositionMatrix,this._distanceIsConfined)if(this._followedObjects.length>0){if(e=o.translationVector3(s),r=i.length3(e),r<this._minimumDistance||r>this._maximumDistance){if(r>this._maximumDistance&&this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;r=Math.min(Math.max(r,this._minimumDistance),this._maximumDistance),s=o.translation4v(i.scaled3(i.normal3(e),r))}}else if(t&&(e=i.diff3(o.translationVector3(s),t),r=i.length3(e),r<this._minimumDistance||r>this._maximumDistance)){if(r>this._maximumDistance&&this._resetsWhenLeavingConfines)return n.crash(),!1;r=Math.min(Math.max(r,this._minimumDistance),this._maximumDistance),s=o.translation4v(i.sum3(t,i.scaled3(i.normal3(e),r)))}if(this._xIsConfined&&(s[12]<this._minimumX||s[12]>this._maximumX)){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;s[12]=Math.min(Math.max(s[12],this._minimumX),this._maximumX)}if(this._yIsConfined&&(s[13]<this._minimumY||s[13]>this._maximumY)){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;s[13]=Math.min(Math.max(s[13],this._minimumY),this._maximumY)}if(this._zIsConfined&&(s[14]<this._minimumZ||s[14]>this._maximumZ)){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;s[14]=Math.min(Math.max(s[14],this._minimumZ),this._maximumZ)}return this._startsWithRelativePosition&&!this._isStarting&&this._followedObjects.length>0?this._relativePositionMatrix=o.prod4(o.translation4m4(o.prod4(s,this.getFollowedObjectOrientationMatrix())),this.getFollowedPositionMatrix()):this._relativePositionMatrix=s,!0},R.prototype.update=function(t,e,n,r){var s,a;if(!this._fixed)if(0===this._followedObjects.length||this._startsWithRelativePosition)s=i.scaled3(i.mulVec3Mat4(n,t),r/1e3),o.translateByVector(this._relativePositionMatrix,s);else if(this._turnsAroundObjects){if(this._distanceIsConfined){if(s=o.translationVector3(this._relativePositionMatrix),a=i.length3(s)+n[2]*r/1e3,a<this._minimumDistance||a>this._maximumDistance){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;n[2]=0,a=Math.min(Math.max(a,this._minimumDistance),this._maximumDistance)}this._relativePositionMatrix=o.translation4v(i.scaled3(i.normal3(s),a))}}else this._movesRelativeToObject?o.translateByVector(this._relativePositionMatrix,i.scaled3(i.mulVec3Mat4(n,o.rotation4([1,0,0],-Math.PI/2)),r/1e3)):o.translateByVector(this._relativePositionMatrix,i.scaled3(i.mulVec3Mat4(n,o.prod4(t,o.inverseOfRotation4(this.getFollowedObjectOrientationMatrix()))),r/1e3));if(!this._isTransitionConfiguration){if(!this._checkConfines(e))return!1;this._cleanupFollowedObjects()}return this._worldPositionMatrix=null,!0},C.prototype.BaseOrientation={WORLD:"world",POSITION_FOLLOWED_OBJECTS:"positionFollowedObjects",ORIENTATION_FOLLOWED_OBJECT:"orientationFollowedObject"},Object.freeze(C.prototype.BaseOrientation),C.prototype.PointToFallback={WORLD:"world",STATIONARY:"stationary",POSITION_FOLLOWED_OBJECT_OR_WORLD:"positionFollowedObjectOrWorld"},Object.freeze(C.prototype.PointToFallback),C.prototype.copy=function(t){var e=new C(this._fixed,this._pointsTowardsObjects,this._fps,this._followedObjects.slice(),o.matrix4(this._defaultRelativeOrientationMatrix),this._alpha,this._beta,[this._minAlpha,this._maxAlpha],[this._minBeta,this._maxBeta],this._baseOrientation,this._pointToFallback,t);return e._relativeOrientationMatrix=o.matrix4(this._relativeOrientationMatrix),e._worldOrientationMatrix=o.matrix4(this._worldOrientationMatrix),e},C.prototype.setCamera=function(t){this._camera=t},C.prototype.resetToDefaults=function(t){this._camera&&!t&&this._camera.orientationConfigurationWillChange(),o.setMatrix4(this._relativeOrientationMatrix,this._defaultRelativeOrientationMatrix),this._alpha=this._defaultAlpha,this._beta=this._defaultBeta,this._worldOrientationMatrix=null},C.prototype.setRelativeOrientationMatrix=function(t,e){this._camera&&!e&&this._camera.orientationConfigurationWillChange(),this._relativeOrientationMatrix=t},C.prototype.isFPS=function(){return this._fps},C.prototype.followsObjects=function(e){return e?t.arraysEqual(this._followedObjects.sort(),e.sort()):this._followedObjects.length>0},C.prototype.setFollowedObjects=function(t,e){(0!==this._followedObjects.length||0!==t.length)&&(this._camera&&!e&&this._camera.orientationConfigurationWillChange(),this._followedObjects=t)},C.prototype.setFollowedObject=function(t,e){(1!==this._followedObjects.length||this._followedObjects[0]!==t)&&this.setFollowedObjects([t],e)},C.prototype.getFollowedObjectsPositionVector=function(){var t,e=[0,0,0];if(0===this._followedObjects.length)n.crash();else{for(t=0;t<this._followedObjects.length;t++)i.add3(e,this._followedObjects[t].getPositionVector());e=[e[0]/this._followedObjects.length,e[1]/this._followedObjects.length,e[2]/this._followedObjects.length]}return e},C.prototype.getFollowedOrientationMatrix=function(){var t;return 0===this._followedObjects.length?n.crash():t=o.matrix4(this._followedObjects[0]._orientationMatrix),t},C.prototype._cleanupFollowedObjects=function(){var t,e,i;for(t=0;t<this._followedObjects.length;t++){for(e=t,i=0;e<this._followedObjects.length&&(!this._followedObjects[e]||this._followedObjects[e].canBeReused()===!0);)e++,i++;if(i>0){if(this._followedObjects.length===i)return this._camera&&this._camera.orientationConfigurationWillChange(),this._pointsTowardsObjects||(this._relativeOrientationMatrix=o.matrix4(this._worldOrientationMatrix),this._fps=!1),this._followedObjects.splice(t,i),!1;this._followedObjects.splice(t,i)}}return!0},C.prototype._calculateWorldOrientationMatrix=function(t,e){var r,s,a,h=function(t){this._worldOrientationMatrix=o.prod34(o.rotation4([1,0,0],-Math.PI/2),this._relativeOrientationMatrix,t)}.bind(this),l=function(){this._fps?this._worldOrientationMatrix=o.prod4(o.rotation4([1,0,0],-Math.PI/2),o.matrix4(this._relativeOrientationMatrix)):this._worldOrientationMatrix=o.matrix4(this._relativeOrientationMatrix)}.bind(this);if(this._followedObjects.length>0)if(this._pointsTowardsObjects)if(t)if(s=i.normal3(i.diff3(this.getFollowedObjectsPositionVector(),o.translationVector3(t))),this._fps){switch(this._baseOrientation){case this.BaseOrientation.WORLD:r=null;break;case this.BaseOrientation.POSITION_FOLLOWED_OBJECTS:r=e||null;break;case this.BaseOrientation.ORIENTATION_FOLLOWED_OBJECT:r=this.followsObjects()?this.getFollowedOrientationMatrix():null;break;default:n.crash()}r?s=i.mulVec3Mat4(s,o.inverseOfRotation4(r)):r=o.IDENTITY4,this._alpha=i.angle2uCapped([0,1],i.normal2([s[0],s[1]])),s[0]<0&&(this._alpha=-this._alpha),this._worldOrientationMatrix=o.prod4(o.rotation4([1,0,0],-Math.PI/2),o.rotation4([0,0,1],this._alpha)),this._beta=i.angle3uCapped(o.getRowC43Neg(this._worldOrientationMatrix),s),s[2]>0&&(this._beta=-this._beta),this._worldOrientationMatrix=o.prod34(o.rotation4([1,0,0],-Math.PI/2),o.rotation4([1,0,0],this._beta),o.rotation4([0,0,1],this._alpha)),o.mul4(this._worldOrientationMatrix,r)}else this._worldOrientationMatrix||(this._worldOrientationMatrix=o.identity4()),this._worldOrientationMatrix[8]=s[0],this._worldOrientationMatrix[9]=s[1],this._worldOrientationMatrix[10]=s[2],a=i.cross3([1,0,0],s),this._worldOrientationMatrix[4]=a[0],this._worldOrientationMatrix[5]=a[1],this._worldOrientationMatrix[6]=a[2],a=i.cross3(s,a),this._worldOrientationMatrix[0]=a[0],this._worldOrientationMatrix[1]=a[1],this._worldOrientationMatrix[2]=a[2],this._worldOrientationMatrix=o.correctedOrthogonal4(this._worldOrientationMatrix);else n.crash();else h(this.getFollowedOrientationMatrix());else if(this._pointsTowardsObjects)switch(this._pointToFallback){case this.PointToFallback.WORLD:l();break;case this.PointToFallback.STATIONARY:this._worldOrientationMatrix||(this._worldOrientationMatrix=o.identity4());break;case this.PointToFallback.POSITION_FOLLOWED_OBJECT_OR_WORLD:e?h(e):l();break;default:n.crash()}else l()},C.prototype.getWorldOrientationMatrix=function(t,e){return this._worldOrientationMatrix||this._calculateWorldOrientationMatrix(t,e),this._worldOrientationMatrix},C.prototype.update=function(t,e){return!this._pointsTowardsObjects||this.followsObjects()||this._pointToFallback!==this.PointToFallback.STATIONARY?(this._fixed||(this._fps?(this._alpha+=t[1]*e/1e3,this._beta+=t[0]*e/1e3,this._alpha>=360&&(this._alpha-=360),this._alpha<=-360&&(this._alpha+=360),this._beta>=360&&(this._beta-=360),this._beta<=-360&&(this._beta+=360),this._alpha=Math.min(Math.max(this._minAlpha,this._alpha),this._maxAlpha),this._beta=Math.min(Math.max(this._minBeta,this._beta),this._maxBeta),this._relativeOrientationMatrix=o.prod4(o.rotation4([1,0,0],this._beta*Math.PI/180),o.rotation4([0,0,1],this._alpha*Math.PI/180))):this._followedObjects.length>0?o.mul4(this._relativeOrientationMatrix,o.prod34(o.rotation4(i.normal3(o.getRowB43(this._relativeOrientationMatrix)),t[2]*Math.PI/180*e/1e3),o.rotation4(i.normal3(o.getRowA43(this._relativeOrientationMatrix)),t[0]*Math.PI/180*e/1e3),o.rotation4(i.normal3(o.getRowC43(this._relativeOrientationMatrix)),t[1]*Math.PI/180*e/1e3))):o.mul4(this._relativeOrientationMatrix,o.prod34(o.rotation4(i.normal3(o.getRowC43(this._relativeOrientationMatrix)),t[2]*Math.PI/180*e/1e3),o.rotation4(i.normal3(o.getRowA43(this._relativeOrientationMatrix)),t[0]*Math.PI/180*e/1e3),o.rotation4(i.normal3(o.getRowB43(this._relativeOrientationMatrix)),t[1]*Math.PI/180*e/1e3)))),this._isTransitionConfiguration||this._cleanupFollowedObjects()?(this._worldOrientationMatrix=null,!0):!1):void 0},B.call(w),w.prototype.copy=function(t,e){var i=new w(t||"",this._positionConfiguration.copy(e),this._orientationConfiguration.copy(e),this._fov,[this._minFOV,this._maxFOV],this._span,[this._minSpan,this._maxSpan]);return i.setPositionMatrix(o.matrix4(this._positionMatrix)),i.setOrientationMatrix(o.matrix4(this._orientationMatrix)),i},w.prototype.setCamera=function(t,e){this._camera=t,this._positionConfiguration.setCamera(t,e),this._orientationConfiguration.setCamera(t),this._camera&&this._shouldAutoReset&&!e&&this.resetToDefaults(!0)},w.prototype.setRelativePositionMatrix=function(t,e){this._positionConfiguration.setRelativePositionMatrix(t,e)},w.prototype.setRelativeOrientationMatrix=function(t,e){this._orientationConfiguration.setRelativeOrientationMatrix(t,e)},w.prototype.getName=function(){return this._name},w.prototype.isFPS=function(){return this._orientationConfiguration.isFPS()},w.prototype.setFOV=function(t,e){this._camera&&!e&&this._camera.configurationWillChange(),this._fov=Math.min(Math.max(t,this._minFOV),this._maxFOV)},w.prototype.getFOV=function(){return this._fov},w.prototype.getMinFOV=function(){return this._minFOV},w.prototype.getMaxFOV=function(){return this._maxFOV},w.prototype.decreaseFOV=function(){return this.setFOV(this._fov*G,!0),this._fov},w.prototype.increaseFOV=function(){return this.setFOV(this._fov*z,!0),this._fov},w.prototype.setSpan=function(t,e){this._camera&&!e&&this._camera.configurationWillChange(),this._span=Math.min(Math.max(t,this._minSpan),this._maxSpan)},w.prototype.getSpan=function(){return this._span},w.prototype.getMinSpan=function(){return this._minSpan},w.prototype.getMaxSpan=function(){return this._maxSpan},w.prototype.decreaseSpan=function(){return this.setSpan(this._span*W,!0),this._span},w.prototype.increaseSpan=function(){return this.setSpan(this._span*q,!0),this._span},w.prototype.shouldAutoReset=function(){return this._shouldAutoReset},w.prototype.resetToDefaults=function(t){this._camera&&!t&&this._camera.configurationWillChange(),this.setFOV(this._defaultFOV,!0),this.setSpan(this._defaultSpan,!0),this._positionConfiguration.resetToDefaults(!0),this._orientationConfiguration.resetToDefaults(!0)},w.prototype.update=function(t,e,i){var o=!0;return o=this._orientationConfiguration.update(e,i),this.setOrientationMatrix(this._orientationConfiguration.getWorldOrientationMatrix(this._positionMatrix,this._positionConfiguration.followsObjects()?this._positionConfiguration.getFollowedObjectOrientationMatrix():null)),o=this._positionConfiguration.update(this._orientationMatrix,this._orientationConfiguration.followsObjects()?this._orientationConfiguration.getFollowedObjectsPositionVector():null,t,i)&&o,this.setPositionMatrix(this._positionConfiguration.getWorldPositionMatrix(this._orientationMatrix)),o},w.prototype.positionFollowsObjects=function(){return this._positionConfiguration.followsObjects()},w.prototype.orientationFollowsObjects=function(){return this._orientationConfiguration.followsObjects()},w.prototype.getFollowedPositionVector=function(){return this._positionConfiguration.getFollowedPositionVector()},w.prototype.setOrientationFollowedObjects=function(t,e){this._orientationConfiguration.setFollowedObjects(t,e)},w.prototype.destroy=function(){this._positionConfiguration=null,this._orientationConfiguration=null,this._camera=null},L.prototype.TransitionStyle={NONE:"none",LINEAR:"linear",SMOOTH:"smooth"},Object.freeze(L.prototype.TransitionStyle),L.prototype.getViewDistance=function(){return this._viewDistance},L.prototype.getNearDistance=function(){return this._near},L.prototype.getCameraPositionMatrix=function(){return this._object3D._positionMatrix},L.prototype.getCameraPositionVector=function(){return this._object3D.getPositionVector()},L.prototype.getCameraOrientationMatrix=function(){return this._object3D._orientationMatrix},L.prototype._setPositionMatrix=function(t){this._object3D.setPositionMatrix(t),this._viewMatrix=null,this._inversePositionMatrix=null},L.prototype._setOrientationMatrix=function(t){this._object3D.setOrientationMatrix(t),this._viewMatrix=null,this._inverseOrientationMatrix=null},L.prototype._rotate=function(t,e){this._object3D.rotate(t,e),this._setOrientationMatrix(this._object3D._orientationMatrix)},L.prototype.moveToPosition=function(t,e,i){e=void 0===e?this._defaultTransitionDuration:e,e>0&&this.transitionToSameConfiguration(e,i),this._currentConfiguration.setRelativePositionMatrix(o.translation4v(t),!0)},L.prototype.getViewMatrix=function(){return this._viewMatrix||(this._viewMatrix=o.prod4(this.getInversePositionMatrix(),this.getInverseOrientationMatrix())),this._viewMatrix},L.prototype.getInversePositionMatrix=function(){return this._inversePositionMatrix||(this._inversePositionMatrix=o.inverseOfTranslation4(this._object3D._positionMatrix)),this._inversePositionMatrix},L.prototype.getInverseOrientationMatrix=function(){return this._inverseOrientationMatrix||(this._inverseOrientationMatrix=o.inverseOfRotation4(this._object3D._orientationMatrix)),this._inverseOrientationMatrix},L.prototype.getConfiguration=function(){return this._currentConfiguration},L.prototype.getVelocityVector=function(){return this._velocityVector},L.prototype.getProjectionMatrix=function(){return this._projectionMatrix||this._updateProjectionMatrix(this._currentConfiguration.getFOV(),this._currentConfiguration.getSpan()),this._projectionMatrix},L.prototype._updateProjectionMatrix=function(t,e){this._near=e/2/Math.tan(Math.radians(t)/2),this._usesVerticalValues?this._projectionMatrix=o.perspective4(e*this._aspect/2,e/2,this._near,this._viewDistance):this._projectionMatrix=o.perspective4(e/2,e/this._aspect/2,this._near,this._viewDistance)},L.prototype.getAspect=function(){return this._aspect},L.prototype.setAspect=function(t){this._aspect=t,this._projectionMatrix=null},L.prototype.getFOV=function(){return this._fov||this._updateFOV(this._getTransitionProgress()),this._fov},L.prototype.setFOV=function(t,e,i){e=void 0===e?this._defaultTransitionDuration:e,e>0?this.transitionToSameConfiguration(e,i):this._fov=t,this._currentConfiguration.setFOV(t,!0),this._projectionMatrix=null},L.prototype.decreaseFOV=function(){this._fov=this._currentConfiguration.decreaseFOV(),this._projectionMatrix=null},L.prototype.increaseFOV=function(){this._fov=this._currentConfiguration.increaseFOV(),this._projectionMatrix=null},L.prototype.getSpan=function(){return this._span||this._updateSpan(this._getTransitionProgress()),this._span},L.prototype.setSpan=function(t,e,i){e=void 0===e?this._defaultTransitionDuration:e,e>0?this.transitionToSameConfiguration(e,i):this._span=t,this._currentConfiguration.setSpan(t,!0),this._projectionMatrix=null},L.prototype.decreaseSpan=function(){this._span=this._currentConfiguration.decreaseSpan(),this._projectionMatrix=null},L.prototype.increaseSpan=function(){this._span=this._currentConfiguration.increaseSpan(),this._projectionMatrix=null},L.prototype.setControlledVelocityVector=function(t){this._controlledVelocityVector=t},L.prototype.setAngularVelocityVector=function(t){this._angularVelocityVector=t},L.prototype._getFreeCameraConfiguration=function(t,e,i){return void 0===t&&(t=this._currentConfiguration.isFPS()),e=e||this.getCameraPositionMatrix(),i=i||this.getCameraOrientationMatrix(),t&&(i=o.prod4(o.rotation4([1,0,0],Math.PI/2),i)),N(t,e,i,this.getFOV(),this._currentConfiguration.getMinFOV(),this._currentConfiguration.getMaxFOV(),this.getSpan(),this._currentConfiguration.getMinSpan(),this._currentConfiguration.getMaxSpan())},L.prototype.setConfiguration=function(t,e){this._currentConfiguration&&this._currentConfiguration.setCamera(null),this._currentConfiguration=t,this._currentConfiguration.setCamera(this,e),this._previousConfiguration=null},L.prototype.startTransitionToConfiguration=function(t,e,i){this._currentConfiguration!==t&&(0===e?this.setConfiguration(t):(this._previousConfiguration&&this._currentConfiguration?this._previousConfiguration=this._getFreeCameraConfiguration(!1):this._previousConfiguration=this._currentConfiguration,this._currentConfiguration&&this._currentConfiguration.setCamera(null),this._currentConfiguration=t,this._currentConfiguration.setCamera(this),this._transitionDuration=void 0===e?this._defaultTransitionDuration:e,this._transitionElapsedTime=0,this._transitionStyle=void 0===i?this._defaultTransitionStyle:i))},L.prototype.transitionToFreeCamera=function(t,e,i,o,n){this._followedNode=null,this.startTransitionToConfiguration(this._getFreeCameraConfiguration(t,e,i),o,n)},L.prototype.setToFreeCamera=function(t,e,i){this.transitionToFreeCamera(t,e,i,0)},L.prototype.transitionToSameConfiguration=function(t,e){var i=this._currentConfiguration;this.setConfiguration(this._previousConfiguration?this._getFreeCameraConfiguration(!1):this._currentConfiguration.copy("",!0),!0),this.startTransitionToConfiguration(i,t,e)},L.prototype.transitionToConfigurationDefaults=function(t,e){this.transitionToSameConfiguration(t,e),this._currentConfiguration.resetToDefaults(!0)},L.prototype.positionConfigurationWillChange=function(){this.transitionToSameConfiguration()},L.prototype.orientationConfigurationWillChange=function(){this.transitionToSameConfiguration()},L.prototype.configurationWillChange=function(){this.transitionToSameConfiguration()},L.prototype.followNode=function(t,e,i,o){var n;return e||this._followedNode!==t?(this._followedNode=t,this._followedNode?(n=this._followedNode.getNextCameraConfiguration(),n?(this.startTransitionToConfiguration(n,i,o),!0):!1):(n=this._scene.getNextCameraConfiguration(),n?(this.startTransitionToConfiguration(n,i,o),!0):!1)):!0},L.prototype.followObject=function(t,e,i,o){return this.followNode(t.getNode(),e,i,o)},L.prototype.changeToNextView=function(t,e){this._followedNode?this.startTransitionToConfiguration(this._followedNode.getNextCameraConfiguration(this._currentConfiguration),t,e):this._scene.getNextCameraConfiguration()&&this.startTransitionToConfiguration(this._scene.getNextCameraConfiguration(this._scene.hasCameraConfiguration(this._currentConfiguration)?this._currentConfiguration:null),t,e)},L.prototype.changeToPreviousView=function(t,e){this._followedNode?this.startTransitionToConfiguration(this._followedNode.getPreviousCameraConfiguration(this._currentConfiguration),t,e):this._scene.getNextCameraConfiguration()&&this.startTransitionToConfiguration(this._scene.getPreviousCameraConfiguration(this._scene.hasCameraConfiguration(this._currentConfiguration)?this._currentConfiguration:null),t,e)},L.prototype.followNextNode=function(t,e,i){var o=this._scene.getNextNode(this._followedNode);if(!(t&&this._followedNode&&o===this._scene.getFirstNode()&&this.followNode(null,!0,e,i))){for(;o!==this._followedNode&&o&&!o.getNextCameraConfiguration();)o=this._scene.getNextNode(o);o&&o.getNextCameraConfiguration()&&this.followNode(o,!0,e,i)}},L.prototype.followPreviousNode=function(t,e,i){var o=this._scene.getFirstNode(),n=this._scene.getPreviousNode(this._followedNode);if(!t||this._followedNode!==o||!this.followNode(null,!0,e,i)){for(;n!==this._followedNode&&n&&!n.getNextCameraConfiguration();){if(n===o&&this.followNode(null,!0,e,i))return;n=this._scene.getPreviousNode(n)}n&&n.getNextCameraConfiguration()&&this.followNode(n,!0,e,i)}},L.prototype.followOrientationOfObjects=function(t,e,i){e=void 0===e?this._defaultTransitionDuration:e,e>0&&this.transitionToSameConfiguration(e,i),this._currentConfiguration.setOrientationFollowedObjects(t,!0)},L.prototype._getTransitionProgress=function(){var t;switch(this._transitionStyle){case this.TransitionStyle.LINEAR:return this._transitionElapsedTime/this._transitionDuration;case this.TransitionStyle.SMOOTH:return t=this._transitionElapsedTime/this._transitionDuration,t=3*t*t-2*t*t*t;default:n.crash()}return-1},L.prototype._updateFOV=function(t){this._fov=this._previousConfiguration?this._previousConfiguration.getFOV()+(this._currentConfiguration.getFOV()-this._previousConfiguration.getFOV())*t:this._currentConfiguration.getFOV();
},L.prototype._updateSpan=function(t){this._span=this._previousConfiguration?this._previousConfiguration.getSpan()+(this._currentConfiguration.getSpan()-this._previousConfiguration.getSpan())*t:this._currentConfiguration.getSpan()},L.prototype.update=function(t){var e,n,r,s,a,h;if(this._extendedCamera=null,this._combinedExtendedCamera=null,this._previousConfiguration){if(!this._currentConfiguration.update([0,0,0],[0,0,0],t))return void this.update(t);if(this._transitionElapsedTime+=t,this._transitionElapsedTime>this._transitionDuration&&(this._transitionElapsedTime=this._transitionDuration),h=this._getTransitionProgress(),!this._previousConfiguration.update([0,0,0],[0,0,0],t))return void this.update(t);e=this._previousConfiguration.getPositionVector(),n=this._currentConfiguration.getPositionVector(),r=this.getCameraPositionVector(),this._setPositionMatrix(o.translation4v(i.sum3(i.scaled3(e,1-h),i.scaled3(n,h)))),this._velocityVector=i.scaled3(i.mulMat4Vec3(this.getCameraOrientationMatrix(),i.diff3(this.getCameraPositionVector(),r)),1e3/t),s=o.prod4(o.inverseOfRotation4(this._previousConfiguration._orientationMatrix),this._currentConfiguration._orientationMatrix),a=o.getRotations(s),this._setOrientationMatrix(o.identity4()),this._rotate(a.gammaAxis,a.gamma*h),this._rotate(a.alphaAxis,a.alpha*h),this._setOrientationMatrix(o.correctedOrthogonal4(o.prod4(this._previousConfiguration._orientationMatrix,this.getCameraOrientationMatrix()))),this._updateFOV(h),this._updateSpan(h),this._updateProjectionMatrix(this._fov,this._span),this._transitionElapsedTime===this._transitionDuration&&(this._previousConfiguration=null)}else{if(!this._currentConfiguration.update(this._controlledVelocityVector,this._angularVelocityVector,t))return void this.update(t);if(!this._currentConfiguration.update([0,0,0],[0,0,0],t))return void this.update(t);r=this.getCameraPositionVector(),this._setPositionMatrix(this._currentConfiguration._positionMatrix),this._setOrientationMatrix(this._currentConfiguration._orientationMatrix),this._currentConfiguration.positionFollowsObjects()?(this._previousFollowedPositionVector?this._velocityVector=i.scaled3(i.mulMat4Vec3(this.getCameraOrientationMatrix(),i.diff3(this._currentConfiguration.getFollowedPositionVector(),this._previousFollowedPositionVector)),1e3/t):this._velocityVector=[0,0,0],this._previousFollowedPositionVector=this._currentConfiguration.getFollowedPositionVector()):this._velocityVector=i.scaled3(i.mulMat4Vec3(this.getCameraOrientationMatrix(),i.diff3(this.getCameraPositionVector(),r)),1e3/t)}},L.prototype.getExtendedCamera=function(t){var e,i;return!t&&this._extendedCamera?this._extendedCamera:t&&this._combinedExtendedCamera?this._combinedExtendedCamera:(0===this._fov&&(this._updateFOV(),this._updateSpan()),e=t?this._span:this._span/this._near*this._viewDistance,i=new L(this._scene,this._aspect,this._usesVerticalValues,this._viewDistance*Lt,N(!1,this._object3D._positionMatrix,this._object3D._orientationMatrix,this._fov,this._fov,this._fov,e,e,e)),i.update(0),t?this._combinedExtendedCamera=i:this._extendedCamera=i,i)},I.prototype.getShadowMapBufferName=function(t){return this._shadowMapBufferNamePrefix+t.toString()},I.prototype.addToContext=function(t,e,i,o,n){var s;if(this._shadowMapBufferNamePrefix=i,e)for(s=0;o>s;s++)t.getFrameBuffer(this.getShadowMapBufferName(s))||t.addFrameBuffer(new r.FrameBuffer(this.getShadowMapBufferName(s),n,n))},I.prototype.reset=function(){this._matrix=null,this._translationVector=null},I.prototype.startShadowMap=function(t,e,n,s,a,h){var l,u={};t.setCurrentFrameBuffer(this.getShadowMapBufferName(n)),l=o.prod34(e.getInversePositionMatrix(),o.translation4v(i.scaled3(o.getRowC43(e.getCameraOrientationMatrix()),h)),this._orientationMatrix),this._matrix=this._matrix||o.prod4(e.getInversePositionMatrix(),this._orientationMatrix),this._translationVector=this._translationVector||i.normal3(i.diff3(o.translationVector3(l),o.translationVector3(this._matrix))),u[r.getUniformName(lt)]=function(){return l},u[r.getUniformName(ut)]=function(){return a},u[r.getUniformName(ct)]=function(){return o.orthographic4(s,s,-a,a)},t.getCurrentShader().assignUniforms(t,u)},I.prototype.getUniformData=function(){return{color:this._color,direction:this._direction,matrix:this._matrix||o.IDENTITY4,translationVector:this._translationVector||i.NULL3}},D.prototype.updateState=function(t){var e,o;if(this._states&&this._states.length>1&&t>0){for(this._timeSinceLastTransition+=t,e=(this._currentStateIndex+1)%this._states.length;this._timeSinceLastTransition>this._states[e].timeToReach;){if(0===e&&!this._looping){e=this._states.length-1,this._timeSinceLastTransition=this._states[e].timeToReach;break}this._timeSinceLastTransition-=this._states[e].timeToReach,e=(e+1)%this._states.length}this._currentStateIndex=0===e?this._states.length-1:e-1,o=this._timeSinceLastTransition/this._states[e].timeToReach,this.setObjectIntensity(this._states[this._currentStateIndex].intensity*(1-o)+this._states[e].intensity*o),this.setColor(i.sum3(i.scaled3(this._states[this._currentStateIndex].color,1-o),i.scaled3(this._states[e].color,o)))}},D.prototype.update=function(t){var e,n;if(this.updateState(t),this._emittingObjects)if(1===this._emittingObjects.length)this._totalIntensity=this._objectIntensity,this._positionVector=i.sum3(this._emittingObjects[0].getPositionVector(),i.mulVec3Mat4(this._relativePositionVector,o.prod4(this._emittingObjects[0].getCascadeScalingMatrix(),this._emittingObjects[0]._orientationMatrix)));else{for(this._positionVector=[0,0,0],n=0,e=0;e<this._emittingObjects.length;e++)this._emittingObjects[e]&&!this._emittingObjects[e].canBeReused()&&(i.add3(this._positionVector,this._emittingObjects[e].getPositionVector()),n++);this._positionVector[0]/=n,this._positionVector[1]/=n,this._positionVector[2]/=n,this._totalIntensity=this._objectIntensity*n}else this._totalIntensity=this._objectIntensity,this._positionVector=this._relativePositionVector},D.prototype.getUniformData=function(){return{color:this._color.concat(this._totalIntensity),position:this._positionVector}},D.prototype.canBeReused=function(){var t;if(!this._emittingObjects)return!1;for(t=0;t<this._emittingObjects.length;t++)if(this._emittingObjects[t]&&!this._emittingObjects[t].canBeReused())return!1;return!0},D.prototype.setColor=function(t){this._color=t},D.prototype.setObjectIntensity=function(t){this._objectIntensity=t},D.prototype.addEmittingObject=function(t){this._emittingObjects.push(t)},D.prototype.shouldBeRendered=function(t){var e=o.prod4(o.translation4v(this._positionVector),t.getViewMatrix());return e[14]<this._totalIntensity},F.prototype=new D,F.prototype.constructor=F,F.prototype.setSpotDirection=function(t){this._relativeSpotDirection=t},F.prototype.setSpotCutoffAngle=function(t){this._spotCutoffCosine=Math.cos(Math.radians(t))},F.prototype.update=function(t){D.prototype.update.call(this,t),this._emittingObjects&&1===this._emittingObjects.length?this._spotDirection=i.mulVec3Mat4(this._relativeSpotDirection,this._emittingObjects[0]._orientationMatrix):this._spotDirection=this._relativeSpotDirection},F.prototype.getUniformData=function(){return{color:this._color.concat(this._totalIntensity),spot:[this._spotDirection[0],this._spotDirection[1],this._spotDirection[2],this._spotCutoffCosine],position:this._positionVector.concat(this._spotFullIntensityCosine)}},V.prototype._setGeneralUniformValueFunctions=function(){this.setUniformValueFunction(dt,function(){return this._directionalLightUniformData.length}),this.setUniformValueFunction(_t,function(){return this._directionalLightUniformData}),this.setUniformValueFunction(gt,function(){return this._pointLightUniformData.length}),this.setUniformValueFunction(ft,function(){return this._pointLightUniformData}),this.setUniformValueFunction(mt,function(){return this._spotLightUniformData.length}),this.setUniformValueFunction(yt,function(){return this._spotLightUniformData}),this.setUniformValueFunction(St,function(){return this._camera.getViewMatrix()}),this.setUniformValueFunction(xt,function(){return this._camera.getInverseOrientationMatrix()}),this.setUniformValueFunction(bt,function(){return this._camera.getAspect()}),this.setUniformValueFunction(ct,function(){return this._camera.getProjectionMatrix()}),this.setUniformValueFunction(Tt,function(){return o.prod4(this._camera.getViewMatrix(),this._camera.getProjectionMatrix())}),this.setUniformValueFunction(Mt,function(){return new Float32Array(this._camera.getCameraPositionVector())}),this.setUniformValueFunction(vt,function(){return this._shadowMappingEnabled})},V.prototype._setShadowMappedShaderUniformValueFunctions=function(t){var e;if(0===t&&(this.setUniformValueFunction(Ot,function(){return this._shadowMapRanges.length}),this.setUniformValueFunction(Et,function(){return new Float32Array(this._shadowMapRanges)}),this.setUniformValueFunction(At,function(){return this._shadowMapDepthRatio}),this.setUniformValueFunction(Rt,function(){return this._shadowMapTextureSize}),this.setUniformValueFunction(wt,function(){return this._shadowMapSampleOffsets})),void 0!==t)this.setContextUniformValueFunction(t,Ct,function(){var e,i,o=[];for(e=0;e<this._directionalLights.length;e++)for(i=0;i<this._shadowMapRanges.length;i++)o.push(this._contexts[t].getFrameBuffer(this._directionalLights[e].getShadowMapBufferName(i)).getLastTextureBindLocation(this._contexts[t].getName()));return new Int32Array(o)});else for(e=0;e<this._contexts.length;e++)this._setShadowMappedShaderUniformValueFunctions(e)},V.prototype._updateStaticLightUniformData=function(){var t;for(this._directionalLightUniformData=[],t=0;t<this._directionalLights.length;t++)this._directionalLightUniformData.push(this._directionalLights[t].getUniformData())},V.prototype._clearDynamicLightUniformData=function(){this._pointLightUniformData=[],this._spotLightUniformData=[]},V.prototype._updateDynamicLightUniformData=function(t){var e,i,o,n;for(this._pointLightUniformData=[],e=0,o=0;e<this._pointLightPriorityArrays.length;e++){for(i=0;i<this._pointLightPriorityArrays[e].length&&o<this._maxRenderedPointLights;i++)this._pointLightPriorityArrays[e][i].update(t),this._pointLightPriorityArrays[e][i].shouldBeRendered(this._camera)&&(this._pointLightUniformData.push(this._pointLightPriorityArrays[e][i].getUniformData()),o++);for(;i<this._pointLightPriorityArrays[e].length;)this._pointLightPriorityArrays[e][i].updateState(t),i++}for(this._spotLightUniformData=[],e=0,n=Math.min(this._spotLights.length,this._maxRenderedSpotLights);n>e;e++)this._spotLights[e].update(t),this._spotLightUniformData.push(this._spotLights[e].getUniformData());for(;e<this._spotLights.length;)this._spotLights[e].updateState(t),e++},V.prototype._getShadowMapBufferNamePrefix=function(t){return at+t+ht},V.prototype._setupContext=function(t){var e;if(void 0!==t)for(this._shadowMappingEnabled&&(this._contexts[t].addShader(this._shadowMappingShader),this._setShadowMappedShaderUniformValueFunctions(t)),e=0;e<this._directionalLights.length;e++)this._directionalLights[e].addToContext(this._contexts[t],this._shadowMappingEnabled,this._getShadowMapBufferNamePrefix(e),this._shadowMapRanges.length,this._shadowMapTextureSize);else for(e=0;e<this._contexts.length;e++)this._setupContext(e)},V.prototype.addToContext=function(t){this._contexts.push(t),this._setupContext(this._contexts.length-1),this._rootBackgroundNode.addToContext(t),this._rootNode.addToContext(t),this._rootUINode.addToContext(t),this._rootResourceNode.addToContext(t)},V.prototype.enableShadowMapping=function(){this._shadowMappingShader&&this._shadowMapRanges.length>0?(this._shadowMappingEnabled=!0,this._setupContext()):n.showError("Cannot enable shadow mapping, as no shadow mapping shader or no shadow mapping ranges were specified")},V.prototype.disableShadowMapping=function(){this._shadowMappingEnabled=!1},V.prototype.toggleShadowMapping=function(){this._shadowMappingEnabled=!this._shadowMappingEnabled,this._shadowMappingEnabled?this.enableShadowMapping():this.disableShadowMapping()},V.prototype.setShadowMapRanges=function(t){this._shadowMapRanges=new Float32Array(t),this._setupContext()},V.prototype.setShadowMapping=function(t){t?(this._shadowMappingEnabled=void 0!==t.enable?t.enable:this._shadowMappingEnabled,this._shadowMappingShader=t.shader||this._shadowMappingShader,this._shadowMapTextureSize=t.textureSize||this._shadowMapTextureSize,this._shadowMapRanges=t.ranges?new Float32Array(t.ranges):this._shadowMapRanges,this._shadowMapDepthRatio=t.depthRatio||this._shadowMapDepthRatio,this._numShadowMapSamples=t.numSamples?e.getNumberValueInRange("shadowMappingParams.numSamples",t.numSamples,this._shadowMappingEnabled?1:0,this._shadowMappingEnabled?Nt.length/2:0,this._shadowMappingEnabled?1:0):t.numSamples,this._shadowMapSampleOffsets=Nt.slice(0,2*this._numShadowMapSamples),t.deferSetup||this._setupContext()):(this._shadowMappingEnabled=!1,this._shadowMappingShader=null,this._shadowMapTextureSize=0,this._shadowMapRanges=[],this._shadowMapDepthRatio=0,this._numShadowMapSamples=0,this._shadowMapSampleOffsets=[])},V.prototype.getCamera=function(){return this._camera},V.prototype.shouldAnimate=function(){return this._shouldAnimate},V.prototype.setShouldAnimate=function(t){this._shouldAnimate=t},V.prototype.shouldUpdateCamera=function(){return this._shouldUpdateCamera},V.prototype.setShouldUpdateCamera=function(t){this._shouldUpdateCamera=t},V.prototype.addBackgroundObject=function(t){var e=new l(t);return this._rootBackgroundNode.addSubnode(e),e},V.prototype.addObject=function(t){var e=new l(t);return this._rootNode.addSubnode(e),e},V.prototype.addNode=function(t){return this._rootNode.addSubnode(t),t},V.prototype.addUIObject=function(t){var e=new l(t);return this._rootUINode.addSubnode(e),e},V.prototype.addObjectToContexts=function(t){var e;for(e=0;e<this._contexts.length;e++)t.addToContext(this._contexts[e])},V.prototype.clearNodes=function(){this._rootBackgroundNode&&this._rootBackgroundNode.destroy(),this._rootBackgroundNode=new l(new c(null,!1,!1)),this._rootBackgroundNode.setScene(this),this._rootNode&&this._rootNode.destroy(),this._rootNode=new l(new c(null,!1,!1)),this._rootNode.setScene(this),this._rootResourceNode&&this._rootResourceNode.destroy(),this._rootResourceNode=new l(new c(null,!1,!1)),this._rootResourceNode.setScene(this),this._rootUINode&&this._rootUINode.destroy(),this._rootUINode=new l(new c(null,!1,!1)),this._rootUINode.setScene(this)},V.prototype.clearPointLights=function(){var t;for(this._pointLightPriorityArrays=new Array(pt),t=0;pt>t;t++)this._pointLightPriorityArrays[t]=[]},V.prototype.getAllObjects=function(){var t,e=[],i=this._rootNode._subnodes;for(t=0;t<i.length;t++)e.push(i[t]._renderableObject);return e},V.prototype.getAll3DObjects=function(){var t,e,i=[],o=this._rootNode._subnodes;for(t=0;t<o.length;t++)e=o[t]._renderableObject,e.getPositionMatrix&&e.getOrientationMatrix&&i.push(e);return i},V.prototype.getFirstNode=function(){return this._rootNode.getFirstSubnode()},V.prototype.getNextNode=function(t){return this._rootNode.getNextSubnode(t)},V.prototype.getPreviousNode=function(t){return this._rootNode.getPreviousSubnode(t)},V.prototype.addResourcesOfObject=function(t){this._rootResourceNode.addSubnode(new l(t))},V.prototype.addDirectionalLightSource=function(t){this._directionalLights.push(t)},V.prototype.addPointLightSource=function(t,e){e=Math.min(e||0,pt-1),this._pointLightPriorityArrays[e].push(t)},V.prototype.addSpotLightSource=function(t){this._spotLights.push(t)},V.prototype.getLODContext=function(){return this._lodContext},V.prototype.getNumberOfDrawnTriangles=function(){return this._numDrawnTriangles},V.prototype.setUniformValueFunction=function(t,e){this._uniformValueFunctions[r.getUniformName(t)]=e.bind(this)},V.prototype.setContextUniformValueFunction=function(t,e,i){this._contextUniformValueFunctions[t]||(this._contextUniformValueFunctions[t]={}),this._contextUniformValueFunctions[t][r.getUniformName(e)]=i.bind(this)},V.prototype.addCameraConfiguration=function(t){this._rootNode.addCameraConfiguration(t)},V.prototype.hasCameraConfiguration=function(t){return this._rootNode.hasCameraConfiguration(t)},V.prototype.getNextCameraConfiguration=function(t){return this._rootNode.getNextCameraConfiguration(t)},V.prototype.getPreviousCameraConfiguration=function(t){return this._rootNode.getPreviousCameraConfiguration(t)},V.prototype.getCameraConfigurationsWithName=function(t){return this._rootNode.getCameraConfigurationsWithName(t)},V.prototype.resizeViewport=function(t,e){this._width=t,this._height=e,this._camera.setAspect(this._width/this._height)},V.prototype.hideUI=function(){this._rootUINode.hide()},V.prototype.showUI=function(){this._rootUINode.show()},V.prototype.assignUniforms=function(t,e){e.assignUniforms(t,this._uniformValueFunctions),e.assignUniforms(t,this._contextUniformValueFunctions[this._contexts.indexOf(t)]),this._uniformsUpdatedForFrame=!0},V.prototype.cleanUp=function(){var t,e,i,o;for(this._rootNode.cleanUp(),o=0;o<this._pointLightPriorityArrays.length;o++)for(t=0;t<this._pointLightPriorityArrays[o].length;t++){for(e=t,i=0;e<this._pointLightPriorityArrays[o].length&&(!this._pointLightPriorityArrays[o][e]||this._pointLightPriorityArrays[o][e].canBeReused()===!0);)e++,i++;this._pointLightPriorityArrays[o].splice(t,i)}for(t=0;t<this._spotLights.length;t++){for(e=t,i=0;e<this._spotLights.length&&(!this._spotLights[e]||this._spotLights[e].canBeReused()===!0);)e++,i++;this._spotLights.splice(t,i)}},V.prototype._renderShadowMap=function(t){var e=t.gl;e.viewport(0,0,this._shadowMapTextureSize,this._shadowMapTextureSize),e.clearColor(0,0,0,0),e.colorMask(!0,!0,!0,!0),e.disable(e.BLEND),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this._rootNode.renderToShadowMap(t,this._width,this._height)},V.prototype._renderShadowMaps=function(t){var e,i;if(this._shadowMappingEnabled){for(n.log("Rendering shadow maps for scene...",4),t.setCurrentShader(this._shadowMappingShader),this.assignUniforms(t,this._shadowMappingShader),e=0;e<this._directionalLights.length;e++)for(this._directionalLights[e].reset(),i=0;i<this._shadowMapRanges.length;i++)this._directionalLights[e].startShadowMap(t,this._camera,i,this._shadowMapRanges[i],this._shadowMapRanges[i]*this._shadowMapDepthRatio,this._shadowMapRanges[i]),this._renderShadowMap(t);for(e=0;e<this._directionalLights.length;e++)for(i=0;i<this._shadowMapRanges.length;i++)t.bindTexture(t.getFrameBuffer(this._directionalLights[e].getShadowMapBufferName(i)),void 0,!0)}t.setCurrentFrameBuffer(null)},V.prototype._renderBackgroundObjects=function(t){var e=t.gl;n.log("Rendering background objects of scene...",4),e.enable(e.BLEND),e.disable(e.DEPTH_TEST),e.depthMask(!1),this._rootBackgroundNode.resetForNewFrame(),this._rootBackgroundNode.render(t,this._width,this._height,!1),this._numDrawnTriangles+=this._rootBackgroundNode.getNumberOfDrawnTriangles()},V.prototype._renderQueue=function(t,e,i,o){var n,r,s,a=e.length;if(a>0)if(r=e[0].getMinimumCountForInstancing(),r>0&&a>=r&&t.instancingExt){for(s=0,e[0].prepareForInstancedRender(t,i,a),n=0;a>n;n++)e[n].render(t,this._width,this._height,o,!0,!0,i)&&s++;s>0&&e[0].renderInstances(t,i,s)}else for(n=0;a>n;n++)e[n].render(t,this._width,this._height,o,!0)},V.prototype._renderMainObjects=function(t,e,i){var o,r;for(r=t.gl,r.enable(r.DEPTH_TEST),n.log("Rendering opaque phase...",4),r.depthMask(!0),r.disable(r.BLEND),o=0;o<e.length;o++)this._renderQueue(t,e[o],o,!0);for(this._numDrawnTriangles+=this._rootNode.getNumberOfDrawnTriangles(!1),n.log("Rendering transparent phase...",4),r.depthMask(!1),r.enable(r.BLEND),o=0;o<i.length;o++)this._renderQueue(t,i[o],o,!1);this._numDrawnTriangles+=this._rootNode.getNumberOfDrawnTriangles(!0)},V.prototype._renderUIObjects=function(t){var e=t.gl;this._rootUINode._subnodes.length>0&&(e.enable(e.BLEND),e.disable(e.DEPTH_TEST),e.depthMask(!1),this._rootUINode.resetForNewFrame(),this._rootUINode.render(t,this._width,this._height,!1),this._numDrawnTriangles+=this._rootUINode.getNumberOfDrawnTriangles())},V.prototype.render=function(t,e){var i,o,r,s=t.gl;n.log("Rendering scene...",3),this._camera.update(this._shouldUpdateCamera?e:0),this._numDrawnTriangles=0,this._rootNode.resetForNewFrame(),this._renderQueues=[[],[],[],[]],this._rootNode.animateAndAddToRenderQueues(this._renderQueues,this._camera,e),r=this._renderQueues[Dt].length>0||this._renderQueues[Ft].length>0,r&&this._renderShadowMaps(t),this._updateStaticLightUniformData(),s.viewport(this._left,this._top,this._width,this._height),this._shouldClearColorOnRender&&(s.colorMask(this._clearColorMask[0],this._clearColorMask[1],this._clearColorMask[2],this._clearColorMask[3]),s.clearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3])),s.depthMask(!0),i=this._shouldClearColorOnRender?s.COLOR_BUFFER_BIT:0,i=this._shouldClearDepthOnRender?i|s.DEPTH_BUFFER_BIT:i,s.clear(i),this._uniformsUpdatedForFrame===!1&&t.getCurrentShader()&&this.assignUniforms(t,t.getCurrentShader()),this._uniformsUpdatedForFrame=!1,this._renderBackgroundObjects(t),(this._renderQueues[Vt].length>0||this._renderQueues[Pt].length>0)&&(o=this._camera,this._camera=this._camera.getExtendedCamera(),this._clearDynamicLightUniformData(),this._renderMainObjects(t,this._renderQueues[Vt],this._renderQueues[Pt]),this._camera=o,s.depthMask(!0),s.clear(s.DEPTH_BUFFER_BIT)),r&&(this._updateDynamicLightUniformData(this._shouldAnimate?e:0),this.assignUniforms(t,t.getCurrentShader()),this._renderMainObjects(t,this._renderQueues[Dt],this._renderQueues[Ft])),o=this._camera,this._camera=this._camera.getExtendedCamera(!0),this._renderUIObjects(t),this._camera=o},{LODContext:s,Scene:V,DirectionalLightSource:I,PointLightSource:D,SpotLightSource:F,RenderableObject:u,RenderableObject3D:c,RenderableNode:l,CubemapSampledFVQ:p,ShadedLODMesh:d,ParameterizedMesh:_,Billboard:g,ParticleState:f,Particle:m,staticParticle:S,dynamicParticle:y,BackgroundBillboard:T,ParticleEmitter:x,OmnidirectionalParticleEmitter:b,UnidirectionalParticleEmitter:M,PlanarParticleEmitter:v,ParticleSystem:O,PointParticle:E,UIElement:A,CameraPositionConfiguration:R,CameraOrientationConfiguration:C,CameraConfiguration:w,Camera:L,getFreeCameraConfiguration:N}}),function(){"use strict";Math.sign=Math.sign||function(t){return t=+t,0===t||isNaN(t)?t:t>0?1:-1},Math.log10=Math.log10||function(t){return Math.log(t)/Math.LN10},Math.seed=function(t){return function(){return t=1e4*Math.sin(t),t-Math.floor(t)}},Math.radians=function(t){return t*Math.PI/180},Math.degrees=function(t){return 180*t/Math.PI},Array.prototype.findIndex=Array.prototype.findIndex||function(t,e){var i;for(i=0;i<this.length;i++)if(t.call(e||t,this[i],i,this))return i;return-1},Array.prototype.find=Array.prototype.find||function(t,e){var i;for(i=0;i<this.length;i++)if(t.call(e||t,this[i],i,this))return this[i]}}(),define("utils/polyfill",function(){}),define("armada/graphics",["utils/types","modules/application","modules/async-resource","modules/managed-gl","modules/graphics-resources","modules/buda-scene","utils/polyfill"],function(t,e,i,o,n,r){"use strict";function s(){i.AsyncResource.call(this),this._dataJSON=null,this._antialiasing=!1,this._filtering=null,this._maxLoadedLOD=0,this._lodContext=null,this._textureQuality=null,this._textureQualities=null,this._textureQualityPreferenceList=null,this._shadowMapping=!1,this._shadowQuality=0,this._shadowRanges=null,this._shadowDistance=0,this._shadowDepthRatio=0,this._maxPointLights=0,this._shaderSettings=null}function a(){return u.isShadowMappingEnabled()&&u.isShadowMappingAvailable()}function h(){return u.getShader(u.getShadowMappingShaderName())}function l(){return a()?{enable:!0,shader:h().getManagedShader(),textureSize:u.getShadowQuality(),ranges:u.getShadowRanges(),depthRatio:u.getShadowDepthRatio(),numSamples:u.getNumShadowMapSamples()}:null}var u,c={LOW:1024,MEDIUM:2048,HIGH:4096},p={OFF:0,MINIMUM:12,FEW:24,MEDIUM:48,MANY:96,MAXIMUM:192},d=!1,_=o.TextureFiltering.BILINEAR,g=["low","medium","high"],f=!1,m=c.MEDIUM,y=[40,125,250,500,1e3,2e3],S=3,T=1.5,x=p.MEDIUM,b={baseType:"object",properties:{NAME:{name:"name",type:"string"},SHADOW_MAPPING_AVAILABLE:{name:"shadows",type:"boolean"},NUM_SHADOW_MAP_SAMPLES:{name:"numShadowMapSamples",type:"number",defaultValue:5},DYNAMIC_LIGHTS_AVAILABLE:{name:"dynamicLights",type:"boolean"},MAX_DIR_LIGHTS:{name:"maxDirLights",type:"number"},MAX_SPOT_LIGHTS:{name:"maxSpotLights",type:"number",defaultValue:7},LUMINOSITY_TEXTURES_AVAILABLE:{name:"luminosityTextures",type:"boolean"},REVEAL_AVAILABLE:{name:"reveal",type:"boolean"}}},M="complexities",v={COMPLEXITIES:{name:M,type:"array",elementType:b,minLength:1},COMPLEXITY:{name:"complexity",type:"string",defaultValue:"medium",check:function(t,e){var i,o=e[M];for(i=0;i<o.length;i++)if(o[i].name===t)return!0;return!1},checkFailMessage:"The specified shader complexity is not one of the specified available complexities."},SHADOW_MAPPING_SHADER_NAME:{name:"shadowMappingShaderName",type:"string",defaultValue:"shadowMapping"},MAX_DIR_LIGHTS_DEFINE_NAME:{name:"maxDirLightsDefineName",type:"string",defaultValue:"MAX_DIR_LIGHTS"},MAX_POINT_LIGHTS_DEFINE_NAME:{name:"maxPointLightsDefineName",type:"string",defaultValue:"MAX_POINT_LIGHTS"},MAX_SPOT_LIGHTS_DEFINE_NAME:{name:"maxSpotLightsDefineName",type:"string",defaultValue:"MAX_SPOT_LIGHTS"},DUST_LENGTH_DIVISOR:{name:"dustLengthDivisor",type:"string",defaultValue:"200.0"},DUST_LENGTH_DIVISOR_DEFINE_NAME:{name:"dustLengthDivisorDefineName",type:"string",defaultValue:"DUST_LENGTH_DIVISOR"},MAX_LUMINOSITY_FACTORS:{name:"maxLuminosityFactors",type:"number",defaultValue:20},MAX_LUMINOSITY_FACTORS_DEFINE_NAME:{name:"maxLuminosityFactorsDefineName",type:"string",defaultValue:"MAX_LUMINOSITY_FACTORS"},MAX_SHADOW_MAP_RANGES_DEFINE_NAME:{name:"maxShadowMapRangesDefineName",type:"string",defaultValue:"MAX_SHADOW_MAP_RANGES"},MAX_SHADOW_MAPS_DEFINE_NAME:{name:"maxShadowMapsDefineName",type:"string",defaultValue:"MAX_SHADOW_MAPS"},NUM_SHADOW_MAP_SAMPLES_DEFINE_NAME:{name:"numShadowMapSamplesDefineName",type:"string",defaultValue:"NUM_SHADOW_MAP_SAMPLES"}},O="withoutShadows",E="withoutDynamicLights";return Object.freeze(c),Object.freeze(p),s.prototype=new i.AsyncResource,s.prototype.constructor=s,s.prototype._updateTextureQualityPreferenceList=function(){var t,e=!1;for(this._textureQualityPreferenceList=[],t=this._textureQualities.length-1;t>=0;t--)this._textureQualities[t]===this._textureQuality&&(e=!0),e&&this._textureQualityPreferenceList.push(this._textureQualities[t]);for(t=this._textureQualities.length-1;t>=0;t--){if(this._textureQualities[t]===this._textureQuality)return;this._textureQualityPreferenceList.push(this._textureQualities[t])}},s.prototype.loadFromJSON=function(i,n){var s,a,h,l;if(n=n||!1,n||(this._dataJSON=i),this._antialiasing=d,this._filtering=_,this._textureQualities=g,this._textureQuality=this._textureQualities[this._textureQualities[this._textureQualities.length-1]],this._updateTextureQualityPreferenceList(),this._shadowMapping=f,this._shadowQuality=m,this._shadowRanges=y,this._shadowDistance=S,this._shadowDepthRatio=T,this._maxPointLights=x,"object"==typeof i.shaders&&(this._shaderSettings=t.getVerifiedObject("shader settings",i.shaders,v)),"object"==typeof i.context&&(this._antialiasing=t.getBooleanValue("antialiasing",i.context.antialiasing),this._filtering=t.getEnumValue("texture filtering",o.TextureFiltering,i.context.filtering,_),i.context.textureQualities&&(i.context.textureQualities instanceof Array?this._textureQualities=i.context.textureQualities:e.showError("Expected texture quality list as an array, instead got "+i.context.textureQualities.constructor.name+"!")),i.context.textureQuality&&(this._textureQuality=t.getEnumValue("texture quality",this._textureQualities,i.context.textureQuality,this._textureQualities[this._textureQualities.length-1])),this._updateTextureQualityPreferenceList(),this._shadowMapping=t.getBooleanValue("shadow mapping",i.context.shadowMapping),this._shadowMapping&&"object"==typeof i.context.shadows&&(this._shadowQuality=t.getEnumValue("shadow quality",c,i.context.shadows.quality,m),this._shadowRanges=i.context.shadows.ranges,this._shadowDistance=t.getNumberValueInRange("shadow distance",i.context.shadows.numRanges,0,this._shadowRanges.length,S),this._shadowDepthRatio=t.getNumberValue("shadow depth ratio",i.context.shadows.depthRatio)),this._maxPointLights=t.getEnumValue("maxPointLights",p,i.context.maxPointLights,x)),this._maxLoadedLOD=i.levelOfDetailSettings.lodLoadProfile.maxLevel,i.levelOfDetailSettings.lodLoadProfile.autoLimitByScreenWidth===!0)for(s=0,a=i.levelOfDetailSettings.lodLoadProfile.limits.length;a>s;s++)h=i.levelOfDetailSettings.lodLoadProfile.limits[s],window.innerWidth<h.screenSizeLessThan&&this._maxLoadedLOD>h.level&&(this._maxLoadedLOD=h.level);for(l=new Array(i.levelOfDetailSettings.lodDisplayProfile.limits.length+1),l[0]=0,s=0,a=i.levelOfDetailSettings.lodDisplayProfile.limits.length;a>s;s++)h=i.levelOfDetailSettings.lodDisplayProfile.limits[s],l[h.level+1]=h.objectSizeLessThan;this._lodContext=new r.LODContext(i.levelOfDetailSettings.lodDisplayProfile.maxLevel,l,i.levelOfDetailSettings.lodDisplayProfile.compensateForObjectSize,i.levelOfDetailSettings.lodDisplayProfile.referenceSize,i.levelOfDetailSettings.lodDisplayProfile.minimumRelativeSize)},s.prototype.loadFromLocalStorage=function(){void 0!==localStorage.interstellarArmada_graphics_antialiasing&&(this._antialiasing="true"===localStorage.interstellarArmada_graphics_antialiasing),void 0!==localStorage.interstellarArmada_graphics_filtering&&this.setFiltering(localStorage.interstellarArmada_graphics_filtering),void 0!==localStorage.interstellarArmada_graphics_textureQuality&&this.setTextureQuality(localStorage.interstellarArmada_graphics_textureQuality),void 0!==localStorage.interstellarArmada_graphics_maxLOD&&this.setMaxLOD(parseInt(localStorage.interstellarArmada_graphics_maxLOD,10)),void 0!==localStorage.interstellarArmada_graphics_shaderComplexity&&this.setShaderComplexity(localStorage.interstellarArmada_graphics_shaderComplexity),void 0!==localStorage.interstellarArmada_graphics_shadowMapping&&(this._shadowMapping="true"===localStorage.interstellarArmada_graphics_shadowMapping),void 0!==localStorage.interstellarArmada_graphics_shadowQuality&&this.setShadowQuality(parseInt(localStorage.interstellarArmada_graphics_shadowQuality,10)),void 0!==localStorage.interstellarArmada_graphics_shadowDistance&&this.setShadowDistance(parseInt(localStorage.interstellarArmada_graphics_shadowDistance,10)),void 0!==localStorage.interstellarArmada_graphics_maxPointLights&&this.setMaxPointLights(parseInt(localStorage.interstellarArmada_graphics_maxPointLights,10)),this.setToReady()},s.prototype.restoreDefaults=function(){this.loadFromJSON(this._dataJSON,!0),localStorage.removeItem("interstellarArmada_graphics_antialiasing"),localStorage.removeItem("interstellarArmada_graphics_filtering"),localStorage.removeItem("interstellarArmada_graphics_textureQuality"),localStorage.removeItem("interstellarArmada_graphics_maxLOD"),localStorage.removeItem("interstellarArmada_graphics_shaderComplexity"),localStorage.removeItem("interstellarArmada_graphics_shadowMapping"),localStorage.removeItem("interstellarArmada_graphics_shadowQuality"),localStorage.removeItem("interstellarArmada_graphics_shadowDistance"),localStorage.removeItem("interstellarArmada_graphics_maxPointLights")},s.prototype.getAntialiasing=function(){return this._antialiasing},s.prototype.setAntialiasing=function(t){this._antialiasing=t,localStorage.interstellarArmada_graphics_antialiasing=this._antialiasing},s.prototype.getFiltering=function(){return this._filtering},s.prototype.setFiltering=function(e){this._filtering=t.getEnumValue("texture filtering",o.TextureFiltering,e,_),localStorage.interstellarArmada_graphics_filtering=this._filtering},s.prototype.getTextureQualities=function(){
return this._textureQualities},s.prototype.getTextureQualityPreferenceList=function(){return this._textureQualityPreferenceList},s.prototype.getTextureQuality=function(){return this._textureQuality},s.prototype.setTextureQuality=function(e){this._textureQuality=t.getEnumValue("texture quality",this._textureQualities,e,this._textureQualities[this._textureQualities.length-1]),localStorage.interstellarArmada_graphics_textureQuality=this._textureQuality,this._updateTextureQualityPreferenceList()},s.prototype.getMaxLoadedLOD=function(){return this._maxLoadedLOD},s.prototype.getLODContext=function(){return this._lodContext},s.prototype.setMaxLOD=function(t){this._maxLoadedLOD=t,this._lodContext.maxEnabledLOD=t,localStorage.interstellarArmada_graphics_maxLOD=this._maxLoadedLOD},s.prototype.getShaderComplexity=function(){return this.getShaderSetting(v.COMPLEXITY)},s.prototype.setShaderComplexity=function(t){this.getShaderComplexities().indexOf(t)>=0?(this.setShaderSetting(v.COMPLEXITY,t),localStorage.interstellarArmada_graphics_shaderComplexity=this.getShaderComplexity()):e.showError("Attempting to set shader complexity to '"+t+"', which is not one of the available options ("+this.getShaderComplexities().join(", ")+").",e.ErrorSeverity.MINOR,"The shader complexity will stay '"+this.getShaderComplexity()+"'.")},s.prototype.getShaderComplexities=function(){return this.getShaderSetting(v.COMPLEXITIES).map(function(t){return t.name})},s.prototype.getShadowMappingShaderName=function(){return this.getShaderSetting(v.SHADOW_MAPPING_SHADER_NAME)},s.prototype.isShadowMappingEnabled=function(){return this._shadowMapping},s.prototype.setShadowMapping=function(t){this._shadowMapping=t,localStorage.interstellarArmada_graphics_shadowMapping=this._shadowMapping},s.prototype.getShadowQuality=function(){return this._shadowQuality},s.prototype.setShadowQuality=function(e){this._shadowQuality=t.getEnumValue("shadow quality",c,e,m),localStorage.interstellarArmada_graphics_shadowQuality=this._shadowQuality},s.prototype.getShadowRanges=function(){var t,e=[];for(t=0;t<this._shadowDistance;t++)e.push(this._shadowRanges[t]);return e},s.prototype.getShadowDistance=function(){return this._shadowDistance},s.prototype.setShadowDistance=function(e){this._shadowDistance=t.getNumberValueInRange("shadow distance",e,0,this._shadowRanges.length,S),localStorage.interstellarArmada_graphics_shadowDistance=this._shadowDistance},s.prototype.getShadowDepthRatio=function(){return this._shadowDepthRatio},s.prototype._getShaderComplexityDescriptor=function(){return this.getShaderSetting(v.COMPLEXITIES).find(function(t){return t.name===this.getShaderSetting(v.COMPLEXITY)},this)},s.prototype.getMaxDirLights=function(){return this._getShaderComplexityDescriptor()[b.properties.MAX_DIR_LIGHTS.name]},s.prototype.getMaxPointLights=function(){return this._maxPointLights},s.prototype.setMaxPointLights=function(e){this._maxPointLights=t.getEnumValue("max dynamic point lights",p,e,x),localStorage.interstellarArmada_graphics_maxPointLights=this._maxPointLights},s.prototype.getMaxSpotLights=function(){return this._getShaderComplexityDescriptor()[b.properties.MAX_SPOT_LIGHTS.name]},s.prototype.getShaderSetting=function(t){return this._shaderSettings[t.name]},s.prototype.setShaderSetting=function(t,e){this._shaderSettings[t.name]=e},s.prototype.getNumShadowMapSamples=function(){return this._getShaderComplexityDescriptor()[b.properties.NUM_SHADOW_MAP_SAMPLES.name]},s.prototype.isShadowMappingAvailable=function(){return this._getShaderComplexityDescriptor()[b.properties.SHADOW_MAPPING_AVAILABLE.name]},s.prototype.areLuminosityTexturesAvailable=function(){return this._getShaderComplexityDescriptor()[b.properties.LUMINOSITY_TEXTURES_AVAILABLE.name]},s.prototype.isRevealAvailable=function(){return this._getShaderComplexityDescriptor()[b.properties.REVEAL_AVAILABLE.name]},s.prototype.areDynamicLightsAvailable=function(){return this._getShaderComplexityDescriptor()[b.properties.DYNAMIC_LIGHTS_AVAILABLE.name]},s.prototype.getShader=function(t){return t=n.getVariantShader(t,this.getShaderComplexity()).getName(),this._shadowMapping||(t=n.getVariantShader(t,O).getName()),this._maxPointLights===p.OFF&&(t=n.getVariantShader(t,E).getName()),n.getShader(t)},s.prototype.getManagedShader=function(t){var e={};return e[this.getShaderSetting(v.MAX_DIR_LIGHTS_DEFINE_NAME)]=this.getMaxDirLights(),e[this.getShaderSetting(v.MAX_POINT_LIGHTS_DEFINE_NAME)]=this.getMaxPointLights(),e[this.getShaderSetting(v.MAX_SPOT_LIGHTS_DEFINE_NAME)]=this.getMaxSpotLights(),e[this.getShaderSetting(v.MAX_SHADOW_MAP_RANGES_DEFINE_NAME)]=this.getShadowDistance(),e[this.getShaderSetting(v.MAX_SHADOW_MAPS_DEFINE_NAME)]=this.getMaxDirLights()*this.getShadowDistance(),e[this.getShaderSetting(v.NUM_SHADOW_MAP_SAMPLES_DEFINE_NAME)]=this.getNumShadowMapSamples(),e[this.getShaderSetting(v.DUST_LENGTH_DIVISOR_DEFINE_NAME)]=this.getShaderSetting(v.DUST_LENGTH_DIVISOR),e[this.getShaderSetting(v.MAX_LUMINOSITY_FACTORS_DEFINE_NAME)]=this.getShaderSetting(v.MAX_LUMINOSITY_FACTORS),this.getShader(t).getManagedShader(e)},s.prototype.getModel=function(t){return n.getModel(t,{maxLOD:this.getMaxLoadedLOD()})},u=new s,{ShadowMapQuality:c,DynamicLightsAmount:p,loadSettingsFromJSON:u.loadFromJSON.bind(u),loadSettingsFromLocalStorage:u.loadFromLocalStorage.bind(u),restoreDefaults:u.restoreDefaults.bind(u),getAntialiasing:u.getAntialiasing.bind(u),setAntialiasing:u.setAntialiasing.bind(u),getFiltering:u.getFiltering.bind(u),setFiltering:u.setFiltering.bind(u),getTextureQualities:u.getTextureQualities.bind(u),getTextureQuality:u.getTextureQuality.bind(u),setTextureQuality:u.setTextureQuality.bind(u),getTextureQualityPreferenceList:u.getTextureQualityPreferenceList.bind(u),setMaxLOD:u.setMaxLOD.bind(u),getMaxLoadedLOD:u.getMaxLoadedLOD.bind(u),getLODContext:u.getLODContext.bind(u),getShaderComplexity:u.getShaderComplexity.bind(u),setShaderComplexity:u.setShaderComplexity.bind(u),getShaderComplexities:u.getShaderComplexities.bind(u),getShadowMappingShaderName:u.getShadowMappingShaderName.bind(u),isShadowMappingEnabled:u.isShadowMappingEnabled.bind(u),setShadowMapping:u.setShadowMapping.bind(u),getShadowQuality:u.getShadowQuality.bind(u),setShadowQuality:u.setShadowQuality.bind(u),getShadowDistance:u.getShadowDistance.bind(u),setShadowDistance:u.setShadowDistance.bind(u),getShadowDepthRatio:u.getShadowDepthRatio.bind(u),getNumShadowMapSamples:u.getNumShadowMapSamples.bind(u),getMaxDirLights:u.getMaxDirLights.bind(u),getMaxPointLights:u.getMaxPointLights.bind(u),setMaxPointLights:u.setMaxPointLights.bind(u),getMaxSpotLights:u.getMaxSpotLights.bind(u),isShadowMappingAvailable:u.isShadowMappingAvailable.bind(u),areLuminosityTexturesAvailable:u.areLuminosityTexturesAvailable.bind(u),isRevealAvailable:u.isRevealAvailable.bind(u),areDynamicLightsAvailable:u.areDynamicLightsAvailable.bind(u),getShader:u.getShader.bind(u),getManagedShader:u.getManagedShader.bind(u),getModel:u.getModel.bind(u),shouldUseShadowMapping:a,getShadowMappingShader:h,getShadowMappingSettings:l,executeWhenReady:u.executeWhenReady.bind(u)}}),define("modules/physics",["utils/vectors","utils/matrices"],function(t,e){"use strict";function i(e,i,o,n){this._id=e,this._strength=i,this._direction=t.normal3(o),this._duration=n,this._continuous=void 0===n}function o(e,i,o,n){this._id=e,this._strength=i,this._axis=t.normal3(o),this._duration=n,this._continuous=void 0===n}function n(t,e,i){this._positionMatrix=t,this._orientationMatrix=e,this._modelMatrixInverse=null,this._width=i[0],this._height=i[1],this._depth=i[2]}function r(t,i,o,n,r,s){this._mass=t,this._positionMatrix=e.matrix4(i),this._orientationMatrix=e.matrix4(o),this._scalingMatrix=e.matrix4(n),this._rotationMatrixInverse=null,this._modelMatrixInverse=null,this._velocityMatrix=e.matrix4(r),this._angularVelocityMatrix=e.identity4(),this._forces=[],this._torques=[],this._bodies=s||[],this._bodySize=-1,this._calculateBodySize()}var s=5,a=1e-4,h=1e-5;return i.prototype.getID=function(){return this._id},i.prototype.renew=function(e,i,o){this._strength=e,this._direction=t.normal3(i),this._duration=o,this._continuous=void 0===o},i.prototype.getExertionDuration=function(t){if(this._continuous)return this._continuous=!1,this._duration=0,t;if(this._duration>.1){var e=Math.min(this._duration,t);return this._duration-=t,e}return 0},i.prototype.getAccelerationVector=function(e){return t.scaled3(this._direction,this._strength/e)},o.prototype.getID=function(){return this._id},o.prototype.renew=function(t,e,i){this._strength=t,this._axis=e,this._duration=i,this._continuous=void 0===i},o.prototype.getExertionDuration=function(t){if(this._continuous)return this._continuous=!1,this._duration=0,t;if(this._duration>.1){var e=Math.min(this._duration,t);return this._duration-=t,e}return 0},o.prototype.getAngularAccelerationMatrixOverTime=function(t,i){return e.rotation4(this._axis,this._strength/t*i)},n.prototype.getPositionMatrix=function(){return this._positionMatrix},n.prototype.getOrientationMatrix=function(){return this._orientationMatrix},n.prototype.getWidth=function(){return this._width},n.prototype.getHeight=function(){return this._height},n.prototype.getDepth=function(){return this._depth},n.prototype.getModelMatrixInverse=function(){return this._modelMatrixInverse=this._modelMatrixInverse||e.prod4(e.inverseOfTranslation4(this._positionMatrix),e.inverseOfRotation4(this._orientationMatrix)),this._modelMatrixInverse},n.prototype.getHalfDimensions=function(){return[.5*this._width,.5*this._height,.5*this._depth]},n.prototype.checkHit=function(e){return e=t.mulVec4Mat4(e,this.getModelMatrixInverse()),e[0]>=.5*-this._width&&e[0]<=.5*this._width&&e[1]>=.5*-this._height&&e[1]<=.5*this._height&&e[2]>=.5*-this._depth&&e[2]<=.5*this._depth},r.prototype.getMass=function(){return this._mass},r.prototype.getPositionMatrix=function(){return this._positionMatrix},r.prototype.getOrientationMatrix=function(){return this._orientationMatrix},r.prototype.getScalingMatrix=function(){return this._scalingMatrix},r.prototype.getVelocityMatrix=function(){return this._velocityMatrix},r.prototype.getAngularVelocityMatrix=function(){return this._angularVelocityMatrix},r.prototype.addForce=function(t){this._forces.push(t)},r.prototype.addTorque=function(t){this._torques.push(t)},r.prototype.setPositionMatrix=function(t){t&&(this._positionMatrix=t),this._modelMatrixInverse=null},r.prototype.setOrientationMatrix=function(t){t&&(this._orientationMatrix=t),this._rotationMatrixInverse=null,this._modelMatrixInverse=null},r.prototype.setScalingMatrix=function(t){this._scalingMatrix=t,this._modelMatrixInverse=null},r.prototype.getRotationMatrixInverse=function(){return this._rotationMatrixInverse=this._rotationMatrixInverse||e.inverseOfRotation4(this._orientationMatrix),this._rotationMatrixInverse},r.prototype.getModelMatrixInverse=function(){return this._modelMatrixInverse=this._modelMatrixInverse||e.prod34(e.inverseOfTranslation4(this._positionMatrix),this.getRotationMatrixInverse(),e.inverseOfScaling4(this._scalingMatrix)),this._modelMatrixInverse},r.prototype.addOrRenewForce=function(t,e,o,n){var r,s=!1;for(r=0;r<this._forces.length;r++)if(this._forces[r].getID()===t){this._forces[r].renew(e,o,n),s=!0;break}s===!1&&this.addForce(new i(t,e,o,n))},r.prototype.addOrRenewTorque=function(t,e,i,n){var r,s=!1;for(r=0;r<this._torques.length;r++)if(this._torques[r].getID()===t){this._torques[r].renew(e,i,n),s=!0;break}s===!1&&this.addTorque(new o(t,e,i,n))},r.prototype.addForceAndTorque=function(e,n,r,s){var a=t.normal3(e),h=t.scaled3(a,t.dot3(n,a)),l=t.diff3(n,h);this.addForce(new i("",r,n,s)),this.addTorque(new o("",r*t.length3(l)*t.length3(e),t.normal3(t.cross3(l,a)),s))},r.prototype._calculateBodySize=function(){var i,o,n;for(this._bodySize=0,i=0;i<this._bodies.length;i++)o=e.translationVector3(this._bodies[i]._positionMatrix),n=t.mulVec3Mat3(this._bodies[i].getHalfDimensions(),e.matrix3from4(e.prod4(this._orientationMatrix,this._bodies[i]._orientationMatrix))),this._bodySize=Math.max(this._bodySize,t.length3(t.sum3(o,n))),this._bodySize=Math.max(this._bodySize,t.length3(t.sum3(o,[n[0],n[1],-n[2]]))),this._bodySize=Math.max(this._bodySize,t.length3(t.sum3(o,[n[0],-n[1],n[2]]))),this._bodySize=Math.max(this._bodySize,t.length3(t.sum3(o,[n[0],-n[1],-n[2]]))),this._bodySize=Math.max(this._bodySize,t.length3(t.sum3(o,[-n[0],n[1],n[2]]))),this._bodySize=Math.max(this._bodySize,t.length3(t.sum3(o,[-n[0],n[1],-n[2]]))),this._bodySize=Math.max(this._bodySize,t.length3(t.sum3(o,[-n[0],-n[1],n[2]]))),this._bodySize=Math.max(this._bodySize,t.length3(t.sum3(o,[-n[0],-n[1],-n[2]])))},r.prototype.checkHit=function(e){var i,o,n=!1;if(e.push(1),i=t.mulVec4Mat4(e,this.getModelMatrixInverse()),Math.abs(i[0])<this._bodySize&&Math.abs(i[1])<this._bodySize&&Math.abs(i[2])<this._bodySize)for(o=0;n===!1&&o<this._bodies.length;o++)n=this._bodies[o].checkHit(i);return n},r.prototype._correctMatrices=function(){e.correctOrthogonal4(this._orientationMatrix),this.setOrientationMatrix(),e.correctOrthogonal4(this._angularVelocityMatrix)},r.prototype.simulate=function(i){var o,n,r,l,u;if(i>0){if(e.translateByVector(this._positionMatrix,t.scaled3(e.translationVector3(this._velocityMatrix),i/1e3)),this.setPositionMatrix(),this._forces.length>0){for(l=e.identity4(),o=0;o<this._forces.length;o++)r=this._forces[o].getExertionDuration(i)/1e3,r>0&&(n=this._forces[o].getAccelerationVector(this._mass),e.translateByVector(this._positionMatrix,t.scaled3(n,.5*r*r)),e.translateByVector(l,t.scaled3(n,r)));e.translateByMatrix(this._velocityMatrix,l)}for(o=0;i>o+s/2;o+=s)e.mul4(this._orientationMatrix,this._angularVelocityMatrix);if(this.setOrientationMatrix(),this._torques.length>0){for(u=e.identity4(),o=0;o<this._torques.length;o++)r=this._torques[o].getExertionDuration(i)/1e3,r>0&&(e.mul4(this._orientationMatrix,this._torques[o].getAngularAccelerationMatrixOverTime(this._mass,.5*r*r)),e.mul4(u,this._torques[o].getAngularAccelerationMatrixOverTime(this._mass,s*r/1e3)));e.mul4(this._angularVelocityMatrix,u)}e.straighten(this._velocityMatrix,a),e.straighten(this._angularVelocityMatrix,h),this._correctMatrices()}},{Body:n,Force:i,Torque:o,PhysicalObject:r,ANGULAR_VELOCITY_MATRIX_DURATION:s,ANGULAR_VELOCITY_MATRIX_DURATION_S:s/1e3,VELOCITY_MATRIX_ERROR_THRESHOLD:a,ANGULAR_VELOCITY_MATRIX_ERROR_THRESHOLD:h}}),define("armada/classes",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/resource-manager","modules/egom-model","modules/physics","modules/graphics-resources","modules/buda-scene","armada/graphics"],function(t,e,i,o,n,r,s,a,h,l){"use strict";function u(t){return Y.getResource(tt,t)}function c(t){return Y.getResource(et,t)}function p(t){return Y.getResource(it,t)}function d(t){return Y.getResource(ot,t)}function _(t){return Y.getResource(nt,t)}function g(t){return Y.getResource(rt,t)}function f(t){return Y.getResource(st,t)}function m(t){return Y.getResource(at,t)}function y(t,e){return Y.getResource(ht,t,{allowNullResult:e})}function S(t){var e,i=[],o=Y.getResourceNames(ht);for(e=0;e<o.length;e++)(!t||y(o[e]).shouldShowInDatabase())&&i.push(y(o[e]));return i}function T(t,e){o.showError("Cannot initialize "+t.constructor.name+" without correctly specifying its property '"+e+"'!",o.ErrorSeverity.SEVERE,"The property was either not specified, or it was specified with a wrong type or an invalid value."+("string"==typeof t._name?"The error happened while initializing '"+t._name+"'":""))}function x(t){n.GenericResource.call(this,t?t.name||T(this,"name"):null),this._source=t?t.source||null:null,t&&(this._source||(this._loadData(t),this.setToReady()))}function b(t){x.call(this,t)}function M(t){b.call(this,t)}function v(t){M.call(this,t)}function O(t){M.call(this,t)}function E(t){O.call(this,t)}function A(t){x.call(this,t)}function R(t){M.call(this,t)}function C(t){O.call(this,t)}function w(t){x.call(this,t)}function N(t){O.call(this,t)}function L(t){this._projectileClass=t?_(t.projectile||T(this,"projectile"))||o.crash():null,this._projectileVelocity=t?t.projectileVelocity||T(this,"projectileVelocity"):0,this._positionVector=t?t.position||T(this,"position"):null}function I(t){O.call(this,t)}function D(t){x.call(this,t)}function F(t){x.call(this,t)}function V(t){this.positionMatrix=t?i.translation4v(t.position||T(this,"position")):null,this.orientationMatrix=t?i.rotation4FromJSON(t.rotations||[]):null,this.maxGrade=t?t.maxGrade||T(this,"maxGrade"):0}function P(t){this.positionVector=t?t.position||T(this,"position"):null,this.positionVector&&this.positionVector.push(1),this.size=t?t.size||1:0,this.uses=t?t.uses||T(this,"uses"):null,this.group=t?"number"==typeof t.groupIndex?t.groupIndex:T(this,"groupIndex"):0}function B(t){this.className=t?t["class"]||T(this,"class"):null}function U(t){this.className=t?t["class"]||T(this,"class"):null}function j(t){var e;if(this._name=t.name||"custom",this._weaponDescriptors=[],t.weapons)for(e=0;e<t.weapons.length;e++)this._weaponDescriptors.push(new B(t.weapons[e]));this._propulsionDescriptor=t.propulsion?new U(t.propulsion):null}function k(e){this._name=e?e.name||T(this,"name"):null,this._fps=e&&"boolean"==typeof e.fps?e.fps:!1,this._fov=e?e.fov||0:0,this._fovRange=e?e.fovRange||null:null,this._movable=e?"boolean"==typeof e.movable?e.movable:T(this,"movable"):!1,this._turnable=e?"boolean"==typeof e.turnable?e.turnable:T(this,"turnable"):!1,this._positionMatrix=e?i.translation4v(e.position||T(this,"position")):null,this._orientationMatrix=e?i.rotation4FromJSON(e.rotations):null,this._alphaRange=e&&this._fps?e.alphaRange||[-360,360]:[0,0],this._betaRange=e&&this._fps?e.betaRange||[-90,90]:[0,0],this._span=e?e.span||0:0,this._spanRange=e?e.spanRange||null:null,this._confines=e?e.confines||null:null,this._resetsWhenLeavingConfines=e&&"boolean"==typeof e.resetsWhenLeavingConfines?e.resetsWhenLeavingConfines:!1,this._baseOrientation=e&&e.baseOrientation?t.getSafeEnumValue(h.CameraOrientationConfiguration.prototype.BaseOrientation,e.baseOrientation)||o.showError("Invalid value '"+e.baseOrientation+"' specified for view baseOrientation!",o.ErrorSeverity.MINOR,"Valid values are: "+t.getEnumValues(h.CameraOrientationConfiguration.prototype.BaseOrientation).join(", ")+"."):null,this._pointToFallback=e&&e.pointToFallback?t.getSafeEnumValue(h.CameraOrientationConfiguration.prototype.PointToFallback,e.pointToFallback)||o.showError("Invalid value '"+e.pointToFallback+"' specified for view pointToFallback!",o.ErrorSeverity.MINOR,"Valid values are: "+t.getEnumValues(h.CameraOrientationConfiguration.prototype.PointToFallback).join(", ")+"."):null}function G(e){k.call(this,e),this._followsPosition="boolean"==typeof e.followsPosition?e.followsPosition:T(this,"followsPosition"),e.lookAt=t.getSafeEnumValue(Z,e.lookAt,Z.NONE),this._followsOrientation="boolean"==typeof e.followsOrientation?e.followsOrientation:e.lookAt===Z.NONE,this._lookAtSelf=e.lookAt===Z.SELF?this._followsPosition||this._followsOrientation||this._turnable?o.showError("Invalid view configuration ('"+this._name+"'): lookAt mode cannot be 'self' if followsPosition, followsOrientation or turnable are true!"):!0:!1,this._lookAtTarget=e.lookAt===Z.TARGET?this._followsOrientation||this._turnable?o.showError("Invalid view configuration ('"+this._name+"'): lookAt mode cannot be 'target' if followsOrientation or turnable are true!"):!0:!1,this._rotationCenterIsObject="boolean"==typeof e.rotationCenterIsObject?e.rotationCenterIsObject?this._lookAtSelf||!this._followsPosition?o.showError("Invalid view configuration ('"+this._name+"'): rotationCenterIsObject with lookAtSelf or without followsPosition!"):!0:!1:this._lookAtSelf||!this._followsPosition?!1:T(this,"rotationCenterIsObject"),this._startsWithRelativePosition=e.startsWithRelativePosition===!0?this._followsPosition||this._rotationCenterIsObject?o.showError("Invalid view configuration ('"+this._name+"'): startsWithRelativePosition cannot be set to true if followsPosition or rotationCenterIsObject are true!"):!0:!1,this._distanceRange=(this._rotationCenterIsObject||this._lookAtSelf||this._lookAtTarget)&&this._movable?e.distanceRange||T(this,"distanceRange"):e.distanceRange||null,this._movesRelativeToObject=e.movesRelativeToObject===!0?!this._rotationCenterIsObject&&this._followsPosition&&this._followsOrientation?!0:o.showError("Invalid view configuration ('"+this._name+"'): movesRelativeToObject can only be set if both position and orientation is followed and rotationCenterIsObject is false!"):!1,this._shouldAutoReset="boolean"==typeof e.shouldAutoReset?e.shouldAutoReset:!1,!this._followsPosition&&!this._startsWithRelativePosition&&(this._lookAtSelf||this._lookAtTarget)&&this._confines&&this._distanceRange&&o.showError("Invalid view configuration ('"+this._name+"'): A lookAt configuration with absolute position cannot have both position and distance confines!",o.ErrorSeverity.SEVERE,"Setting this configuration will likely cause a crash as position confines are absolute (if the position is absolute) but distance confines are relative to the lookAt object."),this._followsPosition||this._startsWithRelativePosition||!this._resetsWhenLeavingConfines||o.showError("Invalid view configuration ('"+this._name+"'): resetsWhenLeavingConfines cannot be set if position is absolute!")}function z(e){k.call(this,e),this._turnAroundAll="boolean"==typeof e.turnAroundAll?e.turnAroundAll:!1,this._lookAtAll=t.getSafeEnumValue($,e.lookAt,$.NONE)===$.ALL?this._turnAroundAll||this._turnable?o.showError("Invalid view configuration ('"+this._name+"'): lookAt mode cannot be 'all' if turnAroundAll or turnable are true!"):!0:!1,this._distanceRange=(this._turnAroundAll||this._lookAtAll)&&this._movable?e.distanceRange||T(this,"distanceRange"):e.distanceRange||null,this._startsWithRelativePosition=e.startsWithRelativePosition===!0?this._turnAroundAll?o.showError("Invalid view configuration ('"+this._name+"'): startsWithRelativePosition cannot be true if the view is set to turn around the objects!"):!0:!1,!this._turnAroundAll&&!this._startsWithRelativePosition&&this._lookAtAll&&this._confines&&this._distanceRange&&o.showError("Invalid view configuration ('"+this._name+"'): A lookAt configuration with absolute position cannot have both position and distance confines!",o.ErrorSeverity.SEVERE,"Setting this configuration will likely cause a crash as position confines are absolute (if the position is absolute) but distance confines are relative to the lookAt object."),this._turnAroundAll||this._startsWithRelativePosition||!this._resetsWhenLeavingConfines||o.showError("Invalid view configuration ('"+this._name+"'): resetsWhenLeavingConfines cannot be set if position is absolute!")}function W(t){this.hullIntegrity=t?t.hullIntegrity||T(this,"hullIntegrity"):0,this.explosionClass=t?d(t["class"]||T(this,"class"))||o.crash():null}function q(t){this.position=t?t.position||T(this,"position"):null,this.color=t?t.color||T(this,"color"):null,this.intensity=t?t.intensity||T(this,"intensity"):0,this.spotDirection=t?t.spotDirection||null:null,this.spotCutoffAngle=t?t.spotCutoffAngle||0:0,this.spotFullIntensityAngle=t?t.spotFullIntensityAngle||0:0}function X(t){this._particle=null,t.particle?(t.particle.name="-",this._particle=new E(t.particle)):T(this,"particle"),this._position=t?t.position||T(this,"position"):null,this._period=t?t.period||T(this,"period"):0,this._blinks=t?t.blinks||T(this,"blinks"):null,this._intensity=t?t.intensity||T(this,"intensity"):0}function H(t){O.call(this,t)}function Q(t,e){var i={};i[tt]=v,i[et]=A,i[it]=R,i[ot]=w,i[nt]=N,i[rt]=I,i[st]=D,i[at]=F,i[ht]=H,Y.requestConfigLoad(t.filename,t.folder,i,function(){Y.requestAllResources(),Y.requestResourceLoad(),e&&e()}),J=t.folder}var Y,J,K={OMNIDIRECTIONAL:"omnidirectional",UNIDIRECTIONAL:"unidirectional",PLANAR:"planar"},Z={NONE:"none",SELF:"self",TARGET:"target"},$={NONE:"none",ALL:"all"},tt="skyboxClasses",et="backgroundObjectClasses",it="dustCloudClasses",ot="explosionClasses",nt="projectileClasses",rt="weaponClasses",st="propulsionClasses",at="spacecraftTypes",ht="spacecraftClasses",lt="fvqModel",ut="squareModel",ct="dust",pt="projectileModel-";return Object.freeze(K),Object.freeze(Z),Object.freeze($),x.prototype=new n.GenericResource,x.prototype.constructor=x,x.prototype.requiresReload=function(){return this.isRequested()?!1:!this.isLoaded()},x.prototype._requestFiles=function(){o.requestTextFile(J,this._source,function(t){this._onFilesLoad(!0,JSON.parse(t))}.bind(this))},x.prototype._loadData=function(){this._source=this._source||""},x.prototype.showResourceAccessError=function(t,e){o.showError("Attempting to access "+t+" ('"+e+"') of class '"+this._name+"' before it has been loaded!")},b.prototype=new x,b.prototype.constructor=b,b.prototype._overrideData=function(t,e){x.prototype._loadData.call(this,e),this._shaderName=t?e&&e.shader?e.shader:t._shaderName:e?e.shader||T(this,"shader"):null,this._shader=null,this._instancedShaderName=null,this._instancedShader=null},b.prototype._loadData=function(t){this._overrideData(null,t)},b.prototype.acquireResources=function(){this._shader=l.getShader(this._shaderName),this._instancedShaderName=a.getShader(this._shaderName).getVariantShaderName("instanced"),this._instancedShaderName&&(this._instancedShader=l.getShader(this._instancedShaderName))},b.prototype.getShader=function(){return null===this._shader?(this.showResourceAccessError("shader",this._shaderName),null):l.getManagedShader(this._shaderName)},b.prototype.getInstancedShader=function(){return null===this._instancedShader?(o.showError("Attempting to access the instanced shader of '"+this._name+"', which does not exist (or is not loaded)!"),null):l.getManagedShader(this._instancedShaderName)},M.prototype=new b,M.prototype.constructor=M,M.prototype._overrideData=function(t,e){b.prototype._overrideData.call(this,t,e),this._modelName=t?e&&e.model?e.model:t._modelName:e?e.model||null:null,this._model=null},M.prototype._loadData=function(t){this._overrideData(null,t)},M.prototype.acquireResources=function(t){b.prototype.acquireResources.call(this),t&&t.model?(this._model=a.getOrAddModel(t.model),this._modelName=this._model.getName()):this._model=l.getModel(this._modelName)},M.prototype.getModel=function(){return null===this._model?(this.showResourceAccessError("model",this._modelName),null):this._model.getEgomModel()},v.prototype=new M,v.prototype.constructor=v,v.prototype._loadData=function(t){M.prototype._loadData.call(this,t),this._cubemapName=t?t.cubemap||T(this,"cubemap"):null,this._cubemap=null},v.prototype.acquireResources=function(){M.prototype.acquireResources.call(this,{model:r.fvqModel(lt)}),null===this._cubemap&&(this._cubemap=a.getCubemap(this._cubemapName))},v.prototype.getCubemap=function(){return null===this._cubemap?(this.showResourceAccessError("cubemap",this._cubemapName),null):this._cubemap.getManagedCubemap()},O.prototype=new M,O.prototype.constructor=O,O.prototype._overrideData=function(t,e){M.prototype._overrideData.call(this,t,e),this._textureName=t?e&&e.texture?e.texture:t._textureName:e?e.texture||T(this,"texture"):null,this._texture=null},O.prototype._loadData=function(t){this._overrideData(null,t)},O.prototype.acquireResources=function(t){M.prototype.acquireResources.call(this,t),null===this._texture&&(this._texture=a.getTexture(this._textureName))},O.prototype.getTexture=function(t,e){return null===this._texture?(this.showResourceAccessError("texture",this._textureName),null):this._texture.getManagedTexture(t,e)},O.prototype.getTexturesOfTypes=function(t,e){return null===this._texture?(this.showResourceAccessError("texture",this._textureName),null):this._texture.getManagedTexturesOfTypes(t,e)},O.prototype.getTextures=function(t){return this.getTexturesOfTypes(this._texture.getTypes(),t)},E.prototype=new O,E.prototype.constructor=E,E.prototype._loadData=function(t){O.prototype._loadData.call(this,t),this._size=t?t.size||1:0,this._color=t?t.color||[1,1,1,1]:null,this._duration=t?t.duration:null},E.prototype.acquireResources=function(){O.prototype.acquireResources.call(this,{model:r.squareModel(ut)})},E.prototype.getSize=function(){return this._size},E.prototype.getColor=function(){return this._color},E.prototype.getDuration=function(){return this._duration},A.prototype=new x,A.prototype.constructor=A,A.prototype._loadData=function(t){var e,i;if(x.prototype._loadData.call(this,t),this._lightColor=t?t.lightColor||[1,1,1]:null,this._layers=[],t)if(t.layers)for(e=0;e<t.layers.length;e++)i=t.layers[e],i.name="-",this._layers.push(new E(i));else T(this,"layers")},A.prototype.acquireResources=function(){var t;for(t=0;t<this._layers.length;t++)this._layers[t].acquireResources()},A.prototype.getLightColor=function(){return this._lightColor},A.prototype.getLayers=function(){return this._layers},R.prototype=new M,R.prototype.constructor=R,R.prototype._loadData=function(t){M.prototype._loadData.call(this,t),this._numberOfParticles=t?t.numberOfParticles||T(this,"numberOfParticles"):0,this._color=t?t.color||[1,1,1]:null,this._range=t?t.range||T(this,"range"):0},R.prototype.acquireResources=function(){M.prototype.acquireResources.call(this,{model:r.lineModel(ct,[1,1,1],[1,1,1,1])})},R.prototype.getNumberOfParticles=function(){return this._numberOfParticles},R.prototype.getColor=function(){return this._color},R.prototype.getRange=function(){return this._range},C.prototype=new O,C.prototype.constructor=C,C.prototype._loadData=function(e){O.prototype._loadData.call(this,e),this._type=e?t.getSafeEnumValue(K,e.type,K.OMNIDIRECTIONAL):null,this._dimensions=e?e.dimensions||[0,0,0]:null,this._directionSpread=!e||this._type!==K.UNIDIRECTIONAL&&this._type!==K.PLANAR?0:e.directionSpread||0,this._velocity=e?e.velocity||0:0,this._velocitySpread=e?e.velocitySpread||0:0,this._initialNumber=e?e.initialNumber||0:0,this._spawnNumber=e?e.spawnNumber||0:0,this._spawnTime=e?e.spawnTime||1:0,this._duration=e?void 0!==e.duration?e.duration:1:0,this._particleStates=e?e.particleStates||[]:null},C.prototype.acquireResources=function(){O.prototype.acquireResources.call(this,{model:r.squareModel(ut)})},C.prototype.getType=function(){return this._type},C.prototype.getDimensions=function(){return this._dimensions},C.prototype.getDirectionSpread=function(){return this._directionSpread},C.prototype.getVelocity=function(){return this._velocity},C.prototype.getVelocitySpread=function(){return this._velocitySpread},C.prototype.getInitialNumber=function(){return this._initialNumber},C.prototype.getSpawnNumber=function(){return this._spawnNumber},C.prototype.getSpawnTime=function(){return this._spawnTime},C.prototype.getDuration=function(){return this._duration},C.prototype.getParticleStates=function(){return this._particleStates},w.prototype=new x,w.prototype.constructor=w,w.prototype._loadData=function(t){var e;if(x.prototype._loadData.call(this,t),this._particleEmitterDescriptors=null,t&&t.particleEmitters)for(this._particleEmitterDescriptors=[],e=0;e<t.particleEmitters.length;e++)t.particleEmitters[e].name="-",this._particleEmitterDescriptors.push(new C(t.particleEmitters[e]));this._lightStates=t?t.lightStates:null},w.prototype.acquireResources=function(){var t;for(t=0;t<this._particleEmitterDescriptors.length;t++)this._particleEmitterDescriptors[t].acquireResources()},w.prototype.getParticleEmitterDescriptors=function(){return this._particleEmitterDescriptors},w.prototype.getLightStates=function(){return this._lightStates},w.prototype.getTotalDuration=function(){var t,e,i,o,n=0;for(t=0;t<this._particleEmitterDescriptors.length;t++){for(i=this._particleEmitterDescriptors[t]._duration,o=this._particleEmitterDescriptors[t].getParticleStates(),e=0;e<o.length;e++)i+=o[e].timeToReach;i>n&&(n=i)}return n},w.prototype.isContinuous=function(){var t;for(t=0;t<this._particleEmitterDescriptors.length;t++)if(0===this._particleEmitterDescriptors[t]._duration)return!0;return!1},N.prototype=new O,N.prototype.constructor=N,N.prototype._loadData=function(t){
O.prototype._loadData.call(this,t),this._damage=t?t.damage||0:0,this._size=t?t.size||1:0,this._intersectionPositions=t?t.intersectionPositions||[]:null,this._mass=t?t.mass||T(this,"mass"):0,this._duration=t?t.duration||T(this,"duration"):0,this._muzzleFlash=null,t&&(t.muzzleFlash?(t.muzzleFlash.name="-",this._muzzleFlash=new E(t.muzzleFlash)):T(this,"muzzleFlash")),this._lightColor=t?t.lightColor||T(this,"lightColor"):null,this._lightIntensity=t?t.lightIntensity||T(this,"lightIntensity"):0,this._explosionClass=t?d(t.explosion||T(this,"explosion"))||o.crash():null},N.prototype.acquireResources=function(){O.prototype.acquireResources.call(this,{model:r.turningBillboardModel(pt+this.getName(),this._intersectionPositions)}),this._muzzleFlash.acquireResources(),this._explosionClass.acquireResources()},N.prototype.getDamage=function(){return this._damage},N.prototype.getSize=function(){return this._size},N.prototype.getMass=function(){return this._mass},N.prototype.getDuration=function(){return this._duration},N.prototype.getMuzzleFlash=function(){return this._muzzleFlash},N.prototype.getLightColor=function(){return this._lightColor},N.prototype.getLightIntensity=function(){return this._lightIntensity},N.prototype.getExplosionClass=function(){return this._explosionClass},L.prototype.getProjectileClass=function(){return this._projectileClass},L.prototype.getForceForDuration=function(t){return this._projectileVelocity*this._projectileClass.getMass()/(t/1e3)},L.prototype.getPositionVector=function(){return this._positionVector},L.prototype.acquireResources=function(){this._projectileClass.acquireResources()},I.prototype=new O,I.prototype.constructor=I,I.prototype._loadData=function(t){var e;if(O.prototype._loadData.call(this,t),this._grade=t?t.grade||T(this,"grade"):0,this._cooldown=t?t.cooldown||T(this,"cooldown"):0,this._barrels=[],t)if(t.barrels)for(e=0;e<t.barrels.length;e++)this._barrels.push(new L(t.barrels[e]));else T(this,"barrels")},I.prototype.acquireResources=function(){var t;for(O.prototype.acquireResources.call(this),t=0;t<this._barrels.length;t++)this._barrels[t].acquireResources()},I.prototype.getGrade=function(){return this._grade},I.prototype.getCooldown=function(){return this._cooldown},I.prototype.getBarrel=function(t){return this._barrels[t]},I.prototype.getBarrels=function(){return this._barrels},D.prototype=new x,D.prototype.constructor=D,D.prototype._loadData=function(t){var e;x.prototype._loadData.call(this,t),e=t?t.referenceMass||1:null,this._thrusterBurnParticle=new E(t),this._grade=t?t.grade||T(this,"grade"):0,this._thrust=t?e*t.thrust||T(this,"thrust"):0,this._angularThrust=t?e*Math.radians(t.angularThrust)||T(this,"angularThrust"):0,this._maxMoveBurnLevel=t?t.maxMoveBurnLevel||T(this,"maxMoveBurnLevel"):0,this._maxTurnBurnLevel=t?t.maxTurnBurnLevel||T(this,"maxTurnBurnLevel"):0},D.prototype.acquireResources=function(){this._thrusterBurnParticle.acquireResources()},D.prototype.getThrusterBurnParticle=function(){return this._thrusterBurnParticle},D.prototype.getGrade=function(){return this._grade},D.prototype.getThrust=function(){return this._thrust},D.prototype.getAngularThrust=function(){return this._angularThrust},D.prototype.getMaxMoveBurnLevel=function(){return this._maxMoveBurnLevel},D.prototype.getMaxTurnBurnLevel=function(){return this._maxTurnBurnLevel},F.prototype=new x,F.prototype.constructor=F,F.prototype._loadData=function(t){x.prototype._loadData.call(this,t),this._fullName=t?t.fullName||T(this,"fullName"):null,this._description=t?"string"==typeof t.description?t.description:T(this,"description"):null,this._goodAgainstTypeNames=t?t.goodAgainst||[]:null,this._badAgainstTypeNames=t?t.badAgainst||[]:null},F.prototype.getFullName=function(){return this._fullName},F.prototype.getDescription=function(){return this._description},F.prototype.getGoodAgainstTypes=function(){var t,e;for(e=[],t=0;t<this._goodAgainstTypeNames.length;t++)e.push(m(this._goodAgainstTypeNames[t]))},F.prototype.getBadAgainstTypes=function(){var t,e;for(e=[],t=0;t<this._badAgainstTypeNames.length;t++)e.push(m(this._badAgainstTypeNames[t]))},j.prototype.getName=function(){return this._name},j.prototype.getWeaponDescriptors=function(){return this._weaponDescriptors},j.prototype.getPropulsionDescriptor=function(){return this._propulsionDescriptor},k.prototype.getName=function(){return this._name},k.prototype.isFPS=function(){return this._fps},k.prototype.getFOV=function(){return this._fov},k.prototype.getFOVRange=function(){return this._fovRange},k.prototype.getSpan=function(){return this._span},k.prototype.getSpanRange=function(){return this._spanRange},k.prototype.isMovable=function(){return this._movable},k.prototype.isTurnable=function(){return this._turnable},k.prototype.getPositionMatrix=function(){return this._positionMatrix},k.prototype.getOrientationMatrix=function(){return this._orientationMatrix},k.prototype.getAlphaRange=function(){return this._alphaRange},k.prototype.getBetaRange=function(){return this._betaRange},k.prototype.getConfines=function(){return this._confines},k.prototype.resetsWhenLeavingConfines=function(){return this._resetsWhenLeavingConfines},k.prototype.getBaseOrientation=function(){return this._baseOrientation},k.prototype.getPointToFallback=function(){return this._pointToFallback},k.prototype.destroy=function(){this._fovRange=null,this._positionMatrix=null,this._orientationMatrix=null,this._alphaRange=null,this._betaRange=null,this._spanRange=null,this._confines=null},G.prototype=new k,G.prototype.constructor=G,G.prototype.turnsAroundObjects=function(){return this._rotationCenterIsObject},G.prototype.movesRelativeToObject=function(){return this._movesRelativeToObject},G.prototype.getPositionFollowedObjectsForObject=function(t){return this._followsPosition||this._startsWithRelativePosition?[t]:[]},G.prototype.startsWithRelativePosition=function(){return this._startsWithRelativePosition},G.prototype.getDistanceRange=function(){return this._distanceRange},G.prototype.pointsTowardsObjects=function(){return this._lookAtSelf||this._lookAtTarget},G.prototype.getOrientationFollowedObjectsForObject=function(t){return this._lookAtSelf||this._followsOrientation?[t]:[]},G.prototype.shouldAutoReset=function(){return this._shouldAutoReset},G.prototype.destroy=function(){k.prototype.destroy.call(this),this._distanceRange=null},z.prototype=new k,z.prototype.constructor=z,z.prototype.turnsAroundObjects=function(){return this._turnAroundAll},z.prototype.movesRelativeToObject=function(){return!1},z.prototype.getPositionFollowedObjectsForScene=function(t){return this._turnAroundAll||this._startsWithRelativePosition?t.getAll3DObjects():[]},z.prototype.startsWithRelativePosition=function(){return this._startsWithRelativePosition},z.prototype.getDistanceRange=function(){return this._distanceRange},z.prototype.pointsTowardsObjects=function(){return this._lookAtAll},z.prototype.getOrientationFollowedObjectsForScene=function(t){return this._lookAtAll?t.getAll3DObjects():[]},z.prototype.shouldAutoReset=function(){return!1},z.prototype.destroy=function(){k.prototype.destroy.call(this),this._distanceRange=null},X.prototype.acquireResources=function(){this._particle.acquireResources()},X.prototype.getParticle=function(){return this._particle},X.prototype.getPosition=function(){return this._position},X.prototype.getBlinks=function(){return this._blinks},X.prototype.getPeriod=function(){return this._period},X.prototype.getIntensity=function(){return this._intensity},X.prototype.getLightColor=function(){return[this._particle.getColor()[0],this._particle.getColor()[1],this._particle.getColor()[2]]},X.prototype.getParticleStates=function(){var t,e=0,i=[];if(this._blinks.length>0)for(this._blinks[0]>0&&(i.push(new h.ParticleState(this._particle.getColor(),0,0)),i.push(new h.ParticleState(this._particle.getColor(),0,this._blinks[0]))),t=0;t<this._blinks.length;t++)i.push(new h.ParticleState(this._particle.getColor(),this._particle.getSize(),0)),i.push(new h.ParticleState(this._particle.getColor(),0,this._particle._duration)),e=this._blinks[t]+this._particle._duration,i.push(new h.ParticleState(this._particle.getColor(),0,t<this._blinks.length-1?this._blinks[t+1]-e:this._period-e));return i},X.prototype.getLightStates=function(){var t,e=0,i=[];if(this._blinks.length>0)for(this._blinks[0]>0&&(i.push({color:this.getLightColor(),intensity:0,timeToReach:0}),i.push({color:this.getLightColor(),intensity:0,timeToReach:this._blinks[0]})),t=0;t<this._blinks.length;t++)i.push({color:this.getLightColor(),intensity:this._intensity,timeToReach:0}),i.push({color:this.getLightColor(),intensity:0,timeToReach:this._particle._duration}),e=this._blinks[t]+this._particle._duration,i.push({color:this.getLightColor(),intensity:0,timeToReach:t<this._blinks.length-1?this._blinks[t+1]-e:this._period-e});return i},H.prototype=new O,H.prototype.constructor=H,H.prototype._overrideData=function(t,o){var n,r,a,h,l,u,c,p,_,g,f;if(O.prototype._overrideData.call(this,t,o),this._spacecraftType=t?o.type?m(o.type):t._spacecraftType:m(o.type||T(this,"type")),this._fullName=t?o.fullName||t._fullName:o.fullName||T(this,"fullName"),this._description=t?o.description||t._description:o.description||T(this,"description"),this._showInDatabase=t?"boolean"==typeof o.showInDatabase?o.showInDatabase:t._showInDatabase:o.showInDatabase||T(this,"showInDatabase"),this._hitpoints=t?o.hitpoints||t._hitpoints:o.hitpoints||T(this,"hitpoints"),this._mass=t?o.mass||t._mass:o.mass||T(this,"mass"),this._bodies=t&&!o.bodies?t._bodies:[],o.bodies)for(n=0;n<o.bodies.length;n++)this._bodies.push(new s.Body(i.translation4v(o.bodies[n].position||T(this,"bodies[i].position")),i.rotation4FromJSON(o.bodies[n].rotations),o.bodies[n].size));else t||T(this,"bodies");if(this._groupZeroLuminosity=o.groupZeroLuminosity||0,this._weaponSlots=t&&!o.weaponSlots?t._weaponSlots:[],o.weaponSlots)for(n=0;n<o.weaponSlots.length;n++)if(o.weaponSlots[n].array)for(a=o.weaponSlots[n].startPosition||T(this,"weaponSlot array startPosition"),h=o.weaponSlots[n].translationVector||T(this,"weaponSlot array translationVector"),l=o.weaponSlots[n].rotations,u=o.weaponSlots[n].maxGrade||T(this,"weaponSlot array maxGrade"),c=o.weaponSlots[n].count||T(this,"weaponSlot array count"),r=0;c>r;r++)this._weaponSlots.push(new V({position:e.sum3(a,e.scaled3(h,r)),rotations:l,maxGrade:u}));else this._weaponSlots.push(new V(o.weaponSlots[n]));if(this._maxPropulsionGrade=t?o.maxPropulsionGrade||t._maxPropulsionGrade:o.maxPropulsionGrade||T(this,"maxPropulsionGrade"),this._thrusterSlots=t&&!o.thrusterSlots?t._thrusterSlots:[],o.thrusterSlots)for(n=0;n<o.thrusterSlots.length;n++){if(p=o.thrusterSlots[n].group,_=o.thrusterSlots[n].uses,o.thrusterSlots[n].array)for(a=o.thrusterSlots[n].startPosition||T(this,"thrusterSlot array startPosition"),h=o.thrusterSlots[n].translationVector||T(this,"thrusterSlot array translationVector"),g=o.thrusterSlots[n].size||T(this,"thrusterSlot array size"),c=o.thrusterSlots[n].count||T(this,"thrusterSlot array count"),r=0;c>r;r++)this._thrusterSlots.push(new P({position:e.sum3(a,e.scaled3(h,r)),size:g,groupIndex:p,uses:_}));if(o.thrusterSlots[n].thrusters)for(r=0;r<o.thrusterSlots[n].thrusters.length;r++)f=o.thrusterSlots[n].thrusters[r],f.groupIndex=p,f.uses=_,this._thrusterSlots.push(new P(f))}if(this._views=t&&!o.views?t._views:[],o.views)for(n=0;n<o.views.length;n++)this._views.push(new G(o.views[n]));else t||T(this,"views");if(this._equipmentProfiles=t&&!o.equipmentProfiles?t._equipmentProfiles:{},o.equipmentProfiles)for(n=0;n<o.equipmentProfiles.length;n++)this._equipmentProfiles[o.equipmentProfiles[n].name]=new j(o.equipmentProfiles[n]);if(this._explosionClass=t?o.explosion?d(o.explosion):t._explosionClass:d(o.explosion||T(this,"explosion")),this._showTimeRatioDuringExplosion=t?o.showTimeRatioDuringExplosion||t._showTimeRatioDuringExplosion:o.showTimeRatioDuringExplosion||T(this,"showTimeRatioDuringExplosion"),this._damageIndicators=t&&!o.damageIndicators?t._damageIndicators:[],o.damageIndicators)for(n=0;n<o.damageIndicators.length;n++)this._damageIndicators.push(new W(o.damageIndicators[n]));else t||T(this,"damageIndicators");if(this._lightSources=t&&!o.lights?t._lightSources:[],o.lights)for(n=0;n<o.lights.length;n++)this._lightSources.push(new q(o.lights[n]));else t||T(this,"lights");if(this._blinkers=t&&!o.blinkers?t._blinkers:[],o.blinkers)for(n=0;n<o.blinkers.length;n++)this._blinkers.push(new X(o.blinkers[n]));else t||T(this,"blinkers")},H.prototype._loadData=function(t){var e;t.basedOn?(e=y(t.basedOn),e.executeWhenReady(function(){this._overrideData(e,t)}.bind(this))):this._overrideData(null,t)},H.prototype.getSpacecraftType=function(){return this._spacecraftType},H.prototype.getFullName=function(){return this._fullName},H.prototype.getDescription=function(){return this._description},H.prototype.shouldShowInDatabase=function(){return this._showInDatabase},H.prototype.getHitpoints=function(){return this._hitpoints},H.prototype.getMass=function(){return this._mass},H.prototype.getBodies=function(){return this._bodies},H.prototype.getGroupZeroLuminosity=function(){return this._groupZeroLuminosity},H.prototype.getWeaponSlots=function(){return this._weaponSlots},H.prototype.getThrusterSlots=function(){return this._thrusterSlots},H.prototype.getEquipmentProfile=function(t){return this._equipmentProfiles[t]},H.prototype.getViews=function(){return this._views},H.prototype.getExplosionClass=function(){return this._explosionClass},H.prototype.getShowTimeRatioDuringExplosion=function(){return this._showTimeRatioDuringExplosion},H.prototype.getDamageIndicators=function(){return this._damageIndicators},H.prototype.getLightSources=function(){return this._lightSources},H.prototype.getBlinkers=function(){return this._blinkers},H.prototype.acquireResources=function(){var t;for(O.prototype.acquireResources.call(this),this._explosionClass.acquireResources(),t=0;t<this._damageIndicators.length;t++)this._damageIndicators[t].explosionClass.acquireResources();for(t=0;t<this._blinkers.length;t++)this._blinkers[t].acquireResources()},Y=new n.ResourceManager,{ParticleEmitterType:K,TexturedModelClass:O,getSkyboxClass:u,getBackgroundObjectClass:c,getDustCloudClass:p,getExplosionClass:d,getProjectileClass:_,getWeaponClass:g,getPropulsionClass:f,getSpacecraftType:m,getSpacecraftClass:y,getSpacecraftClassesInArray:S,EquipmentProfile:j,SceneView:z,requestLoad:Q}}),define("armada/logic",["utils/types","utils/vectors","utils/matrices","modules/application","modules/async-resource","modules/egom-model","modules/physics","modules/graphics-resources","modules/buda-scene","armada/graphics","armada/classes","utils/polyfill"],function(t,e,i,o,n,r,s,a,h,l,u){"use strict";function c(t){this._class=t}function p(t,e,i){this._class=t,this._direction=[Math.cos(Math.radians(e))*Math.cos(Math.radians(i)),Math.sin(Math.radians(e))*Math.cos(Math.radians(i)),Math.sin(Math.radians(i))]}function d(t,e){this._positionVector=e,this._visualModel=null,this._cloud=t,this._range=t.getRange()}function _(t){this._class=t,this._particles=null,this._visualModel=null}function g(t){this._skyboxes=null,this._backgroundObjects=null,this._dustClouds=null,this._camera=null,void 0!==t&&this.loadFromJSON(t)}function f(){n.AsyncResource.call(this),this._environments=null,this._configuration=null,this._settings=null}function m(t,e,i,o,n){this._class=t,this._positionMatrix=e,this._orientationMatrix=i,this._direction=o,this._carriesParticles=n===!0,this._visualModel=null}function y(t,e,o,n,r){this._class=t,this._visualModel=null,this._physicalModel=new s.PhysicalObject(t.getMass(),e||i.identity4(),o||i.identity4(),i.scaling4(t.getSize()),n?n.getVelocityMatrix():i.null4(),[]),this._timeLeft=t._duration,this._origin=n,r&&this._physicalModel.addForce(r)}function S(t,e,i){this._class=t,this._spacecraft=e,this._slot=i,this._cooldown=0,this._visualModel=null}function T(t,e){this._propulsionClass=t,this._slot=e,this._visualModel=null,this._shipModel=null,this._burnLevel=0,this._maxMoveBurnLevel=this._propulsionClass.getMaxMoveBurnLevel()}function x(t,e){this._class=t,this._drivenPhysicalObject=e,this._thrusterUses={forward:{burn:0,thrusters:[]},reverse:{burn:0,thrusters:[]},strafeLeft:{burn:0,thrusters:[]},strafeRight:{burn:0,thrusters:[]},raise:{burn:0,thrusters:[]},lower:{burn:0,thrusters:[]},yawLeft:{burn:0,thrusters:[]},yawRight:{burn:0,thrusters:[]},pitchUp:{burn:0,thrusters:[]},pitchDown:{burn:0,thrusters:[]},rollLeft:{burn:0,thrusters:[]},rollRight:{burn:0,thrusters:[]}}}function b(t){this._spacecraft=t,this._compensated=!0,this._restricted=!1,this._yawTarget=0,this._pitchTarget=0,this._rollTarget=0,this._speedTarget=0,this._strafeTarget=0,this._liftTarget=0,this._speedIncrementPerSecond=0,this._speedIncrement=0,this._turningLimit=0,this._maxMoveBurnLevel=0,this._maxTurnBurnLevel=0,this.updateForNewPropulsion()}function M(t,e,i,o,n,r){this._class=null,this._hitpoints=0,this._visualModel=null,this._physicalModel=null,this._weapons=null,this._propulsion=null,this._maneuveringComputer=null,this._hitbox=null,this._projectileArray=null,this._alive=!0,this._timeElapsedSinceDestruction=-1,this._activeDamageIndicators=[],this._spacecraftArray=null,this._target=null,this._autoTarget=!1,t&&this._init(t,e,i,o,n,r)}function v(){this._environment=null,this._ownsEnvironment=!1,this._views=null,this._spacecrafts=null,this._projectiles=null,this._pilotedCraft=null,this._hitObjects=null}var O,E,A,R,C,w,N={NEVER:"never",HIT_AND_NO_TARGET:"hitAndNoTarget",HIT_AND_AUTO_TARGET:"hitAndAutoTarget",ALWAYS_WHEN_HIT:"alwaysWhenHit"},L={FREE:"free",COMPENSATED:"compensated",RESTRICTED:"restricted"},I={},D="-body-",F=0,V=1,P=2,B=3;return I.VECTOR3={baseType:"array",length:3,elementType:"number"},I.COLOR3={baseType:"array",length:3,elementType:"number",elementTypeParams:{range:[0,1]}},I.COLOR4={baseType:"array",length:4,elementType:"number",elementTypeParams:{range:[0,1]}},I.DURATION={baseType:"number",range:[0,void 0]},I.FILE_DESCRIPTOR={baseType:"object",properties:{FILENAME:{name:"filename",type:"string"},FOLDER:{name:"folder",type:"string"}}},I.ANGLE_DEGREES={baseType:"number",range:[-360,360]},I.LIGHT_SOURCE={baseType:"object",properties:{COLOR:{name:"color",type:I.COLOR3},DIRECTION:{name:"direction",type:I.VECTOR3}}},O={CLASSES_SOURCE_FILE:{name:"classes",type:I.FILE_DESCRIPTOR},ENVIRONMENTS_SOURCE_FILE:{name:"environments",type:I.FILE_DESCRIPTOR},LEVEL_FILES:{name:"levels",type:{baseType:"object",properties:{FOLDER:{name:"folder",type:"string"},FILENAMES:{name:"filenames",type:"array",elementType:"string"}}}}},E={USE_REQUEST_ANIM_FRAME:{name:"useRequestAnimFrame",type:"boolean",defaultValue:!0},DEFAULT_RANDOM_SEED:{name:"defaultRandomSeed",type:"number",defaultValue:4718},UNIFORM_LUMINOSITY_FACTORS_ARRAY_NAME:{name:"luminosityFactorsArrayName",type:"string",defaultValue:"luminosityFactors"},USE_VERTICAL_CAMERA_VALUES:{name:"useVerticalCameraValues",type:"boolean",defaultValue:!0}},A={SHOW_LOADING_BOX_FIRST_TIME:{name:"showLoadingBoxFirstTime",type:"boolean",defaultValue:!0},SHOW_LOADING_BOX_ON_ITEM_CHANGE:{name:"showLoadingBoxOnItemChange",type:"boolean",defaultValue:!0},BACKGROUND_COLOR:{name:"backgroundColor",type:I.COLOR4,defaultValue:[0,0,0,0]},ITEM_VIEW_DISTANCE:{name:"itemViewDistance",type:"number",defaultValue:2e3},ITEM_VIEW_FOV:{name:"itemViewFOV",type:"number",defaultValue:60},ITEM_VIEW_SPAN:{name:"itemViewSpan",type:"number",defaultValue:.2},SHOW_WIREFRAME_MODEL:{name:"showWireframeModel",type:"boolean",defaultValue:!0},WIREFRAME_SHADER_NAME:{name:"wireframeShaderName",type:"string",defaultValue:"oneColorReveal"},WIREFRAME_COLOR:{name:"wireframeColor",type:I.COLOR4,defaultValue:[1,0,0,1]},SHOW_SOLID_MODEL:{name:"showSolidModel",type:"boolean",defaultValue:!0},SOLID_SHADER_NAME:{name:"solidShaderName",type:"string",defaultValue:"shadowMapReveal"},LIGHT_SOURCES:{name:"lightSources",type:"array",elementType:I.LIGHT_SOURCE,minLength:1,maxLength:2},EQUIPMENT_PROFILE_NAME:{name:"equipmentProfileName",type:"string",defaultValue:"default"},START_SIZE_FACTOR:{name:"startSizeFactor",type:"number",defaultValue:"1"},MIN_SIZE_FACTOR:{name:"minimumSizeFactor",type:"number",defaultValue:"0.9"},MAX_SIZE_FACTOR:{name:"maximumSizeFactor",type:"number",defaultValue:"1.6"},MODEL_AUTO_ROTATION:{name:"modelAutoRotation",type:"boolean",defaultValue:!0},MODEL_MOUSE_ROTATION:{name:"modelMouseRotation",type:"boolean",defaultValue:!0},ROTATION_FPS:{name:"rotationFPS",type:"number",defaultValue:60},ROTATION_REVEAL_START_ANGLE:{name:"rotationRevealStartAngle",type:I.ANGLE_DEGREES,defaultValue:90},ROTATION_START_ANGLE:{name:"rotationStartAngle",type:I.ANGLE_DEGREES,defaultValue:180},ROTATION_VIEW_ANGLE:{name:"rotationViewAngle",type:I.ANGLE_DEGREES,defaultValue:60},ROTATION_DURATION:{name:"rotationDuration",type:"number",defaultValue:4e3},ROTATION_MOUSE_SENSITIVITY:{name:"rotationMouseSensitivity",type:"number",defaultValue:1},MODEL_REVEAL_ANIMATION:{name:"modelRevealAnimation",type:"boolean",defaultValue:!0},REVEAL_COLOR:{name:"revealColor",type:I.COLOR4,defaultValue:[1,1,1,1]},REVEAL_FPS:{name:"revealFPS",type:"number",defaultValue:60},REVEAL_DURATION:{name:"revealDuration",type:I.DURATION,defaultValue:2e3},REVEAL_SOLID_DELAY_DURATION:{name:"revealSolidDelayDuration",type:I.DURATION,defaultValue:2e3},REVEAL_TRANSITION_LENGTH_FACTOR:{name:"revealTransitionLengthFactor",type:"number",defaultValue:.15},RENDER_FPS:{name:"databaseRenderFPS",type:"number",defaultValue:60}},R={RENDER_FPS:{name:"battleRenderFPS",type:"number",defaultValue:60},SIMULATION_STEPS_PER_SECOND:{name:"simulationStepsPerSecond",type:"number",defaultValue:60},MINIMUM_DUST_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumDustParticleCountForInstancing",type:"number",defaultValue:1},MINIMUM_EXPLOSION_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumExplosionParticleCountForInstancing",type:"number",defaultValue:1},MINIMUM_MUZZLE_FLASH_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumMuzzleFlashParticleCountForInstancing",type:"number",defaultValue:1},MINIMUM_THRUSTER_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumThrusterParticleCountForInstancing",type:"number",defaultValue:1},MINIMUM_BLINKER_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumBlinkerParticleCountForInstancing",type:"number",defaultValue:1},VIEW_DISTANCE:{name:"viewDistance",type:"number",defaultValue:5e3},CAMERA_DEFAULT_TRANSITION_DURATION:{name:"cameraDefaultTransitionDuration",type:"number",defaultValue:1e3},CAMERA_DEFAULT_TRANSITION_STYLE:{name:"cameraDefaultTransitionStyle",type:"enum",values:h.Camera.prototype.TransitionStyle,defaultValue:h.Camera.prototype.TransitionStyle.SMOOTH},CAMERA_PILOTING_SWITCH_TRANSITION_DURATION:{name:"cameraPilotingSwitchTransitionDuration",type:"number",defaultValue:1e3},CAMERA_PILOTING_SWITCH_TRANSITION_STYLE:{name:"cameraPilotingSwitchTransitionStyle",type:"enum",values:h.Camera.prototype.TransitionStyle,defaultValue:h.Camera.prototype.TransitionStyle.SMOOTH},MOMENT_DURATION:{name:"momentDuration",type:I.DURATION,defaultValue:1},BACKGROUND_OBJECT_DISTANCE:{name:"backgroundObjectDistance",type:"number",defaultValue:4500},TURN_ACCELERATION_DURATION_S:{name:"turnAccelerationDurationInSeconds",type:I.DURATION,defaultValue:.5},DEFAULT_MUZZLE_FLASH_DURATION:{name:"defaultMuzzleFlashDuration",type:I.DURATION,defaultValue:500},SELF_FIRE:{name:"selfFire",type:"boolean",defaultValue:!0},AUTO_TARGETING:{name:"autoTargeting",type:"enum",values:N,defaultValue:N.HIT_AND_AUTO_TARGET},DEFAULT_EQUIPMENT_PROFILE_NAME:{name:"defaultEquipmentProfileName",type:"string",defaultValue:"default"},HITBOX_COLOR:{name:"hitboxColor",type:I.COLOR4,defaultValue:[0,.5,.5,.5]},HITBOX_TEXTURE_NAME:{name:"hitboxTexture",type:"string",defaultValue:"white"},HITBOX_SHADER_NAME:{name:"hitboxShader",type:"string",defaultValue:"lambert-with-luminosity"},RANDOM_SHIPS:{name:"randomShips",type:"object",defaultValue:{}},RANDOM_SHIPS_MAP_SIZE:{name:"randomShipsMapSize",type:"number",defaultValue:3e3},RANDOM_SHIPS_HEADING_ANGLE:{name:"randomShipsHeadingAngle",type:I.ANGLE_DEGREES,defaultValue:0},RANDOM_SHIPS_RANDOM_HEADING:{name:"randomShipsRandomHeading",type:"boolean",defaultValue:!0},RANDOM_SHIPS_EQUIPMENT_PROFILE_NAME:{name:"randomShipsEquipmentProfileName",type:"string",defaultValue:"default"},TARGET_VIEW_NAME:{name:"targetViewName",type:"string",defaultValue:"target"},TARGET_CHANGE_TRANSITION_DURATION:{name:"targetChangeTransitonDuration",type:I.DURATION,defaultValue:300},TARGET_CHANGE_TRANSITION_STYLE:{name:"targetChangeTransitionStyle",type:"enum",values:h.Camera.prototype.TransitionStyle,defaultValue:h.Camera.prototype.TransitionStyle.SMOOTH},HUD_CENTER_CROSSHAIR_TEXTURE:{name:"hudCenterCrosshairTexture",type:"string",defaultValue:"crosshair"},HUD_CENTER_CROSSHAIR_SIZE:{name:"hudCenterCrosshairSize",type:"array",elementType:"number",length:2,defaultValue:[.05,.05]},HUD_CENTER_CROSSHAIR_COLOR:{name:"hudCenterCrosshairColor",type:I.COLOR4,defaultValue:[0,1,0,.25]},HUD_TARGET_ARROW_TEXTURE:{name:"hudTargetArrowTexture",type:"string",defaultValue:"arrow"},HUD_TARGET_ARROW_SIZE:{name:"hudTargetArrowSize",type:"array",elementType:"number",length:2,defaultValue:[.075,.075]},HUD_TARGET_ARROW_COLOR:{name:"hudTargetArrowColor",type:I.COLOR4,defaultValue:[1,0,0,.75]},HUD_TARGET_INDICATOR_TEXTURE:{name:"hudTargetIndicatorTexture",type:"string",defaultValue:"target"},HUD_TARGET_INDICATOR_SIZE:{name:"hudTargetIndicatorSize",type:"array",elementType:"number",length:2,defaultValue:[.1,.1]},HUD_TARGET_INDICATOR_COLOR:{name:"hudTargetIndicatorColor",type:I.COLOR4,defaultValue:[1,0,0,.75]},HUD_TARGET_CROSSHAIR_TEXTURE:{name:"hudTargetCrosshairTexture",type:"string",defaultValue:"crosshair"},HUD_TARGET_CROSSHAIR_SIZE:{name:"hudTargetCrosshairSize",type:"array",elementType:"number",length:2,defaultValue:[.05,.05]},HUD_TARGET_CROSSHAIR_COLOR:{name:"hudTargetCrosshairColor",type:I.COLOR4,defaultValue:[0,1,0,.75]}},C={DEFAULT_FOV:{name:"defaultFOV",type:"number"},DEFAULT_FOV_RANGE:{name:"defaultFOVRange",type:"array",length:2},DEFAULT_SPAN:{name:"defaultSpan",type:"number"},DEFAULT_SPAN_RANGE:{name:"defaultSpanRange",type:"array",length:2},DEFAULT_BASE_ORIENTATION:{name:"defaultBaseOrientation",type:"enum",values:h.CameraOrientationConfiguration.prototype.BaseOrientation},DEFAULT_POINT_TO_FALLBACK:{name:"defaultPointToFallback",type:"enum",values:h.CameraOrientationConfiguration.prototype.PointToFallback}},Object.freeze(N),Object.freeze(I),c.prototype.addToScene=function(t){this._class.acquireResources(),a.executeWhenReady(function(){t.addBackgroundObject(new h.CubemapSampledFVQ(this._class.getModel(),this._class.getShader(),this._class.getShader().getCubemapNames()[0],this._class.getCubemap(),t.getCamera()))}.bind(this))},c.prototype.destroy=function(){this._class=null},p.prototype.addToScene=function(t){t.addDirectionalLightSource(new h.DirectionalLightSource(this._class.getLightColor(),this._direction)),this._class.acquireResources(),a.executeWhenReady(function(){var o,n,r;for(n=this._class.getLayers(),o=0;o<n.length;o++)r=new h.BackgroundBillboard(n[o].getModel(),n[o].getShader(),n[o].getTexturesOfTypes(n[o].getShader().getTextureTypes(),l.getTextureQualityPreferenceList()),n[o].getColor(),n[o].getSize(),i.translation4v(e.scaled3(this._direction,w.getSetting(R.BACKGROUND_OBJECT_DISTANCE)))),r.setRelativeSize(1),t.addBackgroundObject(r)}.bind(this))},p.prototype.destroy=function(){this._class=null,this._direction=null},d.prototype.addToScene=function(t,e){this._visualModel=new h.PointParticle(this._cloud.getClass().getModel(),this._cloud.getClass().getShader(),this._cloud.getClass().getInstancedShader(),this._positionVector,e?this._cloud.getClass().getColor():null,e?this._range:null),t.addSubnode(new h.RenderableNode(this._visualModel,!1,w.getSetting(R.MINIMUM_DUST_PARTICLE_COUNT_FOR_INSTANCING)))},d.prototype.getVisualModel=function(){return this._visualModel},d.prototype.simulate=function(t){this._visualModel.fitPositionWithinRange(t.getCameraPositionMatrix(),this._range)},d.prototype.destroy=function(){this._positionVector=null,this._visualModel&&(this._visualModel.getNode().markAsReusable(),this._visualModel=null),this._cloud=null},_.prototype.getClass=function(){return this._class},_.prototype.getColor=function(){return this._class.getColor().concat(1)},_.prototype.getRange=function(){return this._class.getRange()},_.prototype.addToScene=function(t){var e,i,o;for(this._class.acquireResources(),this._particles=[],i=this._class.getNumberOfParticles(),e=0;i>e;e++)o=new d(this,[2*(Math.random()-.5)*this._class.getRange(),2*(Math.random()-.5)*this._class.getRange(),2*(Math.random()-.5)*this._class.getRange()]),this._particles.push(o);a.executeWhenReady(function(){var e,o;for(this._visualModel=new h.RenderableObject(null,!1,!1),o=t.addNode(new h.RenderableNode(this._visualModel,!0)),e=0;i>e;e++)this._particles[e].addToScene(o,0===e)}.bind(this))},_.prototype.simulate=function(t){var e,i;for(i=this._class.getNumberOfParticles(),this._particles[0]._visualModel.setShift(t.getVelocityVector()[0],t.getVelocityVector()[1],t.getVelocityVector()[2]),e=0;i>e;e++)this._particles[e].simulate(t)},_.prototype.destroy=function(){var t,e;if(e=this._class.getNumberOfParticles(),this._class=null,this._particles){for(t=0;e>t;t++)this._particles[t].destroy(),this._particles[t]=null;this._particles=null}this._visualModel&&(this._visualModel.getNode().markAsReusable(),this._visualModel=null)},g.prototype.loadFromJSON=function(t){var e;for(this._skyboxes=[],e=0;e<t.skyboxes.length;e++)this._skyboxes.push(new c(u.getSkyboxClass(t.skyboxes[e]["class"])));for(this._backgroundObjects=[],e=0;e<t.backgroundObjects.length;e++)this._backgroundObjects.push(new p(u.getBackgroundObjectClass(t.backgroundObjects[e]["class"]),t.backgroundObjects[e].position.angleAlpha,t.backgroundObjects[e].position.angleBeta));for(this._dustClouds=[],e=0;e<t.dustClouds.length;e++)this._dustClouds.push(new _(u.getDustCloudClass(t.dustClouds[e]["class"])))},g.prototype.addToScene=function(t){var e;for(e=0;e<this._skyboxes.length;e++)this._skyboxes[e].addToScene(t);for(e=0;e<this._backgroundObjects.length;e++)this._backgroundObjects[e].addToScene(t);for(e=0;e<this._dustClouds.length;e++)this._dustClouds[e].addToScene(t);this._camera=t.getCamera()},g.prototype.simulate=function(){var t;for(t=0;t<this._dustClouds.length;t++)this._dustClouds[t].simulate(this._camera)},g.prototype.destroy=function(){var t;if(this._skyboxes){for(t=0;t<this._skyboxes.length;t++)this._skyboxes[t].destroy(),this._skyboxes[t]=null;this._skyboxes=null}if(this._backgroundObjects){for(t=0;t<this._backgroundObjects.length;t++)this._backgroundObjects[t].destroy(),this._backgroundObjects[t]=null;this._backgroundObjects=null}if(this._dustClouds){for(t=0;t<this._dustClouds.length;t++)this._dustClouds[t].destroy(),this._dustClouds[t]=null;this._dustClouds=null}this._camera=null},f.prototype=new n.AsyncResource,f.prototype.constructor=f,f.prototype.loadConfigurationFromJSON=function(e){this._configuration=t.getVerifiedObject("configuration",e,O)},f.prototype.getConfigurationSetting=function(t){return this._configuration[t.name]},f.prototype.getSetting=function(t){return this._settings[t.name]},f.prototype.getDefaultCameraFOV=function(){return this.getSetting(C.DEFAULT_FOV)},f.prototype.getDefaultCameraFOVRange=function(){return this.getSetting(C.DEFAULT_FOV_RANGE)},f.prototype.getDefaultCameraSpan=function(){return this.getSetting(C.DEFAULT_SPAN)},f.prototype.getDefaultCameraSpanRange=function(){return this.getSetting(C.DEFAULT_SPAN_RANGE)},f.prototype.getDefaultCameraBaseOrientation=function(){return this.getSetting(C.DEFAULT_BASE_ORIENTATION)},f.prototype.getDefaultCameraPointToFallback=function(){return this.getSetting(C.DEFAULT_POINT_TO_FALLBACK)},f.prototype.getEnvironment=function(t){return this._environments[t]||null},f.prototype.getLevelFileName=function(t){return this.getConfigurationSetting(O.LEVEL_FILES).filenames[t]},f.prototype.requestEnvironmentsLoad=function(){
o.requestTextFile(this.getConfigurationSetting(O.ENVIRONMENTS_SOURCE_FILE).folder,this.getConfigurationSetting(O.ENVIRONMENTS_SOURCE_FILE).filename,function(t){this.loadEnvironmentsFromJSON(JSON.parse(t)),this.setToReady()}.bind(this))},f.prototype.loadEnvironmentsFromJSON=function(t){var e,i;for(this._environments={},e=0;e<t.environments.length;e++)i=new g(t.environments[e]),this._environments[t.environments[e].name]=i},f.prototype.loadSettingsFromJSON=function(e){this._settings=t.getVerifiedObject("general",e.general,E),t.getVerifiedObject("database",e.database,A,this._settings),t.getVerifiedObject("battle",e.battle,R,this._settings),t.getVerifiedObject("camera",e.camera,C,this._settings),u.requestLoad(this.getConfigurationSetting(O.CLASSES_SOURCE_FILE),function(){this.requestEnvironmentsLoad()}.bind(this))},m.prototype.getEmitterParticleConstructor=function(t){var e=this._class.getParticleEmitterDescriptors()[t];return function(){return new h.Particle(e.getModel(),e.getShader(),e.getTexturesOfTypes(e.getShader().getTextureTypes(),l.getTextureQualityPreferenceList()),i.identity4(),e.getParticleStates(),!1,e.getInstancedShader())}},m.prototype.getVisualModel=function(){return this._visualModel},m.prototype._createVisualModel=function(){var t,e,n=[],r=this._class.getParticleEmitterDescriptors();for(t=0;t<r.length;t++){switch(r[t].getType()){case u.ParticleEmitterType.OMNIDIRECTIONAL:e=new h.OmnidirectionalParticleEmitter(i.identity4(),this._orientationMatrix,r[t].getDimensions(),r[t].getVelocity(),r[t].getVelocitySpread(),r[t].getInitialNumber(),r[t].getSpawnNumber(),r[t].getSpawnTime(),r[t]._duration,this.getEmitterParticleConstructor(t));break;case u.ParticleEmitterType.UNIDIRECTIONAL:e=new h.UnidirectionalParticleEmitter(i.identity4(),this._orientationMatrix,r[t].getDimensions(),this._direction,r[t].getDirectionSpread(),r[t].getVelocity(),r[t].getVelocitySpread(),r[t].getInitialNumber(),r[t].getSpawnNumber(),r[t].getSpawnTime(),r[t]._duration,this.getEmitterParticleConstructor(t));break;case u.ParticleEmitterType.PLANAR:e=new h.PlanarParticleEmitter(i.identity4(),this._orientationMatrix,r[t].getDimensions(),this._direction,r[t].getDirectionSpread(),r[t].getVelocity(),r[t].getVelocitySpread(),r[t].getInitialNumber(),r[t].getSpawnNumber(),r[t].getSpawnTime(),r[t]._duration,this.getEmitterParticleConstructor(t));break;default:o.crash()}n.push(e)}this._visualModel=this._visualModel||new h.ParticleSystem(this._positionMatrix,i.identity4(),n,this._class.getTotalDuration(),this._class.isContinuous(),this._carriesParticles,w.getSetting(R.MINIMUM_EXPLOSION_PARTICLE_COUNT_FOR_INSTANCING))},m.prototype.addToScene=function(t,i){var o;this._class.acquireResources(),a.executeWhenReady(function(){this._createVisualModel(),i?i.addSubnode(new h.RenderableNode(this._visualModel)):t.addObject(this._visualModel),o=this._class.getLightStates(),o&&t.addPointLightSource(new h.PointLightSource(o[0].color,o[0].intensity,e.NULL3,[this._visualModel],o),V)}.bind(this))},m.prototype.addResourcesToScene=function(t){this._class.acquireResources(),a.executeWhenReady(function(){this._createVisualModel(),t.addResourcesOfObject(this._visualModel)}.bind(this))},m.prototype.finish=function(){this._visualModel.finishEmitting()},m.prototype.destroy=function(){this._class=null,this._positionMatrix=null,this._orientationMatrix=null,this._direction=null,this._visualModel&&this._visualModel.markAsReusable(),this._visualModel=null},y.prototype.canBeReused=function(){return this._timeLeft<=0},y.prototype._createVisualModel=function(){this._visualModel=this._visualModel||new h.Billboard(this._class.getModel(),this._class.getShader(),this._class.getTexturesOfTypes(this._class.getShader().getTextureTypes(),l.getTextureQualityPreferenceList()),this._class.getSize(),this._physicalModel._positionMatrix,this._physicalModel._orientationMatrix)},y.prototype.getVisualModel=function(){return this._visualModel},y.prototype.addToScene=function(t){this._class.acquireResources(),a.executeWhenReady(function(){this._createVisualModel(),t.addObject(this._visualModel)}.bind(this))},y.prototype.addResourcesToScene=function(t){var e;this._class.acquireResources(),a.executeWhenReady(function(){this._createVisualModel(),t.addResourcesOfObject(this._visualModel),e=new m(this._class.getExplosionClass(),i.identity4(),i.identity4(),[0,0,0],!0),e.addResourcesToScene(t)}.bind(this))},y.prototype.simulate=function(t,o){var n,r,s,a,h,l,u,c,p;if(this._timeLeft-=t,this._timeLeft<=0)this.destroy();else for(this._physicalModel.simulate(t),this._visualModel.setPositionMatrix(this._physicalModel._positionMatrix),this._visualModel.setOrientationMatrix(this._physicalModel._orientationMatrix),r=i.translationVector3(this._physicalModel._positionMatrix),n=0;n<o.length;n++)if(p=o[n]._physicalModel,p&&(w.getSetting(R.SELF_FIRE)||o[n]!==this._origin)&&p.checkHit(r,[],0)){if(s=e.diff3(r,i.translationVector3(p._positionMatrix)),h=i.translationVector3(this._physicalModel.getVelocityMatrix()),l=e.length3(h),u=e.normal3(h),p.addForceAndTorque(s,u,l*this._physicalModel.getMass()*1e3/w.getSetting(R.MOMENT_DURATION),w.getSetting(R.MOMENT_DURATION)),c=new m(this._class.getExplosionClass(),this._physicalModel._positionMatrix,i.identity4(),e.scaled3(u,-1),!0),c.addToScene(this._visualModel.getNode()._scene),s=e.mulVec4Mat4(r,o[n]._visualModel.getModelMatrixInverse()),a=e.mulVec3Mat4(u,i.inverseOfRotation4(o[n]._visualModel._orientationMatrix)),o[n].damage(this._class.getDamage(),s,e.scaled3(a,-1)),o[n]!==this._origin)switch(w.getSetting(R.AUTO_TARGETING)){case N.HIT_AND_NO_TARGET:this._origin.getTarget()||this._origin.setTarget(o[n],!0);break;case N.HIT_AND_AUTO_TARGET:this._origin.hasManualTarget()||this._origin.getTarget()===o[n]||this._origin.setTarget(o[n],!0);break;case N.ALWAYS_WHEN_HIT:this._origin.getTarget()!==o[n]&&this._origin.setTarget(o[n],!0)}this.destroy()}},y.prototype.destroy=function(){this._timeLeft=0,this._class=null,this._origin=null,this._visualModel&&this._visualModel.getNode()&&this._visualModel.getNode().markAsReusable(),this._visualModel=null,this._physicalModel=null},S.prototype.acquireResources=function(){this._class.acquireResources()},S.prototype.addToScene=function(t,e,n){this.acquireResources(),a.executeWhenReady(function(){o.log("Adding weapon ("+this._class.getName()+") to scene...",2),this._visualModel=new h.ShadedLODMesh(this._class.getModel(),this._class.getShader(),this._class.getTexturesOfTypes(this._class.getShader().getTextureTypes(),l.getTextureQualityPreferenceList()),this._slot.positionMatrix,this._slot.orientationMatrix,i.identity4(),n===!0,e),t.addSubnode(new h.RenderableNode(this._visualModel))}.bind(this))},S.prototype._getMuzzleFlashForBarrel=function(t){var e=this._class.getBarrel(t).getProjectileClass(),o=i.translation4v(this._class.getBarrel(t).getPositionVector());return h.dynamicParticle(e.getMuzzleFlash().getModel(),e.getMuzzleFlash().getShader(),e.getMuzzleFlash().getTexturesOfTypes(e.getMuzzleFlash().getShader().getTextureTypes(),l.getTextureQualityPreferenceList()),e.getMuzzleFlash().getColor(),e.getMuzzleFlash().getSize(),o,e.getMuzzleFlash()._duration||w.getSetting(R.DEFAULT_MUZZLE_FLASH_DURATION),e.getMuzzleFlash().getInstancedShader())},S.prototype.getResourceAdderFunction=function(t,e){return function(){t.addResourcesOfObject(this._getMuzzleFlashForBarrel(e))}.bind(this)},S.prototype.addProjectileResourcesToScene=function(t){var e,i,o;for(o=this._class.getBarrels(),e=0;e<o.length;e++)i=new y(o[e].getProjectileClass()),i.addResourcesToScene(t),a.executeWhenReady(this.getResourceAdderFunction(t,e).bind(this))},S.prototype.simulate=function(t){this._cooldown=Math.min(this._cooldown+t,this._class.getCooldown())},S.prototype.fire=function(t){var o,n,r,a,l,u,c,p,d,_,g,f,m,S,T=this._visualModel.getNode()._scene;if(this._cooldown>=this._class.getCooldown()){for(this._cooldown=0,r=this._spacecraft.getPhysicalOrientationMatrix(),a=i.prod4(this._spacecraft.getPhysicalScalingMatrix(),r),l=e.mulVec4Mat4(i.translationVector4(this._slot.positionMatrix),a),u=i.prod4(this._spacecraft.getPhysicalPositionMatrix(),i.translation4v(l)),p=i.prod4(this._slot.orientationMatrix,r),f=this._class.getBarrels(),m={},o=0;o<f.length;o++)d=f[o].getProjectileClass(),_=e.mulVec3Mat3(f[o].getPositionVector(),i.matrix3from4(i.prod4(this._slot.orientationMatrix,a))),c=i.prod4(u,i.translation4v(_)),g=this._getMuzzleFlashForBarrel(o),this._visualModel.getNode().addSubnode(new h.RenderableNode(g),!1,w.getSetting(R.MINIMUM_MUZZLE_FLASH_PARTICLE_COUNT_FOR_INSTANCING)),n=new y(d,c,p,this._spacecraft,new s.Force("",f[o].getForceForDuration(w.getSetting(R.MOMENT_DURATION)),[p[4],p[5],p[6]],w.getSetting(R.MOMENT_DURATION))),n.addToScene(T),t.push(n),m[d.getName()]?m[d.getName()].addEmittingObject(n._visualModel):m[d.getName()]=new h.PointLightSource(d.getLightColor(),d.getLightIntensity(),e.NULL3,[n._visualModel]),this._spacecraft._physicalModel.addForceAndTorque(e.diff3(i.translationVector3(c),i.translationVector3(this._spacecraft.getPhysicalPositionMatrix())),i.getRowB43Neg(p),f[o].getForceForDuration(w.getSetting(R.MOMENT_DURATION)),w.getSetting(R.MOMENT_DURATION));for(S in m)m.hasOwnProperty(S)&&T.addPointLightSource(m[S],P)}},S.prototype.destroy=function(){this._class=null,this._spacecraft=null,this._slot=null,this._visualModel=null},T.prototype.addToScene=function(t){this._propulsionClass.acquireResources(),a.executeWhenReady(function(){this._visualModel=h.staticParticle(this._propulsionClass.getThrusterBurnParticle().getModel(),this._propulsionClass.getThrusterBurnParticle().getShader(),this._propulsionClass.getThrusterBurnParticle().getTexturesOfTypes(this._propulsionClass.getThrusterBurnParticle().getShader().getTextureTypes(),l.getTextureQualityPreferenceList()),this._propulsionClass.getThrusterBurnParticle().getColor(),this._slot.size,i.translation4v(this._slot.positionVector),this._propulsionClass.getThrusterBurnParticle().getInstancedShader()),this._visualModel.setRelativeSize(0),t.addSubnode(new h.RenderableNode(this._visualModel,!1,w.getSetting(R.MINIMUM_THRUSTER_PARTICLE_COUNT_FOR_INSTANCING))),this._shipModel=t._renderableObject}.bind(this))},T.prototype._updateVisuals=function(){this._visualModel.setRelativeSize(this._burnLevel),l.areLuminosityTexturesAvailable()&&this._shipModel.setParameter(w.getSetting(E.UNIFORM_LUMINOSITY_FACTORS_ARRAY_NAME),this._slot.group,Math.min(1,this._burnLevel/this._maxMoveBurnLevel))},T.prototype.resetBurn=function(){this._burnLevel=0,this._updateVisuals()},T.prototype.addBurn=function(t){this._burnLevel+=t,this._updateVisuals()},T.prototype.destroy=function(){this._propulsionClass=null,this._slot=null,this._visualModel=null,this._shipModel=null},x.prototype.acquireResources=function(){this._class.acquireResources()},x.prototype.getThrust=function(){return this._class.getThrust()},x.prototype.getAngularThrust=function(){return this._class.getAngularThrust()},x.prototype.getMaxMoveBurnLevel=function(){return this._class.getMaxMoveBurnLevel()},x.prototype.getMaxTurnBurnLevel=function(){return this._class.getMaxTurnBurnLevel()},x.prototype.addThrusters=function(t){var e,i,o;for(e=0;e<t.length;e++)for(o=new T(this._class,t[e]),i=0;i<t[e].uses.length;i++)this._thrusterUses[t[e].uses[i]].thrusters.push(o)},x.prototype.addToScene=function(t){var e,i;for(e in this._thrusterUses)if(this._thrusterUses.hasOwnProperty(e))for(i=0;i<this._thrusterUses[e].thrusters.length;i++)this._thrusterUses[e].thrusters[i].addToScene(t)},x.prototype.getThrusterBurn=function(t){return this._thrusterUses[t].burn},x.prototype.addThrusterBurn=function(t,e){var i;for(this._thrusterUses[t].burn+=e,i=0;i<this._thrusterUses[t].thrusters.length;i++)this._thrusterUses[t].thrusters[i].addBurn(e)},x.prototype.resetThrusterBurn=function(){var t,e;for(t in this._thrusterUses)if(this._thrusterUses.hasOwnProperty(t))for(this._thrusterUses[t].burn=0,e=0;e<this._thrusterUses[t].thrusters.length;e++)this._thrusterUses[t].thrusters[e].resetBurn()},x.prototype.simulate=function(){var t=i.getRowB4(this._drivenPhysicalObject._orientationMatrix),e=i.getRowC4(this._drivenPhysicalObject._orientationMatrix),o=i.getRowA4(this._drivenPhysicalObject._orientationMatrix);this._thrusterUses.forward.burn>0&&this._drivenPhysicalObject.addOrRenewForce("forwardThrust",this._class.getThrust()*this._thrusterUses.forward.burn/this._class.getMaxMoveBurnLevel(),t),this._thrusterUses.reverse.burn>0&&this._drivenPhysicalObject.addOrRenewForce("reverseThrust",-this._class.getThrust()*this._thrusterUses.reverse.burn/this._class.getMaxMoveBurnLevel(),t),this._thrusterUses.strafeRight.burn>0&&this._drivenPhysicalObject.addOrRenewForce("strafeRightThrust",this._class.getThrust()*this._thrusterUses.strafeRight.burn/this._class.getMaxMoveBurnLevel(),o),this._thrusterUses.strafeLeft.burn>0&&this._drivenPhysicalObject.addOrRenewForce("strafeLeftThrust",-this._class.getThrust()*this._thrusterUses.strafeLeft.burn/this._class.getMaxMoveBurnLevel(),o),this._thrusterUses.raise.burn>0&&this._drivenPhysicalObject.addOrRenewForce("raiseThrust",this._class.getThrust()*this._thrusterUses.raise.burn/this._class.getMaxMoveBurnLevel(),e),this._thrusterUses.lower.burn>0&&this._drivenPhysicalObject.addOrRenewForce("lowerThrust",-this._class.getThrust()*this._thrusterUses.lower.burn/this._class.getMaxMoveBurnLevel(),e),this._thrusterUses.yawRight.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("yawRightThrust",this._class.getAngularThrust()*this._thrusterUses.yawRight.burn/this._class.getMaxTurnBurnLevel(),e),this._thrusterUses.yawLeft.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("yawLeftThrust",-this._class.getAngularThrust()*this._thrusterUses.yawLeft.burn/this._class.getMaxTurnBurnLevel(),e),this._thrusterUses.pitchUp.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("pitchUpThrust",-this._class.getAngularThrust()*this._thrusterUses.pitchUp.burn/this._class.getMaxTurnBurnLevel(),o),this._thrusterUses.pitchDown.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("pitchDownThrust",this._class.getAngularThrust()*this._thrusterUses.pitchDown.burn/this._class.getMaxTurnBurnLevel(),o),this._thrusterUses.rollRight.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("rollRightThrust",-this._class.getAngularThrust()*this._thrusterUses.rollRight.burn/this._class.getMaxTurnBurnLevel(),t),this._thrusterUses.rollLeft.burn>0&&this._drivenPhysicalObject.addOrRenewTorque("rollLeftThrust",this._class.getAngularThrust()*this._thrusterUses.rollLeft.burn/this._class.getMaxTurnBurnLevel(),t)},x.prototype.destroy=function(){this._class=null,this._drivenPhysicalObject=null,this._thrusterUses=null},b.prototype.updateSpeedIncrementPerSecond=function(){this._speedIncrementPerSecond=this._spacecraft.getMaxAcceleration()||0},b.prototype.updateSpeedIncrement=function(t){this._speedIncrement=t*this._speedIncrementPerSecond/1e3},b.prototype.updateTurningLimit=function(){this._turningLimit=this._spacecraft.getMaxAngularAcceleration()*w.getSetting(R.TURN_ACCELERATION_DURATION_S)*s.ANGULAR_VELOCITY_MATRIX_DURATION_S},b.prototype.updateForNewPropulsion=function(){this.updateSpeedIncrementPerSecond(),this.updateTurningLimit(),this._maxMoveBurnLevel=this._spacecraft.getMaxThrusterMoveBurnLevel(),this._maxTurnBurnLevel=this._spacecraft.getMaxThrusterTurnBurnLevel()},b.prototype.getFlightMode=function(){return this._compensated?this._restricted?L.RESTRICTED:L.COMPENSATED:L.FREE},b.prototype.changeFlightMode=function(){this._compensated?this._restricted?(this._compensated=!1,this._restricted=!1):this._restricted=!0:(this._compensated=!0,this._speedTarget=i.translationLength(this._spacecraft.getVelocityMatrix()))},b.prototype.forward=function(t){this._speedTarget=this._compensated?this._speedTarget+(t||this._speedIncrement):Number.MAX_VALUE},b.prototype.stopForward=function(){if(!this._compensated){var t=this._spacecraft.getRelativeVelocityMatrix()[13];this._speedTarget>t&&(this._speedTarget=t)}},b.prototype.reverse=function(t){this._speedTarget=this._compensated?this._speedTarget-(t||this._speedIncrement):-Number.MAX_VALUE},b.prototype.stopReverse=function(){var t;this._compensated||(t=this._spacecraft.getRelativeVelocityMatrix()[13],this._speedTarget<t&&(this._speedTarget=t))},b.prototype.strafeLeft=function(t){this._strafeTarget=t?-t:-Number.MAX_VALUE},b.prototype.stopLeftStrafe=function(){this._strafeTarget<0&&(this._strafeTarget=0)},b.prototype.strafeRight=function(t){this._strafeTarget=t||Number.MAX_VALUE},b.prototype.stopRightStrafe=function(){this._strafeTarget>0&&(this._strafeTarget=0)},b.prototype.lower=function(t){this._liftTarget=t?-t:-Number.MAX_VALUE},b.prototype.stopLower=function(){this._liftTarget<0&&(this._liftTarget=0)},b.prototype.raise=function(t){this._liftTarget=t||Number.MAX_VALUE},b.prototype.stopRaise=function(){this._liftTarget>0&&(this._liftTarget=0)},b.prototype.resetSpeed=function(){this._compensated&&(this._speedTarget=0)},b.prototype.yawLeft=function(t){null===t||void 0===t?this._yawTarget=-this._turningLimit:t>0?this._yawTarget=-Math.min(t,this._turningLimit):this._yawTarget<0&&(this._yawTarget=0)},b.prototype.yawRight=function(t){null===t||void 0===t?this._yawTarget=this._turningLimit:t>0?this._yawTarget=Math.min(t,this._turningLimit):this._yawTarget>0&&(this._yawTarget=0)},b.prototype.pitchDown=function(t){null===t||void 0===t?this._pitchTarget=-this._turningLimit:t>0?this._pitchTarget=-Math.min(t,this._turningLimit):this._pitchTarget<0&&(this._pitchTarget=0)},b.prototype.pitchUp=function(t){null===t||void 0===t?this._pitchTarget=this._turningLimit:t>0?this._pitchTarget=Math.min(t,this._turningLimit):this._pitchTarget>0&&(this._pitchTarget=0)},b.prototype.rollLeft=function(t){null===t||void 0===t?this._rollTarget=-this._turningLimit:t>0?this._rollTarget=-Math.min(t,this._turningLimit):this._rollTarget<0&&(this._rollTarget=0)},b.prototype.rollRight=function(t){null===t||void 0===t?this._rollTarget=this._turningLimit:t>0?this._rollTarget=Math.min(t,this._turningLimit):this._rollTarget>0&&(this._rollTarget=0)},b.prototype.controlThrusters=function(t){var i,o,n,r=this._spacecraft.getRelativeVelocityMatrix(),a=r[13],h=s.VELOCITY_MATRIX_ERROR_THRESHOLD,l=this._spacecraft.getTurningMatrix(),u=s.ANGULAR_VELOCITY_MATRIX_ERROR_THRESHOLD,c=this._turningLimit,p=this._yawTarget,d=this._pitchTarget;this._spacecraft.resetThrusterBurn(),this._restricted&&0!==a&&(c=Math.min(c,this._spacecraft.getMaxTurnRateAtSpeed(a)*s.ANGULAR_VELOCITY_MATRIX_DURATION_S),p=Math.min(Math.max(p,-c),c),d=Math.min(Math.max(d,-c),c)),i=Math.sign(l[4])*e.angle2u([0,1],e.normal2([l[4],l[5]])),p-i>u?this._spacecraft.addThrusterBurn("yawRight",Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(p-i,t))):-u>p-i&&this._spacecraft.addThrusterBurn("yawLeft",Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(i-p,t))),o=Math.sign(l[6])*e.angle2u([1,0],e.normal2([l[5],l[6]])),d-o>u?this._spacecraft.addThrusterBurn("pitchUp",Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(d-o,t))):-u>d-o&&this._spacecraft.addThrusterBurn("pitchDown",Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(o-d,t))),n=Math.sign(-l[2])*e.angle2u([1,0],e.normal2([l[0],l[2]])),this._rollTarget-n>u?this._spacecraft.addThrusterBurn("rollRight",Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(this._rollTarget-n,t))):this._rollTarget-n<-u&&this._spacecraft.addThrusterBurn("rollLeft",Math.min(this._maxTurnBurnLevel,this._spacecraft.getNeededBurnForAngularVelocityChange(n-this._rollTarget,t))),this._speedTarget-a>h?this._spacecraft.addThrusterBurn("forward",Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(this._speedTarget-a,t))):this._speedTarget-a<-h&&this._spacecraft.addThrusterBurn("reverse",Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(a-this._speedTarget,t))),(this._compensated||0!==this._strafeTarget)&&(a=r[12],this._strafeTarget-a>h?this._spacecraft.addThrusterBurn("strafeRight",Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(this._strafeTarget-a,t))):this._strafeTarget-a<-h&&this._spacecraft.addThrusterBurn("strafeLeft",Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(a-this._strafeTarget,t)))),(this._compensated||0!==this._liftTarget)&&(a=r[14],this._liftTarget-a>h?this._spacecraft.addThrusterBurn("raise",Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(this._liftTarget-a,t))):this._liftTarget-a<-h&&this._spacecraft.addThrusterBurn("lower",Math.min(this._maxMoveBurnLevel,this._spacecraft.getNeededBurnForSpeedChange(a-this._liftTarget,t)))),this._yawTarget=0,this._pitchTarget=0,this._rollTarget=0,this._strafeTarget=0,this._liftTarget=0},b.prototype.destroy=function(){this._spacecraft=null},M.prototype._init=function(t,e,o,n,r,h){this._class=t,this._hitpoints=this._class.getHitpoints(),this._physicalModel=new s.PhysicalObject(this._class.getMass(),e||i.identity4(),o||i.identity4(),i.identity4(),i.identity4(),this._class.getBodies()),this._class.acquireResources(),a.executeWhenReady(function(){this._physicalModel.setScalingMatrix(i.scaling4(this._class.getModel().getScale()))}.bind(this)),this._weapons=[],this._maneuveringComputer=new b(this),this._projectileArray=n||null,r&&this.equipProfile(this._class.getEquipmentProfile(r)),this._spacecraftArray=h||null},M.prototype.getClass=function(){return this._class},M.prototype.getHitpoints=function(){return this._hitpoints},M.prototype.getVisualModel=function(){return this._visualModel},M.prototype.getPhysicalModel=function(){return this._physicalModel},M.prototype.getClassName=function(){return this._class.getFullName()},M.prototype.getTypeName=function(){return this._class.getSpacecraftType().getFullName()},M.prototype.canBeReused=function(){return!this._alive},M.prototype.getPhysicalPositionMatrix=function(){return this._physicalModel._positionMatrix},M.prototype.getPhysicalOrientationMatrix=function(){return this._physicalModel._orientationMatrix},M.prototype.getPhysicalScalingMatrix=function(){return this._physicalModel._scalingMatrix},M.prototype.getVelocityMatrix=function(){return this._physicalModel.getVelocityMatrix()},M.prototype.getRelativeVelocityMatrix=function(){return i.prod4(this._physicalModel.getVelocityMatrix(),i.matrix4from3(i.matrix3from4(this._physicalModel.getRotationMatrixInverse())))},M.prototype.getTurningMatrix=function(){return i.prod34(this._physicalModel._orientationMatrix,this._physicalModel.getAngularVelocityMatrix(),i.matrix4from3(i.matrix3from4(this._physicalModel.getRotationMatrixInverse())))},M.prototype.getMaxAcceleration=function(){return this._propulsion?this._propulsion.getThrust()/this._physicalModel.getMass():null},M.prototype.getMaxAngularAcceleration=function(){return this._propulsion?this._propulsion.getAngularThrust()/this._physicalModel.getMass():0},M.prototype.getMaxThrusterMoveBurnLevel=function(){return this._propulsion?this._propulsion.getMaxMoveBurnLevel():0},M.prototype.getMaxThrusterTurnBurnLevel=function(){return this._propulsion?this._propulsion.getMaxTurnBurnLevel():0},M.prototype.getMaxTurnRateAtSpeed=function(t){return Math.abs(this._propulsion.getThrust()/(this._physicalModel.getMass()*t))},M.prototype.getHitboxTextures=function(){var t=a.getShader(w.getSetting(R.HITBOX_SHADER_NAME)).getManagedShader().getTextureTypes(),e=a.getTexture(w.getSetting(R.HITBOX_TEXTURE_NAME));return e.getManagedTexturesOfTypes(t,l.getTextureQualityPreferenceList())},M.prototype.getNeededBurnForSpeedChange=function(t,e){return t*this._physicalModel.getMass()/this._propulsion.getThrust()*this._propulsion.getMaxMoveBurnLevel()/(e/1e3)},M.prototype.getNeededBurnForAngularVelocityChange=function(t,e){return t/s.ANGULAR_VELOCITY_MATRIX_DURATION_S*this._physicalModel.getMass()/this._propulsion.getAngularThrust()*this._propulsion.getMaxTurnBurnLevel()/(e/1e3)},M.prototype.loadFromJSON=function(t,e,o){var n;this._init(u.getSpacecraftClass(t["class"]),i.translation4v(t.position),i.rotation4FromJSON(t.rotations),e,void 0,o),t.equipment?t.equipment.profile?this.equipProfile(this._class.getEquipmentProfile(t.equipment.profile)):(n=new u.EquipmentProfile(t.equipment),this.equipProfile(n)):void 0!==this._class.getEquipmentProfile(w.getSetting(R.DEFAULT_EQUIPMENT_PROFILE_NAME))&&this.equipProfile(this._class.getEquipmentProfile(w.getSetting(R.DEFAULT_EQUIPMENT_PROFILE_NAME)))},M.prototype.setSpacecraftArray=function(t){this._spacecraftArray=t},M.prototype.getFlightMode=function(){return this._maneuveringComputer.getFlightMode()},M.prototype.changeFlightMode=function(){this._maneuveringComputer.changeFlightMode()},M.prototype.forward=function(t){this._maneuveringComputer.forward(t)},M.prototype.stopForward=function(){this._maneuveringComputer.stopForward()},M.prototype.reverse=function(t){this._maneuveringComputer.reverse(t)},M.prototype.stopReverse=function(){this._maneuveringComputer.stopReverse()},M.prototype.strafeLeft=function(t){this._maneuveringComputer.strafeLeft(t)},M.prototype.stopLeftStrafe=function(){this._maneuveringComputer.stopLeftStrafe()},M.prototype.strafeRight=function(t){this._maneuveringComputer.strafeRight(t)},M.prototype.stopRightStrafe=function(){this._maneuveringComputer.stopRightStrafe()},M.prototype.raise=function(t){this._maneuveringComputer.raise(t)},M.prototype.stopRaise=function(){this._maneuveringComputer.stopRaise()},M.prototype.lower=function(t){this._maneuveringComputer.lower(t)},M.prototype.stopLower=function(){this._maneuveringComputer.stopLower()},M.prototype.resetSpeed=function(){this._maneuveringComputer.resetSpeed()},M.prototype.yawLeft=function(t){this._maneuveringComputer.yawLeft(t)},M.prototype.yawRight=function(t){this._maneuveringComputer.yawRight(t)},M.prototype.pitchUp=function(t){this._maneuveringComputer.pitchUp(t)},M.prototype.pitchDown=function(t){this._maneuveringComputer.pitchDown(t)},M.prototype.rollLeft=function(t){this._maneuveringComputer.rollLeft(t)},M.prototype.rollRight=function(t){this._maneuveringComputer.rollRight(t)},M.prototype._addHitboxModel=function(t){var e=a.getOrAddModel(r.cuboidModel(this._class.getName()+D+t,this._class.getBodies()[t].getWidth(),this._class.getBodies()[t].getHeight(),this._class.getBodies()[t].getDepth(),w.getSetting(R.HITBOX_COLOR))),o=new h.ShadedLODMesh(e.getEgomModel(),a.getShader(w.getSetting(R.HITBOX_SHADER_NAME)).getManagedShader(),this.getHitboxTextures(),i.translation4m4(this._class.getBodies()[t]._positionMatrix),this._class.getBodies()[t]._orientationMatrix,i.identity4(),!1);this._hitbox.addSubnode(new h.RenderableNode(o))},M.prototype.acquireResources=function(t,e){o.log("Requesting resources for spacecraft ("+this._class.getFullName()+")...",2);var i=void 0===t?{maxLOD:l.getMaxLoadedLOD()}:{lod:t};e&&(a.getShader(w.getSetting(R.HITBOX_SHADER_NAME)),a.getTexture(w.getSetting(R.HITBOX_TEXTURE_NAME))),this._class.acquireResources(i)},M.prototype.addToScene=function(t,e,n,r,s){var u,c;if(r=r||{},this.acquireResources(e,r&&r.hitboxes===!0),r.weapons===!0)for(u=0;u<this._weapons.length;u++)this._weapons[u].acquireResources(e,r.projectileResources);if(r.thrusterParticles===!0&&this._propulsion&&(this._propulsion.addThrusters(this._class.getThrusterSlots()),this._propulsion.acquireResources()),r.explosion===!0&&this._class.getExplosionClass().acquireResources(),r.blinkers===!0)for(c=this._class.getBlinkers(),u=0;u<c.length;u++)c[u].acquireResources();a.executeWhenReady(function(){var a,p,d;if(o.log("Adding spacecraft ("+this._class.getFullName()+") to scene...",2),this._visualModel=new h.ParameterizedMesh(this._class.getModel(),this._class.getShader(),this._class.getTexturesOfTypes(this._class.getShader().getTextureTypes(),l.getTextureQualityPreferenceList()),this._physicalModel._positionMatrix,this._physicalModel._orientationMatrix,i.scaling4(this._class.getModel().getScale()),n===!0,e,l.areLuminosityTexturesAvailable()?[w.getSetting(E.UNIFORM_LUMINOSITY_FACTORS_ARRAY_NAME)]:[]),l.areLuminosityTexturesAvailable()&&this._visualModel.setParameter(w.getSetting(E.UNIFORM_LUMINOSITY_FACTORS_ARRAY_NAME),0,this._class.getGroupZeroLuminosity()),a=t.addObject(this._visualModel),r.hitboxes===!0){for(this._hitbox=new h.RenderableNode(new h.RenderableObject3D(this._class.getShader(),!1,!1)),u=0;u<this._class.getBodies().length;u++)this._addHitboxModel(u);this._hitbox.hide(),a.addSubnode(this._hitbox)}if(r.weapons===!0)for(u=0;u<this._weapons.length;u++)this._weapons[u].addToScene(a,e,n);if(r.thrusterParticles===!0&&this._propulsion&&this._propulsion.addToScene(a),r.projectileResources===!0)for(u=0;u<this._weapons.length;u++)this._weapons[u].addProjectileResourcesToScene(t);if(r.explosion===!0&&(p=new m(this._class.getExplosionClass(),i.identity4(),i.identity4(),[0,0,0],!0),p.addResourcesToScene(t)),r.cameraConfigurations===!0&&this._addCameraConfigurationsForViews(),r.lightSources===!0)for(d=this._class.getLightSources(),u=0;u<d.length;u++)d[u].spotDirection?t.addSpotLightSource(new h.SpotLightSource(d[u].color,d[u].intensity,d[u].position,d[u].spotDirection,d[u].spotCutoffAngle,d[u].spotFullIntensityAngle,[this._visualModel])):t.addPointLightSource(new h.PointLightSource(d[u].color,d[u].intensity,d[u].position,[this._visualModel]),F);if(r.blinkers===!0)for(c=this._class.getBlinkers(),u=0;u<c.length;u++)a.addSubnode(new h.RenderableNode(new h.Particle(c[u].getParticle().getModel(),c[u].getParticle().getShader(),c[u].getParticle().getTexturesOfTypes(c[u].getParticle().getShader().getTextureTypes(),l.getTextureQualityPreferenceList()),i.translation4v(c[u].getPosition()),c[u].getParticleStates(),!0,c[u].getParticle().getInstancedShader(),0),!1,w.getSetting(R.MINIMUM_BLINKER_PARTICLE_COUNT_FOR_INSTANCING))),r.lightSources===!0&&c[u].getIntensity()>0&&t.addPointLightSource(new h.PointLightSource(c[u].getLightColor(),0,c[u].getPosition(),[this._visualModel],c[u].getLightStates(),!0),B);s&&s(this._visualModel)}.bind(this))},M.prototype.createCameraConfigurationForView=function(t){var e,o,n=i.getYawAndPitch(t._orientationMatrix);return e=new h.CameraPositionConfiguration(!t.isMovable(),t.turnsAroundObjects(),t.movesRelativeToObject(),t.getPositionFollowedObjectsForObject(this._visualModel),t.startsWithRelativePosition(),t._positionMatrix,t.getDistanceRange(),t.getConfines(),t.resetsWhenLeavingConfines()),o=new h.CameraOrientationConfiguration(!t.isTurnable(),t.pointsTowardsObjects(),t.isFPS(),t.getOrientationFollowedObjectsForObject(this._visualModel),t._orientationMatrix,Math.degrees(n.yaw),Math.degrees(n.pitch),t.getAlphaRange(),t.getBetaRange(),t.getBaseOrientation()||w.getDefaultCameraBaseOrientation(),t.getPointToFallback()||w.getDefaultCameraPointToFallback()),new h.CameraConfiguration(t.getName(),e,o,t.getFOV()||w.getDefaultCameraFOV(),t.getFOVRange()||w.getDefaultCameraFOVRange(),t.getSpan()||w.getDefaultCameraSpan(),t.getSpanRange()||w.getDefaultCameraSpanRange(),t.shouldAutoReset())},M.prototype._addCameraConfigurationsForViews=function(){var t;for(t=0;t<this._class.getViews().length;t++)this._visualModel.getNode().addCameraConfiguration(this.createCameraConfigurationForView(this._class.getViews()[t]))},M.prototype.addWeapon=function(t){var e,i=this._class.getWeaponSlots();this._weapons.length<i.length&&(e=i[this._weapons.length],this._weapons.push(new S(t,this,e)))},M.prototype.addPropulsion=function(t){this._propulsion=new x(t,this._physicalModel),this._maneuveringComputer.updateForNewPropulsion(),this._maneuveringComputer.updateTurningLimit()},M.prototype.equipProfile=function(t){var e;if(t){for(e=0;e<t.getWeaponDescriptors().length;e++)this.addWeapon(u.getWeaponClass(t.getWeaponDescriptors()[e].className));null!==t.getPropulsionDescriptor()&&this.addPropulsion(u.getPropulsionClass(t.getPropulsionDescriptor().className));
}else o.log("WARNING: equipping empty profile on "+this._class.getName()+"!")},M.prototype.fire=function(){var t;for(t=0;t<this._weapons.length;t++)this._weapons[t].fire(this._projectileArray)},M.prototype.setTarget=function(t,e){var i,o;if(this._target=t,this._autoTarget=e||!1,this._visualModel)for(o=this._visualModel.getNode().getCameraConfigurationsWithName(w.getSetting(R.TARGET_VIEW_NAME)),i=0;i<o.length;i++)this._visualModel.getNode()._scene.getCamera().getConfiguration()===o[i]&&this._visualModel.getNode()._scene.getCamera().transitionToSameConfiguration(w.getSetting(R.TARGET_CHANGE_TRANSITION_DURATION),w.getSetting(R.TARGET_CHANGE_TRANSITION_STYLE)),o[i].setOrientationFollowedObjects(this._target?[this._target._visualModel]:[],!0)},M.prototype.targetNext=function(){var t;this._spacecraftArray&&this._spacecraftArray.length>0&&(t=(this._spacecraftArray.indexOf(this._target)+1)%this._spacecraftArray.length,this._spacecraftArray[t]===this&&(t=(t+1)%this._spacecraftArray.length),this._spacecraftArray[t]!==this&&this.setTarget(this._spacecraftArray[t],!1))},M.prototype.getTarget=function(){return this._target&&this._target.canBeReused()&&this.setTarget(null),this._target},M.prototype.hasManualTarget=function(){return this._target&&!this._autoTarget},M.prototype.resetThrusterBurn=function(){this._propulsion.resetThrusterBurn()},M.prototype.addThrusterBurn=function(t,e){this._propulsion.addThrusterBurn(t,e)},M.prototype.toggleHitboxVisibility=function(){this._hitbox.toggleVisibility()},M.prototype.resetViewCameras=function(){this._visualModel.getNode().resetCameraConfigurations()},M.prototype.damage=function(t,e,o){var n,r,s,a;if(this._hitpoints-=t,this._hitpoints<0)this._hitpoints=0;else for(n=0;n<this._class.getDamageIndicators().length;n++)r=this._class.getDamageIndicators()[n],s=r.hullIntegrity/100*this._class.getHitpoints(),this._hitpoints<=s&&this._hitpoints+t>s&&(a=new m(r.explosionClass,i.translation4v(e),i.identity4(),o,!0),a.addToScene(this._visualModel.getNode()._scene,this._visualModel.getNode()),this._activeDamageIndicators.push(a))},M.prototype.simulate=function(t){var e,o;if(this._alive){if(this._target&&this._target.canBeReused()&&this.setTarget(null),this._hitpoints<=0){if(this._timeElapsedSinceDestruction<0)for(this._timeElapsedSinceDestruction=0,o=new m(this._class.getExplosionClass(),this._physicalModel._positionMatrix,this._physicalModel._orientationMatrix,i.getRowC43(this._physicalModel._positionMatrix),!1),o.addToScene(this._visualModel.getNode()._scene),e=0;e<this._activeDamageIndicators;e++)this._activeDamageIndicators[e].finish();else if(this._timeElapsedSinceDestruction+=t,this._timeElapsedSinceDestruction>this._class.getExplosionClass().getTotalDuration()*this._class.getShowTimeRatioDuringExplosion())return void this.destroy()}else{for(e=0;e<this._weapons.length;e++)this._weapons[e].simulate(t);this._propulsion&&(this._maneuveringComputer.controlThrusters(t),this._propulsion.simulate(t))}this._physicalModel.simulate(t),this._visualModel.setPositionMatrix(this._physicalModel._positionMatrix),this._visualModel.setOrientationMatrix(this._physicalModel._orientationMatrix),this._propulsion&&this._maneuveringComputer.updateSpeedIncrement(t)}},M.prototype.destroy=function(){var t;if(this._class=null,this._weapons)for(t=0;t<this._weapons.length;t++)this._weapons[t]&&(this._weapons[t].destroy(),this._weapons[t]=null);if(this._weapons=null,this._propulsion&&(this._propulsion.destroy(),this._propulsion=null),this._maneuveringComputer&&(this._maneuveringComputer.destroy(),this._maneuveringComputer=null),this._projectileArray=null,this._spacecraftArray=null,this._target=null,this._hitbox&&this._hitbox.markAsReusable(),this._hitbox=null,this._visualModel&&this._visualModel.getNode()&&this._visualModel.getNode().markAsReusable(),this._visualModel=null,this._physicalModel=null,this._activeDamageIndicators){for(t=0;t<this._activeDamageIndicators.length;t++)this._activeDamageIndicators[t].destroy(),this._activeDamageIndicators[t]=null;this._activeDamageIndicators=null}this._alive=!1},v.prototype.getPilotedSpacecraft=function(){return null===this._pilotedCraft||this._pilotedCraft.canBeReused()?null:this._pilotedCraft},v.prototype.requestLoadFromFile=function(t,e){o.requestTextFile(w.getConfigurationSetting(O.LEVEL_FILES).folder,t,function(t){this.loadFromJSON(JSON.parse(t)),e&&e()}.bind(this))},v.prototype.loadFromJSON=function(t){var e,i;if(o.log("Loading level from JSON file...",2),t.environment.createFrom?(this._environment=w.getEnvironment(t.environment.createFrom),this._ownsEnvironment=!1):(this._environment=new g(t.environment),this._ownsEnvironment=!0),this._views=[],t.views)for(e=0;e<t.views.length;e++)this._views.push(new u.SceneView(t.views[e]));for(this._projectiles=[],this._spacecrafts=[],e=0;e<t.spacecrafts.length;e++)i=new M,i.loadFromJSON(t.spacecrafts[e],this._projectiles,this._spacecrafts),t.spacecrafts[e].piloted&&(this._pilotedCraft=i),this._spacecrafts.push(i);o.log("Level successfully loaded.",2)},v.prototype.addRandomShips=function(t,e,o,n,r,s,a){var h,l,c,p;a=a||w.getSetting(E.DEFAULT_RANDOM_SEED),h=Math.seed(a);for(l in t)if(t.hasOwnProperty(l))for(c=0;c<t[l];c++)p=o?i.matrix4(o):i.identity4(),s&&i.mul4(p,i.rotation4(i.getRowC4(p),h()*Math.PI*2)),n&&i.mul4(p,i.rotation4(i.getRowA4(o||i.identity4()),h()*Math.PI*2)),r&&i.mul4(p,i.rotation4(i.getRowB4(o||i.identity4()),h()*Math.PI*2)),this._spacecrafts.push(new M(u.getSpacecraftClass(l),i.translation4(h()*e-e/2,h()*e-e/2,h()*e-e/2),p,this._projectiles,w.getSetting(R.RANDOM_SHIPS_EQUIPMENT_PROFILE_NAME),this._spacecrafts))},v.prototype.createCameraConfigurationForSceneView=function(t,e){var o,n,r=i.getYawAndPitch(t._orientationMatrix);return o=new h.CameraPositionConfiguration(!t.isMovable(),t.turnsAroundObjects(),t.movesRelativeToObject(),t.getPositionFollowedObjectsForScene(e),t.startsWithRelativePosition(),t._positionMatrix,t.getDistanceRange(),t.getConfines(),t.resetsWhenLeavingConfines()),n=new h.CameraOrientationConfiguration(!t.isTurnable(),t.pointsTowardsObjects(),t.isFPS(),t.getOrientationFollowedObjectsForScene(e),t._orientationMatrix,Math.degrees(r.yaw),Math.degrees(r.pitch),t.getAlphaRange(),t.getBetaRange(),t.getBaseOrientation()||w.getDefaultCameraBaseOrientation(),t.getPointToFallback()||w.getDefaultCameraPointToFallback()),new h.CameraConfiguration(t.getName(),o,n,t.getFOV()||w.getDefaultCameraFOV(),t.getFOVRange()||w.getDefaultCameraFOVRange(),t.getSpan()||w.getDefaultCameraSpan(),t.getSpanRange()||w.getDefaultCameraSpanRange(),t.shouldAutoReset())},v.prototype.addToScene=function(t){var e;for(this._environment.addToScene(t),this._hitObjects=[],e=0;e<this._spacecrafts.length;e++)this._spacecrafts[e].addToScene(t,void 0,!1,{hitboxes:!0,weapons:!0,thrusterParticles:!0,projectileResources:!0,explosion:!0,cameraConfigurations:!0,lightSources:!0,blinkers:!0}),this._hitObjects.push(this._spacecrafts[e]);a.executeWhenReady(function(){for(e=0;e<this._views.length;e++)t.addCameraConfiguration(this.createCameraConfigurationForSceneView(this._views[e],t)),0===e&&(t.getCamera().followNode(null,!0,0),t.getCamera().update(0))}.bind(this))},v.prototype.toggleHitboxVisibility=function(){var t;for(t=0;t<this._spacecrafts.length;t++)this._spacecrafts[t].toggleHitboxVisibility()},v.prototype.tick=function(t){var e;for(this._environment.simulate(),e=0;e<this._spacecrafts.length;e++)void 0===this._spacecrafts[e]||this._spacecrafts[e].canBeReused()?(this._spacecrafts[e].destroy(),this._spacecrafts[e]=null,this._spacecrafts.splice(e,1),this._hitObjects[e]=null,this._hitObjects.splice(e,1)):this._spacecrafts[e].simulate(t);for(e=0;e<this._projectiles.length;e++)void 0===this._projectiles[e]||this._projectiles[e].canBeReused()?(this._projectiles[e].destroy(),this._projectiles[e]=null,this._projectiles.splice(e,1),o.log("Projectile removed.",2)):this._projectiles[e].simulate(t,this._hitObjects)},v.prototype.destroy=function(){var t;if(this._environment&&this._ownsEnvironment&&this._environment.destroy(),this._environment=null,this._views){for(t=0;t<this._views.length;t++)this._views[t]&&(this._views[t].destroy(),this._views[t]=null);this._spacecrafts=null}if(this._spacecrafts){for(t=0;t<this._spacecrafts.length;t++)this._spacecrafts[t]&&(this._spacecrafts[t].destroy(),this._spacecrafts[t]=null);this._spacecrafts=null}if(this._projectiles){for(t=0;t<this._projectiles.length;t++)this._projectiles[t]&&(this._projectiles[t].destroy(),this._projectiles[t]=null);this._projectiles=null}this._pilotedCraft=null,this._hitObjects=null},w=new f,{FlightMode:L,GENERAL_SETTINGS:E,BATTLE_SETTINGS:R,DATABASE_SETTINGS:A,CAMERA_SETTINGS:C,loadConfigurationFromJSON:w.loadConfigurationFromJSON.bind(w),loadSettingsFromJSON:w.loadSettingsFromJSON.bind(w),getLevelFileName:w.getLevelFileName.bind(w),getSetting:w.getSetting.bind(w),executeWhenReady:w.executeWhenReady.bind(w),Spacecraft:M,Level:v}}),define("modules/control",["utils/utils","modules/application","modules/async-resource","modules/strings"],function(t,e,i,o){"use strict";function n(t){it=t}function r(t){this._actionName="string"==typeof t?t:null,"object"==typeof t&&this.loadFromJSON(t)}function s(t,e){this._listening=!1,this._enabled=!0,this._bindingClass=t,this._bindings={},void 0!==e&&this.loadFromJSON(e)}function a(i,o,n,s,a){this._key=o||null,this._keyCode=t.getKeyCodeOf(o),this._shiftState=void 0===n?!1:n||this._keyCode===y,this._ctrlState=void 0===s?!1:s||this._keyCode===S,this._altState=void 0===a?!1:a||this._keyCode===T,r.call(this,i),e.log("Created key binding: "+this._actionName+" - "+this.getControlString(),3)}function h(t){s.call(this,a,t),this._currentlyPressedKeys=new Array(256)}function l(t){this._buttonIndex=0,this._moveX=0,this._moveY=0,this._measuredFromCenter=!1,this._scrollX=0,this._scrollY=0,r.call(this,t)}function u(t){this._currentlyPressedButtons=[!1,!1,!1],this._screenCenter=[0,0],this._mousePosition=null,this._mousePositionChange=[0,0],this._scrollChange=[0,0],this._moveSensitivity=0,this._displacementSensitivity=0,this._displacementDeadzone=0,s.call(this,l,t)}function c(t){this._button=this.BUTTON_NONE,this._axisIndex=this.AXIS_NONE,this._axisPositive=!1,r.call(this,t)}function p(t){this._sensitivityFactor=t.sensitivityFactor||0,this._staticSensitivity=t.staticSensitivity===!0,this._actionNames=t.actionNames,this._sensitivityFactor&&this._staticSensitivity&&e.showError("Sensitivity action group defined with both factored and static sensitivity!",e.ErrorSeverity.MINOR)}function d(t){this._gamepad=null,this._sensitivityActionGroups=null,s.call(this,c,t)}function _(t){this._name=null,this._description=null,this._continuous=!1,this._triggered=!1,this._intensity=this.INTENSITY_NOT_SPECIFIED,this._executed=!1,this._nonTriggeredExecuted=!0,this._executeTriggered=null,this._executeNonTriggered=null,void 0!==t&&this.loadFromJSON(t)}function g(t){this._context=null,this._actions={},void 0!==t&&this.loadFromJSON(t)}function f(){i.AsyncResource.call(this),this._dataJSON=null,this._inputInterpreterTypes={},this._inputInterpreters=null,this._inputInterpretersByType={},this._controllerTypes={},this._controllers=null,this._controllersPriorityQueue=null,this._controllersByType={},this._listening=!1,this._disabledActions={}}var m={NONE:"none",LEFT:"left",MIDDLE:"middle",RIGHT:"right"},y=16,S=17,T=18,x=" + ",b="_key",M="_shift",v="_ctrl",O="_alt",E=[m.NONE,m.LEFT,m.MIDDLE,m.RIGHT],A="left",R="right",C="up",w="down",N="_button",L="_moveX",I="_moveY",D="_measuredFromCenter",F="_scrollX",V="_scrollY",P="_gamepad_button",B="_gamepad_axisIndex",U="_gamepad_axisPositive",j={name:"key"+o.CATEGORY_SEPARATOR},k={name:"mouse"+o.CATEGORY_SEPARATOR+"leftButton",defaultValue:"left click"},G={name:"mouse"+o.CATEGORY_SEPARATOR+"rightButton",defaultValue:"right click"},z={name:"mouse"+o.CATEGORY_SEPARATOR+"middleButton",defaultValue:"middle click"},W={name:"mouse"+o.CATEGORY_SEPARATOR+"fromCenter",defaultValue:"{move} {toDirection} from center"},q={name:"mouse"+o.CATEGORY_SEPARATOR+"notFromCenter",defaultValue:"{move} {toDirection}"},X={name:"mouse"+o.CATEGORY_SEPARATOR+"move",defaultValue:"move"},H={name:"mouse"+o.CATEGORY_SEPARATOR+"leftDirection",defaultValue:"left"},Q={name:"mouse"+o.CATEGORY_SEPARATOR+"rightDirection",defaultValue:"right"},Y={name:"mouse"+o.CATEGORY_SEPARATOR+"upDirection",defaultValue:"up"},J={name:"mouse"+o.CATEGORY_SEPARATOR+"downDirection",defaultValue:"down"},K={name:"mouse"+o.CATEGORY_SEPARATOR+"scroll",defaultValue:"scroll"},Z={name:"joystick"+o.CATEGORY_SEPARATOR+"button",defaultValue:"button {index}"},$={name:"joystick"+o.CATEGORY_SEPARATOR+"axis",defaultValue:"axis {index} {direction}"},tt={name:"joystick"+o.CATEGORY_SEPARATOR+"positiveDirection",defaultValue:"positive"},et={name:"joystick"+o.CATEGORY_SEPARATOR+"negativeDirection",defaultValue:"negative"},it="";return r.prototype.getActionName=function(){return this._actionName},r.prototype.getControlString=function(){return e.showError("Cannot get control string of generic control binding!"),null},r.prototype.loadFromJSON=function(t){this._actionName=t.action},r.prototype.saveToLocalStorage=function(){e.showError("Cannot save generic control binding to local storage!")},r.prototype.loadFromLocalStorage=function(){e.showError("Cannot load generic control binding from local storage!")},r.prototype.removeFromLocalStorage=function(){e.showError("Cannot remove generic control binding from local storage!")},r.prototype.bindsTheSameControls=function(){return e.showError("Cannot check if generic control binds the same controls as another binding!"),!0},s.prototype.getDeviceName=function(){return"Generic"},s.prototype.isListening=function(){return this._listening},s.prototype.startListening=function(){this._listening=!0},s.prototype.stopListening=function(){this._listening=!1},s.prototype.toggleListening=function(){this._listening?this.stopListening():this.startListening()},s.prototype.isEnabled=function(){return this._enabled},s.prototype.enable=function(){this._enabled=!0},s.prototype.disable=function(){this._enabled=!1},s.prototype.toggleEnabled=function(){this._enabled?this.disable():this.enable()},s.prototype.setBinding=function(t){this._bindings[t.getActionName()]=t},s.prototype.setAndStoreBinding=function(t){this.setBinding(t),t.saveToLocalStorage()},s.prototype.loadFromJSON=function(t){var e;for(e=0;e<t.bindings.length;e++)this.setBinding(new this._bindingClass(t.bindings[e]))},s.prototype.loadFromLocalStorage=function(){var t;for(t in this._bindings)this._bindings.hasOwnProperty(t)&&this._bindings[t].loadFromLocalStorage()},s.prototype.removeFromLocalStorage=function(){var t;for(t in this._bindings)this._bindings.hasOwnProperty(t)&&this._bindings[t].removeFromLocalStorage()},s.prototype.getControlStringForAction=function(t){return void 0!==this._bindings[t]?this._bindings[t].getControlString():""},s.prototype._addActionByBinding=function(t,e,i){var o;if(e){for(o=0;o<t.length;o++)if(i.bindsTheSameControls(t[o].binding))return void t[o].actions.push(e);t.push({binding:i,actions:[e]})}},s.prototype.checkAction=function(t){e.showError("Cannot check if action '"+t+"' is triggered with a generic input interpreter!")},s.prototype.getTriggeredActions=function(t){var e,i,o=[],n=[];if(!this.isListening()||!this.isEnabled())return o;for(e in this._bindings)this._bindings.hasOwnProperty(e)&&(!t||t(e))&&this._addActionByBinding(n,this.checkAction(e),this._bindings[e]);for(i=0;i<n.length;i++)o.push(n[i].actions);return o},a.prototype=new r,a.prototype.constructor=a,a.prototype.loadFromJSON=function(t){r.prototype.loadFromJSON.call(this,t),this.setKey(t.key),this._shiftState=t.shift===!0||this._keyCode===y,this._ctrlState=t.ctrl===!0||this._keyCode===S,this._altState=t.alt===!0||this._keyCode===T},a.prototype.saveToLocalStorage=function(){localStorage[it+this._actionName+b]=this._key,localStorage[it+this._actionName+M]=this._shiftState,localStorage[it+this._actionName+v]=this._ctrlState,localStorage[it+this._actionName+O]=this._altState},a.prototype.loadFromLocalStorage=function(){void 0!==localStorage[it+this._actionName+b]&&(this.setKey(localStorage[it+this._actionName+b]),this._shiftState="true"===localStorage[it+this._actionName+M],this._ctrlState="true"===localStorage[it+this._actionName+v],this._altState="true"===localStorage[it+this._actionName+O])},a.prototype.removeFromLocalStorage=function(){localStorage.removeItem(it+this._actionName+b),localStorage.removeItem(it+this._actionName+M),localStorage.removeItem(it+this._actionName+v),localStorage.removeItem(it+this._actionName+O)},a.prototype.getKey=function(){return this._key},a.prototype.setKey=function(e){this._key=e,this._keyCode=t.getKeyCodeOf(this._key)},a.prototype.getShiftState=function(){return this._shiftState},a.prototype.getCtrlState=function(){return this._ctrlState},a.prototype.getAltState=function(){return this._altState},a.prototype.getControlString=function(){var e,i;return e=o.get(j,this._key,this._key),this._shiftState&&this._keyCode!==y&&(i=t.getKeyOfCode(y),i=o.get(j,i,i),e=i+x+e),this._ctrlState&&this._keyCode!==S&&(i=t.getKeyOfCode(S),i=o.get(j,i,i),e=i+x+e),this._altState&&this._keyCode!==T&&(i=t.getKeyOfCode(T),i=o.get(j,i,i),e=i+x+e),e},a.prototype.isTriggered=function(t){return t[this._keyCode]&&(t[y]||!this._shiftState)&&(t[S]||!this._ctrlState)&&(t[T]||!this._altState)},a.prototype.bindsTheSameControls=function(t){return this._keyCode===t._keyCode},h.prototype=new s,h.prototype.constructor=h,h.prototype.getDeviceName=function(){return"keyboard"},h.prototype.defaultActionEnabledForKey=function(e){return["f5","f11","escape"].indexOf(t.getKeyOfCode(e))>=0},h.prototype.cancelPressedKeys=function(){var t;for(t=0;t<this._currentlyPressedKeys.length;t++)this._currentlyPressedKeys[t]=!1},h.prototype.handleKeyDown=function(t){this._currentlyPressedKeys[t.keyCode]=!0,this.defaultActionEnabledForKey(t.keyCode)||(t.preventDefault(),t.stopPropagation())},h.prototype.handleKeyUp=function(t){this._currentlyPressedKeys[t.keyCode]=!1,this.defaultActionEnabledForKey(t.keyCode)||(t.preventDefault(),t.stopPropagation())},h.prototype.startListening=function(){s.prototype.startListening.call(this),this.cancelPressedKeys(),document.onkeydown=function(t){this.handleKeyDown(t)}.bind(this),document.onkeyup=function(t){this.handleKeyUp(t)}.bind(this),document.onkeypress=function(t){this.defaultActionEnabledForKey(t.keyCode)||(t.preventDefault(),t.stopPropagation())}.bind(this)},h.prototype.stopListening=function(){s.prototype.stopListening.call(this),document.onkeydown=null,document.onkeyup=null,this.cancelPressedKeys()},h.prototype.checkAction=function(t){return this._bindings[t].isTriggered(this._currentlyPressedKeys)?{name:t}:null},l.prototype=new r,l.prototype.constructor=l,l.prototype.loadFromJSON=function(t){switch(r.prototype.loadFromJSON.call(this,t),this._buttonIndex=E.indexOf(t.button),this._moveX=0,this._moveY=0,t.move){case A:this._moveX=-1;break;case R:this._moveX=1;break;case C:this._moveY=-1;break;case w:this._moveY=1}switch(this._measuredFromCenter=t.fromCenter===!0,this._scrollX=0,this._scrollY=0,t.scroll){case A:this._scrollX=-1;break;case R:this._scrollX=1;break;case C:this._scrollY=-1;break;case w:this._scrollY=1}},l.prototype.saveToLocalStorage=function(){localStorage[it+this._actionName+N]=this._buttonIndex,localStorage[it+this._actionName+L]=this._moveX,localStorage[it+this._actionName+I]=this._moveY,localStorage[it+this._actionName+D]=this._measuredFromCenter,localStorage[it+this._actionName+F]=this._scrollX,localStorage[it+this._actionName+V]=this._scrollY},l.prototype.loadFromLocalStorage=function(){void 0!==localStorage[it+this._actionName+N]&&(this._buttonIndex=parseInt(localStorage[it+this._actionName+N],10),this._moveX=parseInt(localStorage[it+this._actionName+L],10),this._moveY=parseInt(localStorage[it+this._actionName+I],10),this._measuredFromCenter="true"===localStorage[it+this._actionName+D],this._scrollX=parseInt(localStorage[it+this._actionName+F],10),this._scrollY=parseInt(localStorage[it+this._actionName+V],10))},l.prototype.removeFromLocalStorage=function(){localStorage.removeItem(it+this._actionName+N),localStorage.removeItem(it+this._actionName+L),localStorage.removeItem(it+this._actionName+I),localStorage.removeItem(it+this._actionName+D),localStorage.removeItem(it+this._actionName+F),localStorage.removeItem(it+this._actionName+V)},l.prototype.isMeasuredFromCenter=function(){return this._measuredFromCenter},l.prototype.getControlString=function(){var e="",i=null;switch(E[this._buttonIndex]){case m.LEFT:return o.get(k);case m.MIDDLE:return o.get(z);case m.RIGHT:return o.get(G)}return e=this._measuredFromCenter?o.get(W):o.get(q),this._moveX<0?i=o.get(H):this._moveX>0?i=o.get(Q):this._moveY<0?i=o.get(Y):this._moveY>0&&(i=o.get(J)),i?e=t.formatString(e,{move:o.get(X),toDirection:i}):(i=null,e=o.get(q),this._scrollX<0?i=o.get(H):this._scrollX>0?i=o.get(Q):this._scrollY<0?i=o.get(Y):this._scrollY>0&&(i=o.get(J)),i&&(e=t.formatString(e,{move:o.get(K),toDirection:i})),e)},l.prototype.getTriggeredIntensity=function(t,e,i,o,n){var r,s;return this._buttonIndex>0?t[this._buttonIndex]===!0?1:-1:e?(r=this._measuredFromCenter?e[0]-o[0]:i[0],0!==this._moveX?r*this._moveX:(s=this._measuredFromCenter?e[1]-o[1]:i[1],0!==this._moveY?s*this._moveY:0!==this._scrollX?n[0]*this._scrollX:0!==this._scrollY?n[1]*this._scrollY:void 0)):0},l.prototype.bindsTheSameControls=function(t){return this._buttonIndex===t._buttonIndex&&(0===this._moveX&&0===t._moveX||this._moveX*t._moveX!==0)&&(0===this._moveY&&0===t._moveY||this._moveY*t._moveY!==0)&&(0===this._scrollX&&0===t._scrollX||this._scrollX*t._scrollX!==0)&&(0===this._scrollY&&0===t._scrollY||this._scrollY*t._scrollY!==0)},u.prototype=new s,u.prototype.constructor=u,u.prototype.setScreenCenter=function(t,e){this._screenCenter=[t,e],this._mousePosition=null,this._mousePositionChange=[0,0],this._scrollChange=[0,0]},u.prototype.getDeviceName=function(){return"mouse"},u.prototype.setAndStoreMoveSensitivity=function(t){this._moveSensitivity=t,localStorage[it+"mouse_moveSensitivity"]=this._moveSensitivity},u.prototype.setAndStoreDisplacementSensitivity=function(t){this._displacementSensitivity=t,localStorage[it+"mouse_displacementSensitivity"]=this._displacementSensitivity},u.prototype.setAndStoreDisplacementDeadzone=function(t){this._displacementDeadzone=t,localStorage[it+"mouse_displacementDeadzone"]=this._displacementDeadzone},u.prototype.loadFromJSON=function(t){s.prototype.loadFromJSON.call(this,t),this._moveSensitivity=t.sensitivityProfile.moveSensitivity,this._displacementSensitivity=t.sensitivityProfile.displacementSensitivity,this._displacementDeadzone=t.sensitivityProfile.displacementDeadzone},u.prototype.loadFromLocalStorage=function(){s.prototype.loadFromLocalStorage.call(this),void 0!==localStorage[it+"mouse_moveSensitivity"]&&(this._moveSensitivity=parseFloat(localStorage[it+"mouse_moveSensitivity"])),void 0!==localStorage[it+"mouse_displacementSensitivity"]&&(this._displacementSensitivity=parseFloat(localStorage[it+"mouse_displacementSensitivity"])),void 0!==localStorage[it+"mouse_displacementDeadzone"]&&(this._displacementDeadzone=parseInt(localStorage[it+"mouse_displacementDeadzone"],10))},u.prototype.removeFromLocalStorage=function(){s.prototype.removeFromLocalStorage.call(this),localStorage.removeItem(it+"mouse_moveSensitivity"),localStorage.removeItem(it+"mouse_displacementSensitivity"),localStorage.removeItem(it+"mouse_displacementDeadzone")},u.prototype.cancelPressedButtons=function(){var t;for(t=0;t<this._currentlyPressedButtons.length;t++)this._currentlyPressedButtons[t]=!1},u.prototype.handleMouseDown=function(t){return this._currentlyPressedButtons[t.which]=!0,t.preventDefault(),!1},u.prototype.handleMouseUp=function(t){return this._currentlyPressedButtons[t.which]=!1,t.preventDefault(),!1},u.prototype.handleMouseMove=function(t){null!==this._mousePosition?this._mousePositionChange=[this._mousePositionChange[0]+(t.clientX-this._mousePosition[0]),this._mousePositionChange[1]+(t.clientY-this._mousePosition[1])]:this._mousePositionChange=[0,0],this._mousePosition=[t.clientX,t.clientY]},u.prototype.handleWheel=function(t){this._scrollChange[0]+=t.deltaX,this._scrollChange[1]+=t.deltaY},u.prototype.startListening=function(){s.prototype.startListening.call(this),this.cancelPressedButtons(),this._mousePosition=null,this._mousePositionChange=[0,0],document.onmousedown=function(t){this.handleMouseDown(t)}.bind(this),document.onmouseup=function(t){this.handleMouseUp(t)}.bind(this),document.onmousemove=function(t){this.handleMouseMove(t)}.bind(this),document.onwheel=function(t){this.handleWheel(t)}.bind(this),document.onclick=function(t){return t.preventDefault(),!1},document.oncontextmenu=function(t){return t.preventDefault(),!1}},u.prototype.stopListening=function(){s.prototype.stopListening.call(this),document.onmousedown=null,document.onmouseup=null,document.onmousemove=null,document.onwheel=null,document.onclick=null,document.oncontextmenu=null,this.cancelPressedButtons(),this._mousePosition=null,this._mousePositionChange=[0,0],this._scrollChange=[0,0]},u.prototype.checkAction=function(t){var e=this._bindings[t].getTriggeredIntensity(this._currentlyPressedButtons,this._mousePosition,this._mousePositionChange,this._screenCenter,this._scrollChange);return e>=0?{name:t,intensity:this._bindings[t].isMeasuredFromCenter()===!0?Math.max(0,(e-this._displacementDeadzone)*this._displacementSensitivity):e*this._moveSensitivity}:null},u.prototype.getTriggeredActions=function(t){var e=s.prototype.getTriggeredActions.call(this,t);return this._mousePositionChange=[0,0],this._scrollChange=[0,0],e},c.prototype=new r,c.prototype.constructor=c,c.prototype.BUTTON_NONE=-1,c.prototype.AXIS_NONE=-1,c.prototype.loadFromJSON=function(t){r.prototype.loadFromJSON.call(this,t),"number"==typeof t.button&&(this._button=t.button),"string"==typeof t.axis&&(this._axisIndex=Math.abs(parseInt(t.axis,10)),this._axisPositive="-"!==t.axis[0])},c.prototype.saveToLocalStorage=function(){localStorage[it+this._actionName+P]=this._button,localStorage[it+this._actionName+B]=this._axisIndex,localStorage[it+this._actionName+U]=this._axisPositive},c.prototype.loadFromLocalStorage=function(){void 0!==localStorage[it+this._actionName+P]&&(this._button=parseInt(localStorage[it+this._actionName+P],10),this._axisIndex=parseInt(localStorage[it+this._actionName+P],10),this._axisPositive="true"===localStorage[it+this._actionName+U])},c.prototype.removeFromLocalStorage=function(){localStorage.removeItem(it+this._actionName+P),localStorage.removeItem(it+this._actionName+B),localStorage.removeItem(it+this._actionName+U)},c.prototype.getTriggeredIntensity=function(t){return t?this._button!==this.BUTTON_NONE?1===t.buttons[this._button]||"object"==typeof t.buttons[this._button]&&t.buttons[this._button].pressed?1:0:this._axisIndex!==this.AXIS_NONE?Math.max(t.axes[this._axisIndex]*(this._axisPositive?1:-1),0):0:0},c.prototype.getControlString=function(){return this._button!==this.BUTTON_NONE?t.formatString(o.get(Z),{index:this._button+1}):this._axisIndex!==this.AXIS_NONE?t.formatString(o.get($),{index:this._axisIndex+1,direction:this._axisPositive?o.get(tt):o.get(et)}):""},c.prototype.bindsTheSameControls=function(t){return this._button===t._button&&this._axisIndex===t._axisIndex},p.prototype.getIntensityForAction=function(t,e){return this._actionNames.indexOf(e)>=0?this._staticSensitivity?void 0:t*this._sensitivityFactor:-1},d.prototype=new s,d.prototype.constructor=d,d.prototype.getDeviceName=function(){return"joystick"},d.prototype.loadFromJSON=function(t){var e;if(s.prototype.loadFromJSON.call(this,t),this._sensitivityActionGroups=[],t.sensitivityProfile&&t.sensitivityProfile.actionGroups)for(e=0;e<t.sensitivityProfile.actionGroups.length;e++)this._sensitivityActionGroups.push(new p(t.sensitivityProfile.actionGroups[e]))},d.prototype.handleGamepadConnected=function(t){this._gamepad||(this._gamepad=t.gamepad)},d.prototype.startListening=function(){s.prototype.startListening.call(this),window.addEventListener("gamepadconnected",function(t){this.handleGamepadConnected(t)}.bind(this))},d.prototype.stopListening=function(){s.prototype.stopListening.call(this),window.ongamepadconnected=null,this._gamepad=null},d.prototype.checkAction=function(t){var e,i,o;if(e=this._bindings[t].getTriggeredIntensity(this._gamepad),e>0){for(i=0;i<this._sensitivityActionGroups.length;i++)if(o=this._sensitivityActionGroups[i].getIntensityForAction(e,t),void 0===o||o>0)return{name:t,intensity:o};return{name:t,intensity:e}}return null},d.prototype.getTriggeredActions=function(t){var e;return this.isListening()?(e=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[],e&&e.length>0?this._gamepad=e[0]:this._gamepad=null,this._gamepad?s.prototype.getTriggeredActions.call(this,t):[]):[]},_.prototype.INTENSITY_NOT_SPECIFIED=-3,_.prototype.INTENSITY_KEYPRESS=-2,_.prototype.getName=function(){return this._name},_.prototype.getDescription=function(){return this._description},_.prototype.loadFromJSON=function(t){this._name=t.name,this._description=t.description,this._continuous=t.continuous===!0,this._triggered=!1,this._intensity=this.INTENSITY_NOT_SPECIFIED,this._executed=!1,this._nonTriggeredExecuted=!0},_.prototype.setTriggered=function(t,e){this._triggered=t,void 0!==e&&(this._intensity===this.INTENSITY_NOT_SPECIFIED||this._intensity>=0&&e>this._intensity)?this._intensity=e:void 0===e&&(this._intensity=this.INTENSITY_KEYPRESS)},_.prototype.setExecuteTriggered=function(t){this._executeTriggered=t},_.prototype.setExecuteNonTriggered=function(t){this._executeNonTriggered=t},_.prototype.execute=function(){this._continuous===!0?this._triggered===!0?null!==this._executeTriggered&&this._executeTriggered(this._intensity>=0?this._intensity:null):null!==this._executeNonTriggered&&this._executeNonTriggered():this._triggered===!0&&this._executed===!1?(null!==this._executeTriggered&&this._executeTriggered(this._intensity>=0?this._intensity:null),this._executed=!0):(this._triggered===!1&&this._nonTriggeredExecuted===!1&&(null!==this._executeNonTriggered&&this._executeNonTriggered(),this._nonTriggeredExecuted=!0),this._triggered===!1?this._executed=!1:this._nonTriggeredExecuted=!1),this._triggered=!1,this._intensity=this.INTENSITY_NOT_SPECIFIED},g.prototype.setContext=function(t){this._context=t},g.prototype.getType=function(){return e.showError("Attempting to get the type of a generic controller object!"),"none (generic)"},g.prototype.getActions=function(){var t,e=[];for(t in this._actions)this._actions.hasOwnProperty(t)&&e.push(this._actions[t]);return e},g.prototype.loadFromJSON=function(t){var e;for(e=0;e<t.actions.length;e++)this._actions[t.actions[e].name]=new _(t.actions[e])},g.prototype.setActionFunction=function(t,i,o){this._actions[t]?i===!0?this._actions[t].setExecuteTriggered(o):this._actions[t].setExecuteNonTriggered(o):e.showError("Attempting to initialize action '"+t+"', but no such action was defined for '"+this.getType()+"' type controllers.",e.ErrorSeverity.SEVERE,"The action definition might be missing from the settings file, or the settings file has not been loaded properly. The game is still playable, but this action will not work until the error with the settings file is corrected and the game is restarted.")},g.prototype.setActionFunctions=function(t,e,i){this.setActionFunction(t,!0,e),this.setActionFunction(t,!1,i)},g.prototype.executeActions=function(t){var e,i,o,n;for(e=0;e<t.length;e++){for(o=null,n=-1,i=0;i<t[e].length;i++)void 0!==this._actions[t[e][i].name]&&(void 0!==t[e][i].intensity&&void 0!==n&&t[e][i].intensity>n||void 0!==n&&void 0===t[e][i].intensity)&&(o=t[e][i].name,n=t[e][i].intensity);o&&((void 0===n||n>0)&&this._actions[o].setTriggered(!0,n),t[e]=[])}for(o in this._actions)this._actions.hasOwnProperty(o)&&this._actions[o].execute()},f.prototype=new i.AsyncResource,
f.prototype.constructor=f,f.prototype.registerInputInterpreterType=function(t,e){this._inputInterpreterTypes[t]=e},f.prototype.addInputInterpreter=function(i){var o=t.getKeyOfValue(this._inputInterpreterTypes,i.constructor);o?(this._inputInterpreters.push(i),this._inputInterpretersByType[o]=i):e.showError("Attempting to add an input interpreter of an unregistered type to the control context!",e.ErrorSeverity.SEVERE,"Interpreter type: "+i.constructor.name)},f.prototype.getInputInterpreters=function(){return this._inputInterpreters},f.prototype.getInputInterpreter=function(t){return this._inputInterpretersByType[t]?this._inputInterpretersByType[t]:(e.showError("Asked for a interpreter of type '"+t+"', which does not exist!"),null)},f.prototype.registerControllerType=function(t,e){this._controllerTypes[t]=e},f.prototype.addController=function(i){var o=t.getKeyOfValue(this._controllerTypes,i.constructor);o?(this._controllers.push(i),this._controllersByType[o]=i,i.setContext(this)):e.showError("Attempting to add a controller of an unregistered type to the control context!",e.ErrorSeverity.SEVERE,"Controller type: "+i.prototype.constructor.name)},f.prototype.getControllers=function(){return this._controllers},f.prototype.getController=function(t){return this._controllersByType[t]?this._controllersByType[t]:(e.showError("Asked for a controller of type '"+t+"', which does not exist!"),null)},f.prototype.makeControllerPriority=function(t){var e;for(this._controllersPriorityQueue=[],e=0;e<this._controllers.length;e++)if(this._controllers[e]===t){this._controllersPriorityQueue.push(this._controllers[e]);break}for(e=0;e<this._controllers.length;e++)this._controllers[e]!==t&&this._controllersPriorityQueue.push(this._controllers[e])},f.prototype.restoreDefaultControllerPriorityOrder=function(){this._controllersPriorityQueue=this._controllers},f.prototype.disableAction=function(t){this._disabledActions[t]=!0},f.prototype.enableAction=function(t){this._disabledActions[t]=!1},f.prototype.control=function(t){var e,i,o=function(t){return!this._disabledActions[t]}.bind(this);if(this._listening){for(i=[],e=0;e<this._inputInterpreters.length;e++)i=i.concat(this._inputInterpreters[e].getTriggeredActions(o));for(e=0;e<this._controllersPriorityQueue.length;e++)this._controllersPriorityQueue[e].executeActions(i,t)}},f.prototype.loadConfigurationFromJSON=function(t){var i,o;for(this._controllers=[],i=0,o=t.controllers.length;o>i;i++)this._controllerTypes[t.controllers[i].type]?this.addController(new this._controllerTypes[t.controllers[i].type](t.controllers[i])):e.showError("Attempting to load unregistered controller type: '"+t.controllers[i].type+"'!",e.ErrorSeverity.SEVERE,Object.keys(this._controllerTypes).length>0?"Every controller to be loaded must be of one of the registered types: "+Object.keys(this._controllerTypes).join(", ")+".":"There are no types registered and thus loading controllers is not possible.");this._controllersPriorityQueue=this._controllers},f.prototype.loadSettingsFromJSON=function(t,i){var o,n;if(i)for(o=0,n=t.inputDevices.length;n>o;o++)this._inputInterpreters[o].removeFromLocalStorage(),this._inputInterpreters[o].loadFromJSON(t.inputDevices[o]);else for(this._dataJSON=t,this._inputInterpreters=[],o=0,n=t.inputDevices.length;n>o;o++)this._inputInterpreterTypes[t.inputDevices[o].type]?this.addInputInterpreter(new this._inputInterpreterTypes[t.inputDevices[o].type](t.inputDevices[o])):e.showError("Attempting to load unregistered input device type: '"+t.inputDevices[o].type+"'!",e.ErrorSeverity.SEVERE,Object.keys(this._inputInterpreterTypes).length>0?"Every input device interpreter to be loaded must be of one of the registered types: "+Object.keys(this._inputInterpreterTypes).join(", ")+".":"There are no types registered and thus loading input interpreters is not possible.")},f.prototype.loadSettingsFromLocalStorage=function(){var t;for(t=0;t<this._inputInterpreters.length;t++)this._inputInterpreters[t].loadFromLocalStorage();this.setToReady()},f.prototype.restoreDefaults=function(){this.loadSettingsFromJSON(this._dataJSON,!0)},f.prototype.startListening=function(){this.executeWhenReady(function(){var t;for(t=0;t<this._inputInterpreters.length;t++)this._inputInterpreters[t].startListening();this._listening=!0})},f.prototype.stopListening=function(){this.executeWhenReady(function(){var t;for(t=0;t<this._inputInterpreters.length;t++)this._inputInterpreters[t].stopListening();this._listening=!1})},f.prototype.setScreenCenter=function(t,e){this.executeWhenReady(function(){var i;for(i=0;i<this._inputInterpreters.length;i++)this._inputInterpreters[i].setScreenCenter&&this._inputInterpreters[i].setScreenCenter(t,e)})},{setModulePrefix:n,ControlBinding:r,KeyBinding:a,KeyboardInputInterpreter:h,MouseBinding:l,MouseInputInterpreter:u,GamepadBinding:c,GamepadInputInterpreter:d,Controller:g,ControlContext:f}}),define("modules/camera-controller",["utils/types","modules/application","modules/control","modules/buda-scene"],function(t,e,i,o){"use strict";function n(n){i.Controller.call(this,n),this._controlledCamera=null,this._controlledVelocityVector=[0,0,0],this._velocityTargetVector=[0,0,0],this._maxSpeed=n.maxSpeed||0,this._acceleration=n.acceleration||0,this._deceleration=n.deceleration||0,this._angularVelocityVector=[0,0,0],this._maxAngularVelocity=n.maxSpin||0,this._angularAcceleration=n.angularAcceleration||0,this._angularDeceleration=n.angularDeceleration||0,this._angularVelocityTargetVector=[0,0,0],this._objectChangeTransitionDuration=n.objectChangeTransitionDuration,this._viewChangeTransitionDuration=n.viewChangeTransitionDuration,this._viewResetTransitionDuration=n.viewResetTransitionDuration,this._transitionStyle=t.getEnumValue("cameraController.transitionStyle",o.Camera.prototype.TransitionStyle,n.transitionStyle),this.setActionFunctions("controlCamera",function(){this._context?this._context.makeControllerPriority(this):e.showError("Cannot make camera controller the priority controller because it is not added to any control context!")}.bind(this),function(){this._controlledCamera.getConfiguration().shouldAutoReset()&&this._controlledCamera.transitionToConfigurationDefaults(this._viewResetTransitionDuration,this._transitionStyle),this._context?this._context.restoreDefaultControllerPriorityOrder():e.showError("Cannot restore original priority order of the camera controller's context because it is not added to any!")}.bind(this)),this.setActionFunctions("cameraTurnLeft",function(t){void 0===t||null===t?this._angularVelocityTargetVector[1]>-this._maxAngularVelocity&&(this._angularVelocityTargetVector[1]=-this._maxAngularVelocity):(this._angularVelocityTargetVector[1]=-t,this._angularVelocityVector[1]=-t)}.bind(this),function(){this._angularVelocityTargetVector[1]<0&&(this._angularVelocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraTurnRight",function(t){void 0===t||null===t?this._angularVelocityTargetVector[1]<this._maxAngularVelocity&&(this._angularVelocityTargetVector[1]=this._maxAngularVelocity):(this._angularVelocityTargetVector[1]=t,this._angularVelocityVector[1]=t)}.bind(this),function(){this._angularVelocityTargetVector[1]>0&&(this._angularVelocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraTurnUp",function(t){void 0===t||null===t?this._angularVelocityTargetVector[0]>-this._maxAngularVelocity&&(this._angularVelocityTargetVector[0]=-this._maxAngularVelocity):(this._angularVelocityTargetVector[0]=-t,this._angularVelocityVector[0]=-t)}.bind(this),function(){this._angularVelocityTargetVector[0]<0&&(this._angularVelocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraTurnDown",function(t){void 0===t||null===t?this._angularVelocityTargetVector[0]<this._maxAngularVelocity&&(this._angularVelocityTargetVector[0]=this._maxAngularVelocity):(this._angularVelocityTargetVector[0]=t,this._angularVelocityVector[0]=t)}.bind(this),function(){this._angularVelocityTargetVector[0]>0&&(this._angularVelocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraRollLeft",function(t){void 0===t||null===t?this._angularVelocityTargetVector[2]>-this._maxAngularVelocity&&(this._angularVelocityTargetVector[2]=-this._maxAngularVelocity):(this._angularVelocityTargetVector[2]=-t,this._angularVelocityVector[2]=-t)}.bind(this),function(){this._angularVelocityTargetVector[2]<0&&(this._angularVelocityTargetVector[2]=0)}.bind(this)),this.setActionFunctions("cameraRollRight",function(t){void 0===t||null===t?this._angularVelocityTargetVector[2]<this._maxAngularVelocity&&(this._angularVelocityTargetVector[2]=this._maxAngularVelocity):(this._angularVelocityTargetVector[2]=t,this._angularVelocityVector[2]=t)}.bind(this),function(){this._angularVelocityTargetVector[2]>0&&(this._angularVelocityTargetVector[2]=0)}.bind(this)),this.setActionFunctions("cameraMoveLeft",function(){this._velocityTargetVector[0]>-this._maxSpeed&&(this._velocityTargetVector[0]=-this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[0]<0&&(this._velocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraMoveRight",function(){this._velocityTargetVector[0]<this._maxSpeed&&(this._velocityTargetVector[0]=this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[0]>0&&(this._velocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraMoveUp",function(){this._velocityTargetVector[1]<this._maxSpeed&&(this._velocityTargetVector[1]=this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[1]>0&&(this._velocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraMoveDown",function(){this._velocityTargetVector[1]>-this._maxSpeed&&(this._velocityTargetVector[1]=-this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[1]<0&&(this._velocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraMoveForward",function(){this._velocityTargetVector[2]>-this._maxSpeed&&(this._velocityTargetVector[2]=-this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[2]<0&&(this._velocityTargetVector[2]=0)}.bind(this)),this.setActionFunctions("cameraMoveBackward",function(){this._velocityTargetVector[2]<this._maxSpeed&&(this._velocityTargetVector[2]=this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[2]>0&&(this._velocityTargetVector[2]=0)}.bind(this)),this.setActionFunction("cameraDecreaseFOV",!0,function(){this._controlledCamera.decreaseFOV()}.bind(this)),this.setActionFunction("cameraIncreaseFOV",!0,function(){this._controlledCamera.increaseFOV()}.bind(this)),this.setActionFunction("nextView",!0,function(){this._controlledCamera.changeToNextView(this._viewChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("previousView",!0,function(){this._controlledCamera.changeToPreviousView(this._viewChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("followNext",!0,function(){this._controlledCamera.followNextNode(!0,this._objectChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("followPrevious",!0,function(){this._controlledCamera.followPreviousNode(!0,this._objectChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("resetView",!0,function(){this._controlledCamera.transitionToConfigurationDefaults(this._viewResetTransitionDuration,this._transitionStyle)}.bind(this))}return n.prototype=new i.Controller,n.prototype.constructor=n,n.prototype.getType=function(){return"camera"},n.prototype.setControlledCamera=function(t){this._controlledCamera=t},n.prototype.setCameraToFollowObject=function(t,e,i){this._controlledCamera.followObject(t,!1,e,i)},n.prototype.setToFreeCamera=function(){this._controlledCamera.setToFreeCamera(!1)},n.prototype._updateAngularVelocity=function(t){var e;for(e=0;e<this._angularVelocityVector.length;e++)this._angularVelocityVector[e]>=0?this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]?(this._angularVelocityVector[e]+=this._angularAcceleration*t/1e3,this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])):this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]-=this._angularDeceleration*t/1e3,this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])):this._angularVelocityVector[e]<0&&(this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]?(this._angularVelocityVector[e]-=this._angularAcceleration*t/1e3,this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])):this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]+=this._angularDeceleration*t/1e3,this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])))},n.prototype._updateVelocity=function(t){var e;for(e=0;e<this._controlledVelocityVector.length;e++)this._controlledVelocityVector[e]>=0?this._controlledVelocityVector[e]<this._velocityTargetVector[e]?(this._controlledVelocityVector[e]+=this._acceleration*t/1e3,this._controlledVelocityVector[e]>this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])):this._controlledVelocityVector[e]>this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]-=this._deceleration*t/1e3,this._controlledVelocityVector[e]<this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])):this._controlledVelocityVector[e]<0&&(this._controlledVelocityVector[e]>this._velocityTargetVector[e]?(this._controlledVelocityVector[e]-=this._acceleration*t/1e3,this._controlledVelocityVector[e]<this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])):this._controlledVelocityVector[e]<this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]+=this._deceleration*t/1e3,this._controlledVelocityVector[e]>this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])))},n.prototype.executeActions=function(t,e){this._controlledCamera&&(i.Controller.prototype.executeActions.call(this,t),this._updateAngularVelocity(e),this._updateVelocity(e),this._controlledCamera.setControlledVelocityVector(this._controlledVelocityVector),this._controlledCamera.setAngularVelocityVector(this._angularVelocityVector))},{CameraController:n}}),define("armada/screens/shared",[],function(){"use strict";return{SELECTOR_SOURCE:"selector.html",SELECTOR_CSS:"selector.css",LOADING_BOX_SOURCE:"loadingbox.html",LOADING_BOX_CSS:"loadingbox.css",INFO_BOX_SOURCE:"infobox.html",INFO_BOX_CSS:"infobox.css",MENU_COMPONENT_SOURCE:"menucomponent.html",MENU_CLASS_NAME:"menu",MENU_BUTTON_CLASS_NAME:"button",MENU_BUTTON_CONTAINER_CLASS_NAME:"transparentContainer",SUPERIMPOSE_BACKGROUND_COLOR:[.25,.25,.25,.5],SCREEN_BACKGROUND_CLASS_NAME:"fullScreenFix",SCREEN_CONTAINER_CLASS_NAME:"fullScreenContainer",MAIN_MENU_SCREEN_NAME:"mainMenu",MAIN_MENU_SCREEN_SOURCE:"menu.html",MAIN_MENU_CONTAINER_ID:"menuContainer",BATTLE_SCREEN_NAME:"battle",BATTLE_SCREEN_SOURCE:"battle.html",BATTLE_SCREEN_CSS:"battle.css",DATABASE_SCREEN_NAME:"database",DATABASE_SCREEN_SOURCE:"database.html",DATABASE_SCREEN_CSS:"database.css",SETTINGS_SCREEN_NAME:"settings",SETTINGS_SCREEN_SOURCE:"menu.html",SETTINGS_MENU_CONTAINER_ID:"menuContainer",GENERAL_SETTINGS_SCREEN_NAME:"generalSettings",GENERAL_SETTINGS_SCREEN_SOURCE:"general-settings.html",GRAPHICS_SCREEN_NAME:"graphics",GRAPHICS_SCREEN_SOURCE:"graphics.html",CONTROLS_SCREEN_NAME:"controls",CONTROLS_SCREEN_SOURCE:"controls.html",ABOUT_SCREEN_NAME:"about",ABOUT_SCREEN_SOURCE:"about.html",INGAME_MENU_SCREEN_NAME:"ingameMenu",INGAME_MENU_SCREEN_SOURCE:"ingame-menu.html",INGAME_MENU_SCREEN_CSS:"ingame-menu.css",INGAME_MENU_CONTAINER_ID:"menuContainer"}}),define("armada/strings",["modules/strings"],function(t){"use strict";return t.SCREEN={BACK:{name:"screen.back"}},t.MAIN_MENU={NEW_GAME:{name:"mainMenu.newGame"},DATABASE:{name:"mainMenu.database"},SETTINGS:{name:"mainMenu.settings"},ABOUT:{name:"mainMenu.about"}},t.SETTINGS={GENERAL:{name:"settings.general"},GRAPHICS:{name:"settings.graphics"},CONTROLS:{name:"settings.controls"},DEFAULTS:{name:"settings.defaults"}},t.INGAME_MENU={TITLE:{name:"ingameMenu.title"},RESUME:{name:"ingameMenu.resume"},QUIT:{name:"ingameMenu.quit"}},t.INFO_BOX={HEADER:{name:"infoBox.header"},OK_BUTTON:{name:"infoBox.okButton"}},t.LOADING={HEADER:{name:"loading.header"},RESOURCES_START:{name:"loading.resourcesStart"},RESOURCE_READY:{name:"loading.resourceReady"},INIT_WEBGL:{name:"loading.initWebGL"},READY:{name:"loading.ready"}},t.SPACECRAFT_STATS={ARMOR:{name:"spacecraftStats.armor"}},t.BATTLE={DEVELOPMENT_VERSION_NOTICE:{name:"battle.developmentVersionNotice"},SPECTATOR_MODE:{name:"battle.spectatorMode"},PILOTING_MODE:{name:"battle.pilotingMode"},HUD_TARGET:{name:"battle.hud.target"},HUD_DISTANCE:{name:"battle.hud.distance"},HUD_VIEW:{name:"battle.hud.view"},HUD_FLIGHT_MODE:{name:"battle.hud.flightMode"},HUD_SPEED:{name:"battle.hud.speed"},LOADING_BOX_LOADING_LEVEL:{name:"battle.loadingBox.loadingLevel"},LOADING_BOX_ADDING_RANDOM_ELEMENTS:{name:"battle.loadingBox.addingRandomElements"},LOADING_BOX_BUILDING_SCENE:{name:"battle.loadingBox.buildingScene"},MESSAGE_READY:{name:"battle.message.ready"},MESSAGE_PAUSED:{name:"battle.message.paused"}},t.DATABASE={BACK:{name:"database.backButton"},TITLE:{name:"database.title"},PREV_BUTTON:{name:"database.prevButton"},NEXT_BUTTON:{name:"database.nextButton"},LOADING_BOX_INITIALIZING:{name:"database.loadingBox.initializing"},LENGTH:{name:"database.length"},MASS:{name:"database.mass"},WEAPON_SLOTS:{name:"database.weaponSlots"},THRUSTERS:{name:"database.thrusters"},MISSING_SPACECRAFT_TYPE_DESCRIPTION:{name:"database.missingSpacecraftTypeDescription"},MISSING_SPACECRAFT_CLASS_DESCRIPTION:{name:"database.missingSpacecraftClassDescription"}},t.ABOUT={BACK:{name:"about.backButton"},TITLE:{name:"about.title"},ABOUT_GAME_HEADER:{name:"about.aboutGameHeader"},VERSION_PARAGRAPH:{name:"about.versionParagraph"},ABOUT_GAME_PARAGRAPH:{name:"about.aboutGameParagraph"},ABOUT_AUTHOR_LICENSE_HEADER:{name:"about.aboutAuthorLicenseHeader"},ABOUT_AUTHOR_LICENSE_PARAGRAPH:{name:"about.aboutAuthorLicenseParagraph"},REQUIRE_JS_LICENSES:{name:"about.theNewBSDOrMITLicenses"}},t.SETTING={PREFIX:{name:"setting.",optional:!0},ON:{name:"setting.on"},OFF:{name:"setting.off"},VERY_LOW:{name:"setting.veryLow"},LOW:{name:"setting.low"},MEDIUM:{name:"setting.medium"},HIGH:{name:"setting.high"},VERY_HIGH:{name:"setting.veryHigh"},NORMAL:{name:"setting.normal"},MINIMUM:{name:"setting.minimum"},MAXIMUM:{name:"setting.maximum"},FEW:{name:"setting.few"},MANY:{name:"setting.many"}},t.GENERAL_SETTINGS={BACK:{name:"generalSettings.backButton"},TITLE:{name:"generalSettings.title"},LANGUAGE:{name:"generalSettings.language"}},t.GRAPHICS={PREFIX:{name:"graphics.",optional:!0},BACK:{name:"graphics.back"},TITLE:{name:"graphics.title"},ANTIALIASING:{name:"graphics.antialiasing"},FILTERING:{name:"graphics.filtering"},BILINEAR:{name:"graphics.bilinear"},TRILINEAR:{name:"graphics.trilinear"},ANISOTROPIC:{name:"graphics.anisotropic"},TEXTURE_QUALITY:{name:"graphics.textureQuality"},MODEL_DETAILS:{name:"graphics.modelDetails"},SHADERS:{name:"graphics.shaders"},SHADOWS:{name:"graphics.shadows"},SHADOW_QUALITY:{name:"graphics.shadowQuality"},SHADOW_DISTANCE:{name:"graphics.shadowDistance"},SHADOW_DISTANCE_VERY_CLOSE:{name:"graphics.shadowDistanceVeryClose"},SHADOW_DISTANCE_CLOSE:{name:"graphics.shadowDistanceClose"},SHADOW_DISTANCE_MEDIUM:{name:"graphics.shadowDistanceMedium"},SHADOW_DISTANCE_FAR:{name:"graphics.shadowDistanceFar"},SHADOW_DISTANCE_VERY_FAR:{name:"graphics.shadowDistanceVeryFar"},MAX_DYNAMIC_LIGHTS:{name:"graphics.maxDynamicLights"}},t.CONTOLLER={PREFIX:{name:"controller.",optional:!0},GENERAL:{name:"controller.general"},FIGHTER:{name:"controller.fighter"},CAMERA:{name:"controller.camera"}},t.INPUT={DEVICE_NAME_PREFIX:{name:"inputDevice.",optional:!0},DEVICE_KEYBOARD:{name:"inputDevice.keyboard"},DEVICE_MOUSE:{name:"inputDevice.mouse"},DEVICE_JOYSTICK:{name:"inputDevice.joystick"}},t.CONTROLS={BACK:{name:"controls.back"},TITLE:{name:"controls.title"},CONTROLLER_TYPE_HEADING:{name:"controls.controllerHeading"},ACTION:{name:"controls.action"}},t.ACTION_DESCRIPTIONS={PREFIX:{name:"actionDescriptions.",optional:!0}},t.SPACECRAFT_CLASS={PREFIX:{name:"spacecraftClass.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},t.SPACECRAFT_TYPE={PREFIX:{name:"spacecraftType.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},t.OBJECT_VIEW={PREFIX:{name:"objectView.",optional:!0}},t.FLIGHT_MODE={PREFIX:{name:"flightMode.",optional:!0}},t.getSpacecraftClassName=function(e){return t.get(t.SPACECRAFT_CLASS.PREFIX,e.getName()+t.SPACECRAFT_CLASS.NAME_SUFFIX.name,e.getFullName())},t.getSpacecraftTypeName=function(e){return t.get(t.SPACECRAFT_TYPE.PREFIX,e.getName()+t.SPACECRAFT_TYPE.NAME_SUFFIX.name,e.getFullName())},t}),define("armada/control",["modules/control","modules/camera-controller","modules/game","armada/screens/shared","armada/strings","armada/logic"],function(t,e,i,o,n,r){"use strict";function s(e){t.Controller.call(this,e),this._level=null,this._battle=null,this.setActionFunction("quit",!0,function(){this._battle.pauseBattle(),i.setScreen(o.INGAME_MENU_SCREEN_NAME,!0,o.SUPERIMPOSE_BACKGROUND_COLOR)}.bind(this)),this.setActionFunction("pause",!0,function(){i.getScreen().showMessage(n.get(n.BATTLE.MESSAGE_PAUSED))}),this.setActionFunction("stopTime",!0,function(){this._battle.toggleTime()}.bind(this)),this.setActionFunction("switchToPilotMode",!0,function(){l.switchToPilotMode(this._level.getPilotedSpacecraft())}.bind(this)),this.setActionFunction("switchToSpectatorMode",!0,function(){l.switchToSpectatorMode(!0)}),this.setActionFunction("toggleHitboxVisibility",!0,function(){this._level.toggleHitboxVisibility()}.bind(this)),this.setActionFunction("toggleTextVisibility",!0,function(){i.getScreen().toggleTextVisibility()}),this.setActionFunction("toggleMouseControls",!0,function(){l.getInputInterpreter(c).toggleEnabled(),l.isInPilotMode()&&(l.getInputInterpreter(c).isEnabled()?document.body.style.cursor="crosshair":document.body.style.cursor="default")}),this.setActionFunction("toggleJoystickControls",!0,function(){l.getInputInterpreter(p).toggleEnabled()})}function a(e){t.Controller.call(this,e),this._controlledSpacecraft=null,this.setActionFunction("fire",!0,function(){this._controlledSpacecraft.fire()}.bind(this)),this.setActionFunction("changeFlightMode",!0,function(){this._controlledSpacecraft.changeFlightMode()}.bind(this)),this.setActionFunction("nextTarget",!0,function(){this._controlledSpacecraft.targetNext()}.bind(this)),this.setActionFunctions("forward",function(t){this._controlledSpacecraft.forward(t)}.bind(this),function(){this._controlledSpacecraft.stopForward()}.bind(this)),this.setActionFunctions("reverse",function(t){this._controlledSpacecraft.reverse(t)}.bind(this),function(){this._controlledSpacecraft.stopReverse()}.bind(this)),this.setActionFunctions("strafeLeft",function(t){this._controlledSpacecraft.strafeLeft(t)}.bind(this),function(){this._controlledSpacecraft.stopLeftStrafe()}.bind(this)),this.setActionFunctions("strafeRight",function(t){this._controlledSpacecraft.strafeRight(t)}.bind(this),function(){this._controlledSpacecraft.stopRightStrafe()}.bind(this)),this.setActionFunctions("raise",function(t){this._controlledSpacecraft.raise(t)}.bind(this),function(){this._controlledSpacecraft.stopRaise()}.bind(this)),this.setActionFunctions("lower",function(t){this._controlledSpacecraft.lower(t)}.bind(this),function(){this._controlledSpacecraft.stopLower()}.bind(this)),this.setActionFunction("resetSpeed",!0,function(){this._controlledSpacecraft.resetSpeed()}.bind(this)),this.setActionFunction("yawLeft",!0,function(t){this._controlledSpacecraft.yawLeft(t)}.bind(this)),this.setActionFunction("yawRight",!0,function(t){this._controlledSpacecraft.yawRight(t)}.bind(this)),this.setActionFunction("pitchUp",!0,function(t){this._controlledSpacecraft.pitchUp(t)}.bind(this)),this.setActionFunction("pitchDown",!0,function(t){this._controlledSpacecraft.pitchDown(t)}.bind(this)),this.setActionFunction("rollLeft",!0,function(t){this._controlledSpacecraft.rollLeft(t)}.bind(this)),this.setActionFunction("rollRight",!0,function(t){this._controlledSpacecraft.rollRight(t)}.bind(this))}function h(){t.ControlContext.call(this),this._pilotingMode=!1,this.registerInputInterpreterType(u,t.KeyboardInputInterpreter),this.registerInputInterpreterType(c,t.MouseInputInterpreter),this.registerInputInterpreterType(p,t.GamepadInputInterpreter),this.registerControllerType(_,s),this.registerControllerType(g,a),this.registerControllerType(f,e.CameraController)}var l,u="keyboard",c="mouse",p="joystick",d=p,_="general",g="fighter",f="camera";return t.setModulePrefix("interstellarArmada_control_"),s.prototype=new t.Controller,s.prototype.constructor=s,s.prototype.getType=function(){return"general"},s.prototype.setLevel=function(t){this._level=t},s.prototype.setBattle=function(t){this._battle=t},a.prototype=new t.Controller,a.prototype.constructor=a,a.prototype.getType=function(){return"fighter"},a.prototype.setControlledSpacecraft=function(t){this._controlledSpacecraft=t},a.prototype.executeActions=function(e){this._controlledSpacecraft&&(this._controlledSpacecraft.canBeReused()?this._controlledSpacecraft=null:t.Controller.prototype.executeActions.call(this,e))},h.prototype=new t.ControlContext,h.prototype.constructor=h,h.prototype.isInPilotMode=function(){return this._pilotingMode},h.prototype.switchToPilotMode=function(t){t&&!this._pilotingMode&&(this._pilotingMode=!0,this.getController(g).setControlledSpacecraft(t),this.getController(f).setCameraToFollowObject(t._visualModel,r.getSetting(r.BATTLE_SETTINGS.CAMERA_PILOTING_SWITCH_TRANSITION_DURATION),r.getSetting(r.BATTLE_SETTINGS.CAMERA_PILOTING_SWITCH_TRANSITION_STYLE)),this.disableAction("followNext"),this.disableAction("followPrevious"),i.getScreen().setHeaderContent(n.get(n.BATTLE.PILOTING_MODE),{spacecraftClass:n.getSpacecraftClassName(t.getClass()),spacecraftType:n.getSpacecraftTypeName(t.getClass().getSpacecraftType())}),i.getScreen().showUI(),this.getInputInterpreter(c).isEnabled()&&(document.body.style.cursor="crosshair"))},h.prototype.switchToSpectatorMode=function(t){this._pilotingMode=!1,this.getController(g).setControlledSpacecraft(null),t&&this.getController(f).setToFreeCamera(!1),this.enableAction("followNext"),this.enableAction("followPrevious"),i.getScreen().setHeaderContent(n.get(n.BATTLE.SPECTATOR_MODE)),i.getScreen().hideUI(),document.body.style.cursor="default"},l=new h,{KEYBOARD_NAME:u,MOUSE_NAME:c,JOYSTICK_NAME:p,GAMEPAD_NAME:d,GENERAL_CONTROLLER_NAME:_,FIGHTER_CONTROLLER_NAME:g,CAMERA_CONTROLLER_NAME:f,KeyBinding:t.KeyBinding,loadConfigurationFromJSON:l.loadConfigurationFromJSON.bind(l),loadSettingsFromJSON:l.loadSettingsFromJSON.bind(l),loadSettingsFromLocalStorage:l.loadSettingsFromLocalStorage.bind(l),restoreDefaults:l.restoreDefaults.bind(l),getControllers:l.getControllers.bind(l),getController:l.getController.bind(l),getInputInterpreters:l.getInputInterpreters.bind(l),getInputInterpreter:l.getInputInterpreter.bind(l),control:l.control.bind(l),startListening:l.startListening.bind(l),stopListening:l.stopListening.bind(l),setScreenCenter:l.setScreenCenter.bind(l),executeWhenReady:l.executeWhenReady.bind(l),switchToPilotMode:l.switchToPilotMode.bind(l),switchToSpectatorMode:l.switchToSpectatorMode.bind(l)}}),define("armada/armada",["modules/game","modules/components","armada/constants","armada/graphics","armada/logic","armada/control","armada/strings"],function(t,e,i,o,n,r,s){"use strict";var a=document.getElementById("progress");return a.max=5,t.setGameName(i.GAME_NAME),t.setStartScreenName("mainMenu"),t.setConfigFolder("config/"),t.setConfigFileName("config.json"),t.setFileCacheBypassEnabled(!0),t._loadGameSettingsAndExecuteCallback=function(t,e){o.loadSettingsFromJSON(t.graphics),o.loadSettingsFromLocalStorage(),n.loadSettingsFromJSON(t.logic),r.loadSettingsFromJSON(t.control),r.loadSettingsFromLocalStorage(),n.executeWhenReady(function(){a.value=2,e()})},t._loadGameConfigurationAndExecuteCallback=function(t,e){n.loadConfigurationFromJSON(t.dataFiles.logic),r.loadConfigurationFromJSON(t.control),a.value=1,e()},t._buildScreensAndExecuteCallback=function(o){require(["armada/screens/menus","armada/screens/battle","armada/screens/database","armada/screens/general-settings","armada/screens/graphics-settings","armada/screens/control-settings","armada/screens/about"],function(n,r,h,l,u,c,p){t.addScreen(n.mainMenuScreen),t.addScreen(r.battleScreen),t.addScreen(h.databaseScreen),t.addScreen(n.settingsMenuScreen),t.addScreen(l.generalSettingsScreen),t.addScreen(u.graphicsScreen),t.addScreen(c.controlsScreen),t.addScreen(p.aboutScreen),t.addScreen(n.ingameMenuScreen),a.value=3,t.executeWhenAllScreensReady(function(){a.value=4,t.requestLanguageChange(localStorage.getItem(i.LANGUAGE_LOCAL_STORAGE_ID)||t.getDefaultLanguage(),s,function(){a.value=5,e.clearStoredDOMModels(),o()})})})},t}),require(["armada/armada"],function(t){"use strict";t.initialize()}),define("main",function(){});