define("modules/application",[],function(){"use strict";function t(t,e){(!e||e<=a)&&console.log(t)}var e,i,s,n={CRITICAL:"critical",SEVERE:"severe",MINOR:"minor"},o=null,r=!0,a=0,l="",h=!0,u=!1;return{ErrorSeverity:n,getFolder:function(t){return t.length>0&&"/"===t[t.length-1]?t:o?void 0!==o[t]?o[t]:(this.showError("Asked for folder for file type '"+t+"', and folder for such files is not registered!",n.SEVERE),null):(this.log("Looking for the folder assigned to file type '"+t+"', but there are no folders specified in the application configuration. Will use the folder with the same name as the file type."),t+"/")},setFolders:function(t){var e="",i=function(e,s,o){var r=-1,a=-1,l="",h="";for(o=o||[];e.indexOf("{{")>=0;){if(!(e.indexOf("}}")>=0))return this.showError("Invalid folder name specified! Cannot resolve: '"+e+"'",n.SEVERE,"References to other folders must be surrounded by {{ and }}."),null;if(r=e.indexOf("{{"),a=e.indexOf("}}"),h=e.substring(r+2,a),!(l=t[h]))return this.showError("Invalid folder name specified! Cannot find referenced folder '"+e.substring(r+2,a)+"' in "+e+"!",n.SEVERE),null;if(!(o.indexOf(h)<0))return this.showError("Circular reference detected among the following folders: "+o.concat(s).join(", "),n.SEVERE),null;e=e.replace(e.substring(r,Math.min(a+3,e.length)),i(l,h,o.concat(s)))}return e}.bind(this);o={};for(e in t)t.hasOwnProperty(e)&&(o[e]=i(t[e],e))},setFileCacheBypassEnabled:function(t){r=t},setLogVerbosity:function(t){a=t},getVersion:function(){return l},getVersionURLArg:function(){return"v="+this.getVersion().split(" ")[0]},setVersion:function(t){l=t,requirejs.config({urlArgs:this.getVersionURLArg()})},setPreviouslyRunVersion:function(t){e=t,i=void 0===e},isFirstRun:function(){return i},hasVersionChanged:function(){if(void 0!==i)return e!==l;this.showError("Cannot determine whether the game version has changed, because the previously ran version is not set!")},setDebugVersion:function(t){h=t},setReleases:function(t){s=t},getNewReleases:function(){var t,i=[];for(t=0;t<s.length;t++)s[t]>e.substr(0,5)&&i.push(s[t]);return i},usesElectron:function(){return u},useElectron:function(t){u=t},getFileURL:function(t,e){return this.getFolder(t)+(e+(r||!this.getVersion()?"?t="+performance.now():"?"+this.getVersionURLArg()))},showError:function(t,e,i){var s="Error: "+t+(i?"\n\n"+i+"\n\n":"\n\n");switch(e){case n.CRITICAL:s+="Unfortunately this is a critical error.\nThe application is not functional until this error is resolved.";break;case n.SEVERE:s+="This is a severe error.\nThe application might produce unexpected behaviour from this point on. It is recommended that you restart the application by refreshing the page in your browser.";break;case n.MINOR:s+="This is a minor error.\nThe application might be fully functional, but you might need to readjust some settings or take some other actions depending on the explanation of the error.";break;default:s+="The severity of this error cannot be determined.\nThe application might produce unexpected behaviour from this point on. It is recommended that you restart the application by refreshing the page in your browser."}alert(s)},log:t,log_DEBUG:t,requestFile:function(t,e,i,s,o){this.log("Requesting file: '"+e+"' from "+(""!==this.getFolder(t)?"folder: '"+this.getFolder(t):"root folder")+"'...",2);var r=new XMLHttpRequest;r.onload=function(){this.log("File: '"+e+"' successfully loaded.",2),i(r)}.bind(this),r.onerror=function(){this.showError("An error occured while trying to load file: '"+e+"'.",n.SEVERE,"The status of the request was: '"+r.statusText+"' when the error happened."),i()}.bind(this),r.ontimeout=function(){this.showError("Request to load the file: '"+e+"' timed out.",n.SEVERE),i()}.bind(this),s&&r.overrideMimeType(s),o&&(r.responseType=o),r.open("GET",this.getFileURL(t,e),!0),r.send(null)},requestTextFile:function(t,e,i,s){this.requestFile(t,e,function(t){i(t?t.responseText:null)},s||"text/plain; charset=utf-8")},requestCSSFile:function(t,e,i){var s;0===document.head.querySelectorAll("link[href='"+this.getFileURL(t,e)+"']").length?(s=document.createElement("link"),s.setAttribute("rel","stylesheet"),s.setAttribute("type","text/css"),s.onload=i,s.href=this.getFileURL(t,e),document.head.appendChild(s)):i&&i()}}}),define("modules/async-resource",[],function(){"use strict";function t(){this._readyToUse=!1,this._onReadyQueue=[],this._triggeredOnreadyQueueLength=0}return t.prototype.addOnReadyFunction=function(t){this._onReadyQueue.push(t)},t.prototype.resetReadyState=function(){this._readyToUse=!1},t.prototype.executeOnReadyQueue=function(){var t;for(this._triggeredOnreadyQueueLength=this._onReadyQueue.length,t=0;t<this._triggeredOnreadyQueueLength;t++)this._onReadyQueue[t]&&this._onReadyQueue[t].call(this),this._onReadyQueue[t]=null;this._onReadyQueue=this._onReadyQueue.length>this._triggeredOnreadyQueueLength?this._onReadyQueue.slice(this._triggeredOnreadyQueueLength):[]},t.prototype.setToReady=function(){!1===this._readyToUse&&(this._readyToUse=!0,this.executeOnReadyQueue())},t.prototype.executeWhenReady=function(t,e,i){return this._readyToUse?i?(setTimeout(t.bind(this),0),!1):(t.call(this),!0):(this.addOnReadyFunction(t),void 0!==e&&e.call(this),!1)},{AsyncResource:t}}),define("modules/screen-manager",["modules/async-resource","modules/application"],function(t,e){"use strict";function i(){t.AsyncResource.call(this),this._screens={},this._coveredScreens=[],this._currentScreen=null,this._screensLoaded=0,this._screensToLoad=0}var s;return i.prototype=new t.AsyncResource,i.prototype.constructor=i,i.prototype.getScreen=function(t){return t?this._screens[t]:this._currentScreen},i.prototype.addScreen=function(t,e,i){var s=function(){++this._screensLoaded===this._screensToLoad&&this.setToReady()}.bind(this);this.resetReadyState(),this._screensToLoad++,this._screens[t._name]=t,t.addScreenToPage(s,e,i),this._currentScreen||(this._currentScreen=t,this._currentScreen.setActive(!0))},i.prototype.setCurrentScreen=function(t,i,s){var n,o=this.getScreen(t);if(!o)return void e.showError("Cannot switch to screen '"+t+"', because it does not exist!");if(!0!==i&&null!==this._currentScreen)for(this._currentScreen.hide(),n=0;n<this._coveredScreens.length;n++)this._coveredScreens[n].hide();!0===i?(this._coveredScreens.push(this._currentScreen),this._currentScreen.setActive(!1),this._currentScreen=o,o.superimposeOnPage(s)):(this._currentScreen=o,o.show()),this._currentScreen===o&&this._currentScreen.setActive(!0)},i.prototype.closeSuperimposedScreen=function(){this._currentScreen.hide(),this._currentScreen=this._coveredScreens.pop(),this._currentScreen.setActive(!0)},i.prototype.closeOrNavigateTo=function(t){this._currentScreen.isSuperimposed()?this.closeSuperimposedScreen():this.setCurrentScreen(t)},i.prototype.updateAllScreens=function(){var t;for(t in this._screens)this._screens.hasOwnProperty(t)&&this._screens[t].updateScreen()},s=new i,{getScreen:s.getScreen.bind(s),addScreen:s.addScreen.bind(s),setCurrentScreen:s.setCurrentScreen.bind(s),closeSuperimposedScreen:s.closeSuperimposedScreen.bind(s),closeOrNavigateTo:s.closeOrNavigateTo.bind(s),updateAllScreens:s.updateAllScreens.bind(s),executeWhenReady:s.executeWhenReady.bind(s)}}),define("utils/utils",[],function(){"use strict";var t={WIDTH:"width",HEIGHT:"height",ASPECT:"aspect",MINIMUM:"minimum",MAXIMUM:"maximum"},e={LEFT:1,MIDDLE:2,RIGHT:3},i=[],s={},n=180/Math.PI,o=Math.PI/180,r=.5*Math.PI,a=2*Math.PI,l={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,"caps lock":20,escape:27,space:32,"page up":33,"page down":34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,"left window":91,"right window":92,select:93,"numpad 0":96,"numpad 1":97,"numpad 2":98,"numpad 3":99,"numpad 4":100,"numpad 5":101,"numpad 6":102,"numpad 7":103,"numpad 8":104,"numpad 9":105,"numpad *":106,"numpad +":107,"numpad -":109,"numpad /":111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,";":186,"=":187,",":188,"-":189,".":190,"/":191,"`":192,"[":219,"\\":220,"]":221,"'":222},h={};return h.EMPTY_ARRAY=i,h.EMPTY_STRING="",h.EMPTY_OBJECT=s,h.DEG=n,h.RAD=o,h.HALF_PI=r,h.DOUBLE_PI=a,h.ScaleMode=t,h.MouseButton=e,h.scalesWithWidth=function(e,i,s){return e===t.WIDTH||e===t.MINIMUM&&i<s||e===t.MAXIMUM&&i>=s},h.xScalesWithWidth=function(e,i,s){return e===t.ASPECT||e===t.WIDTH||e===t.MINIMUM&&i<s||e===t.MAXIMUM&&i>=s},h.yScalesWithHeight=function(e,i,s){return e===t.ASPECT||e===t.HEIGHT||e===t.MINIMUM&&s<i||e===t.MAXIMUM&&s>=i},h.getKeyCodeOf=function(t){return t?"#"===t[0]?parseInt(t.slice(1),10):l[t]:-1},h.getKeyOfCode=function(t){var e;for(e in l)if(l[e]===t)return e;return"#"+t},h.arraysEqual=function(t,e){var i,s;if(!e)return!1;if(t.length!==e.length)return!1;for(i=0,s=t.length;i<s;i++)if(t[i]instanceof Array&&e[i]instanceof Array){if(!t[i].equals(e[i]))return!1}else if(t[i]!==e[i])return!1;return!0},h.objectsEqual=function(t,e){var i,s,n;if(null===t&&null===e)return!0;if(!t)return!1;if(i=Object.keys(t).sort(),!e)return!1;if(s=Object.keys(e).sort(),i.length!==s.length)return!1;for(n=0;n<i.length;n++)if(i[n]!==s[n]||t[i[n]]!==e[s[n]])return!1;return!0},h.equivalent=function(t,e){var i,s,n,o;if("object"==typeof t&&"object"==typeof e){if(null===t||null===e)return t===e;if(t instanceof Array&&e instanceof Array){if(t.length!==e.length)return!1;for(i=0,s=t.length;i<s;i++)if(!h.equivalent(t[i],e[i]))return!1;return!0}if(n=Object.keys(t).sort(),o=Object.keys(e).sort(),n.length!==o.length)return!1;for(i=0,s=n.length;i<s;i++)if(n[i]!==o[i]||!h.equivalent(t[n[i]],e[o[i]]))return!1;return!0}return t===e},h.shallowCopy=function(t){var e,i,s;if("object"==typeof t){if(t instanceof Array)return t.slice();for(e={},s=Object.keys(t),i=0;i<s.length;i++)e[s[i]]=t[s[i]];return e}return t},h.deepCopy=function(t){var e,i,s;if("object"==typeof t){if(t instanceof Array){for(e=[],i=0;i<t.length;i++)e.push(h.deepCopy(t[i]));return e}for(e={},s=Object.keys(t),i=0;i<s.length;i++)e[s[i]]=h.deepCopy(t[s[i]]);return e}return t},h.removeFromArray=function(t,e){var i=t.indexOf(e);return i>=0&&(t.splice(i,1),!0)},h.getSafeEnumValue=function(t,e,i){var s;i=i?h.getSafeEnumValue(t,i):null;for(s in t)if(t.hasOwnProperty(s)&&e===t[s])return e;return i||null},h.getSafeEnumValueForKey=function(t,e,i){return i=void 0!==i?h.getSafeEnumValue(t,i):null,e&&(e=h.constantName(e),t.hasOwnProperty(e))?t[e]:void 0!==i?i:null},h.getEnumValues=function(t){var e,i=[];for(e in t)t.hasOwnProperty(e)&&i.push(t[e]);return i},h.getEnumKeys=function(t){var e,i=Object.keys(t);for(e=0;e<i.length;e++)i[e]=h.camelCase(i[e]);return i},h.getEnumObject=function(t){var e,i={};for(e=0;e<t.length;e++)i[t[e]]=t[e];return i},h.getKeyOfValue=function(t,e){var i;for(i in t)if(t.hasOwnProperty(i)&&t[i]===e)return i;return null},h.getPaddedStringForNumber=function(t,e,i){var s,n=t.toString(i||10);for(s=n.length;s<e;s++)n="0"+n;return n},h.getDelimitedStringForNumber=function(t){return t>=1e3?h.getDelimitedStringForNumber(Math.floor(t/1e3))+" "+h.getPaddedStringForNumber(t%1e3,3):t.toString()},h.getLengthString=function(t){return t<2e3?t<100?t.toPrecision(3)+" m":Math.round(t)+" m":t<1e5?(t/1e3).toPrecision(3)+" km":h.getDelimitedStringForNumber(Math.round(t/1e3))+" km"},h.getMassString=function(t){return t<2e3?t<100?t.toPrecision(3)+" kg":Math.round(t)+" kg":t<1e5?(t/1e3).toPrecision(3)+" t":h.getDelimitedStringForNumber(Math.round(t/1e3))+" t"},h.getTimeString=function(t){return t<1e3?t+" ms":t<6e4?Math.round(t/10)/100+" s":h.formatTimeToMinutes(t)},h.constantName=function(t){var e,i="";for(e=0;e<t.length;e++)t[e].match(/[A-Z]/)&&(i+="_"),i+=" "===t[e]||"-"===t[e]?"_":t[e].toUpperCase();return i},h.camelCase=function(t){var e,i="",s=!1;for(e=0;e<t.length;e++)"_"===t[e]?s=!0:(i+=s?t[e]:t[e].toLowerCase(),s=!1);return i},h.formatString=function(t,e){var i,s=t.toString();for(i in e)e.hasOwnProperty(i)&&(s=s.replace(new RegExp("\\{"+i+"\\}","gi"),e[i]));return s},h.formatTimeToMinutes=function(t){var e,i;return e=Math.floor(t/6e4),i=Math.floor(t/1e3)%60,h.getPaddedStringForNumber(e,2)+":"+h.getPaddedStringForNumber(i,2)},h.formatTimeToSeconds=function(t){var e,i;return e=Math.floor(t/1e3)%60,i=Math.floor(t%1e3/10),h.getPaddedStringForNumber(e,2)+"."+h.getPaddedStringForNumber(i,2)},h.executeAsync=function(t){setTimeout(t,0)},h.pointInRect=function(t,e,i,s,n,o){return t>=i&&t<=n&&e>=s&&e<=o},h.getFilenameWithoutExtension=function(t){var e=t.lastIndexOf("."),i=t.lastIndexOf("/");return t=e>0?t.substr(0,e):t,t=i>0?t.substr(i+1):t},h.getLinearMix=function(t,e,i){return t*(1-i)+e*i},h.getMixedColor=function(t,e,i){var s=1-i;return[t[0]*s+e[0]*i,t[1]*s+e[1]*i,t[2]*s+e[2]*i,t[3]*s+e[3]*i]},h.getLuminance=function(t){return.299*t[0]+.587*t[1]+.114*t[2]},h.filterColor=function(t,e){return t[0]*=e[0],t[1]*=e[1],t[2]*=e[2],t[3]*=e[3],t},h.gammaCorrect=function(t,e){return t[0]=Math.pow(t[0],1/e),t[1]=Math.pow(t[1],1/e),t[2]=Math.pow(t[2],1/e),t},h.getCSSColor=function(t){return"rgba("+Math.round(255*t[0])+","+Math.round(255*t[1])+","+Math.round(255*t[2])+","+t[3]+")"},h.getHexColor=function(t){return"#"+h.getPaddedStringForNumber(Math.round(255*t[0]),2,16)+h.getPaddedStringForNumber(Math.round(255*t[1]),2,16)+h.getPaddedStringForNumber(Math.round(255*t[2]),2,16)},h.getColor3FromHex=function(t){var e=[0,0,0];return e[0]=parseInt(t.substr(1,2),16)/255,e[1]=parseInt(t.substr(3,2),16)/255,e[2]=parseInt(t.substr(5,2),16)/255,e},h.getGreaterSolutionOfQuadraticEquation=function(t,e,i){var s=e*e-4*t*i;return s>=0?(Math.sqrt(s)-e)/(2*t):NaN},h.getSmallestPositiveSolutionOf4thDegreeEquationWithoutDegree3=function(t,e,i,s){var n,o,r,a,l,h,u,c,_,d,p,g,m=e/t,f=i/t,S=s/t,T=-m*m/48-S/4,E=-m*m*m/864-f*f/64+m*S/24,y=E*E/4+T*T*T/27;return y>=0?0===f&&m>0&&S===m*m/4?NaN:(n=Math.sqrt(y),o=Math.cbrt(-E/2+n),r=Math.cbrt(-E/2-n),l=m/6+2*(o+r),a=Math.sqrt(-m/3-(o+r)+Math.sqrt(l*l-S)),l=(f>0?-1:1)*Math.sqrt(-m/6+o+r),h=l+a,u=l-a,h<0?u:u<0?h:Math.min(h,u)):(l=2*Math.sqrt(-T/3),a=1/3*Math.acos(-E/2/Math.sqrt(-Math.pow(T/3,3))),c=-m/6+l*Math.cos(a),_=-m/6+l*Math.cos(2*Math.PI/3+a),d=-m/6+l*Math.cos(4*Math.PI/3+a),S>m*m/4||m>0?NaN:(l=(f>0?-1:1)*Math.sqrt(c),_=Math.sqrt(_),d=Math.sqrt(d),a=_+d,h=l+a,u=l-a,a=_-d,p=-l+a,g=-l-a,h<0?u<0?p<0?g<0?NaN:g:g<0?p:Math.min(p,g):p<0?g<0?u:Math.min(u,g):g<0?Math.min(u,p):Math.min(u,p,g):u<0?p<0?g<0?h:Math.min(h,g):g<0?Math.min(h,p):Math.min(h,p,g):p<0?g<0?Math.min(h,u):Math.min(h,u,g):g<0?Math.min(h,u,p):Math.min(h,u,p,g)))},h.areTouchEventsSupported=function(){return"ontouchstart"in window},h}),define("utils/types",["utils/utils","modules/application"],function(t,e){"use strict";function i(t,e,i,s){return"Invalid value for '"+t+"' ("+e+")"+(s?": "+s:".")+" Using default value "+i+" instead."}function s(t,s,n,o){e.showError(i(t,s,n,o))}function n(t,e,i,s){return"Invalid value for '"+e+"'. Expected "+t+", got a(n) "+("object"==typeof i?i.constructor.name:typeof i)+" ("+i+"). Using default value "+(s instanceof Array?"["+s.join(", ")+"]":"'"+s+"'")+" instead."}function o(t,i,s,o){e.showError(n(t,i,s,o))}function r(e,i,s,n){return"Unrecognized '"+e+"' value: '"+i+"'. Possible values are are: "+t.getEnumValues(s).join(", ")+". Default value '"+n+"' will be used instead."}function a(t,i,s,n){e.showError(r(t,i,s,n))}var l={CHECK_FAIL_ERROR:"checkFailError",TYPE_ERROR:"typeError",ENUM_VALUE_ERROR:"enumValueError",INVALID_ENUM_OBJECT_ERROR:"invalidEnumObjectError"},h={Errors:l};return h.NUMBER="number",h.VECTOR2={baseType:"array",length:2,elementType:"number"},h.VECTOR3={baseType:"array",length:3,elementType:"number"},h.COLOR3={baseType:"array",length:3,elementType:"number",elementTypeParams:{range:[0,1]}},h.COLOR4={baseType:"array",length:4,elementType:"number",elementTypeParams:{range:[0,1]}},h.DURATION={baseType:"number",range:[0,void 0]},h.ANGLE_DEGREES={baseType:"number",range:[-360,360]},h.getBooleanValue=function(t,e){if(e=e||{},e.name=e.name||"unnamed boolean","boolean"==typeof t){if(!e.checkFunction||e.checkFunction(t,e.parentObject))return t;e.error=l.CHECK_FAIL_ERROR,e.silentFallback?(e.name,e.defaultValue,e.checkFailMessage):s(e.name,t,e.defaultValue,e.checkFailMessage)}else e.error=l.TYPE_ERROR,e.silentFallback?(e.name,e.defaultValue):o("a boolean",e.name,t,e.defaultValue);return null!==e.defaultValue?(t=e.defaultValue,e.defaultValue=null,h.getBooleanValue(t,e)):null},h.getNumberValue=function(t,e,i,n,r,a,l){return"number"==typeof e?n&&!n(e,a)?(s(t,e,i,r),null!==i?h.getNumberValue(t,i,null,n,r,a):null):e:("number"==typeof i&&l||o("a number",t,e,i),null!==i?h.getNumberValue(t,i,null,n,r,a):null)},h.getNumberValueInRange=function(t,i,n,r,a,l,u,c){return"number"==typeof i?((void 0!==n&&i<n||void 0!==r&&i>r)&&(e.showError("Invalid value for "+t+": out of range ("+(void 0!==n?n:"...")+"-"+(void 0!==r?r:"...")+"). The setting will be changed to fit the valid range."),void 0!==n&&(i=Math.max(n,i)),void 0!==r&&(i=Math.min(i,r))),l&&!l(i,c)?(s(t,i,a,u),null!==a?h.getNumberValueInRange(t,a,n,r,null,l,u,c):null):i):(o("a number",t,i,a),null!==a?h.getNumberValueInRange(t,a,n,r,null,l,u,c):null)},h.getStringValue=function(t,e,i,n,r,a){return"string"==typeof e?n&&!n(e,a)?(s(t,e,i,r),null!==i?h.getStringValue(t,i,null,n,r,a):null):e:(o("a string",t,e,i),null!==i?h.getStringValue(t,i,null,n,r,a):null)},h.getEnumValue=function(i,n,o){var r=t.getSafeEnumValue(i,n);if(o=o||{},o.name=o.name||"unnamed enum "+i.constructor.name,null!==r){if(!o.checkFunction||o.checkFunction(r,o.parentObject))return r;o.error=l.CHECK_FAIL_ERROR,o.silentFallback?(o.name,o.defaultValue,o.checkFailMessage):s(o.name,r,o.defaultValue,o.checkFailMessage)}else{if("object"!=typeof i||0===Object.keys(i).length)return o.error=l.INVALID_ENUM_OBJECT_ERROR,e.showError("Invalid enum object specified for "+o.name+": "+i+", and thus its value ("+n+") cannot be verified!"),null;o.error=l.ENUM_VALUE_ERROR,o.silentFallback?(o.name,o.defaultValue):a(o.name,n,i,o.defaultValue)}return null!==o.defaultValue?(n=o.defaultValue,o.defaultValue=null,h.getEnumValue(i,n,o)):null},h.getObjectValue=function(t,e,i,n,r,a){return"object"==typeof e?n&&!n(e,a)?(s(t,e,i,r),null!==i?h.getObjectValue(t,i,null,n,r,a):null):e:(o("an object",t,e,i),null!==i?h.getObjectValue(t,i,null,n,r,a):null)},h.getValueOfType=function(t,i,s,n,o,r,a,l,u){if(r=r||{},void 0===s)return void 0!==n?null!==n?h.getValueOfType(t,i,n,null,o,r,a,l,u):null:void(o||e.showError("Missing required value of '"+t+"'!"));if("object"==typeof i)return i.baseType?h.getValueOfType(t,i.baseType,s,n,o,i,a,l,u):h.getVerifiedObject(t,s,i);switch(i){case"boolean":return h.getBooleanValue(s,{name:t,defaultValue:n,checkFunction:a,checkFailMessage:l,parentObject:u});case"number":return r.range?h.getNumberValueInRange(t,s,r.range[0],r.range[1],n,a,l,u):h.getNumberValue(t,s,n,a,l,u);case"string":return h.getStringValue(t,s,n,a,l,u);case"enum":return r.values?h.getEnumValue(r.values,s,{name:t,defaultValue:n,checkFunction:a,checkFailMessage:l,parentObject:u}):(e.showError("Missing enum definition object for '"+t+"'!"),null);case"object":return r.properties?h.getVerifiedObject(t,s,r.properties):h.getObjectValue(t,s,n,a,l,u);case"array":return h.getArrayValue(t,s,r.elementType,r.elementTypeParams,r,n,a,l,r.elementCheck,r.elementCheckFailMessage,u);default:return e.showError("Unknown type specified for '"+t+"': "+i),null}},h.getArrayValue=function(t,i,n,r,a,l,u,c,_,d,p){var g,m=[];if(i instanceof Array){if(void 0!==a){if(void 0!==a.length&&i.length!==a.length)return e.showError("Invalid array length for '"+t+"'! Expected a length of "+a.length+" and got "+i.length+(l?". Using default value ["+l.join(", ")+"] instead.":".")),l?h.getArrayValue(t,l,n,r,a,null,u,c,_,d,p):null;if(void 0!==a.minLength&&i.length<a.minLength)return e.showError("Invalid array length for '"+t+"'! Expected a minimum length of "+a.minLength+" and got "+i.length+(l?". Using default value ["+l.join(", ")+"] instead.":".")),l?h.getArrayValue(t,l,n,r,a,null,u,c,_,d,p):null;if(void 0!==a.maxLength&&i.length>a.maxLength)return e.showError("Invalid array length for '"+t+"'! Expected a maximum length of "+a.maxLength+" and got "+i.length+(l?". Using default value ["+l.join(", ")+"] instead.":".")),l?h.getArrayValue(t,l,n,r,a,null,u,c,_,d,p):null}return void 0!==n&&(i.forEach(function(e,i){null!==(g=h.getValueOfType(t+"["+i+"]",n,e,null,!1,r,_,d,p))&&m.push(g)}),i=m),u&&!u(i)?(s(t,i,"["+l.join(", ")+"]",c),null!==l?h.getArrayValue(t,l,n,r,a,null,u,c,_,d,p):null):i}return o("an array",t,i,l),null!==l?h.getArrayValue(t,l,n,r,a,null,u,c,_,d,p):null},h.getVerifiedObject=function(t,i,s,n,o,r,a){var l,u,c,_,d,p,g=n||{},m=[];if("object"==typeof i){for(u in s)if(s.hasOwnProperty(u)){if(c=s[u],g[c.name]&&e.showError("'"+t+"' already has a property named '"+c.name+"', which will be overridden by a new value!"),!c.type&&!a)for(_={},p=Object.keys(c),d=0;d<p.length;d++)"object"==typeof c[p[d]]&&(_[p[d]]=c[p[d]]);g[c.name]=h.getValueOfType(t+"."+c.name,c.type||_||a,i[c.name],c.defaultValue,c.optional,{range:c.range,values:c.values,elementType:c.elementType,elementEnumObject:c.elementEnum,length:c.length,minLength:c.minLength,maxLength:c.maxLength,elementCheck:c.elementCheck,elementCheckFailMessage:c.elementCheckFailMessage,properties:c.properties},c.check,c.checkFailMessage,i),m.push(c.name)}if(!r||o)for(l in i)i.hasOwnProperty(l)&&m.indexOf(l)<0&&(r||e.showError("Unrecognized property '"+l+"' defined for '"+t+"'. The value of this property "+(a?"can be verified only against the default property type":"cannot be verified ")+(o?"but will be included.":"and will be discarded.")),o&&(g[l]=a?h.getValueOfType(t+"."+l,a,i[l]):i[l]));return g}return e.showError("Invalid value for '"+t+"'. Expected an object, got a(n) "+typeof i+" ("+i+")."),null},h.getBooleanValueFromLocalStorage=function(t,e){var i;return i=localStorage[t]===(!0).toString()||localStorage[t]!==(!1).toString()&&localStorage[t],e=e||{},e.name=e.name||"localStorage."+t,h.getBooleanValue(i,e)},h.getNumberValueFromLocalStorage=function(t,e){var i=parseFloat(localStorage[t]);return isNaN(i)&&(i=localStorage[t]),e=e||{},e.name=e.name||"localStorage."+t,h.getNumberValue(e.name,i,e.defaultValue,e.checkFunction,e.checkFailMessage,e.parentObject,e.silentFallback)},h.getEnumValueFromLocalStorage=function(t,e,i){return i=i||{},i.name=i.name||"localStorage."+e,h.getEnumValue(t,localStorage[e],i)},h.getStringValueFromLocalStorage=function(t,e){return e=e||{},e.name=e.name||"localStorage."+t,h.getStringValue(e.name,localStorage[t],e.defaultValue,e.checkFunction,e.checkFailMessage)},h.getValueOfTypeFromLocalStorage=function(t,e,i){if("object"==typeof t)return i.values=t.values,h.getValueOfTypeFromLocalStorage(t.baseType,e,i);switch(t){case"boolean":return h.getBooleanValueFromLocalStorage(e,i);case"number":return h.getNumberValueFromLocalStorage(e,i);case"enum":return h.getEnumValueFromLocalStorage(i.values,e,i);case"string":return h.getStringValueFromLocalStorage(e,i)}},h.getNameAndValueDefinitionObject=function(t){return{baseType:"object",properties:{NAME:{name:"name",type:"string"},VALUE:{name:t,type:"number"}}}},h.getEnumObjectForArray=function(t){var e,i={};for(e=0;e<t.length;e++)i[t[e]]=t[e];return i},h}),define("modules/strings",["utils/types","modules/application"],function(t,e){"use strict";function i(t){var e,n;for(e in t)if(t.hasOwnProperty(e)&&"object"==typeof t[e]){i(t[e]);for(n in t[e])t[e].hasOwnProperty(n)&&(t[e+s+n]=t[e][n]);delete t[e]}}var s=".",n={},o=null,r={},a={};return n.getLanguage=function(){return o},n.setLanguage=function(t){a.hasOwnProperty(t)?o=t:e.showError("Cannot set language to '"+t+"', as there are no strings loaded for that language!")},n.languageIsLoaded=function(t){return a.hasOwnProperty(t)},n.loadStrings=function(e,s,l){var h;r[e]={},i(s);for(h in l)l.hasOwnProperty(h)&&"object"==typeof l[h]&&t.getVerifiedObject("strings."+h,s,l[h],r[e],!1,!0,"string");a[e]=t.getVerifiedObject("strings."+h,s,{},null,!0,!0,"string"),o||n.setLanguage(e)},n.get=function(t,e,i){return a[o]&&a[o][t.name+(e||"")]||i||t.defaultValue||t.name+(e||"")},n.has=function(t,e){return a[o]&&void 0!==a[o][t.name+(e||"")]},n.getKeys=function(t){return Object.keys(a[o]).filter(function(e){return 0===e.indexOf(t)})},n.CATEGORY_SEPARATOR=s,n}),define("modules/game",["modules/application","modules/screen-manager","modules/strings"],function(t,e,i){"use strict";var s=!1,n=!1,o=!1,r=null,a=null,l=null,h=null,u=null,c=null,_=null,d=function(){s&&n&&o&&(t.log("Initialization of "+r+" completed."),document.body.firstElementChild.remove(),e.setCurrentScreen(a))},p=function(){t._buildScreensAndExecuteCallback(function(){o=!0,d()})},g=function(e){t.requestTextFile(e.folder,e.filename,function(e){var i=JSON.parse(e);t.log("Loading game settings...",1),t._loadGameSettingsAndExecuteCallback(i,function(){t.log("Game settings loaded.",1),n=!0,p()})})},m=function(){t.requestTextFile(l,h,function(e){var i=JSON.parse(e);t.log("Loading game configuration..."),t.setFolders(i.folders),t.setLogVerbosity(i.logVerbosity),t.setVersion(i.version),t.setDebugVersion(i.debugVersion),t.setReleases(i.releases),t.log("Game version is: "+t.getVersion(),1),u=i.defaultLanguage,c=i.configFiles.strings,requirejs(["modules/media-resources"],function(e){t._loadGameConfigurationAndExecuteCallback(i,function(){e.requestConfigLoad(i.dataFiles.media.resources,function(){t.log("Game configuration loaded."),s=!0}),g(i.configFiles.settings)})})})};return t.setGameName=function(t){r=t},t.setStartScreenName=function(t){a=t},t.setConfigFolder=function(t){l=t},t.setConfigFileName=function(t){h=t},t.getDefaultLanguage=function(){return u},t.getLanguage=function(){return i.getLanguage()||u},t.getLanguages=function(){return Object.keys(c)},t.getDefaultCursor=function(){return _},t.requestLanguageChange=function(s,n,o){return c&&c[s]?(i.languageIsLoaded(s)?(i.setLanguage(s),e.updateAllScreens(),o(!1)):t.requestTextFile(c[s].folder,c[s].filename,function(t){i.loadStrings(s,JSON.parse(t),n),i.setLanguage(s),e.updateAllScreens(),o(!0)}),!0):(t.showError("Cannot change application language to '"+s+"' as there is no strings file set for this langauge!"),!1)},t.initialize=function(e){if(t.log("Initializing "+r+"..."),t.useElectron(e.electron),!t.usesElectron()&&"file:"===location.protocol&&!e.local)return void this.showError("Trying to run the game from the local filesystem!",t.ErrorSeverity.CRITICAL,"This application can only be run through a web server. If you wish to run it from your own computer, you have to install, set up and start a web server first. You have to put the folder containing the files of this game (assume it is called 'game') to the HTML serving folder of the web server, then you can start the game by entering 'localhost/game' in your browser's address bar.");_=document.body.style.cursor,m()},t.getScreen=e.getScreen,t.setScreen=e.setCurrentScreen,t.addScreen=e.addScreen,t.closeSuperimposedScreen=e.closeSuperimposedScreen,t.closeOrNavigateTo=e.closeOrNavigateTo,t.updateAllScreens=e.updateAllScreens,t.executeWhenAllScreensReady=e.executeWhenReady,t}),define("modules/components",["utils/utils","modules/application","modules/async-resource","modules/strings"],function(t,e,i,s){"use strict";function n(t){return X[t]&&!!X[t].model}function o(t){return X[t]&&X[t].model}function r(t){return X[t]&&X[t].requested}function a(t,i){r(t)?n(t)?i&&i():X[t].onLoadQueue.push(i):(X[t]={},X[t].requested=!0,X[t].onLoadQueue=[i],e.requestTextFile(S,t,function(e){var i,s;for(X[t].model=document.createDocumentFragment(),s=document.createElement("div"),s.innerHTML=e,X[t].model.appendChild(s.firstElementChild),i=0;i<X[t].onLoadQueue.length;i++)X[t].onLoadQueue[i]()}))}function l(t){return t.caption||s.get({name:t.id})}function h(){X={}}function u(t,e,i){this._name=t,this._elementID=e||t,this._element=null,this._onShow=i?i[D]:null,this._onHide=i?i[w]:null,this._onEnable=i?i[F]:null,this._onDisable=i?i[P]:null,this._onSelect=i?i[V]:null,this._onUnselect=i?i[U]:null}function c(t,e,s){i.AsyncResource.call(this),this._name=t,this._rootElementID=t,this._htmlFilename=e,this._style=s||{},this._rootElement=null,this._cssLoaded=!1,this._simpleComponents=[],e&&this.requestModelLoad()}function _(t,e,i,s){c.call(this,t,e,i),this._progress=this.registerSimpleComponent(T),this._status=this.registerSimpleComponent(E),this._header=this.registerSimpleComponent(y),this._headerID=s}function d(t,e,i,s,n,o){c.call(this,t,e,i),this._onShow=o?o[D]:null,this._onHide=o?o[w]:null,this._onButtonSelect=o?o[B]:null,this._onButtonClick=o?o[H]:null,this._message=this.registerSimpleComponent(I),this._okButton=this.registerSimpleComponent(A,this._onButtonSelect?{select:function(){this._onButtonSelect(this._okButton.isEnabled())}.bind(this)}:null),this._header=this.registerSimpleComponent(M),this._headerID=s,this._okButtonID=n,this._handleKeyUp=function(t){t.keyCode===x?this._okButton._element.onclick():t.keyCode!==v&&t.keyCode!==b||this._okButton.select()}.bind(this)}function p(t,e,i,s,n){var o;for(c.call(this,t,e,i),this._menuOptions=s,o=0;o<this._menuOptions.length;o++)void 0===this._menuOptions[o].enabled&&(this._menuOptions[o].enabled=!0);this._selectedIndex=-1,this._onOptionSelect=n?n[G]:null,this._onOptionClick=n?n[j]:null,this._validateStyle(i)}function g(t,e,i,s,n,o){var r;for(c.call(this,t,e,i),this._listElements=s,r=0;r<this._listElements.length;r++)void 0===this._listElements[r].enabled&&(this._listElements[r].enabled=!0);this._subcaptions=n,this._highlightedIndex=-1,this._selectedIndex=-1,this._onElementHighlight=o?o[k]:null,this._onElementSelect=o?o[W]:null,this._ulElement=null,this._validateStyle(i)}function m(t,e,i,s,n){c.call(this,t,e,i),this._propertyLabelDescriptor=s,this._valueList=n,this._valueIndex=0,this._propertyLabel=this.registerSimpleComponent(C),this._valueSelector=this.registerSimpleComponent(N),this.onChange=null}function f(t,e,i,s,n,o){c.call(this,t,e,i),this._propertyLabelDescriptor=s,n=n||{},this._min=n.valueList?0:n.min,this._max=n.valueList?n.valueList.length-1:n.max,this._default=n.default,this._step=n.valueList?1:void 0!==n.step?n.step:1,this._valueList=n.valueList||null,this._propertyLabel=this.registerSimpleComponent(O),this._slider=this.registerSimpleComponent(R),this._valueLabel=this.registerSimpleComponent(L),this.onChange=o||null}var S="component",T="progress",E="status",y="header",I="message",A="okButton",M="header",C="property",N="value",O="property",R="slider",L="valueLabel",x=13,v=38,b=40,D="show",w="hide",F="enable",P="disable",V="select",U="unselect",B="buttonselect",H="buttonclick",G="optionselect",j="optionclick",k="elementhighlight",W="elementselect",X={};return u.prototype.setElementID=function(t){this._elementID=t,this._element&&this._element.setAttribute("id",this._elementID)},u.prototype.getContent=function(){return this._element.innerHTML},u.prototype.setContent=function(e,i){this._element.innerHTML=i?t.formatString(e,i):e},u.prototype.setTextContent=function(e,i){this._element.textContent=i?t.formatString(e,i):e},u.prototype.customizeContent=function(e){this._element.innerHTML=t.formatString(this._element.innerHTML,e)},u.prototype.getAttribute=function(t){return this._element[t]},u.prototype.setAttribute=function(t,e){this._element[t]=e},u.prototype.initComponent=function(){this._element=document.getElementById(this._elementID),this._element||e.showError("Cannot initialize component: '"+this._name+"'!",e.ErrorSeverity.SEVERE,"No element can be found on the page with a corresponding ID: '"+this._elementID+"'!")},u.prototype.isVisible=function(){return!this._element.hidden},u.prototype.hide=function(){this.isVisible()&&(this._element.hidden=!0,this._onHide&&this._onHide())},u.prototype.show=function(){this.isVisible()||(this._element.hidden=!1,this._onShow&&this._onShow())},u.prototype.setVisible=function(t){
t?this.show():this.hide()},u.prototype.isEnabled=function(){return!this._element.classList.contains("disabled")},u.prototype.disable=function(){this.isEnabled()&&(this._element.classList.add("disabled"),this._onDisable&&this._onDisable())},u.prototype.enable=function(){this.isEnabled()||(this._element.classList.remove("disabled"),this._onEnable&&this._onEnable())},u.prototype.isSelected=function(){return this._element.classList.contains("selected")},u.prototype.select=function(){this.isSelected()||(this._element.classList.add("selected"),this._onSelect&&this._onSelect())},u.prototype.unselect=function(){this.isSelected()&&(this._element.classList.remove("selected"),this._onUnselect&&this._onUnselect()),this._element.blur()},c.prototype=new i.AsyncResource,c.prototype.constructor=c,c.prototype.setRootElementID=function(t){var i;if(this._rootElement)e.showError("Attempting to change the root element ID for external component '"+this._name+"' after it has already been added to the page!");else for(this._rootElementID=t,i=0;i<this._simpleComponents.length;i++)this._simpleComponents[i].setElementID(this._getElementID(this._simpleComponents[i]._name))},c.prototype.requestModelLoad=function(){this._style.cssFilename?(this._cssLoaded=!1,e.requestCSSFile("css",this._style.cssFilename,function(){this._cssLoaded=!0,n(this._htmlFilename)&&this.setToReady()}.bind(this))):this._cssLoaded=!0,a(this._htmlFilename,function(){!0===this._cssLoaded&&this.setToReady()}.bind(this))},c.prototype.appendToPage=function(t){var e,i;for(t=t||document.body,this._rootElement=t.appendChild(document.importNode(o(this._htmlFilename).firstElementChild,!0)),this._rootElement.setAttribute("id",this._rootElementID),e=this._rootElement.querySelectorAll("[id]"),i=0;i<e.length;i++)e[i].setAttribute("id",this._getElementID(e[i].getAttribute("id")));this._initializeComponents()},c.prototype._getElementID=function(t){return this._rootElementID+"_"+t},c.prototype._getOriginalElementID=function(t){return t.getAttribute("id").substr(this._rootElementID.length+"_".length)},c.prototype._initializeComponents=function(){var t;if(this._rootElement)for(t=0;t<this._simpleComponents.length;t++)this._simpleComponents[t].initComponent()},c.prototype.updateComponents=function(){var t,e;if(this._rootElement)for(e=this._rootElement.querySelectorAll("[data-translation-key]"),t=0;t<e.length;t++)e[t].innerHTML=s.get({name:e[t].getAttribute("data-translation-key"),defaultValue:e[t].innerHTML})},c.prototype.registerSimpleComponent=function(t,e){var i=new u(t,this._getElementID(t),e);return this._simpleComponents.push(i),i},c.prototype.isVisible=function(){return!this._rootElement.hidden},c.prototype.show=function(){return!(!this._rootElement||this.isVisible())&&(this._rootElement.hidden=!1,!0)},c.prototype.hide=function(){return!(!this._rootElement||!this.isVisible())&&(this._rootElement.hidden=!0,!0)},_.prototype=new c,_.prototype.constructor=_,_.prototype._initializeComponents=function(){c.prototype._initializeComponents.call(this),this._rootElement&&(this._headerID&&this._header.setElementID(this._getElementID(this._headerID)),this.hide())},_.prototype.setMaxProgress=function(t){this._rootElement&&(this._progress._element.max=t)},_.prototype.updateProgress=function(t){this._rootElement&&(this._progress._element.value=t)},_.prototype.updateStatus=function(t,e,i){this._rootElement&&(this._status.setContent(t,e),void 0!==i&&this.updateProgress(i))},d.prototype=new c,d.prototype.constructor=d,d.prototype._initializeComponents=function(){c.prototype._initializeComponents.call(this),this._rootElement&&(this._headerID&&this._header.setElementID(this._getElementID(this._headerID)),this._okButtonID&&this._okButton.setElementID(this._getElementID(this._okButtonID)),this._okButton._element.onmouseenter=function(){this._okButton.select()}.bind(this),this._okButton._element.onmouseleave=function(){this._okButton.unselect()}.bind(this),this._okButton._element.onclick=function(){return this._onButtonClick&&this._onButtonClick(this._okButton.isEnabled()),this.hide(),!1}.bind(this),c.prototype.hide.call(this))},d.prototype.show=function(){return!!c.prototype.show.call(this)&&(this._okButton.unselect(),document.addEventListener("keyup",this._handleKeyUp),this._onShow&&this._onShow(),!0)},d.prototype.hide=function(){return!!c.prototype.hide.call(this)&&(document.removeEventListener("keyup",this._handleKeyUp),this._onHide&&this._onHide(),!0)},d.prototype.updateMessage=function(t,e){this._rootElement&&this._message.setContent(t,e)},p.prototype=new c,p.prototype.constructor=p,p.prototype._validateStyle=function(t){if("object"!=typeof t)return void e.showError("Invalid menu style specified: not an object!");t.selectedButtonClassName||e.showError("Attempting to specify a menu style without specifying a class for selected menu buttons!"),t.disabledClassName||e.showError("Attempting to specify a menu style without specifying a class for disabled menu buttons!")},p.prototype._selectIndex=function(t){t!==this._selectedIndex&&(this._selectedIndex>=0&&(this._menuOptions[this._selectedIndex].element.classList.remove(this._style.selectedButtonClassName),this._menuOptions[this._selectedIndex].element.blur()),this._selectedIndex=t,this._selectedIndex>=0&&this._menuOptions[this._selectedIndex].enabled&&(this._menuOptions[this._selectedIndex].element.classList.add(this._style.selectedButtonClassName),this._onOptionSelect&&this._onOptionSelect(!0)))},p.prototype._getMenuClickHandler=function(t){return function(){return this._menuOptions[t].enabled&&(this._selectIndex(t),this._menuOptions[t].action()),this._onOptionClick&&this._onOptionClick(this._menuOptions[t].enabled),!1}.bind(this)},p.prototype._getMenuMouseMoveHandler=function(t){return function(){this._menuOptions[t].enabled&&this._selectIndex(t)}.bind(this)},p.prototype._initializeComponents=function(){var t,e,i;if(c.prototype._initializeComponents.call(this),this._rootElement){for(this._rootElement.classList.add(this._style.menuClassName),t=0;t<this._menuOptions.length;t++)e=document.createElement("button"),this._menuOptions[t].id&&(e.id=this._getElementID(this._menuOptions[t].id),e.setAttribute("data-translation-key",this._menuOptions[t].id)),e.className=(this._style.menuClassName||"")+" "+(this._style.buttonClassName||"")+(this._menuOptions[t].enabled?"":this._style.disabledClassName),e.innerHTML=l(this._menuOptions[t]),e.onclick=this._getMenuClickHandler(t),e.onmousemove=this._getMenuMouseMoveHandler(t),this._menuOptions[t].element=e,i=document.createElement("li"),i.className=this._style.buttonContainerClassName||"",i.appendChild(e),this._rootElement.appendChild(i);this._rootElement.onmouseout=this.unselect.bind(this)}},p.prototype.unselect=function(){this._selectIndex(-1)},p.prototype.selectNext=function(){var t=this._selectedIndex;-1===t&&(t=this._menuOptions.length-1);do{this._selectIndex((this._selectedIndex+1)%this._menuOptions.length)}while(this._selectedIndex!==t&&!this._menuOptions[this._selectedIndex].enabled);this._menuOptions[this._selectedIndex].enabled||this._selectIndex(-1)},p.prototype.selectPrevious=function(){var t=this._selectedIndex;-1===t&&(t=0);do{this._selectedIndex>0?this._selectIndex(this._selectedIndex-1):this._selectIndex(this._menuOptions.length-1)}while(this._selectedIndex!==t&&!this._menuOptions[this._selectedIndex].enabled);this._menuOptions[this._selectedIndex].enabled||this._selectIndex(-1)},p.prototype.activateSelected=function(){this._selectedIndex>=0&&this._menuOptions[this._selectedIndex].element.onclick()},g.prototype=new c,g.prototype.constructor=g,g.prototype._validateStyle=function(t){if("object"!=typeof t)return void e.showError("Invalid menu style specified: not an object!");t.disabledElementClassName||e.showError("Attempting to specify a list style without specifying a class for disabled list elements!"),t.selectedElementClassName||e.showError("Attempting to specify a list style without specifying a class for selected list elements!"),t.highlightedElementClassName||e.showError("Attempting to specify a list style without specifying a class for highlighted list elements!")},g.prototype._scrollToIndex=function(t){var e;e=this._listElements[t].element,e.offsetTop<this._rootElement.scrollTop?this._rootElement.scrollTop=e.offsetTop:e.offsetTop+e.offsetHeight>this._rootElement.scrollTop+this._rootElement.clientHeight&&(this._rootElement.scrollTop=e.offsetTop+e.offsetHeight-this._rootElement.clientHeight)},g.prototype._highlightIndex=function(t,e){t!==this._highlightedIndex&&(this._highlightedIndex>=0&&this._listElements[this._highlightedIndex].element.classList.remove(this._style.highlightedElementClassName),this._highlightedIndex=t,this._highlightedIndex>=0&&this._listElements[this._highlightedIndex].enabled&&(this._listElements[this._highlightedIndex].element.classList.add(this._style.highlightedElementClassName),e&&this._scrollToIndex(t),this._onElementHighlight&&this._onElementHighlight(t,!0)))},g.prototype.selectIndex=function(t,e){e&&t>=0&&this._scrollToIndex(t),t!==this._selectedIndex&&((t<0||t>=0&&this._listElements[t].enabled)&&(this._selectedIndex>=0&&this._listElements[this._selectedIndex].element.classList.remove(this._style.selectedElementClassName),this._selectedIndex=t,this._selectedIndex>=0&&this._listElements[this._selectedIndex].element.classList.add(this._style.selectedElementClassName)),this._onElementSelect&&this._onElementSelect(t,t>=0&&this._listElements[t].enabled))},g.prototype.getHighlightedIndex=function(){return this._highlightedIndex},g.prototype.getSelectedIndex=function(){return this._selectedIndex},g.prototype._getElementClickHandler=function(t){return function(){return this._listElements[t].enabled&&this.selectIndex(t),!1}.bind(this)},g.prototype._getElementMouseMoveHandler=function(t){return function(){this._listElements[t].enabled?this._highlightIndex(t):this._highlightIndex(-1)}.bind(this)},g.prototype._addListElement=function(t,e){var i,n,o;o=document.createElement("li"),o.className=this._style.elementContainerClassName||"",n=document.createElement("a"),n.className=(this._style.elementClassName||"")+" "+(t.enabled?"":this._style.disabledElementClassName),t.element=n,n.onclick=this._getElementClickHandler(e),n.onmousemove=this._getElementMouseMoveHandler(e),o.appendChild(n),i=document.createElement("span"),t.captionID&&i.setAttribute("data-translation-key",t.captionID),i.className=this._style.captionClassName||"",i.innerHTML=t.caption||s.get({name:t.captionID}),n.appendChild(i),this._subcaptions&&(n.appendChild(document.createElement("br")),i=document.createElement("span"),t.subcaptionID&&i.setAttribute("data-translation-key",t.subcaptionID),i.className=this._style.subcaptionClassName||"",i.innerHTML=t.subcaption||s.get({name:t.subcaptionID}),n.appendChild(i)),this._ulElement.appendChild(o)},g.prototype.addListElement=function(t){void 0===t.enabled&&(t.enabled=!0),this._listElements.push(t),this._addListElement(t,this._listElements.length-1)},g.prototype._initializeComponents=function(){var t;if(c.prototype._initializeComponents.call(this),this._rootElement){for(this._rootElement.classList.add(this._style.listContainerClassName),this._ulElement=document.createElement("ul"),this._ulElement.classList.add(this._style.listClassName),t=0;t<this._listElements.length;t++)this._addListElement(this._listElements[t],t);this._rootElement.onmouseleave=this.unhighlight.bind(this),this._rootElement.appendChild(this._ulElement)}},g.prototype.unhighlight=function(){this._highlightIndex(-1)},g.prototype.unselect=function(){this.selectIndex(-1)},g.prototype.reset=function(){this.unselect(),this.unhighlight(),this._rootElement.scrollTop=0},g.prototype.highlightNext=function(){var t=this._highlightedIndex;-1===t&&(t=this._listElements.length-1);do{this._highlightIndex((this._highlightedIndex+1)%this._listElements.length,!0)}while(this._highlightedIndex!==t&&!this._listElements[this._highlightedIndex].enabled);this._listElements[this._highlightedIndex].enabled||this._highlightIndex(-1)},g.prototype.highlightPrevious=function(){var t=this._highlightedIndex;-1===t&&(t=0);do{this._highlightedIndex>0?this._highlightIndex(this._highlightedIndex-1,!0):this._highlightIndex(this._listElements.length-1,!0)}while(this._highlightedIndex!==t&&!this._listElements[this._highlightedIndex].enabled);this._listElements[this._highlightedIndex].enabled||this._highlightIndex(-1)},g.prototype.selectHighlighted=function(){this._highlightedIndex>=0&&this._listElements[this._highlightedIndex].element.onclick()},g.prototype.executeForListElements=function(t){var e;for(e=0;e<this._listElements.length;e++)t(this._listElements[e].element)},g.prototype.setCaption=function(t,e){var i=this._listElements[t],s=i.element.querySelector("."+this._style.captionClassName);i.captionID&&(i.captionID="",s.removeAttribute("data-translation-key")),i.caption=e,s.innerHTML=e},m.prototype=new c,m.prototype.constructor=m,m.prototype._initializeComponents=function(){c.prototype._initializeComponents.call(this),this._rootElement&&(this._style.selectorClassName&&(this._rootElement.className=this._style.selectorClassName),this._propertyLabelDescriptor.id&&(this._propertyLabel.setElementID(this._getElementID(this._propertyLabelDescriptor.id)),this._propertyLabel._element.setAttribute("data-translation-key",this._propertyLabelDescriptor.id)),this._propertyLabel.setContent(l(this._propertyLabelDescriptor)),this._style.propertyContainerClassName&&(this._propertyLabel._element.className=this._style.propertyContainerClassName),this._valueSelector.setContent(this._valueList[0]),this._valueIndex=0,this.setValueList(this._valueList),this._valueSelector._element.onmouseup=function(t){switch(t.preventDefault(),t.stopPropagation(),t.which){case 1:this.selectNextValue();break;case 3:this.selectPreviousValue()}return!1}.bind(this),this._valueSelector._element.oncontextmenu=function(t){return t.preventDefault(),t.stopPropagation(),!1})},m.prototype.selectValue=function(t){if(this._rootElement){for(var i=0;i<this._valueList.length&&this._valueList[i]!==t;)i++;i<this._valueList.length?this.selectValueWithIndex(i,0):e.showError("Attempted to select value: '"+t+"' for '"+l(this._propertyLabelDescriptor)+"', which is not one of the available options.",e.ErrorSeverity.MINOR)}else e.showError("Attemted to select value for selector "+this._name+" which is not yet appended to the page!")},m.prototype.selectValueWithIndex=function(t,i){var s=this._valueIndex;this._rootElement?this._valueList.length>t?(this._valueIndex=t,this._valueSelector.setContent(this._valueList[this._valueIndex]),s!==t&&this.onChange&&this.onChange(i||0)):e.showError("Attempted to select value with index '"+t+"' for '"+l(this._propertyLabelDescriptor)+"', while the available range is: 0-"+(this._valueList.length-1),e.ErrorSeverity.MINOR):e.showError("Attemted to select value for selector "+this._name+" which is not yet appended to the page!")},m.prototype.getSelectedValue=function(){return this._valueList[this._valueIndex]},m.prototype.getSelectedIndex=function(){return this._valueIndex},m.prototype.selectNextValue=function(){this.selectValueWithIndex((this._valueIndex+1)%this._valueList.length,1)},m.prototype.selectPreviousValue=function(){this.selectValueWithIndex(this._valueIndex>0?this._valueIndex-1:this._valueList.length-1,-1)},m.prototype.setValueList=function(t){this._valueList=t,this._valueIndex>=this._valueList.length&&(this._valueIndex=0),this._valueList.length<2?this._valueSelector.disable():this._valueSelector.enable()},f.prototype=new c,f.prototype.constructor=f,f.prototype._initializeComponents=function(){var t=function(){this._updateValueLabel(),this.onChange&&this.onChange(this.getValue())}.bind(this);c.prototype._initializeComponents.call(this),this._rootElement&&(this._propertyLabelDescriptor.id&&(this._propertyLabel.setElementID(this._getElementID(this._propertyLabelDescriptor.id)),this._propertyLabel._element.setAttribute("data-translation-key",this._propertyLabelDescriptor.id)),this._propertyLabel.setContent(l(this._propertyLabelDescriptor)),this._valueList?(this.setValueList(this._valueList),this._valueLabel.show()):(this._valueLabel.hide(),this._updateSlider()),this.setNumericValue(this._default),this._slider._element.onchange=t,this._slider._element.oninput=t)},f.prototype._updateSlider=function(){this._slider.setAttribute("min",this._min),this._slider.setAttribute("max",this._max),this._slider.setAttribute("step",this._step)},f.prototype._updateValueLabel=function(){this._valueList&&this._valueLabel.setContent(this._valueList[this.getNumericValue()])},f.prototype.setNumericValue=function(t){this._slider.setAttribute("value",t),this._updateValueLabel()},f.prototype.setListedValue=function(t){var i;this._valueList?(i=this._valueIndex.indexOf(t),i>=0?this.setNumericValue(i):e.showError("Cannot set listed value '"+t+"' for slider '"+this._name+"', because it is not in the value list!")):e.showError("Cannot set listed value '"+t+"' for slider '"+this._name+"', because it has no value list!")},f.prototype.getNumericValue=function(){return parseFloat(this._slider.getAttribute("value"))},f.prototype.getListedValue=function(){return this._valueList[this.getNumericValue()]},f.prototype.getValue=function(){return this._valueList?this.getListedValue():this.getNumericValue()},f.prototype.setValueList=function(t){var e=this.getNumericValue();this._valueList=t,this._min=0,this._max=t.length-1,this._step=1,e>this._max&&(e=0),this._updateSlider(),this.setNumericValue(e)},{ELEMENT_ID_SEPARATOR:"_",DISABLED_CLASS_NAME:"disabled",SELECTED_CLASS_NAME:"selected",HIGHLIGHTED_CLASS_NAME:"highlighted",SHOW_EVENT_NAME:D,HIDE_EVENT_NAME:w,BUTTON_SELECT_EVENT_NAME:B,BUTTON_CLICK_EVENT_NAME:H,OPTION_SELECT_EVENT_NAME:G,OPTION_CLICK_EVENT_NAME:j,TRANSLATION_KEY_ATTRIBUTE:"data-translation-key",clearStoredDOMModels:h,SimpleComponent:u,LoadingBox:_,InfoBox:d,MenuComponent:p,ListComponent:g,Selector:m,Slider:f}}),define("modules/analytics",["modules/application"],function(t){"use strict";function e(t){u=t,l=localStorage.analytics_id,h=localStorage.analytics_user_id,c=!localStorage.analytics_enabled||localStorage.analytics_enabled===(!0).toString()}function i(){var e=!(l&&h);_||(_=!0,d("start"+(e?"":"/"+l+"/"+h)+"?version="+t.getVersion().split(" ")[0],function(t){if(t){var e=JSON.parse(t.responseText);e.newlyCreated&&e.id&&e.userID&&(l=e.id,h=e.userID,localStorage.analytics_id=l,localStorage.analytics_user_id=h)}}))}function s(t,e,i){var s,n,o;if(c&&l&&h){if(s=t+"/"+l+"/"+h,e)for(n=0;n<e.length;n++)s+="/"+e[n];if(i)for(s+="?",o=Object.keys(i),n=0;n<o.length;n++)s+=o[n]+"="+i[o[n]]+"&";d(s,function(t){})}}function n(){return c}function o(){c||(c=!0,localStorage.analytics_enabled=(!0).toString(),s("enable"))}function r(){c&&(s("disable"),c=!1,localStorage.analytics_enabled=(!1).toString())}function a(t){t?o():r()}var l,h,u=null,c=!1,_=!1,d=function(t,e){var i=new XMLHttpRequest;c&&(i.onload=function(){e(i)}.bind(this),i.onerror=function(){e()}.bind(this),i.ontimeout=function(){e()}.bind(this),i.overrideMimeType("text/plain; charset=utf-8"),i.open("POST",u+t,!0),i.send(null))};return{init:e,login:i,sendEvent:s,isEnabled:n,enable:o,disable:r,setEnabled:a}}),define("utils/vectors",[],function(){"use strict";var t={},e=[],i=0,s=new Float32Array([0,0,0]),n=new Float32Array([0,0,0,0]);return t.NULL3=[0,0,0],Object.freeze(t.NULL3),t.NULL4=[0,0,0,0],Object.freeze(t.NULL4),t.NULL4W1=[0,0,0,1],Object.freeze(t.NULL4W1),t.UNIT2_X=[1,0],Object.freeze(t.UNIT2_X),t.UNIT2_Y=[0,1],Object.freeze(t.UNIT2_Y),t.UNIT3_X=[1,0,0],Object.freeze(t.UNIT3_X),t.UNIT3_Y=[0,1,0],Object.freeze(t.UNIT3_Y),t.UNIT3_Z=[0,0,1],Object.freeze(t.UNIT3_Z),t.perpendicular3=function(t){return[t[1],-t[0],0]},t.floatVector3Aux=function(t){return s[0]=t[0],s[1]=t[1],s[2]=t[2],s},t.floatVector4Aux=function(t){return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n},t.length2=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])},t.length3=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},t.length3Squared=function(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]},t.toString3=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)},t.toString4=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)+" "+t[3].toFixed(e)},t.getYawAndPitch=function(e){var i,s={};return Math.abs(e[2])>.99999?(s.yaw=0,s.pitch=e[2]>0?-Math.PI/2:Math.PI/2):(s.yaw=t.angle2yCapped(e[0],e[1]),e[0]>0&&(s.yaw=-s.yaw),i=t.rotated2(e,-s.yaw),s.pitch=t.angle2xCapped(i[1],e[2]),e[2]<0&&(s.pitch=-s.pitch)),s},t.getRollAndYaw=function(e,i){var s,n={};return Math.abs(e[1])>.99999?(n.roll=0,n.yaw=e[1]>0?0:Math.PI):(n.roll=t.angle2xCapped(e[0],e[2]),e[2]<0&&(n.roll=-n.roll),s=t.rotated2([e[0],e[2]],-n.roll),n.yaw=t.angle2yCapped(s[0],e[1]),!i&&Math.abs(n.roll)>Math.PI/2&&(n.yaw=-n.yaw,n.roll-=Math.PI*Math.sign(n.roll))),n},t.getRollAndPitch=function(e,i){var s,n={};return Math.abs(e[1])>.99999?(n.roll=0,n.pitch=e[1]>0?0:Math.PI):(n.roll=t.angle2yCapped(e[0],e[2]),e[0]>0&&(n.roll=-n.roll),s=t.rotated2([e[0],e[2]],-n.roll),n.pitch=t.angle2xCapped(e[1],s[1]),!i&&Math.abs(n.roll)>Math.PI/2&&(n.pitch=-n.pitch,n.roll-=Math.PI*Math.sign(n.roll))),n},t.vector4From3=function(t,e){return[t[0],t[1],t[2],e]},t.vector4From3Aux=function(t){var s=e[i];return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=1,i=(i+1)%20,s},t.vector3Aux=function(t,s,n){var o=e[i];return o[0]=t,o[1]=s,o[2]=n,i=(i+1)%20,o},t.x3Aux=function(){var t=e[i];return t[0]=1,t[1]=0,t[2]=0,i=(i+1)%20,t},t.y3Aux=function(){var t=e[i];return t[0]=0,t[1]=1,t[2]=0,i=(i+1)%20,t},t.z3Aux=function(){var t=e[i];return t[0]=0,t[1]=0,t[2]=1,i=(i+1)%20,t},t.normal2=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]),i=0===e?1:1/e;return[t[0]*i,t[1]*i]},t.normal3=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),i=0===e?1:1/e;return[t[0]*i,t[1]*i,t[2]*i]},t.normal3Aux=function(t){var s=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),n=0===s?1:1/s,o=e[i];return o[0]=t[0]*n,o[1]=t[1]*n,o[2]=t[2]*n,i=(i+1)%20,o},t.scaled2=function(t,e){return[t[0]*e,t[1]*e]},t.scaled3=function(t,e){return[t[0]*e,t[1]*e,t[2]*e]},t.scaled3Aux=function(t,s){var n=e[i];return n[0]=t[0]*s,n[1]=t[1]*s,n[2]=t[2]*s,i=(i+1)%20,n},t.scaled4=function(t,e){return[t[0]*e,t[1]*e,t[2]*e,t[3]*e]},t.rotated2=function(t,e){var i=Math.cos(e),s=Math.sin(e),n=[0,0];return n[0]=t[0]*i+t[1]*-s,n[1]=t[0]*s+t[1]*i,n},t.sum3=function(t,e){return[t[0]+e[0],t[1]+e[1],t[2]+e[2]]},t.sumArray3=function(t){var e,i=[0,0,0];for(e=0;e<t.length;e++)i[0]+=t[e][0],i[1]+=t[e][1],i[2]+=t[e][2];return i},t.diff3=function(t,e){return[t[0]-e[0],t[1]-e[1],t[2]-e[2]]},t.diff3Aux=function(t,s){var n=e[i];return n[0]=t[0]-s[0],n[1]=t[1]-s[1],n[2]=t[2]-s[2],i=(i+1)%20,n},t.diffTranslation3=function(t,e){return[t[12]-e[12],t[13]-e[13],t[14]-e[14]]},t.diffTranslation3Aux=function(t,s){var n=e[i];return n[0]=t[12]-s[12],n[1]=t[13]-s[13],n[2]=t[14]-s[14],i=(i+1)%20,n},t.dot3=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},t.cross3=function(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]},t.angle2u=function(t,e){return Math.acos(t[0]*e[0]+t[1]*e[1])},t.angle2x=function(t,e){return Math.acos(t/Math.sqrt(t*t+e*e))},t.angle2y=function(t,e){return Math.acos(e/Math.sqrt(t*t+e*e))},t.angle2uCapped=function(t,e){return Math.acos(Math.min(Math.max(-1,t[0]*e[0]+t[1]*e[1]),1))},t.angle2xCapped=function(t,e){return Math.acos(Math.min(Math.max(-1,t/Math.sqrt(t*t+e*e)),1))},t.angle2yCapped=function(t,e){return Math.acos(Math.min(Math.max(-1,e/Math.sqrt(t*t+e*e)),1))},t.angle3u=function(t,e){return Math.acos(t[0]*e[0]+t[1]*e[1]+t[2]*e[2])},t.angle3uCapped=function(t,e){return Math.acos(Math.min(Math.max(-1,t[0]*e[0]+t[1]*e[1]+t[2]*e[2]),1))},t.prodVec3Mat3=function(t,e){return[e[0]*t[0]+e[3]*t[1]+e[6]*t[2],e[1]*t[0]+e[4]*t[1]+e[7]*t[2],e[2]*t[0]+e[5]*t[1]+e[8]*t[2]]},t.prodVec3Mat3Aux=function(s,n){var o=e[i];return t.setProdVec3Mat3(o,s,n),i=(i+1)%20,o},t.prodVec3Mat4=function(t,e){return[e[0]*t[0]+e[4]*t[1]+e[8]*t[2],e[1]*t[0]+e[5]*t[1]+e[9]*t[2],e[2]*t[0]+e[6]*t[1]+e[10]*t[2]]},t.prodVec3Mat4Aux=function(s,n){var o=e[i];return t.setProdVec3Mat4(o,s,n),i=(i+1)%20,o},t.prodVec4Mat4=function(t,e){return[e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12]*t[3],e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13]*t[3],e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14]*t[3],e[3]*t[0]+e[7]*t[1]+e[11]*t[2]+e[15]*t[3]]},t.prodVec4Mat4Aux=function(s,n){var o=e[i];return t.setProdVec4Mat4(o,s,n),i=(i+1)%20,o},t.prodVecX4Mat4Aux=function(s,n){var o=e[i];return t.setProdVecX4Mat4(o,s,n),i=(i+1)%20,o},t.prodVecY4Mat4Aux=function(s,n){var o=e[i];return t.setProdVecY4Mat4(o,s,n),i=(i+1)%20,o},t.prodTranslationModel3Aux=function(s,n){var o=e[i];return t.setProdTranslationModel3(o,s,n),i=(i+1)%20,o},t.prodMat3Vec3=function(t,e){return[t[0]*e[0]+t[1]*e[1]+t[2]*e[2],t[3]*e[0]+t[4]*e[1]+t[5]*e[2],t[6]*e[0]+t[7]*e[1]+t[8]*e[2]]},t.prodMat4Vec3=function(t,e){return[t[0]*e[0]+t[1]*e[1]+t[2]*e[2],t[4]*e[0]+t[5]*e[1]+t[6]*e[2],t[8]*e[0]+t[9]*e[1]+t[10]*e[2]]},t.prodMat4Vec4=function(t,e){return[t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3],t[4]*e[0]+t[5]*e[1]+t[6]*e[2]+t[7]*e[3],t[8]*e[0]+t[9]*e[1]+t[10]*e[2]+t[11]*e[3],t[12]*e[0]+t[13]*e[1]+t[14]*e[2]+t[15]*e[3]]},t.setNull3=function(t){t[0]=0,t[1]=0,t[2]=0},t.setVector3=function(t,e){t[0]=e[0],t[1]=e[1],t[2]=e[2]},t.setVector4=function(t,e){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]},t.negate2=function(t){t[0]=-t[0],t[1]=-t[1]},t.normalize2=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]),i=0===e?1:1/e;return t[0]*=i,t[1]*=i,t},t.normalize3=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),i=0===e?1:1/e;return t[0]*=i,t[1]*=i,t[2]*=i,t},t.normalize4D=function(t){t[3]=t[3]||1e-7,t[0]/=t[3],t[1]/=t[3],t[2]/=t[3],t[3]=1},t.scale3=function(t,e){return t[0]*=e,t[1]*=e,t[2]*=e,t},t.setSum3=function(t,e,i){t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2]},t.add3=function(t,e){t[0]+=e[0],t[1]+=e[1],t[2]+=e[2]},t.setDiff3=function(t,e,i){t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2]},t.sub3=function(t,e){t[0]-=e[0],t[1]-=e[1],t[2]-=e[2]},t.mulCross3=function(t,e){var i=t[0],s=t[1],n=t[2];t[0]=s*e[2]-n*e[1],t[1]=n*e[0]-i*e[2],t[2]=i*e[1]-s*e[0]},t.rotate2=function(t,e){var i=Math.cos(e),s=Math.sin(e),n=t[0];t[0]=t[0]*i+t[1]*-s,t[1]=n*s+t[1]*i},t.setTranslationVector3=function(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t},t.diffVec3Mat4=function(t,e){return[t[0]-e[12],t[1]-e[13],t[2]-e[14]]},t.diffVec3Mat4Aux=function(t,s){var n=e[i];return n[0]=t[0]-s[12],n[1]=t[1]-s[13],n[2]=t[2]-s[14],i=(i+1)%20,n},t.mulVec3Mat3=function(t,e){var i=t[0],s=t[1],n=t[2];t[0]=e[0]*i+e[3]*s+e[6]*n,t[1]=e[1]*i+e[4]*s+e[7]*n,t[2]=e[2]*i+e[5]*s+e[8]*n},t.setProdVec3Mat3=function(t,e,i){t[0]=i[0]*e[0]+i[3]*e[1]+i[6]*e[2],t[1]=i[1]*e[0]+i[4]*e[1]+i[7]*e[2],t[2]=i[2]*e[0]+i[5]*e[1]+i[8]*e[2]},t.mulVec3Mat4=function(t,e){var i=t[0],s=t[1],n=t[2];t[0]=e[0]*i+e[4]*s+e[8]*n,t[1]=e[1]*i+e[5]*s+e[9]*n,t[2]=e[2]*i+e[6]*s+e[10]*n},t.setProdVec3Mat4=function(t,e,i){t[0]=i[0]*e[0]+i[4]*e[1]+i[8]*e[2],t[1]=i[1]*e[0]+i[5]*e[1]+i[9]*e[2],t[2]=i[2]*e[0]+i[6]*e[1]+i[10]*e[2]},t.mulVec4Mat4=function(t,e){var i=t[0],s=t[1],n=t[2],o=t[3];t[0]=e[0]*i+e[4]*s+e[8]*n+e[12]*o,t[1]=e[1]*i+e[5]*s+e[9]*n+e[13]*o,t[2]=e[2]*i+e[6]*s+e[10]*n+e[14]*o,t[3]=e[3]*i+e[7]*s+e[11]*n+e[15]*o},t.setProdVec4Mat4=function(t,e,i){t[0]=i[0]*e[0]+i[4]*e[1]+i[8]*e[2]+i[12]*e[3],t[1]=i[1]*e[0]+i[5]*e[1]+i[9]*e[2]+i[13]*e[3],t[2]=i[2]*e[0]+i[6]*e[1]+i[10]*e[2]+i[14]*e[3],t[3]=i[3]*e[0]+i[7]*e[1]+i[11]*e[2]+i[15]*e[3]},t.setProdVecX4Mat4=function(t,e,i){t[0]=i[0]*e+i[12],t[1]=i[1]*e+i[13],t[2]=i[2]*e+i[14],t[3]=i[3]*e+i[15]},t.setProdVecY4Mat4=function(t,e,i){t[0]=i[4]*e+i[12],t[1]=i[5]*e+i[13],t[2]=i[6]*e+i[14],t[3]=i[7]*e+i[15]},t.setProdTranslationModel3=function(t,e,i){t[0]=i[0]*e[12]+i[4]*e[13]+i[8]*e[14]+i[12],t[1]=i[1]*e[12]+i[5]*e[13]+i[9]*e[14]+i[13],t[2]=i[2]*e[12]+i[6]*e[13]+i[10]*e[14]+i[14]},t.setRowB43=function(t,e){t[0]=e[4],t[1]=e[5],t[2]=e[6]},t.extractLength2=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]),i=0===e?1:1/e;return t[0]*=i,t[1]*=i,e},t.extractLength3=function(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),i=0===e?1:1/e;return t[0]*=i,t[1]*=i,t[2]*=i,e},function(){var t;for(t=0;t<20;t++)e.push([0,0,0,0])}(),t}),define("utils/matrices",["utils/utils","utils/vectors"],function(t,e){"use strict";function i(){var t;for(t=0;t<r.length;t++)if(!r[t].used)return t;return r.push({used:!1,matrix:o.identity4()}),r.length-1}function s(t){return r[t].used=!0,r[t].matrix}function n(t){r[t].used=!1}var o={},r=[],a=[],l=0,h=[],u=0,c=0;return o.clearMatrixCount=function(){c=0},o.getMatrixCount=function(){return c},o.identity3=function(){return new Float32Array([1,0,0,0,1,0,0,0,1])},o.identity3Aux=function(){var t=h[u];return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,u=(u+1)%20,t},o.IDENTITY3=o.identity3(),o.identity4=function(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},o.identity4Aux=function(){var t=a[l];return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,l=(l+1)%20,t},o.IDENTITY4=o.identity4(),o.null3=function(){return new Float32Array([0,0,0,0,0,0,0,0,0])},o.NULL3=o.null3(),o.null4=function(){return new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])},o.NULL4=o.null4(),o.matrix3=function(t){return new Float32Array([t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]])},o.matrix4=function(t){return new Float32Array([t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]])},o.matrix4Aux=function(t){var e=a[l];return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],l=(l+1)%20,e},o.translation4=function(t,e,i){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t,e,i,1])},o.translation4Aux=function(t,e,i){var s=a[l];return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=t,s[13]=e,s[14]=i,s[15]=1,l=(l+1)%20,s},o.translation4v=function(t){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t[0],t[1],t[2],1])},o.translation4vAux=function(t){var e=a[l];return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,l=(l+1)%20,e},o.translation4m4=function(t){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t[12],t[13],t[14],1])},o.translation4m4Aux=function(t){var e=a[l];return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=1,l=(l+1)%20,e},o.rotation2=function(t){var e=Math.cos(t),i=Math.sin(t);return new Float32Array([e,-i,i,e])},o.rotation3=function(t,e){var i=Math.cos(e),s=Math.sin(e);return new Float32Array([i+(1-i)*t[0]*t[0],(1-i)*t[0]*t[1]-s*t[2],(1-i)*t[0]*t[2]+s*t[1],(1-i)*t[0]*t[1]+s*t[2],i+(1-i)*t[1]*t[1],(1-i)*t[1]*t[2]-s*t[0],(1-i)*t[0]*t[2]-s*t[1],(1-i)*t[1]*t[2]+s*t[0],i+(1-i)*t[2]*t[2]])},o.rotation3Aux=function(t,e){var i=Math.cos(e),s=Math.sin(e),n=h[u];return n[0]=i+(1-i)*t[0]*t[0],n[1]=(1-i)*t[0]*t[1]-s*t[2],n[2]=(1-i)*t[0]*t[2]+s*t[1],n[3]=(1-i)*t[0]*t[1]+s*t[2],n[4]=i+(1-i)*t[1]*t[1],n[5]=(1-i)*t[1]*t[2]-s*t[0],n[6]=(1-i)*t[0]*t[2]-s*t[1],n[7]=(1-i)*t[1]*t[2]+s*t[0],n[8]=i+(1-i)*t[2]*t[2],u=(u+1)%20,n},o.rotation4=function(t,e){var i=Math.cos(e),s=Math.sin(e);return new Float32Array([i+(1-i)*t[0]*t[0],(1-i)*t[0]*t[1]-s*t[2],(1-i)*t[0]*t[2]+s*t[1],0,(1-i)*t[0]*t[1]+s*t[2],i+(1-i)*t[1]*t[1],(1-i)*t[1]*t[2]-s*t[0],0,(1-i)*t[0]*t[2]-s*t[1],(1-i)*t[1]*t[2]+s*t[0],i+(1-i)*t[2]*t[2],0,0,0,0,1])},o.rotationX4=function(t){var e=Math.cos(t),i=Math.sin(t);return new Float32Array([1,0,0,0,0,e,-i,0,0,i,e,0,0,0,0,1])},o.ROTATION_X_90=o.rotationX4(.5*Math.PI),o.ROTATION_X_180=o.rotationX4(1*Math.PI),o.ROTATION_X_270=o.rotationX4(1.5*Math.PI),o.rotationY4=function(t){var e=Math.cos(t),i=Math.sin(t);return new Float32Array([e,0,i,0,0,1,0,0,-i,0,e,0,0,0,0,1])},
o.ROTATION_Y_90=o.rotationY4(.5*Math.PI),o.ROTATION_Y_180=o.rotationY4(1*Math.PI),o.ROTATION_Y_270=o.rotationY4(1.5*Math.PI),o.rotationZ4=function(t){var e=Math.cos(t),i=Math.sin(t);return new Float32Array([e,-i,0,0,i,e,0,0,0,0,1,0,0,0,0,1])},o.ROTATION_Z_90=o.rotationZ4(.5*Math.PI),o.ROTATION_Z_180=o.rotationZ4(1*Math.PI),o.ROTATION_Z_270=o.rotationZ4(1.5*Math.PI),o.rotation4Aux=function(t,e){var i=Math.cos(e),s=Math.sin(e),n=a[l];return n[0]=i+(1-i)*t[0]*t[0],n[1]=(1-i)*t[0]*t[1]-s*t[2],n[2]=(1-i)*t[0]*t[2]+s*t[1],n[3]=0,n[4]=(1-i)*t[0]*t[1]+s*t[2],n[5]=i+(1-i)*t[1]*t[1],n[6]=(1-i)*t[1]*t[2]-s*t[0],n[7]=0,n[8]=(1-i)*t[0]*t[2]-s*t[1],n[9]=(1-i)*t[1]*t[2]+s*t[0],n[10]=i+(1-i)*t[2]*t[2],n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,l=(l+1)%20,n},o.rotationX4Aux=function(t){var e=Math.cos(t),i=Math.sin(t),s=a[l];return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=e,s[6]=-i,s[7]=0,s[8]=0,s[9]=i,s[10]=e,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,l=(l+1)%20,s},o.rotationY4Aux=function(t){var e=Math.cos(t),i=Math.sin(t),s=a[l];return s[0]=e,s[1]=0,s[2]=i,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=-i,s[9]=0,s[10]=e,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,l=(l+1)%20,s},o.rotationZ4Aux=function(t){var e=Math.cos(t),i=Math.sin(t),s=a[l];return s[0]=e,s[1]=-i,s[2]=0,s[3]=0,s[4]=i,s[5]=e,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,l=(l+1)%20,s},o.rotationAroundPoint4=function(t,i,s){var n=o.rotation4(i,s),r=e.prodVec3Mat4Aux(t,n);return n[12]=t[0]-r[0],n[13]=t[1]-r[1],n[14]=t[2]-r[2],n},o.rotation4m4=function(t){return new Float32Array([t[0],t[1],t[2],0,t[4],t[5],t[6],0,t[8],t[9],t[10],0,0,0,0,1])},o.rotation4m4Aux=function(t){var e=a[l];return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=0,e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,l=(l+1)%20,e},o.lookTowards4=function(t,e){var i;return i=o.identity4(),o.setLookTowards4(i,t,e),i},o.lookTowards4Aux=function(t,e){var i=a[l];return o.setLookTowards4(i,t,e),l=(l+1)%20,i},o.scaling4=function(t,e,i){return void 0===e&&(e=t),void 0===i&&(i=t),new Float32Array([t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1])},o.scaling4Aux=function(t,e,i){var s=a[l];return void 0===e&&(e=t),void 0===i&&(i=t),s[0]=t,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=e,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=i,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,l=(l+1)%20,s},o.translationRotation=function(t,e){return new Float32Array([e[0],e[1],e[2],0,e[4],e[5],e[6],0,e[8],e[9],e[10],0,t[12],t[13],t[14],1])},o.perspective4=function(t,e,i,s){return new Float32Array([i/t,0,0,0,0,i/e,0,0,0,0,(i+s)/(i-s),-1,0,0,2*i*s/(i-s),0])},o.orthographic4=function(t,e,i,s){return new Float32Array([1/t,0,0,0,0,1/e,0,0,0,0,-2/(s-i),0,0,0,-(i+s)/2,1])},o.orthographic4Aux=function(t,e,i,s){var n=a[l];return o.setOrthographic4(n,t,e,i,s),l=(l+1)%20,n},o.rotation4FromJSON=function(i){var s,n,r,a=o.identity4();if(i)for(s=0;s<i.length;s++){if(r="string"==typeof i[s]?{axis:i[s][0],degrees:parseFloat(i[s].substring(1))}:i[s],"string"==typeof r.axis)switch(r.axis){case"x":case"X":n=e.UNIT3_X;break;case"y":case"Y":n=e.UNIT3_Y;break;case"z":case"Z":n=e.UNIT3_Z}else r.axis instanceof Array&&(n=r.axis);o.mul4(a,o.rotation4Aux(n,r.degrees*t.RAD))}return a},o.fromVectorsTo3=function(t,e,i){return new Float32Array([t[0],t[1],t[2],e[0],e[1],e[2],i[0],i[1],i[2]])},o.fromVectorsTo4=function(t,e,i,s){return s=s||[0,0,0,1],new Float32Array([t[0],t[1],t[2],t.length>3?t[3]:0,e[0],e[1],e[2],e.length>3?e[3]:0,i[0],i[1],i[2],i.length>3?i[3]:0,s[0],s[1],s[2],s[3]])},o.getRowA3=function(t){return[t[0],t[1],t[2]]},o.getRowA3Neg=function(t){return[-t[0],-t[1],-t[2]]},o.getRowA4=function(t){return[t[0],t[1],t[2],t[3]]},o.getRowA4Neg=function(t){return[-t[0],-t[1],-t[2],-t[3]]},o.getRowA43=function(t){return[t[0],t[1],t[2]]},o.getRowA43Neg=function(t){return[-t[0],-t[1],-t[2]]},o.getRowB3=function(t){return[t[3],t[4],t[5]]},o.getRowB3Neg=function(t){return[-t[3],-t[4],-t[5]]},o.getRowB4=function(t){return[t[4],t[5],t[6],t[7]]},o.getRowB4Neg=function(t){return[-t[4],-t[5],-t[6],-t[7]]},o.getRowB43=function(t){return[t[4],t[5],t[6]]},o.getRowB43Neg=function(t){return[-t[4],-t[5],-t[6]]},o.getRowC4=function(t){return[t[8],t[9],t[10],t[11]]},o.getRowC43=function(t){return[t[8],t[9],t[10]]},o.getRowC43Neg=function(t){return[-t[8],-t[9],-t[10]]},o.getRowD4=function(t){return[t[12],t[13],t[14],t[15]]},o.determinant3=function(t){return t[0]*t[4]*t[8]+t[1]*t[5]*t[6]+t[2]*t[3]*t[7]-t[2]*t[4]*t[6]-t[1]*t[3]*t[8]-t[0]*t[5]*t[7]},o.translationVector3=function(t){return[t[12],t[13],t[14]]},o.translationVector4=function(t){return[t[12],t[13],t[14],t[15]]},o.translationLength=function(t){return e.length3([t[12],t[13],t[14]])},o.getVectorYawAndPitch=function(i){var s,n={};return Math.abs(i[2])>.99999?(n.yaw=0,n.pitch=i[2]>0?-t.HALF_PI:t.HALF_PI):(n.yaw=e.angle2yCapped(i[0],i[1]),i[0]<0&&(n.yaw=-n.yaw),s=e.prodVec3Mat4Aux(i,o.rotationZ4Aux(-n.yaw)),n.pitch=e.angle2xCapped(s[1],s[2]),s[2]>0&&(n.pitch=-n.pitch)),n},o.getYawAndPitch=function(i){var s,n={};return Math.abs(i[6])>.99999?(n.yaw=0,n.pitch=i[6]>0?-t.HALF_PI:t.HALF_PI):(n.yaw=i[10]>0?e.angle2yCapped(i[4],i[5]):e.angle2yCapped(-i[4],-i[5]),i[4]*i[10]<0&&(n.yaw=-n.yaw),s=o.prod3x3SubOf4Aux(i,o.rotationZ4Aux(-n.yaw)),o.correctOrthogonal4(s),n.pitch=e.angle2xCapped(s[5],s[6]),s[6]>0&&(n.pitch=-n.pitch)),n},o.getRotations=function(i){var s,n,r={};return s=e.dot3(e.UNIT3_Y,o.getRowB43(i)),Math.abs(s)>.99999?(r.alphaAxis=[0,0,1],r.alpha=s>0?0:Math.PI):(r.alphaAxis=e.normalize3(e.cross3(o.getRowB43(i),e.UNIT3_Y)),r.alpha=e.angle3u(o.getRowB43(i),e.UNIT3_Y)),r.alpha>Math.PI&&(r.alpha-=t.DOUBLE_PI),n=o.prod3x3SubOf43Aux(i,o.rotation3Aux(r.alphaAxis,-r.alpha)),o.correctOrthogonal4(n),s=e.dot3(e.UNIT3_X,o.getRowA43(n)),Math.abs(s)>.99999?(r.gammaAxis=[0,1,0],r.gamma=s>0?0:Math.PI):(r.gammaAxis=e.normalize3(e.cross3(o.getRowA43(n),e.UNIT3_X)),r.gamma=e.angle3u(o.getRowA43(n),e.UNIT3_X)),r.gamma>Math.PI&&(r.gamma-=t.DOUBLE_PI),r},o.toString3=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)+"\n"+t[3].toFixed(e)+" "+t[4].toFixed(e)+" "+t[5].toFixed(e)+"\n"+t[6].toFixed(e)+" "+t[7].toFixed(e)+" "+t[8].toFixed(e)},o.toString4=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)+" "+t[3].toFixed(e)+"\n"+t[4].toFixed(e)+" "+t[5].toFixed(e)+" "+t[6].toFixed(e)+" "+t[7].toFixed(e)+"\n"+t[8].toFixed(e)+" "+t[9].toFixed(e)+" "+t[10].toFixed(e)+" "+t[11].toFixed(e)+"\n"+t[12].toFixed(e)+" "+t[13].toFixed(e)+" "+t[14].toFixed(e)+" "+t[15].toFixed(e)},o.toHTMLString4=function(t,e){return e=e||2,t[0].toFixed(e)+" "+t[1].toFixed(e)+" "+t[2].toFixed(e)+" "+t[3].toFixed(e)+"<br/>"+t[4].toFixed(e)+" "+t[5].toFixed(e)+" "+t[6].toFixed(e)+" "+t[7].toFixed(e)+"<br/>"+t[8].toFixed(e)+" "+t[9].toFixed(e)+" "+t[10].toFixed(e)+" "+t[11].toFixed(e)+"<br/>"+t[12].toFixed(e)+" "+t[13].toFixed(e)+" "+t[14].toFixed(e)+" "+t[15].toFixed(e)},o.matrix3from4=function(t){return new Float32Array([t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]])},o.matrix3from4Aux=function(t){var e=h[u];return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],u=(u+1)%20,e},o.matrix4from3=function(t){return new Float32Array([t[0],t[1],t[2],0,t[3],t[4],t[5],0,t[6],t[7],t[8],0,0,0,0,1])},o.transposed3=function(t){return new Float32Array([t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8]])},o.transposed3Aux=function(t){var e=h[u];return o.setTransposed3(e,t),u=(u+1)%20,e},o.transposed43=function(t){return new Float32Array([t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]])},o.transposed4=function(t){return new Float32Array([t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15]])},o.transposed4Aux=function(t){var e=a[l];return o.setTransposed4(e,t),l=(l+1)%20,e},o.inverse3=function(t){var e;return e=o.identity3(),o.setInverse3(e,t),e},o.inverse3Aux=function(t){var e=h[u];return o.setInverse3(e,t),u=(u+1)%20,e},o.inverse4=function(t){var e;return e=o.identity4(),o.setInverse4(e,t),e},o.inverse4Aux=function(t){var e=a[l];return o.setInverse4(e,t),l=(l+1)%20,e},o.inverseOfTranslation4=function(t){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,-t[12],-t[13],-t[14],1])},o.inverseOfTranslation4Aux=function(t){var e=a[l];return o.setInverseOfTranslation4(e,t),l=(l+1)%20,e},o.inverseOfRotation4=o.transposed4,o.inverseOfRotation4Aux=o.transposed4Aux,o.inverseOfScaling4=function(t){return o.scaling4(1/t[0],1/t[5],1/t[10])},o.scaled3=function(t,e){return new Float32Array([t[0]*e,t[1]*e,t[2]*e,t[3]*e,t[4]*e,t[5]*e,t[6]*e,t[7]*e,t[8]*e])},o.scaled4=function(t,e){return new Float32Array([t[0]*e,t[1]*e,t[2]*e,t[3]*e,t[4]*e,t[5]*e,t[6]*e,t[7]*e,t[8]*e,t[9]*e,t[10]*e,t[11]*e,t[12]*e,t[13]*e,t[14]*e,t[15]*e])},o.correctedOrthogonal4=function(t){var i=e.normalize3([t[0],t[1],t[2]]),s=e.normalize3([t[4],t[5],t[6]]),n=e.cross3(i,s);return s=e.cross3(n,i),new Float32Array([i[0],i[1],i[2],0,s[0],s[1],s[2],0,n[0],n[1],n[2],0,0,0,0,1])},o.straightened=function(t,e){var i,s=new Float32Array(t);for(i=0;i<s.length;i++)s[i]=Math.abs(t[i])<e?0:Math.abs(1-t[i])<e?1:Math.abs(-1-t[i])<e?-1:t[i];return s},o.equal4=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]},o.sum4=function(t,e){return new Float32Array([t[0]+e[0],t[1]+e[1],t[2]+e[2],t[3]+e[3],t[4]+e[4],t[5]+e[5],t[6]+e[6],t[7]+e[7],t[8]+e[8],t[9]+e[9],t[10]+e[10],t[11]+e[11],t[12]+e[12],t[13]+e[13],t[14]+e[14],t[15]+e[15]])},o.prod3=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[3]+t[2]*e[6],t[0]*e[1]+t[1]*e[4]+t[2]*e[7],t[0]*e[2]+t[1]*e[5]+t[2]*e[8],t[3]*e[0]+t[4]*e[3]+t[5]*e[6],t[3]*e[1]+t[4]*e[4]+t[5]*e[7],t[3]*e[2]+t[4]*e[5]+t[5]*e[8],t[6]*e[0]+t[7]*e[3]+t[8]*e[6],t[6]*e[1]+t[7]*e[4]+t[8]*e[7],t[6]*e[2]+t[7]*e[5]+t[8]*e[8]])},o.prod4=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[4]+t[2]*e[8]+t[3]*e[12],t[0]*e[1]+t[1]*e[5]+t[2]*e[9]+t[3]*e[13],t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+t[3]*e[14],t[0]*e[3]+t[1]*e[7]+t[2]*e[11]+t[3]*e[15],t[4]*e[0]+t[5]*e[4]+t[6]*e[8]+t[7]*e[12],t[4]*e[1]+t[5]*e[5]+t[6]*e[9]+t[7]*e[13],t[4]*e[2]+t[5]*e[6]+t[6]*e[10]+t[7]*e[14],t[4]*e[3]+t[5]*e[7]+t[6]*e[11]+t[7]*e[15],t[8]*e[0]+t[9]*e[4]+t[10]*e[8]+t[11]*e[12],t[8]*e[1]+t[9]*e[5]+t[10]*e[9]+t[11]*e[13],t[8]*e[2]+t[9]*e[6]+t[10]*e[10]+t[11]*e[14],t[8]*e[3]+t[9]*e[7]+t[10]*e[11]+t[11]*e[15],t[12]*e[0]+t[13]*e[4]+t[14]*e[8]+t[15]*e[12],t[12]*e[1]+t[13]*e[5]+t[14]*e[9]+t[15]*e[13],t[12]*e[2]+t[13]*e[6]+t[14]*e[10]+t[15]*e[14],t[12]*e[3]+t[13]*e[7]+t[14]*e[11]+t[15]*e[15]])},o.prod4Aux=function(t,e){var i=a[l];return o.setProd4(i,t,e),l=(l+1)%20,i},o.prod3x3SubOf43=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[4]+t[2]*e[8],t[0]*e[1]+t[1]*e[5]+t[2]*e[9],t[0]*e[2]+t[1]*e[6]+t[2]*e[10],t[4]*e[0]+t[5]*e[4]+t[6]*e[8],t[4]*e[1]+t[5]*e[5]+t[6]*e[9],t[4]*e[2]+t[5]*e[6]+t[6]*e[10],t[8]*e[0]+t[9]*e[4]+t[10]*e[8],t[8]*e[1]+t[9]*e[5]+t[10]*e[9],t[8]*e[2]+t[9]*e[6]+t[10]*e[10]])},o.prod3x3SubOf4=function(t,e){return new Float32Array([t[0]*e[0]+t[1]*e[4]+t[2]*e[8],t[0]*e[1]+t[1]*e[5]+t[2]*e[9],t[0]*e[2]+t[1]*e[6]+t[2]*e[10],0,t[4]*e[0]+t[5]*e[4]+t[6]*e[8],t[4]*e[1]+t[5]*e[5]+t[6]*e[9],t[4]*e[2]+t[5]*e[6]+t[6]*e[10],0,t[8]*e[0]+t[9]*e[4]+t[10]*e[8],t[8]*e[1]+t[9]*e[5]+t[10]*e[9],t[8]*e[2]+t[9]*e[6]+t[10]*e[10],0,0,0,0,1])},o.prod3x3SubOf4Aux=function(t,e){var i=a[l];return i[0]=t[0]*e[0]+t[1]*e[4]+t[2]*e[8],i[1]=t[0]*e[1]+t[1]*e[5]+t[2]*e[9],i[2]=t[0]*e[2]+t[1]*e[6]+t[2]*e[10],i[3]=0,i[4]=t[4]*e[0]+t[5]*e[4]+t[6]*e[8],i[5]=t[4]*e[1]+t[5]*e[5]+t[6]*e[9],i[6]=t[4]*e[2]+t[5]*e[6]+t[6]*e[10],i[7]=0,i[8]=t[8]*e[0]+t[9]*e[4]+t[10]*e[8],i[9]=t[8]*e[1]+t[9]*e[5]+t[10]*e[9],i[10]=t[8]*e[2]+t[9]*e[6]+t[10]*e[10],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,l=(l+1)%20,i},o.prodScalingRotation=function(t,e){return new Float32Array([t[0]*e[0],t[0]*e[1],t[0]*e[2],0,t[5]*e[4],t[5]*e[5],t[5]*e[6],0,t[10]*e[8],t[10]*e[9],t[10]*e[10],0,0,0,0,1])},o.prodScalingRotationAux=function(t,e){var i=a[l];return i[0]=t[0]*e[0],i[1]=t[0]*e[1],i[2]=t[0]*e[2],i[3]=0,i[4]=t[5]*e[4],i[5]=t[5]*e[5],i[6]=t[5]*e[6],i[7]=0,i[8]=t[10]*e[8],i[9]=t[10]*e[9],i[10]=t[10]*e[10],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,l=(l+1)%20,i},o.prodScalingRotation3Aux=function(t,e){var i=h[u];return i[0]=t[0]*e[0],i[1]=t[0]*e[1],i[2]=t[0]*e[2],i[3]=t[5]*e[4],i[4]=t[5]*e[5],i[5]=t[5]*e[6],i[6]=t[10]*e[8],i[7]=t[10]*e[9],i[8]=t[10]*e[10],u=(u+1)%20,i},o.prod3x3SubOf43Aux=function(t,e){var i=a[l];return i[0]=t[0]*e[0]+t[1]*e[3]+t[2]*e[6],i[1]=t[0]*e[1]+t[1]*e[4]+t[2]*e[7],i[2]=t[0]*e[2]+t[1]*e[5]+t[2]*e[8],i[3]=0,i[4]=t[4]*e[0]+t[5]*e[3]+t[6]*e[6],i[5]=t[4]*e[1]+t[5]*e[4]+t[6]*e[7],i[6]=t[4]*e[2]+t[5]*e[5]+t[6]*e[8],i[7]=0,i[8]=t[8]*e[0]+t[9]*e[3]+t[10]*e[6],i[9]=t[8]*e[1]+t[9]*e[4]+t[10]*e[7],i[10]=t[8]*e[2]+t[9]*e[5]+t[10]*e[8],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,l=(l+1)%20,i},o.prodTranslationRotation4=function(t,e){return new Float32Array([e[0],e[1],e[2],0,e[4],e[5],e[6],0,e[8],e[9],e[10],0,e[0]*t[12]+e[4]*t[13]+e[8]*t[14],e[1]*t[12]+e[5]*t[13]+e[9]*t[14],e[2]*t[12]+e[6]*t[13]+e[10]*t[14],1])},o.prodTranslationRotation4Aux=function(t,e){var i=a[l];return o.setProdTranslationRotation4(i,t,e),l=(l+1)%20,i},o.prod34=function(t,e,i){var s=o.prod4(t,e);return o.mul4(s,i),s},o.prod34Aux=function(t,e,i){var s=o.prod4Aux(t,e);return o.mul4(s,i),s},o.translatedByVector=function(t,e){return new Float32Array([t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12]+e[0],t[13]+e[1],t[14]+e[2],t[15]])},o.translatedByVectorAux=function(t,e){var i=a[l];return o.setTranslatedByVector(i,t,e),l=(l+1)%20,i},o.translatedByM4=function(t,e){return new Float32Array([t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12]+e[12],t[13]+e[13],t[14]+e[14],t[15]])},o.translatedByM4Aux=function(t,e){var i=a[l];return o.setTranslatedByM4(i,t,e),l=(l+1)%20,i},o.distanceSquared=function(t,e){return(t[12]-e[12])*(t[12]-e[12])+(t[13]-e[13])*(t[13]-e[13])+(t[14]-e[14])*(t[14]-e[14])},o.setNull3=function(t){t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t[8]=0},o.setIdentity3=function(t){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1},o.setIdentity4=function(t){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1},o.setMatrix3=function(t,e){var i;for(i=0;i<9;i++)t[i]=e[i]},o.setMatrix4=function(t,e){var i;for(i=0;i<16;i++)t[i]=e[i]},o.copyTranslation4=function(t,e){t[12]=e[12],t[13]=e[13],t[14]=e[14]},o.copyScaling4=function(t,e){t[0]=e[0],t[5]=e[5],t[10]=e[10]},o.setTranslation4v=function(t,e){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1},o.updateTranslation4v=function(t,e){t[12]=e[0],t[13]=e[1],t[14]=e[2]},o.setRotation2=function(t,e){var i=Math.cos(e),s=Math.sin(e);t[0]=i,t[1]=-s,t[2]=s,t[3]=i},o.setRotation3=function(t,e,i){var s=Math.cos(i),n=Math.sin(i);t[0]=s+(1-s)*e[0]*e[0],t[1]=(1-s)*e[0]*e[1]-n*e[2],t[2]=(1-s)*e[0]*e[2]+n*e[1],t[3]=(1-s)*e[0]*e[1]+n*e[2],t[4]=s+(1-s)*e[1]*e[1],t[5]=(1-s)*e[1]*e[2]-n*e[0],t[6]=(1-s)*e[0]*e[2]-n*e[1],t[7]=(1-s)*e[1]*e[2]+n*e[0],t[8]=s+(1-s)*e[2]*e[2]},o.setRotation4=function(t,e,i){var s=Math.cos(i),n=Math.sin(i);t[0]=s+(1-s)*e[0]*e[0],t[1]=(1-s)*e[0]*e[1]-n*e[2],t[2]=(1-s)*e[0]*e[2]+n*e[1],t[3]=0,t[4]=(1-s)*e[0]*e[1]+n*e[2],t[5]=s+(1-s)*e[1]*e[1],t[6]=(1-s)*e[1]*e[2]-n*e[0],t[7]=0,t[8]=(1-s)*e[0]*e[2]-n*e[1],t[9]=(1-s)*e[1]*e[2]+n*e[0],t[10]=s+(1-s)*e[2]*e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1},o.setRotationAroundPoint4=function(t,i,s,n){var r;o.setRotation4(t,s,n),r=e.prodVec3Mat4Aux(i,t),t[12]=i[0]-r[0],t[13]=i[1]-r[1],t[14]=i[2]-r[2]},o.setLookTowards4=function(t,i,s){var n;s=s||[0,1,0],Math.abs(e.dot3(s,i))>.99999&&(s=e.perpendicular3(i)),n=e.cross3(s,i),t[0]=n[0],t[1]=n[1],t[2]=n[2],s=e.cross3(i,n),t[4]=s[0],t[5]=s[1],t[6]=s[2],o.correctOrthogonal4(t)},o.translateByVector=function(t,e){t[12]+=e[0],t[13]+=e[1],t[14]+=e[2]},o.translateByMatrix=function(t,e){t[12]+=e[12],t[13]+=e[13],t[14]+=e[14]},o.translateByMatrixMul=function(t,e,i){t[12]+=e[12]*i,t[13]+=e[13]*i,t[14]+=e[14]*i},o.rotate4=function(t,e,r){var a=i(),l=s(a);o.setRotation3(l,e,r),o.mul43(t,l),n(a)},o.rotateAroundPoint4=function(t,e,r,a){var l=i(),h=s(l);o.setRotationAroundPoint4(h,e,r,a),o.mul4(t,h),n(l)},o.setInverse3=function(t,e){var r,a,l,h,u,c,_,d=i();if(c=s(d),o.setMatrix3(c,e),0===o.determinant3(c))return void o.setNull3(t);for(o.setIdentity3(t),r=0;r<3;r++){if(Math.abs(c[4*r])<=1e-4){for(a=r+1;Math.abs(c[3*a+r])<=1e-4;)a++;for(l=0;l<3;l++)_=c[3*r+l],c[3*r+l]=c[3*a+l],c[3*a+l]=_,_=t[3*r+l],t[3*r+l]=t[3*a+l],t[3*a+l]=_}for(h=c[4*r],a=0;a<3;a++)c[3*r+a]=c[3*r+a]/h,t[3*r+a]=t[3*r+a]/h;for(a=r+1;a<3;a++)for(u=c[3*a+r]/c[4*r],l=0;l<3;l++)c[3*a+l]=c[3*a+l]-u*c[3*r+l],t[3*a+l]=t[3*a+l]-u*t[3*r+l]}for(r=2;r>=1;r--)for(a=r-1;a>=0;a--)for(l=0;l<3;l++)t[3*a+l]=t[3*a+l]-c[3*a+r]*t[3*r+l];n(d)},o.setInverse4=function(t,e){var r,a,l,h,u,c,_,d=i();for(c=s(d),o.setMatrix4(c,e),o.setIdentity4(t),r=0;r<4;r++){if(Math.abs(c[5*r])<=1e-4){for(a=r+1;Math.abs(c[4*a+r])<=1e-4;)a++;for(l=0;l<4;l++)_=c[4*r+l],c[4*r+l]=c[4*a+l],c[4*a+l]=_,_=t[4*r+l],t[4*r+l]=t[4*a+l],t[4*a+l]=_}for(h=c[5*r],a=0;a<4;a++)c[4*r+a]=c[4*r+a]/h,t[4*r+a]=t[4*r+a]/h;for(a=r+1;a<4;a++)for(u=c[4*a+r]/c[5*r],l=0;l<4;l++)c[4*a+l]=c[4*a+l]-u*c[4*r+l],t[4*a+l]=t[4*a+l]-u*t[4*r+l]}for(r=3;r>=1;r--)for(a=r-1;a>=0;a--)for(l=0;l<4;l++)t[4*a+l]=t[4*a+l]-c[4*a+r]*t[4*r+l];n(d)},o.setInverseOfTranslation4=function(t,e){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=-e[12],t[13]=-e[13],t[14]=-e[14],t[15]=1},o.setTransposed3=function(t,e){t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8]},o.setTransposed4=function(t,e){t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15]},o.setInverseOfRotation4=o.setTransposed4,o.setInverseOfScaling4=function(t,e){t[0]=1/e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1/e[5],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1/e[10],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1},o.mul3=function(t,e){var r=i(),a=s(r);o.setMatrix3(a,t),t[0]=a[0]*e[0]+a[1]*e[3]+a[2]*e[6],t[1]=a[0]*e[1]+a[1]*e[4]+a[2]*e[7],t[2]=a[0]*e[2]+a[1]*e[5]+a[2]*e[8],t[3]=a[3]*e[0]+a[4]*e[3]+a[5]*e[6],t[4]=a[3]*e[1]+a[4]*e[4]+a[5]*e[7],t[5]=a[3]*e[2]+a[4]*e[5]+a[5]*e[8],t[6]=a[6]*e[0]+a[7]*e[3]+a[8]*e[6],t[7]=a[6]*e[1]+a[7]*e[4]+a[8]*e[7],t[8]=a[6]*e[2]+a[7]*e[5]+a[8]*e[8],n(r)},o.mul4=function(t,e){var r=i(),a=s(r);o.setMatrix4(a,t),t[0]=a[0]*e[0]+a[1]*e[4]+a[2]*e[8]+a[3]*e[12],t[1]=a[0]*e[1]+a[1]*e[5]+a[2]*e[9]+a[3]*e[13],t[2]=a[0]*e[2]+a[1]*e[6]+a[2]*e[10]+a[3]*e[14],t[3]=a[0]*e[3]+a[1]*e[7]+a[2]*e[11]+a[3]*e[15],t[4]=a[4]*e[0]+a[5]*e[4]+a[6]*e[8]+a[7]*e[12],t[5]=a[4]*e[1]+a[5]*e[5]+a[6]*e[9]+a[7]*e[13],t[6]=a[4]*e[2]+a[5]*e[6]+a[6]*e[10]+a[7]*e[14],t[7]=a[4]*e[3]+a[5]*e[7]+a[6]*e[11]+a[7]*e[15],t[8]=a[8]*e[0]+a[9]*e[4]+a[10]*e[8]+a[11]*e[12],t[9]=a[8]*e[1]+a[9]*e[5]+a[10]*e[9]+a[11]*e[13],t[10]=a[8]*e[2]+a[9]*e[6]+a[10]*e[10]+a[11]*e[14],t[11]=a[8]*e[3]+a[9]*e[7]+a[10]*e[11]+a[11]*e[15],t[12]=a[12]*e[0]+a[13]*e[4]+a[14]*e[8]+a[15]*e[12],t[13]=a[12]*e[1]+a[13]*e[5]+a[14]*e[9]+a[15]*e[13],t[14]=a[12]*e[2]+a[13]*e[6]+a[14]*e[10]+a[15]*e[14],t[15]=a[12]*e[3]+a[13]*e[7]+a[14]*e[11]+a[15]*e[15],n(r)},o.mul4Proj=function(t,e){var r=i(),a=s(r);o.setMatrix4(a,t),t[0]=a[0]*e[0],t[1]=a[1]*e[5],t[2]=a[2]*e[10]+a[3]*e[14],t[3]=-a[2],t[4]=a[4]*e[0],t[5]=a[5]*e[5],t[6]=a[6]*e[10]+a[7]*e[14],t[7]=-a[6],t[8]=a[8]*e[0],t[9]=a[9]*e[5],t[10]=a[10]*e[10]+a[11]*e[14],t[11]=-a[10],t[12]=a[12]*e[0],t[13]=a[13]*e[5],t[14]=a[14]*e[10]+a[15]*e[14],t[15]=-a[14],n(r)},o.mul43=function(t,e){var r=i(),a=s(r);o.setMatrix4(a,t),t[0]=a[0]*e[0]+a[1]*e[3]+a[2]*e[6],t[1]=a[0]*e[1]+a[1]*e[4]+a[2]*e[7],t[2]=a[0]*e[2]+a[1]*e[5]+a[2]*e[8],t[4]=a[4]*e[0]+a[5]*e[3]+a[6]*e[6],t[5]=a[4]*e[1]+a[5]*e[4]+a[6]*e[7],t[6]=a[4]*e[2]+a[5]*e[5]+a[6]*e[8],t[8]=a[8]*e[0]+a[9]*e[3]+a[10]*e[6],t[9]=a[8]*e[1]+a[9]*e[4]+a[10]*e[7],t[10]=a[8]*e[2]+a[9]*e[5]+a[10]*e[8],t[12]=a[12]*e[0]+a[13]*e[3]+a[14]*e[6],t[13]=a[12]*e[1]+a[13]*e[4]+a[14]*e[7],t[14]=a[12]*e[2]+a[13]*e[5]+a[14]*e[8],n(r)},o.mulRotation43=function(t,e){var r=i(),a=s(r);o.setMatrix4(a,t),t[0]=a[0]*e[0]+a[1]*e[3]+a[2]*e[6],t[1]=a[0]*e[1]+a[1]*e[4]+a[2]*e[7],t[2]=a[0]*e[2]+a[1]*e[5]+a[2]*e[8],t[4]=a[4]*e[0]+a[5]*e[3]+a[6]*e[6],t[5]=a[4]*e[1]+a[5]*e[4]+a[6]*e[7],t[6]=a[4]*e[2]+a[5]*e[5]+a[6]*e[8],t[8]=a[8]*e[0]+a[9]*e[3]+a[10]*e[6],t[9]=a[8]*e[1]+a[9]*e[4]+a[10]*e[7],t[10]=a[8]*e[2]+a[9]*e[5]+a[10]*e[8],n(r)},o.mulRotationRotation4=function(t,e){var r=i(),a=s(r);o.setMatrix4(a,t),t[0]=a[0]*e[0]+a[1]*e[4]+a[2]*e[8],t[1]=a[0]*e[1]+a[1]*e[5]+a[2]*e[9],t[2]=a[0]*e[2]+a[1]*e[6]+a[2]*e[10],t[4]=a[4]*e[0]+a[5]*e[4]+a[6]*e[8],t[5]=a[4]*e[1]+a[5]*e[5]+a[6]*e[9],t[6]=a[4]*e[2]+a[5]*e[6]+a[6]*e[10],t[8]=a[8]*e[0]+a[9]*e[4]+a[10]*e[8],t[9]=a[8]*e[1]+a[9]*e[5]+a[10]*e[9],t[10]=a[8]*e[2]+a[9]*e[6]+a[10]*e[10],n(r)},o.setProd4=function(t,e,i){t[0]=e[0]*i[0]+e[1]*i[4]+e[2]*i[8]+e[3]*i[12],t[1]=e[0]*i[1]+e[1]*i[5]+e[2]*i[9]+e[3]*i[13],t[2]=e[0]*i[2]+e[1]*i[6]+e[2]*i[10]+e[3]*i[14],t[3]=e[0]*i[3]+e[1]*i[7]+e[2]*i[11]+e[3]*i[15],t[4]=e[4]*i[0]+e[5]*i[4]+e[6]*i[8]+e[7]*i[12],t[5]=e[4]*i[1]+e[5]*i[5]+e[6]*i[9]+e[7]*i[13],t[6]=e[4]*i[2]+e[5]*i[6]+e[6]*i[10]+e[7]*i[14],t[7]=e[4]*i[3]+e[5]*i[7]+e[6]*i[11]+e[7]*i[15],t[8]=e[8]*i[0]+e[9]*i[4]+e[10]*i[8]+e[11]*i[12],t[9]=e[8]*i[1]+e[9]*i[5]+e[10]*i[9]+e[11]*i[13],t[10]=e[8]*i[2]+e[9]*i[6]+e[10]*i[10]+e[11]*i[14],t[11]=e[8]*i[3]+e[9]*i[7]+e[10]*i[11]+e[11]*i[15],t[12]=e[12]*i[0]+e[13]*i[4]+e[14]*i[8]+e[15]*i[12],t[13]=e[12]*i[1]+e[13]*i[5]+e[14]*i[9]+e[15]*i[13],t[14]=e[12]*i[2]+e[13]*i[6]+e[14]*i[10]+e[15]*i[14],t[15]=e[12]*i[3]+e[13]*i[7]+e[14]*i[11]+e[15]*i[15]},o.setProd4NoProj=function(t,e,i){t[0]=e[0]*i[0]+e[1]*i[4]+e[2]*i[8],t[1]=e[0]*i[1]+e[1]*i[5]+e[2]*i[9],t[2]=e[0]*i[2]+e[1]*i[6]+e[2]*i[10],t[4]=e[4]*i[0]+e[5]*i[4]+e[6]*i[8],t[5]=e[4]*i[1]+e[5]*i[5]+e[6]*i[9],t[6]=e[4]*i[2]+e[5]*i[6]+e[6]*i[10],t[8]=e[8]*i[0]+e[9]*i[4]+e[10]*i[8],t[9]=e[8]*i[1]+e[9]*i[5]+e[10]*i[9],t[10]=e[8]*i[2]+e[9]*i[6]+e[10]*i[10],t[12]=e[12]*i[0]+e[13]*i[4]+e[14]*i[8]+i[12],t[13]=e[12]*i[1]+e[13]*i[5]+e[14]*i[9]+i[13],t[14]=e[12]*i[2]+e[13]*i[6]+e[14]*i[10]+i[14]},o.setProd3x3SubOf4=function(t,e,i){t[0]=e[0]*i[0]+e[1]*i[4]+e[2]*i[8],t[1]=e[0]*i[1]+e[1]*i[5]+e[2]*i[9],t[2]=e[0]*i[2]+e[1]*i[6]+e[2]*i[10],t[3]=0,t[4]=e[4]*i[0]+e[5]*i[4]+e[6]*i[8],t[5]=e[4]*i[1]+e[5]*i[5]+e[6]*i[9],t[6]=e[4]*i[2]+e[5]*i[6]+e[6]*i[10],t[7]=0,t[8]=e[8]*i[0]+e[9]*i[4]+e[10]*i[8],t[9]=e[8]*i[1]+e[9]*i[5]+e[10]*i[9],t[10]=e[8]*i[2]+e[9]*i[6]+e[10]*i[10],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1},o.setScalingToProdScalingScaling4=function(t,e,i){t[0]=e[0]*i[0],t[5]=e[5]*i[5],t[10]=e[10]*i[10]},o.setProdTranslationRotation4=function(t,e,i){t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=0,t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=0,t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=0,t[12]=i[0]*e[12]+i[4]*e[13]+i[8]*e[14],t[13]=i[1]*e[12]+i[5]*e[13]+i[9]*e[14],t[14]=i[2]*e[12]+i[6]*e[13]+i[10]*e[14],t[15]=1},o.setModelMatrix=function(t,e,i,s){t[0]=s[0]*i[0],t[1]=s[0]*i[1],t[2]=s[0]*i[2],t[4]=s[5]*i[4],t[5]=s[5]*i[5],t[6]=s[5]*i[6],t[8]=s[10]*i[8],t[9]=s[10]*i[9],t[10]=s[10]*i[10],t[12]=e[12],t[13]=e[13],t[14]=e[14]},o.setTranslatedByVector=function(t,e,i){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12]+i[0],t[13]=e[13]+i[1],t[14]=e[14]+i[2],t[15]=e[15]},o.setTranslatedByM4=function(t,e,i){t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12]+i[12],t[13]=e[13]+i[13],t[14]=e[14]+i[14],t[15]=e[15]},o.setPerspective4=function(t,e,i,s,n){t[0]=s/e,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=s/i,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(s+n)/(s-n),t[11]=-1,t[12]=0,t[13]=0,t[14]=2*s*n/(s-n),t[15]=0},o.setOrthographic4=function(t,e,i,s,n){t[0]=1/e,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1/i,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=-2/(n-s),t[11]=0,t[12]=0,t[13]=0,t[14]=-(s+n)/2,t[15]=1},o.correctOrthogonal4=function(t){var i=e.normalize3([t[0],t[1],t[2]]),s=e.normalize3([t[4],t[5],t[6]]),n=e.cross3(i,s);s=e.cross3(n,i),t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=0,t[4]=s[0],t[5]=s[1],t[6]=s[2],t[7]=0,t[8]=n[0],t[9]=n[1],t[10]=n[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1},o.straighten=function(t,e){var i;for(i=0;i<t.length;i++)t[i]=Math.abs(t[i])<e?0:Math.abs(1-t[i])<e?1:Math.abs(-1-t[i])<e?-1:t[i]},o.straightenTranslation=function(t,e){var i;for(i=12;i<14;i++)t[i]=Math.abs(t[i])<e?0:Math.abs(1-t[i])<e?1:Math.abs(-1-t[i])<e?-1:t[i]},o.straightenRotation4=function(t,e){var i;for(i=0;i<10;i++)t[i]=Math.abs(t[i])<e?0:Math.abs(1-t[i])<e?1:Math.abs(-1-t[i])<e?-1:t[i]},function(){var t;for(t=0;t<20;t++)a.push(o.identity4());for(t=0;t<20;t++)h.push(o.identity3())}(),o}),define("modules/managed-gl",["utils/utils","utils/types","modules/application","modules/async-resource"],function(t,e,i,s){"use strict";function n(t){switch(t){case f.NONE:return 0;case f.FLOAT:return 1;case f.VEC2:return 2;case f.VEC3:return 3;case f.VEC4:case f.MAT2:return 4;case f.MAT3:return 9;case f.MAT4:return 16;case f.SAMPLER2D:case f.SAMPLER_CUBE:case f.INT:case f.BOOL:return 1;default:return i.showError("Cannot determine vector size of GLSL type '"+t+"'!"),0}}function o(t){switch(t){case f.NONE:return 0;case f.FLOAT:case f.VEC2:case f.VEC3:case f.VEC4:return 1;case f.MAT2:return 2;case f.MAT3:return 3;case f.MAT4:return 4;case f.SAMPLER2D:case f.SAMPLER_CUBE:case f.INT:case f.BOOL:return 1;default:return i.showError("Cannot determine vector count of GLSL type '"+t+"'!"),0}}function r(t){return t===f.SAMPLER2D||t===f.SAMPLER_CUBE}function a(t){return t?1:0}function l(t,e,i){this._name=t,this._image=e,this._mipmap=void 0===i||i,this._ids={},this._locations={}}function h(t,e){this._name=t,this._images=e,this._ids={},this._locations={}}function u(t,e,i){this.name=t,this.size=e,this.role=i}function c(t,s,n,o){var a;if(this._name=t,this._type=e.getEnumValue(f,s,{name:"uniform "+this._name+".type",defaultValue:f.NONE}),this._arraySize=n||0,this._unpacked=o,this._unpacked&&(!r(this._type)||this._arraySize<1)&&(i.showError("Uniform '"+this._name+"' cannot be declared as an unpacked array!"),this._unpacked=!1),this._members=this._type===f.STRUCT?[]:null,this._locations={},this._numericValues={},this._prefixes=null,this._type===f.STRUCT)if(this._prefixes=[],this._arraySize>0)for(a=0;a<this._arraySize;a++)this._prefixes.push(this._name+"["+a+"].");else this._prefixes.push(this._name+".");switch(this._setConstantValue=null,this._type){case f.FLOAT:this._arraySize>0?this._setConstantValue=this._setFloatArrayValue:this._setConstantValue=this._setFloatValue;break;case f.VEC2:this._setConstantValue=this._setVec2Value;break;case f.VEC3:this._setConstantValue=this._setVec3Value;break;case f.VEC4:this._setConstantValue=this._setVec4Value;break;case f.MAT2:this._setConstantValue=this._setMat2Value;break;case f.MAT3:this._setConstantValue=this._setMat3Value;break;case f.MAT4:this._setConstantValue=this._setMat4Value;break;case f.SAMPLER2D:case f.SAMPLER_CUBE:case f.INT:this._arraySize>0?this._unpacked?this._setConstantValue=this._setUnpackedIntArrayValue:this._setConstantValue=this._setIntArrayValue:this._setConstantValue=this._setIntValue;break;case f.BOOL:this._arraySize>0?this._setConstantValue=this._setBoolArrayValue:this._setConstantValue=this._setBoolValue;break;case f.STRUCT:this._arraySize>0?this._setConstantValue=this._setStructArrayValue:this._setConstantValue=this._setStructValue}}function _(t,e,i,s){this._name=t,this._role=e,this._vectorSize=i,this._data=new Float32Array(s*this._vectorSize),this._ids={},this._locations={},this._filledVectors=0,this._dirty=!1}function d(t,e,i,s){this._name=t,this._id=null,this._width=e,this._height=i,this._depthOnly=!!s,this._textureID=null,this._textureLocation=this.TEXTURE_LOCATION_NOT_SET,this._renderBufferID=null}function p(t,e,s,n,o,r,a,l){this._name=t,this._blendMode=n,this._vertexAttributes=[],this._instanceAttributes=[],this._uniforms=[],this._vertexShaderSource=e,this._fragmentShaderSource=s,this._ids={},this._instanceAttributeBuffers=[],this._uniformNamesForInstanceAttributeNames=r,this._instanceAttributeNames=Object.keys(r),this._numVertexUniformVectors=0,this._numAttributeVectors=0,this._numVaryingVectors=0,this._numTextureUnits=0,this._numFragmentUniformVectors=0,this._vertexShaderSource?this._fragmentShaderSource?this._parseShaderSources(o,a,l):i.showError("Cannot initialize shader '"+this._name+"': no fragment shader source specified!"):i.showError("Cannot initialize shader '"+this._name+"': no vertex shader source specified!")}function g(t,e,i,n,o,r){s.AsyncResource.call(this),this._name=t,this._canvas=e,this.gl=null,this._antialiasing=!0===i,this._alpha=void 0===n||n,this._filtering=null,this.anisotropicFilterExt=null,this.instancingExt=null,this.depthTextureExt=null,this._shaders=[],this._models=[],this._vertexBuffers=null,this._boundVertexBuffers=[],this._vertexBuffersEnabled=[],this._vertexBuffersUsed=[],this._vertexBuffersInstanced=[],this._frameBuffers={},this._hasBoundFrameBuffer=!1,this._currentShader=null,this._currentBlendMode=null,this._currentColorMask=null,this._currentDepthMask=!1,this._blendingEnabled=!1,this._textures=[],this._boundTextures=[],this._maxBoundTextures=0,this._nextTextureBindLocation=0,this._maxTextureSize=0,this._maxCubemapSize=0,this._maxRenderbufferSize=0,this._maxVertexAttributes=0,this._maxVertexShaderUniforms=0,this._maxFragmentShaderUniforms=0,this._maxVaryings=0,this._createContext(r),this.setFiltering(o)}var m={BILINEAR:"bilinear",TRILINEAR:"trilinear",ANISOTROPIC:"anisotropic"},f={NONE:"none",FLOAT:"float",VEC2:"vec2",VEC3:"vec3",VEC4:"vec4",MAT2:"mat2",MAT3:"mat3",MAT4:"mat4",SAMPLER2D:"sampler2D",SAMPLER_CUBE:"samplerCube",INT:"int",BOOL:"bool",STRUCT:"struct"},S={NONE:"none",MIX:"mix",ADD:"add"},T=null;return Object.freeze(m),Object.freeze(f),l.prototype.getLastTextureBindLocation=function(t){return this._locations[t]},l.prototype.forgetLastTextureBindLocation=function(t){delete this._locations[t]},l.prototype.setMinFiltering=function(t,e,i){if(!1===this._mipmap)t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR);else{switch(e){case m.BILINEAR:t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST),i&&t.texParameterf(t.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,1);break;case m.TRILINEAR:t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),i&&t.texParameterf(t.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,1);break;case m.ANISOTROPIC:t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameterf(t.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,4)}t.generateMipmap(t.TEXTURE_2D)}},l.prototype.createGLTexture=function(t,e){this._ids[t]=e.createTexture()},l.prototype.bindGLTexture=function(t,e,i){e.activeTexture(e.TEXTURE0+i),e.bindTexture(e.TEXTURE_2D,this._ids[t]),this._locations[t]=i},l.prototype.setupGLTexture=function(t,e,i){t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._image),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),this.setMinFiltering(t,e,i)},l.prototype.deleteGLTexture=function(t,e){this._ids[t]&&(e.deleteTexture(this._ids[t]),delete this._ids[t],delete this._locations[t])},h.prototype.getLastTextureBindLocation=function(t){return this._locations[t]},h.prototype.forgetLastTextureBindLocation=function(t){delete this._locations[t]},h.prototype.createGLTexture=function(t,e){this._ids[t]=e.createTexture()},h.prototype.bindGLTexture=function(t,e,i){e.activeTexture(e.TEXTURE0+i),e.bindTexture(e.TEXTURE_CUBE_MAP,this._ids[t]),this._locations[t]=i},
h.prototype.setupGLTexture=function(t){var e,i;for(t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.LINEAR),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),e=[t.TEXTURE_CUBE_MAP_POSITIVE_X,t.TEXTURE_CUBE_MAP_NEGATIVE_X,t.TEXTURE_CUBE_MAP_POSITIVE_Y,t.TEXTURE_CUBE_MAP_NEGATIVE_Y,t.TEXTURE_CUBE_MAP_POSITIVE_Z,t.TEXTURE_CUBE_MAP_NEGATIVE_Z],i=0;i<6;i++)t.texImage2D(e[i],0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._images[i])},h.prototype.deleteGLTexture=function(t,e){this._ids[t]&&(e.deleteTexture(this._ids[t]),delete this._ids[t],delete this._locations[t])},c.prototype.addMember=function(t){this._type===f.STRUCT?this._members.push(t):i.showError("Attempting to add a member to uniform "+this._name+", which is not of struct type!")},c.prototype.saveLocation=function(t,e,i,s){s=s||this._name,this._locations[t]||(this._locations[t]={}),this._locations[t][s]=e.getUniformLocation(i.getIDForContext(t),s)},c.prototype.forgetLocations=function(t){var e,i;if(delete this._locations[t],this._numericValues={},this._members)for(e=0;e<this._arraySize;e++)for(i=0;i<this._members.length;i++)this._members[i].forgetLocations(t)},c.prototype.getLocation=function(t,e,i,s,n){var o=(s||"")+this._name+(n||"");return!s&&!n||this._locations[t]&&void 0!==this._locations[t][o]||this.saveLocation(t,e,i,o),this._locations[t][o]},c.prototype.getArraySize=function(){return this._arraySize},c.prototype.getRawName=function(){var t,e=this._name;return"u_".length>0&&(t=e.split("u_"),e=t[t.length-1]),"".length>0&&(e=e.split("")[0]),e},c.prototype.getTextureType=function(){var t,e;if(this._type!==f.SAMPLER2D)return null;if(t=this.getRawName(),"".length>0){if(e=t.split(""),e.length<2)return null;t=e[e.length-1]}if("Texture".length>0){if(e=t.split("Texture"),e.length<2)return null;t=e[0]}return t},c.prototype.getCubemapName=function(){var t,e;if(this._type!==f.SAMPLER_CUBE)return null;if(t=this.getRawName(),"".length>0){if(e=t.split(""),e.length<2)return null;t=e[e.length-1]}if("Cubemap".length>0){if(e=t.split("Cubemap"),e.length<2)return null;t=e[0]}return t},c.prototype.getUniformName=function(t){return"u_"+t},c.prototype.getTextureUniformRawName=function(t){return t+"Texture"},c.prototype.getCubemapUniformRawName=function(t){return t+"Cubemap"},c.prototype._setFloatArrayValue=function(t,e,i,s,n){e.uniform1fv(this.getLocation(t,e,i,n),s)},c.prototype._setFloatValue=function(t,e,i,s,n){(n||this._numericValues[t]!==s)&&(e.uniform1f(this.getLocation(t,e,i,n),s),this._numericValues[t]=s)},c.prototype._setVec2Value=function(t,e,i,s,n){e.uniform2fv(this.getLocation(t,e,i,n),s)},c.prototype._setVec3Value=function(t,e,i,s,n){e.uniform3fv(this.getLocation(t,e,i,n),s)},c.prototype._setVec4Value=function(t,e,i,s,n){e.uniform4fv(this.getLocation(t,e,i,n),s)},c.prototype._setMat2Value=function(t,e,i,s,n){e.uniformMatrix2fv(this.getLocation(t,e,i,n),!1,s)},c.prototype._setMat3Value=function(t,e,i,s,n){e.uniformMatrix3fv(this.getLocation(t,e,i,n),!1,s)},c.prototype._setMat4Value=function(t,e,i,s,n){e.uniformMatrix4fv(this.getLocation(t,e,i,n),!1,s)},c.prototype._setUnpackedIntArrayValue=function(t,e,i,s,n){var o;for(o=0;o<s.length;o++)e.uniform1i(this.getLocation(t,e,i,n,o.toString()),s[o])},c.prototype._setIntArrayValue=function(t,e,i,s,n){e.uniform1iv(this.getLocation(t,e,i,n),s)},c.prototype._setIntValue=function(t,e,i,s,n){(n||this._numericValues[t]!==s)&&(e.uniform1i(this.getLocation(t,e,i,n),s),this._numericValues[t]=s)},c.prototype._setBoolArrayValue=function(t,e,i,s,n){e.uniform1iv(this.getLocation(t,e,i,n),s.map(a))},c.prototype._setBoolValue=function(t,e,i,s,n){var o=s?1:0;(n||this._numericValues[t]!==o)&&(e.uniform1i(this.getLocation(t,e,i,n),o),this._numericValues[t]=o)},c.prototype._setStructArrayValue=function(t,e,i,s){var n,o,r,a=this._members.length;for(n=0;n<s.length&&null!==s[n];n++)for(o=0;o<a;o++)void 0!==s[n][this._members[o]._name]&&(r=this._members[o]._name,this._members[o]._setConstantValue(t,e,i,s[n][r],this._prefixes[n]))},c.prototype._setStructValue=function(t,e,i,s){var n,o,r=this._members.length;for(n=0;n<r;n++)void 0!==s[this._members[n]._name]&&(o=this._members[n]._name,this._members[n]._setConstantValue(t,e,i,s[o],this._prefixes[0]))},c.prototype.setValue=function(t,e,i,s,n){this._setConstantValue(t,e,i,s(t),n)},c.prototype.getVectorCount=function(){var t,e;if(this._type===f.STRUCT){for(t=0,e=0;e<this._members.length;e++)t+=this._members[e].getVectorCount();return t*(this._arraySize||1)}return o(this._type)*(this._arraySize||1)},c.prototype.isSamplerType=function(){return r(this._type)},_.prototype.getRole=function(){return this._role},_.prototype.setData=function(t,e){this._data.set(t,e*this._vectorSize)},_.prototype.getSize=function(){return this._data.length/this._vectorSize},_.prototype.resize=function(t){this._data=new Float32Array(t*this._vectorSize)},_.prototype.addVector=function(t){this._data.set(t,this._filledVectors*this._vectorSize),this._filledVectors++},_.prototype.resetFilledVectors=function(){this._filledVectors=0},_.prototype.freeData=function(){this._data=null},_.prototype.markDirty=function(){this._dirty=!0},_.prototype.loadToGPUMemory=function(t,e,i){this._ids[t]=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._ids[t]),e.bufferData(e.ARRAY_BUFFER,this._data,e.STATIC_DRAW),i||this.freeData()},_.prototype.bind=function(t,e,i){void 0!==this._locations[e._name]&&-1!==this._locations[e._name]||(this._locations[e._name]=t.gl.getAttribLocation(e.getIDForContext(t._name),this._name));var s=this._locations[e._name];s>=0&&((t.getBoundVertexBuffer(s)!==this||this._dirty)&&(i?this.loadToGPUMemory(t._name,t.gl,!0):t.gl.bindBuffer(t.gl.ARRAY_BUFFER,this._ids[t._name]),t.gl.vertexAttribPointer(s,this._vectorSize,t.gl.FLOAT,!1,0,0),this._dirty=!1),t.setBoundVertexBuffer(s,this,!!i))},_.prototype.delete=function(t){var e,i;t.gl.deleteBuffer(this._ids[t._name]);for(e in this._locations)this._locations.hasOwnProperty(e)&&(i=this._locations[e],t.getBoundVertexBuffer(i)===this&&t.setBoundVertexBuffer(i,null,!1));delete this._ids[t._name],0===Object.keys(this._ids).length&&(this.freeData(),this._locations={})},d.prototype.TEXTURE_LOCATION_NOT_SET=-1,d.prototype.getWidth=function(){return this._width},d.prototype.getLastTextureBindLocation=function(){return this._textureLocation},d.prototype.forgetLastTextureBindLocation=function(){this._textureLocation=this.TEXTURE_LOCATION_NOT_SET},d.prototype.setup=function(t){var e;if(!this._id)switch(this._id=t.gl.createFramebuffer(),t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,this._id),this._textureID=t.gl.createTexture(),this._textureLocation=t.bindTexture(this),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MAG_FILTER,t.gl.NEAREST),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MIN_FILTER,t.gl.NEAREST),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_WRAP_S,t.gl.CLAMP_TO_EDGE),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_WRAP_T,t.gl.CLAMP_TO_EDGE),this._depthOnly&&t.areDepthTexturesAvailable()?(t.gl.texImage2D(t.gl.TEXTURE_2D,0,t.gl.DEPTH_COMPONENT,this._width,this._height,0,t.gl.DEPTH_COMPONENT,t.gl.UNSIGNED_SHORT,null),t.gl.framebufferTexture2D(t.gl.FRAMEBUFFER,t.gl.DEPTH_ATTACHMENT,t.gl.TEXTURE_2D,this._textureID,0)):(t.gl.texImage2D(t.gl.TEXTURE_2D,0,t.gl.RGBA,this._width,this._height,0,t.gl.RGBA,t.gl.UNSIGNED_BYTE,null),this._renderBufferID=t.gl.createRenderbuffer(),t.gl.bindRenderbuffer(t.gl.RENDERBUFFER,this._renderBufferID),t.gl.renderbufferStorage(t.gl.RENDERBUFFER,t.gl.DEPTH_COMPONENT16,this._width,this._height),t.gl.framebufferTexture2D(t.gl.FRAMEBUFFER,t.gl.COLOR_ATTACHMENT0,t.gl.TEXTURE_2D,this._textureID,0),t.gl.framebufferRenderbuffer(t.gl.FRAMEBUFFER,t.gl.DEPTH_ATTACHMENT,t.gl.RENDERBUFFER,this._renderBufferID)),e=t.gl.checkFramebufferStatus(t.gl.FRAMEBUFFER)){case t.gl.FRAMEBUFFER_COMPLETE:break;case t.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete.");break;case t.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': Attachment missing.");break;case t.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': Height and width of the attachment are not the same.");break;case t.gl.FRAMEBUFFER_UNSUPPORTED:i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': The format of the attachment is not supported or depth and stencil attachments are not the same renderbuffer.");break;default:i.showGraphicsError("Unknown framebuffer status for '"+this._name+"' ("+e+")!")}},d.prototype.bind=function(t){t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,this._id)},d.prototype.bindGLTexture=function(t,e){t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_2D,this._textureID),this._textureLocation=e},d.prototype.delete=function(t){t.gl.deleteTexture(this._textureID),this._depthOnly&&t.areDepthTexturesAvailable()||t.gl.deleteRenderbuffer(this._renderBufferID),t.gl.deleteFramebuffer(this._id),this._id=null},p.prototype._hasUniform=function(t){var e;for(e=0;e<this._uniforms.length;e++)if(this._uniforms[e]._name===t)return!0;return!1},p.prototype._getUniform=function(t){var e;for(e=0;e<this._uniforms.length;e++)if(this._uniforms[e]._name===t)return this._uniforms[e];return null},p.prototype._parseShaderSources=function(e,s,a){var l,h,_,d,p,g,m,S,T,E,y,I,A,M,C,N,O,R,L,x={},v={},b=function(t){return""!==t},D=function(t){return"highp"===t||"mediump"===t||"lowp"===t},w=function(e){return t.getSafeEnumValue(f,e,f.NONE)!==f.NONE};for(d=0;d<2;d++){switch(d){case 0:p=this._vertexShaderSource.split("\n");break;case 1:p=this._fragmentShaderSource.split("\n")}for(R=!1,l=0;l<p.length;l++)if(p[l].length>0)if(g=p[l].split(/\s+|[\(\)\[\]\{\}\+\?\-!<>=*\/\^\|\&,;]/),m=p[l].match(/\s+|[\(\)\[\]\{\}\+\?\-!<>=*\/\^\|\&,;]/g),"#define"===g[0])s&&void 0!==s[g[1]]?(x[g[1]]=s[g[1]],g[2]!==s[g[1]]&&(p[l]=p[l].replace(g[2],s[g[1]]),R=!0)):x[g[1]]=g[2];else if(0===d&&"attribute"===g[0])if(S=D(g[1])?3:2,T=g[S],M=g[S-1],E=n(M),y=e[T],this._numAttributeVectors+=o(M),void 0===y){if(!this._uniformNamesForInstanceAttributeNames.hasOwnProperty(T))return void i.showError("Role for attribute named '"+T+"' not found for shader '"+this._name+"'!");y=this._uniformNamesForInstanceAttributeNames[T],this._instanceAttributes.push(new u(T,E,y))}else this._vertexAttributes.push(new u(T,E,y));else if("uniform"===g[0]){if(S=D(g[1])?3:2,A=g[S],M=g[S-1],!1===this._hasUniform(A)){if("["===m[S]){if(O=!1,N=g[S+1],x[N]&&(N=x[N]),C=parseInt(N,10),r(M)&&a){for(p[l]="",h=0;h<C;h++){for(_=0;_<S;_++)p[l]+=g[_],p[l]+=m[_];p[l]+=A+h.toString()+";\n"}R=!0,O=!0}}else C=0;w(M)?this._uniforms.push(new c(A,M,C,O)):(I=new c(A,"struct",C),function(t,e){var i,s,n,o;for(i=!1,n=0;n<p.length;n++)if(s=p[n].split(" "),i){if(s=s.filter(b),s.length>0&&"}"===s[s.length-1].split(";")[0])break;s.length>=2&&(o=D(s[0])?1:0,t.addMember(new c(s[o+1].split(";")[0],s[o],0)))}else"struct"===s[0]&&s[1].split("{")[0]===e&&(i=!0)}(I,M),this._uniforms.push(I))}switch(d){case 0:this._numVertexUniformVectors+=this._getUniform(A).getVectorCount();break;case 1:this._numFragmentUniformVectors+=this._getUniform(A).getVectorCount(),r(M)&&(this._numTextureUnits+=this._getUniform(A).getVectorCount())}}else if("varying"===g[0])S=D(g[1])?3:2,M=g[S-1],1===d&&("["===m[S]?(N=g[S+1],x[N]&&(N=x[N]),C=parseInt(N,10)):C=1,this._numVaryingVectors+=o(M)*C);else{for(S=0;""===g[S];)S++;if(w(g[S])||D(g[S]))S=D(g[S])?S+2:S+1,"["===m[S]&&(N=g[S+1],x[N]&&(N=x[N]),v[g[S]]=parseInt(N,10));else{for(h=0;h<this._uniforms.length;h++)if((S=g.indexOf(this._uniforms[h]._name))>=0&&this._uniforms[h].getArraySize()>0&&"["===m[S]){if(parseInt(g[S+1],10).toString()===g[S+1]&&parseInt(g[S+1],10)>=this._uniforms[h].getArraySize()){p[l]="",R=!0;break}if(this._uniforms[h].isSamplerType()&&a){for(p[l]="",_=0;_<S;_++)p[l]+=g[_],p[l]+=m[_];for(p[l]+=g[S]+g[S+1],_=S+2;_<m.length;_++)p[l]+=g[_],p[l]+=m[_];p[l]+=g[g.length-1],R=!0;break}}for(L=Object.keys(v),h=0;h<L.length;h++)if((S=g.indexOf(L[h]))>=0&&"["===m[S]&&parseInt(g[S+1],10).toString()===g[S+1]&&parseInt(g[S+1],10)>=v[g[S]]){p[l]="",R=!0;break}}}if(R)switch(d){case 0:this._vertexShaderSource=p.join("\n");break;case 1:this._fragmentShaderSource=p.join("\n")}}},p.prototype.getIDForContext=function(t){return this._ids[t]},p.prototype.getVertexAttributes=function(){return this._vertexAttributes},p.prototype.getVertexAttribute=function(t){var e;for(e=0;e<this._vertexAttributes.length;e++)if(this._vertexAttributes[e].name===t)return this._vertexAttributes[e];return null},p.prototype.getInstanceAttribute=function(t){var e;for(e=0;e<this._instanceAttributes.length;e++)if(this._instanceAttributes[e].name===t)return this._instanceAttributes[e];return null},p.prototype.setupGLProgram=function(t,e){var s,n,o,r,a;if(!this._vertexShaderSource||!this._fragmentShaderSource)return void(this._ids[t]=null);if(s=e.createShader(e.VERTEX_SHADER),e.shaderSource(s,this._vertexShaderSource),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS))return n=e.getShaderInfoLog(s),i.showGraphicsError("Compiling GLSL vertex shader of '"+this._name+"' failed.",i.ErrorSeverity.SEVERE,"More details:\n"+n,e),void(this._ids[t]=null);if(o=e.createShader(e.FRAGMENT_SHADER),e.shaderSource(o,this._fragmentShaderSource),e.compileShader(o),!e.getShaderParameter(o,e.COMPILE_STATUS))return n=e.getShaderInfoLog(o),i.showGraphicsError("Compiling GLSL fragment shader of '"+this._name+"' failed.",i.ErrorSeverity.SEVERE,"More details:\n"+n,e),void(this._ids[t]=null);if(this._ids[t]=e.createProgram(),r=this._ids[t],e.attachShader(r,s),e.attachShader(r,o),e.linkProgram(r),!e.getProgramParameter(r,e.LINK_STATUS))return n=e.getProgramInfoLog(r),i.showGraphicsError("Linking GLSL shader '"+this._name+"' failed.",i.ErrorSeverity.SEVERE,"More details: "+n,e),e.deleteProgram(r),void(this._ids[t]=null);for(a=0;a<this._uniforms.length;a++)this._uniforms[a].saveLocation(t,e,this)},p.prototype.getBlendMode=function(){return this._blendMode},p.prototype.assignUniforms=function(t,e){var i;if(e)for(i=0;i<this._uniforms.length;i++)void 0!==e[this._uniforms[i]._name]&&this._uniforms[i].setValue(t._name,t.gl,this,e[this._uniforms[i]._name])},p.prototype.bindVertexBuffers=function(t){var e;for(t.clearVertexBufferUsage(),e=0;e<this._vertexAttributes.length;e++)t.getVertexBuffer(this._vertexAttributes[e].name).bind(t,this);t.disableUnusedVertexBuffers()},p.prototype.getUniformArrayLength=function(t){var e;for(e=0;e<this._uniforms.length;e++)if(this._uniforms[e]._name===t)return this._uniforms[e].getArraySize();return 0},p.prototype.getTextureTypes=function(){var t,e,i=[];for(t=0;t<this._uniforms.length;t++)(e=this._uniforms[t].getTextureType())&&i.push(e);return i},p.prototype.getCubemapNames=function(){var t,e,i=[];for(t=0;t<this._uniforms.length;t++)(e=this._uniforms[t].getCubemapName())&&i.push(e);return i},p.prototype.createInstanceBuffers=function(t,e){var i,s;for(this._instanceAttributeBuffers.length<t+1&&(this._instanceAttributeBuffers=this._instanceAttributeBuffers.concat(new Array(t-this._instanceAttributeBuffers.length+1))),i=0;i<this._instanceAttributeNames.length;i++)s=this._instanceAttributeNames[i],this._instanceAttributeBuffers[t]||(this._instanceAttributeBuffers[t]={}),this._instanceAttributeBuffers[t][s]?(this._instanceAttributeBuffers[t][s].resize(e),this._instanceAttributeBuffers[t][s].resetFilledVectors(),this._instanceAttributeBuffers[t][s].markDirty()):this._instanceAttributeBuffers[t][s]=new _(s,this._uniformNamesForInstanceAttributeNames[s],this.getInstanceAttribute(s).size,e)},p.prototype.addDataToInstanceBuffers=function(e,i){var s,n,o;for(s=0;s<this._instanceAttributeNames.length;s++)n=this._instanceAttributeNames[s],o=this._instanceAttributeBuffers[e][n].getRole(),this._instanceAttributeBuffers[e][n].addVector(i[o](t.EMPTY_STRING))},p.prototype.bindAndFillInstanceBuffers=function(t,e){var i;for(i=0;i<this._instanceAttributeNames.length;i++)this._instanceAttributeBuffers[e][this._instanceAttributeNames[i]].bind(t,this,!0)},p.prototype.deleteInstanceBuffers=function(t){var e,i;for(e=0;e<this._instanceAttributeBuffers.length;e++)for(i=0;i<this._instanceAttributeNames.length;i++)this._instanceAttributeBuffers[e][this._instanceAttributeNames[i]].delete(t);this._instanceAttributeBuffers=[]},p.prototype.deleteGLProgram=function(t,e){var i;if(this._ids[t]){for(i=0;i<this._uniforms.length;i++)this._uniforms[i].forgetLocations(t);e.deleteProgram(this._ids[t]),delete this._ids[t]}},p.prototype.isAllowedByRequirements=function(t){return this._numAttributeVectors<=t.requiredAttributeVectors&&this._numVertexUniformVectors<=t.requiredVertexUniformVectors&&this._numVaryingVectors<=t.requiredVaryingVectors&&this._numTextureUnits<=t.requiredTextureUnits&&this._numFragmentUniformVectors<=t.requiredFragmentUniformVectors},g.prototype=new s.AsyncResource,g.prototype.constructor=g,g.prototype._createContext=function(t){var e,s;s={alpha:this._alpha,antialias:this._antialiasing};try{this.gl=this._canvas.getContext("webgl",s)}catch(t){}if(!this.gl){s.alpha=!1;try{this.gl=this._canvas.getContext("experimental-webgl",s)}catch(t){}if(!this.gl)return void i.showError("Unable to initialize WebGL.",i.ErrorSeverity.CRITICAL,"It looks like your device, browser or graphics drivers do not support web 3D graphics. Make sure your browser and graphics drivers are updated to the latest version, and you are using a modern web browser (Firefox or Chrome are recommended).\nPlease note that some phones or handheld devices do not have 3D web capabilities, even if you use the latest software.");i.showError("Your device appears to only have experimental WebGL (web based 3D) support.",void 0,"This application relies on 3D web features, and without full support, the graphics of the application might be displayed with glitches or not at all. If you experience problems, it is recommended to use lower graphics quality settings.")}e=this.gl,this._antialiasing&&!e.getContextAttributes().antialias&&(t||i.showGraphicsError("Antialiasing is enabled in graphics settings but it is not supported.",i.ErrorSeverity.MINOR,"Your graphics driver, browser or device unfortunately does not support antialiasing. To avoid this error message showing up again, disable antialiasing in the graphics settings or try running the application in a different browser. Antialiasing will not work, but otherwise this error will have no consequences.",e),this._antialiasing=!1),this._maxBoundTextures=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextures=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this._maxCubemapSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this._maxRenderbufferSize=e.getParameter(e.MAX_RENDERBUFFER_SIZE),this._maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._maxVertexShaderUniforms=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentShaderUniforms=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxVaryings=e.getParameter(e.MAX_VARYING_VECTORS),i.log("WebGL context successfully created.\n"+this.getInfoString(),1),this.anisotropicFilterExt=e.getExtension("EXT_texture_filter_anisotropic"),null===this.anisotropicFilterExt?i.log("Anisotropic filtering not available.",1):i.log("Anisotropic filtering successfully initialized.",1),this.instancingExt=e.getExtension("ANGLE_instanced_arrays"),null===this.instancingExt?i.log("Instancing is not available, and so it will be disabled.",1):i.log("Instancing successfully initialized.",1),this.depthTextureExt=e.getExtension("WEBGL_depth_texture"),null===this.depthTextureExt?i.log("Depth textures not available, and so will be disabled.",1):i.log("Depth texture extension successfully initialized.",1),e.clearDepth(1),e.colorMask(!0,!0,!0,!0),this._currentColorMask=[!0,!0,!0,!0],e.depthMask(!0),this._currentDepthMask=!0,e.enable(e.BLEND),this._blendingEnabled=!0,e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW)},g.prototype.getInfoString=function(){return this.gl?"WebGL version: "+this.gl.getParameter(this.gl.VERSION)+"\nShading language version: "+this.gl.getParameter(this.gl.SHADING_LANGUAGE_VERSION)+"\nWebGL vendor: "+this.gl.getParameter(this.gl.VENDOR)+"\nWebGL renderer: "+this.gl.getParameter(this.gl.RENDERER)+"\nAvailable vertex shader uniform vectors: "+this._maxVertexShaderUniforms+"\nAvailable vertex attributes: "+this._maxVertexAttributes+"\nAvailable texture units in vertex shaders: "+this._maxVertexTextures+"\nAvailable varying vectors: "+this._maxVaryings+"\nAvailable fragment shader uniform vectors: "+this._maxFragmentShaderUniforms+"\nAvailable texture units: "+this._maxBoundTextures+"\nMaximum texture size: "+this._maxTextureSize+"\nMaximum cubemap size: "+this._maxCubemapSize+"\nMaximum renderbuffer size: "+this._maxRenderbufferSize:"N/A"},g.prototype.isAntialiased=function(){return this._antialiasing},g.prototype.getFiltering=function(){return this._filtering},g.prototype.setFiltering=function(e){var i;if((e=t.getSafeEnumValue(m,e,this._filtering))!==this._filtering)for(this._filtering=e,this._filtering===m.ANISOTROPIC&&(this.anisotropicFilterExt||(this._filtering=m.TRILINEAR)),i=0;i<this._textures.length;i++)this._textures[i].setMinFiltering&&(this.bindTexture(this._textures[i],void 0,void 0,!0),this._textures[i].setMinFiltering(this.gl,this._filtering,this.anisotropicFilterExt))},g.prototype.isAnisotropicFilteringAvailable=function(){return!!this.anisotropicFilterExt},g.prototype.isInstancingAvailable=function(){return!!this.instancingExt},g.prototype.areDepthTexturesAvailable=function(){return!!this.depthTextureExt},g.prototype.setColorMask=function(t){this._currentColorMask[0]===t[0]&&this._currentColorMask[1]===t[1]&&this._currentColorMask[2]===t[2]&&this._currentColorMask[3]===t[3]||(this.gl.colorMask(t[0],t[1],t[2],t[3]),this._currentColorMask=t)},g.prototype.setDepthMask=function(t){this._currentDepthMask!==t&&(this.gl.depthMask(t),this._currentDepthMask=t)},g.prototype.enableBlending=function(){this._blendingEnabled||(this.gl.enable(this.gl.BLEND),this._blendingEnabled=!0)},g.prototype.disableBlending=function(){this._blendingEnabled&&(this.gl.disable(this.gl.BLEND),this._blendingEnabled=!1)},g.prototype.addShader=function(t){this._shaders.indexOf(t)<0&&(this._shaders.push(t),t.setupGLProgram(this._name,this.gl),this.resetReadyState())},g.prototype.addModel=function(t){this._models.indexOf(t)<0&&(this._models.push(t),this.resetReadyState())},g.prototype.getVertexBuffer=function(t){return this._vertexBuffers[t]},g.prototype.addVertexBuffer=function(t){void 0===this._vertexBuffers[t._name]&&(this._vertexBuffers[t._name]=t)},g.prototype.getBoundVertexBuffer=function(t){return this._boundVertexBuffers[t]},g.prototype.setBoundVertexBuffer=function(t,e,i){this._boundVertexBuffers[t]=e,this._vertexBuffersUsed[t]=!!e,e?(this._vertexBuffersEnabled[t]||(this.gl.enableVertexAttribArray(t),this._vertexBuffersEnabled[t]=!0),this.instancingExt&&i!==this._vertexBuffersInstanced[t]&&(this.instancingExt.vertexAttribDivisorANGLE(t,i?1:0),this._vertexBuffersInstanced[t]=i)):this._vertexBuffersEnabled[t]&&(this.gl.disableVertexAttribArray(t),this._vertexBuffersEnabled[t]=!1)},g.prototype.clearVertexBufferUsage=function(){var t;for(t=0;t<this._vertexBuffersUsed.length;t++)this._vertexBuffersUsed[t]=!1},g.prototype.disableUnusedVertexBuffers=function(){var t;for(t=0;t<this._vertexBuffersEnabled.length;t++)this._vertexBuffersEnabled[t]&&!this._vertexBuffersUsed[t]&&(this.gl.disableVertexAttribArray(t),this._vertexBuffersEnabled[t]=!1)},g.prototype.setVertexBufferData=function(t,e){var i;for(i in this._vertexBuffers)this._vertexBuffers.hasOwnProperty(i)&&void 0!==t[this._vertexBuffers[i].getRole()]&&this._vertexBuffers[i].setData(t[this._vertexBuffers[i].getRole()],e)},g.prototype.setupVertexBuffers=function(){var t,e,i,s,n,o;if(!0!==this._readyToUse){for(i in this._vertexBuffers)this._vertexBuffers.hasOwnProperty(i)&&this._vertexBuffers[i].delete(this);for(s=0,t=0;t<this._models.length;t++)s+=this._models[t].getBufferSize(this);for(this._vertexBuffers={},t=0;t<this._shaders.length;t++)for(n=this._shaders[t].getVertexAttributes(),e=0;e<n.length;e++)this.addVertexBuffer(new _(n[e].name,n[e].role,n[e].size,s));for(o=0,t=0;t<this._models.length;t++)for(e=this._models[t].getMinLOD();e<=this._models[t].getMaxLOD();e++)o+=this._models[t].loadToVertexBuffers(this,o,e);for(i in this._vertexBuffers)this._vertexBuffers.hasOwnProperty(i)&&this._vertexBuffers[i].loadToGPUMemory(this._name,this.gl);for(this._currentShader=null,t=0;t<this._shaders.length;t++)this.setCurrentShader(this._shaders[t])}},g.prototype.getFrameBuffer=function(t){return this._frameBuffers[t]},g.prototype.addFrameBuffer=function(t,e){(void 0===this._frameBuffers[t._name]||e)&&(this._frameBuffers[t._name]=t,this._readyToUse&&this._frameBuffers[t._name].setup(this))},g.prototype.setupFrameBuffers=function(){var t;if(!this._readyToUse)for(t in this._frameBuffers)this._frameBuffers.hasOwnProperty(t)&&this._frameBuffers[t].setup(this)},g.prototype.clearFrameBuffers=function(){var t;for(t in this._frameBuffers)this._frameBuffers.hasOwnProperty(t)&&this._frameBuffers[t].delete(this);this._frameBuffers={}},g.prototype.setup=function(){this.setupVertexBuffers(),this.setupFrameBuffers(),this.setToReady()},g.prototype.clear=function(){var t;for(this.clearFrameBuffers(),this._currentShader=null,t=0;t<this._boundTextures.length;t++)this.unbindTexture(this._boundTextures[t].texture);for(this._boundTextures=[],t=0;t<this._textures.length;t++)this._textures[t].forgetLastTextureBindLocation(this._name);for(t=0;t<this._boundVertexBuffers.length;t++)this.gl.disableVertexAttribArray(t);this._boundVertexBuffers.length=0,this._vertexBuffersUsed.length=0,this._vertexBuffersEnabled.length=0,this._vertexBuffersInstanced.length=0},g.prototype.removeShaders=function(){var t;for(t=0;t<this._shaders.length;t++)this._shaders[t].deleteInstanceBuffers(this),this._shaders[t].deleteGLProgram(this._name,this.gl);this._shaders=[],this._currentShader=null},g.prototype.setCurrentFrameBuffer=function(t){t?(this._frameBuffers[t].bind(this),this._hasBoundFrameBuffer=!0):this._hasBoundFrameBuffer&&(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this._hasBoundFrameBuffer=!1)},g.prototype.getCurrentShader=function(){return this._currentShader},g.prototype.setCurrentShader=function(t){var e,i;if(this._currentShader!==t){if(i=t.getIDForContext(this._name)){switch(this.gl.useProgram(i),e=t.getBlendMode()){case S.MIX:this._currentBlendMode!==e&&(this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this._currentBlendMode=e);break;case S.ADD:this._currentBlendMode!==e&&(this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE),this._currentBlendMode=e)}return t.bindVertexBuffers(this),this._currentShader=t,!0}this._currentShader=null}return!1},g.prototype.addTexture=function(t){this._textures.indexOf(t)<0&&(this._textures.push(t),t.createGLTexture(this._name,this.gl),this.bindTexture(t),t.setupGLTexture(this.gl,this._filtering,this.anisotropicFilterExt))},g.prototype.bindTexture=function(t,e,s,n){var o=void 0!==e||s;if(void 0===e&&(void 0===(e=t.getLastTextureBindLocation(this._name))||e===d.prototype.TEXTURE_LOCATION_NOT_SET||this._boundTextures[e].texture!==t)){for(e=0;e<this._maxBoundTextures&&e<this._boundTextures.length&&this._boundTextures[e];)e++;if(e===this._maxBoundTextures){for(;this._boundTextures[this._nextTextureBindLocation].reserved;)this._nextTextureBindLocation=(this._nextTextureBindLocation+1)%this._maxBoundTextures;e=this._nextTextureBindLocation,this._nextTextureBindLocation=(this._nextTextureBindLocation+1)%this._maxBoundTextures}}return this._boundTextures[e]&&this._boundTextures[e].texture===t&&!n||(t instanceof l?t.bindGLTexture(this._name,this.gl,e):t instanceof h?t.bindGLTexture(this._name,this.gl,e):t instanceof d?t.bindGLTexture(this.gl,e):i.showError("Cannot set object: '"+t.toString()+"' as current texture, because it is not of an appropriate type."),this._boundTextures[e]={texture:t,reserved:o}),this._boundTextures[e].reserved!==o&&(this._boundTextures[e].reserved=o),e},g.prototype.unbindTexture=function(t){var e=t&&t.getLastTextureBindLocation(this._name);void 0!==e&&e>=0&&this._boundTextures[e]===t&&(this.gl.activeTexture(this.gl.TEXTURE0+e),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,null),this._boundTextures[e]=null,t.forgetLastTextureBindLocation(this._name))},g.prototype.removeTexture=function(t){var e=this._textures.indexOf(t);e>=0&&(this.unbindTexture(t),t.deleteGLTexture(this._name,this.gl),this._textures.splice(e,1))},g.prototype.satisfiesRequirements=function(t){return this._maxVertexAttributes>=t.requiredAttributeVectors&&this._maxVertexShaderUniforms>=t.requiredVertexUniformVectors&&this._maxVaryings>=t.requiredVaryingVectors&&this._maxFragmentShaderUniforms>=t.requiredFragmentUniformVectors&&this._maxBoundTextures>=t.requiredTextureUnits},g.prototype.getMaxTextureSize=function(){return this._maxTextureSize},g.prototype.getMaxCubemapSize=function(){return this._maxCubemapSize},g.prototype.getMaxRenderbufferSize=function(){return this._maxRenderbufferSize},i.showGraphicsError=function(t,e,s){i.showError(t,e,(s?s+"\n\n":"")+"This is a graphics related error.\nInformation about your graphics support:\n"+T.getInfoString())},T=new g("",document.createElement("canvas"),!0,!0,m.BILINEAR,!0),{TextureFiltering:m,ShaderVariableType:f,ShaderBlendMode:S,getUniformName:c.prototype.getUniformName,getTextureUniformRawName:c.prototype.getTextureUniformRawName,getCubemapUniformRawName:c.prototype.getCubemapUniformRawName,ManagedTexture:l,ManagedCubemap:h,ManagedShader:p,FrameBuffer:d,ManagedGLContext:g,requirementsAreSatisfied:T.satisfiesRequirements.bind(T),getMaxTextureSize:T.getMaxTextureSize.bind(T),getMaxCubemapSize:T.getMaxCubemapSize.bind(T),getMaxRenderbufferSize:T.getMaxRenderbufferSize.bind(T),isAntialiasingAvailable:T.isAntialiased.bind(T),isAnisotropicFilteringAvailable:T.isAnisotropicFilteringAvailable.bind(T),isInstancingAvailable:T.isInstancingAvailable.bind(T),areDepthTexturesAvailable:T.areDepthTexturesAvailable.bind(T)}}),define("modules/scene/lights",["utils/vectors","utils/matrices","modules/managed-gl"],function(t,e,i){"use strict";function s(t,e){h=t,u=e}function n(s,n){this._color=s,this._direction=t.normal3(n),this.oM=e.inverseOfRotation4(e.lookTowards4(this._direction)),this._baseMatrix=e.identity4(),this._baseMatrixValid=!1,this._near=0,this._far=0,this._lispMatrix=e.matrix4([1,0,0,0,0,1,0,-1,0,0,1,0,0,0,0,0]),this._shadowMapBufferNamePrefix=null,this._uniformValueFunctions={},this._uniformData={color:this._color,direction:[this._direction[0],this._direction[1],this._direction[2],1],matrix:this._baseMatrix},this._shadowMapParams=[0,0,1],this._uniformValueFunctions[i.getUniformName(a)]=function(){return this._baseMatrix}.bind(this),this._uniformValueFunctions[i.getUniformName(l)]=function(){return this._shadowMapParams}.bind(this)}function o(t,e,i,s,n,o){this._color=t,this._objectIntensity=e,this._relativePositionVector=i,this._hasRelativePosition=i&&(0!==i[0]||0!==i[1]||0!==i[2]),this._emittingObjects=s,this._singleEmittingObject=!!s&&1===s.length,this._totalIntensity=e*(s?s.length:1),this._visible=!0,this._positionVector=[0,0,0],this._states=n,this._timeSinceLastTransition=0,this._currentStateIndex=0,this._looping=o,this._uniformColor=[0,0,0,this._totalIntensity],this._uniformData={color:this._uniformColor,position:this._positionVector},t&&this._updateUniformColor()}function r(t,e,i,s,n,r,a,l,h){o.call(this,t,e,i,a,l,h),
this._relativeSpotDirection=s,this._spotCutoffCosine=Math.cos(Math.radians(n)),this._spotFullIntensityCosine=r<n?Math.cos(Math.radians(r)):0,this._spotDirection=[0,0,0],this._uniformData={color:this._uniformColor,spot:[0,0,0,0],position:[0,0,0,0]}}var a="lightMatrix",l="shadowMapParams",h=10,u=100;return n.prototype.getShadowMapBufferName=function(t){return this._shadowMapBufferNamePrefix+t.toString()},n.prototype.addToContext=function(t,e,s,n,o){var r,a,l;if(this._shadowMapBufferNamePrefix=s,e)for(r=0;r<n;r++)a=this.getShadowMapBufferName(r),l=t.getFrameBuffer(a),t.addFrameBuffer(new i.FrameBuffer(a,o,o,!0),l&&l.getWidth()!==o)},n.prototype.reset=function(){this._baseMatrixValid=!1},n.prototype._updateLiSPMatrix=function(){var t=this._shadowMapParams[0],e=this._shadowMapParams[1];this._near=(u+t)*this._shadowMapParams[2]+h,this._far=2*t+this._near,this._lispMatrix[0]=this._far/t,this._lispMatrix[5]=(this._far+this._near)/(this._far-this._near),this._lispMatrix[10]=this._far/e,this._lispMatrix[13]=2*this._far*this._near/(this._far-this._near)},n.prototype.isInsideCurrentMap=function(e,i){var s,n,o,r,a,l,h,u=this._shadowMapParams[0],c=this._shadowMapParams[2];return i*=.5,s=t.prodTranslationModel3Aux(e,this._baseMatrix),s[1]-=c*u+this._near,s[2]=-s[2]+c*u,n=s[0]*this._lispMatrix[0],o=(s[1]+i)*this._lispMatrix[5]+this._lispMatrix[13],r=(s[1]-i)*this._lispMatrix[5]+this._lispMatrix[13],a=s[2]*this._lispMatrix[10],l=-s[1],h=Math.max(l,0),Math.abs(n)-i*this._lispMatrix[0]<h&&(o>0||o>-(l-i))&&(r<0||r<l+i)&&Math.abs(a)-i*this._lispMatrix[10]<h},n.prototype.startShadowMap=function(i,s,n,o,r){var a,l;i.setCurrentFrameBuffer(this.getShadowMapBufferName(n)),a=e.getRowC43(s.getCameraOrientationMatrix()),l=Math.abs(t.dot3(a,this._direction)),this._shadowMapParams[0]=o,this._shadowMapParams[1]=r,this._shadowMapParams[2]=l,this._baseMatrixValid||(e.setInverseOfRotation4(this.oM,e.lookTowards4Aux(this._direction,a)),e.setProdTranslationRotation4(this._baseMatrix,s.getInversePositionMatrix(),this.oM),this._baseMatrixValid=!0),this._uniformData.direction[3]=l,this._updateLiSPMatrix(),i.getCurrentShader().assignUniforms(i,this._uniformValueFunctions)},n.prototype.getUniformData=function(){return this._uniformData},o.prototype._updateUniformColor=function(){this._uniformColor[0]=this._color[0],this._uniformColor[1]=this._color[1],this._uniformColor[2]=this._color[2]},o.prototype.isVisible=function(){var t;if(!this._visible)return!1;if(!this._emittingObjects)return!0;if(this._singleEmittingObject)return this._emittingObjects[0].isVisible();for(t=0;t<this._emittingObjects.length;t++)if(this._emittingObjects[t]&&!this._emittingObjects[t].canBeReused()&&this._emittingObjects[t].isVisible())return!0;return!1},o.prototype.updateState=function(e){var i,s;if(this._states&&this._states.length>1&&e>0){for(this._timeSinceLastTransition+=e,i=(this._currentStateIndex+1)%this._states.length;this._timeSinceLastTransition>this._states[i].timeToReach;){if(0===i&&!this._looping){i=this._states.length-1,this._timeSinceLastTransition=this._states[i].timeToReach;break}this._timeSinceLastTransition-=this._states[i].timeToReach,i=(i+1)%this._states.length}this._currentStateIndex=0===i?this._states.length-1:i-1,s=this._timeSinceLastTransition/this._states[i].timeToReach,this.setObjectIntensity(this._states[this._currentStateIndex].intensity*(1-s)+this._states[i].intensity*s),this.setColor(t.sum3(t.scaled3(this._states[this._currentStateIndex].color,1-s),t.scaled3(this._states[i].color,s)))}},o.prototype.update=function(i){var s,n,o=this._totalIntensity;if(this.updateState(i),this._visible)if(this._emittingObjects)if(this._singleEmittingObject)this._totalIntensity=this._objectIntensity,this._emittingObjects[0].copyPositionToVector(this._positionVector),this._hasRelativePosition&&t.add3(this._positionVector,t.prodVec3Mat4Aux(this._relativePositionVector,e.prod3x3SubOf4Aux(this._emittingObjects[0].getCascadeScalingMatrix(),this._emittingObjects[0].oM)));else{for(t.setNull3(this._positionVector),n=0,s=0;s<this._emittingObjects.length;s++)this._emittingObjects[s]&&!this._emittingObjects[s].canBeReused()&&this._emittingObjects[s].isVisible()&&(this._emittingObjects[s].addPositionToVector(this._positionVector),n++);n>0&&(this._positionVector[0]/=n,this._positionVector[1]/=n,this._positionVector[2]/=n),this._totalIntensity=this._objectIntensity*n}else this._totalIntensity=this._objectIntensity,t.setVector3(this._positionVector,this._relativePositionVector);else this._totalIntensity=0;this._totalIntensity!==o&&(this._uniformColor[3]=this._totalIntensity)},o.prototype.getUniformData=function(){return this._uniformData},o.prototype.canBeReused=function(){var t;if(!this._emittingObjects)return!1;if(this._singleEmittingObject)return this._emittingObjects[0].canBeReused();for(t=0;t<this._emittingObjects.length;t++)if(this._emittingObjects[t]&&!this._emittingObjects[t].canBeReused())return!1;return!0},o.prototype.setColor=function(t){this._color=t,this._updateUniformColor()},o.prototype.setObjectIntensity=function(t){this._objectIntensity=t},o.prototype.addEmittingObject=function(t){this._emittingObjects.push(t),this._singleEmittingObject=1===this._emittingObjects.length},o.prototype.shouldBeRendered=function(t){var e=t.getViewMatrix();return this._totalIntensity>0&&this._positionVector[0]*e[2]+this._positionVector[1]*e[6]+this._positionVector[2]*e[10]+e[14]<this._totalIntensity},o.prototype.setAnimationTime=function(t){this._timeSinceLastTransition=0,this._currentStateIndex=0,this.updateState(t)},o.prototype.hide=function(){this._visible=!1},o.prototype.show=function(){this._visible=!0},r.prototype=new o,r.prototype.constructor=r,r.prototype.setSpotDirection=function(t){this._relativeSpotDirection=t},r.prototype.setSpotCutoffAngle=function(t){this._spotCutoffCosine=Math.cos(Math.radians(t))},r.prototype.update=function(e){o.prototype.update.call(this,e),this._visible&&(this._emittingObjects&&1===this._emittingObjects.length?t.setProdVec3Mat4(this._spotDirection,this._relativeSpotDirection,this._emittingObjects[0].oM):t.setVector3(this._spotDirection,this._relativeSpotDirection))},r.prototype.getUniformData=function(){return this._uniformData.spot[0]=this._spotDirection[0],this._uniformData.spot[1]=this._spotDirection[1],this._uniformData.spot[2]=this._spotDirection[2],this._uniformData.spot[3]=this._spotCutoffCosine,this._uniformData.position[0]=this._positionVector[0],this._uniformData.position[1]=this._positionVector[1],this._uniformData.position[2]=this._positionVector[2],this._uniformData.position[3]=this._spotFullIntensityCosine,this._uniformData},{setupLiSPSM:s,DirectionalLightSource:n,PointLightSource:o,SpotLightSource:r}}),define("armada/constants",[],function(){"use strict";return{GAME_NAME:"Interstellar Armada",LOCAL_STORAGE_PREFIX:"armada_",LANGUAGE_LOCAL_STORAGE_ID:"armada_language",VERSION_LOCAL_STORAGE_ID:"armada_version"}}),define("modules/resource-manager",["utils/utils","modules/application","modules/async-resource"],function(t,e,i){"use strict";function s(t){i.AsyncResource.call(this),this._name=t,this._requested=!1,this._loading=!1,this._hasError=!1,this._requestParams={}}function n(t,i,n){s.call(this,t?t.name||n&&(t&&t.source||a)||e.showError("Cannot initialize instance of "+this.constructor.name+": a name is required!"):null),this._source=t?t.source||null:null,this._sourceFolder=i,this._dataJSON=t,t&&(this._source||(this._loadData(t),this.setToReady()))}function o(t){i.AsyncResource.call(this),this._resourceType=t,this._resources={},this._resourceNames=[],this._numLoadedResources=0,this._numRequestedResources=0}function r(){i.AsyncResource.call(this),this._resourceHolders={},this._numLoadedResources=0,this._numRequestedResources=0,this._onResourceTypeLoadFunctionQueues={},this._onAnyResourceTypeLoadFunctionQueue=[],this._onResourceLoadFunctionQueue=[],this._resourceClasses=null,this._sourceFolder=null}var a="unnamed";return s.prototype=new i.AsyncResource,s.prototype.constructor=s,s.prototype.isRequested=function(e){if(!this._requested)return!1;if(e){if(!this._requestParams)return!1;if(!t.equivalent(this._requestParams,e))return!1}return!0},s.prototype.request=function(i){this._loading&&!t.equivalent(this._requestParams||null,i||null)?e.showError("Attempting to request resource '"+this._name+"' with different parameters while it is being loaded!"):(this._requested=!0,this._requestParams=i)},s.prototype.requiresReload=function(){e.showError("Resource class does not implement requiresReload!")},s.prototype.isLoaded=function(){return this._readyToUse},s.prototype.hasError=function(){return this._hasError},s.prototype._requestFiles=function(){e.showError("Attempting to request files for a resource type that has no file request function implemented!")},s.prototype._loadData=function(){return e.showError("Attempting to load data for a resource type that has no data loading function implemented!"),!1},s.prototype.onFinalLoad=function(){this._requested=!1,this._loading=!1,this.setToReady()},s.prototype._onFilesLoad=function(t,e){this._hasError=this._hasError||!this._loadData(e),!0===t&&this.onFinalLoad()},s.prototype.requestLoadFromFile=function(){!1===this._readyToUse&&!0===this._requested&&!1===this._loading&&(this._loading=!0,this._requestFiles(this._requestParams))},s.prototype.getData=function(){return null},n.prototype=new s,n.prototype.constructor=n,n.prototype.requiresReload=function(){return!this.isRequested()&&!this.isLoaded()},n.prototype._requestFiles=function(){e.requestTextFile(this._sourceFolder,this._source,function(t){this._onFilesLoad(!0,JSON.parse(t))}.bind(this))},n.prototype._loadData=function(t){return this._source=this._source||"",this._dataJSON=t,!0},n.prototype.getData=function(){return this._dataJSON},n.prototype.reloadData=function(){this._loadData(this._dataJSON)},o.prototype=new i.AsyncResource,o.prototype.constructor=o,o.prototype.allResourcesAreLoaded=function(){return this._numLoadedResources===this._numRequestedResources},o.prototype.addResource=function(t,i){var s=t._name;return this._resources[s]?e.showError("Attemtping to add a resource named '"+s+"' that already exists! Data will be overwritten."):i||this._resourceNames.push(s),this._resources[s]=t,this._resources[s]},o.prototype.getResource=function(t,i){var s;return this._resources[t]?(s=this._resources[t],i&&i.doNotLoad||s.requiresReload(i)&&(this._numRequestedResources++,this.resetReadyState(),s.resetReadyState(),s.executeWhenReady(function(){this._numLoadedResources++,this.allResourcesAreLoaded()&&this.setToReady()}.bind(this))),s):(i&&!0===i.allowNullResult||e.showError("Requested a resource named '"+t+"' from "+this._resourceType+", which does not exist."),null)},o.prototype.requestResourceLoad=function(){var t;for(t in this._resources)this._resources.hasOwnProperty(t)&&this._resources[t].requestLoadFromFile()},o.prototype.getResourceNames=function(t){return t?Object.keys(this._resources):this._resourceNames},o.prototype.renameResource=function(t,e){t!==e&&(this._resources[e]=this._resources[t],delete this._resources[t],this._resourceNames[this._resourceNames.indexOf(t)]=e)},o.prototype.moveResourceAfter=function(t,e){this._resourceNames.splice(this._resourceNames.indexOf(t),1),this._resourceNames.splice(this._resourceNames.indexOf(e)+1,0,t)},r.prototype=new i.AsyncResource,r.prototype.constructor=r,r.prototype.setToReady=function(){this._onResourceTypeLoadFunctionQueues={},this._onAnyResourceTypeLoadFunctionQueue=[],this._onResourceLoadFunctionQueue=[],this._numRequestedResources=0,this._numLoadedResources=0,i.AsyncResource.prototype.setToReady.call(this)},r.prototype.executeOnResourceTypeLoad=function(t,e){this._onResourceTypeLoadFunctionQueues[t]=this._onResourceTypeLoadFunctionQueues[t]||[],this._onResourceTypeLoadFunctionQueues[t].push(e)},r.prototype.executeOnAnyResourceTypeLoad=function(t){this._onAnyResourceTypeLoadFunctionQueue.push(t)},r.prototype.executeOnResourceLoad=function(t){this._onResourceLoadFunctionQueue.push(t)},r.prototype.addResource=function(t,e,i){return this._resourceHolders[t]=this._resourceHolders[t]||new o(t),this._resourceHolders[t].addResource(e,i)},r.prototype.createResource=function(t,i){return this._resourceClasses?this._resourceClasses[t]?void this.addResource(t,new this._resourceClasses[t](i,this._sourceFolder)):void e.showError("Cannot create resource of type '"+t+"': no resource constructor was assigned for this resource type!"):void e.showError("Cannot create resource of type '"+t+"': no resource constructors were assigned!")},r.prototype._onResourceLoad=function(t,e){var i,s;for(s=this._onResourceLoadFunctionQueue,i=0;i<s.length;i++)s[i](e,t,this._numRequestedResources,this._numLoadedResources);if(this.allResourcesOfTypeAreLoaded(t))for(s=this._onResourceTypeLoadFunctionQueues[t]||[],i=0;i<s.length;i++)s[i]();this.allResourcesAreLoaded()&&this.setToReady()},r.prototype.getResource=function(t,i,s){var n;return(n=this._resourceHolders[t]?this._resourceHolders[t].getResource(i,s):null)?(s&&s.doNotLoad||n.requiresReload(s)&&(this._numRequestedResources++,this.resetReadyState(),n.request(s),n.executeWhenReady(function(){this._numLoadedResources++,this._onResourceLoad(t,i)}.bind(this))),n):(s&&!0===s.allowNullResult||e.showError("Requested a resource named '"+i+"' of type '"+t+"', which does not exist."),null)},r.prototype.requestAllResources=function(t){var e,i,s;for(e in this._resourceHolders)if(this._resourceHolders.hasOwnProperty(e))for(i=this._resourceHolders[e].getResourceNames(t),s=0;s<i.length;s++)this.getResource(e,i[s])},r.prototype.allResourcesOfTypeAreLoaded=function(t){return this._resourceHolders[t]._readyToUse},r.prototype.allResourcesAreLoaded=function(){return this._numLoadedResources===this._numRequestedResources},r.prototype.requestConfigLoad=function(t,i,s,n){e.requestTextFile(i,t,function(t){this._loadConfigFromJSON(JSON.parse(t),s),n&&n()}.bind(this))},r.prototype._loadConfigFromJSON=function(t,e){var i,s,n;this._resourceClasses=e,this._sourceFolder=t.config?t.config.sourceFolder:null;for(i in e)if(e.hasOwnProperty(i))for(s=t[i],n=0;n<s.length;n++)this.addResource(i,new e[i](s[n],this._sourceFolder))},r.prototype.requestResourceLoad=function(){var t;if(!0===this.allResourcesAreLoaded())this.executeOnReadyQueue();else for(t in this._resourceHolders)this._resourceHolders.hasOwnProperty(t)&&this._resourceHolders[t].requestResourceLoad()},r.prototype.getResourceTypes=function(){return Object.keys(this._resourceHolders)},r.prototype.getResourceNames=function(t){return this._resourceHolders[t]?this._resourceHolders[t].getResourceNames():(e.showError("Asked for the names of resources of type: '"+t+"', but no such resource type exists!"),null)},r.prototype.renameResource=function(t,e,i){this._resourceHolders[t].renameResource(e,i)},r.prototype.moveResourceAfter=function(t,e,i){this._resourceHolders[t].moveResourceAfter(e,i)},r.prototype.executeForAllResourcesOfType=function(t,e,i,s){var n,o;for(o=this._resourceHolders[t].getResourceNames(i),n=0;n<o.length;n++)e(this._resourceHolders[t].getResource(o[n],{doNotLoad:s}),t)},r.prototype.executeForAllResources=function(t,e){var i,s=Object.keys(this._resourceHolders);for(i=0;i<s.length;i++)this.executeForAllResourcesOfType(s[i],t,e)},{GenericResource:s,JSONResource:n,ResourceManager:r}}),define("modules/egom-model",["utils/vectors","modules/application"],function(t,e){"use strict";function i(t,e,i,s){this.x=t,this.y=e,this.z=i,s=s||[this.x,this.y],this.u=s[0],this.v=s[1]}function s(t,e,i,s){this.a=t,this.b=e,this.color=i,this.normal=s}function n(e,i,s,n,o,r,a,l){this._mesh=e,this.a=i,this.b=s,this.c=n,this.color=o,this.texCoords=r,this.normals=a||t.normalize3(t.cross3(this._mesh.getVector(i,s),this._mesh.getVector(i,n))),this.groupIndices=l||[0,0]}function o(){this.bufferStartWireframe=0,this.bufferStartSolid=0,this.bufferStartTransparent=0}function r(){this._vertices=[],this._lines=[],this._triangles=[],this._size=0,this._maxX=0,this._minX=0,this._maxY=0,this._minY=0,this._maxZ=0,this._minZ=0,this._nOpaqueTriangles=0,this._nTransparentTriangles=0,this._contextProperties={},this._texCoords=[[0,1],[1,1],[1,0],[0,0]],this._currentGroupIndices=[0,0],this._nullVertex=new i(0,0,0)}function a(){this.wireframe=!1,this.solid=!1,this.minLOD=0,this.maxLOD=0}function l(){this._meshes=[],this._minLOD=this.LOD_NOT_SET,this._maxLOD=this.LOD_NOT_SET,this._name=null,this._infoProperties={},this._scale=1,this._contextProperties={},this._position4=!1}var h={POSITION:"position",POSITION4:"position4",TEXTURE_COORDINATES:"texCoord",NORMAL:"normal",COLOR:"color",GROUP_INDICES:"groupIndices",TRIANGLE_INDEX:"triangleIndex"},u=[[0,0],[1,1]],c=["3.3"];return Object.freeze(h),i.prototype.getTexCoords=function(){return[this.u,this.v]},i.prototype.setX=function(t){this.x=t},i.prototype.setY=function(t){this.y=t},i.prototype.setZ=function(t){this.z=t},n.prototype.getNormal=function(t){return this.normals[t]||this.normals[0]},r.prototype.getNumOpaqueTriangles=function(){return this._nOpaqueTriangles},r.prototype.getNumTransparentTriangles=function(){return this._nTransparentTriangles},r.prototype.resetMesh=function(){this.resetVertices(),this.resetLines(),this.resetTriangles()},r.prototype.resetVertices=function(){this._vertices=[],this._maxX=0,this._minX=0,this._maxY=0,this._minY=0,this._maxZ=0,this._minZ=0},r.prototype.setVertex=function(e,i){var s,n;if(this._vertices.length<e)for(s=this._vertices.length;s<e;s++)this._vertices[s]=this._nullVertex;this._vertices[e]=i,n=t.length3([this._vertices[e].x,this._vertices[e].y,this._vertices[e].z]),2*n>this._size&&(this._size=2*n),this._vertices[e].x>this._maxX&&(this._maxX=this._vertices[e].x),this._vertices[e].x<this._minX&&(this._minX=this._vertices[e].x),this._vertices[e].y>this._maxY&&(this._maxY=this._vertices[e].y),this._vertices[e].y<this._minY&&(this._minY=this._vertices[e].y),this._vertices[e].z>this._maxZ&&(this._maxZ=this._vertices[e].z),this._vertices[e].z<this._minZ&&(this._minZ=this._vertices[e].z)},r.prototype.appendVertex=function(t,e){this.setVertex(this._vertices.length,new i(t[0],t[1],t[2],e))},r.prototype.resetLines=function(){this._lines=[]},r.prototype.addLine=function(t){this._lines.push(t)},r.prototype.setLine=function(t,e){this._lines[t]=e},r.prototype.resetTriangles=function(){this._triangles=[],this._nOpaqueTriangles=0,this._nTransparentTriangles=0},r.prototype.getVector=function(t,e){return[this._vertices[e].x-this._vertices[t].x,this._vertices[e].y-this._vertices[t].y,this._vertices[e].z-this._vertices[t].z]},r.prototype.addTriangle=function(t,e){this._triangles.push(t),e||(this._lines.push(new s(t.a,t.b,t.color,t.getNormal(0))),this._lines.push(new s(t.b,t.c,t.color,t.getNormal(0))),this._lines.push(new s(t.c,t.a,t.color,t.getNormal(0)))),t.color[3]<1?this._nTransparentTriangles++:this._nOpaqueTriangles++},r.prototype.addTriangleWithParams=function(t,e,i,s){var o,r,a,l,h;return o=s.color||[1,1,1,1],r=s.useVertexTexCoords?[this._vertices[t].getTexCoords(),this._vertices[e].getTexCoords(),this._vertices[i].getTexCoords()]:s.texCoords||[this._texCoords[0],this._texCoords[1],this._texCoords[2]],a=s.normals,l=s.groupIndices||this._currentGroupIndices,h=new n(this,t,e,i,o,r,a,l),this.addTriangle(h,s.withoutLines),h},r.prototype.addQuad=function(t,e,i,n,o){var r,a,l,h;o=o||{},r=Object.create(o),r.withoutLines=!0,r.texCoords=o.useVertexTexCoords?[this._vertices[t].getTexCoords(),this._vertices[e].getTexCoords(),this._vertices[i].getTexCoords()]:o.texCoords?[o.texCoords[0],o.texCoords[1],o.texCoords[2]]:[this._texCoords[0],this._texCoords[1],this._texCoords[2]],r.normals=o.normals?4===o.normals.length?[o.normals[0],o.normals[1],o.normals[2]]:o.normals:null,this.addTriangleWithParams(t,e,i,r),a=Object.create(o),a.texCoords=o.useVertexTexCoords?[this._vertices[i].getTexCoords(),this._vertices[n].getTexCoords(),this._vertices[t].getTexCoords()]:o.texCoords?[o.texCoords[2],o.texCoords[3],o.texCoords[0]]:[this._texCoords[2],this._texCoords[3],this._texCoords[0]],a.normals=o.normals?4===o.normals.length?[o.normals[2],o.normals[3],o.normals[0]]:o.normals:null,this.addTriangleWithParams(i,n,t,a),o.withoutLines||(l=o.color||[1,1,1,1],h=o.normals?o.normals[0]:this._triangles[this._triangles.length-1].getNormal(0),this._lines.push(new s(t,e,l,h)),this._lines.push(new s(e,i,l,h)),this._lines.push(new s(i,n,l,h)),this._lines.push(new s(n,t,l,h)))},r.prototype.getSize=function(){return this._size},r.prototype.getMaxX=function(){return this._maxX},r.prototype.getMinX=function(){return this._minX},r.prototype.getMaxY=function(){return this._maxY},r.prototype.getMinY=function(){return this._minY},r.prototype.getMaxZ=function(){return this._maxZ},r.prototype.getMinZ=function(){return this._minZ},r.prototype.getWidth=function(){return this._maxX-this._minX},r.prototype.getHeight=function(){return this._maxY-this._minY},r.prototype.getDepth=function(){return this._maxZ-this._minZ},r.prototype.getBufferData=function(t,e,i){var s,n,o,r,a,l,u,c,_,d,p,g,m;if(e=e||0,!0===t){if(o=this._lines.length,i)for(u=new Float32Array(8*o),s=0;s<o;s++)u[8*s]=this._vertices[this._lines[s].a].x,u[8*s+1]=this._vertices[this._lines[s].a].y,u[8*s+2]=this._vertices[this._lines[s].a].z,u[8*s+3]=0,u[8*s+4]=this._vertices[this._lines[s].b].x,u[8*s+5]=this._vertices[this._lines[s].b].y,u[8*s+6]=this._vertices[this._lines[s].b].z,u[8*s+7]=1;else for(u=new Float32Array(6*o),s=0;s<o;s++)u[6*s]=this._vertices[this._lines[s].a].x,u[6*s+1]=this._vertices[this._lines[s].a].y,u[6*s+2]=this._vertices[this._lines[s].a].z,u[6*s+3]=this._vertices[this._lines[s].b].x,u[6*s+4]=this._vertices[this._lines[s].b].y,u[6*s+5]=this._vertices[this._lines[s].b].z;for(c=new Float32Array(4*o),s=0;s<o;s++)c[4*s]=0,c[4*s+1]=1,c[4*s+2]=1,c[4*s+3]=1;for(_=new Float32Array(6*o),s=0;s<o;s++)_[6*s]=this._lines[s].normal[0],_[6*s+1]=this._lines[s].normal[1],_[6*s+2]=this._lines[s].normal[2],_[6*s+3]=this._lines[s].normal[0],_[6*s+4]=this._lines[s].normal[1],_[6*s+5]=this._lines[s].normal[2];for(d=new Float32Array(8*o),s=0;s<o;s++)d[8*s]=this._lines[s].color[0],d[8*s+1]=this._lines[s].color[1],d[8*s+2]=this._lines[s].color[2],d[8*s+3]=1,d[8*s+4]=this._lines[s].color[0],d[8*s+5]=this._lines[s].color[1],d[8*s+6]=this._lines[s].color[2],d[8*s+7]=1;for(p=new Float32Array(4*o),s=0;s<o;s++)p[4*s]=0,p[4*s+1]=0,p[4*s+2]=0,p[4*s+3]=0;for(r=this._triangles.length,g=new Float32Array(3*r),s=0;s<r;s++)g[12*s]=0,g[12*s+1]=0,g[12*s+2]=0,g[12*s+3]=0,g[12*s+4]=0,g[12*s+5]=0,g[12*s+6]=0,g[12*s+7]=0,g[12*s+8]=0,g[12*s+9]=0,g[12*s+10]=0,g[12*s+11]=0}else{if(r=this._triangles.length,i)for(u=new Float32Array(12*r),s=0;s<r;s++)u[12*s]=this._vertices[this._triangles[s].a].x,u[12*s+1]=this._vertices[this._triangles[s].a].y,u[12*s+2]=this._vertices[this._triangles[s].a].z,u[12*s+3]=0,u[12*s+4]=this._vertices[this._triangles[s].b].x,u[12*s+5]=this._vertices[this._triangles[s].b].y,u[12*s+6]=this._vertices[this._triangles[s].b].z,u[12*s+7]=1,u[12*s+8]=this._vertices[this._triangles[s].c].x,u[12*s+9]=this._vertices[this._triangles[s].c].y,u[12*s+10]=this._vertices[this._triangles[s].c].z,u[12*s+11]=2;else for(u=new Float32Array(9*r),s=0;s<r;s++)u[9*s]=this._vertices[this._triangles[s].a].x,u[9*s+1]=this._vertices[this._triangles[s].a].y,u[9*s+2]=this._vertices[this._triangles[s].a].z,u[9*s+3]=this._vertices[this._triangles[s].b].x,u[9*s+4]=this._vertices[this._triangles[s].b].y,u[9*s+5]=this._vertices[this._triangles[s].b].z,u[9*s+6]=this._vertices[this._triangles[s].c].x,u[9*s+7]=this._vertices[this._triangles[s].c].y,u[9*s+8]=this._vertices[this._triangles[s].c].z;for(c=new Float32Array(6*r),s=0;s<r;s++)c[6*s]=this._triangles[s].texCoords[0][0],c[6*s+1]=this._triangles[s].texCoords[0][1],c[6*s+2]=this._triangles[s].texCoords[1][0],c[6*s+3]=this._triangles[s].texCoords[1][1],c[6*s+4]=this._triangles[s].texCoords[2][0],c[6*s+5]=this._triangles[s].texCoords[2][1];for(_=new Float32Array(9*r),s=0;s<r;s++)_[9*s]=this._triangles[s].getNormal(0)[0],_[9*s+1]=this._triangles[s].getNormal(0)[1],_[9*s+2]=this._triangles[s].getNormal(0)[2],_[9*s+3]=this._triangles[s].getNormal(1)[0],_[9*s+4]=this._triangles[s].getNormal(1)[1],_[9*s+5]=this._triangles[s].getNormal(1)[2],_[9*s+6]=this._triangles[s].getNormal(2)[0],_[9*s+7]=this._triangles[s].getNormal(2)[1],_[9*s+8]=this._triangles[s].getNormal(2)[2];for(d=new Float32Array(12*r),s=0;s<r;s++)d[12*s]=this._triangles[s].color[0],d[12*s+1]=this._triangles[s].color[1],d[12*s+2]=this._triangles[s].color[2],d[12*s+3]=this._triangles[s].color[3],d[12*s+4]=this._triangles[s].color[0],d[12*s+5]=this._triangles[s].color[1],d[12*s+6]=this._triangles[s].color[2],d[12*s+7]=this._triangles[s].color[3],d[12*s+8]=this._triangles[s].color[0],d[12*s+9]=this._triangles[s].color[1],d[12*s+10]=this._triangles[s].color[2],d[12*s+11]=this._triangles[s].color[3];for(p=new Float32Array(6*r),s=0;s<r;s++)p[6*s]=this._triangles[s].groupIndices[0],p[6*s+1]=this._triangles[s].groupIndices[1],p[6*s+2]=this._triangles[s].groupIndices[0],p[6*s+3]=this._triangles[s].groupIndices[1],p[6*s+4]=this._triangles[s].groupIndices[0],p[6*s+5]=this._triangles[s].groupIndices[1];for(g=new Float32Array(12*r),s=0;s<r;s++){for(a=e+s,l=[],n=0;n<4;n++)l[n]=a%256/255,a=Math.floor(a/256);g[12*s]=l[0],g[12*s+1]=l[1],g[12*s+2]=l[2],g[12*s+3]=l[3],g[12*s+4]=l[0],g[12*s+5]=l[1],g[12*s+6]=l[2],g[12*s+7]=l[3],g[12*s+8]=l[0],g[12*s+9]=l[1],g[12*s+10]=l[2],g[12*s+11]=l[3]}}return m={},m[i?h.POSITION4:h.POSITION]=u,m[h.TEXTURE_COORDINATES]=c,m[h.NORMAL]=_,m[h.COLOR]=d,m[h.GROUP_INDICES]=p,m[h.TRIANGLE_INDEX]=g,m.dataSize=t?2*this._lines.length:3*this._triangles.length,m},r.prototype.getBufferSize=function(t,e){return(t?2*this._lines.length:0)+(e?3*this._triangles.length:0)},r.prototype.loadToVertexBuffers=function(t,e,i,s,n){var r=null,a=0,l=this._contextProperties[t._name]||new o;return i&&(r=this.getBufferData(!0,e,n),l.bufferStartWireframe=e,t.setVertexBufferData(r,e),a+=r.dataSize,e+=r.dataSize),s&&(r=this.getBufferData(!1,e,n),l.bufferStartSolid=e,l.bufferStartTransparent=e+3*this._nOpaqueTriangles,t.setVertexBufferData(r,e),a+=r.dataSize,e+=r.dataSize),this._contextProperties[t._name]=l,a},r.prototype.render=function(t,e,i){var s=this._contextProperties[t._name];if(!0===e)t.gl.drawArrays(t.gl.LINES,s.bufferStartWireframe,2*this._lines.length);else switch(i){case!0:t.gl.drawArrays(t.gl.TRIANGLES,s.bufferStartSolid,3*this._nOpaqueTriangles);break;case!1:t.gl.drawArrays(t.gl.TRIANGLES,s.bufferStartTransparent,3*this._nTransparentTriangles);break;case void 0:t.gl.drawArrays(t.gl.TRIANGLES,s.bufferStartSolid,3*this._triangles.length)}},r.prototype.renderInstances=function(t,e,i,s){var n=this._contextProperties[t._name];if(!0===e)t.instancingExt.drawArraysInstancedANGLE(t.gl.LINES,n.bufferStartWireframe,2*this._lines.length,s);else switch(i){case!0:t.instancingExt.drawArraysInstancedANGLE(t.gl.TRIANGLES,n.bufferStartSolid,3*this._nOpaqueTriangles,s);break;case!1:t.instancingExt.drawArraysInstancedANGLE(t.gl.TRIANGLES,n.bufferStartTransparent,3*this._nTransparentTriangles,s);break;case void 0:t.instancingExt.drawArraysInstancedANGLE(t.gl.TRIANGLES,n.bufferStartSolid,3*this._triangles.length,s)}},l.prototype.LOD_NOT_SET=-1,l.prototype.setName=function(t){this._name=t},l.prototype.getMinLOD=function(){return this._minLOD},l.prototype.getMaxLOD=function(){return this._maxLOD},l.prototype.includeVertexIndicesInPosition=function(t){this._position4=t},l.prototype.getClosestAvailableLOD=function(t){return Math.min(Math.max(this.getMinLOD(),t),this.getMaxLOD())},l.prototype.updateLODInfo=function(t,e){this._minLOD=this._minLOD===this.LOD_NOT_SET?t:t<this._minLOD?t:this._minLOD,this._maxLOD=this._maxLOD===this.LOD_NOT_SET?e:e>this._maxLOD?e:this._maxLOD},l.prototype.getMeshWithLOD=function(t){var e;for(e=this._meshes.length;e<=t;e++)this._meshes.push(new r),this._maxLOD=e;return this._meshes[t]},l.prototype.setVertex=function(t,e,i,s){var n;for(n=t;n<=e;n++)this._meshes[n].setVertex(i,s)},l.prototype.addLineDirect=function(t,e,i){var s;for(s=t;s<=e;s++)this._meshes[s].addLine(i)},l.prototype.addTriangleDirect=function(t,e,i,s,n,o){var r,a=this._meshes[t].addTriangleWithParams(i,s,n,o);for(r=t+1;r<=e;r++)this._meshes[r].addTriangle(a,o.withoutLines);return a},l.prototype.loadFromJSON=function(t,n,o){var r,a,l,h,u,_,d,p,g,m,f,S,T,E=null,y=null,I=null,A=null,M=function(t,e){var i;if(null===E){for(i=t;i<=e;i++)this.getMeshWithLOD(i).resetMesh();E=t,y=e}else{for(i=t;i<E;i++)this.getMeshWithLOD(i).resetMesh();for(i=y+1;i<=e;i++)this.getMeshWithLOD(i).resetMesh();E=t<E?t:E,y=e>y?e:y}}.bind(this);if(o=o||0,"object"!=typeof n)return e.showError("'"+t+"' does not appear to be a JSON file.",e.ErrorSeverity.SEVERE,"A model was supposed to be loaded from this file, but only models of EgomModel JSON format are accepted."),!1;if(!(h=n.version))return e.showError("Model from file: '"+t+"' could not be loaded, because the file version could not have been determined.",e.ErrorSeverity.SEVERE),!1;if(c.indexOf(h)<0)return e.showError("Model from file: '"+t+"' could not be loaded, because the version of the file ("+h+") is not supported.",e.ErrorSeverity.SEVERE,"Supported versions are: "+c.join(", ")+"."),!1;for(u=null,this._infoProperties=n.info||{},this._name=n.info.name||null,this._scale=n.info.scale||1,I=null===n.info.LOD[0]?o:n.info.LOD[0],A=null===n.info.LOD[1]?o:n.info.LOD[1],this.updateLODInfo(I,A),M(I,A),u=n.info.colorPalette,d=n.vertices.length,m=0,r=0;r<d;r++)T=n.vertices[r].length,1===T?m+=n.vertices[r][0]:(n.vertices[r].length>=5?(a=n.vertices[r][3],l=n.vertices[r][4]):(a=I,l=A),f=new i(n.vertices[r][0],n.vertices[r][1],n.vertices[r][2]),this.setVertex(a,l,m,f),m++);for(p=n.lines.length,r=0;r<p;r++)n.lines[r].length>=8?(a=n.lines[r][6],l=n.lines[r][7]):(a=I,l=A),S=new s(n.lines[r][0],n.lines[r][0]+n.lines[r][1],u[n.lines[r][2]],0,n.lines[r].slice(3,6)),this.addLineDirect(a,l,S);for(g=n.triangles.length,_={},r=0;r<g;r++)T=n.triangles[r][0].length,6===T||12===T?(a=n.triangles[r][0][T-2],l=n.triangles[r][0][T-1]):(a=I,l=A),_.color=u[n.triangles[r][0][3]],_.texCoords=T>=10?[n.triangles[r][0].slice(4,6),n.triangles[r][0].slice(6,8),n.triangles[r][0].slice(8,10)]:_.texCoords,_.normals=n.triangles[r][1].length>0?n.triangles[r][1].length>3?[n.triangles[r][1].slice(0,3),n.triangles[r][1].slice(3,6),n.triangles[r][1].slice(6,9)]:[n.triangles[r][1]]:_.normals,_.groupIndices=n.triangles[r].length>=3?n.triangles[r][2].length>0?n.triangles[r][2]:_.groupIndices:null,_.withoutLines=!0,m=n.triangles[r][0][0],this.addTriangleDirect(a,l,m,m+n.triangles[r][0][1],m+n.triangles[r][0][2],_);return!0},l.prototype._getLargestValueOfMeshes=function(t,e){var i,s;if(void 0!==t)return e(this.getMeshWithLOD(t));for(t=this._minLOD;t<=this._maxLOD;t++)s=e(this.getMeshWithLOD(t)),(void 0===i||s>i)&&(i=s);return i},l.prototype._getLowestValueOfMeshes=function(t,e){var i,s;if(void 0!==t)return e(this.getMeshWithLOD(t));for(t=this._minLOD;t<=this._maxLOD;t++)s=e(this.getMeshWithLOD(t)),(void 0===i||s<i)&&(i=s);return i},l.prototype.getSize=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getSize():0})},l.prototype.getMaxX=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getMaxX():0})},l.prototype.getMinX=function(t){return this._getLowestValueOfMeshes(t,function(t){return t?t.getMinX():0})},l.prototype.getMaxY=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getMaxY():0})},l.prototype.getMinY=function(t){return this._getLowestValueOfMeshes(t,function(t){return t?t.getMinY():0})},l.prototype.getMaxZ=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getMaxZ():0})},l.prototype.getMinZ=function(t){return this._getLowestValueOfMeshes(t,function(t){return t?t.getMinZ():0})},l.prototype.getWidth=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getWidth():0})},l.prototype.getHeight=function(t){
return this._getLargestValueOfMeshes(t,function(t){return t?t.getHeight():0})},l.prototype.getDepth=function(t){return this._getLargestValueOfMeshes(t,function(t){return t?t.getDepth():0})},l.prototype.getWidthInMeters=function(t){return t=void 0!==t?t:this._minLOD,this.getWidth(t)*this._scale},l.prototype.getHeightInMeters=function(t){return t=void 0!==t?t:this._minLOD,this.getHeight(t)*this._scale},l.prototype.getDepthInMeters=function(t){return t=void 0!==t?t:this._minLOD,this.getDepth(t)*this._scale},l.prototype.getNumOpaqueTriangles=function(t){return t=void 0!==t?t:this._minLOD,this.getMeshWithLOD(t).getNumOpaqueTriangles()},l.prototype.getNumTransparentTriangles=function(t){return t=void 0!==t?t:this._minLOD,this.getMeshWithLOD(t).getNumTransparentTriangles()},l.prototype.addToContext=function(t,e){this._minLOD=this._minLOD!==this.LOD_NOT_SET?this._minLOD:0,this._maxLOD=this._maxLOD!==this.LOD_NOT_SET?this._maxLOD:0;var i=this._contextProperties[t._name];i?(!i.wireframe&&e&&(i.wireframe=!0,t.resetReadyState()),i.solid||e||(i.solid=!0,t.resetReadyState()),i.minLOD>this._minLOD&&(i.minLOD=this._minLOD,t.resetReadyState()),i.maxLOD<this._maxLOD&&(i.maxLOD=this._maxLOD,t.resetReadyState())):(i=new a,i.wireframe=e,i.solid=!e,i.minLOD=this._minLOD,i.maxLOD=this._maxLOD,t.addModel(this)),this._contextProperties[t._name]=i},l.prototype.clearContextBindings=function(){var t;for(t in this._contextProperties)this._contextProperties.hasOwnProperty(t)&&delete this._contextProperties[t]},l.prototype.getBufferData=function(t,e,i){return i=void 0!==i?i:this._minLOD,this._meshes[i].getBufferData(t,e,this._position4)},l.prototype.getBufferSize=function(t){var e,i=this._contextProperties[t._name],s=0;for(e=i.minLOD;e<=i.maxLOD;e++)s+=this._meshes[e].getBufferSize(i.wireframe,i.solid);return s},l.prototype.loadToVertexBuffers=function(t,e,i){i=void 0!==i?i:this._minLOD;var s=this._contextProperties[t._name];return this._meshes[i].loadToVertexBuffers(t,e,s.wireframe,s.solid,this._position4)},l.prototype.render=function(t,e,i,s){s=void 0!==s?s:this._minLOD,this._meshes[s].render(t,e,i)},l.prototype.renderInstances=function(t,e,i,s,n){s=void 0!==s?s:this._minLOD,this._meshes[s].renderInstances(t,e,i,n)},l.prototype.appendVertex=function(t,e){this.getMeshWithLOD(0).appendVertex(t,e)},l.prototype.addLine=function(t){this.getMeshWithLOD(0).addLine(t)},l.prototype.addQuad=function(t,e,i,s,n){this.getMeshWithLOD(0).addQuad(t,e,i,s,n)},{VertexAttributeRole:h,Model:l,fvqModel:function(t){var e=new l;return t&&e.setName(t),e.appendVertex([-1,-1,0]),e.appendVertex([1,-1,0]),e.appendVertex([1,1,0]),e.appendVertex([-1,1,0]),e.addQuad(0,1,2,3),e},squareModel:function(t,e){var i,s=new l;return t&&s.setName(t),i=e||u,s.appendVertex([-1,-1,0]),s.appendVertex([1,-1,0]),s.appendVertex([1,1,0]),s.appendVertex([-1,1,0]),s.addQuad(0,1,2,3,{texCoords:[[i[0][0],i[1][1]],[i[1][0],i[1][1]],[i[1][0],i[0][1]],[i[0][0],i[0][1]]]}),s},turningBillboardModel:function(t,e,i){var s,n=.5-.5*i,o=.5+.5*i,r=.75-.25*i,a=.75+.25*i,h=new l;if(t&&h.setName(t),h.appendVertex([-i,-1,0]),h.appendVertex([i,-1,0]),h.appendVertex([i,1,0]),h.appendVertex([-i,1,0]),h.addQuad(0,1,2,3,{texCoords:[[n,.5],[o,.5],[o,0],[n,0]]}),e)for(s=0;s<e.length;s++)h.appendVertex([i,e[s],-i]),h.appendVertex([-i,e[s],-i]),h.appendVertex([-i,e[s],i]),h.appendVertex([i,e[s],i]),h.addQuad(4*(s+1),4*(s+1)+1,4*(s+1)+2,4*(s+1)+3,{texCoords:[[n,a],[o,a],[o,r],[n,r]]}),h.addQuad(4*(s+1)+3,4*(s+1)+2,4*(s+1)+1,4*(s+1),{texCoords:[[n,a],[o,a],[o,r],[n,r]]});return h},lineModel:function(t,e,i){var n=new l;return t&&n.setName(t),n.appendVertex([0,0,0]),n.appendVertex(e),n.addLine(new s(0,1,i,e)),n},gridModel:function(t,e,i,n,o,r){var a,h=[0,0,0],u=[0,0,1],c=new l;for(t&&c.setName(t),a=0;a<n;a++)h[0]=e*(a/(n-1)-.5),h[1]=-.5*i,c.appendVertex(h),h[1]=.5*i,c.appendVertex(h),c.addLine(new s(2*a,2*a+1,r,u));for(a=0;a<o;a++)h[0]=-.5*e,h[1]=i*(a/(o-1)-.5),c.appendVertex(h),h[0]=.5*e,c.appendVertex(h),c.addLine(new s(2*(n+a),2*(n+a)+1,r,u));return c},positionMarkerModel:function(t,e,i){var n,o,r=[1,0,0],a=[0,0,1],h=new l;for(t&&h.setName(t),h.appendVertex(r),n=1;n<e;n++)o=n/e*2*Math.PI,r[0]=Math.cos(o),r[1]=Math.sin(o),h.appendVertex(r),h.addLine(new s(n-1,n,i,a));return h.addLine(new s(n-1,0,i,a)),r[0]=0,r[1]=0,r[2]=0,h.appendVertex(r),r[2]=1,h.appendVertex(r),h.addLine(new s(n,n+1,i,a)),h}}}),define("modules/audio",["modules/application"],function(t){"use strict";function e(t,e,i,s){var n=S.currentTime;t.gain.cancelScheduledValues(n),t.gain.setValueAtTime(t.gain.value,n),s?t.gain.setTargetAtTime(e,n,i||y):t.gain.linearRampToValueAtTime(e,n+(i||y))}function i(t,e,i){this._position=t?t.slice():null,this._rolloffFactor=e||I,this._pannerNode=null,this._panningModel=i||A,this._clips={}}function s(t,e,i,s,n,o,r,a){this._soundCategory=t,this._sampleName=e,this._volume=i,this._loop=s,this._shouldStack=n||!1,this._stackTimeThreshold=o||0,this._stackVolumeFactor=r||1,this._sourceNode=null,this._gainNode=null,this._playbackStartTime=0,this._playing=!1,this._stopping=!1,this._onFinish=null,this._onEnded=null,this._soundSource=null,a&&this.setSource(a)}function n(e,i,s,n){S.decodeAudioData(i.response,function(t){M[e]=t,s&&s()},function(){t.showError("Decoding audio sample '"+e+"' failed!"),n&&n()})}function o(t,e,n,o){s.call(m,T.SOUND_EFFECT,t,e,!1),n&&(i.call(f,n,o,A),m.setSource(f)),m.play()}function r(t,i){e(c,t,i)}function a(t,i){e(_,t,i)}function l(t,i){e(d,t,i)}function h(t,i){e(p,t,i)}function u(){S.resume()}var c,_,d,p,g,m,f,S,T={NOME:0,SOUND_EFFECT:1,MUSIC:2,UI:3},E={EQUAL_POWER:"equalpower",HRTF:"HRTF"},y=.01,I=.01,A=E.EQUAL_POWER,M={};return i.prototype.getNode=function(){return this._pannerNode||(this._pannerNode=S.createPanner(),this._pannerNode.panningModel=this._panningModel,this._pannerNode.refDistance=1,this._pannerNode.rolloffFactor=this._rolloffFactor,this._pannerNode.setPosition(this._position[0],this._position[1],this._position[2]),this._pannerNode.connect(c)),this._pannerNode},i.prototype.setPosition=function(t,e,i){var s;t===this._position[0]&&e===this._position[1]&&i===this._position[2]||(this._position[0]=t,this._position[1]=e,this._position[2]=i,this._pannerNode&&(this._pannerNode.positionX&&(!this._gainNode||this._gainNode.gain.value>0)?(s=S.currentTime,this._pannerNode.positionX.value!==t&&(this._pannerNode.positionX.cancelScheduledValues(s),this._pannerNode.positionX.setValueAtTime(this._pannerNode.positionX.value,s),this._pannerNode.positionX.linearRampToValueAtTime(t,s+y)),this._pannerNode.positionY.value!==e&&(this._pannerNode.positionY.cancelScheduledValues(s),this._pannerNode.positionY.setValueAtTime(this._pannerNode.positionY.value,s),this._pannerNode.positionY.linearRampToValueAtTime(e,s+y)),this._pannerNode.positionZ.value!==i&&(this._pannerNode.positionZ.cancelScheduledValues(s),this._pannerNode.positionZ.setValueAtTime(this._pannerNode.positionZ.value,s),this._pannerNode.positionZ.linearRampToValueAtTime(i,s+y))):this._pannerNode.setPosition(t,e,i)))},i.prototype.setClip=function(t,e){this._clips[t]=e},i.prototype.getClip=function(t){return this._clips[t]},i.prototype.destroy=function(){this._pannerNode&&this._pannerNode.disconnect(),this._pannerNode=null},s.prototype.setSource=function(e){this._soundCategory!==T.SOUND_EFFECT?t.showError("Cannot set sound source for clip '"+this._sampleName+"', because its sound category is not sound effect!"):this._soundSource?t.showError("Cannot set sound source for clip '"+this._sampleName+"', because it already has a source!"):this._playing?t.showError("Cannot set sound source for clip '"+this._sampleName+"', because it is already playing!"):this._soundSource=e},s.prototype.getVolume=function(){return void 0!==this._volume?this._volume:1},s.prototype.setVolume=function(t){this._volume=t,this._gainNode&&(this._gainNode.gain.value=t)},s.prototype.increaseVolume=function(t){this._volume+=t,this._gainNode&&(this._gainNode.gain.value=this._volume)},s.prototype.rampVolume=function(t,i,s,n){!this._gainNode||s&&this._volume===t||e(this._gainNode,t,i,n),this._volume=t},s.prototype.getPlaybackPosition=function(){var t=S.currentTime-this._playbackStartTime;return this._loop?t%M[this._sampleName].duration:Math.min(t,M[this._sampleName].duration)},s.prototype._handleEnded=function(){this._playing=!1},s.prototype._startPlayingSample=function(e,i){var s;if(this._sourceNode=S.createBufferSource(),this._sourceNode.buffer=M[this._sampleName],i?this._sourceNode.onended=function(){this._playing=!1,i()}.bind(this):(this._onEnded=this._onEnded||this._handleEnded.bind(this),this._sourceNode.onended=this._onEnded),this._onFinish=i,s=this._sourceNode,void 0!==this._volume&&(this._gainNode=S.createGain(),this._gainNode.gain.value=this._volume,s.connect(this._gainNode),s=this._gainNode),this._loop&&(this._sourceNode.loop=!0),this._soundSource)s.connect(this._soundSource.getNode());else switch(this._soundCategory){case T.SOUND_EFFECT:s.connect(c);break;case T.MUSIC:s.connect(_);break;case T.UI:s.connect(d);break;default:t.showError("Cannot play sound '"+this._sampleName+"', because it has an unkown category: "+this._soundCategory)}this._playing=!0,this._stopping=!1,this._sourceNode.start(S.currentTime,e),this._playbackStartTime=S.currentTime-e},s.prototype.play=function(e,i){var s;if(M[this._sampleName]){if(this._playing)if(e)this.stopPlaying();else if(this._loop)return;this._soundSource&&this._shouldStack?(s=this._soundSource.getClip(this._sampleName),s&&s._playing&&s.getPlaybackPosition()<=this._stackTimeThreshold?s.increaseVolume(this._volume*this._stackVolumeFactor):(this._startPlayingSample(0,i),this._soundSource&&this._soundSource.setClip(this._sampleName,this))):this._startPlayingSample(0,i)}else this._sampleName&&t.showError("Attempting to play back '"+this._sampleName+"', which is not loaded!")},s.prototype.stopPlaying=function(t){this._sourceNode&&this._playing&&!this._stopping&&(t?(this.rampVolume(0,t),setTimeout(this._sourceNode.stop.bind(this._sourceNode),1e3*t),this._stopping=!0):this._sourceNode.stop())},s.prototype.stopLoop=function(){this._sourceNode&&this._playing&&!this._stopping&&(this._sourceNode.loop=!1,this._stopping=!0)},s.prototype.destroy=function(){this.stopPlaying(),this._sourceNode=null,this._gainNode=null,this._position=null},S=new AudioContext,p=S.createGain(),p.connect(S.destination),g=S.createDynamicsCompressor(),g.connect(p),c=S.createGain(),c.connect(g),_=S.createGain(),_.connect(g),d=S.createGain(),d.connect(p),m=new s,f=new i,{SoundCategory:T,PanningModel:E,SoundClip:s,SoundSource:i,loadSample:n,playSound:o,setEffectVolume:r,setMusicVolume:a,setUIVolume:l,setMasterVolume:h,resume:u}}),define("modules/media-resources",["utils/utils","utils/types","modules/application","modules/resource-manager","modules/managed-gl","modules/egom-model","modules/audio"],function(t,e,i,s,n,o,r){"use strict";function a(t){s.GenericResource.call(this,t?t.name:""),this._dataJSON=t,t&&this._loadConfig(t)}function l(t){a.call(this,t)}function h(t){a.call(this,t)}function u(t){a.call(this,t)}function c(t){a.call(this,t)}function _(t){a.call(this,t)}function d(t){a.call(this,t)}function p(){s.ResourceManager.call(this)}function g(t,e){var i={};i[S]=l,i[T]=h,i[E]=u,i[y]=c,i[I]=_,i[A]=d,m.requestConfigLoad(t.filename,t.folder,i,e)}var m,f={VERTEX:"vertex",FRAGMENT:"fragment"},S="textures",T="cubemaps",E="shaders",y="models",I="soundEffects",A="music",M={},C={},N={};return Object.freeze(f),a.prototype=new s.GenericResource,a.prototype.constructor=a,a.prototype._loadConfig=function(t){this._dataJSON=t},a.prototype.getData=function(){return this._dataJSON},a.prototype.reloadData=function(){this._loadConfig(this._dataJSON),this.resetReadyState()},l.prototype=new a,l.prototype.constructor=l,l.prototype._loadConfig=function(t){a.prototype._loadConfig.call(this,t),this._basepath=t.basepath,this._format=t.format,this._useMipmap=!0===t.useMipmap,this._typeSuffixes=t.typeSuffixes,this._qualitySuffixes=t.qualitySuffixes,this._loadedImages=0,this._imagesToLoad=0,this._images={},this._managedTextures={},this._cachedManagedTexturesOfTypes=[]},l.prototype._getPath=function(t,e){return this._basepath+this._typeSuffixes[t]+this._qualitySuffixes[e]+"."+this._format},l.prototype._getOnLoadImageFunction=function(t,e){var i=this._getPath(t,e);return function(){this._loadedImages++,this._onFilesLoad(this._loadedImages===this._imagesToLoad,{path:i})}.bind(this)},l.prototype._handleError=function(t){i.showError("Could not load texture '"+this._name+"': downloading file '"+t+"' failed!"),this._loadedImages++,this._onFilesLoad(this._loadedImages===this._imagesToLoad,{path:t,error:!0})},l.prototype._getMostFittingQuality=function(t){var e,s,n,o=this.getQualities(),r=-1;for(e=0;e<o.length;e++)(s=t.indexOf(o[e]))>=0&&(-1===r||s<r)&&(r=s,n=t[s]);return-1===r?(i.showError("Texture '"+this._name+"' is not available in any of the qualities: ["+t.join(", ")+"]!"),null):n},l.prototype._getProcessedParams=function(t){return t=t||{},t.types=t.types||Object.keys(this._typeSuffixes),t.qualities=t.qualities||t.qualityPreferenceList&&[this._getMostFittingQuality(t.qualityPreferenceList)]||Object.keys(this._qualitySuffixes),delete t.qualityPreferenceList,t},l.prototype.requiresReload=function(t){var e,i;if(t=this._getProcessedParams(t),this.isRequested(t))return!1;for(e=0;e<t.types.length;e++)if(this._typeSuffixes.hasOwnProperty(t.types[e])){if(!this._images[t.types[e]])return!0;for(i=0;i<t.qualities.length;i++)if(this._qualitySuffixes.hasOwnProperty(t.qualities[i])&&!this._images[t.types[e]][t.qualities[i]])return!0}return!1},l.prototype._requestFiles=function(t){var e,s,n,o,r;for(t=this._getProcessedParams(t),e=0;e<t.types.length;e++)if(n=t.types[e],this._typeSuffixes.hasOwnProperty(n))for(this._images[n]=this._images[n]||{},s=0;s<t.qualities.length;s++)o=t.qualities[s],this._qualitySuffixes.hasOwnProperty(o)&&(this._images[n][o]||(r=this._getPath(n,o),C[r]?this._images[n][o]=C[r]:(C[r]=new Image,this._imagesToLoad++,this._images[n][o]=C[r],this._images[n][o].onload=this._getOnLoadImageFunction(n,o).bind(this),this._images[n][o].onerror=this._handleError.bind(this,r))));for(e=0;e<t.types.length;e++)if(n=t.types[e],this._typeSuffixes.hasOwnProperty(n))for(s=0;s<t.qualities.length;s++)o=t.qualities[s],this._qualitySuffixes.hasOwnProperty(o)&&(this._images[n][o].src||(this._images[n][o].src=i.getFileURL("texture",this._getPath(n,o))));this._loadedImages===this._imagesToLoad&&this._onFilesLoad(!0,{path:this._basepath})},l.prototype._loadData=function(t){return!t.error},l.prototype.getQualities=function(){return Object.keys(this._qualitySuffixes)},l.prototype.getManagedTexture=function(t,e){return!1===this._readyToUse?(i.showError("Cannot get managed GL texture for '"+this._name+"', as it has not been loaded from file yet!"),null):(this._images[t]||(i.showError("The requested texture '"+this._name+"' has no type '"+t+"' available!"),t=Object.keys(this._images)[0]),this._managedTextures[t]=this._managedTextures[t]||{},this._managedTextures[t][e]=this._managedTextures[t][e]||new n.ManagedTexture(this._name,this._images[t][e],this._useMipmap),this._managedTextures[t][e])},l.prototype.getManagedTexturesOfTypes=function(e,i){var s,n,o;for(e.sort(),s=0;s<this._cachedManagedTexturesOfTypes.length;s++)if(t.arraysEqual(e,this._cachedManagedTexturesOfTypes[s].types)&&t.arraysEqual(i,this._cachedManagedTexturesOfTypes[s].qualityPreferenceList))return this._cachedManagedTexturesOfTypes[s].textures;for(n={},o=this._getMostFittingQuality(i),s=0;s<e.length;s++)n[e[s]]=this.getManagedTexture(e[s],o);return this._cachedManagedTexturesOfTypes.push({types:e,qualityPreferenceList:i,textures:n}),n},h.prototype=new a,h.prototype.constructor=h,h.prototype._loadConfig=function(t){a.prototype._loadConfig.call(this,t),this._basepath=t.basepath,this._format=t.format,this._imageNames=t.imageNames,this._qualitySuffixes=t.qualitySuffixes,this._loadedImages=0,this._imagesToLoad=0,this._images={},this._cachedManagedCubemaps=[]},h.prototype._getPath=function(t,e){return this._basepath+this._imageNames[t]+this._qualitySuffixes[e]+"."+this._format},h.prototype._getOnLoadImageFunction=function(t,e){var i=this._getPath(t,e);return function(){this._loadedImages++,this._onFilesLoad(this._loadedImages===this._imagesToLoad,{path:i})}.bind(this)},h.prototype._handleError=function(t){i.showError("Could not load cube mapped texture '"+this._name+"': downloading file '"+t+"' failed!"),this._loadedImages++,this._onFilesLoad(this._loadedImages===this._imagesToLoad,{path:t,error:!0})},h.prototype._getMostFittingQuality=function(t){var e,s,n,o=this.getQualities(),r=-1;for(e=0;e<o.length;e++)(s=t.indexOf(o[e]))>=0&&(-1===r||s<r)&&(r=s,n=t[s]);return-1===r?(i.showError("Cubemap '"+this._name+"' is not available in any of the qualities: ["+t.join(", ")+"]!"),null):n},h.prototype._getProcessedParams=function(t){return t=t||{},t.qualities=t.qualities||t.qualityPreferenceList&&[this._getMostFittingQuality(t.qualityPreferenceList)]||Object.keys(this._qualitySuffixes),delete t.qualityPreferenceList,t},h.prototype.requiresReload=function(t){var e,i;if(t=this._getProcessedParams(t),this.isRequested(t))return!1;for(e in this._imageNames)if(this._imageNames.hasOwnProperty(e)){if(!this._images[e])return!0;for(i=0;i<t.qualities.length;i++)if(this._qualitySuffixes.hasOwnProperty(t.qualities[i])&&!this._images[e][t.qualities[i]])return!0}return!1},h.prototype._requestFiles=function(t){var e,s,n,o;t=this._getProcessedParams(t);for(e in this._imageNames)if(this._imageNames.hasOwnProperty(e))for(this._images[e]=this._images[e]||{},s=0;s<t.qualities.length;s++)n=t.qualities[s],this._qualitySuffixes.hasOwnProperty(n)&&(this._images[e][n]||(o=this._getPath(e,n),N[o]?this._images[e][n]=N[o]:(N[o]=new Image,this._imagesToLoad++,this._images[e][n]=N[o],this._images[e][n].onload=this._getOnLoadImageFunction(e,n).bind(this),this._images[e][n].onerror=this._handleError.bind(this,o))));for(e in this._imageNames)if(this._imageNames.hasOwnProperty(e))for(s=0;s<t.qualities.length;s++)n=t.qualities[s],this._qualitySuffixes.hasOwnProperty(n)&&(this._images[e][n].src||(this._images[e][n].src=i.getFileURL("texture",this._getPath(e,n))));this._loadedImages===this._imagesToLoad&&this._onFilesLoad(!0,{path:this._basepath})},h.prototype._loadData=function(t){return!t.error},h.prototype.getQualities=function(){return Object.keys(this._qualitySuffixes)},h.prototype.getManagedCubemap=function(e){var s,o,r;if(!1===this._readyToUse)return i.showError("Cannot get managed GL cubemap for '"+this._name+"', as it has not been loaded from file yet!"),null;for(s=0;s<this._cachedManagedCubemaps.length;s++)if(t.arraysEqual(e,this._cachedManagedCubemaps[s].qualityPreferenceList))return this._cachedManagedCubemaps[s].cubemap;return r=this._getMostFittingQuality(e),o=new n.ManagedCubemap(this._name,[this._images.posX[r],this._images.negX[r],this._images.posY[r],this._images.negY[r],this._images.posZ[r],this._images.negZ[r]]),this._cachedManagedCubemaps.push({qualityPreferenceList:e,cubemap:o}),o},u.prototype=new a,u.prototype.constructor=u,u.prototype._loadConfig=function(t){a.prototype._loadConfig.call(this,t),this._variantShaderNames=t.variants||null,this._vertexShaderSourcePath=t.vertexShaderSource,this._fragmentShaderSourcePath=t.fragmentShaderSource,this._blendMode=e.getEnumValue(n.ShaderBlendMode,t.blendMode,{name:"shader.blendMode"}),this._vertexAttributeRoles=t.vertexAttributeRoles,this._instanceAttributeRoles=t.instanceAttributeRoles||{},this._vertexShaderSource=null,this._fragmentShaderSource=null,this._managedShaderBindings=[],this._shaderIncludesToLoad=0,this._shaderIncludesLoaded=0},u.prototype._checkAllSourcesLoaded=function(){this._vertexShaderSource&&this._fragmentShaderSource&&this._shaderIncludesLoaded===this._shaderIncludesToLoad&&("-"===this._vertexShaderSource&&(this._vertexShaderSource=null),"-"===this._fragmentShaderSource&&(this._fragmentShaderSource=null),this.onFinalLoad())},u.prototype._loadIncludeSource=function(t,e,i){var s;for(M[e].source=i,this._resolveInclude(t,e),s=0;s<M[e].onLoad.length;s++)M[e].onLoad[s]()},u.prototype._getIncludeFileName=function(t){return t.substr('#include "'.length,t.length-('#include "'.length+'"'.length))},u.prototype._resolveInclude=function(t,e){var i,s,n=M[e].source;switch(t){case f.VERTEX:s=this._vertexShaderSource.split("\n");break;case f.FRAGMENT:s=this._fragmentShaderSource.split("\n")}for(i=0;i<s.length;i++)if('#include "'===s[i].substr(0,'#include "'.length)&&e===this._getIncludeFileName(s[i])){switch(s[i]=n,t){case f.VERTEX:this._vertexShaderSource=s.join("\n");break;case f.FRAGMENT:this._fragmentShaderSource=s.join("\n")}this._resolveSource(t,n);break}this._shaderIncludesLoaded++,this._checkAllSourcesLoaded()},u.prototype._resolveSource=function(t,e){var s,n=e.split("\n"),o=[];for(s=0;s<n.length;s++)'#include "'===n[s].substr(0,'#include "'.length)&&(o.push(this._getIncludeFileName(n[s])),this._shaderIncludesToLoad++);for(s=0;s<o.length;s++)M[o[s]]?M[o[s]].source?this._resolveInclude(t,o[s]):M[o[s]].onLoad.push(this._resolveInclude.bind(this,t,o[s])):(M[o[s]]={onLoad:[]},i.requestTextFile("shader",o[s],this._loadIncludeSource.bind(this,t,o[s])))},u.prototype.requiresReload=function(){return!this.isRequested()&&!this.isLoaded()},u.prototype._requestFiles=function(){i.requestTextFile("shader",this._vertexShaderSourcePath,function(t){this._onFilesLoad(!1,{shaderType:f.VERTEX,text:t})}.bind(this)),i.requestTextFile("shader",this._fragmentShaderSourcePath,function(t){this._onFilesLoad(!1,{shaderType:f.FRAGMENT,text:t})}.bind(this))},u.prototype._loadData=function(t){switch(e.getEnumValue(f,t.shaderType,{name:"shaderType",defaultValue:null})){case f.VERTEX:this._vertexShaderSource=t.text||"-";break;case f.FRAGMENT:this._fragmentShaderSource=t.text||"-"}return t.text&&this._resolveSource(t.shaderType,t.text),this._checkAllSourcesLoaded(),!!t.text},u.prototype.getVariantShaderName=function(t){return this._variantShaderNames?this._variantShaderNames[t]:null},u.prototype.getManagedShader=function(e,s){var o;if(!1===this._readyToUse)return i.showError("Cannot get managed GL shader for '"+this._name+"', as it has not been loaded from file yet!"),null;for(e=e||null,o=0;o<this._managedShaderBindings.length;o++)if(t.objectsEqual(this._managedShaderBindings[o].replacedDefines,e))return this._managedShaderBindings[o].managedShader;return this._managedShaderBindings.push({managedShader:new n.ManagedShader(this._name,this._vertexShaderSource,this._fragmentShaderSource,this._blendMode,this._vertexAttributeRoles,this._instanceAttributeRoles,e,s),replacedDefines:e}),this._managedShaderBindings[this._managedShaderBindings.length-1].managedShader},u.prototype.getVertexShaderSource=function(){return this._vertexShaderSource},u.prototype.getFragmentShaderSource=function(){return this._fragmentShaderSource},c.prototype=new a,c.prototype.constructor=c,c.prototype._loadConfig=function(t){if(a.prototype._loadConfig.call(this,t),t.model)return this._model=t.model,this._files=[],this._dataJSON=null,void this.setToReady();this._basepath=t.basepath,this._format=t.format,this._files=t.files,this._loadedFiles=0,this._filesToLoad=0,this._model=null,this._maxLoadedLOD=-1},c.prototype._getPath=function(t){var e;for(e=0;e<this._files.length;e++)if(this._files[e].maxLOD===t)return this._basepath+this._files[e].suffix+"."+this._format;return null},c.prototype.requiresReload=function(t){return!this.isRequested(t)&&(0!==this._files.length&&(t&&"number"==typeof t.maxLOD?t.maxLOD>this._maxLoadedLOD:null!==this.getMaxLOD()&&this.requiresReload({maxLOD:this.getMaxLOD()})))},c.prototype.getMaxLOD=function(){var t,e=null;for(t=0;t<this._files.length;t++)(null===e||this._files[t].maxLOD>e)&&(e=this._files[t].maxLOD);return e},c.prototype._requestFile=function(t){this._filesToLoad++,i.requestTextFile("model",this._getPath(t),function(e){this._loadedFiles++,this._onFilesLoad(this._filesToLoad===this._loadedFiles,{maxLOD:t,text:e})}.bind(this))},c.prototype._requestFiles=function(t){var e,s;if(t=t||{},void 0!==t.maxLOD){for(e=t.maxLOD;e>=0;e--)if(null!==this._getPath(e))return void this._requestFile(e);if(e<0&&this._files.length>0)for(s=this.getMaxLOD(),e=t.maxLOD+1;e<=s;e++)if(null!==this._getPath(e))return void this._requestFile(e);i.showError("Could not find any files to load for model: '"+this._name+"'!")}else this._requestFiles({maxLOD:this.getMaxLOD()})},c.prototype._loadData=function(t){return this._model=new o.Model,t.text?("{"===t.text[0]?this._model.loadFromJSON(this._getPath(t.maxLOD),JSON.parse(t.text),t.maxLOD):i.showError("Cannot load Egom Model from file '"+this._getPath(t.maxLOD)+"' - the file needs to start with '{'!"),this._maxLoadedLOD=t.maxLOD,!0):(i.showError("Model file of max LOD level "+t.maxLOD+" could not be loaded for model '"+this._name+"'!"),!1)},c.prototype.getEgomModel=function(){return!1===this._readyToUse?(i.showError("Cannot get model object for '"+this._name+"', as it has not been loaded from file yet!"),null):this._model},_.prototype=new a,_.prototype.constructor=_,_.prototype._loadConfig=function(t){a.prototype._loadConfig.call(this,t),this._samples=t.samples,this._loadedSamples=0,this._samplesToLoad=0},_.prototype.requiresReload=function(){return!this._readyToUse&&!this.isRequested()},_.prototype._requestFile=function(t){this._samplesToLoad++,i.requestFile("soundEffect",this._samples[t],function(e){e?r.loadSample(this._samples[t],e,function(){this._loadedSamples++,this._onFilesLoad(this._samplesToLoad===this._loadedSamples,{path:this._samples[t]})}.bind(this)):(i.showError("Could not load sound sample '"+this._name+"'!"),this._samples[t]=null,this._loadedSamples++,this._onFilesLoad(this._samplesToLoad===this._loadedSamples,{path:this._samples[t],error:!0}))}.bind(this),void 0,"arraybuffer")},_.prototype._requestFiles=function(){var t;for(t=0;t<this._samples.length;t++)this._requestFile(t)},_.prototype._loadData=function(t){return!t.error},_.prototype.play=function(t,e,s){var n;if(!1===this._readyToUse)return void i.showError("Cannot play sound effect '"+this._name+"', as it has not been loaded from file yet!");(n=this._samples[Math.floor(Math.random()*this._samples.length)])&&r.playSound(n,t,e,s)},_.prototype.createSoundClip=function(t,e,s,n,o,a,l){var h;return!1===this._readyToUse?(i.showError("Cannot create sound source for sound effect '"+this._name+"', as it has not been loaded from file yet!"),null):(h=this._samples[Math.floor(Math.random()*this._samples.length)],h?new r.SoundClip(t,h,e,s,n,o,a,l):null)},d.prototype=new a,d.prototype.constructor=d,d.prototype._loadConfig=function(t){a.prototype._loadConfig.call(this,t),this._sample=t.sample},d.prototype.requiresReload=function(){return!this._readyToUse&&!this.isRequested()},d.prototype._requestFiles=function(){i.requestFile("music",this._sample,function(t){t?r.loadSample(this._sample,t,function(){this._onFilesLoad(!0,{path:this._sample})}.bind(this)):(i.showError("Could not load music track '"+this._name+"'!"),this._sample=null,this._onFilesLoad(!0,{path:this._sample,error:!0}))}.bind(this),void 0,"arraybuffer")},d.prototype._loadData=function(t){return!t.error},d.prototype.createSoundClip=function(t,e){return!1===this._readyToUse?(i.showError("Cannot create sound source for music '"+this._name+"', as it has not been loaded from file yet!"),null):this._sample?new r.SoundClip(r.SoundCategory.MUSIC,this._sample,t,e):null},p.prototype=new s.ResourceManager,p.prototype.constructor=p,p.prototype.getTexture=function(t,e){return this.getResource(S,t,e)},p.prototype.getCubemap=function(t,e){return this.getResource(T,t,e)},p.prototype.getShader=function(t){return this.getResource(E,t)},p.prototype.getVariantShader=function(t,e){return this.getResource(E,this.getResource(E,t,{doNotLoad:!0}).getVariantShaderName(e),{allowNullResult:!0})||this.getShader(t)},p.prototype.getModel=function(t,e){return this.getResource(y,t,e)},p.prototype.getOrAddModel=function(t){var e=this.getResource(y,t._name,{allowNullResult:!0});return e||(e=this.addResource(y,new c({name:t._name,model:t}),!0)),e},p.prototype.getSoundEffect=function(t){return this.getResource(I,t)},p.prototype.getMusic=function(t){return this.getResource(A,t)},m=new p,{SoundCategory:r.SoundCategory,requestConfigLoad:g,requestResourceLoad:m.requestResourceLoad.bind(m),getTexture:m.getTexture.bind(m),getCubemap:m.getCubemap.bind(m),getShader:m.getShader.bind(m),getVariantShader:m.getVariantShader.bind(m),getModel:m.getModel.bind(m),getOrAddModel:m.getOrAddModel.bind(m),getSoundEffect:m.getSoundEffect.bind(m),getMusic:m.getMusic.bind(m),getResourceTypes:m.getResourceTypes.bind(m),getResourceNames:m.getResourceNames.bind(m),getResource:m.getResource.bind(m),addResource:m.addResource.bind(m),createResource:m.createResource.bind(m),executeWhenReady:m.executeWhenReady.bind(m),executeOnResourceLoad:m.executeOnResourceLoad.bind(m),executeForAllResources:m.executeForAllResources.bind(m),renameResource:m.renameResource.bind(m),moveResourceAfter:m.moveResourceAfter.bind(m)}}),define("modules/containers",[],function(){"use strict";function t(){this._first=null,this._last=null,this._length=0}return t.prototype.add=function(t){this._first?(this._last.next=t,t.previous=this._last):(this._first=t,t.previous=null),t.next=null,t.list=this,this._last=t,this._length++},t.prototype.remove=function(t){t.list===this&&(t.previous?t.previous.next=t.next:this._first=t.next,t.next?t.next.previous=t.previous:this._last=t.previous,t.list=null,this._length--)},t.prototype.clear=function(t){var e;if(t)for(e=this._first;e;e=e.next)e.list=null;this._first=null,this._last=null,this._length=0},t.prototype.getFirst=function(){return this._first},t.prototype.getLast=function(){return this._last},t.prototype.getNext=function(t){return t&&t.list===this?t.next||this._first:this._first},t.prototype.getPrevious=function(t){return t&&t.list===this?t.previous||this._last:this._last},t.prototype.appendToArray=function(t){var e,i;for(i=t.length,t.length=i+this._length,e=this._first;e;e=e.next,i++)t[i]=e},{DirectDoubleLinkedList:t}}),define("modules/scene/object-3d",["utils/vectors","utils/matrices"],function(t,e){"use strict";function i(t,i,s,n,o,r){this._parent=null,this.pM=t||e.identity4(),this.oM=i||e.identity4(),this.sM=s||e.identity4(),this.csM=e.identity4(),this.csMValid=!1,this.mM=e.identity4(),this.mMValid=!1,this._cascadedModelMatrix=e.identity4(),this.mMForFrame=this.mM,this.mMForFrameValid=!1,this.mMI=e.identity4(),this.mMIV=!1,this._cascadedModelMatrixInverse=e.identity4(),this.mMIForFrame=this.mMI,this.mMIForFrameValid=!1,this._size=void 0!==n?n:1,this._insideParent=null,this._childrenAlwaysInside=o||!1,this._lastSizeInsideViewFrustum={width:-1,height:-1},this.pMC=e.identity4(),this.pMCV=!1,this._ignoreTransform=r||!1}var s,n;return s=function(){function i(t,i,s,n,o,r){this._parent=null,e.copyTranslation4(this.pM,t||e.IDENTITY4),e.setMatrix4(this.oM,i||e.IDENTITY4),e.copyScaling4(this.sM,s||e.IDENTITY4),this.mMForFrame=this.mM,this.mMIForFrame=this.mMI,this.csMValid=!1,this.mMValid=!1,this.mMForFrameValid=!1,this.mMIV=!1,this.mMIForFrameValid=!1,this._size=void 0!==n?n:1,this._insideParent=null,this._childrenAlwaysInside=o||!1,this._ignoreTransform=r||!1,this._lastSizeInsideViewFrustum={width:-1,height:-1},this.pMCV=!1}function s(){this.pMCV=!1,this.mMForFrameValid=!1,this.mMIForFrameValid=!1}function n(t){this._parent=t,
this.mMForFrame=t&&!t._ignoreTransform?this._cascadedModelMatrix:this.mM,this.mMIForFrame=t&&!t._ignoreTransform?this._cascadedModelMatrixInverse:this.mMI}function o(t){this.pM=t,this.mM[12]=this.pM[12],this.mM[13]=this.pM[13],this.mM[14]=this.pM[14],this.mMIV=!1,this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this.pMCV=!1}function r(){return[this.pM[12],this.pM[13],this.pM[14]]}function a(t){t[0]=this.pM[12],t[1]=this.pM[13],t[2]=this.pM[14]}function l(t){t[0]+=this.pM[12],t[1]+=this.pM[13],t[2]+=this.pM[14]}function h(t){this.pM[12]=t[0],this.pM[13]=t[1],this.pM[14]=t[2],this.mM[12]=t[0],this.mM[13]=t[1],this.mM[14]=t[2],this.mMIV=!1,this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this.pMCV=!1}function u(t){this.pM[12]=t[12],this.pM[13]=t[13],this.pM[14]=t[14],this.mM[12]=t[12],this.mM[13]=t[13],this.mM[14]=t[14],this.mMIV=!1,this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this.pMCV=!1}function c(t,e,i){this.pM[12]+=t,this.pM[13]+=e,this.pM[14]+=i,this.mM[12]+=t,this.mM[13]+=e,this.mM[14]+=i,this.mMIV=!1,this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this.pMCV=!1}function _(t){this.pM[12]+=t[0],this.pM[13]+=t[1],this.pM[14]+=t[2],this.mM[12]+=t[0],this.mM[13]+=t[1],this.mM[14]+=t[2],this.mMIV=!1,this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this.pMCV=!1}function d(t){this.pM[12]+=t[12],this.pM[13]+=t[13],this.pM[14]+=t[14],this.mM[12]+=t[12],this.mM[13]+=t[13],this.mM[14]+=t[14],this.mMIV=!1,this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this.pMCV=!1}function p(t,e){var i=e*t[12]+(1-e)*this.pM[12]-this.pM[12];this.pM[12]+=i,this.mM[12]+=i,i=e*t[13]+(1-e)*this.pM[13]-this.pM[13],this.pM[13]+=i,this.mM[13]+=i,i=e*t[14]+(1-e)*this.pM[14]-this.pM[14],this.pM[14]+=i,this.mM[14]+=i,this.mMIV=!1,this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this.pMCV=!1}function g(t){t&&(this.oM=t),this.mMValid=!1,this.mMIV=!1,this._handleOrientationChanged&&this._handleOrientationChanged()}function m(t){e.setMatrix4(this.oM,t),this.mMValid=!1,this.mMIV=!1,this._handleOrientationChanged&&this._handleOrientationChanged()}function f(){return[this.oM[0],this.oM[1],this.oM[2]]}function S(){return[this.oM[4],this.oM[5],this.oM[6]]}function T(){return[this.oM[8],this.oM[9],this.oM[10]]}function E(t,i){0!==i&&(e.rotate4(this.oM,t,i),this.setOrientationMatrix())}function y(t){e.mulRotationRotation4(this.oM,t),this.setOrientationMatrix()}function I(t){e.mulRotation43(this.oM,t),this.setOrientationMatrix()}function A(t){t&&(this.sM=t),this.mMValid=!1,this.mMIV=!1,this.csMValid=!1}function M(t){this.sM[0]=t,this.sM[5]=t,this.sM[10]=t,this.setScalingMatrix()}function C(){return this.csMValid||(this._parent&&!this._parent._ignoreTransform?e.setScalingToProdScalingScaling4(this.csM,this._parent.getCascadeScalingMatrix(),this.sM):e.copyScaling4(this.csM,this.sM),this.csMValid=!0),this.csM}function N(){return this.mMForFrameValid||(this.mMValid||(e.setModelMatrix(this.mM,this.pM,this.oM,this.sM),this.mMValid=!0),this._parent&&!this._parent._ignoreTransform&&e.setProd4NoProj(this._cascadedModelMatrix,this.mM,this._parent.getModelMatrix()),this.mMForFrameValid=!0),this.mMForFrame}function O(){return this.mMIForFrameValid||(this.mMIV||(e.setInverse4(this.mMI,this.getModelMatrix()),this.mMIV=!0),this._parent&&!this._parent._ignoreTransform&&e.setProd4NoProj(this._cascadedModelMatrixInverse,this._parent.getModelMatrixInverse(),this.mMI),this.mMIForFrameValid=!0),this.mMIForFrame}function R(){return this._size}function L(t){this._size=t}function x(){return this.getSize()*this.getCascadeScalingMatrix()[0]}function v(){return null===this._insideParent&&(this._insideParent=!!this._parent&&(this._parent._childrenAlwaysInside||Math.abs(this.pM[12])<this._parent.getSize()&&Math.abs(this.pM[13])<this._parent.getSize()&&Math.abs(this.pM[14])<this._parent.getSize())),this._insideParent}function b(i){return this.pMCV||(e.updateTranslation4v(this.pMC,t.prodTranslationModel3Aux(this.getModelMatrix(),i.getViewMatrix())),this.pMCV=!0),this.pMC}function D(t,e){var i,s,n,o,r,a,l,h,u;if(n=this.getPositionMatrixInCameraSpace(t),0!==n[14]){if(s=this.getCascadeScalingMatrix(),e&&(i=this.getSize()*s[0],n[14]-i>=-t.getNearDistance()||n[14]+i<-t.getViewDistance()))return this._lastSizeInsideViewFrustum.width=0,this._lastSizeInsideViewFrustum.height=0,this._lastSizeInsideViewFrustum;if(o=t.getProjectionMatrix(),i=this.getSize(),u=-1/n[14],r=n[12]*o[0]*u,a=n[13]*o[5]*u,l=Math.abs(s[0]*o[0]*i*u),h=Math.abs(s[5]*o[5]*i*u),!(r+l<-1||r-l>1||a+h<-1||a-h>1))return this._lastSizeInsideViewFrustum.width=l,this._lastSizeInsideViewFrustum.height=h,this._lastSizeInsideViewFrustum}return this._lastSizeInsideViewFrustum.width=0,this._lastSizeInsideViewFrustum.height=0,this._lastSizeInsideViewFrustum}function w(t){return t.isInsideCurrentMap(this.getModelMatrix(),this.getScaledSize())}return function(){this.prototype.init=i,this.prototype.resetCachedValues=s,this.prototype.setParent=n,this.prototype.setPositionMatrix=o,this.prototype.setPositionv=h,this.prototype.setPositionM4=u,this.prototype.setOrientationMatrix=g,this.prototype.setOrientationM4=m,this.prototype.setScalingMatrix=A,this.prototype.setScale=M,this.prototype.getPositionVector=r,this.prototype.copyPositionToVector=a,this.prototype.addPositionToVector=l,this.prototype.translate=c,this.prototype.translatev=_,this.prototype.translateByMatrix=d,this.prototype.translateTowardsM4=p,this.prototype.getXDirectionVector=f,this.prototype.getYDirectionVector=S,this.prototype.getZDirectionVector=T,this.prototype.rotate=E,this.prototype.rotateByMatrix=y,this.prototype.rotateByMatrix3=I,this.prototype.getCascadeScalingMatrix=C,this.prototype.getModelMatrix=N,this.prototype.getModelMatrixInverse=O,this.prototype.getSize=R,this.prototype.setSize=L,this.prototype.getScaledSize=x,this.prototype.isInsideParent=v,this.prototype.getPositionMatrixInCameraSpace=b,this.prototype.getSizeInsideViewFrustum=D,this.prototype.isInsideShadowRegion=w}},n=s(),n.call(i),{Object3D:i,makeObject3DMixinClass:n}}),define("modules/scene/camera",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/scene/object-3d"],function(t,e,i,s,n){"use strict";function o(t,e,s,n,o,r,a,l,h,u){this._fixed=t,this._turnsAroundObjects=e,this._movesRelativeToObject=s,this._followedObjects=n||[],this._startsWithRelativePosition=o,this._defaultRelativePositionMatrix=i.matrix4(r),this._relativePositionMatrix=r,this._worldPositionMatrix=i.identity4(),this._worldPositionMatrixValid=!1,this._distanceIsConfined=!!a,this._minimumDistance=a?a[0]:0,this._maximumDistance=a?a[1]:0,this._xIsConfined=!(!l||!l[0]),this._minimumX=l&&l[0]?l[0][0]:0,this._maximumX=l&&l[0]?l[0][1]:0,this._yIsConfined=!(!l||!l[1]),this._minimumY=l&&l[1]?l[1][0]:0,this._maximumY=l&&l[1]?l[1][1]:0,this._zIsConfined=!(!l||!l[2]),this._minimumZ=l&&l[2]?l[2][0]:0,this._maximumZ=l&&l[2]?l[2][1]:0,this._resetsWhenLeavingConfines=h,this._isTransitionConfiguration=u,this._isStarting=!0,this._camera=null}function r(t,e,s,n,o,r,a,l,h,p,g,m){this._fixed=t,this._pointsTowardsObjects=e,this._fps=s,this._followedObjects=n||[],this._defaultRelativeOrientationMatrix=i.matrix4(o),this._relativeOrientationMatrix=o,this._worldOrientationMatrix=i.identity4(),this._worldOrientationMatrixValid=!1,this._defaultAlpha=r||0,this._alpha=r||0,this._defaultBeta=a||0,this._beta=a||0,this._minAlpha=l&&void 0!==l[0]?l[0]:u,this._maxAlpha=l&&void 0!==l[1]?l[1]:c,this._minBeta=h&&void 0!==h[0]?h[0]:_,this._maxBeta=h&&void 0!==h[1]?h[1]:d,this._baseOrientation=p,this._pointToFallback=g,this._isTransitionConfiguration=m,this._camera=null}function a(t,e,i,s,o,r,a,l){n.Object3D.call(this,e.pM,i.oM),this._name=t,this._positionConfiguration=e,this._orientationConfiguration=i,this._defaultFOV=s,this._fov=s,this._minFOV=o?o[0]:s,this._maxFOV=o?o[1]:s,this._span=r,this._resetsOnFocusChange=a,this._excludeFromCycle=l,this._camera=null}function l(e,s,n,l,h,u,c){var _=i.getYawAndPitch(n);return new a(t.EMPTY_STRING,new o(!1,!1,!1,[],!1,i.matrix4(s),null,null,!1),new r(!1,!1,e,[],i.matrix4(n),Math.degrees(_.yaw),Math.degrees(_.pitch),void 0,void 0,r.BaseOrientation.WORLD,r.PointToFallback.POSITION_FOLLOWED_OBJECT_OR_WORLD),l,[h,u],c)}function h(t,e,s,o,r,a,l){this._object3D=new n.Object3D(i.identity4(),i.identity4(),i.identity4()),this._scene=t,this._aspect=e,this._usesVerticalValues=s,this._viewDistance=o,this._previousConfiguration=null,this._currentConfiguration=r,this._currentConfiguration.setCamera(this),this._transitionStyle=h.TransitionStyle.NONE,this._defaultTransitionStyle=l||h.TransitionStyle.NONE,this._transitionDuration=0,this._defaultTransitionDuration=a||0,this._transitionElapsedTime=0,this._velocityVector=[0,0,0],this._controlledVelocityVector=[0,0,0],this._angularVelocityVector=[0,0,0],this._previousFollowedPositionVector=null,this._projectionMatrix=i.identity4(),this._projectionMatrixValid=!1,this._followedNode=null,this._viewMatrix=i.identity4(),this._viewMatrixValid=!1,this._inversePositionMatrix=i.identity4(),this._inversePositionMatrixValid=!1,this._inverseOrientationMatrix=i.identity4(),this._inverseOrientationMatrixValid=!1,this._fov=0,this._span=0,this._near=0,this._extendedCamera=null,this._extendedCameraValid=!1,this._combinedExtendedCamera=null,this._combinedExtendedCameraValid=!1,this._posMatrix=i.identity4(),this._oriMatrix=i.identity4(),this._interocularHalfDistance=p,this._stereoscopicConvergenceDistance=g,this._stereoAngle=0,this._stereoscopy=h.Stereoscopy.NONE,this._leftEye=!1,this._rightEye=!1,this._updateFOV(),this._updateSpan(),this._updateStereoAngle()}var u=-360,c=360,_=-90,d=90,p=.0635/1.5,g=20;return o.prototype.init=function(t,e,s,n,o,r,a,l,h,u){this._fixed=t,this._turnsAroundObjects=e,this._movesRelativeToObject=s,this._followedObjects=n||[],this._startsWithRelativePosition=o,i.setMatrix4(this._defaultRelativePositionMatrix,r),i.setMatrix4(this._relativePositionMatrix,r),i.setIdentity4(this._worldPositionMatrix),this._worldPositionMatrixValid=!1,this._distanceIsConfined=!!a,this._minimumDistance=a?a[0]:0,this._maximumDistance=a?a[1]:0,this._xIsConfined=!(!l||!l[0]),this._minimumX=l&&l[0]?l[0][0]:0,this._maximumX=l&&l[0]?l[0][1]:0,this._yIsConfined=!(!l||!l[1]),this._minimumY=l&&l[1]?l[1][0]:0,this._maximumY=l&&l[1]?l[1][1]:0,this._zIsConfined=!(!l||!l[2]),this._minimumZ=l&&l[2]?l[2][0]:0,this._maximumZ=l&&l[2]?l[2][1]:0,this._resetsWhenLeavingConfines=h,this._isTransitionConfiguration=u,this._isStarting=!0,this._camera=null},o.prototype.copy=function(t){var e=new o(this._fixed,this._turnsAroundObjects,this._movesRelativeToObject,this._followedObjects.slice(),this._startsWithRelativePosition,i.matrix4(this._defaultRelativePositionMatrix),this._distanceIsConfined?[this._minimumDistance,this._maximumDistance]:null,[this._xIsConfined?[this._minimumX,this._maximumX]:null,this._yIsConfined?[this._minimumY,this._maximumY]:null,this._zIsConfined?[this._minimumZ,this._maximumZ]:null],this._resetsWhenLeavingConfines,t);return e._relativePositionMatrix=i.matrix4(this._relativePositionMatrix),e._worldPositionMatrix=i.matrix4(this._worldPositionMatrix),e._isStarting=this._isStarting,e},o.prototype.setCamera=function(t,e){t&&this._camera!==t&&this._startsWithRelativePosition&&!e&&this.resetToDefaults(!0),this._camera=t},o.prototype.resetToDefaults=function(t){this._camera&&!t&&this._camera.positionConfigurationWillChange(),i.setMatrix4(this._relativePositionMatrix,this._defaultRelativePositionMatrix),this._worldPositionMatrixValid=!1,this._isStarting=!0},o.prototype.setRelativePositionMatrix=function(t,e){this._camera&&!e&&this._camera.positionConfigurationWillChange(),this._relativePositionMatrix=t},o.prototype.moveByVector=function(t,e){this._camera&&!e&&this._camera.positionConfigurationWillChange(),i.translateByVector(this._relativePositionMatrix,t)},o.prototype.followsObjects=function(e){return e?t.arraysEqual(this._followedObjects.sort(),e.sort()):this._followedObjects.length>0&&!this._startsWithRelativePosition},o.prototype.getFollowedPositionVector=function(){var t,e=[0,0,0];if(0===this._followedObjects.length);else{for(t=0;t<this._followedObjects.length;t++)this._followedObjects[t].addPositionToVector(e);e=[e[0]/this._followedObjects.length,e[1]/this._followedObjects.length,e[2]/this._followedObjects.length]}return e},o.prototype.getFollowedPositionMatrix=function(){var t,e=i.identity4Aux();if(0===this._followedObjects.length);else{for(t=0;t<this._followedObjects.length;t++)i.translateByMatrix(e,this._followedObjects[t].pM);e=i.translation4Aux(e[12]/this._followedObjects.length,e[13]/this._followedObjects.length,e[14]/this._followedObjects.length)}return e},o.prototype.getFollowedObjectOrientationMatrix=function(){return 0===this._followedObjects.length?null:this._followedObjects[0].oM},o.prototype._cleanupFollowedObjects=function(){var t,e,s;for(t=0;t<this._followedObjects.length;t++){for(e=t,s=0;e<this._followedObjects.length&&(!this._followedObjects[e]||!0===this._followedObjects[e].canBeReused());)e++,s++;s>0&&(this._followedObjects.splice(t,s),0===this._followedObjects.length&&i.setMatrix4(this._relativePositionMatrix,this._worldPositionMatrixValid&&this._worldPositionMatrix||this._relativePositionMatrix||this._defaultRelativePositionMatrix))}},o.prototype._calculateWorldPositionMatrix=function(t){this._followedObjects.length>0&&(!this._startsWithRelativePosition||this._isStarting)?(this._isStarting=!1,this._turnsAroundObjects?t&&i.setTranslatedByM4(this._worldPositionMatrix,i.translation4m4Aux(i.prodTranslationRotation4Aux(this._relativePositionMatrix,i.prod3x3SubOf4Aux(i.ROTATION_X_90,t))),this.getFollowedPositionMatrix()):i.setTranslatedByM4(this._worldPositionMatrix,i.translation4m4Aux(i.prodTranslationRotation4Aux(this._relativePositionMatrix,this.getFollowedObjectOrientationMatrix())),this.getFollowedPositionMatrix()),this._startsWithRelativePosition&&i.setMatrix4(this._relativePositionMatrix,this._worldPositionMatrix)):i.setMatrix4(this._worldPositionMatrix,this._relativePositionMatrix),this._worldPositionMatrixValid=!0},o.prototype.getWorldPositionMatrix=function(t){return this._worldPositionMatrixValid||this._calculateWorldPositionMatrix(t),this._worldPositionMatrix},o.prototype._checkConfines=function(t){var s,n,o;if(o=this._startsWithRelativePosition&&!this._isStarting&&this._followedObjects.length>0?i.translation4m4Aux(i.prodTranslationRotation4Aux(i.translatedByM4Aux(this._relativePositionMatrix,i.inverseOfTranslation4Aux(this.getFollowedPositionMatrix())),i.inverseOfRotation4Aux(this.getFollowedObjectOrientationMatrix()))):this._relativePositionMatrix,this._distanceIsConfined)if(this._followedObjects.length>0){if(s=i.translationVector3(o),(n=e.extractLength3(s))<this._minimumDistance||n>this._maximumDistance){if(n>this._maximumDistance&&this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;n=Math.min(Math.max(n,this._minimumDistance),this._maximumDistance),o=i.translation4vAux(e.scale3(s,n))}}else if(t&&(s=e.diff3Aux(i.translationVector3(o),t),(n=e.extractLength3(s))<this._minimumDistance||n>this._maximumDistance)){if(n>this._maximumDistance&&this._resetsWhenLeavingConfines)return!1;n=Math.min(Math.max(n,this._minimumDistance),this._maximumDistance),o=i.translation4vAux(e.sum3(t,e.scale3(s,n)))}if(this._xIsConfined&&(o[12]<this._minimumX||o[12]>this._maximumX)){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;o[12]=Math.min(Math.max(o[12],this._minimumX),this._maximumX)}if(this._yIsConfined&&(o[13]<this._minimumY||o[13]>this._maximumY)){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;o[13]=Math.min(Math.max(o[13],this._minimumY),this._maximumY)}if(this._zIsConfined&&(o[14]<this._minimumZ||o[14]>this._maximumZ)){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;o[14]=Math.min(Math.max(o[14],this._minimumZ),this._maximumZ)}return this._startsWithRelativePosition&&!this._isStarting&&this._followedObjects.length>0?i.setTranslatedByM4(this._relativePositionMatrix,i.translation4m4Aux(i.prodTranslationRotation4Aux(o,this.getFollowedObjectOrientationMatrix())),this.getFollowedPositionMatrix()):i.setMatrix4(this._relativePositionMatrix,o),!0},o.prototype.update=function(t,s,n,o){var r,a;if(!this._fixed)if(0===this._followedObjects.length||this._startsWithRelativePosition)i.translateByVector(this._relativePositionMatrix,e.scale3(e.prodVec3Mat4Aux(n,t),o/1e3));else if(this._turnsAroundObjects){if(this._distanceIsConfined){if(r=i.translationVector3(this._relativePositionMatrix),(a=e.extractLength3(r)+n[2]*o/1e3)<this._minimumDistance||a>this._maximumDistance){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;n[2]=0,a=Math.min(Math.max(a,this._minimumDistance),this._maximumDistance)}i.setTranslation4v(this._relativePositionMatrix,e.scale3(r,a))}}else this._movesRelativeToObject?i.translateByVector(this._relativePositionMatrix,e.scaled3(e.prodVec3Mat4Aux(n,i.ROTATION_X_270),.001*o)):i.translateByVector(this._relativePositionMatrix,e.scaled3(e.prodVec3Mat4Aux(n,i.prod3x3SubOf4Aux(t,i.inverseOfRotation4Aux(this.getFollowedObjectOrientationMatrix()))),.001*o));if(!this._isTransitionConfiguration){if(!this._checkConfines(s))return!1;this._cleanupFollowedObjects()}return this._worldPositionMatrixValid=!1,!0},r.BaseOrientation={WORLD:"world",POSITION_FOLLOWED_OBJECTS:"positionFollowedObjects",ORIENTATION_FOLLOWED_OBJECT:"orientationFollowedObject"},Object.freeze(r.BaseOrientation),r.PointToFallback={WORLD:"world",STATIONARY:"stationary",POSITION_FOLLOWED_OBJECT_OR_WORLD:"positionFollowedObjectOrWorld"},Object.freeze(r.PointToFallback),r.prototype.init=function(t,e,s,n,o,r,a,l,h,p,g,m){this._fixed=t,this._pointsTowardsObjects=e,this._fps=s,this._followedObjects=n||[],i.setMatrix4(this._defaultRelativeOrientationMatrix,o),i.setMatrix4(this._relativeOrientationMatrix,o),i.setIdentity4(this._worldOrientationMatrix),this._worldOrientationMatrixValid=!1,this._defaultAlpha=r||0,this._alpha=r||0,this._defaultBeta=a||0,this._beta=a||0,this._minAlpha=l&&void 0!==l[0]?l[0]:u,this._maxAlpha=l&&void 0!==l[1]?l[1]:c,this._minBeta=h&&void 0!==h[0]?h[0]:_,this._maxBeta=h&&void 0!==h[1]?h[1]:d,this._baseOrientation=p,this._pointToFallback=g,this._isTransitionConfiguration=m,this._camera=null},r.prototype.copy=function(t){var e=new r(this._fixed,this._pointsTowardsObjects,this._fps,this._followedObjects.slice(),i.matrix4(this._defaultRelativeOrientationMatrix),this._alpha,this._beta,[this._minAlpha,this._maxAlpha],[this._minBeta,this._maxBeta],this._baseOrientation,this._pointToFallback,t);return e._relativeOrientationMatrix=i.matrix4(this._relativeOrientationMatrix),e._worldOrientationMatrix=i.matrix4(this._worldOrientationMatrix),e},r.prototype.setCamera=function(t){this._camera=t},r.prototype.resetToDefaults=function(t){this._camera&&!t&&this._camera.orientationConfigurationWillChange(),i.setMatrix4(this._relativeOrientationMatrix,this._defaultRelativeOrientationMatrix),this._alpha=this._defaultAlpha,this._beta=this._defaultBeta,this._worldOrientationMatrixValid=!1},r.prototype.setRelativeOrientationMatrix=function(t,e){this._camera&&!e&&this._camera.orientationConfigurationWillChange(),this._relativeOrientationMatrix=t},r.prototype.isFPS=function(){return this._fps},r.prototype.followsObjects=function(e){return e?t.arraysEqual(this._followedObjects.sort(),e.sort()):this._followedObjects.length>0},r.prototype.setFollowedObjects=function(t,e){0===this._followedObjects.length&&0===t.length||(this._camera&&!e&&this._camera.orientationConfigurationWillChange(),this._followedObjects=t)},r.prototype.setFollowedObject=function(t,e){1===this._followedObjects.length&&this._followedObjects[0]===t||this.setFollowedObjects([t],e)},r.prototype.getFollowedObjectsPositionVector=function(){var t,e=[0,0,0];if(0===this._followedObjects.length);else{for(t=0;t<this._followedObjects.length;t++)this._followedObjects[t].addPositionToVector(e);e=[e[0]/this._followedObjects.length,e[1]/this._followedObjects.length,e[2]/this._followedObjects.length]}return e},r.prototype.getFollowedOrientationMatrix=function(){return 0===this._followedObjects.length?null:this._followedObjects[0].oM},r.prototype._cleanupFollowedObjects=function(){var t,e,s;for(t=0;t<this._followedObjects.length;t++){for(e=t,s=0;e<this._followedObjects.length&&(!this._followedObjects[e]||!0===this._followedObjects[e].canBeReused());)e++,s++;if(s>0){if(this._followedObjects.length===s)return this._camera&&this._camera.orientationConfigurationWillChange(),this._pointsTowardsObjects||(i.setMatrix4(this._relativeOrientationMatrix,this._worldOrientationMatrixValid&&this._worldOrientationMatrix||this._relativeOrientationMatrix||this._defaultRelativeOrientationMatrix),this._fps=!1),this._followedObjects.splice(t,s),!1;this._followedObjects.splice(t,s)}}return!0},r.prototype._calculateWorldOrientationMatrix=function(t,s){var n,o,a,l=function(t){i.setProd3x3SubOf4(this._worldOrientationMatrix,i.prod3x3SubOf4Aux(i.ROTATION_X_270,this._relativeOrientationMatrix),t)}.bind(this),h=function(){this._fps?i.setProd3x3SubOf4(this._worldOrientationMatrix,i.ROTATION_X_270,this._relativeOrientationMatrix):i.setMatrix4(this._worldOrientationMatrix,this._relativeOrientationMatrix)}.bind(this);if(this._followedObjects.length>0)if(this._pointsTowardsObjects)if(t)if(o=e.normalize3(e.diff3(this.getFollowedObjectsPositionVector(),i.translationVector3(t))),this._fps){switch(this._baseOrientation){case r.BaseOrientation.WORLD:n=null;break;case r.BaseOrientation.POSITION_FOLLOWED_OBJECTS:n=s||null;break;case r.BaseOrientation.ORIENTATION_FOLLOWED_OBJECT:n=this.followsObjects()?this.getFollowedOrientationMatrix():null}n?o=e.prodVec3Mat4Aux(o,i.inverseOfRotation4Aux(n)):n=i.IDENTITY4,this._alpha=0!==o[0]||0!==o[1]?e.angle2yCapped(o[0],o[1]):0,o[0]<0&&(this._alpha=-this._alpha),i.setProd3x3SubOf4(this._worldOrientationMatrix,i.ROTATION_X_270,i.rotationZ4Aux(this._alpha)),this._beta=e.angle3uCapped(i.getRowC43Neg(this._worldOrientationMatrix),o),o[2]>0&&(this._beta=-this._beta),i.setProd3x3SubOf4(this._worldOrientationMatrix,i.prod3x3SubOf4Aux(i.ROTATION_X_270,i.rotationX4Aux(this._beta)),i.rotationZ4Aux(this._alpha)),i.mul4(this._worldOrientationMatrix,n)}else this._worldOrientationMatrix[8]=o[0],this._worldOrientationMatrix[9]=o[1],this._worldOrientationMatrix[10]=o[2],this._worldOrientationMatrix[11]=0,a=e.cross3(e.UNIT3_X,o),this._worldOrientationMatrix[4]=a[0],this._worldOrientationMatrix[5]=a[1],this._worldOrientationMatrix[6]=a[2],this._worldOrientationMatrix[7]=0,a=e.cross3(o,a),this._worldOrientationMatrix[0]=a[0],this._worldOrientationMatrix[1]=a[1],this._worldOrientationMatrix[2]=a[2],this._worldOrientationMatrix[3]=0,this._worldOrientationMatrix[12]=0,this._worldOrientationMatrix[13]=0,this._worldOrientationMatrix[14]=0,this._worldOrientationMatrix[15]=1,i.correctOrthogonal4(this._worldOrientationMatrix);else;else l(this.getFollowedOrientationMatrix());else if(this._pointsTowardsObjects)switch(this._pointToFallback){case r.PointToFallback.WORLD:h();break;case r.PointToFallback.STATIONARY:i.setIdentity4(this._worldOrientationMatrix);break;case r.PointToFallback.POSITION_FOLLOWED_OBJECT_OR_WORLD:s?l(s):h()}else h();this._worldOrientationMatrixValid=!0},r.prototype.getWorldOrientationMatrix=function(t,e){return this._worldOrientationMatrixValid||this._calculateWorldOrientationMatrix(t,e),this._worldOrientationMatrix},r.prototype.update=function(s,n){var o;if(!this._pointsTowardsObjects||this.followsObjects()||this._pointToFallback!==r.PointToFallback.STATIONARY)return this._fixed||(this._fps?(this._alpha+=s[1]*n/1e3,this._beta+=s[0]*n/1e3,this._alpha>=360&&(this._alpha-=360),this._alpha<=-360&&(this._alpha+=360),this._beta>=360&&(this._beta-=360),this._beta<=-360&&(this._beta+=360),this._alpha=Math.min(Math.max(this._minAlpha,this._alpha),this._maxAlpha),this._beta=Math.min(Math.max(this._minBeta,this._beta),this._maxBeta),i.setProd3x3SubOf4(this._relativeOrientationMatrix,i.rotationX4Aux(this._beta*t.RAD),i.rotationZ4Aux(this._alpha*t.RAD))):(o=t.RAD*n/1e3,this._followedObjects.length>0?i.mul4(this._relativeOrientationMatrix,i.prod34Aux(i.rotation4Aux(e.normalize3(i.getRowB43(this._relativeOrientationMatrix)),s[2]*o),i.rotation4Aux(e.normalize3(i.getRowA43(this._relativeOrientationMatrix)),s[0]*o),i.rotation4Aux(e.normalize3(i.getRowC43(this._relativeOrientationMatrix)),s[1]*o))):i.mul4(this._relativeOrientationMatrix,i.prod34Aux(i.rotation4Aux(e.normalize3(i.getRowC43(this._relativeOrientationMatrix)),s[2]*o),i.rotation4Aux(e.normalize3(i.getRowA43(this._relativeOrientationMatrix)),s[0]*o),i.rotation4Aux(e.normalize3(i.getRowB43(this._relativeOrientationMatrix)),s[1]*o))))),!(!this._isTransitionConfiguration&&!this._cleanupFollowedObjects())&&(this._worldOrientationMatrixValid=!1,!0)},n.makeObject3DMixinClass.call(a),a.prototype.init=function(t,e,i,s,o,r,a,l){n.Object3D.prototype.init.call(this,e.pM,i.oM),this._name=t,this._positionConfiguration=e,this._orientationConfiguration=i,this._defaultFOV=s,this._fov=s,this._minFOV=o?o[0]:s,this._maxFOV=o?o[1]:s,this._span=r,this._resetsOnFocusChange=a,this._excludeFromCycle=l,this._camera=null},a.prototype.copy=function(e,s){var n=new a(e||t.EMPTY_STRING,this._positionConfiguration.copy(s),this._orientationConfiguration.copy(s),this._fov,[this._minFOV,this._maxFOV],this._span);return n.setPositionMatrix(i.matrix4(this.pM)),n.setOrientationMatrix(i.matrix4(this.oM)),n},a.prototype.setCamera=function(t,e){this._camera=t,this._positionConfiguration.setCamera(t,e),this._orientationConfiguration.setCamera(t),this._camera&&this._resetsOnFocusChange&&!e&&this.resetToDefaults(!0)},a.prototype.setRelativePositionMatrix=function(t,e){this._positionConfiguration.setRelativePositionMatrix(t,e)},a.prototype.moveByVector=function(t,e){this._positionConfiguration.moveByVector(t,e)},a.prototype.setRelativeOrientationMatrix=function(t,e){this._orientationConfiguration.setRelativeOrientationMatrix(t,e)},a.prototype.isFPS=function(){return this._orientationConfiguration.isFPS()},a.prototype.setFOV=function(t,e){this._camera&&!e&&this._camera.configurationWillChange(),this._fov=Math.min(Math.max(t,this._minFOV),this._maxFOV)},a.prototype.getFOV=function(){return this._fov},a.prototype.getMinFOV=function(){return this._minFOV},a.prototype.getMaxFOV=function(){return this._maxFOV},a.prototype.decreaseFOV=function(){return this.setFOV(.95*this._fov,!0),this._fov},a.prototype.increaseFOV=function(){return this.setFOV(1.05*this._fov,!0),this._fov},a.prototype.getSpan=function(){return this._span},a.prototype.resetsOnFocusChange=function(){return this._resetsOnFocusChange},a.prototype.shouldExcludeFromCycle=function(){return this._excludeFromCycle},a.prototype.resetToDefaults=function(t){this._camera&&!t&&this._camera.configurationWillChange(),this.setFOV(this._defaultFOV,!0),this._positionConfiguration.resetToDefaults(!0),this._orientationConfiguration.resetToDefaults(!0)},a.prototype.update=function(t,e,i){var s=!0;return s=this._orientationConfiguration.update(e,i),this.setOrientationMatrix(this._orientationConfiguration.getWorldOrientationMatrix(this.pM,this._positionConfiguration.followsObjects()?this._positionConfiguration.getFollowedObjectOrientationMatrix():null)),s=this._positionConfiguration.update(this.oM,this._orientationConfiguration.followsObjects()?this._orientationConfiguration.getFollowedObjectsPositionVector():null,t,i)&&s,this.setPositionMatrix(this._positionConfiguration.getWorldPositionMatrix(this.oM)),s},a.prototype.positionFollowsObjects=function(){return this._positionConfiguration.followsObjects()},a.prototype.orientationFollowsObjects=function(){return this._orientationConfiguration.followsObjects()},a.prototype.getFollowedPositionVector=function(){return this._positionConfiguration.getFollowedPositionVector()},a.prototype.setOrientationFollowedObjects=function(t,e){this._orientationConfiguration.setFollowedObjects(t,e)},a.prototype.setToFree=function(e,s,n,o,a,l,h){var u=i.getYawAndPitch(n);this._positionConfiguration.init(!1,!1,!1,[],!1,s,null,null,!1),this._orientationConfiguration.init(!1,!1,e,[],n,Math.degrees(u.yaw),Math.degrees(u.pitch),void 0,void 0,r.BaseOrientation.WORLD,r.PointToFallback.POSITION_FOLLOWED_OBJECT_OR_WORLD),this.init(t.EMPTY_STRING,this._positionConfiguration,this._orientationConfiguration,o,[a,l],h)},a.prototype.destroy=function(){this._positionConfiguration=null,this._orientationConfiguration=null,this._camera=null},h.Stereoscopy={NONE:0,LEFT:1,RIGHT:2},h.TransitionStyle={NONE:"none",LINEAR:"linear",SMOOTH:"smooth"},Object.freeze(h.TransitionStyle),h.prototype.init=function(t,e,s,n,o,r,a){this._object3D.init(i.IDENTITY4,i.IDENTITY4,i.IDENTITY4),this._scene=t,this._aspect=e,this._usesVerticalValues=s,this._viewDistance=n,this._previousConfiguration=null,this._currentConfiguration=o,this._currentConfiguration.setCamera(this),this._transitionStyle=h.TransitionStyle.NONE,this._defaultTransitionStyle=a||h.TransitionStyle.NONE,this._transitionDuration=0,this._defaultTransitionDuration=r||0,this._transitionElapsedTime=0,this._velocityVector=[0,0,0],this._controlledVelocityVector=[0,0,0],this._angularVelocityVector=[0,0,0],this._previousFollowedPositionVector=null,i.setIdentity4(this._projectionMatrix),this._projectionMatrixValid=!1,this._followedNode=null,i.setIdentity4(this._viewMatrix),this._viewMatrixValid=!1,i.setIdentity4(this._inversePositionMatrix),this._inversePositionMatrixValid=!1,i.setIdentity4(this._inverseOrientationMatrix),this._inverseOrientationMatrixValid=!1,this._fov=0,this._span=0,this._near=0,this._extendedCamera=null,this._extendedCameraValid=!1,this._combinedExtendedCamera=null,this._combinedExtendedCameraValid=!1,
this._updateFOV(),this._updateSpan()},h.prototype.getViewDistance=function(){return this._viewDistance},h.prototype.setViewDistance=function(t){this._viewDistance=t,this._updateProjectionMatrix(this._fov,this._span)},h.prototype.getNearDistance=function(){return this._near},h.prototype.getCameraPositionMatrix=function(){var t;return i.setMatrix4(this._posMatrix,this._object3D.pM),this._leftEye?(t=this._object3D.oM,this._posMatrix[12]-=this._interocularHalfDistance*t[0],this._posMatrix[13]-=this._interocularHalfDistance*t[1],this._posMatrix[14]-=this._interocularHalfDistance*t[2]):this._rightEye&&(t=this._object3D.oM,this._posMatrix[12]+=this._interocularHalfDistance*t[0],this._posMatrix[13]+=this._interocularHalfDistance*t[1],this._posMatrix[14]+=this._interocularHalfDistance*t[2]),this._posMatrix},h.prototype.getCameraPositionVector=function(){return this._object3D.getPositionVector()},h.prototype.getCameraOrientationMatrix=function(){return i.setMatrix4(this._oriMatrix,this._object3D.oM),this._leftEye?i.rotate4(this._oriMatrix,i.getRowB43(this._oriMatrix),this._stereoAngle):this._rightEye&&i.rotate4(this._oriMatrix,i.getRowB43(this._oriMatrix),-this._stereoAngle),this._oriMatrix},h.prototype._setPositionMatrix=function(t){this._object3D.setPositionMatrix(t),this._viewMatrixValid=!1,this._inversePositionMatrixValid=!1},h.prototype._setPositionv=function(t){this._object3D.setPositionv(t),this._viewMatrixValid=!1,this._inversePositionMatrixValid=!1},h.prototype._setPositionM4=function(t){this._object3D.setPositionM4(t),this._viewMatrixValid=!1,this._inversePositionMatrixValid=!1},h.prototype._setOrientationMatrix=function(t){this._object3D.setOrientationMatrix(t),this._viewMatrixValid=!1,this._inverseOrientationMatrixValid=!1},h.prototype._setOrientationM4=function(t){this._object3D.setOrientationM4(t),this._viewMatrixValid=!1,this._inverseOrientationMatrixValid=!1},h.prototype._rotate=function(t,e){this._object3D.rotate(t,e),this._setOrientationMatrix()},h.prototype.moveToPosition=function(t,e,s){e=void 0===e?this._defaultTransitionDuration:e,e>0&&this.transitionToSameConfiguration(e,s),this._currentConfiguration.setRelativePositionMatrix(i.translation4v(t),!0)},h.prototype.getViewMatrix=function(){return this._viewMatrixValid||(i.setProdTranslationRotation4(this._viewMatrix,this.getInversePositionMatrix(),this.getInverseOrientationMatrix()),this._viewMatrixValid=!0),this._viewMatrix},h.prototype.getInversePositionMatrix=function(){return this._inversePositionMatrixValid||(i.setInverseOfTranslation4(this._inversePositionMatrix,this.getCameraPositionMatrix()),this._inversePositionMatrixValid=!0),this._inversePositionMatrix},h.prototype.getInverseOrientationMatrix=function(){return this._inverseOrientationMatrixValid||(i.setInverseOfRotation4(this._inverseOrientationMatrix,this.getCameraOrientationMatrix()),this._inverseOrientationMatrixValid=!0),this._inverseOrientationMatrix},h.prototype.getConfiguration=function(){return this._currentConfiguration},h.prototype.getProjectionMatrix=function(){return this._projectionMatrixValid||this._updateProjectionMatrix(this.getFOV(),this.getSpan()),this._projectionMatrix},h.prototype._updateProjectionMatrix=function(e,s){this._near=.5*s/Math.tan(e*t.RAD*.5),this._usesVerticalValues?i.setPerspective4(this._projectionMatrix,s*this._aspect*.5,.5*s,this._near,this._viewDistance):i.setPerspective4(this._projectionMatrix,.5*s,s/this._aspect*.5,this._near,this._viewDistance),this._projectionMatrixValid=!0},h.prototype.getAspect=function(){return this._aspect},h.prototype.setAspect=function(t){this._aspect!==t&&(this._aspect=t,this._projectionMatrixValid=!1)},h.prototype.getFOV=function(){return this._fov||this._updateFOV(this._getTransitionProgress()),this._fov},h.prototype.setFOV=function(t,e,i){e=void 0===e?this._defaultTransitionDuration:e,e>0?this.transitionToSameConfiguration(e,i):this._fov=t,this._currentConfiguration.setFOV(t,!0),this._projectionMatrixValid=!1},h.prototype.decreaseFOV=function(){this._fov=this._currentConfiguration.decreaseFOV(),this._projectionMatrixValid=!1},h.prototype.increaseFOV=function(){this._fov=this._currentConfiguration.increaseFOV(),this._projectionMatrixValid=!1},h.prototype.getSpan=function(){return this._span||this._updateSpan(this._getTransitionProgress()),this._span},h.prototype.setControlledVelocityVector=function(t){this._controlledVelocityVector=t},h.prototype.setAngularVelocityVector=function(t){this._angularVelocityVector=t},h.prototype._getFreeCameraConfiguration=function(t,e,s){return void 0===t&&(t=this._currentConfiguration.isFPS()),e=e||this.getCameraPositionMatrix(),s=s||this.getCameraOrientationMatrix(),t&&(s=i.prod3x3SubOf4Aux(i.ROTATION_X_90,s)),l(t,e,s,this.getFOV(),this._currentConfiguration.getMinFOV(),this._currentConfiguration.getMaxFOV(),this.getSpan())},h.prototype.setConfiguration=function(t,e){this._currentConfiguration&&this._currentConfiguration.setCamera(null),this._currentConfiguration=t,this._previousConfiguration=null,this._updateFOV(),this._updateSpan(),this._updateProjectionMatrix(this._fov,this._span),this._currentConfiguration.setCamera(this,e)},h.prototype.startTransitionToConfiguration=function(t,e,i){this._currentConfiguration!==t&&(0===e?this.setConfiguration(t):(this._previousConfiguration&&this._currentConfiguration?this._previousConfiguration=this._getFreeCameraConfiguration(!1):this._previousConfiguration=this._currentConfiguration,this._currentConfiguration&&this._currentConfiguration.setCamera(null),this._currentConfiguration=t,this._currentConfiguration.setCamera(this),this._transitionDuration=void 0===e?this._defaultTransitionDuration:e,this._transitionElapsedTime=0,this._transitionStyle=void 0===i?this._defaultTransitionStyle:i))},h.prototype.transitionToFreeCamera=function(t,e,i,s,n){this._followedNode=null,this.startTransitionToConfiguration(this._getFreeCameraConfiguration(t,e,i),s,n)},h.prototype.setToFreeCamera=function(t,e,i){this.transitionToFreeCamera(t,e,i,0)},h.prototype.transitionToSameConfiguration=function(e,i){var s=this._currentConfiguration;this.setConfiguration(this._previousConfiguration?this._getFreeCameraConfiguration(!1):this._currentConfiguration.copy(t.EMPTY_STRING,!0),!0),this.startTransitionToConfiguration(s,e,i)},h.prototype.transitionToConfigurationDefaults=function(t,e){this.transitionToSameConfiguration(t,e),this._currentConfiguration.resetToDefaults(!0)},h.prototype.positionConfigurationWillChange=function(){this.transitionToSameConfiguration()},h.prototype.orientationConfigurationWillChange=function(){this.transitionToSameConfiguration()},h.prototype.configurationWillChange=function(){this.transitionToSameConfiguration()},h.prototype.getFollowedNode=function(){return this._followedNode},h.prototype.moveToOrigoIfNeeded=function(t){var e=this.getCameraPositionMatrix(),s=null;return(e[12]>t||e[12]<-t||e[13]>t||e[13]<-t||e[14]>t||e[14]<-t)&&(s=[-e[12],-e[13],-e[14]],this._currentConfiguration.positionFollowsObjects()||this._currentConfiguration.setRelativePositionMatrix(i.identity4(),!0),this._previousConfiguration&&!this._previousConfiguration.positionFollowsObjects()&&this._previousConfiguration.moveByVector(s,!0)),s},h.prototype.followNode=function(t,e,i,s,n){var o,r;return!e&&this._followedNode===t||(this._followedNode=t,this._followedNode?(n&&(o=this._followedNode.getCameraConfigurationsWithName(n),o.length>0&&(r=o[0])),!!(r=r||this._followedNode.getNextCameraConfiguration())&&(this.startTransitionToConfiguration(r,i,s),!0)):(n&&(o=this._scene.getCameraConfigurationsWithName(n),o.length>0&&(r=o[0])),!!(r=r||this._scene.getNextCameraConfiguration())&&(this.startTransitionToConfiguration(r,i,s),!0)))},h.prototype.followObject=function(t,e,i,s,n){return this.followNode(t.getNode(),e,i,s,n)},h.prototype.changeToNextView=function(t,e){this._followedNode?this.startTransitionToConfiguration(this._followedNode.getNextCameraConfiguration(this._currentConfiguration),t,e):this._scene.getNextCameraConfiguration()&&this.startTransitionToConfiguration(this._scene.getNextCameraConfiguration(this._scene.hasCameraConfiguration(this._currentConfiguration)?this._currentConfiguration:null),t,e)},h.prototype.changeToPreviousView=function(t,e){this._followedNode?this.startTransitionToConfiguration(this._followedNode.getPreviousCameraConfiguration(this._currentConfiguration),t,e):this._scene.getNextCameraConfiguration()&&this.startTransitionToConfiguration(this._scene.getPreviousCameraConfiguration(this._scene.hasCameraConfiguration(this._currentConfiguration)?this._currentConfiguration:null),t,e)},h.prototype.followNextNode=function(t,e,i){for(var s=this._scene.getNextNode(this._followedNode),n=this._followedNode;s!==n&&s&&(!s.getNextCameraConfiguration()||!s.isVisible());)if(n||(n=s),s=this._scene.getNextNode(s),t&&this._followedNode&&s===this._scene.getFirstNode()&&this.followNode(null,!0,e,i))return!0;return!!(s&&s.getNextCameraConfiguration()&&s.isVisible())&&this.followNode(s,!0,e,i)},h.prototype.followPreviousNode=function(t,e,i){for(var s=this._scene.getFirstNode(),n=this._scene.getPreviousNode(this._followedNode),o=this._followedNode;n!==o&&n&&(!n.getNextCameraConfiguration()||!n.isVisible());){if(o||(o=n),t&&n===s&&this.followNode(null,!0,e,i))return;n=this._scene.getPreviousNode(n)}n&&n.getNextCameraConfiguration()&&this.followNode(n,!0,e,i)},h.prototype.followOrientationOfObjects=function(t,e,i){e=void 0===e?this._defaultTransitionDuration:e,e>0&&this.transitionToSameConfiguration(e,i),this._currentConfiguration.setOrientationFollowedObjects(t,!0)},h.prototype._getTransitionProgress=function(){var t;if(0===this._transitionDuration)return 0;switch(this._transitionStyle){case h.TransitionStyle.LINEAR:return this._transitionElapsedTime/this._transitionDuration;case h.TransitionStyle.SMOOTH:return t=this._transitionElapsedTime/this._transitionDuration,t=3*t*t-2*t*t*t}return-1},h.prototype._updateFOV=function(t){this._fov=this._previousConfiguration?this._previousConfiguration.getFOV()+(this._currentConfiguration.getFOV()-this._previousConfiguration.getFOV())*t:this._currentConfiguration.getFOV()},h.prototype._updateSpan=function(t){this._span=this._previousConfiguration?this._previousConfiguration.getSpan()+(this._currentConfiguration.getSpan()-this._previousConfiguration.getSpan())*t:this._currentConfiguration.getSpan()},h.prototype._updateStereoAngle=function(){this._stereoAngle=Math.atan(this._interocularHalfDistance/this._stereoscopicConvergenceDistance)},h.prototype.update=function(t){var s,n,o,r,a,l,h;if(this._extendedCameraValid=!1,this._combinedExtendedCameraValid=!1,this._previousConfiguration){if(!this._currentConfiguration.update([0,0,0],[0,0,0],t))return void this.update(t);if(this._transitionElapsedTime+=t,this._transitionElapsedTime>this._transitionDuration&&(this._transitionElapsedTime=this._transitionDuration),l=this._getTransitionProgress(),!this._previousConfiguration.update([0,0,0],[0,0,0],t))return void this.update(t);s=this._previousConfiguration.getPositionVector(),n=this._currentConfiguration.getPositionVector(),o=this.getCameraPositionVector(),this._setPositionv(e.sum3(e.scaled3(s,1-l),e.scaled3(n,l))),this._velocityVector=e.scaled3(e.prodMat4Vec3(this.getCameraOrientationMatrix(),e.diff3(this.getCameraPositionVector(),o)),1e3/t),r=i.prod3x3SubOf4Aux(i.inverseOfRotation4Aux(this._previousConfiguration.oM),this._currentConfiguration.oM),a=i.getRotations(r),this._setOrientationM4(i.IDENTITY4),this._rotate(a.gammaAxis,a.gamma*l),this._rotate(a.alphaAxis,a.alpha*l),h=i.prod3x3SubOf4Aux(this._previousConfiguration.oM,this.getCameraOrientationMatrix()),i.correctOrthogonal4(h),this._setOrientationM4(h),this._updateFOV(l),this._updateSpan(l),this._updateProjectionMatrix(this._fov,this._span),this._transitionElapsedTime===this._transitionDuration&&(this._previousConfiguration=null)}else{if(!this._currentConfiguration.update(this._controlledVelocityVector,this._angularVelocityVector,t))return void this.update(t);if(!this._currentConfiguration.update([0,0,0],[0,0,0],t))return void this.update(t);o=this.getCameraPositionVector(),this._setPositionM4(this._currentConfiguration.pM),this._setOrientationM4(this._currentConfiguration.oM),this._currentConfiguration.positionFollowsObjects()?(this._previousFollowedPositionVector?this._velocityVector=e.scaled3(e.prodMat4Vec3(this.getCameraOrientationMatrix(),e.diff3(this._currentConfiguration.getFollowedPositionVector(),this._previousFollowedPositionVector)),1e3/t):this._velocityVector=[0,0,0],this._previousFollowedPositionVector=this._currentConfiguration.getFollowedPositionVector()):this._velocityVector=e.scaled3(e.prodMat4Vec3(this.getCameraOrientationMatrix(),e.diff3(this.getCameraPositionVector(),o)),1e3/t)}},h.prototype.setStereoscopy=function(t){this._stereoscopy!==t&&(this._stereoscopy=t,this._leftEye=t===h.Stereoscopy.LEFT,this._rightEye=t===h.Stereoscopy.RIGHT,this._viewMatrixValid=!1,this._inversePositionMatrixValid=!1,this._inverseOrientationMatrixValid=!1)},h.prototype.setLeftEye=function(){this.setStereoscopy(h.Stereoscopy.LEFT)},h.prototype.setRightEye=function(){this.setStereoscopy(h.Stereoscopy.RIGHT)},h.prototype.setInterocularDistance=function(t){this._interocularHalfDistance=.5*t,this._updateStereoAngle()},h.prototype.setStereoscopicConvergenceDistance=function(t){this._stereoscopicConvergenceDistance=t,this._updateStereoAngle()},h.prototype.copyStereoscopy=function(t,e,i){this.setStereoscopy(t),t!==h.Stereoscopy.NONE&&(this._interocularHalfDistance=e,this._stereoscopicConvergenceDistance=i,this._updateStereoAngle())},h.prototype.getExtendedCamera=function(t){var e,i;return!t&&this._extendedCameraValid?i=this._extendedCamera:t&&this._combinedExtendedCameraValid?i=this._combinedExtendedCamera:(0===this._fov&&(this._updateFOV(),this._updateSpan()),e=t?this._span:this._span/this._near*this._viewDistance,i=t?this._combinedExtendedCamera:this._extendedCamera,i?(i.getConfiguration().setToFree(!1,this._object3D.pM,this._object3D.oM,this._fov,this._fov,this._fov,e,e,e),i.init(this._scene,this._aspect,this._usesVerticalValues,5*this._viewDistance,i.getConfiguration())):i=new h(this._scene,this._aspect,this._usesVerticalValues,5*this._viewDistance,l(!1,this._object3D.pM,this._object3D.oM,this._fov,this._fov,this._fov,e)),i.update(0),t?(this._combinedExtendedCameraValid=!0,this._combinedExtendedCamera=i):(this._extendedCameraValid=!0,this._extendedCamera=i)),i.copyStereoscopy(this._stereoscopy,this._interocularHalfDistance,this._stereoscopicConvergenceDistance),i},{CameraPositionConfiguration:o,CameraOrientationConfiguration:r,CameraConfiguration:a,Camera:h,getFreeCameraConfiguration:l}}),define("modules/scene/renderable-objects",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/managed-gl","modules/scene/object-3d"],function(t,e,i,s,n,o){"use strict";function r(e){switch(e){case t.ScaleMode.WIDTH:return 0;case t.ScaleMode.HEIGHT:return 1;case t.ScaleMode.ASPECT:return 2;case t.ScaleMode.MINIMUM:return 3;case t.ScaleMode.MAXIMUM:return 4}}function a(t,e,i,s,n){this._node=null,this._shader=t,this._textures={},this._textureRoles=[],this._uniformValueFunctions={},this._isRenderedWithDepthMask=void 0===e||e,this._isRenderedWithoutDepthMask=void 0===i||i,this._instancedShader=s||null,this._canBeReused=!1,this._visible=!0,this._castsShadows=void 0===n||n,this._wasRenderedToShadowMap=!1,this._name=null}function l(t,e,i,s,n,r,l,h,u,c){a.call(this,t,e,i,l),o.Object3D.call(this,s,n,r,h,u,c),this._visibleSize={width:-1,height:-1},this._visibleSizeUpdated=!1,this._smallestSizeWhenDrawn=0}function h(t,e,s,n,o){a.call(this,e,!1,!0),this._model=t,this._samplerName=s,this._camera=o,this.setTexture(s,n),this.setUniformValueFunction(M,function(){return i.inverse4Aux(i.prod4Aux(this._camera.getInverseOrientationMatrix(),this._camera.getProjectionMatrix()))})}function u(t,e,s,n,o,r,a,h,u){l.call(this),this._model=null,this._wireframe=!1,this._currentLOD=this.LOD_NOT_SET,this._lastLOD=this.LOD_NOT_SET,this._modelSize=0,this._lodSizeFactors=null,this._staticLOD=this.LOD_NOT_SET,t&&this.init(t,e,s,n,o,r,a,h,u),this.setUniformValueFunction(C,function(){return this.getModelMatrix()}),this.setUniformValueFunction(N,function(){return i.transposed3Aux(i.inverse3Aux(i.matrix3from4Aux(this.getModelMatrix())))})}function c(t,e,i,s,n,o,r,a,l,h){u.call(this),this._parameterArrays=null,t&&this.init(t,e,i,s,n,o,r,a,l,h)}function _(t,e,i,s,n,o,r,a){l.call(this),this._model=null,this._wireframe=!1,this._renderPosition=[0,0,0,0],this._renderDirection=[0,0,0,0],t&&this.init(t,e,i,s,n,o,r,a),this.setUniformValueFunction(v,function(){return this.copyPositionToVector(this._renderPosition),this._renderPosition}),this.setUniformValueFunction(b,function(){return this._renderDirection})}function d(t){l.call(this),t&&this.init(null,!1,!1,null,null,null,null,t,!0,!0),this.setUniformValueFunction(C,function(){return this.getModelMatrix()})}function p(t,e,i,s,n,o,r,a,h,u,c,_,d,p){l.call(this),this._model=null,this._wireframe=!1,this._sizeVector=[0,0,0],this._startPosition=[0,0,0],this._endPosition=[0,0,0],this._startDirection=[0,0,0],this._endDirection=[0,0,0],this._direction=[0,0,0],this._color=[0,0,0,0],this._duration=0,this._startTimeLeft=0,this._endTimeLeft=0,t&&this.init(t,e,i,s,n,o,r,a,h,u,c,_,d,p),this.setUniformValueFunction(w,function(){return this._startPosition}),this.setUniformValueFunction(F,function(){return this._endPosition}),this.setUniformValueFunction(P,function(){return this._startDirection}),this.setUniformValueFunction(V,function(){return this._endDirection}),this.setUniformValueFunction(D,function(){return this._sizeVector}),this.setUniformValueFunction(R,function(){return this._color})}function g(t,e,i){this.color=t||k,this.size=void 0!==e?e:1,this.timeToReach=i||0}function m(t,i,s,n,o,r,a,h){l.call(this),this.setSmallestSizeWhenDrawn(.1),this._model=t,this._color=[0,0,0,0],this._size=0,this._relativeSize=0,this._positionVector=[0,0,0,0],this._states=null,this._currentStateIndex=0,this._looping=!1,this._timeSinceLastTransition=0,this._velocityVector=[0,0,0],this._worldVelocityDirectionVector=[0,0,0],this._worldVelocityDirectionVectorValid=!1,this._shouldAnimate=!1,this._duration=0,t&&this.init(t,i,s,n,o,r,a,h),this.setUniformValueFunction(v,function(){var t;return t=this.getModelMatrix(),this._positionVector[0]=t[12],this._positionVector[1]=t[13],this._positionVector[2]=t[14],this._positionVector}),this.setUniformValueFunction(R,function(){return this._color}),this.setUniformValueFunction(b,function(){return e.floatVector3Aux(this.getWorldVelocityDirectionVector())})}function f(t,e,i,s,n,o,r,a,l){t.init(e,i,s,r,[new g(n,o,0),new g(n,0,a)],!1,l)}function S(t,e,i,s,n,o,r,a){var l=new m;return f(l,t,e,i,s,n,o,r,a),l}function T(t,e,i,s,n,o,r){return new m(t,e,i,o,[new g(s,n,0)],!1,r)}function E(s,n,o,r,a,l,h){var u,c,_,d;m.call(this,s,n,o,l,[new g(r,a,0)],!1),d=[0,1],e.rotate2(d,h),u=[d[0],0,d[1]],c=e.normalize3(i.translationVector3(l)),_=e.getYawAndPitch(c),d=[0,d[1]],e.rotate2(d,_.pitch),u=[u[0],d[0],d[1]],d=[u[0],d[0]],e.rotate2(d,_.yaw),u=[d[0],d[1],u[2]],this.setOrientationMatrix(i.lookTowards4(e.scaled3(c,-1),u)),this._positionVector.length=3,this._calculatedSize=[a],this.setUniformValueFunction(O,function(e){return e===t.EMPTY_STRING?this._calculatedSize:this._calculatedSize[0]}),this.setUniformValueFunction(C,function(){return this.getModelMatrix()})}function y(t,e,i,s,n,o){a.call(this,e,!1,!0,i),this._positionVector=s,this._model=t,this._color=n,this._range=o,this._shift=null,this.setUniformValueFunction(v,function(){return this._positionVector}),this._color&&(this._shift=[0,0,0],this.setUniformValueFunction(R,function(){return this._color}),this.setUniformValueFunction(L,function(){return this._shift}),this.setUniformValueFunction(x,function(){return this._range}))}function I(t,e,s,n,o,l,h,u,c,_){a.call(this,e,!1,!0),this.setTextures(s),this._model=t,this._position=n,this._color=h,this._size=o,this._scaleMode=r(l),this._rotationMatrix=i.rotation2(Math.radians(u||0)),this._clipCoordinates=c||j.slice(),this._clipColor=_||[0,0,0,0],this.setUniformValueFunction(v,function(){return this._position}),this.setUniformValueFunction(D,function(){return this._size}),this.setUniformValueFunction(U,function(){return this._scaleMode}),this.setUniformValueFunction(R,function(){return this._color}),this.setUniformValueFunction(B,function(){return this._rotationMatrix}),this.setUniformValueFunction(H,function(){return this._clipCoordinates}),this.setUniformValueFunction(G,function(){return this._clipColor})}var A={NONE:0,FRONT_QUEUE_BIT:1,DISTANCE_QUEUE_BIT:2},M="viewDirectionProjectionInverse",C="modelMatrix",N="normalMatrix",O="billboardSize",R="color",L="shift",x="farthestZ",v="position",b="direction",D="size",w="startPosition",F="endPosition",P="startDirection",V="endDirection",U="scaleMode",B="rotationMatrix",H="clipCoords",G="clipColor",j=[0,1,0,1],k=[1,1,1,1];return a.prototype.init=function(t,e,i,s,n){this._shader=t,this._textures={},this._textureRoles=[],this._isRenderedWithDepthMask=void 0===e||e,this._isRenderedWithoutDepthMask=void 0===i||i,this._instancedShader=s||null,this._canBeReused=!1,this._visible=!0,this._castsShadows=void 0===n||n,this._name=null},a.prototype.getNode=function(){return this._node},a.prototype.setNode=function(t){this._node=t},a.prototype.getShader=function(){return this._shader},a.prototype.setShader=function(t){this._shader=t},a.prototype.setInstancedShader=function(t){this._instancedShader=t},a.prototype._updateTextures=function(){var t,e,i;for(this._textureRoles=Object.keys(this._textures),t=0;t<this._textureRoles.length;t++){if(e=this._textureRoles[t],this._textures[e]instanceof n.ManagedTexture)i=n.getUniformName(n.getTextureUniformRawName(e));else{if(!(this._textures[e]instanceof n.ManagedCubemap)){s.showError("Attemtping to add a texture of unknown type ("+this._textures[e].constructor.name+") to the GL context.");continue}i=n.getUniformName(n.getCubemapUniformRawName(e))}this._uniformValueFunctions[i]=this._uniformValueFunctions[i]||this._getTextureLocation.bind(this,e)}},a.prototype.setTexture=function(t,e){this._textures[t]=e,this._updateTextures()},a.prototype.setTextures=function(t){this._textures=t,t&&this._updateTextures()},a.prototype.setUniformValueFunction=function(t,e,i){this._uniformValueFunctions[n.getUniformName(t)]=e.bind(i||this)},a.prototype.setName=function(t){this._name=t},a.prototype._getTextureLocation=function(t,e){return this._textures[t].getLastTextureBindLocation(e)},a.prototype.addToContext=function(t){var e,i;for(this._shader&&t.addShader(this._shader),this._instancedShader&&t.addShader(this._instancedShader),i=0;i<this._textureRoles.length;i++)e=this._textureRoles[i],t.addTexture(this._textures[e])},a.prototype.bindTextures=function(t){var e,i;for(i=0;i<this._textureRoles.length;i++)e=this._textureRoles[i],t.bindTexture(this._textures[e])},a.prototype.markAsReusable=function(t){this._canBeReused=!0,this._node&&this._node.handleObjectBecameReusable(t)},a.prototype.canBeReused=function(){return this._canBeReused},a.prototype.isVisible=function(){return this._visible&&(!this._node||this._node.isVisible())},a.prototype.getRenderQueueBits=function(){return this._visible?A.FRONT_QUEUE_BIT:A.NONE},a.prototype.prepareForInstancedRender=function(t,e,i,s){t.setCurrentShader(this._instancedShader)&&e.assignUniforms(t,this._instancedShader),t.getCurrentShader()===this._instancedShader&&(this.bindTextures(t),this._instancedShader.assignUniforms(t,this._uniformValueFunctions),this._instancedShader.createInstanceBuffers(i,s))},a.prototype.mightBeRendered=function(){return!0!==this._canBeReused&&this._visible},a.prototype.shouldBeRendered=function(t){return t.depthMask&&this._isRenderedWithDepthMask||!t.depthMask&&this._isRenderedWithoutDepthMask},a.prototype.prepareForRender=function(t){t.useInstancing&&t.context.getCurrentShader()===this._instancedShader?this._instancedShader.addDataToInstanceBuffers(t.instanceQueueIndex,this._uniformValueFunctions):(t.context.setCurrentShader(this._shader)&&t.scene.assignUniforms(t.context,this._shader),t.context.getCurrentShader()===this._shader&&(this.bindTextures(t.context),this._shader.assignUniforms(t.context,this._uniformValueFunctions)))},a.prototype.performRender=function(){return!0},a.prototype.render=function(t){return!!this.shouldBeRendered(t)&&(this.prepareForRender(t),t.useInstancing||this.performRender(t),!0)},a.prototype.renderInstances=function(t,e,i){this._instancedShader.bindAndFillInstanceBuffers(t,e),this._peformRenderInstances(t,i)},a.prototype.mightBeRenderedToShadowMap=function(){return!this._canBeReused&&this._visible&&this._castsShadows},a.prototype.shouldBeRenderedToShadowMap=function(){return!0},a.prototype.wasRenderedToShadowMap=function(){return this._wasRenderedToShadowMap},a.prototype.prepareForRenderToShadowMap=function(){return!0},a.prototype.performRenderToShadowMap=function(){return!0},a.prototype.renderToShadowMap=function(t){return this.shouldBeRenderedToShadowMap(t)?(this.prepareForRenderToShadowMap(t),this.performRenderToShadowMap(t),this._wasRenderedToShadowMap=!0,!0):(this._wasRenderedToShadowMap=!1,!1)},a.prototype.shouldAnimate=function(t){return t>0},a.prototype.performAnimate=function(){return!0},a.prototype.animate=function(t){this.shouldAnimate(t)&&this.performAnimate(t)},a.prototype.shouldGoInSameRenderQueue=function(t){return this._shader===t.getShader()},a.prototype.shouldGoInSameRenderQueueInstanced=function(t){return this.constructor===t.constructor&&this._shader===t._shader},l.prototype=new a,o.makeObject3DMixinClass.call(l),l.prototype.constructor=a,l.prototype.init=function(t,e,i,s,n,r,l,h,u,c){a.prototype.init.call(this,t,e,i,l),o.Object3D.prototype.init.call(this,s,n,r,h,u,c),this._visibleSize={width:-1,height:-1},this._smallestSizeWhenDrawn=0},l.prototype.setSmallestSizeWhenDrawn=function(t){this._smallestSizeWhenDrawn=t},l.prototype.updateVisibleSize=function(t,e){return this._visibleSizeUpdated||(this._visibleSize=this.getSizeInsideViewFrustum(t.camera)),this._visibleSizeUpdated=e,this._visibleSize},l.prototype.getSizeInPixels=function(t){return Math.max(this._visibleSize.width*t.viewportWidth/2,this._visibleSize.height*t.viewportHeight/2)},l.prototype.resetForNewFrame=function(){l.prototype.resetCachedValues.call(this)},l.prototype.getRenderQueueBits=function(t,e){var i,s,n,o=A.NONE;return this.isInsideParent()?e:(i=this.getPositionMatrixInCameraSpace(t),s=this.getCascadeScalingMatrix(),n=this.getSize()*s[0],i[14]-n<=-t.getNearDistance()&&i[14]+n>-t.getViewDistance()&&(o|=A.FRONT_QUEUE_BIT),i[14]-n<=-t.getViewDistance()&&i[14]+n>-t.getExtendedCamera().getViewDistance()&&(o|=A.DISTANCE_QUEUE_BIT),o)},l.prototype.shouldBeRendered=function(t){var e,i;return a.prototype.shouldBeRendered.call(this,t)?!0===this.isInsideParent()?(e=t.parent._visibleSize,e.width>0?(i=Math.max(this.getSize()/t.parent.getSize(),t.lodContext.minimumRelativeSize),this._visibleSize.width=e.width*i,this._visibleSize.height=e.height*i,this.getSizeInPixels(t)>=this._smallestSizeWhenDrawn):(this._visibleSize.width=0,this._visibleSize.height=0,!1)):(e=this.updateVisibleSize(t,!1),e.width>0&&this.getSizeInPixels(t)>=this._smallestSizeWhenDrawn):(this._visibleSize.width=0,this._visibleSize.height=0,!1)},l.prototype.shouldBeRenderedToShadowMap=function(t){return!0===this.isInsideParent()?t.parent.wasRenderedToShadowMap():this.isInsideShadowRegion(t.light)},h.prototype=new a,h.prototype.constructor=h,h.prototype.addToContext=function(t){a.prototype.addToContext.call(this,t),this._model.addToContext(t,!1)},h.prototype.performRender=function(t){this._model.render(t.context,!1)},u.prototype=new l,u.prototype.constructor=u,u.prototype.LOD_NOT_SET=-1,u.prototype.init=function(t,e,i,s,n,o,r,a,h){l.prototype.init.call(this,e,!0,!0,s,n,o),this.setSmallestSizeWhenDrawn(h||5),this.setTextures(i),this._model=t,this._wireframe=!0===r,this._wireframe&&(this._isRenderedWithDepthMask=!1),this._currentLOD=this.LOD_NOT_SET,this._lastLOD=this.LOD_NOT_SET,this._modelSize=0,this._lodSizeFactors={},this._staticLOD=void 0!==a?a:this.LOD_NOT_SET;for(var u=this._model.getMinLOD();u<=this._model.getMaxLOD();u++)this._model.getSize(u)>this._modelSize&&(this._modelSize=this._model.getSize(u))},u.prototype.addToContext=function(t){l.prototype.addToContext.call(this,t),this._model.addToContext(t,this._wireframe)},u.prototype.getModel=function(){return this._model},u.prototype.getSize=function(){return this._modelSize},u.prototype.getLODSize=function(t,e){return void 0===this._lodSizeFactors[e.toString()]&&(this._lodSizeFactors[e.toString()]=Math.log10(e+10)/Math.log10(this.getScaledSize()+10)),t*this._lodSizeFactors[e.toString()]},u.prototype.getHeight=function(){return this._model.getHeight()},u.prototype.getHeightInMeters=function(){return this._model.getHeightInMeters()},u.prototype.getMaxY=function(){return this._model.getMaxY()},u.prototype.getCurrentLOD=function(t){var e,i,s;if(this._currentLOD===this.LOD_NOT_SET)if(this._staticLOD!==this.LOD_NOT_SET)this._currentLOD=this._model.getClosestAvailableLOD(this._staticLOD);else{if(!t)return this.LOD_NOT_SET;if(this.updateVisibleSize(t,!0),e=this.getSizeInPixels(t),(i=t.lodContext.compensateForObjectSize?this.getLODSize(e,t.lodContext.referenceSize):e)>0)for(s=Math.min(this._model.getMaxLOD(),t.lodContext.maxEnabledLOD);s>=this._model.getMinLOD();s--)if(t.lodContext.thresholds[s]<=i){this._currentLOD=s;break}}return this._currentLOD!==this.LOD_NOT_SET?(this._lastLOD=this._currentLOD,this._currentLOD):this._lastLOD!==this.LOD_NOT_SET?this._lastLOD:0},u.prototype.setStaticLOD=function(t){this._staticLOD=t,this._currentLOD=this.LOD_NOT_SET,this._lastLOD=this.LOD_NOT_SET},u.prototype.resetForNewFrame=function(){l.prototype.resetForNewFrame.call(this),this._staticLOD===this.LOD_NOT_SET&&(this._currentLOD=this.LOD_NOT_SET)},u.prototype.shouldBeRendered=function(t){if(l.prototype.shouldBeRendered.call(this,t)){if(!0===this._wireframe)return!0;if(!0===t.depthMask){if(this._model.getNumOpaqueTriangles(this.getCurrentLOD(t))>0)return!0}else if(!1===t.depthMask&&this._model.getNumTransparentTriangles(this.getCurrentLOD(t))>0)return!0;return!1}return!1},u.prototype.performRender=function(t){this._model.render(t.context,this._wireframe,t.depthMask,this.getCurrentLOD(t))},u.prototype.shouldBeRenderedToShadowMap=function(t){if(l.prototype.shouldBeRenderedToShadowMap.call(this,t))return this._model.getNumOpaqueTriangles(this.getCurrentLOD(t))>0},u.prototype.prepareForRenderToShadowMap=function(t){t.context.getCurrentShader().assignUniforms(t.context,this._uniformValueFunctions)},u.prototype.performRenderToShadowMap=function(t){this._model.render(t.context,this._wireframe,!0,this.getCurrentLOD(t))},c.prototype=new u,c.prototype.constructor=c,c.prototype.init=function(t,e,i,o,r,a,l,h,c,_){var d,p,g,m,f;for(u.prototype.init.call(this,t,e,i,o,r,a,l,h,c),this._parameterArrays={},f=Object.keys(_),d=0;d<f.length;d++)if(g=n.getUniformName(f[d]),(m=e.getUniformArrayLength(g))>0){switch(_[f[d]]){case n.ShaderVariableType.FLOAT:break;case n.ShaderVariableType.MAT4:m*=16;break;default:s.showError("Cannot create uniform parameter array with elements of type: '"+_[f[d]]+"'!")}for(this._parameterArrays[f[d]]=new Float32Array(m),p=0;p<m;p++)this._parameterArrays[f[d]][p]=0;this.setUniformValueFunction(f[d],this.createGetParameterArrayFunction(f[d]))}else this._parameterArrays[f[d]]=new Float32Array},c.prototype.createGetParameterArrayFunction=function(t){return function(){return this._parameterArrays[t]}},c.prototype.hasParameterArray=function(t){return!!this._parameterArrays[t]&&this._parameterArrays[t].length>0},c.prototype.setFloatParameter=function(t,e,i){this._parameterArrays[t][e]=i},
c.prototype.setMat4Parameter=function(t,e,i){this._parameterArrays[t].set(i,16*e)},c.prototype.setParameterArray=function(t,e){this._parameterArrays[t].set(e,0)},_.prototype=new l,_.prototype.constructor=_,_.prototype.init=function(t,s,n,o,r,a,h,u){l.prototype.init.call(this,s,!1,!0,a,h,i.scaling4Aux(o),u),this.setTextures(n),e.setRowB43(this._renderDirection,this.oM),this._renderDirection[3]=1,this._renderPosition[3]=o,this._model=t,this._wireframe=!0===r,this._wireframe&&(this._isRenderedWithDepthMask=!1)},_.prototype.getModel=function(){return this._model},_.prototype.getCurrentLOD=function(){return 0},_.prototype.updateDirection=function(){e.setRowB43(this._renderDirection,this.oM)},_.prototype.setDirectionW=function(t){this._renderDirection[3]=t},_.prototype.addToContext=function(t){l.prototype.addToContext.call(this,t),this._model.addToContext(t,this._wireframe)},_.prototype.performRender=function(t){this._model.render(t.context,this._wireframe)},_.prototype._peformRenderInstances=function(t,e){this._model.renderInstances(t,this._wireframe,void 0,void 0,e)},_.prototype.mightBeRenderedToShadowMap=function(){return!1},_.prototype.shouldGoInSameRenderQueueInstanced=function(t){return l.prototype.shouldGoInSameRenderQueueInstanced.call(this,t)&&this._textures===t._textures&&this._model===t._model},d.prototype=new l,d.prototype.constructor=d,d.prototype.translatev=function(t){var e;for(o.Object3D.prototype.translatev.call(this,t),e=this.getNode()._subnodes.getFirst();e;e=e.next)e._renderableObject.translatev(t)},p.prototype=new l,p.prototype.constructor=p,p.prototype.init=function(t,s,n,o,r,a,h,u,c,_,d,p,g,m){l.prototype.init.call(this,s,!1,!0,i.translation4vAux(a),i.IDENTITY4,i.scaling4Aux(o),m),this.setTextures(n),e.setVector3(this._startPosition,a),e.setVector3(this._endPosition,u),e.setVector3(this._startDirection,h),e.setVector3(this._endDirection,c),e.setVector4(this._color,_),this._duration=d,this._startTimeLeft=p,this._endTimeLeft=g,this._sizeVector[0]=o,this._model=t,this._wireframe=!0===r,this._wireframe&&(this._isRenderedWithDepthMask=!1)},p.prototype.shouldBeRendered=function(t){return a.prototype.shouldBeRendered.call(this,t)},p.prototype.translatev=function(t){e.add3(this._startPosition,t),e.add3(this._endPosition,t)},p.prototype.getModel=function(){return this._model},p.prototype.getCurrentLOD=function(){return 0},p.prototype.getEndDirection=function(){return this._endDirection},p.prototype.getEndTimeLeft=function(){return this._endTimeLeft},p.prototype.addToContext=function(t){l.prototype.addToContext.call(this,t),this._model.addToContext(t,this._wireframe)},p.prototype.performAnimate=function(t){var i;if(this._startTimeLeft-=t,this._endTimeLeft-=t,this._endTimeLeft<=0)return this._startTimeLeft=0,this._endTimeLeft=0,void this.markAsReusable(!0);this._startTimeLeft<0&&(e.setDiff3(this._direction,this._endPosition,this._startPosition),i=e.extractLength3(this._direction),e.add3(this._startPosition,e.scaled3Aux(this._direction,i*(1-this._endTimeLeft/(this._endTimeLeft-this._startTimeLeft)))),this._startTimeLeft=0),this._sizeVector[1]=this._startTimeLeft/this._duration,this._sizeVector[2]=this._endTimeLeft/this._duration},p.prototype.performRender=function(t){this._model.render(t.context,this._wireframe)},p.prototype._peformRenderInstances=function(t,e){this._model.renderInstances(t,this._wireframe,void 0,void 0,e)},p.prototype.mightBeRenderedToShadowMap=function(){return!1},p.prototype.shouldGoInSameRenderQueueInstanced=function(t){return l.prototype.shouldGoInSameRenderQueueInstanced.call(this,t)&&this._textures===t._textures&&this._model===t._model},m.prototype=new l,m.prototype.constructor=m,m.prototype.init=function(e,s,n,o,r,a,h,u){l.prototype.init.call(this,s,!1,!0,o,i.IDENTITY4,i.IDENTITY4,h),this.setTextures(n),this._model=e,r?(this._color[0]=r[0].color[0],this._color[1]=r[0].color[1],this._color[2]=r[0].color[2],this._color[3]=r[0].color[3],this._states=r):this._states=t.EMPTY_ARRAY,this._size=void 0!==u?u:r?r[0].size:0,this._relativeSize=1,this._calculateSize(),this._calculateDuration(),this._currentStateIndex=0,this._looping=!0===a,this._timeSinceLastTransition=0,this._velocityVector[0]=0,this._velocityVector[1]=0,this._velocityVector[2]=0,this._worldVelocityDirectionVector[0]=0,this._worldVelocityDirectionVector[1]=0,this._worldVelocityDirectionVector[2]=0,this._worldVelocityDirectionVectorValid=!1,this._shouldAnimate=!1,this._updateShouldAnimate()},m.prototype._calculateDuration=function(){var t;for(this._duration=0,t=1;t<this._states.length;t++)this._duration+=this._states[t].timeToReach},m.prototype._calculateSize=function(){this._positionVector[3]=this._size*this._relativeSize,this._visible=this._positionVector[3]>=.01},m.prototype.getSize=function(){return this._positionVector[3]},m.prototype.getFinalSize=function(){return 0===this._states.length?this._size:this._states[this._states.length-1].size},m.prototype.getMaxSize=function(){var t,e;if(0===this._states.length)return this._size;for(t=0,e=0;e<this._states.length;e++)this._states[e].size>t&&(t=this._states[e].size);return t},m.prototype._hasVelocity=function(){return this._velocityVector&&(0!==this._velocityVector[0]||0!==this._velocityVector[1]||0!==this._velocityVector[2])},m.prototype.rotateByMatrix3=function(t){this._velocityVector?(e.mulVec3Mat3(this._velocityVector,t),this._updateVelocity()):l.prototype.rotateByMatrix3.call(this,t)},m.prototype._updateShouldAnimate=function(){this._shouldAnimate=this._states.length>1||this._hasVelocity()},m.prototype._updateVelocity=function(){this._worldVelocityDirectionVectorValid=!1,this._updateShouldAnimate()},m.prototype.setRelativeSize=function(t){this._relativeSize=t,this._calculateSize()},m.prototype.setVelocityVector=function(t){this._velocityVector=t,this._updateVelocity()},m.prototype.setVelocity=function(t,e,i){this._velocityVector[0]=t,this._velocityVector[1]=e,this._velocityVector[2]=i,this._updateVelocity()},m.prototype.setVelocityM=function(t){this._velocityVector[0]=t[12],this._velocityVector[1]=t[13],this._velocityVector[2]=t[14],this._updateVelocity()},m.prototype.getWorldVelocityDirectionVector=function(){return this._worldVelocityDirectionVectorValid||(e.setProdVec3Mat4(this._worldVelocityDirectionVector,this._velocityVector,this.getModelMatrix()),e.normalize3(this._worldVelocityDirectionVector),this._worldVelocityDirectionVectorValid=!0),this._worldVelocityDirectionVector},m.prototype.invalidateWorldVelocityDirectionVector=function(){this._worldVelocityDirectionVectorValid=!1},m.prototype.setAnimationTime=function(t){this._currentStateIndex=0,this._timeSinceLastTransition=0,this.performAnimate(t)},m.prototype.addToContext=function(t){l.prototype.addToContext.call(this,t),this._model.addToContext(t,!1)},m.prototype.getRenderQueueBits=function(t,e){return this._visible?l.prototype.getRenderQueueBits.call(this,t,e):A.NONE},m.prototype.performRender=function(t){this._model.render(t.context,!1)},m.prototype._peformRenderInstances=function(t,e){this._model.renderInstances(t,!1,void 0,void 0,e)},m.prototype.mightBeRenderedToShadowMap=function(){return!1},m.prototype.shouldAnimate=function(t){return!!l.prototype.shouldAnimate.call(this,t)&&this._shouldAnimate},m.prototype.performAnimate=function(t){var i,s,n;if(this._states.length>1){for(this._timeSinceLastTransition+=t,i=(this._currentStateIndex+1)%this._states.length;this._timeSinceLastTransition>this._states[i].timeToReach;){if(0===i&&!this._looping)return this._size=0,void this.markAsReusable(!0);this._timeSinceLastTransition-=this._states[i].timeToReach,i=(i+1)%this._states.length}for(this._currentStateIndex=0===i?this._states.length-1:i-1,s=this._timeSinceLastTransition/this._states[i].timeToReach,n=0;n<4;n++)this._color[n]=this._states[this._currentStateIndex].color[n]*(1-s)+this._states[i].color[n]*s;this._size=this._states[this._currentStateIndex].size*(1-s)+this._states[i].size*s,this._calculateSize()}this._hasVelocity()&&this.translatev(e.scaled3Aux(this._velocityVector,.001*t))},m.prototype.shouldGoInSameRenderQueueInstanced=function(t){return l.prototype.shouldGoInSameRenderQueueInstanced.call(this,t)&&this._textures===t._textures&&this._model===t._model},E.prototype=new m,E.prototype.constructor=E,E.prototype._calculateSize=function(){return!0},E.prototype.shouldBeRendered=function(t){return a.prototype.shouldBeRendered.call(this,t)},y.prototype=new a,y.prototype.constructor=y,y.prototype.addToContext=function(t){this._color&&(a.prototype.addToContext.call(this,t),this._model.addToContext(t,!0))},y.prototype.setShift=function(t,e,i){this._shift[0]=t,this._shift[1]=e,this._shift[2]=i},y.prototype.fitPositionWithinRange=function(t,e){var i;for(i=0;i<3;i++){for(;this._positionVector[i]>t[12+i]+e;)this._positionVector[i]-=2*e;for(;this._positionVector[i]<t[12+i]-e;)this._positionVector[i]+=2*e}},y.prototype.performRender=function(t){this._model.render(t.context,!0)},y.prototype._peformRenderInstances=function(t,e){this._model.renderInstances(t,!0,!1,void 0,e)},y.prototype.mightBeRenderedToShadowMap=function(){return!1},y.prototype.shouldAnimate=function(){return!1},y.prototype.shouldGoInSameRenderQueueInstanced=function(t){return a.prototype.shouldGoInSameRenderQueueInstanced.call(this,t)&&this._color===t._color&&this._range===t._range},I.prototype=new a,I.prototype.constructor=I,I.prototype.init=function(t,e,s,n,o,l,h,u,c,_){a.prototype.init.call(this,e,!1,!0),this.setTextures(s),this._model=t,this._position=n,this._color=h,this._size=o,this._scaleMode=r(l),i.setRotation2(this._rotationMatrix,Math.radians(u||0)),this._clipCoordinates=c||j.slice(),this._clipColor=_||[0,0,0,0]},I.prototype.addToContext=function(t){a.prototype.addToContext.call(this,t),this._model.addToContext(t,!1)},I.prototype.performRender=function(t){this._model.render(t.context)},I.prototype.setPosition=function(t){this._position=t},I.prototype.setSize=function(t){this._size=t},I.prototype.setColor=function(t){this._color=t},I.prototype.setAngle=function(t){i.setRotation2(this._rotationMatrix,t)},I.prototype.setClipCoordinates=function(t){this._clipCoordinates=t},I.prototype.clipX=function(t,e){this._clipCoordinates[0]=t,this._clipCoordinates[1]=e},I.prototype.clipY=function(t,e){this._clipCoordinates[2]=1-e,this._clipCoordinates[3]=1-t},I.prototype.setClipColor=function(t){this._clipColor=t},I.prototype.setModel=function(t){this._model=t},I.prototype.setScaleMode=function(t){this._scaleMode=r(t)},{RenderQueueBits:A,UNIFORM_COLOR_NAME:R,CLIP_COORDINATES_NO_CLIP:j,RenderableObject:a,RenderableObject3D:l,CubemapSampledFVQ:h,ShadedLODMesh:u,ParameterizedMesh:c,Billboard:_,Trail:d,TrailSegment:p,ParticleState:g,Particle:m,staticParticle:T,initDynamicParticle:f,dynamicParticle:S,BackgroundBillboard:E,PointParticle:y,UIElement:I}}),define("modules/scene/scene-graph",["utils/utils","utils/types","utils/vectors","utils/matrices","modules/application","modules/managed-gl","modules/egom-model","modules/containers","modules/scene/camera","modules/scene/renderable-objects"],function(t,e,i,s,n,o,r,a,l,h){"use strict";function u(t,e,i,s,n){this.maxEnabledLOD=t,this.thresholds=e,this.compensateForObjectSize=!0===i,this.referenceSize=s||p,this.minimumRelativeSize=n||g}function c(t,e,i,s,n,o,r,a,l,h,u,c){this.context=t,this.depthMask=e,this.scene=i,this.parent=s,this.camera=n,this.viewportWidth=o,this.viewportHeight=r,this.lodContext=a,this.dt=l||0,this.useInstancing=h||!1,this.instanceQueueIndex=u,this.light=c}function _(t,e,i,s){this._renderableObject=t,t.setNode(this),this._scene=null,this._parent=null,this._subnodes=new a.DirectDoubleLinkedList,this._visible=!0,this._renderParameters=new c,this._cameraConfigurations=[],this._isRenderedToShadowMap=!1!==e,this._hasInstancedSubnodes=i,this._minimumCountForInstancing=s||0,this._canBeReused=!1,this.next=null,this.previous=null,this.list=null}function d(t,e,i,n,r,a,h,u,c,_,d,p,g,m){this._left=t,this._bottom=e,this._width=i,this._height=n,this._shouldClearColorOnRender=r,this._clearColorMask=a,this._clearColor=h,this._shouldClearDepthOnRender=u,this._rootBackgroundNode=null,this._rootNode=null,this._rootUINode=null,this._objectsToMove=null,this._ambientColor=[0,0,0],this._directionalLights=[],this._maxRenderedDirectionalLights=_||0,this._renderedDirectionalLights=0,this._directionalLightUniformData=new Array(this._maxRenderedDirectionalLights),this._pointLightPriorityArrays=null,this._maxRenderedPointLights=d||0,this._renderedPointLights=0,this._pointLightUniformData=new Array(this._maxRenderedPointLights),this._spotLights=[],this._maxRenderedSpotLights=p||0,this._renderedSpotLights=0,this._spotLightUniformData=new Array(this._maxRenderedSpotLights),this._rootResourceNode=null,this._resourceObjectIDs=null,this._camera=new l.Camera(this,this._width/this._height,g.useVerticalValues,g.viewDistance,g.configuration||l.getFreeCameraConfiguration(g.fps,g.positionMatrix||s.IDENTITY4,g.orientationMatrix||s.IDENTITY4,g.fov,g.fovRange&&g.fovRange[0]||g.fov,g.fovRange&&g.fovRange[1]||g.fov,g.span),g.transitionDuration,g.transitionStyle),this._lodContext=c,this._shadowMappingEnabled=!1,this._shadowMappingShader=null,this._shadowMapTextureSize=0,this._shadowMapRanges=new Float32Array([]),this._shadowMapDepthRatio=0,this._numShadowMapSamples=0,this._shadowMapSampleOffsets=[],this._uniformValueFunctions={},this._cameraUniformValueFunctions={},this._constantUniformValueFunctions={},this._stereoscopicUniformValueFunctions={},this._stereoscopicTextureUnit=0,this._stereoscopicUniformValueFunctions[o.getUniformName(o.getTextureUniformRawName(S))]=function(){return this._stereoscopicTextureUnit}.bind(this),this._shadowMapDebugUniformValueFunctions={},this._shadowMapTextureUnit=0,this._shadowMapDebugUniformValueFunctions[o.getUniformName(T)]=function(){return this._shadowMapTextureUnit}.bind(this),this._contextUniformValueFunctions=[],this._contextConstantUniformValueFunctions=[],this._shouldAnimate=!0,this._shouldUpdateCamera=!0,this._contexts=[],this._distanceRendering=void 0===m||m,this._renderQueues=this._distanceRendering?[[],[],[],[]]:[[],[]],this._shadowQueue=null,this._uniformsUpdatedForFrame=!1,this._uniformsUpdated=new Set,this._cameraUniformsUpdated=new Set,this._constantUniformsUpdated=new Set,this._initNodes(),this.clearPointLights(),this._setGeneralUniformValueFunctions()}var p=100,g=.05,m=[0,0,1,0,0,1,-1,0,0,-1,1,1,1,-1,-1,1,-1,-1],f=[!0,!0,!0,!0],S="stereo",T="shadowMapDebug";return _.prototype.canBeReused=function(){var t;if(this._canBeReused)return!0;if(this._renderableObject.canBeReused()){for(t=this._subnodes.getFirst();t;t=t.next)if(!1===t.canBeReused())return!1;return this._canBeReused=!0,!0}return!1},_.prototype.setScene=function(t,e){var i;for(this._scene=t,t&&e&&t.addObjectToContexts(this._renderableObject),i=this._subnodes.getFirst();i;i=i.next)i.setScene(t,e)},_.prototype.addToRenderQueue=function(t){var e;if(0===this._minimumCountForInstancing){for(e=0;e<t.length;e++)if(t[e].length>0&&0===t[e][0]._minimumCountForInstancing&&this._renderableObject.shouldGoInSameRenderQueue(t[e][0]._renderableObject))return t[e].push(this),e}else for(e=0;e<t.length;e++)if(t[e].length>0&&t[e][0]._minimumCountForInstancing>0&&this._renderableObject.shouldGoInSameRenderQueueInstanced(t[e][0]._renderableObject))return t[e].push(this),e;return t.push([this]),t.length-1},_.prototype.animateAndAddToRenderQueues=function(t,e,i,s,n){var o,r,a,l,u,c,_;if(this._visible&&(this._renderableObject.resetForNewFrame&&this._renderableObject.resetForNewFrame(),this._scene.shouldAnimate()&&this._renderableObject.animate(s),!this._renderableObject.canBeReused()&&(u=this._renderableObject._isRenderedWithoutDepthMask,c=this._renderableObject._isRenderedWithDepthMask,(u||c)&&(e?(o=this._renderableObject.getRenderQueueBits(i,n),o&h.RenderQueueBits.FRONT_QUEUE_BIT&&(u&&this.addToRenderQueue(t[1]),c&&this.addToRenderQueue(t[0])),o&h.RenderQueueBits.DISTANCE_QUEUE_BIT&&(u&&this.addToRenderQueue(t[3]),c&&this.addToRenderQueue(t[2]))):(u&&this.addToRenderQueue(t[1]),c&&this.addToRenderQueue(t[0]))),this._subnodes._length>0)))if(void 0===o&&(o=e?this._renderableObject.getRenderQueueBits(i,n):h.RenderQueueBits.FRONT_QUEUE_BIT),!this._hasInstancedSubnodes||this._subnodes._length<this._subnodes.getFirst()._minimumCountForInstancing)for(r=this._subnodes.getFirst();r;r=a)a=r.next,r.animateAndAddToRenderQueues(t,e,i,s,o);else{if(this._scene.shouldAnimate())for(r=this._subnodes.getFirst();r;r=a)a=r.next,_=r._renderableObject,_.animate(s),_.resetForNewFrame&&_.resetForNewFrame();else for(r=this._subnodes.getFirst();r;r=a)a=r.next,_=r._renderableObject,_.resetForNewFrame&&_.resetForNewFrame();r=this._subnodes.getFirst(),r&&(u=r._renderableObject._isRenderedWithoutDepthMask,c=r._renderableObject._isRenderedWithDepthMask,(u||c)&&(o=r._renderableObject.getRenderQueueBits(i,o),o&h.RenderQueueBits.FRONT_QUEUE_BIT&&(u&&(l=r.addToRenderQueue(t[1]),t[1][l].pop(),this._subnodes.appendToArray(t[1][l])),c&&(l=r.addToRenderQueue(t[0]),t[0][l].pop(),this._subnodes.appendToArray(t[0][l]))),o&h.RenderQueueBits.DISTANCE_QUEUE_BIT&&(u&&(l=r.addToRenderQueue(t[3]),t[3][l].pop(),this._subnodes.appendToArray(t[3][l])),c&&(l=r.addToRenderQueue(t[2]),t[2][l].pop(),this._subnodes.appendToArray(t[2][l])))))}},_.prototype.setParent=function(t){this._parent=t,this.setScene(t._scene),this._renderableObject.setParent&&this._renderableObject.setParent(t._renderableObject)},_.prototype.isVisible=function(){return this._visible&&(!this._parent||this._parent.isVisible())},_.prototype.show=function(){this._visible=!0},_.prototype.hide=function(){this._visible=!1},_.prototype.toggleVisibility=function(){this._visible=!this._visible},_.prototype.addSubnode=function(t,e){return this._subnodes.add(t),t.setParent(this),this._scene&&t.setScene(this._scene,e),t},_.prototype.getFirstSubnode=function(){return this._subnodes.getFirst()},_.prototype.getNextSubnode=function(t){return this._subnodes.getNext(t)},_.prototype.getPreviousSubnode=function(t){return this._subnodes.getPrevious(t)},_.prototype.addCameraConfiguration=function(t){this._cameraConfigurations.push(t)},_.prototype.hasCameraConfiguration=function(t){var e;for(e=0;e<this._cameraConfigurations.length;e++)if(this._cameraConfigurations[e]===t)return!0;return!1},_.prototype.getNextCameraConfiguration=function(t){var e,i,s=this._cameraConfigurations.length;if(s<=0)return null;if(t){for(e=0;e<s;e++)if(this._cameraConfigurations[e]===t){i=e;break}if(e>=s)return}else i=-1;for(e=(i+1)%s;e!==i&&this._cameraConfigurations[e].shouldExcludeFromCycle();)e=(e+1)%s;return this._cameraConfigurations[e]},_.prototype.getPreviousCameraConfiguration=function(t){var e,i,s=this._cameraConfigurations.length;if(s<=0)return null;if(t){for(e=s-1;e>=0;e--)if(this._cameraConfigurations[e]===t){i=e;break}if(e<0)return}else i=s;for(e=(i+s-1)%s;e!==i&&this._cameraConfigurations[e].shouldExcludeFromCycle();)e=(e+s-1)%s;return this._cameraConfigurations[e]},_.prototype.getCameraConfigurationsWithName=function(t){var e,i=[];for(e=0;e<this._cameraConfigurations.length;e++)this._cameraConfigurations[e]._name===t&&i.push(this._cameraConfigurations[e]);return i},_.prototype.resetCameraConfigurations=function(){var t;for(t=0;t<this._cameraConfigurations.length;t++)this._cameraConfigurations[t].resetToDefaults()},_.prototype.setRenderParameters=function(t,e,i,s,n,o,r){var a=this._renderParameters;a.context=t,a.depthMask=s,a.scene=this._scene,a.parent=this._parent?this._parent._renderableObject:null,a.camera=this._scene._camera,a.viewportWidth=e,a.viewportHeight=i,a.lodContext=this._scene._lodContext,a.useInstancing=n,a.instanceQueueIndex=o,a.light=r},_.prototype.render=function(t,e,i,s,n,o,r,a){var l,h;if(this._visible){if(!a&&this._renderableObject.resetForNewFrame&&this._renderableObject.resetForNewFrame(),this._renderableObject.mightBeRendered()?(this.setRenderParameters(t,e,i,s,o,r),h=this._renderableObject.render(this._renderParameters)):h=!1,!n)for(l=this._subnodes.getFirst();l;l=l.next)l.render(t,e,i,s,n,o,r,a);return h}return!1},_.prototype.prepareForInstancedRender=function(t,e,i){this._renderableObject.prepareForInstancedRender(t,this._scene,e,i)},_.prototype.renderInstances=function(t,e,i){this._renderableObject.renderInstances(t,e,i)},_.prototype.renderToShadowMap=function(t,e,i,s){var n,o;if(this._visible&&this._isRenderedToShadowMap){for(this._renderableObject.mightBeRenderedToShadowMap()?(this.setRenderParameters(t,e,i,!0,void 0,void 0,s),o=this._renderableObject.renderToShadowMap(this._renderParameters)):o=!1,n=this._subnodes.getFirst();n;n=n.next)n.renderToShadowMap(t,e,i,s);return o}return!1},_.prototype.execute=function(t){var e;for(t(this._renderableObject),e=this._subnodes.getFirst();e;e=e.next)e.execute(t)},_.prototype.addToContext=function(t){var e;for(this._renderableObject.addToContext(t),e=this._subnodes.getFirst();e;e=e.next)e.addToContext(t)},_.prototype.getShader=function(){return this._renderableObject.getShader()},_.prototype.setShader=function(t){var e;for(this._renderableObject.setShader(t),e=this._subnodes.getFirst();e;e=e.next)e.setShader(t)},_.prototype.markAsReusable=function(t){var e,i;for(this._renderableObject.markAsReusable(t),e=this._subnodes.getFirst();e;e=i)i=e.next,e.markAsReusable(t);this._canBeReused=!0,t&&this._parent&&this._parent.removeSubnode(this,!0)},_.prototype.handleObjectBecameReusable=function(t){t&&this._parent&&0===this._subnodes._length&&this._parent.removeSubnode(this,!0)},_.prototype.cleanUp=function(){var t,e;for(t=this._subnodes.getFirst();t;)e=t.next,t.canBeReused()&&this._subnodes.remove(t),t=e;for(t=this._subnodes.getFirst();t;t=t.next)t.cleanUp()},_.prototype.removeSubnode=function(t,e){this._subnodes.remove(t),e&&0===this._subnodes._length&&this._renderableObject.canBeReused()&&this._parent&&this._parent.removeSubnode(this,!0)},_.prototype.removeSubnodes=function(t){this._subnodes.clear(t)},_.prototype.destroy=function(){var t,e;if(this._renderableObject.setNode(null),this._renderableObject=null,this._scene=null,this._parent=null,this._subnodes){for(t=this._subnodes.getFirst();t;t=e)e=t.next,t.destroy(),t=null;this._subnodes=null}this._renderParameters=null,this._cameraConfigurations=null,this.next=null,this.previous=null,this.list=null},d.StereoscopicMode={NONE:"none",ANAGLYPH:"anaglyph",SIDE_BY_SIDE:"sideBySide"},d.prototype.setClearColor=function(t){this._clearColor=t},d.prototype.setAmbientColor=function(t){this._ambientColor=t},d.prototype._setGeneralUniformValueFunctions=function(){this.setUniformValueFunction("ambientColor",function(){return this._ambientColor}),this.setUniformValueFunction("numDirLights",function(){return this._renderedDirectionalLights}),this.setUniformValueFunction("dirLights",function(){return this._directionalLightUniformData}),this.setUniformValueFunction("numPointLights",function(){return this._renderedPointLights}),this.setUniformValueFunction("pointLights",function(){return this._pointLightUniformData}),this.setUniformValueFunction("numSpotLights",function(){return this._renderedSpotLights}),this.setUniformValueFunction("spotLights",function(){return this._spotLightUniformData}),this.setCameraUniformValueFunction("cameraMatrix",function(){return this._camera.getViewMatrix()}),this.setCameraUniformValueFunction("cameraOrientationMatrix",function(){return this._camera.getInverseOrientationMatrix()}),this.setCameraUniformValueFunction("aspect",function(){return this._camera.getAspect()}),this.setCameraUniformValueFunction("projMatrix",function(){return this._camera.getProjectionMatrix()}),this.setCameraUniformValueFunction("viewProjMatrix",function(){return s.prod4Aux(this._camera.getViewMatrix(),this._camera.getProjectionMatrix())}),this.setCameraUniformValueFunction("eyePos",function(){return i.floatVector3Aux(this._camera.getCameraPositionVector())})},d.prototype._setContextUniformValueFunctions=function(t){var e=this._contexts[t].gl,i=[0,0];this.setContextUniformValueFunction(t,"viewportSize",function(){return i[0]=e.drawingBufferWidth*this._width,i[1]=e.drawingBufferHeight*this._height,i})},d.prototype._setShadowMappedShaderUniformValueFunctions=function(t){var e;if(0===t&&(this.setConstantUniformValueFunction("numRanges",function(){return this._shadowMapRanges.length}),this.setConstantUniformValueFunction("shadowMapRanges",function(){return this._shadowMapRanges}),this.setConstantUniformValueFunction("shadowMapDepthRatio",function(){return this._shadowMapDepthRatio}),this.setConstantUniformValueFunction("shadowMapTextureSize",function(){return this._shadowMapTextureSize}),this.setConstantUniformValueFunction("shadowMapSampleOffsets",function(){return this._shadowMapSampleOffsets})),void 0!==t)this.setContextConstantUniformValueFunction(t,"shadowMaps",function(){var e,i,s=[];for(e=0;e<this._directionalLights.length&&e<this._maxRenderedDirectionalLights;e++)for(i=0;i<this._shadowMapRanges.length;i++)s.push(this._contexts[t].getFrameBuffer(this._directionalLights[e].getShadowMapBufferName(i)).getLastTextureBindLocation(this._contexts[t]._name));return new Int32Array(s)});else for(e=0;e<this._contexts.length;e++)this._setShadowMappedShaderUniformValueFunctions(e)},d.prototype._updateStaticLightUniformData=function(){var t;for(this._renderedDirectionalLights=Math.min(this._directionalLights.length,this._maxRenderedDirectionalLights),t=0;t<this._renderedDirectionalLights;t++)this._directionalLightUniformData[t]=this._directionalLights[t].getUniformData();t<this._maxRenderedDirectionalLights&&(this._directionalLightUniformData[t]=null)},d.prototype._clearDynamicLightUniformData=function(){this._renderedPointLights=0,this._pointLightUniformData[0]=null,this._renderedSpotLights=0,this._spotLightUniformData[0]=null},d.prototype._updateDynamicLightUniformData=function(t){var e,i,s,n;for(e=0,s=0;e<this._pointLightPriorityArrays.length;e++){for(i=0;i<this._pointLightPriorityArrays[e].length&&s<this._maxRenderedPointLights;i++)this._pointLightPriorityArrays[e][i].isVisible()&&(this._pointLightPriorityArrays[e][i].update(t),this._pointLightPriorityArrays[e][i].shouldBeRendered(this._camera)&&(this._pointLightUniformData[s]=this._pointLightPriorityArrays[e][i].getUniformData(),s++));for(;i<this._pointLightPriorityArrays[e].length;)this._pointLightPriorityArrays[e][i].isVisible()&&this._pointLightPriorityArrays[e][i].updateState(t),i++}for(this._renderedPointLights=s,s<this._maxRenderedPointLights&&(this._pointLightUniformData[s]=null),s=0,e=0,n=Math.min(this._spotLights.length,this._maxRenderedSpotLights);e<this._spotLights.length&&s<n;e++)this._spotLights[e].update(t),this._spotLights[e].shouldBeRendered(this._camera)&&(this._spotLightUniformData[s]=this._spotLights[e].getUniformData(),s++);for(;e<this._spotLights.length;)this._spotLights[e].updateState(t),e++;this._renderedSpotLights=s,s<this._maxRenderedSpotLights&&(this._spotLightUniformData[s]=null)},d.prototype._getShadowMapBufferNamePrefix=function(t){return"shadow-map-buffer-"+t+"-"},d.prototype._getWidthInPixels=function(t){return t.gl.drawingBufferWidth*this._width},d.prototype._getHeightInPixels=function(t){return t.gl.drawingBufferHeight*this._height},d.prototype._setupContext=function(t){var e,i;if(this._constantUniformsUpdated.clear(),void 0!==t)for(i=this._contexts[t],this._setContextUniformValueFunctions(t),this._shadowMappingEnabled&&(i.addShader(this._shadowMappingShader),this._setShadowMappedShaderUniformValueFunctions(t)),e=0;e<this._directionalLights.length&&e<this._maxRenderedDirectionalLights;e++)this._directionalLights[e].addToContext(this._contexts[t],this._shadowMappingEnabled,this._getShadowMapBufferNamePrefix(e),this._shadowMapRanges.length,this._shadowMapTextureSize);else for(e=0;e<this._contexts.length;e++)this._setupContext(e)},d.prototype.setRelativeViewport=function(t,e,i,s){this._left=t,this._bottom=e,this._width=i,this._height=s},d.prototype.addToContext=function(t){var e=this._contexts.findIndex(function(e){return e._name===t._name});e<0&&(this._contexts.push(t),e=this._contexts.length-1),this._setupContext(e),this._rootBackgroundNode.addToContext(t),this._rootNode.addToContext(t),this._rootUINode.addToContext(t),this._rootResourceNode.addToContext(t)},d.prototype.enableShadowMapping=function(){this._shadowMappingShader&&this._shadowMapRanges.length>0?(this._shadowMappingEnabled=!0,this._setupContext()):n.showError("Cannot enable shadow mapping, as no shadow mapping shader or no shadow mapping ranges were specified")},d.prototype.disableShadowMapping=function(){this._shadowMappingEnabled=!1},d.prototype.toggleShadowMapping=function(){this._shadowMappingEnabled=!this._shadowMappingEnabled,this._shadowMappingEnabled?this.enableShadowMapping():this.disableShadowMapping()},d.prototype.setShadowMapRanges=function(t){this._shadowMapRanges=new Float32Array(t),this._setupContext()},d.prototype.setShadowMapping=function(t){t?(this._shadowMappingEnabled=void 0!==t.enable?t.enable:this._shadowMappingEnabled,this._shadowMappingShader=t.shader||this._shadowMappingShader,this._shadowMapTextureSize=t.textureSize||this._shadowMapTextureSize,this._shadowMapRanges=t.ranges?new Float32Array(t.ranges):this._shadowMapRanges,this._shadowMapDepthRatio=t.depthRatio||this._shadowMapDepthRatio,this._numShadowMapSamples=t.numSamples?e.getNumberValueInRange("shadowMappingParams.numSamples",t.numSamples,this._shadowMappingEnabled?1:0,this._shadowMappingEnabled?m.length/2:0,this._shadowMappingEnabled?1:0):t.numSamples,this._shadowMapSampleOffsets=m.slice(0,2*this._numShadowMapSamples),t.deferSetup||this._setupContext()):(this._shadowMappingEnabled=!1,this._shadowMappingShader=null,this._shadowMapTextureSize=0,this._shadowMapRanges=new Float32Array([]),this._shadowMapDepthRatio=0,this._numShadowMapSamples=0,this._shadowMapSampleOffsets=[]),this._constantUniformsUpdated.clear()},d.prototype.shouldAnimate=function(){return this._shouldAnimate},d.prototype.setShouldAnimate=function(t){this._shouldAnimate=t},d.prototype.setShouldUpdateCamera=function(t){this._shouldUpdateCamera=t},d.prototype.addBackgroundObject=function(t){var e=new _(t,!1);return this._rootBackgroundNode.addSubnode(e),e},d.prototype.addObject=function(t,e,i){var s=t.getNode()||new _(t,e,!1,i);return this._rootNode.addSubnode(s),s},d.prototype.addNode=function(t){return this._rootNode.addSubnode(t),t},d.prototype.addUIObject=function(t){var e=new _(t,!1);return this._rootUINode.addSubnode(e),e},d.prototype.addObjectToContexts=function(t){var e;for(e=0;e<this._contexts.length;e++)t.addToContext(this._contexts[e])},d.prototype.addObjectToMove=function(t){this._objectsToMove.push(t)},d.prototype.clear=function(t){this.clearNodes(t),this.clearDirectionalLights(),this.clearPointLights(),this.clearSpotLights()},d.prototype._initNodes=function(){this._rootBackgroundNode=new _(new h.RenderableObject3D(null,!1,!1,s.IDENTITY4,s.IDENTITY4,s.IDENTITY4,void 0,0,!1,!0),!1),this._rootBackgroundNode.setScene(this),this._rootNode=new _(new h.RenderableObject3D(null,!1,!1,s.IDENTITY4,s.IDENTITY4,s.IDENTITY4,void 0,0,!1,!0)),this._rootNode.setScene(this),this._rootResourceNode=new _(new h.RenderableObject3D(null,!1,!1,s.IDENTITY4,s.IDENTITY4,s.IDENTITY4,void 0,1,!1,!0),!1),this._rootResourceNode.setScene(this),this._resourceObjectIDs={},this._rootUINode=new _(new h.RenderableObject3D(null,!1,!1,s.IDENTITY4,s.IDENTITY4,s.IDENTITY4,void 0,0,!1,!0),!1),this._rootUINode.setScene(this),this._objectsToMove=[]},d.prototype.clearNodes=function(t){this._rootBackgroundNode&&this._rootBackgroundNode.removeSubnodes(t),this._rootNode&&this._rootNode.removeSubnodes(t),this._rootResourceNode&&this._rootResourceNode.removeSubnodes(t),this._resourceObjectIDs={},this._rootUINode&&this._rootUINode.removeSubnodes(t),this._objectsToMove.length=0},d.prototype.clearDirectionalLights=function(){this._directionalLights=[]},d.prototype.clearPointLights=function(){var t;for(this._pointLightPriorityArrays=new Array(5),
t=0;t<5;t++)this._pointLightPriorityArrays[t]=[]},d.prototype.clearSpotLights=function(){this._spotLights=[]},d.prototype.getAllObjects=function(){var t,e=[],i=this._rootNode._subnodes;for(t=i.getFirst();t;t=t.next)e.push(t._renderableObject);return e},d.prototype.getAll3DObjects=function(){var t,e,i=[],s=this._rootNode._subnodes;for(e=s.getFirst();e;e=e.next)t=e._renderableObject,t.getPositionMatrix&&t.getOrientationMatrix&&i.push(t);return i},d.prototype.moveAllObjectsByVector=function(t){var e,i,s,n=this._rootNode._subnodes;for(s=n.getFirst();s;s=s.next)i=s._renderableObject,i.translatev&&i.translatev(t);for(e=0;e<this._objectsToMove.length;e++)this._objectsToMove[e].translatev(t)},d.prototype.moveCameraToOrigoIfNeeded=function(t){var e=this._camera.moveToOrigoIfNeeded(t);return e&&this.moveAllObjectsByVector(e),e},d.prototype.getFirstNode=function(){return this._rootNode.getFirstSubnode()},d.prototype.getNextNode=function(t){return this._rootNode.getNextSubnode(t)},d.prototype.getPreviousNode=function(t){return this._rootNode.getPreviousSubnode(t)},d.prototype.hasResourcesOfObject=function(t){return!!this._resourceObjectIDs[t]},d.prototype.addResourcesOfObject=function(t,e){var i;e&&this._resourceObjectIDs[e]||(t&&(i=new _(t,!1),this._rootResourceNode.addSubnode(i,!0),i.markAsReusable(!1)),e&&(this._resourceObjectIDs[e]=!0))},d.prototype.addDirectionalLightSource=function(t){this._directionalLights.push(t)},d.prototype.addPointLightSource=function(t,e){e=Math.min(e||0,4),this._pointLightPriorityArrays[e].push(t)},d.prototype.addSpotLightSource=function(t){this._spotLights.push(t)},d.prototype.getLODContext=function(){return this._lodContext},d.prototype.setUniformValueFunction=function(t,e){this._uniformValueFunctions[o.getUniformName(t)]=e.bind(this)},d.prototype.setCameraUniformValueFunction=function(t,e){this._cameraUniformValueFunctions[o.getUniformName(t)]=e.bind(this)},d.prototype.setConstantUniformValueFunction=function(t,e){this._constantUniformValueFunctions[o.getUniformName(t)]=e.bind(this)},d.prototype.setContextUniformValueFunction=function(t,e,i){this._contextUniformValueFunctions[t]||(this._contextUniformValueFunctions[t]={}),this._contextUniformValueFunctions[t][o.getUniformName(e)]=i.bind(this)},d.prototype.setContextConstantUniformValueFunction=function(t,e,i){this._contextConstantUniformValueFunctions[t]||(this._contextConstantUniformValueFunctions[t]={}),this._contextConstantUniformValueFunctions[t][o.getUniformName(e)]=i.bind(this)},d.prototype.addCameraConfiguration=function(t){this._rootNode.addCameraConfiguration(t)},d.prototype.hasCameraConfiguration=function(t){return this._rootNode.hasCameraConfiguration(t)},d.prototype.getNextCameraConfiguration=function(t){return this._rootNode.getNextCameraConfiguration(t)},d.prototype.getPreviousCameraConfiguration=function(t){return this._rootNode.getPreviousCameraConfiguration(t)},d.prototype.getCameraConfigurationsWithName=function(t){return this._rootNode.getCameraConfigurationsWithName(t)},d.prototype.hideUI=function(){this._rootUINode.hide()},d.prototype.showUI=function(){this._rootUINode.show()},d.prototype.assignUniforms=function(t,e){this._uniformsUpdated.has(e)||(e.assignUniforms(t,this._uniformValueFunctions),e.assignUniforms(t,this._contextUniformValueFunctions[this._contexts.indexOf(t)]),this._uniformsUpdated.add(e),this._uniformsUpdatedForFrame=!0),this._cameraUniformsUpdated.has(e)||(e.assignUniforms(t,this._cameraUniformValueFunctions),this._cameraUniformsUpdated.add(e)),this._constantUniformsUpdated.has(e)||(e.assignUniforms(t,this._constantUniformValueFunctions),e.assignUniforms(t,this._contextConstantUniformValueFunctions[this._contexts.indexOf(t)]),this._constantUniformsUpdated.add(e))},d.prototype.cleanUpLights=function(){var t,e,i,s;for(s=0;s<this._pointLightPriorityArrays.length;s++)for(t=0;t<this._pointLightPriorityArrays[s].length;t++){for(e=t,i=0;e<this._pointLightPriorityArrays[s].length&&(!this._pointLightPriorityArrays[s][e]||!0===this._pointLightPriorityArrays[s][e].canBeReused());)e++,i++;this._pointLightPriorityArrays[s].splice(t,i)}for(t=0;t<this._spotLights.length;t++){for(e=t,i=0;e<this._spotLights.length&&(!this._spotLights[e]||!0===this._spotLights[e].canBeReused());)e++,i++;this._spotLights.splice(t,i)}},d.prototype._renderShadowMap=function(t,e,i,s){var n,r,a=t.gl;if(this._shadowQueue.length>0){for(o.areDepthTexturesAvailable()?a.clear(a.DEPTH_BUFFER_BIT):a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),r=[],n=0;n<this._shadowQueue.length;n++)this._shadowQueue[n].renderToShadowMap(t,e,i,s)&&r.push(this._shadowQueue[n]);this._shadowQueue=r}},d.prototype._renderShadowMaps=function(t,e,i){var s,n,o,r=t.gl;if(this._shadowMappingEnabled){for(r.viewport(0,0,this._shadowMapTextureSize,this._shadowMapTextureSize),r.clearColor(0,0,0,0),t.setColorMask(f),t.disableBlending(),t.setDepthMask(!0),t.setCurrentShader(this._shadowMappingShader),this.assignUniforms(t,this._shadowMappingShader),s=0;s<this._directionalLights.length&&s<this._maxRenderedDirectionalLights;s++){for(this._directionalLights[s].reset(),this._shadowQueue=new Array(this._rootNode._subnodes._length),n=0,o=this._rootNode._subnodes.getFirst();o;o=o.next,n++)this._shadowQueue[n]=o;for(n=this._shadowMapRanges.length-1;n>=0;n--)this._directionalLights[s].startShadowMap(t,this._camera,n,this._shadowMapRanges[n],this._shadowMapRanges[n]*this._shadowMapDepthRatio),this._renderShadowMap(t,e,i,this._directionalLights[s])}for(s=0;s<this._directionalLights.length&&s<this._maxRenderedDirectionalLights;s++)for(n=0;n<this._shadowMapRanges.length;n++)t.bindTexture(t.getFrameBuffer(this._directionalLights[s].getShadowMapBufferName(n)),void 0,!0)}t.setCurrentFrameBuffer(null)},d.prototype._renderBackgroundObjects=function(t,e,i){t.enableBlending(),t.setDepthMask(!1),this._rootBackgroundNode.render(t,e,i,!1)},d.prototype._renderQueue=function(t,e,i,s,n,o){var r,a,l,h=s.length;if(h>0)if((a=s[0]._minimumCountForInstancing)>0&&h>=a&&t.instancingExt){for(l=0,s[0].prepareForInstancedRender(t,n,h),r=0;r<h;r++)s[r].render(t,e,i,o,!0,!0,n,!0)&&l++;l>0&&s[0].renderInstances(t,n,l)}else for(r=0;r<h;r++)s[r].render(t,e,i,o,!0,void 0,void 0,!0)},d.prototype._renderMainObjects=function(t,e,i,s,n,o){var r;if(s.length>0)for(t.setDepthMask(!0),t.disableBlending(),r=0;r<s.length;r++)this._renderQueue(t,e,i,s[r],r,!0);if(o&&this._renderBackgroundObjects(t,e,i),n.length>0)for(t.setDepthMask(!1),t.enableBlending(),r=0;r<n.length;r++)this._renderQueue(t,e,i,n[r],r,!1)},d.prototype._renderUIObjects=function(t,e,i){var s,n=t.gl;this._rootUINode.isVisible()&&this._rootUINode._subnodes._length>0&&(s=this._camera,this._distanceRendering&&(this._camera=this._camera.getExtendedCamera(!0)),t.enableBlending(),n.disable(n.DEPTH_TEST),t.setDepthMask(!1),this._rootUINode.render(t,e,i,!1),n.enable(n.DEPTH_TEST),this._camera=s)},d.prototype._render=function(t,e,i,s,n,o){var r,a,l=t.gl;this._shouldClearColorOnRender&&(t.setColorMask(this._clearColorMask),l.clearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3])),t.setDepthMask(!0),r=this._shouldClearColorOnRender?l.COLOR_BUFFER_BIT:0,r=this._shouldClearDepthOnRender?r|l.DEPTH_BUFFER_BIT:r,l.clear(r),e&&(a=this._camera,this._camera=this._camera.getExtendedCamera(),this._cameraUniformsUpdated.clear(),this._clearDynamicLightUniformData(),this._renderMainObjects(t,s,n,this._renderQueues[2],this._renderQueues[3],!0),this._camera=a,t.setDepthMask(!0),l.clear(l.DEPTH_BUFFER_BIT),this._cameraUniformsUpdated.clear()),!i&&e||(this._updateDynamicLightUniformData(this._shouldAnimate?o:0),t.getCurrentShader()&&this.assignUniforms(t,t.getCurrentShader()),this._renderMainObjects(t,s,n,this._renderQueues[0],this._renderQueues[1],!e)),this._renderUIObjects(t,s,n)},d.prototype.render=function(t,e){var i,s,n,o=t.gl,r=o.drawingBufferWidth,a=o.drawingBufferHeight,l=r*this._width,h=a*this._height;this._camera.setAspect(l/h),this._shouldUpdateCamera&&this._camera.update(e),this._uniformsUpdated.clear(),this._cameraUniformsUpdated.clear(),n=!1,!1===this._uniformsUpdatedForFrame&&t.getCurrentShader()&&(this._updateStaticLightUniformData(),this.assignUniforms(t,t.getCurrentShader()),n=!0),this._uniformsUpdatedForFrame=!1,this._renderQueues[0].length=0,this._renderQueues[1].length=0,this._distanceRendering&&(this._renderQueues[2].length=0,this._renderQueues[3].length=0),this._rootNode.animateAndAddToRenderQueues(this._renderQueues,this._distanceRendering,this._camera,e),this.cleanUpLights(),i=this._renderQueues[0].length>0||this._renderQueues[1].length>0,s=this._distanceRendering&&(this._renderQueues[2].length>0||this._renderQueues[3].length>0),i&&(this._renderShadowMaps(t,l,h),this._shadowMappingEnabled&&(n=!1)),n||this._updateStaticLightUniformData(),o.viewport(this._left*r,this._bottom*a,l,h),this._render(t,s,i,l,h,e)},{LODContext:u,RenderableNode:_,Scene:d}}),function(){"use strict";Math.sign=Math.sign||function(t){return t=+t,0===t||isNaN(t)?t:t>0?1:-1},Math.log10=Math.log10||function(t){return Math.log(t)/Math.LN10},Math.log2=Math.log2||function(t){return Math.log(t)/Math.LN2},Math.seed=function(t){return function(){return(t=1e4*Math.sin(t))-Math.floor(t)}},Math.radians=function(t){return t*Math.PI/180},Math.degrees=function(t){return 180*t/Math.PI},Number.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},Array.prototype.findIndex=Array.prototype.findIndex||function(t,e){var i;for(i=0;i<this.length;i++)if(t.call(e||t,this[i],i,this))return i;return-1},Array.prototype.find=Array.prototype.find||function(t,e){var i;for(i=0;i<this.length;i++)if(t.call(e||t,this[i],i,this))return this[i]}}(),define("utils/polyfill",function(){}),define("armada/graphics",["utils/matrices","utils/types","modules/application","modules/async-resource","modules/managed-gl","modules/media-resources","modules/scene/scene-graph","armada/constants","utils/polyfill"],function(t,e,i,s,n,o,r,a){"use strict";function l(t,e){var i,s,n=0;for(i in w)w.hasOwnProperty(i)&&(s=w[i],e.hasOwnProperty(s.name)&&(n+=t[s.name]*e[s.name]));return n}function h(t,e){return{requiredVertexUniformVectors:t[F]+l(t[P],e),requiredAttributeVectors:t[V]+l(t[U],e),requiredVaryingVectors:t[B]+l(t[H],e),requiredTextureUnits:t[G]+l(t[j],e),requiredFragmentUniformVectors:t[k]+l(t[W],e)}}function u(t,e){return{requiredVertexUniformVectors:t.requiredVertexUniformVectors+e.requiredVertexUniformVectors,requiredAttributeVectors:t.requiredAttributeVectors+e.requiredAttributeVectors,requiredVaryingVectors:t.requiredVaryingVectors+e.requiredVaryingVectors,requiredTextureUnits:t.requiredTextureUnits+e.requiredTextureUnits,requiredFragmentUniformVectors:t.requiredFragmentUniformVectors+e.requiredFragmentUniformVectors}}function c(t,i,s,n){this._list=t?e.getArrayValue(s||"OrderedNamedNumericOptions.list",t,i,null,{minLength:1},[]):[],this._optionNamePropertyName=i?i.properties.NAME.name:null,this._optionValuePropertyName=i?i.properties.VALUE.name:null,this._list.sort(function(t,e){return t[this._optionValuePropertyName]-e[this._optionValuePropertyName]}.bind(this)),this._currentIndex=this._list.length-1,n&&this.applyLimit(n)}function _(t,e,i){c.call(this,t,v,e,i),this._preferenceList=null,this._preferenceNameList=null,this._updatePreferenceList()}function d(){s.AsyncResource.call(this),this._dataJSON=null,this._antialiasing=!1,this._filtering=null,this._lodLevel=null,this._maxLoadedLOD=0,this._lodContext=null,this._msInLaunchers=!1,this._textureQuality=null,this._cubemapQuality=null,this._shadowMappingEnabled=!1,this._shadowMapQuality=null,this._shadowRanges=null,this._shadowDistances=null,this._shadowDepthRatio=0,this._pointLightAmount=null,this._particleAmount=null,this._dustParticleAmount=null,this._shaderConfig=null,this._shaderComplexity=null,this._luminosityTextureAreAvailable=!1,this._groupTransformIdentityArray=null,this._generalLevels=null,this._currentGeneralLevel=null}function p(){return L.isShadowMappingEnabled()&&L.isShadowMappingAvailable()}function g(){return L.getShader(L.getShadowMappingShaderName())}function m(){return p()?{enable:!0,shader:L.getManagedShader(L.getShadowMappingShaderName()),textureSize:L.getShadowMapTextureSize(),ranges:L.getShadowRanges(),depthRatio:L.getShadowDepthRatio(),numSamples:L.getNumShadowMapSamples()}:null}function f(){return L.getShader(L.getShaderConfig(q.ANAGLYPH_RED_SHADER_NAME))}function S(){return L.getShader(L.getShaderConfig(q.ANAGLYPH_CYAN_SHADER_NAME))}function T(){return L.getShader(L.getShaderConfig(q.SIDE_BY_SIDE_LEFT_SHADER_NAME))}function E(){return L.getShader(L.getShaderConfig(q.SIDE_BY_SIDE_RIGHT_SHADER_NAME))}function y(){return L.getShader(L.getShaderConfig(q.SHADOW_MAP_DEBUG_SHADER_NAME))}function I(){return parseFloat(L.getShaderConfig(q.ANAGLYPH_ORIGINAL_COLOR_RATIO))}function A(){return parseFloat(L.getShaderConfig(q.ANAGLYPH_GAMMA))}function M(){return parseFloat(L.getShaderConfig(q.ANAGLYPH_CYAN_FACTOR))}function C(){return parseFloat(L.getShaderConfig(q.LISPSM_MINIMUM_NEAR))}function N(){return parseFloat(L.getShaderConfig(q.LISPSM_NEAR_FACTOR))}function O(t){pt.push(t)}function R(){var t;for(t=0;t<pt.length;t++)pt[t]()}var L,x=a.LOCAL_STORAGE_PREFIX+"graphics_",v=e.getNameAndValueDefinitionObject("maximumResolution"),b=e.getNameAndValueDefinitionObject("lod"),D={baseType:"object",properties:{LUMINOSITY_FACTOR:{name:"luminosityFactor",type:"number",defaultValue:0},GROUP_TRANSFORM:{name:"groupTransform",type:"number",defaultValue:0},DIR_LIGHT:{name:"dirLight",type:"number",defaultValue:0},POINT_LIGHT:{name:"pointLight",type:"number",defaultValue:0},SPOT_LIGHT:{name:"spotLight",type:"number",defaultValue:0},SHADOW_MAP:{name:"shadowMap",type:"number",defaultValue:0},SHADOW_MAP_RANGE:{name:"shadowMapRange",type:"number",defaultValue:0},SHADOW_MAP_SAMPLE:{name:"shadowMapSample",type:"number",defaultValue:0}}},w=D.properties,F="requiredVertexUniformVectors",P="requiredVertexUniformVectorsPer",V="requiredAttributeVectors",U="requiredAttributeVectorsPer",B="requiredVaryingVectors",H="requiredVaryingVectorsPer",G="requiredTextureUnits",j="requiredTextureUnitsPer",k="requiredFragmentUniformVectors",W="requiredFragmentUniformVectorsPer",X={baseType:"object",properties:{VERTEX_UNIFORM_VECTORS:{name:F,type:"number",defaultValue:0},VERTEX_UNIFORM_VECTORS_PER:{name:P,type:D,defaultValue:{}},ATTRIBUTE_VECTORS:{name:V,type:"number",defaultValue:0},ATTRIBUTE_VECTORS_PER:{name:U,type:D,defaultValue:{}},VARYING_VECTORS:{name:B,type:"number",defaultValue:0},VARYING_VECTORS_PER:{name:H,type:D,defaultValue:{}},TEXTURE_UNITS:{name:G,type:"number",defaultValue:0},TEXTURE_UNITS_PER:{name:j,type:D,defaultValue:{}},FRAGMENT_UNIFORM_VECTORS:{name:k,type:"number",defaultValue:0},FRAGMENT_UNIFORM_VECTORS_PER:{name:W,type:D,defaultValue:{}}}},Y={baseType:"object",properties:{NAME:{name:"name",type:"string"},SHADOW_MAPPING_AVAILABLE:{name:"shadows",type:"boolean"},NUM_SHADOW_MAP_SAMPLES:{name:"numShadowMapSamples",type:"number",defaultValue:0},DYNAMIC_LIGHTS_AVAILABLE:{name:"dynamicLights",type:"boolean"},MAX_DIR_LIGHTS:{name:"maxDirLights",type:"number"},MAX_SPOT_LIGHTS:{name:"maxSpotLights",type:"number",defaultValue:0},LUMINOSITY_TEXTURES_AVAILABLE:{name:"luminosityTextures",type:"boolean"},REVEAL_AVAILABLE:{name:"reveal",type:"boolean"},REQUIREMENTS:{name:"requirements",type:X}}},z=Y.properties,q={FEATURE_REQUIREMENTS:{name:"featureRequirements",type:"object",properties:{SHADOWS:{name:"shadows",type:X},DYNAMIC_LIGHTS:{name:"dynamicLights",type:X},REVEAL:{name:"reveal",type:X}}},COMPLEXITIES:{name:"complexities",type:"array",elementType:Y,minLength:1},SHADOW_MAPPING_SHADER_NAME:{name:"shadowMappingShaderName",type:"string"},MAX_DIR_LIGHTS_DEFINE_NAME:{name:"maxDirLightsDefineName",type:"string"},MAX_POINT_LIGHTS_DEFINE_NAME:{name:"maxPointLightsDefineName",type:"string"},MAX_SPOT_LIGHTS_DEFINE_NAME:{name:"maxSpotLightsDefineName",type:"string"},DUST_LENGTH_DIVISOR:{name:"dustLengthDivisor",type:"string"},DUST_LENGTH_DIVISOR_DEFINE_NAME:{name:"dustLengthDivisorDefineName",type:"string"},MAX_LUMINOSITY_FACTORS:{name:"maxLuminosityFactors",type:"number"},MAX_LUMINOSITY_FACTORS_DEFINE_NAME:{name:"maxLuminosityFactorsDefineName",type:"string"},MAX_GROUP_TRANSFORMS:{name:"maxGroupTransforms",type:"number"},MAX_GROUP_TRANSFORMS_DEFINE_NAME:{name:"maxGroupTransformsDefineName",type:"string"},MAX_SHADOW_MAP_RANGES_DEFINE_NAME:{name:"maxShadowMapRangesDefineName",type:"string"},MAX_SHADOW_MAPS_DEFINE_NAME:{name:"maxShadowMapsDefineName",type:"string"},NUM_SHADOW_MAP_SAMPLES_DEFINE_NAME:{name:"numShadowMapSamplesDefineName",type:"string"},DEPTH_TEXTURES_DEFINE_NAME:{name:"depthTexturesDefineName",type:"string"},MAX_SHININESS:{name:"maxShininess",type:"string"},MAX_SHININESS_DEFINE_NAME:{name:"maxShininessDefineName",type:"string"},LISPSM_MINIMUM_NEAR:{name:"lispsmMinimumNear",type:"string"},LISPSM_MINIMUM_NEAR_DEFINE_NAME:{name:"lispsmMinimumNearDefineName",type:"string"},LISPSM_NEAR_FACTOR:{name:"lispsmNearFactor",type:"string"},LISPSM_NEAR_FACTOR_DEFINE_NAME:{name:"lispsmNearFactorDefineName",type:"string"},ANAGLYPH_RED_SHADER_NAME:{name:"anaglyphRedShaderName",type:"string"},ANAGLYPH_CYAN_SHADER_NAME:{name:"anaglyphCyanShaderName",type:"string"},SIDE_BY_SIDE_LEFT_SHADER_NAME:{name:"sideBySideLeftShaderName",type:"string"},SIDE_BY_SIDE_RIGHT_SHADER_NAME:{name:"sideBySideRightShaderName",type:"string"},SHADOW_MAP_DEBUG_SHADER_NAME:{name:"shadowMapDebugShaderName",type:"string"},ANAGLYPH_ORIGINAL_COLOR_RATIO:{name:"anaglyphOriginalColorRatio",type:"string"},ANAGLYPH_ORIGINAL_COLOR_RATIO_DEFINE_NAME:{name:"anaglyphOriginalColorRatioDefineName",type:"string"},ANAGLYPH_GAMMA:{name:"anaglyphGamma",type:"string"},ANAGLYPH_GAMMA_DEFINE_NAME:{name:"anaglyphGammaDefineName",type:"string"},ANAGLYPH_CYAN_FACTOR:{name:"anaglyphCyanFactor",type:"string"},ANAGLYPH_CYAN_FACTOR_DEFINE_NAME:{name:"anaglyphCyanFactorDefineName",type:"string"}},Q=q.FEATURE_REQUIREMENTS.properties,J=e.getNameAndValueDefinitionObject("numRanges"),K=e.getNameAndValueDefinitionObject("maxLights"),Z=e.getNameAndValueDefinitionObject("particleCountFactor"),$=x+"generalLevel",tt=x+"antialiasing",et=x+"filtering",it=n.TextureFiltering.TRILINEAR,st=x+"textureQuality",nt=x+"cubemapQuality",ot=x+"maxLOD",rt=x+"missilesInLaunchers",at=x+"shaderComplexity",lt=x+"shadowMapping",ht=x+"shadowQuality",ut=x+"shadowDistance",ct=x+"pointLightAmount",_t=x+"particleAmount",dt=x+"dustParticleAmount",pt=[];return c.prototype._getNameFunction=function(t){return t[this._optionNamePropertyName]},c.prototype._checkNameFunction=function(t,e){return e[this._optionNamePropertyName]===t},c.prototype._isWithinLimitFunction=function(t,e){return e[this._optionValuePropertyName]<=t},c.prototype._valueFilterFunction=function(t,e){return t(e[this._optionValuePropertyName])},c.prototype._getInvalidOptionAccessErrorMessage=function(t){return"Invalid option ("+this._optionValuePropertyName+") '"+t+"' specified! Valid values are: "+this.getNameList().join(", ")+"."},c.prototype.getNameList=function(){return this._list.map(this._getNameFunction.bind(this))},c.prototype.getFilteredNameList=function(t){return this._list.filter(this._valueFilterFunction.bind(this,t)).map(this._getNameFunction.bind(this))},c.prototype.setCurrent=function(t,e){return this._currentIndex=this._list.findIndex(this._checkNameFunction.bind(this,t)),this._currentIndex<0&&e&&(this._currentIndex=this._list.length-1),!(this._currentIndex<0)||(i.showError(this._getInvalidOptionAccessErrorMessage(t)),!1)},c.prototype.getCurrentName=function(){return this._currentIndex>=0?this._list[this._currentIndex][this._optionNamePropertyName]:null},c.prototype.getCurrentValue=function(){return this._currentIndex>=0?this._list[this._currentIndex][this._optionValuePropertyName]:0},c.prototype.getValueForName=function(t){var e=this._list.findIndex(this._checkNameFunction.bind(this,t));return e>=0?this._list[e][this._optionValuePropertyName]:(i.showError(this._getInvalidOptionAccessErrorMessage(t)),0)},c.prototype.applyLimit=function(t){this.getCurrentName();this._list=this._list.filter(this._isWithinLimitFunction.bind(this,t)),this._currentIndex>=this._list.length&&(this._currentIndex=this._list.length-1)},c.prototype.decrease=function(){return this._currentIndex>0&&(this._currentIndex--,!0)},c.prototype.setLowest=function(){this._currentIndex=0},c.prototype.getFirstValue=function(){return this._list[0][this._optionValuePropertyName]},_.prototype=new c,_.prototype.constructor=_,_.prototype._updatePreferenceList=function(){var t;for(this._preferenceList=[],t=this._currentIndex;t>=0;t--)this._preferenceList.push(this._list[t]);for(t=this._currentIndex+1;t<this._list.length;t++)this._preferenceList.push(this._list[t]);this._preferenceNameList=this._preferenceList.map(this._getNameFunction.bind(this))},_.prototype.setCurrent=function(t,e){var i;return i=c.prototype.setCurrent.call(this,t,e),this._updatePreferenceList(),i},_.prototype.getPreferenceNameList=function(){return this._preferenceNameList},_.prototype.applyLimit=function(t){c.prototype.applyLimit.call(this,t),this._updatePreferenceList()},d.prototype=new s.AsyncResource,d.prototype.constructor=d,d.prototype._getShaderRequirements=function(t){t=t||{};var e,i=this._getShaderComplexityDescriptor(t.complexityLevelIndex),s=this.getShaderConfig(q.FEATURE_REQUIREMENTS),n=i[z.MAX_DIR_LIGHTS.name],o=void 0===t.numPointLights?this.getMaxPointLights():t.numPointLights,r=o>0?i[z.MAX_SPOT_LIGHTS.name]:0,a=void 0===t.numShadowRanges?this.getNumShadowMapRanges():t.numShadowRanges,l=n*a,c=i[z.NUM_SHADOW_MAP_SAMPLES.name],_={};return _[w.DIR_LIGHT.name]=n,_[w.POINT_LIGHT.name]=o,_[w.SPOT_LIGHT.name]=r,_[w.SHADOW_MAP.name]=l,_[w.SHADOW_MAP_RANGE.name]=a,_[w.SHADOW_MAP_SAMPLE.name]=c,_[w.LUMINOSITY_FACTOR.name]=this.getShaderConfig(q.MAX_LUMINOSITY_FACTORS),_[w.GROUP_TRANSFORM.name]=this.getShaderConfig(q.MAX_GROUP_TRANSFORMS),e=h(i[z.REQUIREMENTS.name],_),i[z.SHADOW_MAPPING_AVAILABLE.name]&&a>0&&(e=u(e,h(s[Q.SHADOWS.name],_))),i[z.DYNAMIC_LIGHTS_AVAILABLE.name]&&o>0&&(e=u(e,h(s[Q.DYNAMIC_LIGHTS.name],_))),i[z.REVEAL_AVAILABLE.name]&&(e=u(e,h(s[Q.REVEAL.name],_))),e},d.prototype._shaderRequirementsAreSatisfied=function(t){return n.requirementsAreSatisfied(this._getShaderRequirements(t))},d.prototype._limitShaderComplexities=function(){var t,e=[],i=this.getShaderConfig(q.COMPLEXITIES);for(t=0;t<i.length;t++)this._shaderRequirementsAreSatisfied({numPointLights:0,numShadowRanges:0,complexityLevelIndex:t})&&e.push(i[t]);this.setShaderConfig(q.COMPLEXITIES,e)},d.prototype._setFallbackShaderComplexity=function(t){var e;for(t&&!this._shaderRequirementsAreSatisfied()&&this._disableShaderFeatures(),e=this.getShaderComplexities().indexOf(this.getShaderComplexity());e>0&&!this._shaderRequirementsAreSatisfied({complexityLevelIndex:e});)e--;this.setShaderComplexity(this.getShaderComplexities()[e],!1)},d.prototype.loadConfigurationFromJSON=function(i){var s,o,a,l;for(this._shaderConfig=e.getVerifiedObject("config.graphics.shaders",i.shaders,q),this._limitShaderComplexities(),this._textureQuality=new _(i.context.textureQualities,"config.graphics.context.textureQualities",n.getMaxTextureSize()),this._cubemapQuality=new _(i.context.cubemapQualities,"config.graphics.context.cubemapQualities",n.getMaxCubemapSize()),this._shadowMapQuality=new _(i.context.shadows.qualities,"config.graphics.context.shadows.qualities",n.getMaxRenderbufferSize()),this._shadowRanges=e.getArrayValue("config.graphics.context.shadows.ranges",i.context.shadows.ranges,"number",null,{minLength:1}),this._shadowDistances=new c(i.context.shadows.distances,J,"config.graphics.context.shadows.distances",this._shadowRanges.length),this._shadowDepthRatio=e.getNumberValue("config.graphics.context.shadows.depthRatio",i.context.shadows.depthRatio),this._pointLightAmount=new c(i.context.pointLightAmounts,K,"config.graphics.context.pointLightAmounts"),this._particleAmount=new c(i.context.particleAmounts,Z,"config.graphics.context.particleAmounts"),this._dustParticleAmount=new c(i.context.dustParticleAmounts,Z,"config.graphics.context.dustParticleAmounts"),this._lodLevel=new c(i.levelOfDetailSettings.lodLevels,b,"config.graphics.levelOfDetailSettings.lodLevels"),l=new Array(i.levelOfDetailSettings.lodDisplayProfile.limits.length+1),l[0]=0,s=0,o=i.levelOfDetailSettings.lodDisplayProfile.limits.length;s<o;s++)a=i.levelOfDetailSettings.lodDisplayProfile.limits[s],l[this._lodLevel.getValueForName(a.level)+1]=a.objectSizeLessThan;for(this._lodContext=new r.LODContext(this._lodLevel.getFirstValue(),l,i.levelOfDetailSettings.lodDisplayProfile.compensateForObjectSize,i.levelOfDetailSettings.lodDisplayProfile.referenceSize,i.levelOfDetailSettings.lodDisplayProfile.minimumRelativeSize),this._generalLevels=i.generalLevels,this._groupTransformIdentityArray=new Float32Array(16*this.getShaderConfig(q.MAX_GROUP_TRANSFORMS)),s=0;s<this._groupTransformIdentityArray.length;s++)this._groupTransformIdentityArray[s]=t.IDENTITY4[s%16]},d.prototype._limitSettingByScreenSize=function(t,e,i,s,n){var o,r,a,l;if(!0===t.autoLimitByScreenSize)for(o=Math.max(screen.width,screen.height),r=0,a=t.limits.length;r<a;r++)l=t.limits[r],o<l.screenSizeLessThan&&i()>e.getValueForName(l[n])&&s(l[n],!1)},d.prototype.loadSettingsFromJSON=function(t,s){s=s||!1,s||(this._dataJSON=t),"object"==typeof t.shaders?this.setShaderComplexity(t.shaders.complexity,!1,!0):i.showError("Missing required settings.graphics.shaders from the setting definition object!"),"object"==typeof t.context?(this.setAntialiasing(e.getBooleanValue(t.context.antialiasing,{name:"settings.graphics.context.antialiasing"}),!1),this.setFiltering(e.getEnumValue(n.TextureFiltering,t.context.filtering,{name:"settings.graphics.context.filtering"}),!1),this.setTextureQuality(t.context.textureQuality,!1,!0),this.setCubemapQuality(t.context.cubemapQuality.level,!1,!0),this._limitSettingByScreenSize(t.context.cubemapQuality,this._cubemapQuality,this.getCubemapMaxResolution.bind(this),this.setCubemapQuality.bind(this),"level"),this.setShadowMapping(e.getBooleanValue(t.context.shadowMapping,{name:"settings.graphics.context.shadowMapping"}),!1,!0),"object"==typeof t.context.shadows&&(this.setShadowMapQuality(t.context.shadows.quality,!1,!0),this.setShadowDistance(t.context.shadows.distance,!1,!0)),this.setPointLightAmount(t.context.pointLightAmount,!1,!0)):i.showError("Missing required settings.graphics.context from the setting definition object!"),this.setLODLevel(t.levelOfDetail.maxLevel,!1),this._limitSettingByScreenSize(t.levelOfDetail,this._lodLevel,this.getMaxLoadedLOD.bind(this),this.setLODLevel.bind(this),"level"),this.setMissilesInLaunchersVisible(e.getBooleanValue(t.showMissilesInLaunchers,{name:"settings.graphics.showMissilesInLaunchers"}),!1),this.setParticleAmount(t.particleAmount.amount,!1),this._limitSettingByScreenSize(t.particleAmount,this._particleAmount,this.getParticleCountFactor.bind(this),this.setParticleAmount.bind(this),"amount"),!0===t.particleAmount.autoDecreaseIfInstancingNotAvailable&&(n.isInstancingAvailable()||this._particleAmount.decrease()),this.setDustParticleAmount(t.dustParticleAmount.amount,!1),this._limitSettingByScreenSize(t.dustParticleAmount,this._dustParticleAmount,this.getDustParticleCountFactor.bind(this),this.setDustParticleAmount.bind(this),"amount"),!0===t.dustParticleAmount.autoDecreaseIfInstancingNotAvailable&&(n.isInstancingAvailable()||this._dustParticleAmount.decrease()),this._setFallbackShaderComplexity(!0)},d.prototype.loadFromLocalStorage=function(){var t,s,o=function(n,o,r,a){void 0!==localStorage[n]&&(s={silentFallback:i.hasVersionChanged(),defaultValue:r},t=e.getValueOfTypeFromLocalStorage(o,n,s),s.error&&!i.hasVersionChanged()||a(t,!!s.error&&s.error!==e.Errors.INVALID_ENUM_OBJECT_ERROR))};o($,{baseType:"enum",values:e.getEnumObjectForArray(this.getGeneralLevelNames())},this.getGeneralLevel(),function(t){this._currentGeneralLevel=t}.bind(this)),o(tt,"boolean",this.getAntialiasing(),this.setAntialiasing.bind(this)),o(et,{baseType:"enum",values:n.TextureFiltering},this.getFiltering(),this.setFiltering.bind(this)),o(st,{baseType:"enum",values:e.getEnumObjectForArray(this.getTextureQualities())},this.getTextureQuality(),this.setTextureQuality.bind(this)),o(nt,{baseType:"enum",values:e.getEnumObjectForArray(this.getCubemapQualities())},this.getCubemapQuality(),this.setCubemapQuality.bind(this)),o(ot,{baseType:"enum",values:e.getEnumObjectForArray(this.getLODLevels())},this.getLODLevel(),this.setLODLevel.bind(this)),o(rt,"boolean",this.areMissilesInLaunchersVisible(),this.setMissilesInLaunchersVisible.bind(this)),o(at,{baseType:"enum",values:e.getEnumObjectForArray(this.getShaderComplexities())},this.getShaderComplexity(),this.setShaderComplexity.bind(this)),o(lt,"boolean",this.isShadowMappingEnabled(),this.setShadowMapping.bind(this)),o(ht,{baseType:"enum",values:e.getEnumObjectForArray(this.getShadowMapQualities())},this.getShadowMapQuality(),this.setShadowMapQuality.bind(this)),this.canEnableShadowMapping()&&o(ut,{baseType:"enum",values:e.getEnumObjectForArray(this.getShadowDistances())},this.getShadowDistance(),this.setShadowDistance.bind(this)),o(ct,{baseType:"enum",values:e.getEnumObjectForArray(this.getPointLightAmounts())},this.getPointLightAmount(),this.setPointLightAmount.bind(this)),o(_t,{baseType:"enum",values:e.getEnumObjectForArray(this.getParticleAmounts())},this.getParticleAmount(),this.setParticleAmount.bind(this)),o(dt,{baseType:"enum",values:e.getEnumObjectForArray(this.getDustParticleAmounts())},this.getDustParticleAmount(),this.setDustParticleAmount.bind(this)),this.setToReady()},d.prototype.restoreDefaults=function(){this.loadSettingsFromJSON(this._dataJSON,!0),localStorage.removeItem($),localStorage.removeItem(tt),localStorage.removeItem(et),localStorage.removeItem(st),localStorage.removeItem(nt),localStorage.removeItem(ot),localStorage.removeItem(rt),localStorage.removeItem(at),localStorage.removeItem(lt),localStorage.removeItem(ht),localStorage.removeItem(ut),localStorage.removeItem(ct),localStorage.removeItem(_t),localStorage.removeItem(dt)},d.prototype.getAntialiasing=function(){return this._antialiasing},d.prototype.setAntialiasing=function(t,e){return void 0===e&&(e=!0),n.isAntialiasingAvailable()?this._antialiasing=t:this._antialiasing=!1,e&&(localStorage[tt]=t.toString()),this._antialiasing===t},d.prototype.getFiltering=function(){return this._filtering},d.prototype.setFiltering=function(t,i){void 0===i&&(i=!0),t=e.getEnumValue(n.TextureFiltering,t,{name:"texture filtering",defaultValue:this._filtering}),this._filtering=t,n.isAnisotropicFilteringAvailable()||t!==n.TextureFiltering.ANISOTROPIC||(this._filtering=it),i&&(localStorage[et]=t.toString())},d.prototype.getTextureQualities=function(){return this._textureQuality.getNameList()},d.prototype.getTextureQualityPreferenceList=function(){return this._textureQuality.getPreferenceNameList()},d.prototype.getTextureQuality=function(){return this._textureQuality.getCurrentName()},d.prototype.setTextureQuality=function(t,e,i){void 0===e&&(e=!0),this._textureQuality.setCurrent(t,i)&&e&&(localStorage[st]=t)},d.prototype.getCubemapMaxResolution=function(){return this._cubemapQuality.getCurrentValue()},d.prototype.getCubemapQualities=function(){return this._cubemapQuality.getNameList()},d.prototype.getCubemapQualityPreferenceList=function(){return this._cubemapQuality.getPreferenceNameList()},d.prototype.getCubemapQuality=function(){return this._cubemapQuality.getCurrentName()},d.prototype.setCubemapQuality=function(t,e,i){void 0===e&&(e=!0),this._cubemapQuality.setCurrent(t,i)&&e&&(localStorage[nt]=t)},d.prototype.getMaxLoadedLOD=function(){return this._maxLoadedLOD},d.prototype.getLODLevels=function(){return this._lodLevel.getNameList()},d.prototype.getLODLevel=function(){return this._lodLevel.getCurrentName()},d.prototype.getLOD=function(t){return this._lodLevel.getValueForName(t)},
d.prototype.setLODLevel=function(t,e){void 0===e&&(e=!0),this._lodLevel.setCurrent(t)&&(this._maxLoadedLOD=this._lodLevel.getCurrentValue(),this._lodContext.maxEnabledLOD=this._lodLevel.getCurrentValue(),e&&(localStorage[ot]=t))},d.prototype.getLODContext=function(){return this._lodContext},d.prototype.setMissilesInLaunchersVisible=function(t,e){void 0===e&&(e=!0),this._msInLaunchers=t,e&&(localStorage[rt]=t.toString())},d.prototype.areMissilesInLaunchersVisible=function(){return this._msInLaunchers},d.prototype.getShaderComplexity=function(){return this._shaderComplexity},d.prototype._limitShaderFeatures=function(){var t=this.isShadowMappingEnabled();for(this.getNumShadowMapRanges(),this.getMaxPointLights();!this._shaderRequirementsAreSatisfied();)if(this.isShadowMappingEnabled())this._shadowDistances.decrease()||this.setShadowMapping(!1,!1,!0);else if(!this._pointLightAmount.decrease())return void i.showError("Cannot satisfy shader requirements for current complexity!");this.isShadowMappingEnabled()!==t||this.getNumShadowMapRanges(),this.getMaxPointLights()},d.prototype._disableShaderFeatures=function(){this.isShadowMappingEnabled()&&this.setShadowMapping(!1,!1,!0),this._pointLightAmount.setLowest()},d.prototype.setShaderComplexity=function(t,e,s){var n=this.getShaderComplexities();void 0===e&&(e=!0),n.indexOf(t)>=0?(this._shaderComplexity!==t&&(this._shaderComplexity=t,this._limitShaderFeatures()),e&&(localStorage[at]=t)):s?this._shaderComplexity=n[n.length-1]:i.showError("Attempting to set shader complexity to '"+t+"', which is not one of the available options ("+this.getShaderComplexities().join(", ")+").",i.ErrorSeverity.MINOR,"The shader complexity will stay '"+this.getShaderComplexity()+"'."),this._luminosityTextureAreAvailable=this._getShaderComplexityDescriptor()[z.LUMINOSITY_TEXTURES_AVAILABLE.name]},d.prototype.getShaderComplexities=function(){return this.getShaderConfig(q.COMPLEXITIES).map(function(t){return t[z.NAME.name]})},d.prototype.getShadowMappingShaderName=function(){return this.getShaderConfig(q.SHADOW_MAPPING_SHADER_NAME)},d.prototype.isShadowMappingEnabled=function(){return this._shadowMappingEnabled},d.prototype.setShadowMapping=function(t,i,s){return void 0===t&&(t=void 0!==localStorage[lt]?"true"===localStorage[lt]:e.getBooleanValue(this._dataJSON.context.shadowMapping,{name:"settings.graphics.context.shadowMapping"}),i=!1,s=!1),void 0===i&&(i=!0),s||!t||this.canEnableShadowMapping()?this._shadowMappingEnabled!==t&&(this._shadowMappingEnabled=t,!s&&t&&this._limitShaderFeatures()):this._shadowMappingEnabled=!1,i&&(localStorage[lt]=t.toString()),this._shadowMappingEnabled===t},d.prototype.getShadowMapQualities=function(){return this._shadowMapQuality.getNameList()},d.prototype.getShadowMapQuality=function(){return this._shadowMapQuality.getCurrentName()},d.prototype.getShadowMapTextureSize=function(){return this._shadowMapQuality.getCurrentValue()},d.prototype.setShadowMapQuality=function(t,e,i){void 0===e&&(e=!0),this._shadowMapQuality.setCurrent(t,i)&&e&&(localStorage[ht]=t)},d.prototype.getShadowRanges=function(){var t,e=[],i=this.getNumShadowMapRanges();for(t=0;t<i;t++)e.push(this._shadowRanges[t]);return e},d.prototype.getShadowDistances=function(){return this._shadowDistances.getFilteredNameList(function(t){return this._shaderRequirementsAreSatisfied({numShadowRanges:t})}.bind(this))},d.prototype.getShadowDistance=function(){return this._shadowDistances.getCurrentName()},d.prototype.getNumShadowMapRanges=function(){return this._shadowMappingEnabled?this._shadowDistances.getCurrentValue():0},d.prototype.setShadowDistance=function(t,e,i){void 0===e&&(e=!0),this._shadowDistances.setCurrent(t,i)&&e&&(localStorage[ut]=t)},d.prototype.getShadowDepthRatio=function(){return this._shadowDepthRatio},d.prototype._getShaderComplexityDescriptor=function(t){return void 0===t?this.getShaderConfig(q.COMPLEXITIES).find(function(t){return t[z.NAME.name]===this.getShaderComplexity()}.bind(this),this):this.getShaderConfig(q.COMPLEXITIES)[t]},d.prototype.getMaxDirLights=function(){return this._getShaderComplexityDescriptor()[z.MAX_DIR_LIGHTS.name]},d.prototype.getPointLightAmounts=function(){return this._pointLightAmount.getFilteredNameList(function(t){return this._shaderRequirementsAreSatisfied({numPointLights:t})}.bind(this))},d.prototype.getPointLightAmount=function(){return this._pointLightAmount.getCurrentName()},d.prototype.getMaxPointLights=function(){return this._pointLightAmount.getCurrentValue()},d.prototype.setPointLightAmount=function(t,e,i){void 0===e&&(e=!0),this._pointLightAmount.setCurrent(t,i)&&e&&(localStorage[ct]=t)},d.prototype.getMaxSpotLights=function(){return this._getShaderComplexityDescriptor()[z.MAX_SPOT_LIGHTS.name]},d.prototype.getParticleAmounts=function(){return this._particleAmount.getNameList()},d.prototype.getParticleAmount=function(){return this._particleAmount.getCurrentName()},d.prototype.getParticleCountFactor=function(){return this._particleAmount.getCurrentValue()},d.prototype.setParticleAmount=function(t,e,i){void 0===e&&(e=!0),this._particleAmount.setCurrent(t,i)&&e&&(localStorage[_t]=t)},d.prototype.getDustParticleAmounts=function(){return this._dustParticleAmount.getNameList()},d.prototype.getDustParticleAmount=function(){return this._dustParticleAmount.getCurrentName()},d.prototype.getDustParticleCountFactor=function(){return this._dustParticleAmount.getCurrentValue()},d.prototype.setDustParticleAmount=function(t,e,i){void 0===e&&(e=!0),this._dustParticleAmount.setCurrent(t,i)&&e&&(localStorage[dt]=t)},d.prototype.getShaderConfig=function(t){return this._shaderConfig[t.name]},d.prototype.setShaderConfig=function(t,e){this._shaderConfig[t.name]=e},d.prototype.getNumShadowMapSamples=function(){return this._getShaderComplexityDescriptor()[z.NUM_SHADOW_MAP_SAMPLES.name]},d.prototype.isShadowMappingAvailable=function(){return this._getShaderComplexityDescriptor()[z.SHADOW_MAPPING_AVAILABLE.name]},d.prototype.areLuminosityTexturesAvailable=function(){return this._luminosityTextureAreAvailable},d.prototype.getGroupTransformIdentityArray=function(){return this._groupTransformIdentityArray},d.prototype.isRevealAvailable=function(){return this._getShaderComplexityDescriptor()[z.REVEAL_AVAILABLE.name]},d.prototype.areDynamicLightsAvailable=function(){return this._getShaderComplexityDescriptor()[z.DYNAMIC_LIGHTS_AVAILABLE.name]},d.prototype.canEnableShadowMapping=function(){return this.isShadowMappingAvailable()&&this._shaderRequirementsAreSatisfied({numShadowRanges:this._shadowDistances.getFirstValue()})},d.prototype.getTexture=function(t,e){return e=e||{},e.qualityPreferenceList=this.getTextureQualityPreferenceList(),o.getTexture(t,e)},d.prototype.getCubemap=function(t,e){return e=e||{},e.qualityPreferenceList=this.getCubemapQualityPreferenceList(),o.getCubemap(t,e)},d.prototype.getShader=function(t){return t=o.getVariantShader(t,this.getShaderComplexity())._name,this._shadowMappingEnabled||(t=o.getVariantShader(t,"withoutShadows")._name),0===this._pointLightAmount.getCurrentValue()&&(t=o.getVariantShader(t,"withoutDynamicLights")._name),o.getShader(t)},d.prototype.getManagedShader=function(t){var e,s={};return s[this.getShaderConfig(q.MAX_DIR_LIGHTS_DEFINE_NAME)]=this.getMaxDirLights(),s[this.getShaderConfig(q.MAX_POINT_LIGHTS_DEFINE_NAME)]=this.getMaxPointLights(),s[this.getShaderConfig(q.MAX_SPOT_LIGHTS_DEFINE_NAME)]=this.getMaxSpotLights(),s[this.getShaderConfig(q.MAX_SHADOW_MAP_RANGES_DEFINE_NAME)]=this.getNumShadowMapRanges(),s[this.getShaderConfig(q.MAX_SHADOW_MAPS_DEFINE_NAME)]=this.getMaxDirLights()*this.getNumShadowMapRanges(),s[this.getShaderConfig(q.NUM_SHADOW_MAP_SAMPLES_DEFINE_NAME)]=this.getNumShadowMapSamples(),s[this.getShaderConfig(q.DUST_LENGTH_DIVISOR_DEFINE_NAME)]=this.getShaderConfig(q.DUST_LENGTH_DIVISOR),s[this.getShaderConfig(q.MAX_LUMINOSITY_FACTORS_DEFINE_NAME)]=this.getShaderConfig(q.MAX_LUMINOSITY_FACTORS),s[this.getShaderConfig(q.MAX_GROUP_TRANSFORMS_DEFINE_NAME)]=this.getShaderConfig(q.MAX_GROUP_TRANSFORMS),s[this.getShaderConfig(q.DEPTH_TEXTURES_DEFINE_NAME)]=n.areDepthTexturesAvailable()?"1":"0",s[this.getShaderConfig(q.MAX_SHININESS_DEFINE_NAME)]=this.getShaderConfig(q.MAX_SHININESS),s[this.getShaderConfig(q.LISPSM_MINIMUM_NEAR_DEFINE_NAME)]=this.getShaderConfig(q.LISPSM_MINIMUM_NEAR),s[this.getShaderConfig(q.LISPSM_NEAR_FACTOR_DEFINE_NAME)]=this.getShaderConfig(q.LISPSM_NEAR_FACTOR),s[this.getShaderConfig(q.ANAGLYPH_ORIGINAL_COLOR_RATIO_DEFINE_NAME)]=this.getShaderConfig(q.ANAGLYPH_ORIGINAL_COLOR_RATIO),s[this.getShaderConfig(q.ANAGLYPH_GAMMA_DEFINE_NAME)]=this.getShaderConfig(q.ANAGLYPH_GAMMA),s[this.getShaderConfig(q.ANAGLYPH_CYAN_FACTOR_DEFINE_NAME)]=this.getShaderConfig(q.ANAGLYPH_CYAN_FACTOR),e=this.getShader(t).getManagedShader(s,!0),e.isAllowedByRequirements(this._getShaderRequirements())||i.showError("Shader '"+t+"' has too high requirements!"),e},d.prototype.getModel=function(t){return o.getModel(t,{maxLOD:this.getMaxLoadedLOD()})},d.prototype.getGeneralLevelNames=function(){return Object.keys(this._generalLevels)},d.prototype.setGeneralLevel=function(t,e){void 0===e&&(e=!0),t?(this.loadSettingsFromJSON(this._generalLevels[t],!0),e&&(localStorage[$]=t)):e&&localStorage.removeItem($),this._currentGeneralLevel=t},d.prototype.getGeneralLevel=function(){return this._currentGeneralLevel},L=new d,{SHADER_VARIANT_WITHOUT_SHADOWS_NAME:"withoutShadows",SHADER_VARIANT_WITHOUT_DYNAMIC_LIGHTS_NAME:"withoutDynamicLights",loadConfigurationFromJSON:L.loadConfigurationFromJSON.bind(L),loadSettingsFromJSON:L.loadSettingsFromJSON.bind(L),loadSettingsFromLocalStorage:L.loadFromLocalStorage.bind(L),restoreDefaults:L.restoreDefaults.bind(L),getAntialiasing:L.getAntialiasing.bind(L),setAntialiasing:L.setAntialiasing.bind(L),getFiltering:L.getFiltering.bind(L),setFiltering:L.setFiltering.bind(L),getTextureQualities:L.getTextureQualities.bind(L),getTextureQuality:L.getTextureQuality.bind(L),setTextureQuality:L.setTextureQuality.bind(L),getTextureQualityPreferenceList:L.getTextureQualityPreferenceList.bind(L),getCubemapQualities:L.getCubemapQualities.bind(L),getCubemapQuality:L.getCubemapQuality.bind(L),setCubemapQuality:L.setCubemapQuality.bind(L),getCubemapQualityPreferenceList:L.getCubemapQualityPreferenceList.bind(L),getLODLevels:L.getLODLevels.bind(L),getLODLevel:L.getLODLevel.bind(L),getLOD:L.getLOD.bind(L),setLODLevel:L.setLODLevel.bind(L),getMaxLoadedLOD:L.getMaxLoadedLOD.bind(L),getLODContext:L.getLODContext.bind(L),setMissilesInLaunchersVisible:L.setMissilesInLaunchersVisible.bind(L),areMissilesInLaunchersVisible:L.areMissilesInLaunchersVisible.bind(L),getShaderComplexity:L.getShaderComplexity.bind(L),setShaderComplexity:L.setShaderComplexity.bind(L),getShaderComplexities:L.getShaderComplexities.bind(L),getMaxLuminosityFactors:L.getShaderConfig.bind(L,q.MAX_LUMINOSITY_FACTORS),getMaxGroupTransforms:L.getShaderConfig.bind(L,q.MAX_GROUP_TRANSFORMS),getLispsmMinimumNear:C,getLispsmNearFactor:N,getShadowMappingShaderName:L.getShadowMappingShaderName.bind(L),isShadowMappingEnabled:L.isShadowMappingEnabled.bind(L),setShadowMapping:L.setShadowMapping.bind(L),getShadowMapQualities:L.getShadowMapQualities.bind(L),getShadowMapQuality:L.getShadowMapQuality.bind(L),getShadowMapTextureSize:L.getShadowMapTextureSize.bind(L),setShadowMapQuality:L.setShadowMapQuality.bind(L),getShadowDistances:L.getShadowDistances.bind(L),getShadowDistance:L.getShadowDistance.bind(L),setShadowDistance:L.setShadowDistance.bind(L),getShadowDepthRatio:L.getShadowDepthRatio.bind(L),getNumShadowMapSamples:L.getNumShadowMapSamples.bind(L),getMaxDirLights:L.getMaxDirLights.bind(L),getPointLightAmounts:L.getPointLightAmounts.bind(L),getPointLightAmount:L.getPointLightAmount.bind(L),getMaxPointLights:L.getMaxPointLights.bind(L),setPointLightAmount:L.setPointLightAmount.bind(L),getParticleAmounts:L.getParticleAmounts.bind(L),getParticleAmount:L.getParticleAmount.bind(L),getParticleCountFactor:L.getParticleCountFactor.bind(L),setParticleAmount:L.setParticleAmount.bind(L),getDustParticleAmounts:L.getDustParticleAmounts.bind(L),getDustParticleAmount:L.getDustParticleAmount.bind(L),getDustParticleCountFactor:L.getDustParticleCountFactor.bind(L),setDustParticleAmount:L.setDustParticleAmount.bind(L),getMaxSpotLights:L.getMaxSpotLights.bind(L),isShadowMappingAvailable:L.isShadowMappingAvailable.bind(L),areLuminosityTexturesAvailable:L.areLuminosityTexturesAvailable.bind(L),getGroupTransformIdentityArray:L.getGroupTransformIdentityArray.bind(L),isRevealAvailable:L.isRevealAvailable.bind(L),areDynamicLightsAvailable:L.areDynamicLightsAvailable.bind(L),canEnableShadowMapping:L.canEnableShadowMapping.bind(L),getTexture:L.getTexture.bind(L),getCubemap:L.getCubemap.bind(L),getShader:L.getShader.bind(L),getManagedShader:L.getManagedShader.bind(L),getModel:L.getModel.bind(L),getGeneralLevelNames:L.getGeneralLevelNames.bind(L),setGeneralLevel:L.setGeneralLevel.bind(L),getGeneralLevel:L.getGeneralLevel.bind(L),getAnaglyphOriginalColorRatio:I,getAnaglyphGamma:A,getAnaglyphCyanFactor:M,shouldUseShadowMapping:p,getShadowMappingShader:g,getShadowMappingSettings:m,getAnaglyphRedShader:f,getAnaglyphCyanShader:S,getSideBySideLeftShader:T,getSideBySideRightShader:E,getShadowMapDebugShader:y,onSettingsChange:O,handleSettingsChanged:R,executeWhenReady:L.executeWhenReady.bind(L)}}),define("modules/physics",["utils/utils","utils/vectors","utils/matrices","modules/containers"],function(t,e,i,s){"use strict";function n(){return u}function o(t,e){u=t,c=e}function r(t,e,i){this._strength=t,this._direction=e,this._duration=i||0,this._continuous=void 0===i,this.next=null,this.previous=null,this.list=null}function a(t,e,i){this._strength=t,this._axis=e,this._duration=i||0,this._continuous=void 0===i,this.next=null,this.previous=null,this.list=null}function l(t,e,s){this.pM=t,this._positionVector=i.translationVector3(t),this.oM=e,this._rotated=!i.equal4(e,i.IDENTITY4),this.mMI=null,this._halfWidth=.5*s[0],this._halfHeight=.5*s[1],this._halfDepth=.5*s[2],this._modelTransformResult=[0,0,0,1]}function h(t,e,n,o,r,a,l,h,u){this._mass=0,this.pM=i.identity4(),this.oM=i.identity4(),this.sM=i.identity4(),this._rotationMatrixInverse=i.identity4(),this._rotationMatrixInverseValid=!1,this.sMInverse=i.identity4(),this.sMInverseValid=!1,this.mMI=i.identity4(),this.mMIV=!1,this._velocityMatrix=i.identity4(),this._acceleration=[0,0,0],this._offset=[0,0,0],this._angularVelocityMatrix=i.identity4(),this._angularAccelerationMatrix=i.identity3(),this._orientationOffset=i.identity3(),this._hasAngularAcceleration=!1,this._forces=new s.DirectDoubleLinkedList,this._torques=new s.DirectDoubleLinkedList,this._bodies=null,this._bodySize=-1,this._fixedVelocity=!1,this._fixedOrientation=!1,this._dragFactor=0,this._inverseScalingFactor=1,this._inverseMass=0,e&&this.init(t,e,n,o,r,a,l,h,u)}var u=0,c=0;return r.prototype.renew=function(t,i){this._strength=t,e.setVector3(this._direction,i),this._duration=0},r.prototype.exert=function(t){if(this._continuous)return this._duration<0?0:(this._duration=-1,t);if(this._duration>=.1){var e=Math.min(this._duration,t);return this._duration-=t,e}return 0},r.prototype.getAccelerationVector=function(t){return e.scaled3(this._direction,this._strength*t)},r.prototype.canBeReused=function(){return this._duration<.1&&!this._continuous},a.prototype.renew=function(t,i){this._strength=t,e.setVector3(this._axis,i),this._duration=0},a.prototype.exert=function(t){if(this._continuous)return this._duration<0?0:(this._duration=-1,t);if(this._duration>=.1){var e=Math.min(this._duration,t);return this._duration-=t,e}return 0},a.prototype.getAngularAccelerationMatrixOverTime=function(t,e){return i.rotation3Aux(this._axis,this._strength*t*e)},a.prototype.canBeReused=function(){return this._duration<.1&&!this._continuous},l.prototype.getWidth=function(){return 2*this._halfWidth},l.prototype.getHeight=function(){return 2*this._halfHeight},l.prototype.getDepth=function(){return 2*this._halfDepth},l.prototype._modelTransform=function(t){return this._rotated?e.setSum3(this._modelTransformResult,e.prodVec3Mat4Aux(t,this.oM),this._positionVector):e.setSum3(this._modelTransformResult,t,this._positionVector),this._modelTransformResult},l.prototype.getModelMatrixInverse=function(){return this.mMI=this.mMI||i.prodTranslationRotation4(i.inverseOfTranslation4Aux(this.pM),i.inverseOfRotation4Aux(this.oM)),this.mMI},l.prototype.getHalfDimensions=function(){return[this._halfWidth,this._halfHeight,this._halfDepth]},l.prototype.checkHit=function(s,n,o,r){var a,l,h,u=this._halfWidth+r,c=this._halfHeight+r,_=this._halfDepth+r;if(this._rotated?(s=e.prodVec4Mat4Aux(s,this.getModelMatrixInverse()),n=e.prodVec3Mat3Aux(n,i.matrix3from4Aux(i.inverseOfRotation4Aux(this.oM)))):s=e.diff3Aux(s,this._positionVector),0!==n[0])if(n[0]>0){if(a=(-u-s[0])/n[0],l=s[1]+n[1]*a,h=s[2]+n[2]*a,t.pointInRect(l,h,-c,-_,c,_))return a<=0&&a>=-o?this._modelTransform([-u,l,h]):null}else if(a=(u-s[0])/n[0],l=s[1]+n[1]*a,h=s[2]+n[2]*a,t.pointInRect(l,h,-c,-_,c,_))return a<=0&&a>=-o?this._modelTransform([u,l,h]):null;if(0!==n[1])if(n[1]>0){if(a=(-c-s[1])/n[1],l=s[0]+n[0]*a,h=s[2]+n[2]*a,t.pointInRect(l,h,-u,-_,u,_))return a<=0&&a>=-o?this._modelTransform([l,-c,h]):null}else if(a=(c-s[1])/n[1],l=s[0]+n[0]*a,h=s[2]+n[2]*a,t.pointInRect(l,h,-u,-_,u,_))return a<=0&&a>=-o?this._modelTransform([l,c,h]):null;if(0!==n[2])if(n[2]>0){if(a=(-_-s[2])/n[2],l=s[0]+n[0]*a,h=s[1]+n[1]*a,t.pointInRect(l,h,-u,-c,u,c))return a<=0&&a>=-o?this._modelTransform([l,h,-_]):null}else if(a=(_-s[2])/n[2],l=s[0]+n[0]*a,h=s[1]+n[1]*a,t.pointInRect(l,h,-u,-c,u,c))return a<=0&&a>=-o?this._modelTransform([l,h,_]):null;return null},h.prototype.init=function(s,n,o,r,a,l,h,u,c){this._mass=s,this._inverseMass=1/s,i.copyTranslation4(this.pM,n),i.setMatrix4(this.oM,o),i.copyScaling4(this.sM,r),this._rotationMatrixInverseValid=!1,this.sMInverseValid=!1,this.mMIV=!1,i.copyTranslation4(this._velocityMatrix,a),e.setNull3(this._acceleration),e.setNull3(this._offset),i.setIdentity4(this._angularVelocityMatrix),i.setIdentity3(this._angularAccelerationMatrix),i.setIdentity3(this._orientationOffset),this._hasAngularAcceleration=!1,this._inverseScalingFactor=1/this.sM[0],this._forces.clear(),this._torques.clear(),this._bodies=l||t.EMPTY_ARRAY,this._bodySize=-1,this._calculateBodySize(),this._fixedOrientation=!!h,this._fixedVelocity=!!u,this._dragFactor=void 0!==c?c:1},h.prototype.reset=function(){i.setIdentity4(this._velocityMatrix),i.setIdentity4(this._angularVelocityMatrix),this._forces.clear(),this._torques.clear()},h.prototype.setDragFactor=function(t){this._dragFactor=t},h.prototype.copyPositionToVector=function(t){t[0]=this.pM[12],t[1]=this.pM[13],t[2]=this.pM[14]},h.prototype.getBodySize=function(){return this._bodySize},h.prototype.getSize=function(){return this._bodySize*this.sM[0]},h.prototype.getVelocityMatrix=function(){return this._velocityMatrix},h.prototype.setVelocityMatrix=function(t){this._velocityMatrix=t},h.prototype.getAngularVelocityMatrix=function(){return this._angularVelocityMatrix},h.prototype.addForce=function(t){return this._forces.add(t),t},h.prototype.applyForce=function(t,e,i,s,n){var o=.001*n,r=t*this._inverseMass*.5*o*o;this._offset[0]+=e*r,this._offset[1]+=i*r,this._offset[2]+=s*r,r=t*this._inverseMass*o,this._acceleration[0]+=e*r,this._acceleration[1]+=i*r,this._acceleration[2]+=s*r},h.prototype.addTorque=function(t){return this._torques.add(t),t},h.prototype.applyTorque=function(t,e,s){var n=.001*s,o=t*this._inverseMass*n;this._hasAngularAcceleration=!0,i.mul3(this._orientationOffset,i.rotation3Aux(e,.5*o*n)),i.mul3(this._angularAccelerationMatrix,i.rotation3Aux(e,5*o*.001))},h.prototype.setPositionMatrix=function(t){t&&(this.pM=t),this.mMIV=!1},h.prototype.setOrientationMatrix=function(t){t&&(this.oM=t),this._rotationMatrixInverseValid=!1,this.mMIV=!1},h.prototype.setScalingMatrix=function(t){this.sM=t,this.sMInverseValid=!1,this.mMIV=!1,this._inverseScalingFactor=1/this.sM[0]},h.prototype.getRotationMatrixInverse=function(){return this._rotationMatrixInverseValid||(i.setInverseOfRotation4(this._rotationMatrixInverse,this.oM),this._rotationMatrixInverseValid=!0),this._rotationMatrixInverse},h.prototype.getScalingMatrixInverse=function(){return this.sMInverseValid||(i.setInverseOfScaling4(this.sMInverse,this.sM),this.sMInverseValid=!0),this.sMInverse},h.prototype.getModelMatrixInverse=function(){return this.mMIV||(i.setProdTranslationRotation4(this.mMI,i.inverseOfTranslation4Aux(this.pM),i.prod3x3SubOf4Aux(this.getRotationMatrixInverse(),this.getScalingMatrixInverse())),this.mMIV=!0),this.mMI},h.prototype.addOrRenewForce=function(t,e,i){return t?t.renew(e,i):t=this.addForce(new r(e,i)),t},h.prototype.addOrRenewTorque=function(t,e,i){return t?t.renew(e,i):t=this.addTorque(new a(e,i)),t},h.prototype.addForceAndTorque=function(t,i,s,n){var o=e.length3(t),l=e.scaled3(t,1/o),h=e.scaled3(l,e.dot3(i,l)),u=e.diff3Aux(i,h);this.addForce(new r(s,i,n)),this.addTorque(new a(s*e.length3(u)*o,e.normalize3(e.cross3(u,l)),n))},h.prototype.applyForceAndTorque=function(t,i,s,n){var o=e.length3(t),r=e.scaled3(t,1/o),a=e.scaled3(r,e.dot3(i,r)),l=e.diff3Aux(i,a);this.applyForce(s,i[0],i[1],i[2],n),this.applyTorque(s*e.length3(l)*o,e.normalize3(e.cross3(l,r)),n)},h.prototype._calculateBodySize=function(){var t,s,n=[0,0,0];for(this._bodySize=0,t=0;t<this._bodies.length;t++)e.setTranslationVector3(n,this._bodies[t].pM),s=e.prodVec3Mat3Aux(this._bodies[t].getHalfDimensions(),i.prod3x3SubOf43(this.oM,this._bodies[t].oM)),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(n,s))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(n,[s[0],s[1],-s[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(n,[s[0],-s[1],s[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(n,[s[0],-s[1],-s[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(n,[-s[0],s[1],s[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(n,[-s[0],s[1],-s[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(n,[-s[0],-s[1],s[2]]))),this._bodySize=Math.max(this._bodySize,e.length3(e.sum3(n,[-s[0],-s[1],-s[2]])))},h.prototype.checkHit=function(t,s,n,o){var r,a,l,h,u=null;if(o=o||0,o*=this._inverseScalingFactor,r=e.prodVec4Mat4Aux(e.vector4From3Aux(t),this.getModelMatrixInverse()),a=e.diffVec3Mat4(s,this.getVelocityMatrix()),l=e.extractLength3(a),h=l*n*.001*this._inverseScalingFactor,Math.abs(r[0])-h<this._bodySize+o&&Math.abs(r[1])-h<this._bodySize+o&&Math.abs(r[2])-h<this._bodySize+o)for(e.mulVec3Mat3(a,i.matrix3from4Aux(this.getRotationMatrixInverse())),l=0;null===u&&l<this._bodies.length;l++)u=this._bodies[l].checkHit(r,a,h,o);return u},h.prototype.checkHitRelative=function(t,e,i,s){var n,o=null;for(n=0;null===o&&n<this._bodies.length;n++)o=this._bodies[n].checkHit(t,e,i,s);return o},h.prototype._correctMatrices=function(){i.correctOrthogonal4(this.oM),this.setOrientationMatrix(),i.correctOrthogonal4(this._angularVelocityMatrix)},h.prototype.simulate=function(t){var s,n,o,r,a,l,h,_,d;if(t>0){if(u>0&&this._dragFactor>0&&(o=this._velocityMatrix[12]*this._velocityMatrix[12]+this._velocityMatrix[13]*this._velocityMatrix[13]+this._velocityMatrix[14]*this._velocityMatrix[14])>.1&&(n=u*this._dragFactor*o,o=1/Math.sqrt(o),n=-o*n*t*.001,this._velocityMatrix[12]+=n*this._velocityMatrix[12],this._velocityMatrix[13]+=n*this._velocityMatrix[13],this._velocityMatrix[14]+=n*this._velocityMatrix[14]),i.translateByMatrixMul(this.pM,this._velocityMatrix,.001*t),this._fixedVelocity)this.setPositionMatrix();else{if(i.translateByVector(this.pM,this._offset),this.setPositionMatrix(),this._forces._length>0)for(a=this._forces.getFirst();a;a=l)l=a.next,a.canBeReused()?this._forces.remove(a):(r=.001*a.exert(t))>0&&(n=a.getAccelerationVector(this._inverseMass),i.translateByVector(this.pM,e.scaled3Aux(n,.5*r*r)),e.add3(this._acceleration,e.scaled3Aux(n,r)));i.translateByVector(this._velocityMatrix,this._acceleration),e.setNull3(this._acceleration),e.setNull3(this._offset),i.straightenTranslation(this._velocityMatrix,1e-4)}if(!this._fixedOrientation){for(u>0&&this._dragFactor>0&&(d=i.identity3Aux(),o=c*this._dragFactor*t*.001,e.angle2y(this._angularVelocityMatrix[4],this._angularVelocityMatrix[5])>.001&&i.mul3(d,i.rotation3Aux(e.UNIT3_Z,this._angularVelocityMatrix[4]>0?-o:o)),e.angle2x(this._angularVelocityMatrix[5],this._angularVelocityMatrix[6])>.001&&i.mul3(d,i.rotation3Aux(e.UNIT3_X,this._angularVelocityMatrix[6]>0?o:-o)),e.angle2x(this._angularVelocityMatrix[0],this._angularVelocityMatrix[2])>.001&&i.mul3(d,i.rotation3Aux(e.UNIT3_Y,this._angularVelocityMatrix[2]>0?-o:o)),i.mulRotation43(this._angularVelocityMatrix,d)),s=0;s+2.5<t;s+=5)i.mulRotationRotation4(this.oM,this._angularVelocityMatrix);if(this._hasAngularAcceleration&&(i.mulRotation43(this.oM,this._orientationOffset),i.setIdentity3(this._orientationOffset)),this.setOrientationMatrix(),this._torques._length>0)for(this._hasAngularAcceleration=!0,h=this._torques.getFirst();h;h=_)_=h.next,h.canBeReused()?this._torques.remove(h):(r=.001*h.exert(t))>0&&(i.mulRotation43(this.oM,h.getAngularAccelerationMatrixOverTime(this._inverseMass,.5*r*r)),i.mul3(this._angularAccelerationMatrix,h.getAngularAccelerationMatrixOverTime(this._inverseMass,5*r*.001)));this._hasAngularAcceleration&&(i.mulRotation43(this._angularVelocityMatrix,this._angularAccelerationMatrix),i.setIdentity3(this._angularAccelerationMatrix),this._hasAngularAcceleration=!1,i.straightenRotation4(this._angularVelocityMatrix,1e-5)),this._correctMatrices()}}},{getDrag:n,setDrag:o,Body:l,Force:r,Torque:a,PhysicalObject:h,ANGULAR_VELOCITY_MATRIX_DURATION:5,ANGULAR_VELOCITY_MATRIX_DURATION_S:.005,VELOCITY_MATRIX_ERROR_THRESHOLD:1e-4,ANGULAR_VELOCITY_MATRIX_ERROR_THRESHOLD:1e-5}}),define("armada/strings",["modules/strings"],function(t){"use strict";function e(t){var e=t[0].toLowerCase();return"a"===e||"e"===e||"u"===e||"i"===e||"o"===e||"á"===e||"é"===e||"ú"===e||"ü"===e||"ű"===e||"í"===e||"ó"===e||"ö"===e||"ő"===e}return t.GRAMMAR={DEFINITE_ARTICLE_BEFORE_VOWEL:{name:"grammar.definiteArticle.beforeVowel"},DEFINITE_ARTICLE_BEFORE_CONSONANT:{name:"grammar.definiteArticle.beforeConsonant"},AND:{name:"grammar.and"}},t.FIRST_RUN_NOTE={HEADER:{name:"firstRunNote.header"},MESSAGE:{name:"firstRunNote.message"},BUTTON:{name:"firstRunNote.button"}},t.RELEASE_NOTES={PREFIX:{name:"releaseNotes.",optional:!0},HEADER:{name:"releaseNotes.header"},GENERAL:{name:"releaseNotes.general"},NO_NEWS:{name:"releaseNotes.noNews"},BUTTON:{name:"releaseNotes.button"}},t.SCREEN={BACK:{name:"screen.back"},CANCEL:{name:"screen.cancel"}},t.MAIN_MENU={NEW_GAME:{name:"mainMenu.newGame"},DATABASE:{name:"mainMenu.database"},SETTINGS:{name:"mainMenu.settings"},ABOUT:{name:"mainMenu.about"},QUIT:{name:"mainMenu.quit"}},t.MISSIONS={BACK:{name:"missions.backButton"},TITLE:{name:"missions.title"},DIFFICULTY:{name:"missions.difficulty"},LAUNCH_BUTTON:{name:"missions.launchButton"},DEMO_BUTTON:{name:"missions.demoButton"},FILE_BUTTON:{name:"missions.fileButton"},CUSTOM_MISSION_CAPTION:{name:"missions.customMissionCaption"},CUSTOM_MISSION_SUBCAPTION:{name:"missions.customMissionSubcaption"},NOT_COMPLETED:{name:"missions.notCompleted"},BEST_SCORE:{name:"missions.bestScore"},SANDBOX_COMPLETED:{name:"missions.sandboxCompleted"},NO_SELECTED_NAME:{name:"missions.noSelectedName"},NO_SELECTED_DESCRIPTION:{name:"missions.noSelectedDescription"},CUSTOM_DESCRIPTION:{name:"missions.customDescription"},LOCATION:{name:"missions.location"},CREATED_BY:{name:"missions.createdBy"},LOADING_DESCRIPTION:{name:"missions.loadingDescription"},NO_TRANSLATED_DESCRIPTION:{name:"missions.noTranslatedDescription"},NO_DESCRIPTION:{name:"missions.noDescription"},OBJECTIVES_TITLE:{name:"missions.missionObjectivesTitle"},SPACECRAFT_TITLE:{name:"missions.playerSpacecraftTitle"},SPACECRAFT_DATA:{name:"missions.playerSpacecraftData"},SPACECRAFT_WEAPONS:{name:"missions.playerSpacecraftWeapons"},SPACECRAFT_MISSILES:{name:"missions.playerSpacecraftMissiles"},SPACECRAFT_SHIELD:{name:"missions.playerSpacecraftShield"},SPACECRAFT_PROPULSION:{name:"missions.playerSpacecraftPropulsion"},OBJECTIVE_SUBJECTS_SQUAD:{name:"missions.objectiveSubjects.squad"},OBJECTIVE_SUBJECTS_SQUADS:{name:"missions.objectiveSubjects.squads"},OBJECTIVE_SUBJECTS_TEAM:{name:"missions.objectiveSubjects.team"},OBJECTIVE_SUBJECTS_TEAMS:{name:"missions.objectiveSubjects.teams"},OBJECTIVE_WIN_PREFIX:{name:"missions.winObjective.",optional:!0},OBJECTIVE_LOSE_PREFIX:{name:"missions.loseObjective.",optional:!0}},t.OBJECTIVE={DESTROY_ALL_SUFFIX:{name:"destroyAll",optional:!0},DESTROY_SUFFIX:{name:"destroy",optional:!0},DESTROY_ONE_SUFFIX:{name:"destroyOne",optional:!0},DESTROY_ANY_SUFFIX:{name:"destroyAny",optional:!0},COUNT_BELOW_SUFFIX:{name:"countBelow",optional:!0},TIME_SUFFIX:{name:"time",optional:!0},TIME_MULTI_SUFFIX:{name:"timeMulti",optional:!0}},t.LOCATION={UNKNOWN:{name:"location.unknown"},SYSTEM:{name:"location.system"}},t.SETTINGS={GENERAL:{name:"settings.general"},GRAPHICS:{name:"settings.graphics"},AUDIO:{name:"settings.audio"},GAMEPLAY:{name:"settings.gameplay"},CONTROLS:{name:"settings.controls"},DEFAULTS:{name:"settings.defaults"}},t.INGAME_MENU={TITLE:{name:"ingameMenu.title"},RESUME:{name:"ingameMenu.resume"},RESTART:{name:"ingameMenu.restart"},RESTART_HEADER:{name:"ingameMenu.restartDialog.header"},RESTART_MESSAGE:{name:"ingameMenu.restartDialog.message"},RESTART_RESTART:{name:"ingameMenu.restartDialog.restartButton"},QUIT:{name:"ingameMenu.quit"},QUIT_HEADER:{name:"ingameMenu.quitDialog.header"},QUIT_MESSAGE:{name:"ingameMenu.quitDialog.message"},QUIT_TO_MISSIONS:{name:"ingameMenu.quitDialog.quitToMissionsButton"},QUIT_TO_MAIN_MENU:{name:"ingameMenu.quitDialog.quitToMainMenuButton"}},t.INFO_BOX={HEADER:{name:"infoBox.header"},OK_BUTTON:{name:"infoBox.okButton"}},t.LOADING={HEADER:{name:"loading.header"},RESOURCES_START:{name:"loading.resourcesStart"},RESOURCE_READY:{name:"loading.resourceReady"},INIT_WEBGL:{name:"loading.initWebGL"},READY:{name:"loading.ready"}},t.SPACECRAFT_STATS={ARMOR:{name:"spacecraftStats.armor"},ARMOR_RATING:{name:"spacecraftStats.armorRating"}},t.MISSION={PREFIX:{name:"mission.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0},MESSAGES_SUFFIX:{name:".messages.",optional:!0}},t.FACTION={PREFIX:{name:"faction.",optional:!0}},t.SQUAD={PREFIX:{name:"squad.",optional:!0}},t.BATTLE={DEVELOPMENT_VERSION_NOTICE:{name:"battle.developmentVersionNotice"},SPECTATOR_MODE:{name:"battle.spectatorMode"},SCORE:{name:"battle.score"},HUD_FIREPOWER:{name:"battle.hud.firepower"},HUD_DISTANCE:{name:"battle.hud.distance"},HUD_VELOCITY:{name:"battle.hud.velocity"},HUD_SPACECRAFT_NAME_UNKNOWN:{name:"battle.hud.spacecraftNameUnknown"},HUD_TEAM_UNKNOWN:{name:"battle.hud.teamUnknown"},HUD_WINGMEN_HEADER:{name:"battle.hud.wingmenHeader"},HUD_FLIGHT_MODE:{name:"battle.hud.flightMode"},HUD_MISSILES:{name:"battle.hud.missiles"},HUD_OBJECTIVES:{name:"battle.hud.objectives"},HUD_ESCORTED_SHIPS_HEADER:{name:"battle.hud.escortedShipsHeader"},OBJECTIVE_SUBJECTS_SPACECRAFTS:{name:"battle.objectiveSubjects.spacecrafts"
},OBJECTIVE_SUBJECTS_SQUADS:{name:"battle.objectiveSubjects.squads"},OBJECTIVE_SUBJECTS_TEAMS:{name:"battle.objectiveSubjects.teams"},OBJECTIVE_WIN_PREFIX:{name:"battle.winObjective.",optional:!0},OBJECTIVE_LOSE_PREFIX:{name:"battle.loseObjective.",optional:!0},LOADING_BOX_LOADING_MISSION:{name:"battle.loadingBox.loadingMission"},LOADING_BOX_BUILDING_SCENE:{name:"battle.loadingBox.buildingScene"},MESSAGE_READY:{name:"battle.message.ready"},MESSAGE_PAUSED:{name:"battle.message.paused"},MESSAGE_VICTORY:{name:"battle.message.victory"},MESSAGE_FAIL:{name:"battle.message.fail"},MESSAGE_DEFEAT_HEADER:{name:"battle.message.defeat.header"},MESSAGE_DEFEAT_MESSAGE:{name:"battle.message.defeat.message"},MESSAGE_DEFEAT_DEBRIEFING:{name:"battle.message.defeat.debriefingButton"},MESSAGE_DEFEAT_RESTART:{name:"battle.message.defeat.restartButton"},MESSAGE_DEFEAT_SPECTATE:{name:"battle.message.defeat.spectateButton"},MESSAGE_JUMP_ENGAGED:{name:"battle.message.jump.engaged"},MESSAGE_JUMP_PREPARING:{name:"battle.message.jump.preparing"},MESSAGE_NEW_HOSTILES:{name:"battle.message.newHostiles"}},t.PERFORMANCE_LEVEL={PREFIX:{name:"performanceLevel.",optional:!0}},t.DEBRIEFING={BACK:{name:"debriefing.backButton"},VICTORY_TITLE:{name:"debriefing.victoryTitle"},DEFEAT_TITLE:{name:"debriefing.defeatTitle"},GENERIC_TITLE:{name:"debriefing.genericTitle"},SCORE:{name:"debriefing.score"},NEW_RECORD:{name:"debriefing.newRecord"},DESCRIPTION_VICTORY:{name:"debriefing.description.victory"},DESCRIPTION_NEXT_PERFORMANCE:{name:"debriefing.description.nextPerformance"},DESCRIPTION_FAIL:{name:"debriefing.description.fail"},DESCRIPTION_DEFEAT:{name:"debriefing.description.defeat"},DESCRIPTION_LEFT_EARLY:{name:"debriefing.description.leftEarly"},DESCRIPTION_GENERIC:{name:"debriefing.description.generic"},OBJECTIVES_HEADER:{name:"debriefing.objectivesHeader"},COMPLETED:{name:"debriefing.completed"},FAILED:{name:"debriefing.failed"},STATISTICS_HEADER:{name:"debriefing.statisticsHeader"},TIME_LABEL_CELL:{name:"debriefing.timeLabelCell"},KILLS_LABEL_CELL:{name:"debriefing.killsLabelCell"},DAMAGE_LABEL_CELL:{name:"debriefing.damageLabelCell"},HIT_RATIO_LABEL_CELL:{name:"debriefing.hitRatioLabelCell"},HULL_INTEGRITY_LABEL_CELL:{name:"debriefing.hullIntegrityLabelCell"},TEAM_SURVIVAL_LABEL_CELL:{name:"debriefing.teamSurvivalLabelCell"},BASE_SCORE_LABEL_CELL:{name:"debriefing.baseScoreLabelCell"},HIT_RATIO_BONUS_LABEL_CELL:{name:"debriefing.hitRatioBonusLabelCell"},HULL_INTEGRITY_BONUS_LABEL_CELL:{name:"debriefing.hullIntegrityBonusLabelCell"},TEAM_SURVIVAL_BONUS_LABEL_CELL:{name:"debriefing.teamSurvivalBonusLabelCell"},SCORE_BREAKDOWN_HEADER:{name:"debriefing.scoreBreakdownHeader"},RESTART_BUTTON:{name:"debriefing.restartButton"}},t.DATABASE={BACK:{name:"database.backButton"},TITLE:{name:"database.title"},PREV_BUTTON:{name:"database.prevButton"},NEXT_BUTTON:{name:"database.nextButton"},LOADING_BOX_INITIALIZING:{name:"database.loadingBox.initializing"},LENGTH:{name:"database.length"},WEAPON_SLOTS:{name:"database.weaponSlots"},MISSILE_LAUNCHERS:{name:"database.missileLaunchers"},LOCK_RESIST:{name:"database.lockResist"},MISSING_SPACECRAFT_TYPE_DESCRIPTION:{name:"database.missingSpacecraftTypeDescription"},MISSING_SPACECRAFT_CLASS_DESCRIPTION:{name:"database.missingSpacecraftClassDescription"}},t.ABOUT={BACK:{name:"about.backButton"},TITLE:{name:"about.title"},VERSION_PARAGRAPH:{name:"about.versionParagraph"},ABOUT_GAME_PARAGRAPH:{name:"about.aboutGameParagraph"},ABOUT_GAME_DEV_PARAGRAPH:{name:"about.aboutGameDevParagraph"},LICENSE_NOTE:{name:"about.licenseNote"},CREDITS_HEADER:{name:"about.creditsHeader"},CREDITS_GAME_DESIGN:{name:"about.creditsGameDesign"},CREDITS_PROGRAMMING:{name:"about.creditsProgramming"},CREDITS_REQUIREJS_NOTE:{name:"about.creditsRequireJSNote"},CREDITS_FONTS:{name:"about.creditsFonts"},CREDITS_MODELS:{name:"about.credits3DModels"},CREDITS_TEXTURES:{name:"about.creditsTextures"},CREDITS_MUSIC:{name:"about.creditsMusic"},CREDITS_SFX:{name:"about.creditsSoundEffects"},CREDITS_FREESOUND_NOTE:{name:"about.creditsFreesoundNote"},CREDITS_OTHER_SOUNDS_NOTE:{name:"about.creditsOtherSoundsNote"},CREDITS_SOUND_LICENSE_NOTE:{name:"about.creditsSoundLicenseNote"},CREDITS_TESTING:{name:"about.creditsTesting"},USED_SOFTWARE_HEADER:{name:"about.usedSoftwareHeader"},USED_SOFTWARE_PARAGRAPH:{name:"about.usedSoftwareParagraph"},LICENSE_HEADER:{name:"about.licenseHeader"},LICENSE_PARAGRAPH:{name:"about.licenseParagraph"},REQUIRE_JS_LICENSE:{name:"about.requireJSLicense"},HERE:{name:"about.here"}},t.SETTING={PREFIX:{name:"setting.",optional:!0},ON:{name:"setting.on"},OFF:{name:"setting.off"},VERY_LOW:{name:"setting.veryLow"},LOW:{name:"setting.low"},MEDIUM:{name:"setting.medium"},HIGH:{name:"setting.high"},VERY_HIGH:{name:"setting.veryHigh"},NORMAL:{name:"setting.normal"},MINIMUM:{name:"setting.minimum"},MAXIMUM:{name:"setting.maximum"},FEW:{name:"setting.few"},MANY:{name:"setting.many"},EASY:{name:"setting.easy"},HARD:{name:"setting.hard"},CUSTOM:{name:"setting.custom"}},t.GENERAL_SETTINGS={BACK:{name:"generalSettings.backButton"},TITLE:{name:"generalSettings.title"},LANGUAGE:{name:"generalSettings.language"},ANALYTICS:{name:"generalSettings.analytics"},ANALYTICS_NOTE:{name:"generalSettings.analyticsNote"}},t.GRAPHICS={PREFIX:{name:"graphics.",optional:!0},BACK:{name:"graphics.backButton"},TITLE:{name:"graphics.title"},GENERAL_LEVEL:{name:"graphics.generalLevel"},ANTIALIASING:{name:"graphics.antialiasing"},FILTERING:{name:"graphics.filtering"},BILINEAR:{name:"graphics.bilinear"},TRILINEAR:{name:"graphics.trilinear"},ANISOTROPIC:{name:"graphics.anisotropic"},TEXTURE_QUALITY:{name:"graphics.textureQuality"},BACKGROUND_QUALITY:{name:"graphics.backgroundQuality"},MODEL_DETAILS:{name:"graphics.modelDetails"},MISSILES_IN_LAUNCHERS:{name:"graphics.missilesInLaunchers"},SHADERS:{name:"graphics.shaders"},SHADOWS:{name:"graphics.shadows"},SHADOW_QUALITY:{name:"graphics.shadowQuality"},SHADOW_DISTANCE:{name:"graphics.shadowDistance"},MAX_DYNAMIC_LIGHTS:{name:"graphics.maxDynamicLights"},PARTICLE_AMOUNT:{name:"graphics.particleAmount"},DUST_PARTICLE_AMOUNT:{name:"graphics.dustParticleAmount"}},t.GAMEPLAY_SETTINGS={PREFIX:{name:"gameplaySettings.",optional:!0},BACK:{name:"gameplaySettings.backButton"},TITLE:{name:"gameplaySettings.title"},HUD_TITLE:{name:"gameplaySettings.hudTitle"},CAMERA_TITLE:{name:"gameplaySettings.cameraTitle"},CONTROLS_TITLE:{name:"gameplaySettings.controlsTitle"},TARGET_HEALTH_AT_CENTER:{name:"gameplaySettings.targetHealthAtCenter"},OFFSET_IMPACT_INDICATORS:{name:"gameplaySettings.offsetImpactIndicators"},RELATIVE_TARGET_ORIENTATION:{name:"gameplaySettings.relativeTargetOrientation"},PREFERRED_FIGHTER_VIEW:{name:"gameplaySettings.preferredFighterView"},PREFERRED_SHIP_VIEW:{name:"gameplaySettings.preferredShipView"},DEMO_VIEW_SWITCHING:{name:"gameplaySettings.demoViewSwitching"},DEFAULT_SALVO_MODE:{name:"gameplaySettings.defaultSalvoMode"}},t.AUDIO={PREFIX:{name:"audio.",optional:!0},BACK:{name:"audio.backButton"},TITLE:{name:"audio.title"},MASTER_VOLUME:{name:"audio.masterVolume"},MUSIC_VOLUME:{name:"audio.musicVolume"},SFX_VOLUME:{name:"audio.sfxVolume"},UI_VOLUME:{name:"audio.uiVolume"}},t.CONTOLLER={PREFIX:{name:"controller.",optional:!0},GENERAL:{name:"controller.general"},FIGHTER:{name:"controller.fighter"},CAMERA:{name:"controller.camera"}},t.INPUT={DEVICE_NAME_PREFIX:{name:"inputDevice.",optional:!0},DEVICE_KEYBOARD:{name:"inputDevice.keyboard"},DEVICE_MOUSE:{name:"inputDevice.mouse"},DEVICE_JOYSTICK:{name:"inputDevice.joystick"}},t.TOUCH_AREA={PREFIX:{name:"touchArea.",optional:!0},DEFAULT:{name:"touchArea.default"}},t.CONTROLS={BACK:{name:"controls.backButton"},SETTINGS_TITLE:{name:"controls.settingsTitle"},TITLE:{name:"controls.title"},MOUSE_TURN_SENSITIVITY:{name:"controls.mouseTurnSensitivity"},CONTROLLER_TYPE_HEADING:{name:"controls.controllerHeading"},ACTION:{name:"controls.action"}},t.ACTION_DESCRIPTIONS={PREFIX:{name:"actionDescriptions.",optional:!0}},t.SPACECRAFT_CLASS={PREFIX:{name:"spacecraftClass.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},t.SPACECRAFT_TYPE={PREFIX:{name:"spacecraftType.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},t.WEAPON_CLASS={PREFIX:{name:"weaponClass.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},t.MISSILE_CLASS={PREFIX:{name:"missileClass.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},t.PROPULSION_CLASS={PREFIX:{name:"propulsionClass.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},t.SHIELD_CLASS={PREFIX:{name:"shieldClass.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},t.MISSILE_SIZE={PREFIX:{name:"missileSize.",optional:!0}},t.OBJECT_VIEW={PREFIX:{name:"objectView.",optional:!0}},t.FLIGHT_MODE={PREFIX:{name:"flightMode.",optional:!0}},t.TIP={PREFIX:{name:"tip.",optional:!0}},t.getDefiniteArticleForWord=function(i){return t.get(e(i)?t.GRAMMAR.DEFINITE_ARTICLE_BEFORE_VOWEL:t.GRAMMAR.DEFINITE_ARTICLE_BEFORE_CONSONANT)},t.getList=function(e){var i,s;for(i=e[0],s=1;s<e.length-1;s++)i+=", "+e[s];return e.length>1&&(i+=" "+t.get(t.GRAMMAR.AND)+" "+e[e.length-1]),i},t}),define("armada/logic/classes",["utils/utils","utils/types","utils/vectors","utils/matrices","modules/application","modules/resource-manager","modules/egom-model","modules/physics","modules/media-resources","modules/scene/camera","modules/scene/renderable-objects","armada/graphics","armada/strings"],function(t,e,i,s,n,o,r,a,l,h,u,c,_){"use strict";function d(t){return At.getResource(bt,t)}function p(t){return At.getResource(Dt,t)}function g(t){return At.getResource(wt,t)}function m(t){return At.getResource(Ft,t)}function f(t){return At.getResource(Pt,t)}function S(t){return At.getResource(Vt,t)}function T(t){return At.getResource(Ut,t)}function E(t){return At.getResource(Bt,t)}function y(t){return At.getResource(Ht,t)}function I(t){return At.getResource(Gt,t)}function A(t){return At.getResource(jt,t)}function M(t,e){return At.getResource(kt,t,{allowNullResult:e})}function C(t){var e,i=[],s=At.getResourceNames(kt);for(e=0;e<s.length;e++)t&&!M(s[e]).shouldShowInDatabase()||i.push(M(s[e]));return i}function N(){return At.getResourceTypes()}function O(t){return At.getResourceNames(t)}function R(t,e,i){return At.getResource(t,e,i)}function L(t,e){n.showError("Cannot initialize "+t.constructor.name+" without correctly specifying its property '"+e+"'!",n.ErrorSeverity.SEVERE,"The property was either not specified, or it was specified with a wrong type or an invalid value."+("string"==typeof t._name?"The error happened while initializing '"+t._name+"'":""))}function x(t,e){return L(t,e),0}function v(t,e){return L(t,e),""}function b(t,e){return L(t,e),[0,0]}function D(t,e){return L(t,e),[0,0,0]}function w(t,e){return L(t,e),[]}function F(t,e){return L(t,e),null}function P(t){t.resource=l.getSoundEffect(t.name)}function V(t,e){t.resource.play(t.volume,e)}function U(t,e,i,s,n,o){return t.resource?t.resource.createSoundClip(l.SoundCategory.SOUND_EFFECT,t.volume,e,s,n,o,i):null}function B(t,e,s){var n,o,r,a,l,h,u,c,_;for(n=0;n<t.thrusterSlots.length;n++){if(r=t.thrusterSlots[n].group,a=t.thrusterSlots[n].uses,t.thrusterSlots[n].count>0)for(l=t.thrusterSlots[n].position||D(e,"thrusterSlot array position"),h=t.thrusterSlots[n].vector||D(e,"thrusterSlot array vector"),u=t.thrusterSlots[n].size||x(e,"thrusterSlot array size"),c=t.thrusterSlots[n].count,o=0;o<c;o++)s.push(new lt({position:i.sum3(l,i.scaled3(h,o)),size:u,groupIndex:r,uses:a}));if(t.thrusterSlots[n].thrusters)for(o=0;o<t.thrusterSlots[n].thrusters.length;o++)_=Object.assign({},t.thrusterSlots[n].thrusters[o]),_.groupIndex=r,_.uses=a,s.push(new lt(_))}}function H(t,e){o.JSONResource.call(this,t,Mt,e)}function G(t,e){H.call(this,t,e)}function j(t,e){G.call(this,t,e)}function k(t){j.call(this,t)}function W(t,e){j.call(this,t,e)}function X(t){W.call(this,t,!0)}function Y(t){W.call(this,t,!0)}function z(t){H.call(this,t)}function q(t){j.call(this,t)}function Q(t){W.call(this,t,!0)}function J(t){H.call(this,t)}function K(t){W.call(this,t)}function Z(t){W.call(this,t)}function $(t){this._pClass=t?f(t.projectile||v(this,"projectile")):null,this._pVelocity=t?t.projectileVelocity||x(this,"projectileVelocity"):0,this._positionVector=t?t.position?t.position.slice():D(this,"position"):null,this._positionVector&&this._positionVector.push(1)}function tt(t){this.axis=e.getValueOfType("WeaponRotator.axis",e.VECTOR3,t.axis),this.center=e.getValueOfType("WeaponRotator.center",e.VECTOR3,t.center),this.range=e.getValueOfType("WeaponRotator.range",e.VECTOR2,t.range,null,!0),this.range&&(this.range[0]=Math.radians(this.range[0]),this.range[1]=Math.radians(this.range[1])),this.defaultAngle=Math.radians(e.getValueOfType("WeaponRotator.defaultAngle",e.NUMBER,t.defaultAngle,0,!0)),this.restricted=!!this.range,this.rotationRate=Math.radians(e.getValueOfType("WeaponRotator.rotationRate",e.NUMBER,t.rotationRate)),this.transformGroupIndex=e.getValueOfType("WeaponRotator.transformGroupIndex",e.NUMBER,t.transformGroupIndex)}function et(t){W.call(this,t)}function it(t){H.call(this,t)}function st(t){H.call(this,t)}function nt(t){H.call(this,t)}function ot(t){H.call(this,t)}function rt(t){this.positionMatrix=t?s.translation4v(t.position||D(this,"position")):null,this.orientationMatrix=t?s.rotation4FromJSON(t.rotations||[]):null}function at(e){var n,o,r;if(this.tubePositions=e?e.tubes?[]:w(this,"tubes"):null,this.tubePositions)for(n=0;n<e.tubes.length;n++)if(r=e.tubes[n],r.count>1)for(o=0;o<r.count;o++)this.tubePositions.push(i.sum3(r.position,i.scaled3Aux(r.vector,o)));else this.tubePositions.push(r.position);this.orientationMatrix=e?s.rotation4FromJSON(e.rotations||[]):null,this.size=e?t.getSafeEnumValue(Rt,e.size,null)||v(this,"size"):null,this.capacity=e?e.capacity||x(this,"capacity"):0,this.salvo=e?e.salvo||1:0}function lt(t){this.positionVector=t?t.position.slice()||D(this,"position"):null,this.positionVector&&this.positionVector.push(1),this.size=t?t.size||1:0,this.uses=t?t.uses||w(this,"uses"):null,this.group=t?"number"==typeof t.groupIndex?t.groupIndex:x(this,"groupIndex"):0}function ht(t){this.className=t?t.class||v(this,"class"):null,this.slotIndex=t?t.slotIndex:-1}function ut(t){this.className=t?t.class||v(this,"class"):null,this.launcherIndex=t?t.launcherIndex:-1,this.amount=t?t.amount||x(this,"amount"):0}function ct(t){this.className=t?t.class||v(this,"class"):null}function _t(t){this.className=t?t.class||v(this,"class"):null}function dt(t){this.className=t?t.class||v(this,"class"):null}function pt(t){var e;if(this._name=t.name||"custom",this._wDescriptors=[],t.weapons)for(e=0;e<t.weapons.length;e++)this._wDescriptors.push(new ht(t.weapons[e]));if(this._mDescriptors=[],t.missiles)for(e=0;e<t.missiles.length;e++)this._mDescriptors.push(new ut(t.missiles[e]));this._propulsionDescriptor=t.propulsion?new ct(t.propulsion):null,this._jumpEngineDescriptor=t.jumpEngine?new _t(t.jumpEngine):null,this._shieldDescriptor=t.shield?new dt(t.shield):null}function gt(e){this._name=e?e.name||v(this,"name"):null,this._fps=!!e&&("boolean"==typeof e.fps&&e.fps),this._fov=e?e.fov||0:0,this._fovRange=e?e.fovRange||null:null,this._movable=!!e&&!0===e.movable,this._turnable=!!e&&!0===e.turnable,this.pM=e?s.translation4v(e.position||D(this,"position")):null,this.oM=e?s.rotation4FromJSON(e.rotations):null,this._alphaRange=e&&this._fps?e.alphaRange||[-360,360]:[0,0],this._betaRange=e&&this._fps?e.betaRange||[-90,90]:[0,0],this._span=e?e.span||0:0,this._confines=e?e.confines||null:null,this._resetsWhenLeavingConfines=!!e&&("boolean"==typeof e.resetsWhenLeavingConfines&&e.resetsWhenLeavingConfines),this._baseOrientation=e&&e.baseOrientation?t.getSafeEnumValue(h.CameraOrientationConfiguration.BaseOrientation,e.baseOrientation)||n.showError("Invalid value '"+e.baseOrientation+"' specified for view baseOrientation!",n.ErrorSeverity.MINOR,"Valid values are: "+t.getEnumValues(h.CameraOrientationConfiguration.BaseOrientation).join(", ")+"."):null,this._pointToFallback=e&&e.pointToFallback?t.getSafeEnumValue(h.CameraOrientationConfiguration.PointToFallback,e.pointToFallback)||n.showError("Invalid value '"+e.pointToFallback+"' specified for view pointToFallback!",n.ErrorSeverity.MINOR,"Valid values are: "+t.getEnumValues(h.CameraOrientationConfiguration.PointToFallback).join(", ")+"."):null,this._excludeFromCycle=!!e&&("boolean"==typeof e.excludeFromCycle&&e.excludeFromCycle)}function mt(e){var i;gt.call(this,e),i=t.getSafeEnumValue(Nt,e.lookAt,Nt.NONE),this._isAimingView=!0===e.aimingView,this._followsPosition=void 0!==e.followsPosition?e.followsPosition:i!==Nt.SELF,this._followsOrientation=void 0!==e.followsOrientation?e.followsOrientation:i===Nt.NONE,this._lookAtSelf=i===Nt.SELF&&(!(this._followsPosition||this._followsOrientation||this._turnable)||n.showError("Invalid view configuration ('"+this._name+"'): lookAt mode cannot be 'self' if followsPosition, followsOrientation or turnable are true!")),this._lookAtTarget=i===Nt.TARGET&&(!this._followsOrientation&&!this._turnable||n.showError("Invalid view configuration ('"+this._name+"'): lookAt mode cannot be 'target' if followsOrientation or turnable are true!")),this._rotationCenterIsObject="boolean"==typeof e.rotationCenterIsObject&&(!!e.rotationCenterIsObject&&(!(this._lookAtSelf||!this._followsPosition)||n.showError("Invalid view configuration ('"+this._name+"'): rotationCenterIsObject with lookAtSelf or without followsPosition!"))),this._startsWithRelativePosition=!0===e.startsWithRelativePosition&&(!this._followsPosition&&!this._rotationCenterIsObject||n.showError("Invalid view configuration ('"+this._name+"'): startsWithRelativePosition cannot be set to true if followsPosition or rotationCenterIsObject are true!")),this._distanceRange=(this._rotationCenterIsObject||this._lookAtSelf||this._lookAtTarget)&&this._movable?e.distanceRange||b(this,"distanceRange"):e.distanceRange||null,this._movesRelativeToObject=!0===e.movesRelativeToObject&&(!(this._rotationCenterIsObject||!this._followsPosition||!this._followsOrientation)||n.showError("Invalid view configuration ('"+this._name+"'): movesRelativeToObject can only be set if both position and orientation is followed and rotationCenterIsObject is false!")),this._resetsOnFocusChange="boolean"==typeof e.resetsOnFocusChange&&e.resetsOnFocusChange,!this._followsPosition&&!this._startsWithRelativePosition&&(this._lookAtSelf||this._lookAtTarget)&&this._confines&&this._distanceRange&&n.showError("Invalid view configuration ('"+this._name+"'): A lookAt configuration with absolute position cannot have both position and distance confines!",n.ErrorSeverity.SEVERE,"Setting this configuration will likely cause a crash as position confines are absolute (if the position is absolute) but distance confines are relative to the lookAt object."),this._followsPosition||this._startsWithRelativePosition||!this._resetsWhenLeavingConfines||n.showError("Invalid view configuration ('"+this._name+"'): resetsWhenLeavingConfines cannot be set if position is absolute!")}function ft(e){gt.call(this,e),this._turnAroundAll="boolean"==typeof e.turnAroundAll&&e.turnAroundAll,this._lookAtAll=t.getSafeEnumValue(Ot,e.lookAt,Ot.NONE)===Ot.ALL&&(!this._turnAroundAll&&!this._turnable||n.showError("Invalid view configuration ('"+this._name+"'): lookAt mode cannot be 'all' if turnAroundAll or turnable are true!")),this._distanceRange=(this._turnAroundAll||this._lookAtAll)&&this._movable?e.distanceRange||b(this,"distanceRange"):e.distanceRange||null,this._startsWithRelativePosition=!0===e.startsWithRelativePosition&&(!this._turnAroundAll||n.showError("Invalid view configuration ('"+this._name+"'): startsWithRelativePosition cannot be true if the view is set to turn around the objects!")),!this._turnAroundAll&&!this._startsWithRelativePosition&&this._lookAtAll&&this._confines&&this._distanceRange&&n.showError("Invalid view configuration ('"+this._name+"'): A lookAt configuration with absolute position cannot have both position and distance confines!",n.ErrorSeverity.SEVERE,"Setting this configuration will likely cause a crash as position confines are absolute (if the position is absolute) but distance confines are relative to the lookAt object."),this._turnAroundAll||this._startsWithRelativePosition||!this._resetsWhenLeavingConfines||n.showError("Invalid view configuration ('"+this._name+"'): resetsWhenLeavingConfines cannot be set if position is absolute!")}function St(t){this.hullIntegrity=t?t.hullIntegrity||x(this,"hullIntegrity"):0,this.explosionClass=t?m(t.class||v(this,"class")):null}function Tt(t){this.position=t?t.position||D(this,"position"):null,this.color=t?t.color||[1,1,1]:null,this.intensity=t?t.intensity||x(this,"intensity"):0,this.spotDirection=t?t.spotDirection||null:null,this.spotCutoffAngle=t?t.spotCutoffAngle||0:0,this.spotFullIntensityAngle=t?t.spotFullIntensityAngle||0:0}function Et(t){this._particle=null,t.particle?this._particle=new X(t.particle):L(this,"particle"),this._position=t?t.position||D(this,"position"):null,this._period=t?t.period||x(this,"period"):0,this._blinks=t?t.blinks||w(this,"blinks"):null,this._intensity=t?t.intensity||x(this,"intensity"):0,this._lightColor=this._particle?[this._particle._color[0],this._particle._color[1],this._particle._color[2]]:null}function yt(t){W.call(this,t)}function It(t,e){var i={};i[bt]=k,i[Dt]=z,i[wt]=q,i[Ft]=J,i[Pt]=K,i[Ut]=et,i[Bt]=it,i[Vt]=Z,i[Ht]=st,i[Gt]=nt,i[jt]=ot,i[kt]=yt,At.requestConfigLoad(t.filename,t.folder,i,function(){At.requestAllResources(),At.requestResourceLoad(),e&&e()}),Mt=t.folder}var At,Mt,Ct={OMNIDIRECTIONAL:"omnidirectional",UNIDIRECTIONAL:"unidirectional",PLANAR:"planar"},Nt={NONE:"none",SELF:"self",TARGET:"target"},Ot={NONE:"none",ALL:"all"},Rt={SMALL:"small",MEDIUM:"medium",LARGE:"large"},Lt={NONE:0,INITIAL:1,CONTINUOUS:2},xt={NONE:"none",YAW_PITCH:"yawPitch",ROLL_YAW:"rollYaw"},vt={YAW_PITCH:"yawPitch",ROLL_YAW:"rollYaw",ROLL_PITCH:"rollPitch"},bt="skyboxClasses",Dt="backgroundObjectClasses",wt="dustCloudClasses",Ft="explosionClasses",Pt="projectileClasses",Vt="missileClasses",Ut="weaponClasses",Bt="propulsionClasses",Ht="jumpEngineClasses",Gt="shieldClasses",jt="spacecraftTypes",kt="spacecraftClasses",Wt={NAME:{name:"name",type:"string"},VOLUME:{name:"volume",type:"number",range:[0,10],defaultValue:1},RESOURCE:{name:"resource",type:"object",optional:!0}},Xt={NAME:{name:"name",type:"string"},VOLUME:{name:"volume",type:"number",range:[0,50],defaultValue:1},RESOURCE:{name:"resource",type:"object",optional:!0}};return Object.freeze(Ct),Object.freeze(Nt),Object.freeze(Ot),Object.freeze(Lt),Object.freeze(xt),Object.freeze(vt),H.prototype=new o.JSONResource,H.prototype.constructor=H,H.prototype.showResourceAccessError=function(t,e){n.showError("Attempting to access "+t+" ('"+e+"') of class '"+this._name+"' before it has been loaded!")},H.prototype.handleGraphicsSettingsChanged=function(){},G.prototype=new H,G.prototype.constructor=G,G.prototype._overrideData=function(t,e){H.prototype._loadData.call(this,e),this._shaderName=t?e&&e.shader?e.shader:t._shaderName:e?e.shader||v(this,"shader"):null,this._shader=null,this._instancedShaderName=null,this._instancedShader=null,this._managedShader=null,this._managedInstancedShader=null},G.prototype._loadData=function(t){return this._overrideData(null,t),!0},G.prototype.acquireResources=function(e){e=e||t.EMPTY_OBJECT,e.omitShader||(this._shader=c.getShader(this._shaderName),this._instancedShaderName=l.getShader(this._shaderName).getVariantShaderName("instanced"),this._instancedShaderName&&(this._instancedShader=c.getShader(this._instancedShaderName)))},G.prototype.getShader=function(){return null===this._shader?(this.showResourceAccessError("shader",this._shaderName),null):(this._managedShader||(this._managedShader=c.getManagedShader(this._shaderName)),this._managedShader)},G.prototype.getInstancedShader=function(){return null===this._instancedShader?(n.showError("Attempting to access the instanced shader of '"+this._name+"', which does not exist (or is not loaded)!"),null):(this._managedInstancedShader||(this._managedInstancedShader=c.getManagedShader(this._instancedShaderName)),this._managedInstancedShader)},G.prototype.handleGraphicsSettingsChanged=function(){this._managedShader=null,this._managedInstancedShader=null},j.prototype=new G,j.prototype.constructor=j,j.prototype._overrideData=function(t,e){G.prototype._overrideData.call(this,t,e),this._modelName=t?e&&e.model?e.model:t._modelName:e?e.model||null:null,this._model=null},j.prototype._loadData=function(t){return this._overrideData(null,t),!0},j.prototype.acquireResources=function(t){G.prototype.acquireResources.call(this,t),t&&t.model?(this._model=l.getOrAddModel(t.model),this._modelName=this._model._name):this._model=c.getModel(this._modelName)},j.prototype.getModel=function(){return null===this._model?(this.showResourceAccessError("model",this._modelName),null):this._model.getEgomModel()},k.prototype=new j,k.prototype.constructor=k,k.prototype._loadData=function(t){return j.prototype._loadData.call(this,t),this._cubemapName=t?t.cubemap||v(this,"cubemap"):null,this._cubemap=null,!0},k.prototype.acquireResources=function(){j.prototype.acquireResources.call(this,{model:r.fvqModel("fvqModel")}),null===this._cubemap&&(this._cubemap=c.getCubemap(this._cubemapName))},k.prototype.getCubemap=function(t){return null===this._cubemap?(this.showResourceAccessError("cubemap",this._cubemapName),null):this._cubemap.getManagedCubemap(t)},k.prototype.handleGraphicsSettingsChanged=function(){j.prototype.handleGraphicsSettingsChanged.call(this),this._cubemap=null},W.prototype=new j,W.prototype.constructor=W,W.prototype._overrideData=function(t,e){var i,s,o;for(j.prototype._overrideData.call(this,t,e),this._textureName=t?e&&e.texture?e.texture:t._textureName:e?e.texture||v(this,"texture"):null,this._texture=null,this._defaultLuminosityFactors=[],i=0,o=c.getMaxLuminosityFactors();i<o;i++)this._defaultLuminosityFactors.push(0);if(e.defaultLuminosityFactors)for(i=0;i<e.defaultLuminosityFactors.length;i++)s=e.defaultLuminosityFactors[i][0],s<c.getMaxLuminosityFactors()?this._defaultLuminosityFactors[s]=e.defaultLuminosityFactors[i][1]:n.showError("Attempting to set luminosity of group with index "+s+", while there are only "+c.getMaxLuminosityFactors()+" luminosity groups available. (and indices start with 0)",n.ErrorSeverity.MINOR,"Happened while creating textured model class '"+this._name+"'.");else t&&(this._defaultLuminosityFactors=t._defaultLuminosityFactors.slice())},W.prototype._loadData=function(t){return this._overrideData(null,t),!0},W.prototype.acquireResources=function(t){j.prototype.acquireResources.call(this,t),null===this._texture&&(this._texture=c.getTexture(this._textureName))},W.prototype.getTexture=function(t,e){return null===this._texture?(this.showResourceAccessError("texture",this._textureName),null):this._texture.getManagedTexture(t,e)},W.prototype.getTexturesOfTypes=function(t,e){return null===this._texture?(this.showResourceAccessError("texture",this._textureName),null):this._texture.getManagedTexturesOfTypes(t,e)},W.prototype.getDefaultGroupLuminosity=function(t){return this._defaultLuminosityFactors[t]},W.prototype.getDefaultGroupLuminosityFactors=function(){return this._defaultLuminosityFactors},W.prototype.handleGraphicsSettingsChanged=function(){j.prototype.handleGraphicsSettingsChanged.call(this),this._texture=null},X.prototype=new W,X.prototype.constructor=X,X.prototype._loadData=function(t){return W.prototype._loadData.call(this,t),this._size=t?t.size||1:0,this._color=t?t.color||[1,1,1,1]:null,this._duration=t?t.duration:null,!0},X.prototype.acquireResources=function(){W.prototype.acquireResources.call(this,{model:r.squareModel("squareModel")})},X.prototype.getSize=function(){return this._size},Y.prototype=new W,Y.prototype.constructor=Y,Y.prototype._loadData=function(t){return W.prototype._loadData.call(this,t),this._size=t?t.size||1:0,this._color=t?t.color||[1,1,1,1]:null,this._duration=t?t.duration||x(this,"duration"):null,this._growthRate=t?t.growthRate||x(this,"growthRate"):null,!0},Y.prototype.acquireResources=function(){W.prototype.acquireResources.call(this,{model:r.turningBillboardModel("squareModel",t.EMPTY_ARRAY,1)})},Y.prototype.getSize=function(){return this._size},z.prototype=new H,z.prototype.constructor=z,z.prototype._loadData=function(t){var e;if(H.prototype._loadData.call(this,t),this._lightColor=t?t.lightColor:null,this._layers=[],t)if(t.layers&&t.layers.length>0)for(e=0;e<t.layers.length;e++)this._layers.push(new X(t.layers[e]));else L(this,"layers");return!0},z.prototype.acquireResources=function(){var t;for(t=0;t<this._layers.length;t++)this._layers[t].acquireResources()},z.prototype.handleGraphicsSettingsChanged=function(){var t;for(H.prototype.handleGraphicsSettingsChanged.call(this),t=0;t<this._layers.length;t++)this._layers[t].handleGraphicsSettingsChanged()},q.prototype=new j,q.prototype.constructor=q,q.prototype._loadData=function(t){return j.prototype._loadData.call(this,t),this._numberOfParticles=t?t.numberOfParticles||x(this,"numberOfParticles"):0,this._color=t?t.color||[1,1,1]:null,this._range=t?t.range||x(this,"range"):0,!0},q.prototype.acquireResources=function(){j.prototype.acquireResources.call(this,{model:r.lineModel("dust",[1,1,1],[1,1,1,1])})},q.prototype.getNumberOfParticles=function(){return this._numberOfParticles*c.getDustParticleCountFactor()},q.prototype.getRange=function(){return this._range},Q.prototype=new W,Q.prototype.constructor=Q,Q.prototype._loadData=function(e){var i;if(W.prototype._loadData.call(this,e),this._type=e?t.getSafeEnumValue(Ct,e.type,Ct.OMNIDIRECTIONAL):null,this._hasProjectileModel=!!e&&(e.hasProjectileModel||!1),this._pModelWidth=e?e.projectileModelWidth||1:0,this._pModelIntersection=e?e.projectileModelIntersection||0:0,this._dimensions=e?e.dimensions||[0,0,0]:null,this._directionSpread=!e||this._type!==Ct.UNIDIRECTIONAL&&this._type!==Ct.PLANAR?0:e.directionSpread||0,this._velocity=e?e.velocity||0:0,this._velocitySpread=e?e.velocitySpread||0:0,this._initialNumber=e?e.initialNumber||0:0,this._spawnNumber=e?e.spawnNumber||0:0,this._spawnTime=e?e.spawnTime||1:0,this._duration=e?e.duration||0:0,this._delay=e?e.delay||0:0,this._particleStates=null,e)if(this._particleStates=[],e.particleStates&&e.particleStates.length>0)for(i=0;i<e.particleStates.length;i++)this._particleStates.push(new u.ParticleState(e.particleStates[i].color,e.particleStates[i].size,e.particleStates[i].timeToReach));else L(this,"particleStates");return!0},Q.prototype.acquireResources=function(){W.prototype.acquireResources.call(this,{model:this._hasProjectileModel?r.turningBillboardModel("projectileModel-"+this._pModelIntersection+"-width-"+this._pModelWidth,[this._pModelIntersection],this._pModelWidth):r.squareModel("squareModel")})},Q.prototype.getType=function(){return this._type},Q.prototype.isContinuous=function(){return this._spawnNumber>0&&0===this._duration},Q.prototype.getParticleStates=function(){return this._particleStates},Q.prototype.getParticleDuration=function(){var t,e=0;for(t=1;t<this._particleStates.length;t++)e+=this._particleStates[t].timeToReach;return e},Q.prototype.getTotalDuration=function(){var t=this._delay;return this._spawnNumber&&this._spawnTime&&(t+=Math.floor(this._duration/this._spawnTime)*this._spawnTime),t+=this.getParticleDuration()},Q.prototype.getMaxParticleCount=function(){var t,e,i,s=this.getParticleDuration();return i=Math.floor(this._duration/this._spawnTime)+1,e=Math.ceil(s/this._spawnTime),
t=this._spawnNumber*(this._duration?Math.min(i,e):e),this._initialNumber>this._spawnNumber?t+=this._initialNumber-this._spawnNumber:this._initialNumber<this._spawnNumber&&this._duration&&i<=e&&(t-=this._spawnNumber-this._initialNumber),t},J.prototype=new H,J.prototype.constructor=J,J.prototype._loadData=function(t){var i;if(H.prototype._loadData.call(this,t),this._particleEmitterDescriptors=null,t&&t.particleEmitters)for(this._particleEmitterDescriptors=[],i=0;i<t.particleEmitters.length;i++)this._particleEmitterDescriptors.push(new Q(t.particleEmitters[i]));return this._lightStates=t?t.lightStates:null,this._soundEffect=t&&t.soundEffect?e.getVerifiedObject("explosionClasses['"+this._name+"'].soundEffect",t.soundEffect,Xt):null,!0},J.prototype.acquireResources=function(t){var e;for(e=0;e<this._particleEmitterDescriptors.length;e++)this._particleEmitterDescriptors[e].acquireResources();t.sound&&this._soundEffect&&P(this._soundEffect)},J.prototype.getLightStates=function(){return this._lightStates},J.prototype.getTotalDuration=function(){var t,e,i=0;for(t=0;t<this._particleEmitterDescriptors.length;t++)(e=this._particleEmitterDescriptors[t].getTotalDuration())>i&&(i=e);return i},J.prototype.getMaxParticleCount=function(){var t,e=0;for(t=0;t<this._particleEmitterDescriptors.length;t++)e+=this._particleEmitterDescriptors[t].getMaxParticleCount();return e},J.prototype.isContinuous=function(){var t;for(t=0;t<this._particleEmitterDescriptors.length;t++)if(this._particleEmitterDescriptors[t].isContinuous())return!0;return!1},J.prototype.playSound=function(t,e,i,s){var n;this._soundEffect&&(n=U(this._soundEffect,!1,t,e,i,s))&&n.play()},J.prototype.handleGraphicsSettingsChanged=function(){var t;for(H.prototype.handleGraphicsSettingsChanged.call(this),t=0;t<this._particleEmitterDescriptors.length;t++)this._particleEmitterDescriptors[t].handleGraphicsSettingsChanged()},K.prototype=new W,K.prototype.constructor=K,K.prototype._loadData=function(t){return W.prototype._loadData.call(this,t),this._damage=t?t.damage||0:0,this._size=t?t.size||1:0,this._intersectionPositions=t?t.intersectionPositions||[]:null,this._width=t?t.width||1:0,this._mass=t?t.mass||x(this,"mass"):0,this._dragFactor=t?t.dragFactor||0:0,this._duration=t?t.duration||x(this,"duration"):0,this._dissipationDuration=t?t.dissipationDuration||x(this,"dissipationDuration"):0,this._muzzleFlash=null,t&&(t.muzzleFlash?this._muzzleFlash=new X(t.muzzleFlash):L(this,"muzzleFlash")),this._lightColor=t?t.lightColor||null:null,this._lightIntensity=t&&t.lightColor?t.lightIntensity||x(this,"lightIntensity"):0,this._explosionClass=t?m(t.explosion||v(this,"explosion")):null,this._shieldExplosionClass=t?m(t.shieldExplosion||v(this,"shieldExplosion")):null,!0},K.prototype.acquireResources=function(t){W.prototype.acquireResources.call(this,{model:r.turningBillboardModel("projectileModel-"+this._intersectionPositions.join("-")+"-width-"+this._width,this._intersectionPositions,this._width)}),t.projectileOnly||(this._muzzleFlash.acquireResources(),this._explosionClass.acquireResources({sound:t.sound}),this._shieldExplosionClass.acquireResources({sound:t.sound}))},K.prototype.getDamage=function(){return this._damage},K.prototype.getSize=function(){return this._size},K.prototype.handleGraphicsSettingsChanged=function(){W.prototype.handleGraphicsSettingsChanged.call(this),this._muzzleFlash.handleGraphicsSettingsChanged()},Z.prototype=new W,Z.prototype.constructor=Z,Z.prototype._loadData=function(i){var s;return W.prototype._loadData.call(this,i),this._fullName=i?i.fullName||this._name:null,this._shortName=i?i.shortName||this._fullName&&this._fullName.split(" ")[0].substring(0,5):null,this._antiShip=!!i&&(i.antiShip||!1),this._damage=i?i.damage||0:0,this._modelScale=i?i.modelScale||1:0,this._size=i?t.getSafeEnumValue(Rt,i.size,null)||v(this,"size"):null,this._capacity=i?i.capacity||1:0,this._length=i?i.length||x(this,"length"):0,this._homingMode=i?t.getSafeEnumValueForKey(Lt,i.homingMode,Lt.NONE):null,this._mass=i?i.mass||x(this,"mass"):0,this._dragFactor=i?void 0!==i.dragFactor?i.dragFactor:1:0,this._launchVelocity=i?i.launchVelocity||0:0,this._ignitionTime=i?i.ignitionTime||0:0,this._acceleration=i?i.acceleration||x(this,"acceleration"):0,this._thrust=i?this._mass*i.acceleration||x(this,"acceleration"):0,this._angularAcceleration=this._homingMode!==Lt.NONE&&i?Math.radians(i.angularAcceleration)||x(this,"angularAcceleration"):0,this._angularThrust=i?this._mass*this._angularAcceleration:0,this._mainBurnAngleThreshold=this._homingMode!==Lt.NONE&&i?Math.radians(i.mainBurnAngleThreshold)||x(this,"mainBurnAngleThreshold"):0,this._duration=i?i.duration||x(this,"duration"):0,this._lockingTime=this._homingMode!==Lt.NONE&&i?i.lockingTime||0:0,this._lockingAngle=this._lockingTime>0&&i?Math.radians(i.lockingAngle||0):0,this._cooldown=i?i.cooldown||x(this,"cooldown"):0,this._salvoCooldown=i?i.salvoCooldown||this._cooldown:0,this._proximityRange=i?i.proximityRange||0:0,this._kineticFactor=i?i.kineticFactor||1:0,this._lightColor=i?i.lightColor||null:null,this._lightIntensity=i&&i.lightColor?i.lightIntensity||x(this,"lightIntensity"):0,this._trailDescriptor=i?i.trail?new Y(i.trail):F(this,"trail"):null,this._explosionClass=i?m(i.explosion||v(this,"explosion")):null,this._shieldExplosionClass=i?m(i.shieldExplosion||v(this,"shieldExplosion")):null,this._scoreValue=i?i.scoreValue||0:0,this._launchSound=i?e.getVerifiedObject("missileClasses['"+this._name+"'].launchSound",i.launchSound,Xt):null,this._startSound=i?e.getVerifiedObject("missileClasses['"+this._name+"'].startSound",i.startSound,Xt):null,this._propulsionClass=i?E(i.propulsion||v(this,"propulsion")):null,this._thrusterSlots=i?[]:null,i&&i.thrusterSlots?B(i,this,this._thrusterSlots):i&&L(this,"thrusterSlots"),this._enginePosition=this._thrusterSlots&&this._thrusterSlots.length>0?this._thrusterSlots[0].positionVector:[0,0,0],s=.001*(this._duration-this._ignitionTime),this._nominalRange=.001*this._duration*this._launchVelocity+.5*this._acceleration*s*s,!0},Z.prototype.acquireResources=function(t){W.prototype.acquireResources.call(this,t),t.missileOnly||(this._explosionClass.acquireResources({sound:t.sound}),this._shieldExplosionClass.acquireResources({sound:t.sound}),this._propulsionClass.acquireResources({sound:!1}),t.sound&&(P(this._launchSound),P(this._startSound)),t.trail&&this._trailDescriptor.acquireResources())},Z.prototype.getDisplayName=function(){return _.get(_.MISSILE_CLASS.PREFIX,this._name+_.MISSILE_CLASS.NAME_SUFFIX.name,this._fullName)},Z.prototype.getDamage=function(t){return Math.max(0,this._damage-t)},Z.prototype.getNominalRange=function(){return this._nominalRange},Z.prototype.getFireRate=function(){return 1e3/this._cooldown},Z.prototype.getLockingTime=function(){return this._lockingTime},Z.prototype.getSize=function(){return this._size},Z.prototype.getThrust=function(){return this._thrust},Z.prototype.getAngularThrust=function(){return this._angularThrust},Z.prototype.getForceForDuration=function(t){return this._launchVelocity*this._mass/(.001*t)},Z.prototype.getCooldown=function(){return this._cooldown},Z.prototype.getPropulsionClass=function(){return this._propulsionClass},Z.prototype.getMaxCount=function(){return Math.ceil(this._duration/this._cooldown)},Z.prototype.getParticleCount=function(){return this._thrusterSlots.length},Z.prototype.getScoreValue=function(){return this._scoreValue},Z.prototype.playLaunchSound=function(t,e,i,s){t?V(this._launchSound,t):U(this._launchSound,!1,e,!0,i,s).play()},Z.prototype.playStartSound=function(t){var e=U(this._startSound,!1,t);return e.play(),e},Z.prototype.getEnginePosition=function(){return this._enginePosition},Z.prototype.getTargetHitTime=function(e,i,s){var n,o,r,a,l;for(n=this._acceleration*this._acceleration*.25,o=-(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),r=0,l=0;l<3;l++)r+=2*s[l]*(e[l]-i[l]);for(a=0,l=0;l<3;l++)a+=-i[l]*i[l]-e[l]*e[l]+2*i[l]*e[l];return t.getSmallestPositiveSolutionOf4thDegreeEquationWithoutDegree3(n,o,r,a)},Z.prototype.handleGraphicsSettingsChanged=function(){W.prototype.handleGraphicsSettingsChanged.call(this),this._trailDescriptor.handleGraphicsSettingsChanged()},$.prototype.getProjectileClass=function(){return this._pClass},$.prototype.getProjectileVelocity=function(){return this._pVelocity},$.prototype.getForceForDuration=function(t){return this._pVelocity*this._pClass._mass/(.001*t)},$.prototype.getPositionVector=function(){return this._positionVector},$.prototype.acquireResources=function(t){this._pClass.acquireResources(t)},$.prototype.getMaxProjectileCount=function(t){return Math.ceil(this._pClass._duration/t)},$.prototype.getMaxExplosionCount=function(t){return Math.ceil(Math.max(this._pClass._explosionClass.getTotalDuration(),this._pClass._shieldExplosionClass.getTotalDuration())/t)},$.prototype.getMaxParticleCount=function(t){return 1+this.getMaxExplosionCount(t)*Math.max(this._pClass._explosionClass.getMaxParticleCount(),this._pClass._shieldExplosionClass.getMaxParticleCount())},et.prototype=new W,et.prototype.constructor=et,et.prototype._loadData=function(i){var s;if(W.prototype._loadData.call(this,i),this._fullName=i?i.fullName||this._name:null,this._cooldown=i?i.cooldown||x(this,"cooldown"):0,this._barrels=[],i)if(i.barrels)for(s=0;s<i.barrels.length;s++)this._barrels.push(new $(i.barrels[s]));else L(this,"barrels");if(this._attachmentPoint=i?i.attachmentPoint||[0,0,0]:null,this._rotationStyle=i?t.getSafeEnumValue(xt,i.rotationStyle,xt.NONE):null,this._fixed=this._rotationStyle===xt.NONE,this._basePoint=i&&!this._fixed?i.basePoint&&i.basePoint.slice()||[0,0,0]:null,this._basePoint&&this._basePoint.push(1),this._rotators=[],i&&!this._fixed)if(i.rotators)for(s=0;s<i.rotators.length;s++)this._rotators.push(new tt(i.rotators[s]));else L(this,"rotators");return this._fireSound=i?e.getVerifiedObject("weaponClasses['"+this._name+"'].fireSound",i.fireSound,Xt):null,this._scoreValue=i?i.scoreValue||0:0,!0},et.prototype.acquireResources=function(t){var e,i;if(W.prototype.acquireResources.call(this,t),t.projectileResources)for(i={projectileOnly:!1,sound:t.sound},e=0;e<this._barrels.length;e++)this._barrels[e].acquireResources(i);t.sound&&P(this._fireSound)},et.prototype.getDisplayName=function(){return _.get(_.WEAPON_CLASS.PREFIX,this._name+_.WEAPON_CLASS.NAME_SUFFIX.name,this._fullName)},et.prototype.getCooldown=function(){return this._cooldown},et.prototype.getBarrel=function(t){return this._barrels[t]},et.prototype.getProjectileClass=function(){return this._barrels[0].getProjectileClass()},et.prototype.getProjectileVelocity=function(){return this._barrels[0].getProjectileVelocity()},et.prototype.getDamage=function(t){var e,i=0;for(t=t||0,e=0;e<this._barrels.length;e++)i+=Math.max(0,this._barrels[e].getProjectileClass().getDamage()-t);return i},et.prototype.getFirepower=function(t){return 1e3*this.getDamage(t)/this._cooldown},et.prototype.getFireRate=function(){return 1e3/this._cooldown},et.prototype.playFireSound=function(t,e,i,s){t?V(this._fireSound,t):U(this._fireSound,!1,e,!0,i,s).play()},et.prototype.getScoreValue=function(){return this._scoreValue},et.prototype.getMaxProjectileCount=function(){var t,e=0;for(t=0;t<this._barrels.length;t++)e+=this._barrels[t].getMaxProjectileCount(this._cooldown);return e},et.prototype.getMaxExplosionCount=function(){var t,e=0;for(t=0;t<this._barrels.length;t++)e+=this._barrels[t].getMaxExplosionCount(this._cooldown);return e},et.prototype.getMaxParticleCount=function(){var t,e=0;for(t=0;t<this._barrels.length;t++)e+=this._barrels[t].getMaxParticleCount(this._cooldown);return e},it.prototype=new H,it.prototype.constructor=it,it.prototype._loadData=function(t){var i;return H.prototype._loadData.call(this,t),i=t?t.referenceMass||1:null,this._fullName=t?t.fullName||this._name:null,this._thrusterBurnParticle=new X(t),this._thrust=t?i*t.thrust||x(this,"thrust"):0,this._angularThrust=t?i*Math.radians(t.angularThrust)||x(this,"angularThrust"):0,this._maxMoveBurnLevel=t?t.maxMoveBurnLevel||x(this,"maxMoveBurnLevel"):0,this._maxTurnBurnLevel=t?t.maxTurnBurnLevel||x(this,"maxTurnBurnLevel"):0,this._thrusterSound=t?e.getVerifiedObject("propulsionClasses['"+this._name+"'].thrusterSound",t.thrusterSound,Xt):null,this._scoreValue=t?t.scoreValue||0:0,!0},it.prototype.acquireResources=function(t){this._thrusterBurnParticle.acquireResources(),t.sound&&P(this._thrusterSound)},it.prototype.getDisplayName=function(){return _.get(_.PROPULSION_CLASS.PREFIX,this._name+_.PROPULSION_CLASS.NAME_SUFFIX.name,this._fullName)},it.prototype.getThrust=function(){return this._thrust},it.prototype.getAngularThrust=function(){return this._angularThrust},it.prototype.getMaxMoveBurnLevel=function(){return this._maxMoveBurnLevel},it.prototype.getMaxTurnBurnLevel=function(){return this._maxTurnBurnLevel},it.prototype.handleGraphicsSettingsChanged=function(){H.prototype.handleGraphicsSettingsChanged.call(this),this._thrusterBurnParticle.handleGraphicsSettingsChanged()},it.prototype.createThrusterSoundClip=function(t){return U(this._thrusterSound,!0,t)},it.prototype.getThrusterSoundVolume=function(){return this._thrusterSound.volume},it.prototype.getScoreValue=function(){return this._scoreValue},st.prototype=new H,st.prototype.constructor=st,st.prototype._loadData=function(t){return H.prototype._loadData.call(this,t),this._engageSound=t?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].engageSound",t.engageSound,Wt):null,this._disengageSound=t?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].disengageSound",t.disengageSound,Wt):null,this._prepareVelocity=t?void 0!==t.prepareVelocity?t.prepareVelocity:x(this,"prepareVelocity"):0,this._prepareDuration=t?void 0!==t.prepareDuration?t.prepareDuration:x(this,"prepareDuration"):0,this._prepareSound=t?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].prepareSound",t.prepareSound,Xt):null,this._cancelSound=t?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].cancelSound",t.cancelSound,Xt):null,this._jumpOutAcceleration=t?t.jumpOutAcceleration||x(this,"jumpOutAcceleration"):0,this._jumpOutScaling=t?t.jumpOutScaling||1:0,this._jumpOutDuration=t?t.jumpOutDuration||x(this,"jumpOutDuration"):0,this._jumpOutSound=t?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].jumpOutSound",t.jumpOutSound,Xt):null,this._jumpOutExplosionClass=t?m(t.jumpOutExplosion||v(this,"jumpOutExplosion")):null,this._jumpInDeceleration=t?t.jumpInDeceleration||this._jumpOutAcceleration:0,this._jumpInVelocity=t?void 0!==t.jumpInVelocity?t.jumpInVelocity:this._prepareVelocity:0,this._jumpInScaling=t?t.jumpInScaling||this._jumpOutScaling:0,this._jumpInDuration=t?t.jumpInDuration||this._jumpOutDuration:0,this._jumpInSound=t?t.jumpInSound?e.getVerifiedObject("JumpEngineClasses['"+this._name+"'].jumpInSound",t.jumpInSound,Xt):this._jumpOutSound:null,this._jumpInExplosionClass=t?t.jumpInExplosion?m(t.jumpInExplosion):this._jumpOutExplosionClass:null,!0},st.prototype.acquireResources=function(t){t.sound&&(P(this._engageSound),P(this._disengageSound),P(this._prepareSound),P(this._cancelSound),P(this._jumpOutSound),P(this._jumpInSound)),this._jumpOutExplosionClass.acquireResources({sound:t.sound}),this._jumpInExplosionClass.acquireResources({sound:t.sound})},st.prototype.createEngageSoundClip=function(){return U(this._engageSound,!1)},st.prototype.createDisengageSoundClip=function(){return U(this._disengageSound,!1)},st.prototype.createPrepareSoundClip=function(t){return U(this._prepareSound,!1,t)},st.prototype.createCancelSoundClip=function(t){return U(this._cancelSound,!1,t)},st.prototype.createJumpOutSoundClip=function(t){return U(this._jumpOutSound,!1,t)},st.prototype.createJumpInSoundClip=function(t){return U(this._jumpInSound,!1,t)},nt.prototype=new H,nt.prototype.constructor=nt,nt.prototype._loadData=function(t){return H.prototype._loadData.call(this,t),this._fullName=t?t.fullName||this._name:null,this._capacity=t?t.capacity||x(this,"capacity"):0,this._rechargeDelay=t?void 0!==t.rechargeDelay?t.rechargeDelay:x(this,"rechargeDelay"):0,this._rechargeRate=t?t.rechargeRate||x(this,"rechargeRate"):0,this._rechargeColor=t?t.rechargeColor||[1,1,1]:null,this._rechargeAnimationDuration=t?t.rechargeAnimationDuration||x(this,"rechargeAnimationDuration"):0,this._rechargeStartSound=t?e.getVerifiedObject("ShieldClasses['"+this._name+"'].rechargeStartSound",t.rechargeStartSound,Xt):null,this._scoreValue=t?t.scoreValue||0:0,!0},nt.prototype.acquireResources=function(t){t.sound&&P(this._rechargeStartSound)},nt.prototype.getDisplayName=function(){return _.get(_.SHIELD_CLASS.PREFIX,this._name+_.SHIELD_CLASS.NAME_SUFFIX.name,this._fullName)},nt.prototype.getRechargeDelay=function(){return this._rechargeDelay},nt.prototype.getRechargeRate=function(){return this._rechargeRate},nt.prototype.createRechargeStartSoundClip=function(t){return U(this._rechargeStartSound,!1,t)},nt.prototype.getScoreValue=function(){return this._scoreValue},ot.prototype=new H,ot.prototype.constructor=ot,ot.prototype._loadData=function(t){return H.prototype._loadData.call(this,t),this._isFighterType=!!t&&!0===t.isFighterType,this._fullName=t?t.fullName||this._name:null,this._description=t?"string"==typeof t.description?t.description:v(this,"description"):null,this._goodAgainstTypeNames=t?t.goodAgainst||[]:null,this._badAgainstTypeNames=t?t.badAgainst||[]:null,!0},ot.prototype.getDisplayName=function(){return _.get(_.SPACECRAFT_TYPE.PREFIX,this._name+_.SPACECRAFT_TYPE.NAME_SUFFIX.name,this._fullName)},ot.prototype.getDisplayDescription=function(){return _.get(_.SPACECRAFT_TYPE.PREFIX,this._name+_.SPACECRAFT_TYPE.DESCRIPTION_SUFFIX.name,t.formatString(_.get(_.DATABASE.MISSING_SPACECRAFT_TYPE_DESCRIPTION),{spacecraftType:this.getDisplayName(),originalDescription:this._description}))},ot.prototype.getGoodAgainstTypes=function(){var t,e;for(e=[],t=0;t<this._goodAgainstTypeNames.length;t++)e.push(A(this._goodAgainstTypeNames[t]))},ot.prototype.getBadAgainstTypes=function(){var t,e;for(e=[],t=0;t<this._badAgainstTypeNames.length;t++)e.push(A(this._badAgainstTypeNames[t]))},ot.prototype.isGoodAgainst=function(t){return this._goodAgainstTypeNames.indexOf(t._name)>=0},ot.prototype.isBadAgainst=function(t){return this._badAgainstTypeNames.indexOf(t._name)>=0},pt.prototype.getWeaponDescriptors=function(){return this._wDescriptors},pt.prototype.getMissileDescriptors=function(){return this._mDescriptors},pt.prototype.getPropulsionDescriptor=function(){return this._propulsionDescriptor},pt.prototype.getJumpEngineDescriptor=function(){return this._jumpEngineDescriptor},pt.prototype.getShieldDescriptor=function(){return this._shieldDescriptor},gt.prototype.isFPS=function(){return this._fps},gt.prototype.getFOV=function(){return this._fov},gt.prototype.getFOVRange=function(){return this._fovRange},gt.prototype.getSpan=function(){return this._span},gt.prototype.isMovable=function(){return this._movable},gt.prototype.isTurnable=function(){return this._turnable},gt.prototype.getAlphaRange=function(){return this._alphaRange},gt.prototype.getBetaRange=function(){return this._betaRange},gt.prototype.getConfines=function(){return this._confines},gt.prototype.resetsWhenLeavingConfines=function(){return this._resetsWhenLeavingConfines},gt.prototype.getBaseOrientation=function(){return this._baseOrientation},gt.prototype.getPointToFallback=function(){return this._pointToFallback},gt.prototype.shouldExcludeFromCycle=function(){return this._excludeFromCycle},gt.prototype.destroy=function(){this._fovRange=null,this.pM=null,this.oM=null,this._alphaRange=null,this._betaRange=null,this._confines=null},mt.prototype=new gt,mt.prototype.constructor=mt,mt.prototype.turnsAroundObjects=function(){return this._rotationCenterIsObject},mt.prototype.movesRelativeToObject=function(){return this._movesRelativeToObject},mt.prototype.getPositionFollowedObjectsForObject=function(t){return this._followsPosition||this._startsWithRelativePosition?[t]:[]},mt.prototype.startsWithRelativePosition=function(){return this._startsWithRelativePosition},mt.prototype.getDistanceRange=function(){return this._distanceRange},mt.prototype.pointsTowardsObjects=function(){return this._lookAtSelf||this._lookAtTarget},mt.prototype.getOrientationFollowedObjectsForObject=function(t){return this._lookAtSelf||this._followsOrientation?[t]:[]},mt.prototype.resetsOnFocusChange=function(){return this._resetsOnFocusChange},mt.prototype.createCameraConfiguration=function(t,e,i,n,o){var r,a,l=s.getYawAndPitch(this.oM);return r=new h.CameraPositionConfiguration(!this.isMovable(),this.turnsAroundObjects(),this.movesRelativeToObject(),this.getPositionFollowedObjectsForObject(t),this.startsWithRelativePosition(),s.matrix4(this.pM),this.getDistanceRange(),this.getConfines(),this.resetsWhenLeavingConfines()),a=new h.CameraOrientationConfiguration(!this.isTurnable(),this.pointsTowardsObjects(),this.isFPS(),this.getOrientationFollowedObjectsForObject(t),s.matrix4(this.oM),Math.degrees(l.yaw),Math.degrees(l.pitch),this.getAlphaRange(),this.getBetaRange(),this.getBaseOrientation()||e,this.getPointToFallback()||i),new h.CameraConfiguration(this._name,r,a,this.getFOV()||n,this.getFOVRange(),this.getSpan()||o,this.resetsOnFocusChange(),this.shouldExcludeFromCycle())},mt.prototype.destroy=function(){gt.prototype.destroy.call(this),this._distanceRange=null},ft.prototype=new gt,ft.prototype.constructor=ft,ft.prototype.turnsAroundObjects=function(){return this._turnAroundAll},ft.prototype.movesRelativeToObject=function(){return!1},ft.prototype.getPositionFollowedObjectsForScene=function(t){return this._turnAroundAll||this._startsWithRelativePosition?t.getAll3DObjects():[]},ft.prototype.startsWithRelativePosition=function(){return this._startsWithRelativePosition},ft.prototype.getDistanceRange=function(){return this._distanceRange},ft.prototype.pointsTowardsObjects=function(){return this._lookAtAll},ft.prototype.getOrientationFollowedObjectsForScene=function(t){return this._lookAtAll?t.getAll3DObjects():[]},ft.prototype.resetsOnFocusChange=function(){return!1},ft.prototype.destroy=function(){gt.prototype.destroy.call(this),this._distanceRange=null},Et.prototype.acquireResources=function(){this._particle.acquireResources()},Et.prototype.getParticleStates=function(){var t,e=0,i=[];if(this._blinks.length>0)for(this._blinks[0]>0&&(i.push(new u.ParticleState(this._particle._color,0,0)),i.push(new u.ParticleState(this._particle._color,0,this._blinks[0]))),t=0;t<this._blinks.length;t++)i.push(new u.ParticleState(this._particle._color,this._particle.getSize(),0)),i.push(new u.ParticleState(this._particle._color,0,this._particle._duration)),e=this._blinks[t]+this._particle._duration,i.push(new u.ParticleState(this._particle._color,0,t<this._blinks.length-1?this._blinks[t+1]-e:this._period-e));else i.push(new u.ParticleState(this._particle._color,this._particle.getSize(),0));return i},Et.prototype.getLightStates=function(){var t,e=0,i=[];if(this._blinks.length>0)for(this._blinks[0]>0&&(i.push({color:this._lightColor,intensity:0,timeToReach:0}),i.push({color:this._lightColor,intensity:0,timeToReach:this._blinks[0]})),t=0;t<this._blinks.length;t++)i.push({color:this._lightColor,intensity:this._intensity,timeToReach:0}),i.push({color:this._lightColor,intensity:0,timeToReach:this._particle._duration}),e=this._blinks[t]+this._particle._duration,i.push({color:this._lightColor,intensity:0,timeToReach:t<this._blinks.length-1?this._blinks[t+1]-e:this._period-e});else i.push({color:this._lightColor,intensity:this._intensity,timeToReach:0});return i},Et.prototype.handleGraphicsSettingsChanged=function(){this._particle.handleGraphicsSettingsChanged()},yt.prototype=new W,yt.prototype.constructor=yt,yt.prototype._overrideData=function(o,r){var l,h,u,c,_,d,p;switch(W.prototype._overrideData.call(this,o,r),this._scType=o?r.type?A(r.type):o._scType:A(r.type||v(this,"type")),this._fullName=o?r.fullName||o._fullName:r.fullName||this._name,this._showInDatabase=o?"boolean"==typeof r.showInDatabase?r.showInDatabase:o._showInDatabase:"boolean"!=typeof r.showInDatabase||r.showInDatabase,this._description=o?r.description||o._description:r.description||(this._showInDatabase?v(this,"description"):""),this._hitpoints=o?r.hitpoints||o._hitpoints:r.hitpoints||x(this,"hitpoints"),this._armor="number"==typeof r.armor?r.armor:o?o._armor:0,this._factionColor=o?r.factionColor||o._factionColor:r.factionColor||null,this._turnStyle=r.turnStyle?t.getSafeEnumValue(vt,r.turnStyle,vt.YAW_PITCH):o?o._turnStyle:vt.YAW_PITCH,this._attackVector=r.attackVector?i.normal3(r.attackVector):o?o._attackVector:[0,1,0],this._attackVectorAngles=[0,0],this._turnStyle){case vt.YAW_PITCH:p=i.getYawAndPitch(this._attackVector),this._attackVectorAngles[0]=p.yaw,this._attackVectorAngles[1]=p.pitch;break;case vt.ROLL_YAW:p=i.getRollAndYaw(this._attackVector),this._attackVectorAngles[0]=p.roll,this._attackVectorAngles[1]=p.yaw;break;case vt.ROLL_PITCH:p=i.getRollAndPitch(this._attackVector),this._attackVectorAngles[0]=p.roll,this._attackVectorAngles[1]=p.pitch}if(this._attackThresholdAngle=Math.radians(r.attackThresholdAngle)||(o?o._attackThresholdAngle:0),this._mass=o?r.mass||o._mass:r.mass||x(this,"mass"),this._dragFactor=o?void 0!==r.dragFactor?r.dragFactor:o._dragFactor:void 0!==r.dragFactor?r.dragFactor:1,this._bodies=o&&!r.bodies?o._bodies:[],r.bodies)for(l=0;l<r.bodies.length;l++)this._bodies.push(new a.Body(s.translation4v(r.bodies[l].position||D(this,"bodies[i].position")),s.rotation4FromJSON(r.bodies[l].rotations),r.bodies[l].size));else o||L(this,"bodies");if(this._wSlots=o&&!r.weaponSlots?o._wSlots:[],r.weaponSlots)for(l=0;l<r.weaponSlots.length;l++)if(r.weaponSlots[l].count>1)for(u=r.weaponSlots[l].position||D(this,"weaponSlot array position"),c=r.weaponSlots[l].vector||D(this,"weaponSlot array vector"),_=r.weaponSlots[l].rotations,d=r.weaponSlots[l].count,h=0;h<d;h++)this._wSlots.push(new rt({position:i.sum3(u,i.scaled3(c,h)),rotations:_}));else this._wSlots.push(new rt(r.weaponSlots[l]));if(this._mLs=o&&!r.missileLaunchers?o._mLs:[],r.missileLaunchers)for(l=0;l<r.missileLaunchers.length;l++)this._mLs.push(new at(r.missileLaunchers[l]));if(this._thrusterSlots=o&&!r.thrusterSlots?o._thrusterSlots:[],r.thrusterSlots&&B(r,this,this._thrusterSlots),this._views=o&&!r.views?o._views:[],r.views)for(l=0;l<r.views.length;l++)this._views.push(new mt(r.views[l]));else o||L(this,"views");if(this._loadouts=o&&!r.loadouts?o._loadouts:{},r.loadouts)for(l=0;l<r.loadouts.length;l++)this._loadouts[r.loadouts[l].name]=new pt(r.loadouts[l]);if(this._defaultLoadout=o?r.defaultLoadout||o._defaultLoadout:r.defaultLoadout||null,this._defaultLoadout&&!this._loadouts[this._defaultLoadout]&&(n.showError("Non-existing default loadout '"+this._defaultLoadout+"' specified for spacecraft class "+this._name+"!",n.ErrorSeverity.MINOR),this._defaultLoadout=null),this._humSound=r.humSound?e.getVerifiedObject("spacecraftClasses['"+this._name+"'].humSound",r.humSound,Xt):o?o._humSound:null,this._explosionClass=o?r.explosion?m(r.explosion):o._explosionClass:m(r.explosion||v(this,"explosion")),this._showTimeRatioDuringExplosion=void 0!==r.showTimeRatioDuringExplosion?r.showTimeRatioDuringExplosion:o?o._showTimeRatioDuringExplosion:x(this,"showTimeRatioDuringExplosion"),this._damageIndicators=o&&!r.damageIndicators?o._damageIndicators:[],r.damageIndicators)for(l=0;l<r.damageIndicators.length;l++)this._damageIndicators.push(new St(r.damageIndicators[l]));if(this._lightSources=o&&!r.lights?o._lightSources:[],r.lights)for(l=0;l<r.lights.length;l++)this._lightSources.push(new Tt(r.lights[l]));if(this._blinkerDescriptors=o&&!r.blinkers?o._blinkerDescriptors:[],r.blinkers)for(l=0;l<r.blinkers.length;l++)this._blinkerDescriptors.push(new Et(r.blinkers[l]));this._lockingTimeFactor=void 0!==r.lockingTimeFactor?r.lockingTimeFactor:o?o._lockingTimeFactor:1,this._scoreValue=o?r.scoreValue||o._scoreValue:r.scoreValue||0},yt.prototype._loadData=function(t){var e;return t.basedOn?(e=M(t.basedOn),e.executeWhenReady(function(){this._overrideData(e,t)}.bind(this))):this._overrideData(null,t),!0},yt.prototype.isFighterClass=function(){return this._scType._isFighterType},yt.prototype.getDisplayName=function(){return _.get(_.SPACECRAFT_CLASS.PREFIX,this._name+_.SPACECRAFT_CLASS.NAME_SUFFIX.name,this._fullName)},yt.prototype.getDisplayDescription=function(){return _.get(_.SPACECRAFT_CLASS.PREFIX,this._name+_.SPACECRAFT_CLASS.DESCRIPTION_SUFFIX.name,t.formatString(_.get(_.DATABASE.MISSING_SPACECRAFT_CLASS_DESCRIPTION),{spacecraftClass:this.getDisplayName(),originalDescription:this._description}))},yt.prototype.shouldShowInDatabase=function(){return this._showInDatabase},yt.prototype.getMissileLaunchersBySize=function(){var t,e={};for(t=0;t<this._mLs.length;t++)e[this._mLs[t].size]?e[this._mLs[t].size].push(this._mLs[t]):e[this._mLs[t].size]=[this._mLs[t]];return e},yt.prototype.getLoadout=function(t){return this._loadouts[t]},yt.prototype.getLoadoutNames=function(){return Object.keys(this._loadouts)},yt.prototype.getView=function(t){var e;for(e=0;e<this._views.length;e++)if(this._views[e]._name===t)return this._views[e];return null},yt.prototype.getLockingTimeFactor=function(){return this._lockingTimeFactor},yt.prototype.acquireResources=function(t){var e;if(W.prototype.acquireResources.call(this,t),t.explosion&&this._explosionClass.acquireResources({sound:t.sound}),t.damageIndicators)for(e=0;e<this._damageIndicators.length;e++)this._damageIndicators[e].explosionClass.acquireResources({sound:t.sound});if(t.blinkers)for(e=0;e<this._blinkerDescriptors.length;e++)this._blinkerDescriptors[e].acquireResources();t.sound&&this._humSound&&P(this._humSound)},yt.prototype.handleGraphicsSettingsChanged=function(){var t;if(W.prototype.handleGraphicsSettingsChanged.call(this),this._blinkerDescriptors)for(t=0;t<this._blinkerDescriptors.length;t++)this._blinkerDescriptors[t].handleGraphicsSettingsChanged()},yt.prototype.hasHumSound=function(){return!!this._humSound},yt.prototype.createHumSoundClip=function(t){return this._humSound?U(this._humSound,!0,t):null},yt.prototype.getScoreValue=function(){return this._scoreValue},At=new o.ResourceManager,c.onSettingsChange(function(){At.executeForAllResources(function(t){t.handleGraphicsSettingsChanged()})}),{SHADER_VARIANT_INSTANCED_NAME:"instanced",SOUND_EFFECT:Wt,ParticleEmitterType:Ct,ObjectViewLookAtMode:Nt,SceneViewLookAtMode:Ot,MissileSize:Rt,MissileHomingMode:Lt,WeaponRotationStyle:xt,SpacecraftTurnStyle:vt,TexturedModelClass:W,getSkyboxClass:d,getBackgroundObjectClass:p,getDustCloudClass:g,getExplosionClass:m,getMissileClass:S,getWeaponClass:T,getPropulsionClass:E,getJumpEngineClass:y,getShieldClass:I,getSpacecraftType:A,getSpacecraftClass:M,getSpacecraftClassesInArray:C,getClassCategories:N,getClassNames:O,getClass:R,createClass:At.createResource.bind(At),Loadout:pt,ObjectView:mt,SceneView:ft,requestLoad:It,executeWhenReady:At.executeWhenReady.bind(At),executeForAllClasses:At.executeForAllResources.bind(At),renameClass:At.renameResource.bind(At),moveClassAfter:At.moveResourceAfter.bind(At)}}),define("armada/configuration",["utils/utils","utils/types","modules/async-resource","modules/scene/camera","armada/logic/classes","armada/constants"],function(t,e,i,s,n,o){"use strict";function r(){i.AsyncResource.call(this),this._configuration=null,this._settings=null,this._hudSettings={}}var a,l,h,u,c,_,d,p,g=o.LOCAL_STORAGE_PREFIX+"settings_",m={};return m.FILE_DESCRIPTOR={baseType:"object",properties:{FILENAME:{name:"filename",type:"string"},FOLDER:{name:"folder",type:"string"}}},m.LIGHT_SOURCE={baseType:"object",properties:{COLOR:{name:"color",type:e.COLOR3},DIRECTION:{name:"direction",type:e.VECTOR3}
}},m.LAYOUT_DESCRIPTOR={baseType:"object",properties:{LEFT:{name:"left",type:"number",optional:!0},CENTER_X:{name:"centerX",type:"number",optional:!0},RIGHT:{name:"right",type:"number",optional:!0},TOP:{name:"top",type:"number",optional:!0},CENTER_Y:{name:"centerY",type:"number",optional:!0},BOTTOM:{name:"bottom",type:"number",optional:!0},WIDTH:{name:"width",type:"number",optional:!0},HEIGHT:{name:"height",type:"number",optional:!0},SCALE_MODE:{name:"scaleMode",type:"enum",values:t.ScaleMode},X_SCALE_MODE:{name:"xScaleMode",type:"enum",values:t.ScaleMode,optional:!0},Y_SCALE_MODE:{name:"yScaleMode",type:"enum",values:t.ScaleMode,optional:!0}}},m.TEXTURE_MAPPING={baseType:"array",elementType:e.VECTOR2,length:2},m.UI_IMAGE_DESCRIPTOR={baseType:"object",properties:{TEXTURE:{name:"texture",type:"string"},MAPPING:{name:"mapping",type:m.TEXTURE_MAPPING,optional:!0},SIZE:{name:"size",type:e.VECTOR2},SCALE_MODE:{name:"scaleMode",type:"enum",values:t.ScaleMode},COLOR:{name:"color",type:e.COLOR4}}},m.UI_LAID_OUT_IMAGE_DESCRIPTOR={baseType:"object",properties:{TEXTURE:{name:"texture",type:"string"},MAPPING:{name:"mapping",type:m.TEXTURE_MAPPING},LAYOUT:{name:"layout",type:m.LAYOUT_DESCRIPTOR},COLOR:{name:"color",type:e.COLOR4}}},m.TEXT_DESCRIPTOR={baseType:"object",properties:{COLOR:{name:"color",type:e.COLOR4},FONT_SIZE:{name:"fontSize",type:"number"},FONT_NAME:{name:"fontName",type:"string"},POSITION:{name:"position",type:e.VECTOR2},LAYOUT:{name:"layout",type:m.LAYOUT_DESCRIPTOR,optional:!0}}},m.CRAFT_INDICATOR_POSITIONS={baseType:"array",elementType:{baseType:"array",elementType:e.VECTOR2}},m.STRING_ARRAY={baseType:"array",elementType:"string"},m.getCustomDescriptor=function(e,i,s){var n,o,r,a,l=t.deepCopy(e);for(r=Object.keys(i),n=0;n<r.length;n++){for(a=l.properties[r[n]],l.properties[r[n]+"S"]={name:a.name+"s",type:{baseType:"object",properties:{}}},o=0;o<i[r[n]].length;o++)l.properties[r[n]+"S"].type.properties[i[r[n]][o].toUpperCase()]={name:i[r[n]][o],type:a.type};delete l.properties[r[n]]}if(s)for(n=0;n<s.length;n++)delete l.properties[s[n]];return l},a={CLASSES_SOURCE_FILE:{name:"classes",type:m.FILE_DESCRIPTOR},ENVIRONMENTS_SOURCE_FILE:{name:"environments",type:m.FILE_DESCRIPTOR},MISSION_FILES:{name:"missions",type:{baseType:"object",properties:{FILENAME:{name:"filename",type:"string"},FOLDER:{name:"folder",type:"string"}}}}},l={USE_REQUEST_ANIM_FRAME:{name:"useRequestAnimFrame",type:"boolean",defaultValue:!0},DEFAULT_RANDOM_SEED:{name:"defaultRandomSeed",type:"number",defaultValue:4718},UNIFORM_LUMINOSITY_FACTORS_ARRAY_NAME:{name:"luminosityFactorsArrayName",type:"string",defaultValue:"luminosityFactors"},UNIFORM_GROUP_TRANSFORMS_ARRAY_NAME:{name:"groupTransformsArrayName",type:"string",defaultValue:"groupTransforms"},USE_VERTICAL_CAMERA_VALUES:{name:"useVerticalCameraValues",type:"boolean",defaultValue:!0},MENU_MUSIC:{name:"menuMusic",type:"string"},MUSIC_FADE_IN_DURATION:{name:"musicFadeInDuration",type:"number"},THEME_CROSSFADE_DURATION:{name:"themeCrossfadeDuration",type:"number"},MUSIC_FADE_OUT_DURATION:{name:"musicFadeOutDuration",type:"number"},BUTTON_SELECT_SOUND:{name:"buttonSelectSound",type:n.SOUND_EFFECT},BUTTON_CLICK_SOUND:{name:"buttonClickSound",type:n.SOUND_EFFECT}},h={SHOW_LOADING_BOX_FIRST_TIME:{name:"showLoadingBoxFirstTime",type:"boolean",defaultValue:!0},SHOW_LOADING_BOX_ON_ITEM_CHANGE:{name:"showLoadingBoxOnItemChange",type:"boolean",defaultValue:!0},BACKGROUND_COLOR:{name:"backgroundColor",type:e.COLOR4,defaultValue:[0,0,0,0]},ITEM_VIEW_DISTANCE:{name:"itemViewDistance",type:"number",defaultValue:2e3},ITEM_VIEW_FOV:{name:"itemViewFOV",type:"number",defaultValue:60},ITEM_VIEW_SPAN:{name:"itemViewSpan",type:"number",defaultValue:.2},SHOW_WIREFRAME_MODEL:{name:"showWireframeModel",type:"boolean",defaultValue:!0},WIREFRAME_SHADER_NAME:{name:"wireframeShaderName",type:"string",defaultValue:"oneColorReveal"},WIREFRAME_COLOR:{name:"wireframeColor",type:e.COLOR4,defaultValue:[1,0,0,1]},SHOW_SOLID_MODEL:{name:"showSolidModel",type:"boolean",defaultValue:!0},SOLID_SHADER_NAME:{name:"solidShaderName",type:"string",defaultValue:"shadowMapReveal"},LIGHT_SOURCES:{name:"lightSources",type:"array",elementType:m.LIGHT_SOURCE,minLength:1,maxLength:2},START_SIZE_FACTOR:{name:"startSizeFactor",type:"number",defaultValue:"1"},MIN_SIZE_FACTOR:{name:"minimumSizeFactor",type:"number",defaultValue:"0.9"},MAX_SIZE_FACTOR:{name:"maximumSizeFactor",type:"number",defaultValue:"1.6"},MODEL_AUTO_ROTATION:{name:"modelAutoRotation",type:"boolean",defaultValue:!0},MODEL_MOUSE_ROTATION:{name:"modelMouseRotation",type:"boolean",defaultValue:!0},ROTATION_FPS:{name:"rotationFPS",type:"number",defaultValue:60},ROTATION_REVEAL_START_ANGLE:{name:"rotationRevealStartAngle",type:e.ANGLE_DEGREES,defaultValue:90},ROTATION_START_ANGLE:{name:"rotationStartAngle",type:e.ANGLE_DEGREES,defaultValue:180},ROTATION_VIEW_ANGLE:{name:"rotationViewAngle",type:e.ANGLE_DEGREES,defaultValue:60},ROTATION_DURATION:{name:"rotationDuration",type:"number",defaultValue:4e3},ROTATION_MOUSE_SENSITIVITY:{name:"rotationMouseSensitivity",type:"number",defaultValue:1},MODEL_REVEAL_ANIMATION:{name:"modelRevealAnimation",type:"boolean",defaultValue:!0},REVEAL_COLOR:{name:"revealColor",type:e.COLOR4,defaultValue:[1,1,1,1]},REVEAL_FPS:{name:"revealFPS",type:"number",defaultValue:60},REVEAL_DURATION:{name:"revealDuration",type:e.DURATION,defaultValue:2e3},REVEAL_SOLID_DELAY_DURATION:{name:"revealSolidDelayDuration",type:e.DURATION,defaultValue:2e3},REVEAL_TRANSITION_LENGTH_FACTOR:{name:"revealTransitionLengthFactor",type:"number",defaultValue:.15},RENDER_FPS:{name:"databaseRenderFPS",type:"number",defaultValue:60}},u={RENDER_FPS:{name:"battleRenderFPS",type:"number",defaultValue:60},SIMULATION_STEPS_PER_SECOND:{name:"simulationStepsPerSecond",type:"number",defaultValue:60},PARTICLE_POOL_PREFILL_FACTOR:{name:"particlePoolPrefillFactor",type:"number"},PROJECTILE_POOL_PREFILL_FACTOR:{name:"projectilePoolPrefillFactor",type:"number"},MISSILE_POOL_PREFILL_FACTOR:{name:"missilePoolPrefillFactor",type:"number"},TRAIL_SEGMENT_POOL_PREFILL_FACTOR:{name:"trailSegmentPoolPrefillFactor",type:"number"},EXPLOSION_POOL_PREFILL_FACTOR:{name:"explosionPoolPrefillFactor",type:"number"},MINIMUM_DUST_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumDustParticleCountForInstancing",type:"number",defaultValue:1},MINIMUM_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumParticleCountForInstancing",type:"number",defaultValue:1},MINIMUM_PROJECTILE_COUNT_FOR_INSTANCING:{name:"minimumProjectileCountForInstancing",type:"number",defaultValue:1},MINIMUM_TRAIL_SEGMENT_COUNT_FOR_INSTANCING:{name:"minimumTrailSegmentCountForInstancing",type:"number",defaultValue:1},MINIMUM_THRUSTER_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumThrusterParticleCountForInstancing",type:"number",defaultValue:1},MINIMUM_BLINKER_PARTICLE_COUNT_FOR_INSTANCING:{name:"minimumBlinkerParticleCountForInstancing",type:"number",defaultValue:1},VIEW_DISTANCE:{name:"viewDistance",type:"number",defaultValue:5e3},MOVE_TO_ORIGO_DISTANCE:{name:"moveToOrigoDistance",type:"number"},CAMERA_DEFAULT_TRANSITION_DURATION:{name:"cameraDefaultTransitionDuration",type:"number",defaultValue:1e3},CAMERA_DEFAULT_TRANSITION_STYLE:{name:"cameraDefaultTransitionStyle",type:"enum",values:s.Camera.TransitionStyle,defaultValue:s.Camera.TransitionStyle.SMOOTH},CAMERA_PILOTING_SWITCH_TRANSITION_DURATION:{name:"cameraPilotingSwitchTransitionDuration",type:"number",defaultValue:1e3},CAMERA_PILOTING_SWITCH_TRANSITION_STYLE:{name:"cameraPilotingSwitchTransitionStyle",type:"enum",values:s.Camera.TransitionStyle,defaultValue:s.Camera.TransitionStyle.SMOOTH},MOMENT_DURATION:{name:"momentDuration",type:e.DURATION,defaultValue:1},BACKGROUND_OBJECT_DISTANCE:{name:"backgroundObjectDistance",type:"number",defaultValue:4500},TURN_ACCELERATION_DURATION_S:{name:"turnAccelerationDurationInSeconds",type:e.DURATION},MAX_COMBAT_FORWARD_SPEED_FACTOR:{name:"maxCombatForwardSpeedFactor",type:"number"},MAX_COMBAT_REVERSE_SPEED_FACTOR:{name:"maxCombatReverseSpeedFactor",type:"number"},MAX_CRUISE_FORWARD_SPEED_FACTOR:{name:"maxCruiseForwardSpeedFactor",type:"number"},MAX_CRUISE_REVERSE_SPEED_FACTOR:{name:"maxCruiseReverseSpeedFactor",type:"number"},STRAFE_SPEED_FACTOR:{name:"strafeSpeedFactor",type:"number"},DEFAULT_MUZZLE_FLASH_DURATION:{name:"defaultMuzzleFlashDuration",type:e.DURATION,defaultValue:500},SELF_FIRE:{name:"selfFire",type:"boolean",defaultValue:!0},HITBOX_COLOR:{name:"hitboxColor",type:e.COLOR4,defaultValue:[0,.5,.5,.5]},HITBOX_TEXTURE_NAME:{name:"hitboxTexture",type:"string",defaultValue:"white"},HITBOX_SHADER_NAME:{name:"hitboxShader",type:"string",defaultValue:"oneColor"},SHOW_HITBOXES_FOR_HITCHECKS:{name:"showHitboxesForHitchecks",type:"boolean"},DEFAULT_FIGHTER_VIEW_NAME:{name:"defaultFighterViewName",type:"string"},DEFAULT_FIGHTER_VIEW_NAME_OPTIONS:{name:"defaultFighterViewNameOptions",type:m.STRING_ARRAY},DEFAULT_SHIP_VIEW_NAME:{name:"defaultShipViewName",type:"string"},DEFAULT_SHIP_VIEW_NAME_OPTIONS:{name:"defaultShipViewNameOptions",type:m.STRING_ARRAY},TARGET_VIEW_NAME:{name:"targetViewName",type:"string",defaultValue:"target"},TARGET_CHANGE_TRANSITION_DURATION:{name:"targetChangeTransitonDuration",type:e.DURATION,defaultValue:300},TARGET_CHANGE_TRANSITION_STYLE:{name:"targetChangeTransitionStyle",type:"enum",values:s.Camera.TransitionStyle},TARGET_ORDER_DURATION:{name:"targetOrderDuration",type:"number"},JUMP_PREPARE_VIEW_NAME:{name:"jumpPrepareViewName",type:"string"},JUMP_OUT_VIEW_NAME:{name:"jumpOutViewName",type:"string"},GAME_STATE_DISPLAY_DELAY:{name:"gameStateDisplayDelay",type:"number"},QUIT_DELAY_AFTER_JUMP_OUT:{name:"quitDelayAfterJumpOut",type:"number"},HUD:{name:"hud",ALWAYS_SHOW_TARGET_HULL_BAR_AT_CENTER:{name:"alwaysShowTargetHullBarAtCenter",type:"boolean"},AIM_ASSIST_CROSSHAIRS:{name:"aimAssistCrosshairs",type:"boolean"},RELATIVE_TARGET_ORIENTATION:{name:"relativeTargetOrientation",type:"boolean"},HIGHLIGHT_INTERVAL:{name:"highlightInterval",type:"number"},TARGET_SWITCH_ANIMATION_DURATION:{name:"targetSwitchAnimationDuration",type:"number"},AIM_ASSIST_APPEAR_ANIMATION_DURATION:{name:"aimAssistAppearAnimationDuration",type:"number"},HULL_INTEGRITY_DECREASE_ANIMATION_DURATION:{name:"hullIntegrityDecreaseAnimationDuration",type:"number"},SHIELD_DECREASE_ANIMATION_DURATION:{name:"shieldDecreaseAnimationDuration",type:"number"},TARGET_HULL_INTEGRITY_DECREASE_ANIMATION_DURATION:{name:"targetHullIntegrityDecreaseAnimationDuration",type:"number"},TARGET_SHIELD_DECREASE_ANIMATION_DURATION:{name:"targetShieldDecreaseAnimationDuration",type:"number"},SHIP_INDICATOR_HIGHLIGHT_ANIMATION_INTERVAL:{name:"shipIndicatorHighlightAnimationInterval",type:"number"},CENTER_CROSSHAIR:{name:"centerCrosshair",type:m.UI_IMAGE_DESCRIPTOR},CURSOR:{name:"cursor",type:m.getCustomDescriptor(m.UI_IMAGE_DESCRIPTOR,{MAPPING:["still","turn"]})},SHIP_ARROW:{name:"shipArrow",type:m.getCustomDescriptor(m.UI_IMAGE_DESCRIPTOR,{COLOR:["hostile","friendly","hostileHighlight","friendlyHighlight","newHostile","hostileTarget","friendlyTarget","transmission"],SIZE:["default","target"]})},SHIP_ARROW_POSITION_RADIUS:{name:"shipArrowPositionRadius",type:"number"},TARGET_ARROW_SWITCH_SCALE:{name:"targetArrowSwitchScale",type:"number"},SHIP_INDICATOR:{name:"shipIndicator",type:m.getCustomDescriptor(m.UI_IMAGE_DESCRIPTOR,{COLOR:["hostile","friendly","hostileHighlight","friendlyHighlight","newHostile","hostileTarget","friendlyTarget","transmission"],SIZE:["minimum","targetMinimum","maximum"]})},SHIP_INDICATOR_SIZE_FACTOR:{name:"shipIndicatorSizeFactor",type:"number"},TARGET_INDICATOR_SWITCH_SCALE:{name:"targetIndicatorSwitchScale",type:"number"},MISSILE_LOCK_INDICATOR:{name:"missileLockIndicator",type:m.getCustomDescriptor(m.UI_IMAGE_DESCRIPTOR,{COLOR:["hostileTarget","friendlyTarget"]},["SIZE"])},MISSILE_LOCK_INDICATOR_COUNT:{name:"missileLockIndicatorCount",type:"number"},MISSILE_LOCK_INDICATOR_RADIUS:{name:"missileLockIndicatorRadius",type:"number"},MISSILE_LOCK_INDICATOR_SIZE:{name:"missileLockIndicatorSize",type:"number"},MISSILE_LOCK_INDICATOR_ANGLE:{name:"missileLockIndicatorAngle",type:"number"},MISSILE_LOCK_INDICATOR_ROTATION_SPEED:{name:"missileLockIndicatorRotationSpeed",type:"number"},MISSILE_LOCK_INDICATOR_BLINK_INTERVAL:{name:"missileLockIndicatorBlinkInterval",type:"number"},DISTANCE_TEXT_LAYER_LAYOUT:{name:"distanceTextLayerLayout",type:m.LAYOUT_DESCRIPTOR},DISTANCE_TEXT:{name:"distanceText",type:m.getCustomDescriptor(m.TEXT_DESCRIPTOR,{COLOR:["hostile","friendly"]})},SHIP_STATUS_INDICATOR:{name:"shipStatusIndicator",type:m.getCustomDescriptor(m.UI_IMAGE_DESCRIPTOR,{MAPPING:["protect","destroy","transmission"],COLOR:["protect","destroy","transmission"],SIZE:["reticle","arrow"]})},AIM_ASSIST_INDICATOR:{name:"aimAssistIndicator",type:m.getCustomDescriptor(m.UI_IMAGE_DESCRIPTOR,{COLOR:["hostile","friendly","appear"]})},AIM_ASSIST_INDICATOR_APPEAR_SCALE:{name:"aimAssistIndicatorAppearScale",type:"number"},WEAPON_IMPACT_INDICATOR:{name:"weaponImpactIndicator",type:m.getCustomDescriptor(m.UI_IMAGE_DESCRIPTOR,{COLOR:["normal","outOfRange"]})},WEAPON_IMPACT_INDICATOR_SWITCH_SCALE:{name:"weaponImpactIndicatorSwitchScale",type:"number"},TARGET_VIEW_LAYOUT:{name:"targetViewLayout",type:m.LAYOUT_DESCRIPTOR},TARGET_VIEW_CAMERA_DISTANCE:{name:"targetViewCameraDistance",type:"number"},TARGET_VIEW_VIEW_DISTANCE:{name:"targetViewViewDistance",type:"number"},TARGET_VIEW_FOV:{name:"targetViewFOV",type:"number"},TARGET_VIEW_TARGET_ITEM_SHADER:{name:"targetViewTargetItemShader",type:"string"},TARGET_VIEW_TARGET_ITEM_FULL_INTEGRITY_COLOR:{name:"targetViewTargetItemFullIntegrityColor",type:e.COLOR4},TARGET_VIEW_TARGET_ITEM_HALF_INTEGRITY_COLOR:{name:"targetViewTargetItemHalfIntegrityColor",type:e.COLOR4},TARGET_VIEW_TARGET_ITEM_ZERO_INTEGRITY_COLOR:{name:"targetViewTargetItemZeroIntegrityColor",type:e.COLOR4},TARGET_INFO_BACKGROUND:{name:"targetInfoBackground",type:m.UI_LAID_OUT_IMAGE_DESCRIPTOR},TARGET_HULL_INTEGRITY_BAR:{name:"targetHullIntegrityBar",type:m.getCustomDescriptor(m.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["filled","empty"]})},TARGET_SHIELD_BAR:{name:"targetShieldBar",type:m.getCustomDescriptor(m.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["filled","empty"]})},TARGET_INFO_TEXT_LAYER_LAYOUT:{name:"targetInfoTextLayerLayout",type:m.LAYOUT_DESCRIPTOR},TARGET_INFO_TEXT:{name:"targetInfoText",type:m.getCustomDescriptor(m.TEXT_DESCRIPTOR,{COLOR:["hostile","friendly"],FONT_SIZE:["name","others"],POSITION:["name","class","team","firepower","distance","velocity"]})},WINGMEN_STATUS_BACKGROUND:{name:"wingmenStatusBackground",type:m.UI_LAID_OUT_IMAGE_DESCRIPTOR},WINGMEN_STATUS_HEADER_TEXT:{name:"wingmenStatusHeaderText",type:m.TEXT_DESCRIPTOR},WINGMEN_STATUS_CRAFT_INDICATOR:{name:"wingmenStatusCraftIndicator",type:m.getCustomDescriptor(m.UI_IMAGE_DESCRIPTOR,{MAPPING:["player","shield","general","interceptor","bomber","heavyFighter"],COLOR:["fullIntegrity","halfIntegrity","zeroIntegrity","destroyed","away","fullShieldIntegrity","halfShieldIntegrity","zeroShieldIntegrity"]})},WINGMEN_STATUS_CRAFT_POSITIONS:{name:"wigmenStatusCraftPositions",type:m.CRAFT_INDICATOR_POSITIONS},WINGMEN_STATUS_SQUAD_LAYOUT:{name:"wigmenStatusSquadLayout",type:m.LAYOUT_DESCRIPTOR},WINGMEN_STATUS_SQUAD_TEXT:{name:"wingmenStatusSquadText",type:m.TEXT_DESCRIPTOR},SPEED_BAR:{name:"speedBar",type:m.getCustomDescriptor(m.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["combatFilled","combatEmpty","combatReverseFilled","combatReverseEmpty","cruiseFilled","cruiseEmpty","cruiseReverseFilled","cruiseReverseEmpty","freeFilled","freeEmpty","freeReverseFilled","freeReverseEmpty"]})},SPEED_BAR_BASE_MAX_SPEED_FACTOR:{name:"speedBarBaseMaxSpeedFactor",type:"number"},SPEED_BAR_DEFAULT_BASE_MAX_SPEED:{name:"speedBarDefaultBaseMaxSpeed",type:"number"},SPEED_BAR_MAX_SPEED_STEP_FACTOR:{name:"speedBarMaxSpeedStepFactor",type:"number"},SPEED_BAR_MAX_SPEED_STEP_BUFFER:{name:"speedBarMaxSpeedStepBuffer",type:"number"},SPEED_TEXT_LAYER_LAYOUT:{name:"speedTextLayerLayout",type:m.LAYOUT_DESCRIPTOR},SPEED_TEXT:{name:"speedText",type:m.getCustomDescriptor(m.TEXT_DESCRIPTOR,{COLOR:["combatForward","combatReverse","cruiseForward","cruiseReverse","freeForward","freeReverse"],POSITION:["maxForward","maxReverse"]})},SPEED_TARGET_INDICATOR:{name:"speedTargetIndicator",type:m.UI_IMAGE_DESCRIPTOR},MISSILE_INDICATOR:{name:"missileIndicator",type:m.getCustomDescriptor(m.UI_LAID_OUT_IMAGE_DESCRIPTOR,{MAPPING:["single","salvo"],COLOR:["ready","locking","loading"]})},MISSILE_INDICATOR_TEXT_LAYOUT:{name:"missileIndicatorTextLayout",type:m.LAYOUT_DESCRIPTOR},MISSILE_INDICATOR_TEXT:{name:"missileIndicatorText",type:m.getCustomDescriptor(m.TEXT_DESCRIPTOR,{COLOR:["ready","locking","loading"]})},HULL_INTEGRITY_BAR:{name:"hullIntegrityBar",type:m.getCustomDescriptor(m.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["filled","empty","filledWhenDecreasing","emptyWhenDecreasing"]})},SHIELD_BAR:{name:"shieldBar",type:m.getCustomDescriptor(m.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["filled","empty","filledWhenDecreasing","emptyWhenDecreasing"]})},FLIGHT_MODE_INDICATOR_BACKGROUND:{name:"flightModeIndicatorBackground",type:m.UI_LAID_OUT_IMAGE_DESCRIPTOR},FLIGHT_MODE_HEADER_TEXT:{name:"flightModeHeaderText",type:m.TEXT_DESCRIPTOR},FLIGHT_MODE_TEXT:{name:"flightModeText",type:m.getCustomDescriptor(m.TEXT_DESCRIPTOR,{COLOR:["free","combat","cruise"]})},MISSILE_INFO_BACKGROUND:{name:"missileInfoBackground",type:m.UI_LAID_OUT_IMAGE_DESCRIPTOR},MISSILE_INFO_HEADER_TEXT:{name:"missileInfoHeaderText",type:m.TEXT_DESCRIPTOR},MISSILE_INFO_TEXT:{name:"missileInfoText",type:m.getCustomDescriptor(m.TEXT_DESCRIPTOR,{COLOR:["readySelected","lockingSelected","loadingSelected","notSelected","empty"],POSITION:["name","count"]})},MISSILE_INFO_TEXT_OFFSET:{name:"missileInfoTextOffset",type:"number"},MAX_MISSILE_INFO_DISPLAYED:{name:"maxMissileInfoDisplayed",type:"number"},DRIFT_ARROW:{name:"driftArrow",type:m.getCustomDescriptor(m.UI_IMAGE_DESCRIPTOR,{COLOR:["minSpeed","maxSpeed"]})},DRIFT_ARROW_POSITION_RADIUS:{name:"driftArrowPositionRadius",type:"number"},DRIFT_ARROW_MIN_SPEED:{name:"driftArrowMinSpeed",type:"number"},DRIFT_ARROW_MAX_SPEED_FACTOR:{name:"driftArrowMaxSpeedFactor",type:"number"},TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR:{name:"targetHullIntegrityQuickViewBar",type:m.getCustomDescriptor(m.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["hostileFilled","hostileEmpty","friendlyFilled","friendlyEmpty","filledWhenDecreasing"]})},TARGET_SHIELD_QUICK_VIEW_BAR:{name:"targetShieldQuickViewBar",type:m.getCustomDescriptor(m.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["filled","empty","filledWhenDecreasing"]})},HEADER_TEXT_LAYER_LAYOUT:{name:"headerTextLayerLayout",type:m.LAYOUT_DESCRIPTOR},SMALL_HEADER_TEXT:{name:"smallHeaderText",type:m.TEXT_DESCRIPTOR},BIG_HEADER_TEXT:{name:"bigHeaderText",type:m.TEXT_DESCRIPTOR},SUBHEADER_TEXT:{name:"subheaderText",type:m.TEXT_DESCRIPTOR},MESSAGE_BACKGROUND:{name:"messageBackground",type:m.UI_LAID_OUT_IMAGE_DESCRIPTOR},MESSAGE_TEXT:{name:"messageText",type:m.getCustomDescriptor(m.TEXT_DESCRIPTOR,{COLOR:["default","jump","alert","controlString","friendlySpacecraft","hostileSpacecraft"]})},MESSAGE_TEXT_MARGIN:{name:"messageTextMargin",type:"number"},TOP_LEFT_TEXT_LAYER_LAYOUT:{name:"topLeftTextLayerLayout",type:m.LAYOUT_DESCRIPTOR},SCORE_TEXT:{name:"scoreText",type:m.TEXT_DESCRIPTOR},OBJECTIVES_BACKGROUND:{name:"objectivesBackground",type:m.UI_LAID_OUT_IMAGE_DESCRIPTOR},OBJECTIVES_HEADER_TEXT:{name:"objectivesHeaderText",type:m.TEXT_DESCRIPTOR},OBJECTIVES_TEXT:{name:"objectivesText",type:m.getCustomDescriptor(m.TEXT_DESCRIPTOR,{COLOR:["inProgress","completed","failed"]})},OBJECTIVES_TEXT_OFFSET:{name:"objectivesTextOffset",type:"number"},MAX_OBJECTIVES_DISPLAYED:{name:"maxObjectivesDisplayed",type:"number"},ESCORTS_BACKGROUND:{name:"escortsBackground",type:m.UI_LAID_OUT_IMAGE_DESCRIPTOR},ESCORTS_HEADER_TEXT:{name:"escortsHeaderText",type:m.TEXT_DESCRIPTOR},ESCORTS_TEXT:{name:"escortsText",type:m.getCustomDescriptor(m.TEXT_DESCRIPTOR,{COLOR:["alive","away","destroyed"]})},ESCORTS_INTEGRITY_BARS:{name:"escortsIntegrityBars",type:m.getCustomDescriptor(m.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["fullHull","halfHull","zeroHull","awayHull","destroyed","shield","lostShield"],LAYOUT:["hull","shield"]})},ESCORTS_TEXT_OFFSET:{name:"escortsTextOffset",type:"number"},MAX_ESCORTS_DISPLAYED:{name:"maxEscortsDisplayed",type:"number"},TARGET_SWITCH_SOUND:{name:"targetSwitchSound",type:n.SOUND_EFFECT},TARGET_SWITCH_DENIED_SOUND:{name:"targetSwitchDeniedSound",type:n.SOUND_EFFECT},FLIGHT_MODE_SWITCH_SOUND:{name:"flightModeSwitchSound",type:n.SOUND_EFFECT},MISSILE_CHANGE_SOUND:{name:"missileChangeSound",type:n.SOUND_EFFECT},MISSILE_CHANGE_DENIED_SOUND:{name:"missileChangeDeniedSound",type:n.SOUND_EFFECT},MISSILE_SALVO_SOUND:{name:"missileSalvoSound",type:n.SOUND_EFFECT},MISSILE_LOADED_SOUND:{name:"missileLoadedSound",type:n.SOUND_EFFECT},MISSILE_LOCKING_SOUND:{name:"missileLockingSound",type:n.SOUND_EFFECT},MISSILE_LOCKING_SOUND_COUNT:{name:"missileLockingSoundCount",type:"number"},MISSILE_LOCKED_SOUND:{name:"missileLockedSound",type:n.SOUND_EFFECT},MESSAGE_SOUND:{name:"messageSound",type:n.SOUND_EFFECT},MESSAGE_TYPE_SOUND:{name:"messageTypeSound",type:n.SOUND_EFFECT},NEW_HOSTILES_ALERT_SOUND:{name:"newHostilesAlertSound",type:n.SOUND_EFFECT},NEW_HOSTILES_ALERT_DURATION:{name:"newHostilesAlertDuration",type:"number"},NEW_HOSTILES_ALERT_BLINK_INTERVAL:{name:"newHostilesAlertBlinkInterval",type:"number"}},WEAPON_FIRE_SOUND_STACK_MINIMUM_DISTANCE:{name:"weaponFireSoundStackMinimumDistance",type:"number"},HIT_SOUND_STACKING_TIME_THRESHOLD:{name:"hitSoundStackingTimeThreshold",type:"number"},HIT_SOUND_STACKING_VOLUME_FACTOR:{name:"hitSoundStackingVolumeFactor",type:"number"},FIRE_SOUND_STACKING_TIME_THRESHOLD:{name:"fireSoundStackingTimeThreshold",type:"number"},FIRE_SOUND_STACKING_VOLUME_FACTOR:{name:"fireSoundStackingVolumeFactor",type:"number"},DEMO_FIGHTER_AI_TYPE:{name:"demoFighterAI",type:"string"},DEMO_SHIP_AI_TYPE:{name:"demoShipAI",type:"string"},DEMO_VIEW_SWITCHING:{name:"demoViewSwitching",type:"boolean"},DEMO_VIEW_SWITCH_INTERVAL:{name:"demoViewSwitchInterval",type:"number"},DEMO_DOUBLE_VIEW_SWITCH_CHANCE:{name:"demoDoubleViewSwitchChance",type:"number"},MUSIC_VOLUME_IN_MENUS:{name:"musicVolumeInMenus",type:"number"},SFX_VOLUME_IN_MENUS:{name:"sfxVolumeInMenus",type:"number"},AMBIENT_MUSIC:{name:"ambientMusic",type:"string"},ANTICIPATION_MUSIC:{name:"anticipationMusic",type:m.STRING_ARRAY},COMBAT_MUSIC:{name:"combatMusic",type:m.STRING_ARRAY},VICTORY_MUSIC:{name:"victoryMusic",type:"string"},DEFEAT_MUSIC:{name:"defeatMusic",type:"string"},DEBRIEFING_VICTORY_MUSIC:{name:"debriefingVictoryMusic",type:"string"},DEBRIEFING_DEFEAT_MUSIC:{name:"debriefingDefeatMusic",type:"string"},COMBAT_THEME_DURATION_AFTER_FIRE:{name:"combatThemeDurationAfterFire",type:"number"},END_THEME_CROSSFADE_DURATION:{name:"endThemeCrossfadeDuration",type:"number"},DEBRIEFING_THEME_FADE_IN_DURATION:{name:"debriefingThemeFadeInDuration",type:"number"},SCORE_FRACTION_FOR_KILL:{name:"scoreFractionForKill",type:{baseType:"number",range:[0,1]}},SCORE_BONUS_FOR_HULL_INTEGRITY:{name:"scoreBonusForHullIntegrity",type:"number"},SCORE_BONUS_FOR_HULL_INTEGRITY_TEAM:{name:"scoreBonusForHullIntegrityTeam",type:"number"},MISSILE_HIT_RATIO_FACTOR:{name:"missileHitRatioFactor",type:"number"},SCORE_BONUS_FOR_TEAM_SURVIVAL:{name:"scoreBonusForTeamSurvival",type:"number"},DEFAULT_SALVO_MODE:{name:"defaultSalvoMode",type:"boolean"},MISSILE_AUTO_CHANGE_COOLDOWN:{name:"missileAutoChangeCooldown",type:"number"}},c={DEFAULT_FOV:{name:"defaultFOV",type:"number"},DEFAULT_SPAN:{name:"defaultSpan",type:"number"},DEFAULT_BASE_ORIENTATION:{name:"defaultBaseOrientation",type:"enum",values:s.CameraOrientationConfiguration.BaseOrientation},DEFAULT_POINT_TO_FALLBACK:{name:"defaultPointToFallback",type:"enum",values:s.CameraOrientationConfiguration.PointToFallback}},_=g+u.HUD.name+"_",d=g+"battle_",Object.freeze(m),r.prototype=new i.AsyncResource,r.prototype.constructor=r,r.prototype.loadConfigurationFromJSON=function(t){this._configuration=e.getVerifiedObject("configuration",t,a)},r.prototype.getConfigurationSetting=function(t){return this._configuration[t.name]},r.prototype.getSetting=function(t){return this._settings[t.name]},r.prototype.getBattleSetting=function(t){var i;return void 0!==localStorage[d+t.name]&&(i=e.getValueOfTypeFromLocalStorage(t.type,d+t.name)),void 0!==i?i:this._settings[t.name]},r.prototype.setBattleSetting=function(t,e){localStorage[d+t.name]=e},r.prototype.gHS=function(t){var i;return void 0===this._hudSettings[t.name]&&(void 0!==localStorage[_+t.name]&&(i=e.getValueOfTypeFromLocalStorage(t.type,_+t.name)),this._hudSettings[t.name]=void 0!==i?i:this._settings[u.HUD.name][t.name]),this._hudSettings[t.name]},r.prototype.setHUDSetting=function(t,e){localStorage[_+t.name]=e,this._hudSettings[t.name]=e},r.prototype.resetHUDSettings=function(){var t,e,i=Object.keys(u.HUD);for(t=0;t<i.length;t++)"object"==typeof u.HUD[i[t]]&&(e=u.HUD[i[t]].name,localStorage.removeItem(_+e),this._hudSettings[e]=this._settings[u.HUD.name][e])},r.prototype.resetBattleSettings=function(){var t,e=Object.keys(u);for(t=0;t<e.length;t++)"object"==typeof u[e[t]]&&localStorage.removeItem(d+u[e[t]].name)},r.prototype.getDefaultCameraFOV=function(){return this.getSetting(c.DEFAULT_FOV)},r.prototype.getDefaultCameraSpan=function(){return this.getSetting(c.DEFAULT_SPAN)},r.prototype.getDefaultCameraBaseOrientation=function(){return this.getSetting(c.DEFAULT_BASE_ORIENTATION)},r.prototype.getDefaultCameraPointToFallback=function(){return this.getSetting(c.DEFAULT_POINT_TO_FALLBACK)},r.prototype.getDefaultCamerConfigurationName=function(t){return t.isFighter()?this.getBattleSetting(u.DEFAULT_FIGHTER_VIEW_NAME):this.getBattleSetting(u.DEFAULT_SHIP_VIEW_NAME)},r.prototype.loadSettingsFromJSON=function(t){this._settings=e.getVerifiedObject("general",t.general,l),e.getVerifiedObject("database",t.database,h,this._settings),e.getVerifiedObject("battle",t.battle,u,this._settings),e.getVerifiedObject("camera",t.camera,c,this._settings),n.requestLoad(this.getConfigurationSetting(a.CLASSES_SOURCE_FILE),function(){this.setToReady()}.bind(this))},p=new r,{CONFIGURATION:a,GENERAL_SETTINGS:l,BS:u,DATABASE_SETTINGS:h,CAMERA_SETTINGS:c,loadConfigurationFromJSON:p.loadConfigurationFromJSON.bind(p),loadSettingsFromJSON:p.loadSettingsFromJSON.bind(p),getConfigurationSetting:p.getConfigurationSetting.bind(p),getSetting:p.getSetting.bind(p),gHS:p.gHS.bind(p),setHUDSetting:p.setHUDSetting.bind(p),getBattleSetting:p.getBattleSetting.bind(p),setBattleSetting:p.setBattleSetting.bind(p),resetHUDSettings:p.resetHUDSettings.bind(p),resetBattleSettings:p.resetBattleSettings.bind(p),getDefaultCameraFOV:p.getDefaultCameraFOV.bind(p),getDefaultCameraSpan:p.getDefaultCameraSpan.bind(p),getDefaultCameraBaseOrientation:p.getDefaultCameraBaseOrientation.bind(p),getDefaultCameraPointToFallback:p.getDefaultCameraPointToFallback.bind(p),getDefaultCamerConfigurationName:p.getDefaultCamerConfigurationName.bind(p),executeWhenReady:p.executeWhenReady.bind(p)}}),define("armada/audio",["utils/types","modules/application","modules/async-resource","modules/audio","modules/media-resources","armada/constants","armada/configuration","utils/polyfill"],function(t,e,i,s,n,o,r){"use strict";function a(){i.AsyncResource.call(this),this._dataJSON=null,this._masterVolume=1,this._musicVolume=1,this._sfxVolume=1,this._uiVolume=1,this._rolloffFactor=0,this._panningModel=null}function l(t,e,i){var s;I[e]&&I[e].name===t||(s=n.getMusic(t))&&!s.hasError()&&n.executeWhenReady(function(){I[e]={name:t,clip:s.createSoundClip(1,i)}})}function h(t,e,i){void 0===i&&(i=y?t?d:p:t?_:0),t!==y&&(y&&I[y]&&(i>0?I[y].clip.rampVolume(0,i):I[y].clip.stopPlaying()),t&&I[t]&&(I[t].clip.play(!0,e?function(){y===t&&h(e,null,i)}:null),i>0?(I[t].clip.setVolume(0),I[t].clip.rampVolume(1,i)):I[t].clip.setVolume(1)),y=t)}function u(){var t,e=Object.keys(I);for(t=0;t<e.length;t++)I[e[t]]&&I[e[t]].clip.stopPlaying();y=null}function c(){s.resume()}var _,d,p,g,m=o.LOCAL_STORAGE_PREFIX+"audio_",f=m+"masterVolume",S=m+"musicVolume",T=m+"sfxVolume",E=m+"uiVolume",y=null,I={};return a.prototype=new i.AsyncResource,a.prototype.constructor=a,a.prototype.loadConfigurationFromJSON=function(e){e.rolloffFactor&&(this._rolloffFactor=t.getNumberValue("configuration.audio.rolloffFactor",e.rolloffFactor,0)),e.panningModel&&(this._panningModel=t.getEnumValue(s.PanningModel,e.panningModel,{name:"configuration.audio.panningModel"}))},a.prototype.loadSettingsFromJSON=function(i,s){if("object"!=typeof i)return void e.showError("Cannot initialize audio settings from JSON: audio section missing or has wrong type ('"+typeof i+"')!");s=s||!1,s||(this._dataJSON=i),this.setMasterVolume(t.getNumberValue("settings.audio.masterVolume",i.masterVolume,1),!1),this.setMusicVolume(t.getNumberValue("settings.audio.musicVolume",i.musicVolume,1),!1),this.setSFXVolume(t.getNumberValue("settings.audio.sfxVolume",i.sfxVolume,1),!1),this.setUIVolume(t.getNumberValue("settings.audio.uiVolume",i.uiVolume,1),!1)},a.prototype.loadFromLocalStorage=function(){var i,s,n=function(n,o,r,a){void 0!==localStorage[n]&&(s={silentFallback:e.hasVersionChanged(),defaultValue:r},i=t.getValueOfTypeFromLocalStorage(o,n,s),s.error&&!e.hasVersionChanged()||a(i,!!s.error&&s.error!==t.Errors.INVALID_ENUM_OBJECT_ERROR))};n(f,"number",this.getMasterVolume(),this.setMasterVolume.bind(this)),n(S,"number",this.getMusicVolume(),this.setMusicVolume.bind(this)),n(T,"number",this.getSFXVolume(),this.setSFXVolume.bind(this)),n(E,"number",this.getUIVolume(),this.setUIVolume.bind(this)),this.setToReady()},a.prototype.restoreDefaults=function(){this.loadSettingsFromJSON(this._dataJSON,!0),localStorage.removeItem(f),localStorage.removeItem(S),localStorage.removeItem(T),localStorage.removeItem(E)},a.prototype.getMasterVolume=function(){return this._masterVolume},a.prototype.setMasterVolume=function(t,e){return void 0===e&&(e=!0),this._masterVolume=t,s.setMasterVolume(this._masterVolume),e&&(localStorage[f]=t.toString()),this._masterVolume===t},a.prototype.resetMasterVolume=function(){this.setMasterVolume(void 0!==localStorage[f]?localStorage[f]:this._dataJSON.masterVolume)},a.prototype.getMusicVolume=function(){return this._musicVolume},a.prototype.setMusicVolume=function(t,e){return void 0===e&&(e=!0),this._musicVolume=t,s.setMusicVolume(this._musicVolume),e&&(localStorage[S]=t.toString()),this._musicVolume===t},a.prototype.resetMusicVolume=function(){this.setMusicVolume(void 0!==localStorage[S]?localStorage[S]:this._dataJSON.musicVolume)},a.prototype.getSFXVolume=function(){return this._sfxVolume},a.prototype.setSFXVolume=function(t,e){return void 0===e&&(e=!0),this._sfxVolume=t,s.setEffectVolume(this._sfxVolume),e&&(localStorage[T]=t.toString()),this._sfxVolume===t},a.prototype.resetSFXVolume=function(){this.setSFXVolume(void 0!==localStorage[T]?localStorage[T]:this._dataJSON.sfxVolume)},a.prototype.getUIVolume=function(){return this._uiVolume},a.prototype.setUIVolume=function(t,e){return void 0===e&&(e=!0),this._uiVolume=t,s.setUIVolume(this._uiVolume),e&&(localStorage[E]=t.toString()),this._uiVolume===t},a.prototype.resetUIVolume=function(){this.setUIVolume(void 0!==localStorage[E]?localStorage[E]:this._dataJSON.uiVolume)},a.prototype.createSoundSource=function(t){return new s.SoundSource(t,this._rolloffFactor,this._panningModel)},g=new a,r.executeWhenReady(function(){_=r.getSetting(r.GENERAL_SETTINGS.MUSIC_FADE_IN_DURATION),d=r.getSetting(r.GENERAL_SETTINGS.THEME_CROSSFADE_DURATION),p=r.getSetting(r.GENERAL_SETTINGS.MUSIC_FADE_OUT_DURATION)}),{SOUND_RAMP_DURATION:.1,SoundCategory:s.SoundCategory,loadConfigurationFromJSON:g.loadConfigurationFromJSON.bind(g),loadSettingsFromJSON:g.loadSettingsFromJSON.bind(g),loadSettingsFromLocalStorage:g.loadFromLocalStorage.bind(g),
restoreDefaults:g.restoreDefaults.bind(g),getMasterVolume:g.getMasterVolume.bind(g),setMasterVolume:g.setMasterVolume.bind(g),resetMasterVolume:g.resetMasterVolume.bind(g),getMusicVolume:g.getMusicVolume.bind(g),setMusicVolume:g.setMusicVolume.bind(g),resetMusicVolume:g.resetMusicVolume.bind(g),getSFXVolume:g.getSFXVolume.bind(g),setSFXVolume:g.setSFXVolume.bind(g),resetSFXVolume:g.resetSFXVolume.bind(g),getUIVolume:g.getUIVolume.bind(g),setUIVolume:g.setUIVolume.bind(g),resetUIVolume:g.resetUIVolume.bind(g),createSoundSource:g.createSoundSource.bind(g),executeWhenReady:g.executeWhenReady.bind(g),initMusic:l,playMusic:h,stopMusic:u,resume:c}}),define("modules/pools",[],function(){"use strict";function t(t){this._objectConstructor=t,this._objects=[],this._objectsFree=[],this._freeIndices=[],this._firstFreeIndex=0,this._firstLockedIndex=0}function e(e,s){var n=i[e]||new t(s);return i[e]=n,n}var i={};return t.prototype.markAsFree=function(t){this._objectsFree[t]||(this._freeIndices[this._firstLockedIndex]=t,this._objectsFree[t]=!0,++this._firstLockedIndex>=this._freeIndices.length&&(this._firstLockedIndex=0))},t.prototype.getFreeObject=function(){var t;return this._objectsFree[this._freeIndices[this._firstFreeIndex]]?(this._objectsFree[this._freeIndices[this._firstFreeIndex]]=!1,t=this._objects[this._freeIndices[this._firstFreeIndex]],this._firstFreeIndex++,this._firstFreeIndex>=this._freeIndices.length&&(this._firstFreeIndex=0),t):null},t.prototype.addObject=function(t){this._objects.push(t),this._objectsFree.push(!1),this._firstFreeIndex<this._firstLockedIndex||this._firstFreeIndex===this._firstLockedIndex&&!this._objectsFree[this._freeIndices[this._firstFreeIndex]]?this._freeIndices.push(-1):(this._freeIndices.splice(this._firstLockedIndex,0,-1),++this._firstFreeIndex>=this._freeIndices.length&&(this._firstFreeIndex=0))},t.prototype.getObjects=function(){return this._objects},t.prototype.getObject=function(){var t=this.getFreeObject();return t||(t=new this._objectConstructor,this.addObject(t)),t},t.prototype.hasLockedObjects=function(){return this._firstFreeIndex!==this._firstLockedIndex||!this._objectsFree[this._freeIndices[this._firstFreeIndex]]},t.prototype.getLockedObjectCount=function(){return this._firstFreeIndex===this._firstLockedIndex?this._objectsFree[this._freeIndices[this._firstFreeIndex]]?0:this._objects.length:this._firstFreeIndex<this._firstLockedIndex?this._objects.length-(this._firstLockedIndex-this._firstFreeIndex):this._firstFreeIndex-this._firstLockedIndex},t.prototype.executeForLockedObjects=function(t){var e,i=this._freeIndices.length;if(i>0)for(e=0;e<i;e++)this._objectsFree[e]||t(this._objects[e],e)},t.prototype.clear=function(){this._objects=[],this._objectsFree=[],this._freeIndices=[],this._firstFreeIndex=0,this._firstLockedIndex=0},t.prototype.prefill=function(t,e){var i;for(this._objects.length>0&&this.clear(),this._objects=new Array(t),this._objectsFree=new Array(t),this._freeIndices=new Array(t),i=0;i<t;i++)this._objects[i]=new this._objectConstructor,this._objectsFree[i]=!0,this._freeIndices[i]=i;if(e)for(i=0;i<t;i++)e(this._objects[i],i);this._firstFreeIndex=0,this._firstLockedIndex=0},{Pool:t,getPool:e}}),define("modules/scene/particle-system",["utils/utils","utils/vectors","utils/matrices","modules/scene/renderable-objects","modules/scene/scene-graph"],function(t,e,i,s,n){"use strict";function o(t,e,i,s,n,o,r,a,l,h,u){this.pM=t,this.oM=e,this._dimensions=i,this._velocity=s,this._velocitySpread=n,this._initialNumber=o,this._spawnNumber=r,this._spawnTime=a,this._age=0,this._duration=l,this._delay=h||0,this._lastSpawn=0,this._createParticleFunction=u,this._particleDuration=-1,this._size=0,t&&this._calculateSize()}function r(t,e,i,s,n,r,a,l,h,u,c){o.call(this,t,e,i,s,n,r,a,l,h,u,c),this._calculateSize()}function a(e,i,s,n,r,a,l,h,u,c,_,d,p){o.call(this,e,i,s,a,l,h,u,c,_,d,p),this._direction=n,this._directionSpread=r*t.RAD}function l(e,i,s,n,r,a,l,h,u,c,_,d,p){o.call(this,e,i,s,a,l,h,u,c,_,d,p),this._planeNormal=n,this._directionSpread=r*t.RAD}function h(t,e,i,n,o,r,a,l,h,u,c){s.RenderableObject3D.call(this,null,!1,!0,t,e,i,void 0,1,!0),this._velocityMatrix=n,this._emitters=o,this._age=0,this._duration=r,this._keepAlive=!0===a,this._carriesParticles=!0===l,this._hasRelativeOrientation=!0===h,this._minimumCountForInstancing=u,this._particleCountFactor=void 0!==c?c:1,this._calculateSize()}return o.prototype._calculateSize=function(){var t=this._createParticleFunction();this._size=i.translationLength(this.pM)+e.length3(this._dimensions)+Math.max((this._velocity+.5*this._velocitySpread)*t._duration*.001+t.getFinalSize(),t.getMaxSize()),t.markAsReusable(!0)},o.prototype.getSize=function(){return this._size},o.prototype.getParticleDuration=function(){var t;return-1===this._particleDuration&&(this._particleDuration=0,t=this._createParticleFunction(),this._particleDuration=t._duration,t.markAsReusable(!0)),this._particleDuration},o.prototype._emitParticle=function(){var t,i;return t=this._createParticleFunction(),i=[this.pM[12]+(Math.random()-.5)*this._dimensions[0],this.pM[13]+(Math.random()-.5)*this._dimensions[1],this.pM[14]+(Math.random()-.5)*this._dimensions[2]],t.setPositionv(e.prodVec3Mat4Aux(i,this.oM)),t},o.prototype.emitParticles=function(t,e){var i,s,n;if(i=[],void 0===e&&(e=1),this._delay>0&&(this._delay-=t,this._delay<=0&&(t=-this._delay,this._delay=0)),0===this._delay){if(0===this._age)for(n=Math.round(this._initialNumber*e),this._initialNumber>0&&n<1&&(n=1),s=0;s<n;s++)i.push(this._emitParticle());for(this._age+=t;this._age-this._lastSpawn>this._spawnTime&&(this._lastSpawn<this._duration||0===this._duration);){for(n=Math.round(this._spawnNumber*e),this._spawnNumber>0&&n<1&&(n=1),s=0;s<n;s++)i.push(this._emitParticle());this._lastSpawn+=this._spawnTime}}return i},o.prototype.addToContext=function(t){var e=this._createParticleFunction();e.addToContext(t),e.markAsReusable(!0)},r.prototype=new o,r.prototype.constructor=r,r.prototype._emitParticle=function(){var e,i,s,n,r,a,l,h=o.prototype._emitParticle.call(this);return e=this._velocity+(Math.random()-.5)*this._velocitySpread,i=Math.random()*t.DOUBLE_PI,s=Math.random()*t.DOUBLE_PI,n=Math.sin(i),r=Math.cos(i),a=Math.sin(s),l=Math.cos(s),h.setVelocity(e*r*l,e*r*a,e*n),h},a.prototype=new o,a.prototype.constructor=a,a.prototype._emitParticle=function(){var s,n,r,a=o.prototype._emitParticle.call(this);return s=this._velocity+(Math.random()-.5)*this._velocitySpread,n=e.scaled3Aux(this._direction,s),r=Math.abs(this._direction[0])<.75?e.x3Aux():Math.abs(this._direction[1])<.75?e.y3Aux():e.z3Aux(),e.mulCross3(r,this._direction),e.normalize3(r),e.mulVec3Mat3(n,i.rotation3Aux(r,Math.random()*this._directionSpread)),e.mulVec3Mat3(n,i.rotation3Aux(this._direction,Math.random()*t.DOUBLE_PI)),a.setVelocity(n[0],n[1],n[2]),a},l.prototype=new o,l.prototype.constructor=a,l.prototype._emitParticle=function(){var s,n,r,a=o.prototype._emitParticle.call(this);return n=this._velocity+(Math.random()-.5)*this._velocitySpread,s=Math.abs(this._planeNormal[0])<.75?e.x3Aux():Math.abs(this._planeNormal[1])<.75?e.y3Aux():e.z3Aux(),e.mulCross3(s,this._planeNormal),e.normalize3(s),r=e.scaled3(s,n),e.mulVec3Mat3(r,i.rotation3Aux(e.cross3(s,this._planeNormal),(Math.random()-.5)*this._directionSpread)),e.mulVec3Mat3(r,i.rotation3Aux(this._planeNormal,Math.random()*t.DOUBLE_PI)),a.setVelocity(r[0],r[1],r[2]),a},h.prototype=new s.RenderableObject3D,h.prototype.constructor=h,h.prototype.init=function(t,e,i,n,o,r,a,l,h,u,c){s.RenderableObject3D.prototype.init.call(this,null,!1,!0,t,e,i,void 0,1,!0),this._velocityMatrix=n,this._emitters=o,this._age=0,this._duration=r,this._keepAlive=!0===a,this._carriesParticles=!0===l,this._hasRelativeOrientation=!0===h,this._minimumCountForInstancing=u,this._particleCountFactor=void 0!==c?c:1,this._calculateSize()},h.prototype._calculateSize=function(){var t,e=0;for(t=0;t<this._emitters.length;t++)e=Math.max(e,this._emitters[t].getSize());this.setSize(e)},h.prototype._handleOrientationChanged=function(){var t;if(this._carriesParticles&&this.getNode())for(t=this.getNode()._subnodes.getFirst();t;t=t.next)t._renderableObject.invalidateWorldVelocityDirectionVector()},h.prototype.shouldBeRendered=function(t){return this.updateVisibleSize(t,!1),!1},h.prototype.performAnimate=function(t){var s,o,r,a,l;if(!this._keepAlive&&this._age>this._duration)return void this.getNode().markAsReusable(!0);if(this._age+=t,this._emitters)for(s=0;s<this._emitters.length;s++)if(r=this._emitters[s].emitParticles(t,this._particleCountFactor),this._carriesParticles)for(o=0;o<r.length;o++)this.getNode().addSubnode(r[o].getNode()||new n.RenderableNode(r[o],!1,!1,this._minimumCountForInstancing));else if(this._hasRelativeOrientation)for(a=this.getModelMatrix(),l=i.matrix3from4Aux(a),o=0;o<r.length;o++)r[o].translateByMatrix(a),r[o].rotateByMatrix3(l),this.getNode()._scene.addNode(r[o].getNode()||new n.RenderableNode(r[o],!1,!1,this._minimumCountForInstancing));else for(a=this.getModelMatrix(),o=0;o<r.length;o++)r[o].translateByMatrix(a),this.getNode()._scene.addNode(r[o].getNode()||new n.RenderableNode(r[o],!1,!1,this._minimumCountForInstancing));this.translatev(e.scale3(i.translationVector3(this._velocityMatrix),t/1e3))},h.prototype.finishEmitting=function(){var t,e,i=0;if(this._keepAlive=!1,this._carriesParticles){if(this._emitters){for(this._age=0,t=0;t<this._emitters.length;t++)(e=this._emitters[t].getParticleDuration())>i&&(i=e);this._emitters=null,this._duration=i}}else this._duration=0,this.getNode().markAsReusable(!0)},h.prototype.addToContext=function(t){var e;for(e=0;e<this._emitters.length;e++)this._emitters[e].addToContext(t)},{ParticleEmitter:o,OmnidirectionalParticleEmitter:r,UnidirectionalParticleEmitter:a,PlanarParticleEmitter:l,ParticleSystem:h}}),define("armada/logic/constants",[],function(){"use strict";return{SPACECRAFT_LIGHT_PRIORITY:0,EXPLOSION_LIGHT_PRIORITY:1,PROJECTILE_LIGHT_PRIORITY:2,MISSILE_LIGHT_PRIORITY:3,BLINKER_LIGHT_PRIORITY:4,PARTICLE_POOL_NAME:"Particle",PROJECTILE_POOL_NAME:"Projectile",MISSILE_POOL_NAME:"Missile",TRAIL_SEGMENT_POOL_NAME:"TrailSegment",EXPLOSION_POOL_NAME:"Explosion"}}),define("armada/logic/explosion",["utils/vectors","utils/matrices","modules/application","modules/media-resources","modules/pools","modules/scene/renderable-objects","modules/scene/lights","modules/scene/scene-graph","modules/scene/particle-system","armada/graphics","armada/logic/classes","armada/configuration","armada/logic/constants","utils/polyfill"],function(t,e,i,s,n,o,r,a,l,h,u,c,_){"use strict";function d(){E=h.areDynamicLightsAvailable()&&h.getMaxPointLights()>0}function p(){return T.getObject()}function g(t,i,s,n,o,r,a,l){this._class=t,this.pM=i||e.identity4(),this.oM=s||e.identity4(),this._direction=n,this._carriesParticles=!0===o,this._hasRelativeOrientation=!0===r,this._velocityMatrix=a||e.identity4(),this._ignoreParticleCountFactor=!0===l,this.vMo=null}var m,f,S,T,E=!1,y=0;return g.prototype.init=function(t,i,s,n,o,r,a,l){this._class=t,e.copyTranslation4(this.pM,i),e.setMatrix4(this.oM,s),this._direction=n,this._carriesParticles=!0===o,this._hasRelativeOrientation=!0===r,this._ignoreParticleCountFactor=!0===l,e.copyTranslation4(this._velocityMatrix,a||e.IDENTITY4)},g.prototype.createVisualModel=function(t,i){this.vMo=new l.ParticleSystem(this.pM,this.oM,t?e.scaling4(t):e.identity4(),this._velocityMatrix,i||[],this._class?this._class.getTotalDuration():0,!!this._class&&this._class.isContinuous(),this._carriesParticles,this._hasRelativeOrientation,y,this._ignoreParticleCountFactor?1:h.getParticleCountFactor())},g.prototype.canBeReused=function(){return this.vMo&&this.vMo.canBeReused()},g.prototype.getEmitterParticleConstructor=function(t){var i=this._class._particleEmitterDescriptors[t],s=i.getModel(),n=i.getShader(),o=i.getTexturesOfTypes(i.getShader().getTextureTypes(),h.getTextureQualityPreferenceList()),r=i.getParticleStates(),a=i.getInstancedShader();return function(){var t=S.getObject();return t.init(s,n,o,e.IDENTITY4,r,!1,a),t}.bind(this)},g.prototype._initVisualModel=function(t){var i,s,n,o;for(s=[],o=this._class._particleEmitterDescriptors,i=0;i<o.length;i++){switch(o[i].getType()){case u.ParticleEmitterType.OMNIDIRECTIONAL:n=new l.OmnidirectionalParticleEmitter(e.IDENTITY4,e.IDENTITY4,o[i]._dimensions,o[i]._velocity,o[i]._velocitySpread,o[i]._initialNumber,o[i]._spawnNumber,o[i]._spawnTime,o[i]._duration,o[i]._delay,this.getEmitterParticleConstructor(i));break;case u.ParticleEmitterType.UNIDIRECTIONAL:n=new l.UnidirectionalParticleEmitter(e.IDENTITY4,e.IDENTITY4,o[i]._dimensions,this._direction,o[i]._directionSpread,o[i]._velocity,o[i]._velocitySpread,o[i]._initialNumber,o[i]._spawnNumber,o[i]._spawnTime,o[i]._duration,o[i]._delay,this.getEmitterParticleConstructor(i));break;case u.ParticleEmitterType.PLANAR:n=new l.PlanarParticleEmitter(e.IDENTITY4,e.IDENTITY4,o[i]._dimensions,this._direction,o[i]._directionSpread,o[i]._velocity,o[i]._velocitySpread,o[i]._initialNumber,o[i]._spawnNumber,o[i]._spawnTime,o[i]._duration,o[i]._delay,this.getEmitterParticleConstructor(i))}s.push(n)}this.vMo?this.vMo.init(this.pM,this.oM,t?e.scaling4Aux(t):e.IDENTITY4,this._velocityMatrix,s,this._class.getTotalDuration(),this._class.isContinuous(),this._carriesParticles,this._hasRelativeOrientation,y,this._ignoreParticleCountFactor?1:h.getParticleCountFactor()):this.createVisualModel(t,s)},g.prototype.addToSceneNow=function(e,i,s,n){var o,l=e._scene;this._initVisualModel(1/e._renderableObject.getCascadeScalingMatrix()[0]),e.addSubnode(this.vMo.getNode()||new a.RenderableNode(this.vMo,!1)),E&&(o=this._class.getLightStates())&&l.addPointLightSource(new r.PointLightSource(o[0].color,o[0].intensity,t.NULL3,[this.vMo],o),_.EXPLOSION_LIGHT_PRIORITY),this._class.playSound(i,s,m,f),n&&n(this.vMo)},g.prototype.addToScene=function(t,e,i,n){s.executeWhenReady(this.addToSceneNow.bind(this,t,e,i,n))},g.prototype.addResourcesToScene=function(t){var e="explosion/"+this._class._name;this._class.acquireResources({sound:!0}),s.executeWhenReady(function(){t.hasResourcesOfObject(e)||(this._initVisualModel(),t.addResourcesOfObject(this.vMo,e))}.bind(this))},g.prototype.finish=function(){this.vMo.finishEmitting()},g.prototype.destroy=function(){this._class=null,this.pM=null,this.oM=null,this._direction=null,this.vMo&&this.vMo.getNode().markAsReusable(!0),this.vMo=null},S=n.getPool(_.PARTICLE_POOL_NAME,o.Particle),T=n.getPool(_.EXPLOSION_POOL_NAME,g),c.executeWhenReady(function(){m=c.getSetting(c.BS.HIT_SOUND_STACKING_TIME_THRESHOLD),f=c.getSetting(c.BS.HIT_SOUND_STACKING_VOLUME_FACTOR),y=c.getSetting(c.BS.MINIMUM_PARTICLE_COUNT_FOR_INSTANCING),h.executeWhenReady(d),h.onSettingsChange(d)}),{getExplosion:p,Explosion:g}}),define("armada/logic/environments",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/async-resource","modules/media-resources","modules/scene/renderable-objects","modules/scene/lights","modules/scene/scene-graph","armada/graphics","armada/logic/classes","armada/logic/explosion","armada/configuration","armada/strings","utils/polyfill"],function(t,e,i,s,n,o,r,a,l,h,u,c,_,d){"use strict";function p(t){this._class=t}function g(t,e,i,s,n){this._class=t,this._size=e,this._direction=[Math.cos(Math.radians(i))*Math.cos(Math.radians(s)),Math.sin(Math.radians(i))*Math.cos(Math.radians(s)),Math.sin(Math.radians(s))],this._angle=Math.radians(n)||0}function m(t,e){this._positionVector=e,this.vMo=null,this._cloud=t,this._range=t.getRange()}function f(t){this._class=t,this._particles=null,this.vMo=null}function S(t){this._origin=t.position?t.position.slice():[0,0,0],this._origin.push(1),this._position=[0,0,0,1],this._relativeToCamera=!1!==t.relativeToCamera,this._effect=new c.Explosion(u.getExplosionClass(t.class),this._relativeToCamera?void 0:i.translation4v(this._origin),void 0,t.direction||[0,0,1],!1,!0===t.relativeDirection,void 0,!0)}function T(t){this._name=null,this._location=null,this._color=null,this._skyboxes=null,this._backgroundObjects=null,this._dustClouds=null,this._particleEffects=null,this._shadows=!1,this._ambientColor=null,this._drag=0,this._angularDrag=0,this._lockingTimeFactor=0,this._camera=null,this._dataJSON=null,void 0!==t&&this.loadFromJSON(t)}function E(){n.AsyncResource.call(this),this._environments=null}var y;return p.prototype.addToScene=function(t){this._class.acquireResources(),o.executeWhenReady(function(){t.addBackgroundObject(new r.CubemapSampledFVQ(this._class.getModel(),this._class.getShader(),this._class.getShader().getCubemapNames()[0],this._class.getCubemap(h.getCubemapQualityPreferenceList()),t._camera))}.bind(this))},p.prototype.destroy=function(){this._class=null},g.prototype.addToScene=function(t,s){!s&&this._class._lightColor&&t.addDirectionalLightSource(new a.DirectionalLightSource(this._class._lightColor,this._direction)),this._class.acquireResources(),o.executeWhenReady(function(){var s,n,o;for(n=this._class._layers,s=0;s<n.length;s++)o=new r.BackgroundBillboard(n[s].getModel(),n[s].getShader(),n[s].getTexturesOfTypes(n[s].getShader().getTextureTypes(),h.getTextureQualityPreferenceList()),n[s]._color,n[s].getSize()*this._size,i.translation4v(e.scaled3(this._direction,_.getSetting(_.BS.BACKGROUND_OBJECT_DISTANCE))),this._angle),o.setRelativeSize(1),t.addBackgroundObject(o)}.bind(this))},g.prototype.destroy=function(){this._class=null,this._direction=null},m.prototype.addToScene=function(t,e){this.vMo=new r.PointParticle(this._cloud.getClass().getModel(),this._cloud.getClass().getShader(),this._cloud.getClass().getInstancedShader(),this._positionVector,e?this._cloud.getClass()._color:null,e?this._range:0),t.addSubnode(new l.RenderableNode(this.vMo,!1,!1,_.getSetting(_.BS.MINIMUM_DUST_PARTICLE_COUNT_FOR_INSTANCING)))},m.prototype.simulate=function(t){this.vMo.fitPositionWithinRange(t.getCameraPositionMatrix(),this._range)},m.prototype.destroy=function(){this._positionVector=null,this.vMo&&(this.vMo.getNode().markAsReusable(!0),this.vMo=null),this._cloud=null},f.prototype.getClass=function(){return this._class},f.prototype.getRange=function(){return this._class.getRange()},f.prototype.addToScene=function(t){var e,i,s;for(this._class.acquireResources(),this._particles=[],i=this._class.getNumberOfParticles(),e=0;e<i;e++)s=new m(this,[2*(Math.random()-.5)*this._class.getRange(),2*(Math.random()-.5)*this._class.getRange(),2*(Math.random()-.5)*this._class.getRange()]),this._particles.push(s);o.executeWhenReady(function(){var e,s;for(this.vMo=new r.RenderableObject(null,!1,!1,void 0,!1),s=t.addNode(new l.RenderableNode(this.vMo,!1,!0)),e=0;e<i;e++)this._particles[e].addToScene(s,0===e)}.bind(this))},f.prototype.simulate=function(t){var e,i;for(i=this._class.getNumberOfParticles(),this._particles[0].vMo.setShift(t._velocityVector[0],t._velocityVector[1],t._velocityVector[2]),e=0;e<i;e++)this._particles[e].simulate(t)},f.prototype.destroy=function(){var t,e;if(e=this._class.getNumberOfParticles(),this._class=null,this._particles){for(t=0;t<e;t++)this._particles[t].destroy(),this._particles[t]=null;this._particles=null}this.vMo&&(this.vMo.getNode().markAsReusable(!0),this.vMo=null)},S.prototype.addResourcesToScene=function(t){this._effect.addResourcesToScene(t)},S.prototype.addToScene=function(t){this._effect.addToScene(t._rootNode)},S.prototype.simulate=function(t){var i;this._relativeToCamera&&(e.setVector4(this._position,this._origin),i=t.getCameraOrientationMatrix(),e.mulVec4Mat4(this._position,i),e.add3(this._position,t.getCameraPositionVector()),this._effect.vMo.setPositionv(this._position),this._effect.vMo.setOrientationM4(i))},S.prototype.destroy=function(){this._origin=null,this._position=null,this._effect&&this._effect.destroy(),this._effect=null},T.prototype.loadFromJSON=function(t){var e,i;if(this._dataJSON=t,this._name=t.name,this._location=t.location,this._color=t.color||[0,0,0,0],this._skyboxes=[],t.skyboxes)for(e=0;e<t.skyboxes.length;e++)this._skyboxes.push(new p(u.getSkyboxClass(t.skyboxes[e].class)));if(this._backgroundObjects=[],t.backgroundObjects)for(e=0;e<t.backgroundObjects.length;e++)i=u.getBackgroundObjectClass(t.backgroundObjects[e].class),t.backgroundObjects[e].position||s.showError("No position specified for background object of class '"+i._name+"' in environment '"+this._name+"'!",s.ErrorSeverity.MINOR),this._backgroundObjects.push(new g(i,t.backgroundObjects[e].size||s.showError("No size specified for background object of class '"+i._name+"' in environment '"+this._name+"'!",s.ErrorSeverity.MINOR)||0,t.backgroundObjects[e].position&&t.backgroundObjects[e].position.angleAlpha||0,t.backgroundObjects[e].position&&t.backgroundObjects[e].position.angleBeta||0,t.backgroundObjects[e].position&&t.backgroundObjects[e].position.angleGamma||0));if(this._dustClouds=[],t.dustClouds)for(e=0;e<t.dustClouds.length;e++)this._dustClouds.push(new f(u.getDustCloudClass(t.dustClouds[e].class)));if(this._particleEffects=[],t.particleEffects)for(e=0;e<t.particleEffects.length;e++)this._particleEffects.push(new S(t.particleEffects[e]));this._shadows=!1!==t.shadows,this._ambientColor=t.ambientColor||[0,0,0],this._drag=t.drag||0,this._angularDrag=t.angularDrag||0,this._lockingTimeFactor=void 0!==t.lockingTimeFactor?t.lockingTimeFactor:1},T.prototype.getDisplayName=function(){return this._location?t.formatString(d.get(d.LOCATION.SYSTEM),{systemName:this._location}):d.get(d.LOCATION.UNKNOWN)},T.prototype.hasShadows=function(){return this._shadows},T.prototype.getDrag=function(){return this._drag},T.prototype.getLockingTimeFactor=function(){return this._lockingTimeFactor},T.prototype.getData=function(){return this._dataJSON},T.prototype.reloadData=function(){this.loadFromJSON(this._dataJSON)},T.prototype.addToScene=function(t){var e;for(t.setClearColor(this._color),e=0;e<this._skyboxes.length;e++)this._skyboxes[e].addToScene(t);for(e=0;e<this._backgroundObjects.length;e++)this._backgroundObjects[e].addToScene(t,!1);for(e=0;e<this._dustClouds.length;e++)this._dustClouds[e].addToScene(t);for(e=0;e<this._particleEffects.length;e++)this._particleEffects[e].addResourcesToScene(t);this._camera=t._camera,t.setAmbientColor(this._ambientColor)},T.prototype.addParticleEffectsToScene=function(t){var e;for(e=0;e<this._particleEffects.length;e++)this._particleEffects[e].addToScene(t);return this._particleEffects.length>0},T.prototype.simulate=function(){var t;if(this._camera){for(t=0;t<this._dustClouds.length;t++)this._dustClouds[t].simulate(this._camera);for(t=0;t<this._particleEffects.length;t++)this._particleEffects[t].simulate(this._camera)}},T.prototype.removeFromScene=function(){this._camera=null},T.prototype.destroy=function(){var t;if(this._skyboxes){for(t=0;t<this._skyboxes.length;t++)this._skyboxes[t].destroy(),this._skyboxes[t]=null;this._skyboxes=null}if(this._backgroundObjects){for(t=0;t<this._backgroundObjects.length;t++)this._backgroundObjects[t].destroy(),this._backgroundObjects[t]=null;this._backgroundObjects=null}if(this._dustClouds){for(t=0;t<this._dustClouds.length;t++)this._dustClouds[t].destroy(),this._dustClouds[t]=null;this._dustClouds=null}if(this._particleEffects){for(t=0;t<this._particleEffects.length;t++)this._particleEffects[t].destroy(),this._particleEffects[t]=null;this._particleEffects=null}this._camera=null},E.prototype=new n.AsyncResource,E.prototype.constructor=E,E.prototype.getEnvironment=function(t){return this._environments[t]||null},E.prototype.getEnvironmentNames=function(){return Object.keys(this._environments)},E.prototype.createEnvironment=function(t){this._environments[t.name]=new T(t)},E.prototype.executeForAllEnvironments=function(t){var e,i=this.getEnvironmentNames();for(e=0;e<i.length;e++)t(this._environments[i[e]],"environments")},E.prototype.requestLoad=function(){s.requestTextFile(_.getConfigurationSetting(_.CONFIGURATION.ENVIRONMENTS_SOURCE_FILE).folder,_.getConfigurationSetting(_.CONFIGURATION.ENVIRONMENTS_SOURCE_FILE).filename,function(t){this.loadEnvironmentsFromJSON(JSON.parse(t)),this.setToReady()}.bind(this))},E.prototype.loadEnvironmentsFromJSON=function(t){var e,i;for(this._environments={},e=0;e<t.environments.length;e++)i=new T(t.environments[e]),this._environments[t.environments[e].name]=i},y=new E,{requestLoad:y.requestLoad.bind(y),executeWhenReady:y.executeWhenReady.bind(y),getEnvironment:y.getEnvironment.bind(y),getEnvironmentNames:y.getEnvironmentNames.bind(y),createEnvironment:y.createEnvironment.bind(y),executeForAllEnvironments:y.executeForAllEnvironments.bind(y),Skybox:p,BackgroundObject:g,Environment:T}}),define("armada/logic/SpacecraftEvents",[],function(){"use strict";return{BEING_TARGETED:"beingTargeted",BEING_HIT:"beingHit",TARGET_HIT:"targetHit",ANY_SPACECRAFT_HIT:"anySpacecraftHit",TARGET_FIRED:"targetFired",FIRED:"fired",DESTRUCTED:"destructed",JUMP_ENGAGED:"jumpEngaged",PREPARING_JUMP:"preparingJump",JUMP_OUT_STARTED:"jumpOutStarted",JUMPED_OUT:"jumpedOut",JUMPED_IN:"jumpedIn",ARRIVED:"arrived",JUMP_CANCELLED:"jumpCancelled",COMMAND_RECEIVED:"commandReceived",HUD:"hud"}}),define("modules/control/control",["utils/utils","modules/application","modules/async-resource","modules/strings"],function(t,e,i){"use strict";function s(t){this._actionName="string"==typeof t?t:null,"object"==typeof t&&this.loadFromJSON(t)}function n(t,e){this._listening=!1,this._enabled=!0,this._bindingClass=t,this._bindings={},this._disabledActions={},void 0!==e&&this.loadFromJSON(e)}function o(t){this._name=null,this._description=null,this._continuous=!1,this._triggered=!1,this._intensity=this.INTENSITY_NOT_SPECIFIED,this._executed=!1,this._nonTriggeredExecuted=!0,this._executeTriggered=null,this._executeNonTriggered=null,this._source=null,void 0!==t&&this.loadFromJSON(t)}function r(t){this._context=null,this._actions={},void 0!==t&&this.loadFromJSON(t)}function a(){i.AsyncResource.call(this),this._dataJSON=null,this._inputInterpreterTypes={},this._inputInterpreters=null,this._inputInterpretersByType={},this._controllerTypes={},this._controllers=null,this._controllersPriorityQueue=null,this._controllersByType={},this._listening=!1,this._disabledActions={}}return s.prototype.getActionName=function(){return this._actionName},s.prototype.loadFromJSON=function(t){this._actionName=t.action},n.prototype.getDeviceName=function(){return"Generic"},n.prototype.isListening=function(){return this._listening},n.prototype.startListening=function(){this._listening||(this.resetState(),this._listening=!0)},n.prototype.stopListening=function(){this._listening&&(this.resetState(),this._listening=!1)},n.prototype.toggleListening=function(){this._listening?this.stopListening():this.startListening()},n.prototype.isEnabled=function(){return this._enabled},n.prototype.enable=function(){this._enabled=!0},n.prototype.disable=function(){this._enabled=!1},n.prototype.toggleEnabled=function(){this._enabled?this.disable():this.enable()},n.prototype.setBinding=function(t){this._bindings[t.getActionName()]=t},n.prototype.setAndStoreBinding=function(t){this.setBinding(t),t.saveToLocalStorage()},n.prototype.loadFromJSON=function(t){var e;for(e=0;e<t.bindings.length;e++)this.setBinding(new this._bindingClass(t.bindings[e]))},n.prototype.loadFromLocalStorage=function(){var t;for(t in this._bindings)this._bindings.hasOwnProperty(t)&&this._bindings[t].loadFromLocalStorage()},n.prototype.removeFromLocalStorage=function(){var t;for(t in this._bindings)this._bindings.hasOwnProperty(t)&&this._bindings[t].removeFromLocalStorage()},n.prototype.getControlStringForAction=function(t){return void 0!==this._bindings[t]?this._bindings[t].getControlString():""},n.prototype._addActionByBinding=function(t,e,i){var s;if(e){for(s=0;s<t.length;s++)if(i.bindsTheSameControls(t[s].binding))return void t[s].actions.push(e);t.push({binding:i,actions:[e]})}},n.prototype.disableAction=function(t){this._disabledActions[t]=!0},n.prototype.enableAction=function(t){this._disabledActions[t]=!1},n.prototype.getTriggeredActions=function(t){var e,i,s=[],n=[];if(!this.isListening()||!this.isEnabled())return s;for(e in this._bindings)this._bindings.hasOwnProperty(e)&&(this._disabledActions[e]||t&&!t(e)||this._addActionByBinding(n,this.checkAction(e),this._bindings[e]));for(i=0;i<n.length;i++)s.push(n[i].actions);return s},o.prototype.INTENSITY_NOT_SPECIFIED=-3,o.prototype.INTENSITY_KEYPRESS=-2,o.prototype.getDescription=function(){return this._description},o.prototype.loadFromJSON=function(t){this._name=t.name,this._description=t.description,this._continuous=!0===t.continuous,this._triggered=!1,this._intensity=this.INTENSITY_NOT_SPECIFIED,this._executed=!1,this._nonTriggeredExecuted=!0},o.prototype.setTriggered=function(t,e,i){this._triggered=t,void 0!==e&&(this._intensity===this.INTENSITY_NOT_SPECIFIED||this._intensity>=0&&e>this._intensity)?this._intensity=e:void 0===e&&(this._intensity=this.INTENSITY_KEYPRESS),this._source=i},o.prototype.setExecuteTriggered=function(t){this._executeTriggered=t},o.prototype.setExecuteNonTriggered=function(t){this._executeNonTriggered=t},o.prototype.execute=function(){!0===this._continuous?!0===this._triggered?null!==this._executeTriggered&&this._executeTriggered(this._intensity>=0?this._intensity:void 0,this._source):null!==this._executeNonTriggered&&this._executeNonTriggered():!0===this._triggered&&!1===this._executed?(null!==this._executeTriggered&&this._executeTriggered(this._intensity>=0?this._intensity:void 0,this._source),this._executed=!0):(!1===this._triggered&&!1===this._nonTriggeredExecuted&&(null!==this._executeNonTriggered&&this._executeNonTriggered(),this._nonTriggeredExecuted=!0),!1===this._triggered?this._executed=!1:this._nonTriggeredExecuted=!1),this._triggered=!1,this._intensity=this.INTENSITY_NOT_SPECIFIED},r.prototype.setContext=function(t){this._context=t},r.prototype.getActions=function(){var t,e=[];for(t in this._actions)this._actions.hasOwnProperty(t)&&e.push(this._actions[t]);return e},r.prototype.loadFromJSON=function(t){var e,i;for(e=0;e<t.actions.length;e++)i=t.actions[e],i.debug||(this._actions[i.name]=new o(i))},r.prototype.setActionFunction=function(t,i,s){this._actions[t]?!0===i?this._actions[t].setExecuteTriggered(s):this._actions[t].setExecuteNonTriggered(s):e.showError("Attempting to initialize action '"+t+"', but no such action was defined for '"+this.getType()+"' type controllers.",e.ErrorSeverity.SEVERE,"The action definition might be missing from the settings file, or the settings file has not been loaded properly. The game is still playable, but this action will not work until the error with the settings file is corrected and the game is restarted.")},r.prototype.setActionFunctions=function(t,e,i){this.setActionFunction(t,!0,e),this.setActionFunction(t,!1,i)},r.prototype.executeActions=function(t){var e,i,s,n,o;for(e=0;e<t.length;e++){for(s=null,n=-1,o=null,i=0;i<t[e].length;i++)void 0!==this._actions[t[e][i].name]&&(void 0!==t[e][i].intensity&&void 0!==n&&t[e][i].intensity>n||void 0!==n&&void 0===t[e][i].intensity)&&(s=t[e][i].name,n=t[e][i].intensity,o=t[e][i].source);s&&((void 0===n||n>0)&&this._actions[s].setTriggered(!0,n,o),t[e]=[])}for(s in this._actions)this._actions.hasOwnProperty(s)&&this._actions[s].execute()},a.prototype=new i.AsyncResource,a.prototype.constructor=a,a.prototype.registerInputInterpreterType=function(t,e){this._inputInterpreterTypes[t]=e},a.prototype.addInputInterpreter=function(i){
var s=t.getKeyOfValue(this._inputInterpreterTypes,i.constructor);s?(this._inputInterpreters.push(i),this._inputInterpretersByType[s]=i):e.showError("Attempting to add an input interpreter of an unregistered type to the control context!",e.ErrorSeverity.SEVERE,"Interpreter type: "+i.constructor.name)},a.prototype.getInputInterpreters=function(){return this._inputInterpreters},a.prototype.getInputInterpreter=function(t){return this._inputInterpretersByType[t]?this._inputInterpretersByType[t]:(e.showError("Asked for a interpreter of type '"+t+"', which does not exist!"),null)},a.prototype.registerControllerType=function(t,e){this._controllerTypes[t]=e},a.prototype.addController=function(i){var s=t.getKeyOfValue(this._controllerTypes,i.constructor);s?(this._controllers.push(i),this._controllersByType[s]=i,i.setContext(this)):e.showError("Attempting to add a controller of an unregistered type to the control context!",e.ErrorSeverity.SEVERE,"Controller type: "+i.prototype.constructor.name)},a.prototype.getControllers=function(){return this._controllers},a.prototype.getController=function(t){return this._controllersByType[t]?this._controllersByType[t]:(e.showError("Asked for a controller of type '"+t+"', which does not exist!"),null)},a.prototype.makeControllerPriority=function(t){var e;for(this._controllersPriorityQueue=[],e=0;e<this._controllers.length;e++)if(this._controllers[e]===t){this._controllersPriorityQueue.push(this._controllers[e]);break}for(e=0;e<this._controllers.length;e++)this._controllers[e]!==t&&this._controllersPriorityQueue.push(this._controllers[e])},a.prototype.isControllerPriority=function(t){return this._controllersPriorityQueue.length>0&&this._controllersPriorityQueue[0]===this.getController(t)},a.prototype.restoreDefaultControllerPriorityOrder=function(){this._controllersPriorityQueue=this._controllers},a.prototype.disableAction=function(t){this._disabledActions[t]=!0},a.prototype.enableAction=function(t){this._disabledActions[t]=!1},a.prototype.control=function(t){var e,i,s=function(t){return!this._disabledActions[t]}.bind(this);if(this._listening){for(i=[],e=0;e<this._inputInterpreters.length;e++)i=i.concat(this._inputInterpreters[e].getTriggeredActions(s));for(e=0;e<this._controllersPriorityQueue.length;e++)this._controllersPriorityQueue[e].executeActions(i,t)}},a.prototype.loadConfigurationFromJSON=function(t){var i,s;for(this._controllers=[],i=0,s=t.controllers.length;i<s;i++)this._controllerTypes[t.controllers[i].type]?this.addController(new this._controllerTypes[t.controllers[i].type](t.controllers[i])):e.showError("Attempting to load unregistered controller type: '"+t.controllers[i].type+"'!",e.ErrorSeverity.SEVERE,Object.keys(this._controllerTypes).length>0?"Every controller to be loaded must be of one of the registered types: "+Object.keys(this._controllerTypes).join(", ")+".":"There are no types registered and thus loading controllers is not possible.");this._controllersPriorityQueue=this._controllers},a.prototype.loadSettingsFromJSON=function(t,i){var s,n;if(i)for(s=0,n=t.inputDevices.length;s<n;s++)this._inputInterpreterTypes[t.inputDevices[s].type]&&(this._inputInterpreters[s].removeFromLocalStorage(),this._inputInterpreters[s].loadFromJSON(t.inputDevices[s]));else for(this._dataJSON=t,this._inputInterpreters=[],s=0,n=t.inputDevices.length;s<n;s++)this._inputInterpreterTypes[t.inputDevices[s].type]?this.addInputInterpreter(new this._inputInterpreterTypes[t.inputDevices[s].type](t.inputDevices[s])):t.inputDevices[s].optional||e.showError("Attempting to load unregistered input device type: '"+t.inputDevices[s].type+"'!",e.ErrorSeverity.SEVERE,Object.keys(this._inputInterpreterTypes).length>0?"Every input device interpreter to be loaded must be of one of the registered types: "+Object.keys(this._inputInterpreterTypes).join(", ")+".":"There are no types registered and thus loading input interpreters is not possible.")},a.prototype.loadSettingsFromLocalStorage=function(){var t;for(t=0;t<this._inputInterpreters.length;t++)this._inputInterpreters[t].loadFromLocalStorage();this.setToReady()},a.prototype.restoreDefaults=function(){this.loadSettingsFromJSON(this._dataJSON,!0)},a.prototype.startListening=function(){this.executeWhenReady(function(){var t;for(t=0;t<this._inputInterpreters.length;t++)this._inputInterpreters[t].startListening();this._listening=!0})},a.prototype.stopListening=function(){this.executeWhenReady(function(){var t;for(t=0;t<this._inputInterpreters.length;t++)this._inputInterpreters[t].stopListening();this._listening=!1})},a.prototype.isListening=function(){return this._listening},a.prototype.setScreenCenter=function(t,e){this.executeWhenReady(function(){var i;for(i=0;i<this._inputInterpreters.length;i++)this._inputInterpreters[i].setScreenCenter&&this._inputInterpreters[i].setScreenCenter(t,e)})},{ControlBinding:s,InputInterpreter:n,Controller:r,ControlContext:a}}),define("modules/control/keyboard",["utils/utils","modules/application","modules/strings","modules/control/control"],function(t,e,i,s){"use strict";function n(t){c=t}function o(e,i,n,o,r){this._key=i||null,this._keyCode=t.getKeyCodeOf(i),this._shiftState=void 0!==n&&(n||this._keyCode===a),this._ctrlState=void 0!==o&&(o||this._keyCode===l),this._altState=void 0!==r&&(r||this._keyCode===h),s.ControlBinding.call(this,e)}function r(t){s.InputInterpreter.call(this,o,t),this._currentlyPressedKeys=new Array(256)}var a=16,l=17,h=18,u={name:"key"+i.CATEGORY_SEPARATOR},c="";return o.prototype=new s.ControlBinding,o.prototype.constructor=o,o.prototype.loadFromJSON=function(t){s.ControlBinding.prototype.loadFromJSON.call(this,t),this.setKey(t.key),this._shiftState=!0===t.shift||this._keyCode===a,this._ctrlState=!0===t.ctrl||this._keyCode===l,this._altState=!0===t.alt||this._keyCode===h},o.prototype.saveToLocalStorage=function(){localStorage[c+this._actionName+"_key"]=this._key,localStorage[c+this._actionName+"_shift"]=this._shiftState,localStorage[c+this._actionName+"_ctrl"]=this._ctrlState,localStorage[c+this._actionName+"_alt"]=this._altState},o.prototype.loadFromLocalStorage=function(){void 0!==localStorage[c+this._actionName+"_key"]&&(this.setKey(localStorage[c+this._actionName+"_key"]),this._shiftState="true"===localStorage[c+this._actionName+"_shift"],this._ctrlState="true"===localStorage[c+this._actionName+"_ctrl"],this._altState="true"===localStorage[c+this._actionName+"_alt"])},o.prototype.removeFromLocalStorage=function(){localStorage.removeItem(c+this._actionName+"_key"),localStorage.removeItem(c+this._actionName+"_shift"),localStorage.removeItem(c+this._actionName+"_ctrl"),localStorage.removeItem(c+this._actionName+"_alt")},o.prototype.getKey=function(){return this._key},o.prototype.setKey=function(e){this._key=e,this._keyCode=t.getKeyCodeOf(this._key)},o.prototype.getShiftState=function(){return this._shiftState},o.prototype.getCtrlState=function(){return this._ctrlState},o.prototype.getAltState=function(){return this._altState},o.prototype.getControlString=function(){var e,s;return e=i.get(u,this._key,this._key),this._shiftState&&this._keyCode!==a&&(s=t.getKeyOfCode(a),s=i.get(u,s,s),e=s+" + "+e),this._ctrlState&&this._keyCode!==l&&(s=t.getKeyOfCode(l),s=i.get(u,s,s),e=s+" + "+e),this._altState&&this._keyCode!==h&&(s=t.getKeyOfCode(h),s=i.get(u,s,s),e=s+" + "+e),e},o.prototype.isTriggered=function(t){return t[this._keyCode]&&(t[a]||!this._shiftState)&&(t[l]||!this._ctrlState)&&(t[h]||!this._altState)},o.prototype.bindsTheSameControls=function(t){return this._keyCode===t._keyCode},r.prototype=new s.InputInterpreter,r.prototype.constructor=r,r.prototype.getDeviceName=function(){return"keyboard"},r.prototype.resetState=function(){var t;for(t=0;t<this._currentlyPressedKeys.length;t++)this._currentlyPressedKeys[t]=!1},r.prototype.defaultActionEnabledForKey=function(e){return["f5","f11","escape"].indexOf(t.getKeyOfCode(e))>=0},r.prototype.handleKeyDown=function(t){this._currentlyPressedKeys[t.keyCode]=!0,this.defaultActionEnabledForKey(t.keyCode)||(t.preventDefault(),t.stopPropagation())},r.prototype.handleKeyUp=function(t){this._currentlyPressedKeys[t.keyCode]=!1,this.defaultActionEnabledForKey(t.keyCode)||(t.preventDefault(),t.stopPropagation())},r.prototype.startListening=function(){s.InputInterpreter.prototype.startListening.call(this),document.onkeydown=function(t){this.handleKeyDown(t)}.bind(this),document.onkeyup=function(t){this.handleKeyUp(t)}.bind(this),document.onkeypress=function(t){this.defaultActionEnabledForKey(t.keyCode)||(t.preventDefault(),t.stopPropagation())}.bind(this)},r.prototype.stopListening=function(){s.InputInterpreter.prototype.stopListening.call(this),document.onkeydown=null,document.onkeyup=null},r.prototype.checkAction=function(t){return this._bindings[t].isTriggered(this._currentlyPressedKeys)?{name:t,source:this}:null},{setModulePrefix:n,KeyBinding:o,KeyboardInputInterpreter:r}}),define("modules/control/mouse",["utils/utils","modules/strings","modules/control/control"],function(t,e,i){"use strict";function s(t){T=t}function n(t){this._buttonIndex=0,this._moveX=0,this._moveY=0,this._measuredFromCenter=!1,this._scrollX=0,this._scrollY=0,i.ControlBinding.call(this,t)}function o(t){this._currentlyPressedButtons=[!1,!1,!1],this._screenCenter=[0,0],this._screenSize=0,this._mousePosition=[-1,-1],this._mousePositionChange=[0,0],this._scrollChange=[0,0],this._moveSensitivity=0,this._displacementAreaRelativeSize=0,this._displacementFactor=1,this._displacementDeadzone=0,i.InputInterpreter.call(this,n,t)}var r={NONE:"none",LEFT:"left",MIDDLE:"middle",RIGHT:"right"},a=[r.NONE,r.LEFT,r.MIDDLE,r.RIGHT],l={name:"mouse"+e.CATEGORY_SEPARATOR+"leftButton",defaultValue:"left click"},h={name:"mouse"+e.CATEGORY_SEPARATOR+"rightButton",defaultValue:"right click"},u={name:"mouse"+e.CATEGORY_SEPARATOR+"middleButton",defaultValue:"middle click"},c={name:"mouse"+e.CATEGORY_SEPARATOR+"fromCenter",defaultValue:"{move} {toDirection} from center"},_={name:"mouse"+e.CATEGORY_SEPARATOR+"notFromCenter",defaultValue:"{move} {toDirection}"},d={name:"mouse"+e.CATEGORY_SEPARATOR+"move",defaultValue:"move"},p={name:"mouse"+e.CATEGORY_SEPARATOR+"leftDirection",defaultValue:"left"},g={name:"mouse"+e.CATEGORY_SEPARATOR+"rightDirection",defaultValue:"right"},m={name:"mouse"+e.CATEGORY_SEPARATOR+"upDirection",defaultValue:"up"},f={name:"mouse"+e.CATEGORY_SEPARATOR+"downDirection",defaultValue:"down"},S={name:"mouse"+e.CATEGORY_SEPARATOR+"scroll",defaultValue:"scroll"},T="";return n.prototype=new i.ControlBinding,n.prototype.constructor=n,n.prototype.loadFromJSON=function(t){switch(i.ControlBinding.prototype.loadFromJSON.call(this,t),this._buttonIndex=a.indexOf(t.button),this._moveX=0,this._moveY=0,t.move){case"left":this._moveX=-1;break;case"right":this._moveX=1;break;case"up":this._moveY=-1;break;case"down":this._moveY=1}switch(this._measuredFromCenter=!0===t.fromCenter,this._scrollX=0,this._scrollY=0,t.scroll){case"left":this._scrollX=-1;break;case"right":this._scrollX=1;break;case"up":this._scrollY=-1;break;case"down":this._scrollY=1}},n.prototype.saveToLocalStorage=function(){localStorage[T+this._actionName+"_button"]=this._buttonIndex,localStorage[T+this._actionName+"_moveX"]=this._moveX,localStorage[T+this._actionName+"_moveY"]=this._moveY,localStorage[T+this._actionName+"_measuredFromCenter"]=this._measuredFromCenter,localStorage[T+this._actionName+"_scrollX"]=this._scrollX,localStorage[T+this._actionName+"_scrollY"]=this._scrollY},n.prototype.loadFromLocalStorage=function(){void 0!==localStorage[T+this._actionName+"_button"]&&(this._buttonIndex=parseInt(localStorage[T+this._actionName+"_button"],10),this._moveX=parseInt(localStorage[T+this._actionName+"_moveX"],10),this._moveY=parseInt(localStorage[T+this._actionName+"_moveY"],10),this._measuredFromCenter="true"===localStorage[T+this._actionName+"_measuredFromCenter"],this._scrollX=parseInt(localStorage[T+this._actionName+"_scrollX"],10),this._scrollY=parseInt(localStorage[T+this._actionName+"_scrollY"],10))},n.prototype.removeFromLocalStorage=function(){localStorage.removeItem(T+this._actionName+"_button"),localStorage.removeItem(T+this._actionName+"_moveX"),localStorage.removeItem(T+this._actionName+"_moveY"),localStorage.removeItem(T+this._actionName+"_measuredFromCenter"),localStorage.removeItem(T+this._actionName+"_scrollX"),localStorage.removeItem(T+this._actionName+"_scrollY")},n.prototype.getControlString=function(){var i="",s=null;switch(a[this._buttonIndex]){case r.LEFT:return e.get(l);case r.MIDDLE:return e.get(u);case r.RIGHT:return e.get(h)}return i=this._measuredFromCenter?e.get(c):e.get(_),this._moveX<0?s=e.get(p):this._moveX>0?s=e.get(g):this._moveY<0?s=e.get(m):this._moveY>0&&(s=e.get(f)),s?i=t.formatString(i,{move:e.get(d),toDirection:s}):(s=null,i=e.get(_),this._scrollX<0?s=e.get(p):this._scrollX>0?s=e.get(g):this._scrollY<0?s=e.get(m):this._scrollY>0&&(s=e.get(f)),s&&(i=t.formatString(i,{move:e.get(S),toDirection:s})),i)},n.prototype.getTriggeredIntensity=function(t,e,i,s,n){var o,r;return this._buttonIndex>0?!0===t[this._buttonIndex]?1:-1:e?(o=this._measuredFromCenter?e[0]>=0?e[0]-s[0]:0:i[0],0!==this._moveX?o*this._moveX:(r=this._measuredFromCenter?e[1]>=0?e[1]-s[1]:0:i[1],0!==this._moveY?r*this._moveY:0!==this._scrollX?n[0]*this._scrollX:0!==this._scrollY?n[1]*this._scrollY:void 0)):0},n.prototype.bindsTheSameControls=function(t){return this._buttonIndex===t._buttonIndex&&(0===this._moveX&&0===t._moveX||this._moveX*t._moveX!=0)&&(0===this._moveY&&0===t._moveY||this._moveY*t._moveY!=0)&&(0===this._scrollX&&0===t._scrollX||this._scrollX*t._scrollX!=0)&&(0===this._scrollY&&0===t._scrollY||this._scrollY*t._scrollY!=0)},o.prototype=new i.InputInterpreter,o.prototype.constructor=o,o.prototype._updateDisplacementFactor=function(){this._displacementFactor=1/((this._screenSize||1)*this._displacementAreaRelativeSize)},o.prototype.setScreenCenter=function(t,e){this._screenCenter=[t,e],this._screenSize=Math.min(t,e),this._updateDisplacementFactor(),this._mousePosition=[t,e],this._mousePositionChange=[0,0],this._scrollChange=[0,0]},o.prototype.getDeviceName=function(){return"mouse"},o.prototype.resetState=function(){var t;for(t=0;t<this._currentlyPressedButtons.length;t++)this._currentlyPressedButtons[t]=!1;this._mousePosition=[-1,-1],this._mousePositionChange=[0,0],this._scrollChange=[0,0]},o.prototype.setAndStoreMoveSensitivity=function(t){this._moveSensitivity=t,localStorage[T+"mouse_moveSensitivity"]=this._moveSensitivity},o.prototype.getDisplacementAreaRelativeSize=function(){return this._displacementAreaRelativeSize},o.prototype.setAndStoreDisplacementAreaRelativeSize=function(t){this._displacementAreaRelativeSize=t,this._updateDisplacementFactor(),localStorage[T+"mouse_displacementAreaRelativeSize"]=this._displacementAreaRelativeSize},o.prototype.setAndStoreDisplacementDeadzone=function(t){this._displacementDeadzone=t,localStorage[T+"mouse_displacementDeadzone"]=this._displacementDeadzone},o.prototype.loadFromJSON=function(t){i.InputInterpreter.prototype.loadFromJSON.call(this,t),this._moveSensitivity=t.sensitivityProfile.moveSensitivity,this._displacementAreaRelativeSize=t.sensitivityProfile.displacementAreaRelativeSize,this._updateDisplacementFactor(),this._displacementDeadzone=t.sensitivityProfile.displacementDeadzone},o.prototype.loadFromLocalStorage=function(){i.InputInterpreter.prototype.loadFromLocalStorage.call(this),void 0!==localStorage[T+"mouse_moveSensitivity"]&&(this._moveSensitivity=parseFloat(localStorage[T+"mouse_moveSensitivity"])),void 0!==localStorage[T+"mouse_displacementAreaRelativeSize"]&&(this._displacementAreaRelativeSize=parseFloat(localStorage[T+"mouse_displacementAreaRelativeSize"]),this._updateDisplacementFactor()),void 0!==localStorage[T+"mouse_displacementDeadzone"]&&(this._displacementDeadzone=parseInt(localStorage[T+"mouse_displacementDeadzone"],10))},o.prototype.removeFromLocalStorage=function(){i.InputInterpreter.prototype.removeFromLocalStorage.call(this),localStorage.removeItem(T+"mouse_moveSensitivity"),localStorage.removeItem(T+"mouse_displacementAreaRelativeSize"),localStorage.removeItem(T+"mouse_displacementDeadzone")},o.prototype.handleMouseDown=function(t){return this._currentlyPressedButtons[t.which]=!0,t.preventDefault(),!1},o.prototype.handleMouseUp=function(t){return this._currentlyPressedButtons[t.which]=!1,t.preventDefault(),!1},o.prototype.handleMouseMove=function(t){this._mousePosition[0]>=0&&(this._mousePositionChange[0]+=t.clientX-this._mousePosition[0],this._mousePositionChange[1]+=t.clientY-this._mousePosition[1]),this._mousePosition=[t.clientX,t.clientY]},o.prototype.handleWheel=function(t){this._scrollChange[0]+=t.deltaX,this._scrollChange[1]+=t.deltaY},o.prototype.startListening=function(){i.InputInterpreter.prototype.startListening.call(this),document.onmousedown=function(t){this.handleMouseDown(t)}.bind(this),document.onmouseup=function(t){this.handleMouseUp(t)}.bind(this),document.onmousemove=function(t){this.handleMouseMove(t)}.bind(this),document.onwheel=function(t){this.handleWheel(t)}.bind(this),document.onclick=function(t){return t.preventDefault(),!1},document.oncontextmenu=function(t){return t.preventDefault(),!1}},o.prototype.stopListening=function(){i.InputInterpreter.prototype.stopListening.call(this),document.onmousedown=null,document.onmouseup=null,document.onmousemove=null,document.onwheel=null,document.onclick=null,document.oncontextmenu=null},o.prototype.checkAction=function(t){var e=this._bindings[t].getTriggeredIntensity(this._currentlyPressedButtons,this._mousePosition,this._mousePositionChange,this._screenCenter,this._scrollChange);return e>=0?{name:t,intensity:!0===this._bindings[t]._measuredFromCenter?Math.min(1,Math.max(0,e-this._displacementDeadzone)*this._displacementFactor):e*this._moveSensitivity,source:this}:null},o.prototype.getTriggeredActions=function(t){var e=i.InputInterpreter.prototype.getTriggeredActions.call(this,t);return this._mousePositionChange=[0,0],this._scrollChange=[0,0],e},o.prototype.isMouseDisplaced=function(){return Math.abs(this._mousePosition[0]-this._screenCenter[0])>this._displacementDeadzone||Math.abs(this._mousePosition[1]-this._screenCenter[1])>this._displacementDeadzone},{setModulePrefix:s,MouseBinding:n,MouseInputInterpreter:o}}),define("modules/control/gamepad",["utils/utils","modules/application","modules/strings","modules/control/control"],function(t,e,i,s){"use strict";function n(t){_=t}function o(t){this._button=this.BUTTON_NONE,this._axisIndex=this.AXIS_NONE,this._axisPositive=!1,s.ControlBinding.call(this,t)}function r(t){this._sensitivityFactor=t.sensitivityFactor||0,this._staticSensitivity=!0===t.staticSensitivity,this._quadraticIntensity=!0===t.quadraticSensitivity,this._actionNames=t.actionNames,this._sensitivityFactor&&this._staticSensitivity&&e.showError("Sensitivity action group defined with both factored and static sensitivity!",e.ErrorSeverity.MINOR)}function a(t){this._gamepad=null,this._sensitivityActionGroups=null,s.InputInterpreter.call(this,o,t)}var l={name:"joystick"+i.CATEGORY_SEPARATOR+"button",defaultValue:"button {index}"},h={name:"joystick"+i.CATEGORY_SEPARATOR+"axis",defaultValue:"axis {index} {direction}"},u={name:"joystick"+i.CATEGORY_SEPARATOR+"positiveDirection",defaultValue:"positive"},c={name:"joystick"+i.CATEGORY_SEPARATOR+"negativeDirection",defaultValue:"negative"},_="";return o.prototype=new s.ControlBinding,o.prototype.constructor=o,o.prototype.BUTTON_NONE=-1,o.prototype.AXIS_NONE=-1,o.prototype.loadFromJSON=function(t){s.ControlBinding.prototype.loadFromJSON.call(this,t),"number"==typeof t.button&&(this._button=t.button),"string"==typeof t.axis&&(this._axisIndex=Math.abs(parseInt(t.axis,10)),this._axisPositive="-"!==t.axis[0])},o.prototype.saveToLocalStorage=function(){localStorage[_+this._actionName+"_gamepad_button"]=this._button,localStorage[_+this._actionName+"_gamepad_axisIndex"]=this._axisIndex,localStorage[_+this._actionName+"_gamepad_axisPositive"]=this._axisPositive},o.prototype.loadFromLocalStorage=function(){void 0!==localStorage[_+this._actionName+"_gamepad_button"]&&(this._button=parseInt(localStorage[_+this._actionName+"_gamepad_button"],10),this._axisIndex=parseInt(localStorage[_+this._actionName+"_gamepad_button"],10),this._axisPositive="true"===localStorage[_+this._actionName+"_gamepad_axisPositive"])},o.prototype.removeFromLocalStorage=function(){localStorage.removeItem(_+this._actionName+"_gamepad_button"),localStorage.removeItem(_+this._actionName+"_gamepad_axisIndex"),localStorage.removeItem(_+this._actionName+"_gamepad_axisPositive")},o.prototype.getTriggeredIntensity=function(t){return t?this._button!==this.BUTTON_NONE?1===t.buttons[this._button]||"object"==typeof t.buttons[this._button]&&t.buttons[this._button].pressed?1:0:this._axisIndex!==this.AXIS_NONE?Math.max(t.axes[this._axisIndex]*(this._axisPositive?1:-1),0):0:0},o.prototype.getControlString=function(){return this._button!==this.BUTTON_NONE?t.formatString(i.get(l),{index:this._button+1}):this._axisIndex!==this.AXIS_NONE?t.formatString(i.get(h),{index:this._axisIndex+1,direction:this._axisPositive?i.get(u):i.get(c)}):""},o.prototype.bindsTheSameControls=function(t){return this._button===t._button&&this._axisIndex===t._axisIndex},r.prototype.getIntensityForAction=function(t,e){return this._actionNames.indexOf(e)>=0?this._staticSensitivity?void 0:t*(this._quadraticIntensity?t:1)*this._sensitivityFactor:-1},a.prototype=new s.InputInterpreter,a.prototype.constructor=a,a.prototype.getDeviceName=function(){return"joystick"},a.prototype.resetState=function(){this._gamepad=null},a.prototype.loadFromJSON=function(t){var e;if(s.InputInterpreter.prototype.loadFromJSON.call(this,t),this._sensitivityActionGroups=[],t.sensitivityProfile&&t.sensitivityProfile.actionGroups)for(e=0;e<t.sensitivityProfile.actionGroups.length;e++)this._sensitivityActionGroups.push(new r(t.sensitivityProfile.actionGroups[e]))},a.prototype.handleGamepadConnected=function(t){this._gamepad||(this._gamepad=t.gamepad)},a.prototype.startListening=function(){s.InputInterpreter.prototype.startListening.call(this),window.addEventListener("gamepadconnected",function(t){this.handleGamepadConnected(t)}.bind(this))},a.prototype.stopListening=function(){s.InputInterpreter.prototype.stopListening.call(this),window.ongamepadconnected=null},a.prototype.checkAction=function(t){var e,i,s;if((e=this._bindings[t].getTriggeredIntensity(this._gamepad))>0){for(i=0;i<this._sensitivityActionGroups.length;i++)if(void 0===(s=this._sensitivityActionGroups[i].getIntensityForAction(e,t))||s>0)return{name:t,intensity:s,source:this};return{name:t,intensity:e,source:this}}return null},a.prototype.getTriggeredActions=function(t){var e;return this.isListening()?(e=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[],e&&e.length>0?this._gamepad=e[0]:this._gamepad=null,this._gamepad?s.InputInterpreter.prototype.getTriggeredActions.call(this,t):[]):[]},{setModulePrefix:n,GamepadBinding:o,GamepadInputInterpreter:a}}),define("modules/control/touch",["utils/utils","modules/strings","modules/control/control"],function(t,e,i){"use strict";function s(t){E=t}function n(t){this._area=a.NONE,this._type=null,this._timeout=0,this._count=1,this._range=0,this._moveX=0,this._moveY=0,this._currentX=0,this._currentY=0,this._touches=[],this._areaPx=null,this._rangePx=0,this._rangeFactor=0,i.ControlBinding.call(this,t)}function o(t){this._touches=[],this._handleTouchStart=this._handleTouchStart.bind(this),this._handleTouchMove=this._handleTouchMove.bind(this),this._handleTouchEnd=this._handleTouchEnd.bind(this),i.InputInterpreter.call(this,n,t)}var r={TAP:0,LONG_TAP:1,TWO_POINT_TAP:2,THREE_POINT_TAP:3,HOLD:4,SLIDE:5,SWIPE:6},a={NONE:{x:[0,0],y:[0,0]},FULL:{x:[0,1],y:[0,1]},"top-left":{x:[0,.5],y:[0,.5]},"top-right":{x:[.5,1],y:[0,.5]},"bottom-left":{x:[0,.5],y:[.5,1]},"bottom-right":{x:[.5,1],y:[.5,1]},left:{x:[0,.5],y:[0,1]},right:{x:[.5,1],y:[0,1]}},l={name:"touch"+e.CATEGORY_SEPARATOR+"tap",defaultValue:"tap {area} of the screen"},h={name:"touch"+e.CATEGORY_SEPARATOR+"longTap",defaultValue:"long tap {area} of the screen"},u={name:"touch"+e.CATEGORY_SEPARATOR+"twoPointTap",defaultValue:"tap {area} of the screen with two fingers"},c={name:"touch"+e.CATEGORY_SEPARATOR+"threePointTap",defaultValue:"tap {area} of the screen with three fingers"},_={name:"touch"+e.CATEGORY_SEPARATOR+"swipe",defaultValue:"swipe {direction} on {area} of the screen"},d={name:"touch"+e.CATEGORY_SEPARATOR+"hold",defaultValue:"tap and hold on {area} of the screen"},p={name:"touch"+e.CATEGORY_SEPARATOR+"holdDirection",defaultValue:"swipe {direction} and hold on {area} of the screen"},g={name:"touch"+e.CATEGORY_SEPARATOR+"slide",defaultValue:"slide {direction} on {area} of the screen"},m={name:"touch"+e.CATEGORY_SEPARATOR+"leftDirection",defaultValue:"left"},f={name:"touch"+e.CATEGORY_SEPARATOR+"rightDirection",defaultValue:"right"},S={name:"touch"+e.CATEGORY_SEPARATOR+"upDirection",defaultValue:"up"},T={name:"touch"+e.CATEGORY_SEPARATOR+"downDirection",defaultValue:"down"},E="";return n.prototype=new i.ControlBinding,n.prototype.constructor=n,n.prototype._initDerivedProperties=function(){switch(this._areaPx=t.deepCopy(this._area),this._type){case r.TWO_POINT_TAP:this._count=2;break;case r.THREE_POINT_TAP:this._count=3;break;default:this._count=1}this._timeout=this._type===r.LONG_TAP?2e3:300,this._rangePx=0,this._rangeFactor=0,this._currentX=0,this._currentY=0},n.prototype.loadFromJSON=function(e){if(i.ControlBinding.prototype.loadFromJSON.call(this,e),"string"==typeof e.area?this._area=a[e.area]:this._area=a.FULL,"string"==typeof e.type&&(this._type=t.getSafeEnumValueForKey(r,e.type)),this._range=e.range||.5,this._moveX=0,this._moveY=0,"string"==typeof e.direction)switch(e.direction){case"left":this._moveX=-1;break;case"right":this._moveX=1;break;case"up":this._moveY=-1;break;case"down":this._moveY=1}this._initDerivedProperties()},n.prototype.saveToLocalStorage=function(){localStorage[E+this._actionName+"_touch_area"]=JSON.stringify(this._area),localStorage[E+this._actionName+"_touch_type"]=this._type,localStorage[E+this._actionName+"_touch_moveX"]=this._moveX,localStorage[E+this._actionName+"_touch_moveY"]=this._moveY,localStorage[E+this._actionName+"_touch_range"]=this._range},n.prototype.loadFromLocalStorage=function(){void 0!==localStorage[E+this._actionName+"_touch_type"]&&(this._area=JSON.parse(localStorage[E+this._actionName+"_touch_area"]),this._type=localStorage[E+this._actionName+"_touch_type"],this._moveX=parseInt(localStorage[E+this._actionName+"_touch_moveX"],10),this._moveY=parseInt(localStorage[E+this._actionName+"_touch_moveY"],10),this._range=parseInt(localStorage[E+this._actionName+"_touch_range"],10),this._initDerivedProperties())},n.prototype.removeFromLocalStorage=function(){localStorage.removeItem(E+this._actionName+"_touch_area"),localStorage.removeItem(E+this._actionName+"_touch_type"),localStorage.removeItem(E+this._actionName+"_touch_moveX"),localStorage.removeItem(E+this._actionName+"_touch_moveY"),localStorage.removeItem(E+this._actionName+"_touch_range")},n.prototype.setScreenSize=function(t,e){this._areaPx.x[0]=this._area.x[0]*t,this._areaPx.x[1]=this._area.x[1]*t,this._areaPx.y[0]=this._area.y[0]*e,this._areaPx.y[1]=this._area.y[1]*e,this._rangePx=this._range*Math.min(t,e),this._rangeFactor=1/(this._rangePx||1)},n.prototype._touchStartedInArea=function(t){return t.startX>=this._areaPx.x[0]&&t.startX<=this._areaPx.x[1]&&t.startY>=this._areaPx.y[0]&&t.startY<=this._areaPx.y[1]},n.prototype.getTriggeredIntensity=function(t){var e,i,s;switch(this._type){case r.TAP:case r.LONG_TAP:for(e=t.length-1;e>=0;e--){if(i=t[e],i.age>this._timeout)return 0;if(null===i.capturedBy&&this._touchStartedInArea(i)&&Math.abs(i.currentX-i.startX)<=20&&Math.abs(i.currentY-i.startY)<=20&&!0===i.finished)return i.capturedBy=this,1}return 0;case r.TWO_POINT_TAP:case r.THREE_POINT_TAP:if(this._touches.length>0){for(s=0,e=0;e<this._count;e++){if(i=this._touches[e],i.age>this._timeout||null!==i.capturedBy&&i.capturedBy!==this)return this._touches.length=0,0;!0===i.finished&&s++}for(e=0;e<this._count;e++)this._touches[e].capturedBy=this;if(s===this._count)return this._touches.length=0,1}else{for(e=t.length-1;e>=0&&(i=t[e],!(i.age>this._timeout));e--)if(null===i.capturedBy&&this._touchStartedInArea(i)&&Math.abs(i.currentX-i.startX)<=20&&Math.abs(i.currentY-i.startY)<=20){if(!(this._touches.length<this._count))return this._touches.length=0,0;this._touches.push(i)}if(this._touches.length!==this._count)return this._touches.length=0,0;for(e=0;e<this._count;e++)this._touches[e].capturedBy=this}return 0;case r.SWIPE:for(e=0;e<t.length;e++)if(i=t[e],!0===i.finished&&!(i.age>=1e3)&&this._touchStartedInArea(i)&&(i.currentX-i.startX>20&&this._moveX>0||i.currentX-i.startX<-20&&this._moveX<0||i.currentY-i.startY>20&&this._moveY>0||i.currentY-i.startY<-20&&this._moveY<0))return 1;return 0;case r.HOLD:for(e=0;e<t.length;e++)if(i=t[e],!1===i.finished&&this._touchStartedInArea(i))return this._moveX>0?Math.min(Math.max(0,(i.currentX-i.startX-5)*this._rangeFactor),1):this._moveX<0?Math.min(Math.max(0,(i.startX-i.currentX-5)*this._rangeFactor),1):this._moveY>0?Math.min(Math.max(0,(i.currentY-i.startY-5)*this._rangeFactor),1):this._moveY<0?Math.min(Math.max(0,(i.startY-i.currentY-5)*this._rangeFactor),1):1;break;case r.SLIDE:for(e=0;e<t.length;e++)if(i=t[e],!0===i.finished&&!(i.age>=300)&&this._touchStartedInArea(i)&&Math.abs(i.currentX-i.startX)<=5&&Math.abs(i.currentY-i.startY)<=5)return this._currentX=0,this._currentY=0,0;for(e=0;e<t.length;e++)i=t[e],!1===i.finished&&this._touchStartedInArea(i)&&(this._currentX+=i.currentX-i.previousX,this._currentY+=i.currentY-i.previousY,this._currentX>this._rangePx+5?this._currentX=this._rangePx+5:this._currentX<-this._rangePx-5&&(this._currentX=-this._rangePx-5),this._currentY>this._rangePx+5?this._currentY=this._rangePx+5:this._currentY<-this._rangePx-5&&(this._currentY=-this._rangePx-5));return this._moveX>0?Math.min(Math.max(0,(this._currentX-5)*this._rangeFactor),1):this._moveX<0?Math.min(Math.max(0,(-this._currentX-5)*this._rangeFactor),1):this._moveY>0?Math.min(Math.max(0,(this._currentY-5)*this._rangeFactor),1):this._moveY<0?Math.min(Math.max(0,(-this._currentY-5)*this._rangeFactor),1):0}return 0},n.prototype.getControlString=function(){var i="",s="";switch(this._moveX<0?i=e.get(m):this._moveX>0?i=e.get(f):this._moveY<0?i=e.get(S):this._moveY>0&&(i=e.get(T)),s=e.get(e.TOUCH_AREA.PREFIX,t.getKeyOfValue(a,this._area)),this._type){case r.TAP:return t.formatString(e.get(l),{area:s});case r.LONG_TAP:return t.formatString(e.get(h),{area:s});case r.TWO_POINT_TAP:return t.formatString(e.get(u),{area:s});case r.THREE_POINT_TAP:return t.formatString(e.get(c),{area:s});case r.SWIPE:return t.formatString(e.get(_),{area:s,direction:i});case r.HOLD:return 0!==this._moveX||0!==this._moveY?t.formatString(e.get(p),{area:s,direction:i}):t.formatString(e.get(d),{area:s});case r.SLIDE:return t.formatString(e.get(g),{area:s,direction:i})}return""},n.prototype.bindsTheSameControls=function(e){return this._type===e._type&&this._moveX===e._moveX&&this._moveY===e._moveY&&t.objectsEqual(this._area,e._area)},o.prototype=new i.InputInterpreter,o.prototype.constructor=o,o.prototype.getDeviceName=function(){return"touch"},o.prototype.resetState=function(){this._touches=[]},o.prototype.setScreenCenter=function(t,e){var i,s;for(s=Object.keys(this._bindings),i=0;i<s.length;i++)this._bindings[s[i]].setScreenSize(2*t,2*e)},o.prototype._addTouch=function(t,e){this._touches.push({identifier:t.identifier,startTime:e,startX:t.clientX,startY:t.clientY,previousX:t.clientX,previousY:t.clientY,currentX:t.clientX,currentY:t.clientY,finished:!1,capturedBy:null,age:0})},o.prototype._updateTouch=function(t){var e;for(e=0;e<this._touches.length;e++)if(this._touches[e].identifier===t.identifier&&!1===this._touches[e].finished)return this._touches[e].currentX=t.clientX,
void(this._touches[e].currentY=t.clientY)},o.prototype._removeTouch=function(t){var e;for(e=0;e<this._touches.length;e++)if(this._touches[e].identifier===t.identifier)return void(this._touches[e].finished=!0)},o.prototype._handleTouchStart=function(t){var e,i=performance.now();for(t.preventDefault(),e=0;e<t.changedTouches.length;e++)this._addTouch(t.changedTouches[e],i);return!1},o.prototype._handleTouchMove=function(t){var e;for(t.preventDefault(),e=0;e<t.changedTouches.length;e++)this._updateTouch(t.changedTouches[e]);return!1},o.prototype._handleTouchEnd=function(t){var e;for(t.preventDefault(),e=0;e<t.changedTouches.length;e++)this._removeTouch(t.changedTouches[e]);return!1},o.prototype.startListening=function(){var t={passive:!1};i.InputInterpreter.prototype.startListening.call(this),document.addEventListener("touchstart",this._handleTouchStart,t),document.addEventListener("touchmove",this._handleTouchMove,t),document.addEventListener("touchend",this._handleTouchEnd,t),document.addEventListener("touchcancel",this._handleTouchEnd,t)},o.prototype.stopListening=function(){i.InputInterpreter.prototype.stopListening.call(this),document.removeEventListener("touchstart",this._handleTouchStart),document.removeEventListener("touchmove",this._handleTouchMove),document.removeEventListener("touchend",this._handleTouchEnd),document.removeEventListener("touchcancel",this._handleTouchEnd)},o.prototype.checkAction=function(t){var e=this._bindings[t].getTriggeredIntensity(this._touches);return e>0?{name:t,intensity:e,source:this}:null},o.prototype.getTriggeredActions=function(t){var e,s,n,o=performance.now();for(s=i.InputInterpreter.prototype.getTriggeredActions.call(this,t),e=0;e<this._touches.length;e++)n=this._touches[e],n.finished?(this._touches.splice(e,1),e--):(n.previousX=n.currentX,n.previousY=n.currentY,n.age=o-n.startTime,n.capturedBy=null);return s},{setModulePrefix:s,TouchBinding:n,TouchInputInterpreter:o}}),define("modules/camera-controller",["utils/types","modules/application","modules/control/control","modules/scene/camera"],function(t,e,i,s){"use strict";function n(n){i.Controller.call(this,n),this._controlledCamera=null,this._controlledVelocityVector=[0,0,0],this._velocityTargetVector=[0,0,0],this._maxSpeed=n.maxSpeed||0,this._acceleration=n.acceleration||0,this._deceleration=n.deceleration||0,this._angularVelocityVector=[0,0,0],this._maxAngularVelocity=n.maxSpin||0,this._angularAcceleration=n.angularAcceleration||0,this._angularDeceleration=n.angularDeceleration||0,this._angularVelocityTargetVector=[0,0,0],this._objectChangeTransitionDuration=n.objectChangeTransitionDuration,this._viewChangeTransitionDuration=n.viewChangeTransitionDuration,this._viewResetTransitionDuration=n.viewResetTransitionDuration,this._transitionStyle=t.getEnumValue(s.Camera.TransitionStyle,n.transitionStyle,{name:"cameraController.transitionStyle"}),this.setActionFunctions("controlCamera",function(){this._context?this._context.makeControllerPriority(this):e.showError("Cannot make camera controller the priority controller because it is not added to any control context!")}.bind(this),function(){this._controlledCamera.getConfiguration().resetsOnFocusChange()&&this._controlledCamera.transitionToConfigurationDefaults(this._viewResetTransitionDuration,this._transitionStyle),this._context?this._context.restoreDefaultControllerPriorityOrder():e.showError("Cannot restore original priority order of the camera controller's context because it is not added to any!")}.bind(this)),this.setActionFunctions("cameraTurnLeft",function(t){void 0===t?this._angularVelocityTargetVector[1]>-this._maxAngularVelocity&&(this._angularVelocityTargetVector[1]=-this._maxAngularVelocity):(this._angularVelocityTargetVector[1]=-t,this._angularVelocityVector[1]=-t)}.bind(this),function(){this._angularVelocityTargetVector[1]<0&&(this._angularVelocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraTurnRight",function(t){void 0===t?this._angularVelocityTargetVector[1]<this._maxAngularVelocity&&(this._angularVelocityTargetVector[1]=this._maxAngularVelocity):(this._angularVelocityTargetVector[1]=t,this._angularVelocityVector[1]=t)}.bind(this),function(){this._angularVelocityTargetVector[1]>0&&(this._angularVelocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraTurnUp",function(t){void 0===t?this._angularVelocityTargetVector[0]>-this._maxAngularVelocity&&(this._angularVelocityTargetVector[0]=-this._maxAngularVelocity):(this._angularVelocityTargetVector[0]=-t,this._angularVelocityVector[0]=-t)}.bind(this),function(){this._angularVelocityTargetVector[0]<0&&(this._angularVelocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraTurnDown",function(t){void 0===t?this._angularVelocityTargetVector[0]<this._maxAngularVelocity&&(this._angularVelocityTargetVector[0]=this._maxAngularVelocity):(this._angularVelocityTargetVector[0]=t,this._angularVelocityVector[0]=t)}.bind(this),function(){this._angularVelocityTargetVector[0]>0&&(this._angularVelocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraRollLeft",function(t){void 0===t?this._angularVelocityTargetVector[2]>-this._maxAngularVelocity&&(this._angularVelocityTargetVector[2]=-this._maxAngularVelocity):(this._angularVelocityTargetVector[2]=-t,this._angularVelocityVector[2]=-t)}.bind(this),function(){this._angularVelocityTargetVector[2]<0&&(this._angularVelocityTargetVector[2]=0)}.bind(this)),this.setActionFunctions("cameraRollRight",function(t){void 0===t?this._angularVelocityTargetVector[2]<this._maxAngularVelocity&&(this._angularVelocityTargetVector[2]=this._maxAngularVelocity):(this._angularVelocityTargetVector[2]=t,this._angularVelocityVector[2]=t)}.bind(this),function(){this._angularVelocityTargetVector[2]>0&&(this._angularVelocityTargetVector[2]=0)}.bind(this)),this.setActionFunctions("cameraMoveLeft",function(){this._velocityTargetVector[0]>-this._maxSpeed&&(this._velocityTargetVector[0]=-this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[0]<0&&(this._velocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraMoveRight",function(){this._velocityTargetVector[0]<this._maxSpeed&&(this._velocityTargetVector[0]=this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[0]>0&&(this._velocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraMoveUp",function(){this._velocityTargetVector[1]<this._maxSpeed&&(this._velocityTargetVector[1]=this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[1]>0&&(this._velocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraMoveDown",function(){this._velocityTargetVector[1]>-this._maxSpeed&&(this._velocityTargetVector[1]=-this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[1]<0&&(this._velocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraMoveForward",function(t){var e=(void 0!==t?t:1)*this._maxSpeed;(this._velocityTargetVector[2]>-e||void 0!==t)&&(this._velocityTargetVector[2]=-e)}.bind(this),function(){this._velocityTargetVector[2]<0&&(this._velocityTargetVector[2]=0)}.bind(this)),this.setActionFunctions("cameraMoveBackward",function(){this._velocityTargetVector[2]<this._maxSpeed&&(this._velocityTargetVector[2]=this._maxSpeed)}.bind(this),function(){this._velocityTargetVector[2]>0&&(this._velocityTargetVector[2]=0)}.bind(this)),this.setActionFunction("cameraDecreaseFOV",!0,function(){this._controlledCamera.decreaseFOV()}.bind(this)),this.setActionFunction("cameraIncreaseFOV",!0,function(){this._controlledCamera.increaseFOV()}.bind(this)),this.setActionFunction("nextView",!0,function(){this._controlledCamera.changeToNextView(this._viewChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("previousView",!0,function(){this._controlledCamera.changeToPreviousView(this._viewChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("followNext",!0,function(){this._controlledCamera.followNextNode(!0,this._objectChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("followPrevious",!0,function(){this._controlledCamera.followPreviousNode(!0,this._objectChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("resetView",!0,function(){this._controlledCamera.transitionToConfigurationDefaults(this._viewResetTransitionDuration,this._transitionStyle)}.bind(this))}return n.prototype=new i.Controller,n.prototype.constructor=n,n.prototype.getType=function(){return"camera"},n.prototype.setControlledCamera=function(t){this._controlledCamera=t},n.prototype.getMaxSpeed=function(){return this._maxSpeed},n.prototype.setCameraToFollowObject=function(t,e,i,s){this._controlledCamera.followObject(t,!1,e,i,s)},n.prototype.setToFreeCamera=function(){this._controlledCamera.setToFreeCamera(!1)},n.prototype.stop=function(){this._controlledVelocityVector[0]=0,this._controlledVelocityVector[1]=0,this._controlledVelocityVector[2]=0,this._velocityTargetVector[0]=0,this._velocityTargetVector[1]=0,this._velocityTargetVector[2]=0,this._angularVelocityVector[0]=0,this._angularVelocityVector[1]=0,this._angularVelocityVector[2]=0,this._angularVelocityTargetVector[0]=0,this._angularVelocityTargetVector[1]=0,this._angularVelocityTargetVector[2]=0},n.prototype._updateAngularVelocity=function(t){var e;for(e=0;e<this._angularVelocityVector.length;e++)this._angularVelocityVector[e]>=0?this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]?(this._angularVelocityVector[e]+=this._angularAcceleration*t/1e3,this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])):this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]-=this._angularDeceleration*t/1e3,this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])):this._angularVelocityVector[e]<0&&(this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]?(this._angularVelocityVector[e]-=this._angularAcceleration*t/1e3,this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])):this._angularVelocityVector[e]<this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]+=this._angularDeceleration*t/1e3,this._angularVelocityVector[e]>this._angularVelocityTargetVector[e]&&(this._angularVelocityVector[e]=this._angularVelocityTargetVector[e])))},n.prototype._updateVelocity=function(t){var e;for(e=0;e<this._controlledVelocityVector.length;e++)this._controlledVelocityVector[e]>=0?this._controlledVelocityVector[e]<this._velocityTargetVector[e]?(this._controlledVelocityVector[e]+=this._acceleration*t/1e3,this._controlledVelocityVector[e]>this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])):this._controlledVelocityVector[e]>this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]-=this._deceleration*t/1e3,this._controlledVelocityVector[e]<this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])):this._controlledVelocityVector[e]<0&&(this._controlledVelocityVector[e]>this._velocityTargetVector[e]?(this._controlledVelocityVector[e]-=this._acceleration*t/1e3,this._controlledVelocityVector[e]<this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])):this._controlledVelocityVector[e]<this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]+=this._deceleration*t/1e3,this._controlledVelocityVector[e]>this._velocityTargetVector[e]&&(this._controlledVelocityVector[e]=this._velocityTargetVector[e])))},n.prototype.executeActions=function(t,e){this._controlledCamera&&(i.Controller.prototype.executeActions.call(this,t),this._updateAngularVelocity(e),this._updateVelocity(e),this._controlledCamera.setControlledVelocityVector(this._controlledVelocityVector),this._controlledCamera.setAngularVelocityVector(this._angularVelocityVector))},{CameraController:n}}),define("armada/screens/shared",["modules/game","modules/media-resources","modules/components","armada/configuration","armada/audio"],function(t,e,i,s,n){"use strict";function o(){document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.mozExitFullScreen?document.mozExitFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen():document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.webkitRequestFullscreen?document.documentElement.webkitRequestFullscreen():document.documentElement.msRequestFullscreen&&document.documentElement.msRequestFullscreen()}var r,a,l={MENU_THEME:"menu",DEBRIEFING_VICTORY_THEME:"debriefing_victory",DEBRIEFING_DEFEAT_THEME:"debriefing_defeat",SELECTOR_SOURCE:"selector.html",SELECTOR_CSS:"selector.css",SLIDER_SOURCE:"slider.html",SLIDER_CSS:"slider.css",LOADING_BOX_SOURCE:"loadingbox.html",LOADING_BOX_CSS:"loadingbox.css",INFO_BOX_SOURCE:"infobox.html",INFO_BOX_CSS:"infobox.css",MENU_COMPONENT_SOURCE:"menucomponent.html",LIST_COMPONENT_SOURCE:"listcomponent.html",LIST_COMPONENT_CSS:"listcomponent.css",MENU_CLASS_NAME:"menu",MENU_BUTTON_CONTAINER_CLASS_NAME:"transparentContainer",LIST_CLASS_NAME:"list",LIST_ELEMENT_CLASS_NAME:"listElement",LIST_ELEMENT_CONTAINER_CLASS_NAME:"transparentContainer",CAPTION_CLASS_NAME:"caption",SUBCAPTION_CLASS_NAME:"subcaption",SUPERIMPOSE_BACKGROUND_COLOR:[.25,.25,.25,.5],SCREEN_BACKGROUND_CLASS_NAME:"fullScreenFix",SCREEN_CONTAINER_CLASS_NAME:"fullScreenContainer",RELEASE_NOTES_CLASS_NAME:"releaseNotes",MAIN_MENU_SCREEN_NAME:"mainMenu",MAIN_MENU_SCREEN_SOURCE:"menu.html",MAIN_MENU_CONTAINER_ID:"menuContainer",MISSIONS_SCREEN_NAME:"missions",MISSIONS_SCREEN_SOURCE:"missions.html",MISSIONS_SCREEN_CSS:"missions.css",MISSIONS_LIST_CONTAINER_ID:"missionListContainer",BATTLE_SCREEN_NAME:"battle",BATTLE_SCREEN_SOURCE:"battle.html",BATTLE_SCREEN_CSS:"battle.css",DEBRIEFING_SCREEN_NAME:"debriefing",DEBRIEFING_SCREEN_SOURCE:"debriefing.html",DEBRIEFING_SCREEN_CSS:"debriefing.css",DATABASE_SCREEN_NAME:"database",DATABASE_SCREEN_SOURCE:"database.html",DATABASE_SCREEN_CSS:"database.css",SETTINGS_SCREEN_NAME:"settings",SETTINGS_SCREEN_SOURCE:"menu.html",SETTINGS_MENU_CONTAINER_ID:"menuContainer",GENERAL_SETTINGS_SCREEN_NAME:"generalSettings",GENERAL_SETTINGS_SCREEN_SOURCE:"general-settings.html",GENERAL_SETTINGS_SCREEN_CSS:"general-settings.css",GRAPHICS_SCREEN_NAME:"graphics",GRAPHICS_SCREEN_SOURCE:"graphics.html",GRAPHICS_SCREEN_CSS:"graphics.css",AUDIO_SCREEN_NAME:"audio",AUDIO_SCREEN_SOURCE:"audio.html",CONTROLS_SCREEN_NAME:"controls",CONTROLS_SCREEN_SOURCE:"controls.html",CONTROLS_SCREEN_CSS:"controls.css",GAMEPLAY_SETTINGS_SCREEN_NAME:"gameplaySettings",GAMEPLAY_SETTINGS_SCREEN_SOURCE:"gameplay-settings.html",GAMEPLAY_SETTINGS_SCREEN_CSS:"gameplay-settings.css",ABOUT_SCREEN_NAME:"about",ABOUT_SCREEN_SOURCE:"about.html",ABOUT_SCREEN_CSS:"about.css",INGAME_MENU_SCREEN_NAME:"ingameMenu",INGAME_MENU_SCREEN_SOURCE:"ingame-menu.html",INGAME_MENU_SCREEN_CSS:"ingame-menu.css",INGAME_MENU_CONTAINER_ID:"menuContainer",DIALOG_SCREEN_NAME:"dialog",DIALOG_SCREEN_SOURCE:"dialog.html",DIALOG_SCREEN_CSS:"dialog.css"};return l.initAudio=function(t){var i,o;i=e.getSoundEffect(s.getSetting(s.GENERAL_SETTINGS.BUTTON_SELECT_SOUND).name),o=e.getSoundEffect(s.getSetting(s.GENERAL_SETTINGS.BUTTON_CLICK_SOUND).name),n.initMusic(s.getSetting(s.GENERAL_SETTINGS.MENU_MUSIC),l.MENU_THEME,!0),(i&&!i.isLoaded()&&!i.hasError()||o&&!o.isLoaded()&&!o.hasError())&&e.executeWhenReady(function(){r=i&&i.createSoundClip(e.SoundCategory.UI,s.getSetting(s.GENERAL_SETTINGS.BUTTON_SELECT_SOUND).volume),a=o&&o.createSoundClip(e.SoundCategory.UI,s.getSetting(s.GENERAL_SETTINGS.BUTTON_CLICK_SOUND).volume)}),e.requestResourceLoad(),t&&e.executeWhenReady(t)},l.playButtonSelectSound=function(t){r&&t&&r.play()},l.playButtonClickSound=function(t){a&&t&&a.play()},l.openDialog=function(e){t.getScreen(l.DIALOG_SCREEN_NAME).setup(e),t.setScreen(l.DIALOG_SCREEN_NAME,!0,l.SUPERIMPOSE_BACKGROUND_COLOR)},l.getSubParagraph=function(t){return'<p class="sub fadedText">'+t+"</p>"},l.setupFullscreenButton=function(){t.usesElectron()?this.getElement("fullscreenButton").hidden=!0:this.getElement("fullscreenButton").onclick=o},l.BUTTON_EVENT_HANDLERS={button:{mouseenter:function(){l.playButtonSelectSound(!this.classList.contains(i.DISABLED_CLASS_NAME))},mouseup:function(){l.playButtonClickSound(!this.classList.contains(i.DISABLED_CLASS_NAME))}}},l.MENU_EVENT_HANDLERS={show:l.setupFullscreenButton,optionselect:l.playButtonSelectSound,optionclick:l.playButtonClickSound},l.MENU_STYLE={menuClassName:l.MENU_CLASS_NAME,buttonContainerClassName:l.MENU_BUTTON_CONTAINER_CLASS_NAME,selectedButtonClassName:i.SELECTED_CLASS_NAME,disabledClassName:i.DISABLED_CLASS_NAME},l}),define("armada/logic/equipment",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/managed-gl","modules/physics","modules/media-resources","modules/pools","modules/scene/renderable-objects","modules/scene/lights","modules/scene/scene-graph","armada/graphics","armada/audio","armada/logic/classes","armada/logic/SpacecraftEvents","armada/configuration","armada/logic/constants","armada/logic/explosion","utils/polyfill"],function(t,e,i,s,n,o,r,a,l,h,u,c,_,d,p,g,m,f){"use strict";function S(){rt={},rt[ot]=n.ShaderVariableType.MAT4,c.areLuminosityTexturesAvailable()&&(rt[nt]=n.ShaderVariableType.FLOAT),at=c.areDynamicLightsAvailable()&&c.getMaxPointLights()>0}function T(t){K=t.getPlayerSelfDamage(),Z=t.getPlayerFriendlyFireDamage(),$=t.getHitboxOffset()}function E(t,e){var i;for(t.burn+=e,i=0;i<t.thrusters.length;i++)t.thrusters[i].addBurn(e)}function y(t,e){return e?$:0}function I(t,s,n,o,r,a,l){var h,u,c,_,d,p,g,m,f,S,T,E,y,I;if(d=i.translationVector3(t.pM),g=i.translationVector3(t.getVelocityMatrix()),u=s.getObjects(Math.min(d[0],d[0]-g[0]*n*.001),Math.max(d[0],d[0]-g[0]*n*.001),Math.min(d[1],d[1]-g[1]*n*.001),Math.max(d[1],d[1]-g[1]*n*.001),Math.min(d[2],d[2]-g[2]*n*.001),Math.max(d[2],d[2]-g[2]*n*.001)),U)for(h=0;h<u.length;h++)u[h].showHitbox();for(c=!r||r.isHostile(o),_=o===r,h=0;h<u.length;h++)if((S=u[h].pMo)&&(u[h]===o&&J&&(K||!_)||u[h]!==o&&(Z||u[h]!==r||c))&&(I=a(u[h],_&&r.isHostile(u[h])),T=S.checkHit(d,g,n,I)))return f=e.diffVec3Mat4(g,S.getVelocityMatrix()),m=e.extractLength3(f),p=e.prodVec3Mat4Aux(f,i.inverseOfRotation4Aux(u[h].vMo.oM)),E=e.prodVec4Mat4Aux(T,u[h].vMo.getModelMatrix()),y=e.diffVec3Mat4Aux(E,S.pM),void l(u[h],S,T,E,y,p,f,m,I)}function A(t,e,i,s,n){this._class=null,this.vMo=null,this.pMo=new o.PhysicalObject,this._timeLeft=0,this._origin=null,this._lightSource=null,this._hitCallback=A.prototype._hitCallback.bind(this),t&&this.init(t,e,i,s,n)}function M(t){this._descriptor=t,this._firstPoint=[0,0,0],this._lastPoint=[0,0,0],this._emitting=!1,this._lastSegment=null,this.vMo=null,this._lastScene=null}function C(t,e,s,n,r,a){this._class=null,this.vMo=null,this._trailEmitter=null,this.pMo=new o.PhysicalObject,this._timeLeft=0,this._origin=null,this._turningMatrix=i.identity4(),this._turningMatrixValid=!1,this._yawTarget=0,this._pitchTarget=0,this._turningLimit=0,this._thrusters=[],this._forward={burn:0,thrusters:[]},this._yawLeft={burn:0,thrusters:[]},this._yawRight={burn:0,thrusters:[]},this._pitchUp={burn:0,thrusters:[]},this._pitchDown={burn:0,thrusters:[]},this._burnForAngularVelocityChangeFactor=0,this._mainBurn=!1,this._started=!1,this._homing=!1,this._stopHoming=!1,this._t=null,this._tHitPosition=[0,0,0],this._tHitPositionValid=!1,this._lightSource=null,this._soundSource=null,this._soundSourcePosition=[0,0,0],this._hitCallback=C.prototype._hitCallback.bind(this),this._getHitOffset=C.prototype._getHitOffset.bind(this),t&&this.init(t,e,s,n,r,a)}function N(t,e,s){this._class=t,this._sc=e,this._slot=s,this._cooldown=0,this.vMo=null,this._origoPositionMatrix=null,this._scaledOriMatrix=null,this._rotationAngles=[0,0],this._rotationChanged=!1,this._transformMatrix=i.identity4(),this._fixed=this._class._fixed,this._lastAimStatus=this._fixed?Y.FIXED:Y.NO_TARGET}function O(t,e,i,s){this._class=t,this._sc=e,this._descriptor=i,this._mCount=s,this._cooldown=0,this._activeTubeIndex=0,this._salvo=!1,this._salvoLeft=0,this._salvoTarget=null,this.vMos=null}function R(t,e,i){this._sc=t,this._t=null,this._scArray=e||null,this._tHitPosition=null,this._orderedHostileTargets=null,this._orderedNonHostileTargets=null,this._timeUntilHostileOrderReset=0,this._timeUntilNonHostileOrderReset=0,this._mL=null,this._lockTime=1,this._lockTimeLeft=1,this._lockingTimeFactor=i?i.getLockingTimeFactor():1}function L(t,e){this._propulsionClass=t,this._slot=e,this.vMo=null,this._shipModel=null,this._burnLevel=0,this._maxMoveBurnLevel=this._propulsionClass.getMaxMoveBurnLevel()}function x(t,e){this._class=t,this._drivenPhysicalObject=e,this._thrusters=[],this._forward={burn:0,thrusters:[]},this._reverse={burn:0,thrusters:[]},this._strafeLeft={burn:0,thrusters:[]},this._strafeRight={burn:0,thrusters:[]},this._raise={burn:0,thrusters:[]},this._lower={burn:0,thrusters:[]},this._yawLeft={burn:0,thrusters:[]},this._yawRight={burn:0,thrusters:[]},this._pitchUp={burn:0,thrusters:[]},this._pitchDown={burn:0,thrusters:[]},this._rollLeft={burn:0,thrusters:[]},this._rollRight={burn:0,thrusters:[]},this._thrusterSoundClip=null,this._yawTorque=null,this._pitchTorque=null,this._rollTorque=null,this._thrustFactor=this._class.getThrust()/this._class.getMaxMoveBurnLevel(),this._angularThrustFactor=this._class.getAngularThrust()/this._class.getMaxTurnBurnLevel()}function v(t){this._sc=t,this._assisted=!0,this._restricted=!1,this._yawTarget=0,this._pitchTarget=0,this._rollTarget=0,this._holdSpeed=!1,this._speedThrottled=!1,this._speedTarget=0,this._strafeTarget=0,this._liftTarget=0,this._locked=!1,this._speedIncrementPerSecond=0,this._speedIncrement=0,this._maxCombatForwardSpeed=0,this._maxCombatReverseSpeed=0,this._maxCruiseForwardSpeed=0,this._maxCruiseReverseSpeed=0,this._turningLimit=0,this._maxMoveBurnLevel=0,this._maxTurnBurnLevel=0,this.updateForNewPropulsion()}function b(t,e){this._class=t,this._sc=e,this._state=b.JumpState.NONE,this._timeLeft=0,this._soundClip=null,this._originalFlightMode=null,this._originalScalingMatrix=null}function D(t,e){var i;this._class=t,this._sc=e,this._capacity=t._capacity,this._timeSinceHit=0,this._timeSinceRecharge=t?t._rechargeAnimationDuration:0,this._state=[0,0,0,0],t&&(i=t._rechargeColor,this._state[0]=i[0],this._state[1]=i[1],this._state[2]=i[2]),this._soundClip=null}var w,F,P,V,U,B,H,G,j,k,W,X={FREE:"free",COMBAT:"combat",CRUISE:"cruise"},Y={FIXED:0,NO_TARGET:1,AIMING_OUT_OF_REACH:2,AIMING:3,AIMED_OUT_OF_RANGE:4,AIMED_IN_RANGE:5},z={FORWARD:"forward",REVERSE:"reverse",STRAFE_LEFT:"strafeLeft",STRAFE_RIGHT:"strafeRight",RAISE:"raise",LOWER:"lower",YAW_LEFT:"yawLeft",YAW_RIGHT:"yawRight",PITCH_UP:"pitchUp",PITCH_DOWN:"pitchDown",ROLL_LEFT:"rollLeft",ROLL_RIGHT:"rollRight"},q=Math.radians(.05),Q=1e3/o.ANGULAR_VELOCITY_MATRIX_DURATION,J=!1,K=!1,Z=!1,$=0,tt=0,et=0,it=0,st=0,nt=null,ot=null,rt=null,at=!1;return Object.freeze(X),Object.freeze(Y),Object.freeze(z),A.prototype.init=function(e,s,n,o,r){var a=i.identity4Aux();o&&i.copyTranslation4(a,o.getVelocityMatrix()),r&&(a[12]+=n[4]*r,a[13]+=n[5]*r,a[14]+=n[6]*r),this._class=e,this.pMo.init(e._mass,s||i.IDENTITY4,n||i.IDENTITY4,i.scaling4Aux(e.getSize()),a,t.EMPTY_ARRAY,!0,!0,e._dragFactor),this._timeLeft=e._duration,this._origin=o},A.prototype.canBeReused=function(){return this._timeLeft<=0},A.prototype.createVisualModel=function(){this.vMo=new l.Billboard},A.prototype._initVisualModel=function(t){this.vMo||this.createVisualModel(),this.vMo.init(this._class.getModel(),this._class.getShader(),this._class.getTexturesOfTypes(this._class.getShader().getTextureTypes(),c.getTextureQualityPreferenceList()),this._class.getSize(),t,this.pMo.pM,this.pMo.oM,this._class.getInstancedShader())},A.prototype.setLightSource=function(t){this._lightSource=t},A.prototype.addToSceneNow=function(t,e,i){this._initVisualModel(e),t.addObject(this.vMo,!1,it),i&&i(this.vMo)},A.prototype.addToScene=function(t,e,i){r.executeWhenReady(this.addToSceneNow.bind(this,t,e,i))},A.prototype.addResourcesToScene=function(t,e){var s,n="projectile/"+this._class._name;this._class.acquireResources({projectileOnly:!1,sound:!0}),r.executeWhenReady(function(){t.hasResourcesOfObject(n)||(this._initVisualModel(e),t.addResourcesOfObject(this.vMo,n),s=new f.Explosion(this._class._explosionClass,i.IDENTITY4,i.IDENTITY4,[0,0,0],!0),s.addResourcesToScene(t),s=new f.Explosion(this._class._shieldExplosionClass,i.IDENTITY4,i.IDENTITY4,[0,0,0],!0),s.addResourcesToScene(t))}.bind(this))},A.prototype._hitCallback=function(t,s,n,o,r,a,l,h,u){var c,_;_=Math.min(this._timeLeft/this._class._dissipationDuration,1),s.applyForceAndTorque(r,l,_*h*this.pMo._mass*1e3/tt,tt),c=f.getExplosion(),c.init(t.getShieldIntegrity()>0?this._class._shieldExplosionClass:this._class._explosionClass,i.translation4vAux(o),i.IDENTITY4,e.scaled3(l,-1),!0,!0,s.getVelocityMatrix()),c.addToSceneNow(this.vMo.getNode()._scene._rootNode,t.getSoundSource(),!0),t.damage(_*this._class.getDamage(),n,e.scaled3(a,-1),this._origin,!1,u),this._timeLeft=0,this.vMo.markAsReusable(!0)},A.prototype.simulate=function(t,e,i){var s,n;this.canBeReused()||(s=Math.min(t,this._class._duration-this._timeLeft),this._timeLeft-=t,this._timeLeft>0?(this.pMo.simulate(t),this.vMo.setPositionMatrix(this.pMo.pM),this._timeLeft<this._class._dissipationDuration&&(n=this._timeLeft/this._class._dissipationDuration,this.vMo.setDirectionW(n),this._lightSource&&this._lightSource.setObjectIntensity(n*this._class._lightIntensity)),I(this.pMo,e,s,this._origin,i,y,this._hitCallback)):this.vMo.markAsReusable(!0))},A.prototype.destroy=function(){this._timeLeft=0,this._class=null,this._origin=null,this.vMo&&this.vMo.getNode()&&this.vMo.getNode().markAsReusable(!0),this.vMo=null,this.pMo=null},M.prototype.getDescriptor=function(){return this._descriptor},M.prototype.addResourcesToScene=function(t){this._descriptor.acquireResources(),r.executeWhenReady(function(){t.addResourcesOfObject(new l.TrailSegment(this._descriptor.getModel(),this._descriptor.getShader(),this._descriptor.getTexturesOfTypes(this._descriptor.getShader().getTextureTypes(),c.getTextureQualityPreferenceList()),this._descriptor.getSize(),!1,e.NULL3,e.NULL3,e.NULL3,e.NULL3,e.NULL4,0,0,0,this._descriptor.getInstancedShader()))}.bind(this))},M.prototype.startNew=function(t,i){e.setVector3(this._firstPoint,i),e.setVector3(this._lastPoint,i),this._emitting=!0,this._lastSegment=null,this.vMo=new l.Trail(this._descriptor.getSize()),t.addNode(new u.RenderableNode(this.vMo,!1,!0)),this._lastScene!==t&&(t.addObjectToMove(this),this._lastScene=t)},M.prototype.addPoint=function(t,i){var s,n,o;this.vMo.setPositionv(t),o=e.normalize3(e.diff3(t,this._lastPoint)),n=this._lastSegment?this._lastSegment.getEndTimeLeft():0,s=W.getObject(),s.init(this._descriptor.getModel(),this._descriptor.getShader(),this._descriptor.getTexturesOfTypes(this._descriptor.getShader().getTextureTypes(),c.getTextureQualityPreferenceList()),this._descriptor.getSize(),!1,this._lastPoint,this._lastSegment?this._lastSegment.getEndDirection():o,t,o,this._descriptor._color,this._descriptor._duration,n,Math.min(this._descriptor._duration,n+this._descriptor._growthRate*i),this._descriptor.getInstancedShader()),this.vMo.getNode().addSubnode(s.getNode()||new u.RenderableNode(s,!1,!1,st)),this.vMo.setSize(e.length3(e.diff3Aux(this._firstPoint,t))),e.setVector3(this._lastPoint,t),this._lastSegment=s},M.prototype.translatev=function(t){e.add3(this._lastPoint,t)},M.prototype.detach=function(){this._emitting=!1,this._lastSegment=null,this.vMo=null},M.prototype.destroy=function(){this._descriptor=null,this._emitting=!1,this._firstPoint=null,this._lastPoint=null,this._lastSegment=null,this.vMo&&(this.vMo.getNode().markAsReusable(!0),this.vMo=null)},C.prototype.init=function(e,s,n,r,a,l){var h,u=i.identity4Aux();for(r&&i.copyTranslation4(u,r.getVelocityMatrix()),a&&(u[12]+=n[4]*a,u[13]+=n[5]*a,u[14]+=n[6]*a),this._class=e,this.pMo.init(e._mass,s||i.IDENTITY4,n||i.IDENTITY4,i.scaling4Aux(e._modelScale),u,t.EMPTY_ARRAY,!1,!1,e._dragFactor),this._timeLeft=e._duration,this._timeLeftForIgnition=e._ignitionTime,this._origin=r,this._turningLimit=.2*e._angularAcceleration*o.ANGULAR_VELOCITY_MATRIX_DURATION_S,h=0;h<this._thrusters.length;h++)this._thrusters[h].destroy();this._thrusters.length=0,this._forward.thrusters.length=0,this._yawLeft.thrusters.length=0,this._yawRight.thrusters.length=0,this._pitchUp.thrusters.length=0,this._pitchDown.thrusters.length=0,this.addThrusters(e._thrusterSlots),this._homing=e._homingMode!==d.MissileHomingMode.NONE,this._burnForAngularVelocityChangeFactor=this._homing?1/o.ANGULAR_VELOCITY_MATRIX_DURATION_S*e._mass/e.getAngularThrust()*1e3:0,this._t=l||null,this._tHitPositionValid=!1,this._yawTorque=null,this._pitchTorque=null,this._mainBurn=!1,this._started=!1,this._stopHoming=!1,this._startSound=null},C.prototype.canBeReused=function(){return this._timeLeft<=0},C.prototype.createVisualModel=function(){this.vMo=new l.ParameterizedMesh},C.prototype._initVisualModel=function(t,e,i,s){var n=i?c.getManagedShader(i):this._class.getShader();this.vMo||this.createVisualModel(),this.vMo.init(this._class.getModel(),n,this._class.getTexturesOfTypes(n.getTextureTypes(),c.getTextureQualityPreferenceList()),this.pMo.pM,this.pMo.oM,this.pMo.sM,t,e,void 0,rt),this.vMo.hasParameterArray(ot)&&this.vMo.setParameterArray(ot,c.getGroupTransformIdentityArray()),c.areLuminosityTexturesAvailable()&&this.vMo.hasParameterArray(nt)&&this.vMo.setParameterArray(nt,this._class._defaultLuminosityFactors),s&&(this._trailEmitter=new M(this._class._trailDescriptor))},C.prototype.getTarget=function(){return this._t},C.prototype.getClass=function(){return this._class},C.prototype.addToSceneNow=function(t,i,s,n,o,r){var a;for(this._initVisualModel(i,s,n,o),t.addObject(this.vMo,!0),a=0;a<this._thrusters.length;a++)this._thrusters[a].addToScene(this.vMo.getNode(),!0);at&&this._class._lightColor&&(this._lightSource||(this._lightSource=new h.PointLightSource(this._class._lightColor,0,e.NULL3,[this.vMo])),t.addPointLightSource(this._lightSource,m.MISSILE_LIGHT_PRIORITY)),r&&r(this.vMo)},C.prototype.addToScene=function(t,e,i,s,n,o){r.executeWhenReady(this.addToSceneNow.bind(this,t,e,i,s,n,o))},C.prototype.addResourcesToScene=function(t,e,s,n,o){var a,l="missile/"+this._class._name;this._class.acquireResources({missileOnly:!1,sound:!0,trail:o}),r.executeWhenReady(function(){t.hasResourcesOfObject(l)||(this._initVisualModel(e,s,n,o),t.addResourcesOfObject(this.vMo,l),o&&this._trailEmitter.addResourcesToScene(t),a=new f.Explosion(this._class._explosionClass,i.IDENTITY4,i.IDENTITY4,[0,0,0],!0),a.addResourcesToScene(t),
a=new f.Explosion(this._class._shieldExplosionClass,i.IDENTITY4,i.IDENTITY4,[0,0,0],!0),a.addResourcesToScene(t))}.bind(this))},C.prototype.getThrusterUse=function(t){switch(t){case z.FORWARD:return this._forward;case z.YAW_LEFT:return this._yawLeft;case z.YAW_RIGHT:return this._yawRight;case z.PITCH_UP:return this._pitchUp;case z.PITCH_DOWN:return this._pitchDown;default:return s.showError("Invalid thruster use specified for missile: '"+t+"'!",s.ErrorSeverity.SEVERE),null}},C.prototype.addThrusters=function(t){var e,i,s,n;for(e=0;e<t.length;e++)for(s=new L(this._class.getPropulsionClass(),t[e]),this._thrusters.push(s),i=0;i<t[e].uses.length;i++)(n=this.getThrusterUse(t[e].uses[i]))&&n.thrusters.push(s)},C.prototype.getTurningMatrix=function(){return this._turningMatrixValid||(i.setProd3x3SubOf4(this._turningMatrix,i.prod3x3SubOf4Aux(this.pMo.oM,this.pMo.getAngularVelocityMatrix()),i.rotation4m4Aux(this.pMo.getRotationMatrixInverse())),this._turningMatrixValid=!0),this._turningMatrix},C.prototype.yawLeft=function(t){this._yawTarget=-t*this._turningLimit},C.prototype.yawRight=function(t){this._yawTarget=t*this._turningLimit},C.prototype.pitchDown=function(t){this._pitchTarget=-t*this._turningLimit},C.prototype.pitchUp=function(t){this._pitchTarget=t*this._turningLimit},C.prototype.resetThrusterBurn=function(){var t;for(this._forward.burn=0,this._yawLeft.burn=0,this._yawRight.burn=0,this._pitchUp.burn=0,this._pitchDown.burn=0,t=0;t<this._thrusters.length;t++)this._thrusters[t].resetBurn()},C.prototype.addThrusterBurnForward=function(t){E(this._forward,t)},C.prototype.addThrusterBurnYawLeft=function(t){E(this._yawLeft,t)},C.prototype.addThrusterBurnYawRight=function(t){E(this._yawRight,t)},C.prototype.addThrusterBurnPitchUp=function(t){E(this._pitchUp,t)},C.prototype.addThrusterBurnPitchDown=function(t){E(this._pitchDown,t)},C.prototype.getNeededBurnForAngularVelocityChange=function(t,e){return t*this._burnForAngularVelocityChangeFactor/e},C.prototype._controlTurnThrusters=function(t){var i,s,n,r=this.getTurningMatrix(),a=o.ANGULAR_VELOCITY_MATRIX_ERROR_THRESHOLD;i=Math.sign(r[4])*e.angle2y(r[4],r[5]),this._yawTarget-i>a?this.addThrusterBurnYawRight(Math.min(1,this.getNeededBurnForAngularVelocityChange(this._yawTarget-i,t))):this._yawTarget-i<-a?this.addThrusterBurnYawLeft(Math.min(1,this.getNeededBurnForAngularVelocityChange(i-this._yawTarget,t))):n=!0,s=Math.sign(r[6])*e.angle2x(r[5],r[6]),this._pitchTarget-s>a?this.addThrusterBurnPitchUp(Math.min(1,this.getNeededBurnForAngularVelocityChange(this._pitchTarget-s,t))):this._pitchTarget-s<-a?this.addThrusterBurnPitchDown(Math.min(1,this.getNeededBurnForAngularVelocityChange(s-this._pitchTarget,t))):n&&this._stopHoming&&(this._homing=!1),this._yawTarget=0,this._pitchTarget=0},C.prototype._applyTurnThrust=function(){var t,e;t=i.getRowC4(this.pMo.oM),e=i.getRowA4(this.pMo.oM),this._yawRight.burn>0?this._yawTorque=this.pMo.addOrRenewTorque(this._yawTorque,this._class.getAngularThrust()*this._yawRight.burn,t):this._yawLeft.burn>0&&(this._yawTorque=this.pMo.addOrRenewTorque(this._yawTorque,-this._class.getAngularThrust()*this._yawLeft.burn,t)),this._pitchUp.burn>0?this._pitchTorque=this.pMo.addOrRenewTorque(this._pitchTorque,-this._class.getAngularThrust()*this._pitchUp.burn,e):this._pitchDown.burn>0&&(this._pitchTorque=this.pMo.addOrRenewTorque(this._pitchTorque,this._class.getAngularThrust()*this._pitchDown.burn,e))},C.prototype._getTargetHitPosition=function(){var t,s,n,o;return this._tHitPositionValid||(s=this._t.getPhysicalPositionVector(),t=i.translationVector3(this.pMo.pM),n=e.diffTranslation3(this._t.getVelocityMatrix(),this.pMo.getVelocityMatrix()),o=this._class.getTargetHitTime(t,s,n),this._tHitPosition[0]=s[0]+o*n[0],this._tHitPosition[1]=s[1]+o*n[1],this._tHitPosition[2]=s[2]+o*n[2],this._tHitPositionValid=!0),this._tHitPosition},C.prototype._turn=function(t,i,s){var n,o,r,a,l;n=this.getTurningMatrix(),r=this._class._angularAcceleration,l=5e3/(r*s),o=Math.sign(n[4])*e.angle2y(n[4],n[5])*Q,a=Math.max(o*o/(2*r),q),t>a?this.yawLeft(Math.min(Math.max(0,l*(t-a)),1)):t<-a&&this.yawRight(Math.min(Math.max(0,l*(-t-a)),1)),o=Math.sign(n[6])*e.angle2x(n[5],n[6])*Q,a=Math.max(o*o/(2*r),q),i>a?this.pitchUp(Math.min(Math.max(0,l*(i-a)),1)):i<-a&&this.pitchDown(Math.min(Math.max(0,l*(-i-a)),1))},C.prototype._getSoundSourcePosition=function(){var t=this.vMo.getPositionMatrixInCameraSpace(this.vMo.getNode()._scene._camera);return this._soundSourcePosition[0]=.1*Math.round(10*t[12]),this._soundSourcePosition[1]=.1*Math.round(10*t[13]),this._soundSourcePosition[2]=.1*Math.round(10*t[14]),this._soundSourcePosition},C.prototype.getSoundSource=function(){return this._soundSource||(this._soundSource=_.createSoundSource([0,0,0])),this._soundSource},C.prototype._destruct=function(t,e,s,n,o,r){var a;this._t=null,a=f.getExplosion(),a.init(t,e,i.IDENTITY4,s,!0,!0,n),a.addToSceneNow(this.vMo.getNode()._scene._rootNode,o,r),this.vMo.markAsReusable(!0),this._startSound&&(this._startSound.stopPlaying(_.SOUND_RAMP_DURATION),this._startSound=null),this._trailEmitter&&this._trailEmitter.detach()},C.prototype._getHitOffset=function(t){return this._origin.isHostile(t)?this._class._proximityRange:0},C.prototype._hitCallback=function(t,s,n,o,r,a,l,h,u){s.applyForceAndTorque(r,l,h*this._class._kineticFactor*this.pMo._mass*1e3/tt,tt),this._destruct(t.getShieldIntegrity()>0?this._class._shieldExplosionClass:this._class._explosionClass,i.translation4vAux(o),e.scaled3(l,-1),s.getVelocityMatrix(),t.getSoundSource(),!0),t.damage(this._class.getDamage(0),n,e.scaled3(a,-1),this._origin,!0,u),this._timeLeft=0},C.prototype.simulate=function(t,s,n){var o,r,a,l,h,u,c;if(!this.canBeReused())if(u=Math.min(t,this._class._duration-this._timeLeft),this._timeLeft-=t,this._timeLeftForIgnition-=t,this._t&&this._homing&&!this._t._alive&&(this._t=null,this._timeLeftForIgnition<=0&&(this._timeLeft=0)),this._mainBurn=!1,this._timeLeft>0){if(this._timeLeftForIgnition<=0&&this._t)for(a=this.pMo.oM,this.resetThrusterBurn(),this._homing&&!this._stopHoming&&(l=e.getYawAndPitch(e.normalize3(e.prodVec3Mat4Aux(e.diff3(this._getTargetHitPosition(),i.translationVector3(this.pMo.pM)),i.inverseOfRotation4Aux(a)))),h=this._class._mainBurnAngleThreshold),(!this._homing||this._stopHoming||Math.abs(l.yaw)<h&&Math.abs(l.pitch)<h)&&(this.pMo.applyForce(this._class.getThrust(),a[4],a[5],a[6],t),this._mainBurn=!0,this.addThrusterBurnForward(1),this._started||(this._started=!0,this._class._homingMode===d.MissileHomingMode.INITIAL&&(this._stopHoming=!0),this._startSound=this._class.playStartSound(this.getSoundSource()))),this._homing&&(this._stopHoming||this._turn(l.yaw,l.pitch,t),this._controlTurnThrusters(t),this._applyTurnThrust()),o=0;o<this._thrusters.length;o++)this._thrusters[o].updateVisuals();this._started&&(r=this._getSoundSourcePosition(),this.getSoundSource().setPosition(r[0],r[1],r[2])),this._lightSource&&this._lightSource.setObjectIntensity(this._mainBurn?this._class._lightIntensity:0),this.pMo.simulate(t),this._turningMatrixValid=!1,this._tHitPositionValid=!1,this.vMo.setPositionMatrix(this.pMo.pM),this.vMo.setOrientationMatrix(this.pMo.oM),this._trailEmitter&&(this._mainBurn?(c=this.vMo.getPositionVector(),e.add3(c,e.prodVec3Mat3Aux(this._class.getEnginePosition(),i.prodScalingRotation3Aux(this.vMo.sM,this.vMo.oM))),this._trailEmitter._emitting?this._trailEmitter.addPoint(c,t):this._trailEmitter.startNew(this.vMo.getNode()._scene,c)):this._trailEmitter._emitting&&this._trailEmitter.detach()),u>0&&this._timeLeftForIgnition<=0&&I(this.pMo,s,u,this._origin,n,this._getHitOffset,this._hitCallback)}else this._timeLeft=0,this.vMo.canBeReused()||this._destruct(this._class._explosionClass,this.pMo.pM,e.scaled3(e.normalize3(i.translationVector3(this.pMo.getVelocityMatrix())),-1),this.pMo.getVelocityMatrix(),_.createSoundSource(i.translationVector3(this.vMo.getPositionMatrixInCameraSpace(this.vMo.getNode()._scene._camera))),!1)},C.prototype.updateThrusterVisuals=function(){var t;for(t=0;t<this._thrusters.length;t++)this._thrusters[t].updateVisuals()},C.prototype.destroy=function(){var t;for(this._timeLeft=0,this._class=null,this._origin=null,this._turningMatrix=null,this._t=null,this._tHitPosition=null,t=0;t<this._thrusters.length;t++)this._thrusters[t].destroy();this._thrusters=null,this._forward=null,this._yawLeft=null,this._yawRight=null,this._pitchUp=null,this._pitchDown=null,this._yawTorque=null,this._pitchTorque=null,this.vMo&&this.vMo.getNode()&&this.vMo.getNode().markAsReusable(!0),this.vMo=null,this._trailEmitter&&(this._trailEmitter.destroy(),this._trailEmitter=null),this.pMo=null,this._startSound&&(this._startSound.stopPlaying(_.SOUND_RAMP_DURATION),this._startSound=null),this._soundSource=null,this._soundSourcePosition=null,this._lightSource=null,this._hitCallback=null,this._getHitOffset=null},N.prototype.getDisplayName=function(){return this._class.getDisplayName()},N.prototype.getProjectileClass=function(){return this._class.getProjectileClass()},N.prototype.getProjectileVelocity=function(){return this._class.getProjectileVelocity()},N.prototype.getDamage=function(t){return this._class.getDamage(t)},N.prototype.getFirepower=function(t){return this._class.getFirepower(t)},N.prototype.getFireRate=function(){return this._class.getFireRate()},N.prototype.getRange=function(t){return(this._class.getProjectileVelocity()+(t||0))*this._class.getProjectileClass()._duration/1e3},N.prototype.getCooldown=function(){return this._class.getCooldown()},N.prototype.getOrigoPositionMatrix=function(){return this._origoPositionMatrix=this._origoPositionMatrix||i.translatedByVector(this._slot?this._slot.positionMatrix:i.IDENTITY4,e.prodVec3Mat4Aux(e.scaled3(this._class._attachmentPoint,-1),i.prodScalingRotationAux(i.scaling4(this._class.getModel()._scale/(this._sc?this._sc.pMo.sM[0]:1)),this._slot?this._slot.orientationMatrix:i.IDENTITY4))),this._origoPositionMatrix},N.prototype.getScaledOriMatrix=function(){return this._scaledOriMatrix=this._scaledOriMatrix||i.prodScalingRotation(this.vMo.sM,this._slot.orientationMatrix),this._scaledOriMatrix},N.prototype.getBasePointPosVector=function(t){var s,n=e.prodVec3Mat4Aux(i.translationVector3(this.getOrigoPositionMatrix()),t);return e.add3(n,this._sc.getPhysicalPositionVector()),s=e.prodVec4Mat4(this._class._basePoint,this._transformMatrix),e.mulVec3Mat4(s,i.prod3x3SubOf4Aux(this.getScaledOriMatrix(),t)),e.add3(s,n),s},N.prototype.getProjectileOrientationMatrix=function(){return i.setProd3x3SubOf4(N._pOriMatrix,this._slot.orientationMatrix,this._sc.pMo.oM),this._fixed||i.setProd3x3SubOf4(N._pOriMatrix,this._transformMatrix,i.matrix4Aux(N._pOriMatrix)),N._pOriMatrix},N.prototype.acquireResources=function(t){this._class.acquireResources(t)},N.prototype.addToSceneNow=function(t,e,s,n,o){var r,a,h;h=n.shaderName?c.getManagedShader(n.shaderName):this._class.getShader(),a=this._class.getModel()._scale/t._renderableObject.sM[0],r=new l.ParameterizedMesh(this._class.getModel(),h,this._class.getTexturesOfTypes(h.getTextureTypes(),c.getTextureQualityPreferenceList()),this._slot?this.getOrigoPositionMatrix():i.identity4(),n.orientationMatrix||(this._slot?this._slot.orientationMatrix:i.identity4()),i.scaling4(a),!0===s,e,void 0,rt),t.addSubnode(new u.RenderableNode(r)),r.hasParameterArray(ot)&&r.setParameterArray(ot,c.getGroupTransformIdentityArray()),c.areLuminosityTexturesAvailable()&&r.hasParameterArray(nt)&&r.setParameterArray(nt,this._class._defaultLuminosityFactors),this.vMo||(this.vMo=r),o&&o(r)},N.prototype.addToScene=function(t,e,i,s,n){s.skipResources||(this.acquireResources({omitShader:!!s.shaderName,projectileResources:s.projectileResources,sound:s.sound}),s.shaderName&&c.getShader(s.shaderName)),r.executeWhenReady(this.addToSceneNow.bind(this,t,e,i,s,n))},N.prototype._getMuzzleFlashForBarrel=function(t,e){var s=this._class.getBarrel(t).getProjectileClass(),n=i.translation4vAux(e),o=G.getObject();return l.initDynamicParticle(o,s._muzzleFlash.getModel(),s._muzzleFlash.getShader(),s._muzzleFlash.getTexturesOfTypes(s._muzzleFlash.getShader().getTextureTypes(),c.getTextureQualityPreferenceList()),s._muzzleFlash._color,s._muzzleFlash.getSize(),n,s._muzzleFlash._duration||g.getSetting(g.BS.DEFAULT_MUZZLE_FLASH_DURATION),s._muzzleFlash.getInstancedShader()),o},N.prototype.getResourceAdderFunction=function(t,e,i){return function(){var s;t.hasResourcesOfObject(i)||(s=this._getMuzzleFlashForBarrel(e,[0,0,0]),t.addResourcesOfObject(s))}.bind(this)},N.prototype.addProjectileResourcesToScene=function(t){var e,i,s,n="weapon/"+this._class._name;for(s=this._class._barrels,e=0;e<s.length;e++)i=new A(s[e].getProjectileClass()),i.addResourcesToScene(t),r.executeWhenReady(this.getResourceAdderFunction(t,e,n).bind(this));r.executeWhenReady(function(){t.addResourcesOfObject(null,n)})},N.prototype.simulate=function(t){var s,n;if(this._cooldown=Math.max(this._cooldown-t,0),this._rotationChanged){for(i.setIdentity4(this._transformMatrix),n=this._class._rotators,s=0;s<n.length;s++)i.rotateAroundPoint4(this._transformMatrix,e.prodVec3Mat4Aux(n[s].center,this._transformMatrix),e.prodVec3Mat4Aux(n[s].axis,this._transformMatrix),this._rotationAngles[s]),this.vMo.setMat4Parameter(ot,n[s].transformGroupIndex,this._transformMatrix);this._rotationChanged=!1}},N._wSlotPosMatrix=i.identity4(),N._pPosMatrix=i.identity4(),N._pOriMatrix=i.identity4(),N.prototype.fire=function(t,s,n){var o,r,a,l,c,_,d,p,g,f,S,T,E,y=this.vMo.getNode()._scene;if(s&&this._lastAimStatus!==Y.FIXED&&this._lastAimStatus!==Y.AIMED_IN_RANGE)return 0;if(this._cooldown<=0){for(this._cooldown=this._class.getCooldown(),l=e.prodVec3Mat4Aux(i.translationVector3(this.getOrigoPositionMatrix()),t),i.setTranslatedByVector(N._wSlotPosMatrix,this._sc.pMo.pM,l),c=this.getProjectileOrientationMatrix(),g=this._class._barrels,at&&(f={}),a=0,o=0;o<g.length;o++)_=g[o].getProjectileClass(),d=g[o].getPositionVector(),this._fixed||(d=e.prodVec4Mat4(d,this._transformMatrix)),p=this._getMuzzleFlashForBarrel(o,d),d=e.prodVec3Mat4(d,i.prod3x3SubOf4Aux(this.getScaledOriMatrix(),t)),i.setTranslatedByVector(N._pPosMatrix,N._wSlotPosMatrix,d),this.vMo.getNode().addSubnode(p.getNode()||new u.RenderableNode(p,!1,!1,et)),r=j.getObject(),r.init(_,N._pPosMatrix,c,this._sc,g[o].getProjectileVelocity()),r.addToSceneNow(y),at&&_._lightColor&&(f[_._name]?f[_._name].addEmittingObject(r.vMo):(E=new h.PointLightSource(_._lightColor,_._lightIntensity,e.NULL3,[r.vMo]),f[_._name]=E,r.setLightSource(E))),this._sc.pMo.applyForceAndTorque(e.diffTranslation3(N._pPosMatrix,this._sc.pMo.pM),i.getRowB43Neg(c),g[o].getForceForDuration(tt),tt),a++;if(at)for(S in f)f.hasOwnProperty(S)&&y.addPointLightSource(f[S],m.PROJECTILE_LIGHT_PRIORITY);return n||(T=i.translationVector3(r.vMo.getPositionMatrixInCameraSpace(y._camera))),this._class.playFireSound(T,n,B,H),a}return 0},N.prototype.setRotation=function(e,i){this._fixed||(this._rotationAngles[0]=e*t.RAD,this._rotationAngles[1]=i*t.RAD,this._rotationChanged=!0)},N.prototype.rotateTo=function(e,i,s,n,o){var r,a,l,h;if(!this._fixed)for(this._lastAimStatus=Y.AIMED_IN_RANGE,a=this._class._rotators,l=0;l<a.length;l++){switch(l){case 0:r=e-this._rotationAngles[0],this._class._rotationStyle===d.WeaponRotationStyle.ROLL_YAW&&Math.abs(r-Math.sign(r)*Math.PI)<Math.abs(r)&&(r-=Math.sign(r)*Math.PI,i=-i);break;case 1:r=i-this._rotationAngles[1]}a[l].restricted||(r>Math.PI?r-=t.DOUBLE_PI:r<-Math.PI&&(r+=t.DOUBLE_PI)),h=0,Math.abs(r)>s&&(h=a[l].rotationRate*o/1e3,r>0?this._rotationAngles[l]+=Math.min(h,r):this._rotationAngles[l]-=Math.min(h,-r),this._rotationChanged=!0,Math.abs(r)-h>n&&(this._lastAimStatus=Y.AIMING)),a[l].restricted?(this._rotationAngles[l]>a[l].range[1]&&(this._rotationAngles[l]=a[l].range[1],Math.abs(r)-h>n&&(this._lastAimStatus=Y.AIMING_OUT_OF_REACH)),this._rotationAngles[l]<a[l].range[0]&&(this._rotationAngles[l]=a[l].range[0],Math.abs(r)-h>n&&(this._lastAimStatus=Y.AIMING_OUT_OF_REACH))):(this._rotationAngles[l]>Math.PI&&(this._rotationAngles[l]-=t.DOUBLE_PI),this._rotationAngles[l]<-Math.PI&&(this._rotationAngles[l]+=t.DOUBLE_PI))}},N.prototype.aimTowards=function(t,i,s,n,o){var r,a,l,h,u;if(!this._fixed){switch(r=this.getBasePointPosVector(n),a=e.diff3(t,r),a=e.prodMat4Vec3(this._sc.pMo.oM,a),a=e.prodMat4Vec3(this._slot.orientationMatrix,a),u=e.extractLength3(a)<=this.getRange(),this._class._rotationStyle){case d.WeaponRotationStyle.YAW_PITCH:l=e.getYawAndPitch(a),this.rotateTo(-l.yaw,-l.pitch,i,s,o);break;case d.WeaponRotationStyle.ROLL_YAW:h=e.getRollAndYaw(a),this.rotateTo(h.roll,h.yaw,i,s,o)}u||this._lastAimStatus!==Y.AIMED_IN_RANGE||(this._lastAimStatus=Y.AIMED_OUT_OF_RANGE)}},N.prototype.rotateToDefaultPosition=function(t,e){var i;this._fixed||(i=this._class._rotators,this.rotateTo(i[0].defaultAngle,i[1].defaultAngle,t,0,e),this._lastAimStatus=Y.NO_TARGET)},N.prototype.getScoreValue=function(){return this._class.getScoreValue()},N.prototype.getMaxProjectileCount=function(){return this._class.getMaxProjectileCount()},N.prototype.getMaxExplosionCount=function(){return this._class.getMaxExplosionCount()},N.prototype.getMaxParticleCount=function(){return this._class.getMaxParticleCount()},N.prototype.destroy=function(){this._class=null,this._sc=null,this._slot=null,this.vMo&&this.vMo.markAsReusable(!0),this.vMo=null},O.prototype.getDisplayName=function(){return this._class.getDisplayName()},O.prototype.getDamage=function(t){return this._class.getDamage(t)},O.prototype.getFirepower=function(t){return this._mCount*this._class.getDamage(t)},O.prototype.getNominalRange=function(){return this._class.getNominalRange()},O.prototype.getFireRate=function(){return this._class.getFireRate()},O.prototype.getLockingTime=function(){return this._class.getLockingTime()},O.prototype.getCooldown=function(){return this._class.getCooldown()},O.prototype.getLoadRatio=function(){return this._mCount>this._salvoLeft?this._salvo?1-(this._salvoLeft+this._cooldown/this._class.getCooldown())/this._descriptor.salvo:1-this._cooldown/this._class.getCooldown():0},O.prototype.setSalvoMode=function(t){this._salvo=t&&this._descriptor.salvo>1},O.prototype.toggleSalvoMode=function(){return this._descriptor.salvo>1&&(this._salvo=!this._salvo,!0)},O.prototype.getSalvo=function(){return this._descriptor.salvo},O.prototype.setMinimumCooldown=function(t){this._cooldown<t&&(this._cooldown=t)},O.prototype.getMissileOrientationMatrix=function(){return i.setProd3x3SubOf4(O._mOriMatrix,this._descriptor.orientationMatrix,this._sc.pMo.oM),O._mOriMatrix},O.prototype.acquireResources=function(t){this._class.acquireResources(t)},O.prototype.addMissileResourcesToScene=function(t){var e,i="missileLauncher/"+this._class._name;e=new C(this._class),e.addResourcesToScene(t,!1,void 0,void 0,!0),r.executeWhenReady(function(){t.addResourcesOfObject(null,i)})},O.prototype.addToSceneNow=function(t,s,n,o,r){var a,h,_,d,p,g,m,f=!1;for(h=this._class.getModel()._scale/t._renderableObject.sM[0],_=o.shaderName?c.getManagedShader(o.shaderName):this._class.getShader(),d=this._class.getTexturesOfTypes(_.getTextureTypes(),c.getTextureQualityPreferenceList()),this.vMos||(this.vMos=[],f=!0),p=0;p<this._descriptor.tubePositions.length;p++)for(m=o.allMissiles?Math.floor(this._mCount/this._descriptor.tubePositions.length)+(this._mCount%this._descriptor.tubePositions.length>p?1:0):1,g=0;g<m;g++)a=new l.ParameterizedMesh(this._class.getModel(),_,d,i.translation4v(e.sum3(this._descriptor.tubePositions[p],[0,-g*h*this._class._length,0])),i.identity4(),i.scaling4(h),!0===n,s,void 0,rt),t.addSubnode(new u.RenderableNode(a)),a.hasParameterArray(ot)&&a.setParameterArray(ot,c.getGroupTransformIdentityArray()),c.areLuminosityTexturesAvailable()&&a.hasParameterArray(nt)&&a.setParameterArray(nt,this._class._defaultLuminosityFactors),f&&this.vMos.push(a),r&&r(a)},O.prototype.simulate=function(t){if(this._cooldown=Math.max(this._cooldown-t,0),this._salvoLeft>0&&this._cooldown<=0&&(this._mCount>0&&this._salvoTarget&&this._salvoTarget._alive?this.launch(this._sc.getScaledOriMatrix(),this._sc.getSoundSourceForFireSound(),!0)&&this._sc.handleSalvoMissileLaunched():(this._salvoLeft=0,this._salvoTarget=null)),null!==this.vMos)for(;this.vMos.length>this._mCount;)this.vMos.shift().markAsReusable(!0)},O._tubePosMatrix=i.identity4(),O._mOriMatrix=i.identity4(),O.prototype.launch=function(t,s,n){var o,r,a,l,h=this._sc.vMo.getNode()._scene;return this._mCount>0&&this._cooldown<=0&&(n||this._salvoLeft<=0)?(n||(this._salvo&&this._sc.getTarget()?(this._salvoLeft=this._descriptor.salvo,this._salvoTarget=this._sc.getTarget()):this._salvoLeft=1),this._mCount--,this._salvoLeft--,this._cooldown=this._salvoLeft>0?this._class._salvoCooldown:this._class.getCooldown(),r=e.prodVec3Mat4Aux(this._descriptor.tubePositions[this._activeTubeIndex],t),i.setTranslatedByVector(O._tubePosMatrix,this._sc.pMo.pM,r),a=this.getMissileOrientationMatrix(),o=k.getObject(),o.init(this._class,O._tubePosMatrix,a,this._sc,this._class._launchVelocity,n?this._salvoTarget:this._sc.getTarget()),o.addToSceneNow(h,!1,void 0,void 0,!0),this._sc.pMo.applyForceAndTorque(r,i.getRowB43Neg(a),this._class.getForceForDuration(tt),tt),s||(l=i.translationVector3(o.vMo.getPositionMatrixInCameraSpace(h._camera))),this._class.playLaunchSound(l,s,B,H),this._activeTubeIndex=(this._activeTubeIndex+1)%this._descriptor.tubePositions.length,o):null},O.prototype.isReady=function(){return this._cooldown<=0&&this._salvoLeft<=0},O.prototype.isInLockingRange=function(t){var s,n,o,r,a,l,h,u,c,_,p;if(a=this._sc.pMo.oM,c=e.sum3(i.translationVector3(this._sc.getVelocityMatrix()),e.scaled3Aux(i.getRowB43(a),this._class._launchVelocity)),_=e.diff3(i.translationVector3(t.getVelocityMatrix()),c),s=.001*this._class._ignitionTime,o=this._sc.getPhysicalPositionVector(),r=e.sum3(t.getPhysicalPositionVector(),e.scaled3Aux(_,s)),this._class._homingMode===d.MissileHomingMode.NONE)u=0;else{if(l=e.getYawAndPitch(e.normalize3(e.prodVec3Mat4Aux(e.diff3(r,o),i.inverseOfRotation4Aux(a)))),l.yaw=Math.abs(l.yaw),l.pitch=Math.abs(l.pitch),this._class._lockingAngle>0&&Math.max(l.yaw,l.pitch)>this._class._lockingAngle)return!1;h=Math.max(0,Math.max(l.yaw,l.pitch)-this._class._mainBurnAngleThreshold),p=this._class._angularAcceleration,u=(.2*p*.2+h)/(.2*p),u<.4&&(u=Math.sqrt(4*h/p)),r=e.sum3(r,e.scaled3Aux(_,u))}return n=.001*this._class._duration-s-u,this._class.getTargetHitTime(o,r,_)<n},O.prototype.getScoreValue=function(){return this._class.getScoreValue()*this._mCount},O.prototype.getMissileCount=function(){return this._mCount},O.prototype.hasMissilesLeftToLaunch=function(){return this._mCount>this._salvoLeft},O.prototype.getMaxMissileCount=function(){return Math.min(this._mCount,this._class.getMaxCount())},O.prototype.getMaxExplosionCount=function(){return this.getMaxMissileCount()},O.prototype.getMaxParticleCount=function(){return this.getMaxMissileCount()*this._class.getParticleCount()},O.prototype.destroy=function(){var t;if(this._class=null,this._sc=null,this._descriptor=null,this._salvoTarget=null,null!==this.vMos){for(t=0;t<this.vMos.length;t++)this.vMos[t].markAsReusable(!0);this.vMos=null}},R.prototype._resetMissileLock=function(){this._lockTime=this._t&&this._mL?this._t.getLockingTimeFactor()*this._lockingTimeFactor*this._mL.getLockingTime():1,this._lockTimeLeft=this._lockTime},R.prototype.isMissileLocked=function(){return this._lockTimeLeft<=0},R.prototype.getMissileLockRatio=function(){return 1-this._lockTimeLeft/this._lockTime},R.prototype.setMissileLauncher=function(t){this._mL&&t&&t._class===this._mL._class?this._mL=t:(this._mL=t,this._resetMissileLock())},R.prototype.setTarget=function(t){var e,i,s,n;if(t!==this._t){if(this._t&&this._t.setBeingUntargeted(this._sc),this._t=t,this._tHitPosition=null,this._sc.vMo)for(s=this._sc.vMo.getNode(),n=s._scene._camera,i=s.getCameraConfigurationsWithName(g.getSetting(g.BS.TARGET_VIEW_NAME)),e=0;e<i.length;e++)n.getConfiguration()===i[e]&&n.transitionToSameConfiguration(g.getSetting(g.BS.TARGET_CHANGE_TRANSITION_DURATION),g.getSetting(g.BS.TARGET_CHANGE_TRANSITION_STYLE)),i[e].setOrientationFollowedObjects(this._t?[this._t.vMo]:[],!0);this._t&&this._t.setBeingTargeted(this._sc),this._resetMissileLock()}},R.prototype._filterHostileTarget=function(t){return this._sc.isHostile(t)},R.prototype._filterNonHostileTarget=function(t){return t!==this._sc&&!this._sc.isHostile(t)},R.prototype._mapTargetByBearing=function(t,s){return{index:s,value:e.angle3u(i.getRowB43(this._sc.pMo.oM),e.normalize3(e.diff3(t.getPhysicalPositionVector(),this._sc.getPhysicalPositionVector())))}},R.prototype._mapTargetToCombinedValue=function(t,s){var n=e.diffTranslation3(t.pMo.pM,this._sc.pMo.pM);return{index:s,value:(e.extractLength3(n)+200*e.angle3u(i.getRowB43(this._sc.pMo.oM),n))*(this._sc.isGoodAgainst(t)?.5:this._sc.isBadAgainst(t)?2:1)}},R._compareMappedTargets=function(t,e){return t.value-e.value},R.prototype._updateHostileOrder=function(t){var e,i,s;if(this._scArray){if(e=this._scArray.filter(this._filterHostileTarget,this),this._timeUntilHostileOrderReset<=0){for(i=e.map(t,this).sort(R._compareMappedTargets),this._orderedHostileTargets=[],s=0;s<i.length;s++)this._orderedHostileTargets.push(e[i[s].index]);return!0}for(s=0;s<e.length;s++)this._orderedHostileTargets.indexOf(e[s])<0&&this._orderedHostileTargets.push(e[s])}return!1},R.prototype._updateNonHostileOrder=function(){var t,e,i;if(this._scArray){if(t=this._scArray.filter(this._filterNonHostileTarget,this),this._timeUntilNonHostileOrderReset<=0){for(e=t.map(this._mapTargetByBearing,this).sort(R._compareMappedTargets),this._orderedNonHostileTargets=[],i=0;i<e.length;i++)this._orderedNonHostileTargets.push(t[e[i].index]);return!0}for(i=0;i<t.length;i++)this._orderedNonHostileTargets.indexOf(t[i])<0&&this._orderedNonHostileTargets.push(t[i])}return!1},R.prototype._isValidNewTarget=function(t){return t._alive&&!t._away&&t!==this._t},R.prototype._tNextHostile=function(t){var e,i,s,n=this._updateHostileOrder(t);if(this._orderedHostileTargets&&this._orderedHostileTargets.length>0){for(s=this._orderedHostileTargets.length,e=n?0:(this._orderedHostileTargets.indexOf(this._t)+1)%s,i=0;i<s&&!this._isValidNewTarget(this._orderedHostileTargets[e]);)e=(e+1)%s,i++;if(i<s)return this.setTarget(this._orderedHostileTargets[e]),this._timeUntilHostileOrderReset=g.getSetting(g.BS.TARGET_ORDER_DURATION),!0}return this._timeUntilHostileOrderReset=0,!1},R.prototype._tPreviousHostile=function(t){var e,i,s,n=this._updateHostileOrder(t);if(this._orderedHostileTargets&&this._orderedHostileTargets.length>0){for(s=this._orderedHostileTargets.length,e=n?s-1:(this._orderedHostileTargets.indexOf(this._t)+s-1)%s,i=0;i<s&&!this._isValidNewTarget(this._orderedHostileTargets[e]);)e=(e+s-1)%s,i++;if(i<s)return this.setTarget(this._orderedHostileTargets[e]),this._timeUntilHostileOrderReset=g.getSetting(g.BS.TARGET_ORDER_DURATION),!0}return this._timeUntilHostileOrderReset=0,!1},R.prototype.targetNextNearestHostile=function(){return this._tNextHostile(this._mapTargetByBearing)},R.prototype.targetPreviousNearestHostile=function(){return this._tPreviousHostile(this._mapTargetByBearing)},R.prototype.targetNextBestHostile=function(){return this._tNextHostile(this._mapTargetToCombinedValue)},R.prototype.targetNextNearestNonHostile=function(){var t,e,i,s=this._updateNonHostileOrder();if(this._orderedNonHostileTargets&&this._orderedNonHostileTargets.length>0){for(i=this._orderedNonHostileTargets.length,t=s?0:(this._orderedNonHostileTargets.indexOf(this._t)+1)%i,e=0;e<i&&!this._isValidNewTarget(this._orderedNonHostileTargets[t]);)t=(t+1)%i,e++;if(e<i)return this.setTarget(this._orderedNonHostileTargets[t]),this._timeUntilNonHostileOrderReset=g.getSetting(g.BS.TARGET_ORDER_DURATION),!0}return this._timeUntilNonHostileOrderReset=0,!1},R.prototype.getTarget=function(){return this._t&&(this._t.canBeReused()||this._t._away)&&this.setTarget(null),this._t},R.prototype.getTargetHitPosition=function(){var i,s,n,o,r,a,l,h,u,c;if(!this._tHitPosition){if(s=this._t.getPhysicalPositionVector(),o=this._sc._ws,0===o.length)return s;for(i=this._sc.getPhysicalPositionVector(),n=e.diffTranslation3(this._t.getVelocityMatrix(),this._sc.getVelocityMatrix()),r=o[0].getProjectileVelocity(),a=r*r-(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]),l=0,u=0;u<3;u++)l+=2*n[u]*(i[u]-s[u]);for(h=0,u=0;u<3;u++)h+=-s[u]*s[u]-i[u]*i[u]+2*s[u]*i[u];c=t.getGreaterSolutionOfQuadraticEquation(a,l,h),this._tHitPosition=[s[0]+c*n[0],s[1]+c*n[1],s[2]+c*n[2]]}return this._tHitPosition},R.prototype.simulate=function(t){this._t&&(this._t.canBeReused()||this._t._away)&&this.setTarget(null),this._tHitPosition=null,this._timeUntilHostileOrderReset>0&&(this._timeUntilHostileOrderReset-=t),this._timeUntilNonHostileOrderReset>0&&(this._timeUntilNonHostileOrderReset-=t),this._t&&this._mL&&this._mL.hasMissilesLeftToLaunch()&&this._mL.isInLockingRange(this._t)?this._lockTimeLeft=Math.max(0,this._lockTimeLeft-t):this._resetMissileLock()},R.prototype.destroy=function(){this._sc=null,this._scArray=null,this._t=null,this._tHitPosition=null,this._orderedHostileTargets=null,this._orderedNonHostileTargets=null,this._mL=null},L.PROPULSION_RESOURCE_PARAMS={sound:!0},L.prototype.addToScene=function(t,e){var s;this._propulsionClass.acquireResources(L.PROPULSION_RESOURCE_PARAMS),r.executeWhenReady(function(){
s=l.staticParticle(this._propulsionClass._thrusterBurnParticle.getModel(),this._propulsionClass._thrusterBurnParticle.getShader(),this._propulsionClass._thrusterBurnParticle.getTexturesOfTypes(this._propulsionClass._thrusterBurnParticle.getShader().getTextureTypes(),c.getTextureQualityPreferenceList()),this._propulsionClass._thrusterBurnParticle._color,this._slot.size,i.translation4v(this._slot.positionVector),this._propulsionClass._thrusterBurnParticle.getInstancedShader()),s.setRelativeSize(0),t.addSubnode(new u.RenderableNode(s,!1,!1,g.getSetting(g.BS.MINIMUM_THRUSTER_PARTICLE_COUNT_FOR_INSTANCING))),this.vMo&&!e||(this.vMo&&this.vMo.markAsReusable(!0),this.vMo=s,this._shipModel=t._renderableObject)}.bind(this))},L.prototype.updateVisuals=function(){this.vMo.setRelativeSize(this._burnLevel),c.areLuminosityTexturesAvailable()&&this._shipModel.setFloatParameter(nt,this._slot.group,Math.min(1,this._burnLevel/this._maxMoveBurnLevel))},L.prototype.resetBurn=function(){this._burnLevel=0},L.prototype.addBurn=function(t){this._burnLevel+=t},L.prototype.destroy=function(){this._propulsionClass=null,this._slot=null,this.vMo&&this.vMo.markAsReusable(!0),this.vMo=null,this._shipModel=null},x.prototype.resetForcesAndTorques=function(){this._yawTorque=null,this._pitchTorque=null,this._rollTorque=null},x.prototype.acquireResources=function(t){this._class.acquireResources(t)},x.prototype.getDisplayName=function(){return this._class.getDisplayName()},x.prototype.getThrust=function(){return this._class.getThrust()},x.prototype.getAngularThrust=function(){return this._class.getAngularThrust()},x.prototype.getMaxMoveBurnLevel=function(){return this._class.getMaxMoveBurnLevel()},x.prototype.getMaxTurnBurnLevel=function(){return this._class.getMaxTurnBurnLevel()},x.prototype.getThrusterUse=function(t){switch(t){case z.FORWARD:return this._forward;case z.REVERSE:return this._reverse;case z.STRAFE_LEFT:return this._strafeLeft;case z.STRAFE_RIGHT:return this._strafeRight;case z.RAISE:return this._raise;case z.LOWER:return this._lower;case z.YAW_LEFT:return this._yawLeft;case z.YAW_RIGHT:return this._yawRight;case z.PITCH_UP:return this._pitchUp;case z.PITCH_DOWN:return this._pitchDown;case z.ROLL_LEFT:return this._rollLeft;case z.ROLL_RIGHT:return this._rollRight;default:return s.showError("Invalid thruster use specified: '"+t+"'!",s.ErrorSeverity.SEVERE),null}},x.prototype.addThrusters=function(t){var e,i,s,n;for(e=0;e<t.length;e++)for(s=new L(this._class,t[e]),this._thrusters.push(s),i=0;i<t[e].uses.length;i++)(n=this.getThrusterUse(t[e].uses[i]))&&n.thrusters.push(s)},x.prototype.addToScene=function(t){var e;for(e=0;e<this._thrusters.length;e++)this._thrusters[e].addToScene(t,!1)},x.prototype.addThrusterBurn=function(t,e){E(this.getThrusterUse(t),e)},x.prototype.addThrusterBurnForward=function(t){E(this._forward,t)},x.prototype.addThrusterBurnReverse=function(t){E(this._reverse,t)},x.prototype.addThrusterBurnLeft=function(t){E(this._strafeLeft,t)},x.prototype.addThrusterBurnRight=function(t){E(this._strafeRight,t)},x.prototype.addThrusterBurnUp=function(t){E(this._raise,t)},x.prototype.addThrusterBurnDown=function(t){E(this._lower,t)},x.prototype.addThrusterBurnYawLeft=function(t){E(this._yawLeft,t)},x.prototype.addThrusterBurnYawRight=function(t){E(this._yawRight,t)},x.prototype.addThrusterBurnPitchUp=function(t){E(this._pitchUp,t)},x.prototype.addThrusterBurnPitchDown=function(t){E(this._pitchDown,t)},x.prototype.addThrusterBurnRollLeft=function(t){E(this._rollLeft,t)},x.prototype.addThrusterBurnRollRight=function(t){E(this._rollRight,t)},x.prototype.resetThrusterBurn=function(){var t;for(this._forward.burn=0,this._reverse.burn=0,this._strafeLeft.burn=0,this._strafeRight.burn=0,this._raise.burn=0,this._lower.burn=0,this._yawLeft.burn=0,this._yawRight.burn=0,this._pitchUp.burn=0,this._pitchDown.burn=0,this._rollLeft.burn=0,this._rollRight.burn=0,t=0;t<this._thrusters.length;t++)this._thrusters[t].resetBurn()},x.prototype.updateVisuals=function(){var t;for(t=0;t<this._thrusters.length;t++)this._thrusters[t].updateVisuals()},x.prototype._getSoundVolume=function(){var t,e,i;return i=this._class.getMaxMoveBurnLevel(),t=i?Math.max(this._forward.burn,this._reverse.burn,this._strafeRight.burn,this._strafeLeft.burn,this._raise.burn,this._lower.burn)/i:0,i=this._class.getMaxTurnBurnLevel(),e=i?Math.max(this._yawRight.burn,this._yawLeft.burn,this._pitchUp.burn,this._pitchDown.burn,this._rollRight.burn,this._rollLeft.burn)/i:0,i=Math.round(3*(t+e))/3},x.prototype.simulate=function(t,e,s){var n,o,r;!1!==s&&(n=i.getRowB4(this._drivenPhysicalObject.oM),o=i.getRowC4(this._drivenPhysicalObject.oM),r=i.getRowA4(this._drivenPhysicalObject.oM),this._forward.burn>0?this._drivenPhysicalObject.applyForce(this._thrustFactor*this._forward.burn,n[0],n[1],n[2],t):this._reverse.burn>0&&this._drivenPhysicalObject.applyForce(-this._thrustFactor*this._reverse.burn,n[0],n[1],n[2],t),this._strafeRight.burn>0?this._drivenPhysicalObject.applyForce(this._thrustFactor*this._strafeRight.burn,r[0],r[1],r[2],t):this._strafeLeft.burn>0&&this._drivenPhysicalObject.applyForce(-this._thrustFactor*this._strafeLeft.burn,r[0],r[1],r[2],t),this._raise.burn>0?this._drivenPhysicalObject.applyForce(this._thrustFactor*this._raise.burn,o[0],o[1],o[2],t):this._lower.burn>0&&this._drivenPhysicalObject.applyForce(-this._thrustFactor*this._lower.burn,o[0],o[1],o[2],t),this._yawRight.burn>0?this._yawTorque=this._drivenPhysicalObject.addOrRenewTorque(this._yawTorque,this._angularThrustFactor*this._yawRight.burn,o):this._yawLeft.burn>0&&(this._yawTorque=this._drivenPhysicalObject.addOrRenewTorque(this._yawTorque,-this._angularThrustFactor*this._yawLeft.burn,o)),this._pitchUp.burn>0?this._pitchTorque=this._drivenPhysicalObject.addOrRenewTorque(this._pitchTorque,-this._angularThrustFactor*this._pitchUp.burn,r):this._pitchDown.burn>0&&(this._pitchTorque=this._drivenPhysicalObject.addOrRenewTorque(this._pitchTorque,this._angularThrustFactor*this._pitchDown.burn,r)),this._rollRight.burn>0?this._rollTorque=this._drivenPhysicalObject.addOrRenewTorque(this._rollTorque,-this._angularThrustFactor*this._rollRight.burn,n):this._rollLeft.burn>0&&(this._rollTorque=this._drivenPhysicalObject.addOrRenewTorque(this._rollTorque,this._angularThrustFactor*this._rollLeft.burn,n))),this._thrusterSoundClip||(this._thrusterSoundClip=this._class.createThrusterSoundClip(e),this._thrusterSoundClip&&(this._thrusterSoundClip.setVolume(0),this._thrusterSoundClip.play())),this._thrusterSoundClip&&this._thrusterSoundClip.rampVolume(this._getSoundVolume()*this._class.getThrusterSoundVolume(),.02,!0,!0)},x.prototype.getScoreValue=function(){return this._class.getScoreValue()},x.prototype.destroy=function(){this._class=null,this._drivenPhysicalObject=null,this._thrusters=null,this._forward=null,this._reverse=null,this._strafeLeft=null,this._strafeRight=null,this._raise=null,this._lower=null,this._yawLeft=null,this._yawRight=null,this._pitchUp=null,this._pitchDown=null,this._rollLeft=null,this._rollRight=null,this._thrusterSoundClip&&(this._thrusterSoundClip.stopPlaying(_.SOUND_RAMP_DURATION),setTimeout(function(){this._thrusterSoundClip.destroy(),this._thrusterSoundClip=null}.bind(this),_.SOUND_RAMP_DURATION))},v.prototype.prepareForControl=function(){this._speedThrottled=!1},v.prototype.updateSpeedIncrementPerSecond=function(){this._speedIncrementPerSecond=this._sc.getMaxAcceleration()||0},v.prototype.updateSpeedIncrement=function(t){this._speedIncrement=t*this._speedIncrementPerSecond/1e3},v.prototype.updateTurningLimit=function(){this._turningLimit=this._sc.getMaxAngularAcceleration()*g.getSetting(g.BS.TURN_ACCELERATION_DURATION_S)*o.ANGULAR_VELOCITY_MATRIX_DURATION_S},v.prototype.updateForNewPropulsion=function(){var t=this._sc.getMaxAcceleration();this.updateSpeedIncrementPerSecond(),this._maxCombatForwardSpeed=w*t,this._maxCombatReverseSpeed=F*-t,this._maxCruiseForwardSpeed=P*t,this._maxCruiseReverseSpeed=V*-t,this.updateTurningLimit(),this._maxMoveBurnLevel=this._sc.getMaxThrusterMoveBurnLevel(),this._maxTurnBurnLevel=this._sc.getMaxThrusterTurnBurnLevel()},v.prototype.getRestrictedTurningLimit=function(t){return Math.min(this._turningLimit,this._sc.getMaxTurnRateAtSpeed(void 0===t?this._sc.getRelativeVelocityMatrix()[13]:t)*o.ANGULAR_VELOCITY_MATRIX_DURATION_S)},v.prototype.setLocked=function(t){this._locked=t,this._locked&&(this._yawTarget=0,this._pitchTarget=0,this._rollTarget=0)},v.prototype.getFlightMode=function(){return this._assisted?this._restricted?X.CRUISE:X.COMBAT:X.FREE},v.prototype.changeFlightMode=function(t){if(this._locked)return!1;switch(t||(t=this._assisted?this._restricted?X.FREE:X.CRUISE:X.COMBAT),t){case X.COMBAT:this._speedTarget=Math.min(Math.max(this._maxCombatReverseSpeed,this._assisted?this._speedTarget:this._sc.getRelativeVelocityMatrix()[13]),this._maxCombatForwardSpeed),this._assisted=!0,this._restricted=!1;break;case X.CRUISE:this._speedTarget=Math.min(Math.max(this._maxCruiseReverseSpeed,this._assisted?this._speedTarget:this._sc.getRelativeVelocityMatrix()[13]),this._maxCruiseForwardSpeed),this._assisted=!0,this._restricted=!0;break;case X.FREE:this._assisted=!1,this._restricted=!1;break;default:return s.showError("Cannot switch to unknown flight mode: '"+t+"'!"),!1}return!0},v.prototype.toggleFlightAssist=function(){return this.changeFlightMode(this._assisted?X.FREE:X.COMBAT)},v.prototype.toggleCruise=function(){return this.changeFlightMode(this._restricted?X.COMBAT:X.CRUISE)},v.prototype.forward=function(t){var e;this._locked||(this._assisted?(e=this._restricted?this._maxCruiseForwardSpeed:this._maxCombatForwardSpeed,this._speedThrottled=void 0!==t,this._speedTarget=this._holdSpeed&&!this._speedThrottled?Math.min(Math.max(this._sc.getRelativeVelocityMatrix()[13],this._speedTarget)+this._speedIncrement,e):(t||1)*e):this._speedTarget=Number.MAX_VALUE)},v.prototype.stopForward=function(){var t;this._locked||(this._assisted?this._holdSpeed||this._speedTarget>0&&(this._speedTarget=0):(t=this._sc.getRelativeVelocityMatrix()[13],this._speedTarget>t&&(this._speedTarget=t)))},v.prototype.reverse=function(t){var e;this._locked||(this._assisted?(e=this._restricted?this._maxCruiseReverseSpeed:this._maxCombatReverseSpeed,this._speedThrottled=void 0!==t,this._speedTarget=this._holdSpeed&&!this._speedThrottled?Math.max(Math.min(this._sc.getRelativeVelocityMatrix()[13],this._speedTarget)-this._speedIncrement,e):(t||1)*e):this._speedTarget=-Number.MAX_VALUE)},v.prototype.stopReverse=function(){var t;this._locked||(this._assisted?this._holdSpeed||this._speedTarget<0&&(this._speedTarget=0):(t=this._sc.getRelativeVelocityMatrix()[13],this._speedTarget<t&&(this._speedTarget=t)))},v.prototype.strafeLeft=function(t){this._locked||(this._strafeTarget=this._restricted?0:this._assisted&&t?-t:-Number.MAX_VALUE)},v.prototype.stopLeftStrafe=function(){this._strafeTarget<0&&(this._strafeTarget=0)},v.prototype.strafeRight=function(t){this._locked||(this._strafeTarget=this._restricted?0:this._assisted&&t||Number.MAX_VALUE)},v.prototype.stopRightStrafe=function(){this._strafeTarget>0&&(this._strafeTarget=0)},v.prototype.lower=function(t){this._locked||(this._liftTarget=this._restricted?0:this._assisted&&t?-t:-Number.MAX_VALUE)},v.prototype.stopLower=function(){this._liftTarget<0&&(this._liftTarget=0)},v.prototype.raise=function(t){this._locked||(this._liftTarget=this._restricted?0:this._assisted&&t||Number.MAX_VALUE)},v.prototype.stopRaise=function(){this._liftTarget>0&&(this._liftTarget=0)},v.prototype.toggleSpeedHolding=function(){return!(this._locked||!this._assisted)&&(this._holdSpeed=!this._holdSpeed,this._holdSpeed&&(this._speedTarget=this._sc.getRelativeVelocityMatrix()[13],this._restricted?this._speedTarget=Math.min(Math.max(this._maxCruiseReverseSpeed,this._speedTarget),this._maxCruiseForwardSpeed):this._speedTarget=Math.min(Math.max(this._maxCombatReverseSpeed,this._speedTarget),this._maxCombatForwardSpeed)),!0)},v.prototype.setSpeedHolding=function(t){this._holdSpeed=t},v.prototype.resetSpeed=function(){this._locked||this._assisted&&this._holdSpeed&&(this._speedTarget=0)},v.prototype.setSpeedTarget=function(t){this._locked||this._assisted&&(this._speedTarget=t)},v.prototype.getSpeedTarget=function(){return this._speedTarget},v.prototype.hasSpeedTarget=function(){return this._assisted&&(this._holdSpeed||this._speedThrottled)},v.prototype.getMaxSpeed=function(){return this._assisted?this._restricted?this._maxCruiseForwardSpeed:this._maxCombatForwardSpeed:void 0},v.prototype.yawLeft=function(t){this._locked||(void 0===t?this._yawTarget=-this._turningLimit:t>0?this._yawTarget=-t*(this._restricted?this.getRestrictedTurningLimit():this._turningLimit):this._yawTarget<0&&(this._yawTarget=0))},v.prototype.yawRight=function(t){this._locked||(void 0===t?this._yawTarget=this._turningLimit:t>0?this._yawTarget=t*(this._restricted?this.getRestrictedTurningLimit():this._turningLimit):this._yawTarget>0&&(this._yawTarget=0))},v.prototype.pitchDown=function(t){this._locked||(void 0===t?this._pitchTarget=-this._turningLimit:t>0?this._pitchTarget=-t*(this._restricted?this.getRestrictedTurningLimit():this._turningLimit):this._pitchTarget<0&&(this._pitchTarget=0))},v.prototype.pitchUp=function(t){this._locked||(void 0===t?this._pitchTarget=this._turningLimit:t>0?this._pitchTarget=t*(this._restricted?this.getRestrictedTurningLimit():this._turningLimit):this._pitchTarget>0&&(this._pitchTarget=0))},v.prototype.rollLeft=function(t){this._locked||(void 0===t?this._rollTarget=-this._turningLimit:t>0?this._rollTarget=-t*this._turningLimit:this._rollTarget<0&&(this._rollTarget=0))},v.prototype.rollRight=function(t){this._locked||(void 0===t?this._rollTarget=this._turningLimit:t>0?this._rollTarget=t*this._turningLimit:this._rollTarget>0&&(this._rollTarget=0))},v.prototype.controlThrusters=function(t){var i,s,n,r,a=this._sc.getRelativeVelocityMatrix(),l=a[13],h=o.VELOCITY_MATRIX_ERROR_THRESHOLD,u=this._sc.getTurningMatrix(),c=o.ANGULAR_VELOCITY_MATRIX_ERROR_THRESHOLD,_=this._yawTarget,d=this._pitchTarget,p=this._sc._propulsion;p.resetThrusterBurn(),this._restricted&&0!==l&&(i=this.getRestrictedTurningLimit(l),_=Math.min(Math.max(_,-i),i),d=Math.min(Math.max(d,-i),i)),s=Math.sign(u[4])*e.angle2y(u[4],u[5]),_-s>c?p.addThrusterBurnYawRight(Math.min(this._maxTurnBurnLevel,this._sc.getNeededBurnForAngularVelocityChange(_-s,t))):_-s<-c&&p.addThrusterBurnYawLeft(Math.min(this._maxTurnBurnLevel,this._sc.getNeededBurnForAngularVelocityChange(s-_,t))),n=Math.sign(u[6])*e.angle2x(u[5],u[6]),d-n>c?p.addThrusterBurnPitchUp(Math.min(this._maxTurnBurnLevel,this._sc.getNeededBurnForAngularVelocityChange(d-n,t))):d-n<-c&&p.addThrusterBurnPitchDown(Math.min(this._maxTurnBurnLevel,this._sc.getNeededBurnForAngularVelocityChange(n-d,t))),r=Math.sign(-u[2])*e.angle2x(u[0],u[2]),this._rollTarget-r>c?p.addThrusterBurnRollRight(Math.min(this._maxTurnBurnLevel,this._sc.getNeededBurnForAngularVelocityChange(this._rollTarget-r,t))):this._rollTarget-r<-c&&p.addThrusterBurnRollLeft(Math.min(this._maxTurnBurnLevel,this._sc.getNeededBurnForAngularVelocityChange(r-this._rollTarget,t))),this._speedTarget-l>h?p.addThrusterBurnForward(Math.min(this._maxMoveBurnLevel,this._sc.getNeededBurnForSpeedChange(this._speedTarget-l,t))):this._speedTarget-l<-h&&p.addThrusterBurnReverse(Math.min(this._maxMoveBurnLevel,this._sc.getNeededBurnForSpeedChange(l-this._speedTarget,t))),(this._assisted||0!==this._strafeTarget)&&(l=a[12],this._strafeTarget-l>h?p.addThrusterBurnRight(Math.min(this._maxMoveBurnLevel,this._sc.getNeededBurnForSpeedChange(this._strafeTarget-l,t))):this._strafeTarget-l<-h&&p.addThrusterBurnLeft(Math.min(this._maxMoveBurnLevel,this._sc.getNeededBurnForSpeedChange(l-this._strafeTarget,t)))),(this._assisted||0!==this._liftTarget)&&(l=a[14],this._liftTarget-l>h?p.addThrusterBurnUp(Math.min(this._maxMoveBurnLevel,this._sc.getNeededBurnForSpeedChange(this._liftTarget-l,t))):this._liftTarget-l<-h&&p.addThrusterBurnDown(Math.min(this._maxMoveBurnLevel,this._sc.getNeededBurnForSpeedChange(l-this._liftTarget,t)))),p.updateVisuals(),this._yawTarget=0,this._pitchTarget=0,this._rollTarget=0,this._strafeTarget=0,this._liftTarget=0},v.prototype.destroy=function(){this._sc=null},b.VELOCITY_TOLERANCE=1,b.JumpState={NONE:0,ALIGNING_VELOCITY:1,PREPARING:2,JUMPING_OUT:3,JUMPING_IN:4},Object.freeze(b.JumpOutState),b.prototype.acquireResources=function(t){this._class.acquireResources(t)},b.prototype.jumpOut=function(t){var e;switch(this._state){case b.JumpState.NONE:this._state=b.JumpState.ALIGNING_VELOCITY,this._originalFlightMode=this._sc.getFlightMode(),this._sc.changeFlightMode(X.CRUISE),this._sc.setSpeedTarget(this._class._prepareVelocity),this._sc.lockManeuvering(),this._sc.disableFiring(),this._sc.handleEvent(p.JUMP_ENGAGED)&&(this._soundClip=this._class.createEngageSoundClip(),this._soundClip&&this._soundClip.play());break;case b.JumpState.ALIGNING_VELOCITY:case b.JumpState.PREPARING:t&&(e=this._state===b.JumpState.PREPARING,this._state=b.JumpState.NONE,this._sc.unlockManeuvering(),this._sc.changeFlightMode(this._originalFlightMode),this._sc.enableFiring(),this._soundClip&&(this._soundClip.stopPlaying(_.SOUND_RAMP_DURATION),this._soundClip=null),this._sc.handleEvent(p.JUMP_CANCELLED)&&(this._soundClip=this._class.createDisengageSoundClip(),this._soundClip&&this._soundClip.play()),e&&(this._soundClip=this._class.createCancelSoundClip(),this._soundClip&&this._soundClip.play()))}},b.prototype.jumpIn=function(){var t,s,n;this._state===b.JumpState.NONE&&(this._state=b.JumpState.JUMPING_IN,this._timeLeft=this._class._jumpInDuration,this._sc.unlockManeuvering(),this._sc.setSpeedTarget(0),this._sc.lockManeuvering(),this._sc.disableFiring(),s=f.getExplosion(),s.init(this._class._jumpInExplosionClass,this._sc.pMo.pM,this._sc.pMo.oM,i.getRowC43(this._sc.pMo.pM),!0,!0,i.IDENTITY4),s.addToSceneNow(this._sc.vMo.getNode()._scene._rootNode,this._sc.getSoundSource()),this._originalScalingMatrix=i.matrix4(this._sc.vMo.sM),n=this._sc.pMo,t=i.getRowB4(n.oM),n.setVelocityMatrix(i.translation4v(e.scaled3(t,this._class._jumpInVelocity+this._class._jumpInDeceleration*this._class._jumpInDuration/1e3))),n.addForce(new o.Force(n._mass*this._class._jumpInDeceleration,e.scaled3(t,-1),this._class._jumpInDuration)),n.setDragFactor(0),this._soundClip=this._class.createJumpInSoundClip(this._sc.getSoundSource()),this._soundClip&&this._soundClip.play(),this._sc.setAway(!1),this._sc.handleEvent(p.JUMPED_IN))},b.prototype.simulate=function(t){var e,s,n,r,a;switch(this._state){case b.JumpState.ALIGNING_VELOCITY:e=this._sc.getRelativeVelocityMatrix(),a=this._sc.getTopSpeed()?Math.min(this._sc.getTopSpeed(),this._class._prepareVelocity):this._class._prepareVelocity,Math.abs(e[12])<b.VELOCITY_TOLERANCE&&Math.abs(e[14])<b.VELOCITY_TOLERANCE&&Math.abs(e[13]-a)<b.VELOCITY_TOLERANCE&&(this._state=b.JumpState.PREPARING,this._timeLeft=this._class._prepareDuration,this._soundClip=this._class.createPrepareSoundClip(this._sc.getSoundSource()),this._soundClip&&this._soundClip.play());break;case b.JumpState.PREPARING:this._sc.handleEvent(p.PREPARING_JUMP,{duration:this._class._prepareDuration,timeLeft:this._timeLeft}),this._timeLeft<=0&&(this._state=b.JumpState.JUMPING_OUT,this._timeLeft=this._class._jumpOutDuration,this._soundClip=this._class.createJumpOutSoundClip(this._sc.getSoundSource()),this._soundClip&&this._soundClip.play(),r=this._sc.pMo,s=i.getRowB4(r.oM),r.addForce(new o.Force(r._mass*this._class._jumpOutAcceleration,s,this._class._jumpOutDuration)),r.setDragFactor(0),this._sc.unlockManeuvering(),this._sc.setSpeedTarget(Number.MAX_VALUE),this._sc.lockManeuvering(),this._originalScalingMatrix=i.matrix4(this._sc.vMo.sM),this._sc.handleEvent(p.JUMP_OUT_STARTED)),this._timeLeft-=t;break;case b.JumpState.JUMPING_OUT:this._sc.vMo.setScalingMatrix(i.prod3x3SubOf4(this._originalScalingMatrix,i.scaling4(1,1+(1-this._timeLeft/this._class._jumpOutDuration)*(this._class._jumpOutScaling-1),1))),this._timeLeft<=0&&(this._state=b.JumpState.NONE,n=f.getExplosion(),n.init(this._class._jumpOutExplosionClass,this._sc.pMo.pM,this._sc.pMo.oM,i.getRowC43(this._sc.pMo.pM),!0,!0,i.IDENTITY4),n.addToSceneNow(this._sc.vMo.getNode()._scene._rootNode,this._sc.getSoundSource()),this._sc.vMo.setScalingMatrix(this._originalScalingMatrix),this._sc.setAway(!0),this._sc.handleEvent(p.JUMPED_OUT)),this._timeLeft-=t;break;case b.JumpState.JUMPING_IN:this._timeLeft<0&&(this._timeLeft=0),this._sc.vMo.setScalingMatrix(i.prod3x3SubOf4(this._originalScalingMatrix,i.scaling4(1,1+this._timeLeft/this._class._jumpInDuration*(this._class._jumpInScaling-1),1))),this._timeLeft<=0&&(this._state=b.JumpState.NONE,this._sc.unlockManeuvering(),this._sc.enableFiring(),this._sc.handleEvent(p.ARRIVED),this._sc.resetDrag()),this._timeLeft-=t}},b.prototype.destroy=function(){this._class=null,this._sc=null,this._soundClip&&(this._soundClip.destroy(),this._soundClip=null),this._originalScalingMatrix=null},D.prototype.acquireResources=function(t){this._class.acquireResources(t)},D.prototype.getDisplayName=function(){return this._class.getDisplayName()},D.prototype.getIntegrity=function(){return this._capacity/this._class._capacity},D.prototype.getRechargeRate=function(){return this._class.getRechargeRate()},D.prototype.damage=function(t){var e=Math.min(this._capacity,t);return this._timeSinceHit=0,this._capacity-=e,t-e},D.prototype.startRecharge=function(){this._soundClip=this._class.createRechargeStartSoundClip(this._sc.getSoundSource()),this._soundClip&&this._soundClip.play(),this._timeSinceRecharge=0},D.prototype.simulate=function(t){var e=this._class._rechargeAnimationDuration;this._capacity<this._class._capacity&&(this._timeSinceHit<this._class.getRechargeDelay()?(this._timeSinceHit+=t,this._timeSinceHit>=this._class.getRechargeDelay()&&this.startRecharge()):this._capacity=Math.min(this._class._capacity,this._capacity+this._class.getRechargeRate()*t*.001)),this._timeSinceRecharge=Math.min(e,this._timeSinceRecharge+t),this._state[3]=this._timeSinceRecharge/e},D.prototype.getScoreValue=function(){return this._class.getScoreValue()},D.prototype.destroy=function(){this._class=null,this._sc=null,this._soundClip&&(this._soundClip.destroy(),this._soundClip=null)},G=a.getPool(m.PARTICLE_POOL_NAME,l.Particle),j=a.getPool(m.PROJECTILE_POOL_NAME,A),k=a.getPool(m.MISSILE_POOL_NAME,C),W=a.getPool(m.TRAIL_SEGMENT_POOL_NAME,l.TrailSegment),g.executeWhenReady(function(){J=g.getSetting(g.BS.SELF_FIRE),tt=g.getSetting(g.BS.MOMENT_DURATION),et=g.getSetting(g.BS.MINIMUM_PARTICLE_COUNT_FOR_INSTANCING),it=g.getSetting(g.BS.MINIMUM_PROJECTILE_COUNT_FOR_INSTANCING),st=g.getSetting(g.BS.MINIMUM_TRAIL_SEGMENT_COUNT_FOR_INSTANCING),w=g.getSetting(g.BS.MAX_COMBAT_FORWARD_SPEED_FACTOR),F=g.getSetting(g.BS.MAX_COMBAT_REVERSE_SPEED_FACTOR),P=g.getSetting(g.BS.MAX_CRUISE_FORWARD_SPEED_FACTOR),V=g.getSetting(g.BS.MAX_CRUISE_REVERSE_SPEED_FACTOR),U=g.getSetting(g.BS.SHOW_HITBOXES_FOR_HITCHECKS),nt=g.getSetting(g.GENERAL_SETTINGS.UNIFORM_LUMINOSITY_FACTORS_ARRAY_NAME),ot=g.getSetting(g.GENERAL_SETTINGS.UNIFORM_GROUP_TRANSFORMS_ARRAY_NAME),B=g.getSetting(g.BS.FIRE_SOUND_STACKING_TIME_THRESHOLD),H=g.getSetting(g.BS.FIRE_SOUND_STACKING_VOLUME_FACTOR),c.executeWhenReady(S),c.onSettingsChange(S)}),{FlightMode:X,ThrusterUse:z,handleDifficultySet:T,Projectile:A,Missile:C,Weapon:N,MissileLauncher:O,TargetingComputer:R,Propulsion:x,JumpEngine:b,Shield:D,ManeuveringComputer:v}}),define("armada/control",["utils/utils","modules/application","modules/control/control","modules/control/keyboard","modules/control/mouse","modules/control/gamepad","modules/control/touch","modules/camera-controller","modules/game","modules/media-resources","armada/screens/shared","armada/strings","armada/configuration","armada/logic/equipment"],function(t,e,i,s,n,o,r,a,l,h,u,c,_,d){"use strict";function p(t){i.Controller.call(this,t),this._mission=null,this._battle=null,this.setActionFunction("quit",!0,function(){this._battle.pauseBattle(),l.setScreen(u.INGAME_MENU_SCREEN_NAME,!0,u.SUPERIMPOSE_BACKGROUND_COLOR)}.bind(this)),this.setActionFunction("pause",!0,function(){l.getScreen().showMessage(c.get(c.BATTLE.MESSAGE_PAUSED))}),this.setActionFunction("toggleDevInfoVisibility",!0,function(){l.getScreen().toggleDevInfoVisibility()}),this.setActionFunction("toggleHUDVisibility",!0,function(){this._battle.toggleHUDVisibility()}.bind(this)),this.setActionFunction("toggleMouseControls",!0,function(){C.getInputInterpreter(R).toggleEnabled(),C.isInPilotMode()&&(C.getInputInterpreter(R).isEnabled()?(document.body.style.cursor="none",C.enableMouseTurning()):document.body.style.cursor=l.getDefaultCursor())}),this.setActionFunction("toggleJoystickControls",!0,function(){C.getInputInterpreter(L).toggleEnabled()})}function g(t){i.Controller.call(this,t),this._controlledSpacecraft=null,this._strafeSpeed=0,this._autoTargeting=!0,this._wAimThreshold=t.weaponAimThreshold,this.setActionFunction("fire",!0,function(t,e){this._controlledSpacecraft.fire(!1,t),e===N&&C.enableMouseTurning()}.bind(this)),this.setActionFunction("launchMissile",!0,function(t,e){this._controlledSpacecraft.launchMissile(t)||A&&A.play(),e===N&&C.enableMouseTurning()}.bind(this)),this.setActionFunction("changeMissile",!0,function(t){this._controlledSpacecraft.changeMissile(t)?I&&I.play():A&&A.play()}.bind(this)),this.setActionFunction("toggleSalvo",!0,function(t){this._controlledSpacecraft.toggleSalvo(t)?M&&M.play():A&&A.play()}.bind(this)),this.setActionFunction("changeFlightMode",!0,function(){this._controlledSpacecraft.changeFlightMode()&&y&&y.play()}.bind(this)),this.setActionFunction("toggleCruise",!0,function(){this._controlledSpacecraft.toggleCruise()&&y&&y.play()}.bind(this)),this.setActionFunction("toggleFlightAssist",!0,function(){this._controlledSpacecraft.toggleFlightAssist()&&y&&y.play()}.bind(this)),this.setActionFunction("nextNearestHostileTarget",!0,function(){this._controlledSpacecraft.targetNextNearestHostile()?T.play():E.play()}.bind(this)),this.setActionFunction("previousNearestHostileTarget",!0,function(){this._controlledSpacecraft.targetPreviousNearestHostile()?T.play():E.play()}.bind(this)),this.setActionFunction("nextNearestNonHostileTarget",!0,function(){this._controlledSpacecraft.targetNextNearestNonHostile()?T.play():E.play()}.bind(this)),this.setActionFunction("toggleAutoTargeting",!0,function(){this._autoTargeting=!this._autoTargeting}.bind(this)),this.setActionFunctions("forward",function(t){this._controlledSpacecraft.forward(t)}.bind(this),function(){this._controlledSpacecraft.stopForward()}.bind(this)),this.setActionFunctions("reverse",function(t){this._controlledSpacecraft.reverse(t)}.bind(this),function(){this._controlledSpacecraft.stopReverse()}.bind(this)),this.setActionFunctions("strafeLeft",function(t){this._controlledSpacecraft.getFlightMode()===d.FlightMode.CRUISE&&this._controlledSpacecraft.toggleCruise()&&y&&y.play(),this._controlledSpacecraft.strafeLeft((void 0!==t?t:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopLeftStrafe()}.bind(this)),this.setActionFunctions("strafeRight",function(t){this._controlledSpacecraft.getFlightMode()===d.FlightMode.CRUISE&&this._controlledSpacecraft.toggleCruise()&&y&&y.play(),this._controlledSpacecraft.strafeRight((void 0!==t?t:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopRightStrafe()}.bind(this)),this.setActionFunctions("raise",function(t){this._controlledSpacecraft.getFlightMode()===d.FlightMode.CRUISE&&this._controlledSpacecraft.toggleCruise()&&y&&y.play(),this._controlledSpacecraft.raise((void 0!==t?t:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopRaise()}.bind(this)),this.setActionFunctions("lower",function(t){this._controlledSpacecraft.getFlightMode()===d.FlightMode.CRUISE&&this._controlledSpacecraft.toggleCruise()&&y&&y.play(),this._controlledSpacecraft.lower((void 0!==t?t:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopLower()}.bind(this)),this.setActionFunction("toggleSpeedHolding",!0,function(){this._controlledSpacecraft.toggleSpeedHolding()&&y&&y.play()}.bind(this)),this.setActionFunction("resetSpeed",!0,function(){this._controlledSpacecraft.resetSpeed()}.bind(this)),this.setActionFunction("yawLeft",!0,function(t,e){this._controlledSpacecraft.yawLeft(t),e!==N&&C.disableMouseTurning()}.bind(this)),this.setActionFunction("yawRight",!0,function(t,e){this._controlledSpacecraft.yawRight(t),e!==N&&C.disableMouseTurning()}.bind(this)),this.setActionFunction("pitchUp",!0,function(t,e){this._controlledSpacecraft.pitchUp(t),e!==N&&C.disableMouseTurning()}.bind(this)),this.setActionFunction("pitchDown",!0,function(t,e){this._controlledSpacecraft.pitchDown(t),e!==N&&C.disableMouseTurning()}.bind(this)),this.setActionFunction("rollLeft",!0,function(t){this._controlledSpacecraft.rollLeft(t)}.bind(this)),this.setActionFunction("rollRight",!0,function(t){this._controlledSpacecraft.rollRight(t)}.bind(this)),this.setActionFunction("jumpOut",!0,function(){this._controlledSpacecraft.jumpOut(!0)}.bind(this))}function m(t){return h.getSoundEffect(_.gHS(t).name).createSoundClip(h.SoundCategory.SOUND_EFFECT,_.gHS(t).volume)}function f(){i.ControlContext.call(this),this._pilotingMode=!1,this._mouseTurningDisabled=!1,this.registerInputInterpreterType(O,s.KeyboardInputInterpreter),this.registerInputInterpreterType(R,n.MouseInputInterpreter),this.registerInputInterpreterType(L,o.GamepadInputInterpreter),t.areTouchEventsSupported()&&this.registerInputInterpreterType(v,r.TouchInputInterpreter),this.registerControllerType(b,p),this.registerControllerType(D,g),this.registerControllerType(w,a.CameraController)}var S,T,E,y,I,A,M,C,N,O="keyboard",R="mouse",L="joystick",x=L,v="touch",b="general",D="fighter",w="camera",F=function(){I&&I.play()};return s.setModulePrefix("interstellarArmada_control_"),n.setModulePrefix("interstellarArmada_control_"),o.setModulePrefix("interstellarArmada_control_"),r.setModulePrefix("interstellarArmada_control_"),p.prototype=new i.Controller,p.prototype.constructor=p,p.prototype.getType=function(){return"general"},p.prototype.setMission=function(t){this._mission=t},p.prototype.setBattle=function(t){this._battle=t},g.prototype=new i.Controller,g.prototype.constructor=g,g.prototype.getType=function(){return"fighter"},g.prototype.setControlledSpacecraft=function(t){this._controlledSpacecraft=t,this._controlledSpacecraft&&(this._strafeSpeed=S*this._controlledSpacecraft.getMaxAcceleration())},g.prototype.executeActions=function(t,e){this._controlledSpacecraft&&(this._controlledSpacecraft.canBeReused()?this._controlledSpacecraft=null:(this._controlledSpacecraft.prepareForControl(),
i.Controller.prototype.executeActions.call(this,t),this._autoTargeting&&!this._controlledSpacecraft.getTarget()&&this._controlledSpacecraft.targetNextBestHostile()&&T.play(),this._controlledSpacecraft.aimWeapons(this._wAimThreshold,0,e)))},f.prototype=new i.ControlContext,f.prototype.constructor=f,f.prototype.isInPilotMode=function(){return this._pilotingMode},f.prototype.switchToPilotMode=function(t,e){t&&t._alive&&!this._pilotingMode&&(this._pilotingMode=!0,T=m(_.BS.HUD.TARGET_SWITCH_SOUND),E=m(_.BS.HUD.TARGET_SWITCH_DENIED_SOUND),y=m(_.BS.HUD.FLIGHT_MODE_SWITCH_SOUND),I=m(_.BS.HUD.MISSILE_CHANGE_SOUND),A=m(_.BS.HUD.MISSILE_CHANGE_DENIED_SOUND),M=m(_.BS.HUD.MISSILE_SALVO_SOUND),this.getController(D).setControlledSpacecraft(t),this.getController(w).setCameraToFollowObject(t.vMo,e?0:_.getSetting(_.BS.CAMERA_PILOTING_SWITCH_TRANSITION_DURATION),_.getSetting(_.BS.CAMERA_PILOTING_SWITCH_TRANSITION_STYLE),_.getDefaultCamerConfigurationName(t)),this.disableAction("followNext"),this.disableAction("followPrevious"),l.getScreen().setHeaderContent(""),this.getInputInterpreter(R).isEnabled()&&(document.body.style.cursor="none"))},f.prototype.switchToSpectatorMode=function(t,e){(this._pilotingMode||e)&&(this._pilotingMode=!1,this.getController(D).setControlledSpacecraft(null),t&&this.getController(w).setToFreeCamera(!1),this.enableAction("followNext"),this.enableAction("followPrevious"),l.getScreen().setHeaderContent(c.get(c.BATTLE.SPECTATOR_MODE)),document.body.style.cursor=l.getDefaultCursor())},f.prototype.disableMouseTurning=function(){this._mouseTurningDisabled||(N.disableAction("yawLeft"),N.disableAction("yawRight"),N.disableAction("pitchUp"),N.disableAction("pitchDown"),N.disableAction("rollLeft"),N.disableAction("rollRight"),this._mouseTurningDisabled=!0)},f.prototype.enableMouseTurning=function(){this._mouseTurningDisabled&&(N.enableAction("yawLeft"),N.enableAction("yawRight"),N.enableAction("pitchUp"),N.enableAction("pitchDown"),N.enableAction("rollLeft"),N.enableAction("rollRight"),this._mouseTurningDisabled=!1)},f.prototype.isMouseTurningDisabled=function(){return this._mouseTurningDisabled},C=new f,C.executeWhenReady(function(){N=C.getInputInterpreter(R)}),_.executeWhenReady(function(){S=_.getSetting(_.BS.STRAFE_SPEED_FACTOR)}),{KEYBOARD_NAME:O,MOUSE_NAME:R,JOYSTICK_NAME:L,GAMEPAD_NAME:x,GENERAL_CONTROLLER_NAME:b,FIGHTER_CONTROLLER_NAME:D,CAMERA_CONTROLLER_NAME:w,KeyBinding:s.KeyBinding,loadConfigurationFromJSON:C.loadConfigurationFromJSON.bind(C),loadSettingsFromJSON:C.loadSettingsFromJSON.bind(C),loadSettingsFromLocalStorage:C.loadSettingsFromLocalStorage.bind(C),restoreDefaults:C.restoreDefaults.bind(C),getControllers:C.getControllers.bind(C),getController:C.getController.bind(C),isControllerPriority:C.isControllerPriority.bind(C),getInputInterpreters:C.getInputInterpreters.bind(C),getInputInterpreter:C.getInputInterpreter.bind(C),control:C.control.bind(C),startListening:C.startListening.bind(C),stopListening:C.stopListening.bind(C),isListening:C.isListening.bind(C),setScreenCenter:C.setScreenCenter.bind(C),executeWhenReady:C.executeWhenReady.bind(C),isInPilotMode:C.isInPilotMode.bind(C),switchToPilotMode:C.switchToPilotMode.bind(C),switchToSpectatorMode:C.switchToSpectatorMode.bind(C),isMouseTurningDisabled:C.isMouseTurningDisabled.bind(C),playMissileChangeSound:F}}),define("armada/logic/spacecraft",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/managed-gl","modules/egom-model","modules/physics","modules/media-resources","modules/scene/renderable-objects","modules/scene/lights","modules/scene/scene-graph","armada/graphics","armada/audio","armada/logic/classes","armada/configuration","armada/strings","armada/control","armada/logic/constants","armada/logic/SpacecraftEvents","armada/logic/equipment","armada/logic/explosion","utils/polyfill"],function(t,e,i,s,n,o,r,a,l,h,u,c,_,d,p,g,m,f,S,T,E){"use strict";function y(){D={},D[b]=n.ShaderVariableType.MAT4,c.areLuminosityTexturesAvailable()&&(D[v]=n.ShaderVariableType.FLOAT),w=c.areDynamicLightsAvailable()&&c.getMaxPointLights()>0}function I(){R=Math.seed(p.getSetting(p.GENERAL_SETTINGS.DEFAULT_RANDOM_SEED))}function A(t){this._descriptor=t,this.vMo=null,this._lightSource=null}function M(t,e,s,n,o,r,a){this._class=null,this._id=null,this._name=null,this._displayName=null,this._alive=!0,this._away=!1,this._hitpoints=0,this._maxHitpoints=0,this.vMo=null,this._blinkers=null,this._lights=null,this.pMo=null,this._physicalPositionVector=[0,0,0],this._relativeVelocityMatrix=i.identity4(),this._relativeVelocityMatrixValid=!1,this._turningMatrix=i.identity4(),this._turningMatrixValid=!1,this._scaledOriMatrix=i.identity4(),this._ws=null,this._mLs=[],this._activeMissileLauncherIndex=-1,this._mClasses=[],this._tC=null,this._firingDisabled=!1,this._propulsion=null,this._jumpEngine=null,this._shield=null,this._mC=null,this._activeDamageIndicators=[],this._explosion=null,this._eventHandlers=null,this._tedBy=null,this._team=null,this._squad=null,this._indexInSquad=0,this._humSoundClip=null,this._humSoundVolume=0,this._soundSource=null,this._soundSourcePosition=[0,0,0],this._kills=0,this._score=0,this._damageDealt=0,this._mDamageDealt=0,this._shotsFired=0,this._hitsOnEnemies=0,this._msLaunched=0,this._mHitsOnEnemies=0,this._scoreValue=0,this._timeElapsedSinceDestruction=-1,this._burnForSpeedChangeFactor=0,this._burnForAngularVelocityChangeFactor=0,this._topSpeed=0,t&&this._init(t,e,s,n,o,r,a)}var C,N,O,R,L={WEDGE:"wedge",RANDOM:"random"},x=[-1,-1,-1,-1],v=null,b=null,D=null,w=!1;return A.prototype.addToScene=function(t,e){this.vMo=new l.Particle(this._descriptor._particle.getModel(),this._descriptor._particle.getShader(),this._descriptor._particle.getTexturesOfTypes(this._descriptor._particle.getShader().getTextureTypes(),c.getTextureQualityPreferenceList()),i.translation4v(this._descriptor._position),this._descriptor.getParticleStates(),!0,this._descriptor._particle.getInstancedShader(),0),t.addSubnode(new u.RenderableNode(this.vMo,!1,!1,p.getSetting(p.BS.MINIMUM_BLINKER_PARTICLE_COUNT_FOR_INSTANCING))),w&&!0===e&&this._descriptor._intensity>0&&(this._lightSource=new h.PointLightSource(this._descriptor._lightColor,0,this._descriptor._position,[t._renderableObject],this._descriptor.getLightStates(),!0),t._scene.addPointLightSource(this._lightSource,f.BLINKER_LIGHT_PRIORITY))},A.prototype.setTime=function(t){this.vMo.setAnimationTime(t),this._lightSource&&this._lightSource.setAnimationTime(t)},A.prototype.setRandomTime=function(){var t=Math.round(Math.random()*this._descriptor._period);return this.setTime(t),t},M.getPositionInFormation=function(t,i,n,o){var r,a=Math.ceil(i/2);switch(t.type){case L.WEDGE:r=[(i%2==1?1:-1)*a*t.spacing[0],a*t.spacing[1],a*t.spacing[2]];break;case L.RANDOM:r=[R()*t.spacing[0]-t.spacing[0]/2,R()*t.spacing[1]-t.spacing[1]/2,R()*t.spacing[2]-t.spacing[2]/2];break;default:return s.showError("Unknown formation type specified: '"+t.type+"!"),[0,0,0]}return o&&e.mulVec3Mat4(r,o),n&&e.add3(r,n),r},M.prototype._init=function(t,e,s,n,o,a,l){var h,u;for(this._class=t,this._name=e||"",this._alive=!0,this._away=!1,this._hitpoints=this._class._hitpoints,this._maxHitpoints=this._class._hitpoints,this.pMo=new r.PhysicalObject(this._class._mass,s||i.identity4(),n||i.identity4(),i.identity4(),i.identity4(),this._class._bodies,!1,!1,this._class._dragFactor),this._ws=[],this._mLs=[],this._mClasses=[],this._activeMissileLauncherIndex=-1,this._tC=new T.TargetingComputer(this,a,l),this._firingDisabled=!1,this._mC=new T.ManeuveringComputer(this),this._blinkers=[],u=this._class._blinkerDescriptors,h=0;h<u.length;h++)this._blinkers.push(new A(u[h]));this._lights=[],o&&this.equipLoadout(this._class.getLoadout(o)),this._tedBy=[],this._eventHandlers={},this._team=null,this._kills=0,this._score=0,this._damageDealt=0,this._mDamageDealt=0,this._shotsFired=0,this._hitsOnEnemies=0,this._msLaunched=0,this._mHitsOnEnemies=0,this._hitSounds={},this._hitSoundTimestamp=0,this._updateIDAndName(),this._updateScoreValue(),this._updateBurnNeedFactors()},M.prototype._updateIDAndName=function(){this._id=this._name||!this._squad?this._name:this._squad+" "+this._indexInSquad.toString(),this._displayName=this._name||!this._squad?this._name:g.get(g.SQUAD.PREFIX,this._squad,this._squad)+" "+this._indexInSquad.toString()},M.prototype._updateBurnNeedFactors=function(){this._burnForSpeedChangeFactor=this._propulsion?this.pMo._mass/this._propulsion.getThrust()*this._propulsion.getMaxMoveBurnLevel()*1e3:0,this._burnForAngularVelocityChangeFactor=this._propulsion?1/r.ANGULAR_VELOCITY_MATRIX_DURATION_S*this.pMo._mass/this._propulsion.getAngularThrust()*this._propulsion.getMaxTurnBurnLevel()*1e3:0},M.prototype.setAway=function(t){var e,i;if(this._away!==t)if(this._away=t,this._away){if(this.setTarget(null),i=this.pMo.pM,this.vMo&&(!this.vMo._wireframe||0===i[12]&&0===i[13]&&0===i[14])&&this.vMo.getNode().hide(),this._lights)for(e=0;e<this._lights.length;e++)this._lights[e].hide();this.pMo&&this.pMo.reset(),this._humSoundClip&&this._humSoundClip.stopPlaying(_.SOUND_RAMP_DURATION),this._propulsion&&(this._propulsion.resetThrusterBurn(),this._propulsion.simulate(0,this.getSoundSource(),!1),this._propulsion.resetForcesAndTorques())}else if(this.vMo&&this.vMo.getNode().show(),this._lights)for(e=0;e<this._lights.length;e++)this._lights[e].show()},M.prototype.setTeam=function(t){this._team=t},M.prototype.getTeam=function(){return this._team},M.prototype.setSquad=function(t,e){this._squad=t,this._indexInSquad=e,this._updateIDAndName()},M.prototype.isFriendly=function(t){return t.getTeam()===this._team},M.prototype.isHostile=function(t){return t.getTeam()!==this._team},M.prototype.getClass=function(){return this._class},M.prototype.isFighter=function(){return this._class.isFighterClass()},M.prototype.getID=function(){return this._id},M.prototype.getDisplayName=function(){return this._displayName},M.prototype.getHullIntegrity=function(){return this._hitpoints/this._maxHitpoints},M.prototype.hasShield=function(){return!!this._shield},M.prototype.getShieldDisplayName=function(){return this._shield.getDisplayName()},M.prototype.getShieldIntegrity=function(){return this._shield?this._shield.getIntegrity():0},M.prototype.getShieldCapacity=function(){return this._shield?this._shield._capacity:0},M.prototype.getShieldRechargeRate=function(){return this._shield?this._shield.getRechargeRate():0},M.prototype.getShieldState=function(){return this._shield?this._shield._state:e.NULL4},M.prototype.rechargeShield=function(){this._shield.startRecharge()},M.prototype.multiplyMaxHitpoints=function(t){this._hitpoints*=t,this._maxHitpoints*=t},M.prototype.getExplosion=function(){return this._explosion},M.prototype.getClassName=function(){return this._class._name},M.prototype.getTypeName=function(){return this._class._scType._name},M.prototype.isGoodAgainst=function(t){return this._class._scType.isGoodAgainst(t.getClass()._scType)},M.prototype.isBadAgainst=function(t){return this._class._scType.isBadAgainst(t.getClass()._scType)},M.prototype.resetDrag=function(){return this.pMo.setDragFactor(this._class._dragFactor)},M.prototype.getView=function(t){return this._class.getView(t)},M.prototype.enableFiring=function(){this._firingDisabled=!1},M.prototype.disableFiring=function(){this._firingDisabled=!0},M.prototype.hasWeapons=function(){return this._ws&&this._ws.length>0},M.prototype.getWeaponsDisplayText=function(t){var e,i,s,n="",o={};for(t=t||", ",e=0;e<this._ws.length;e++)i=this._ws[e].getDisplayName(),o[i]?o[i]+=1:o[i]=1;for(s=Object.keys(o),e=0;e<s.length;e++)n+=(e>0?t:"")+o[s[e]]+" × "+s[e];return n},M.prototype.getWeaponRangesDisplayText=function(t){t=t||"/";var e,i,s=[];for(e=0;e<this._ws.length;e++)i=this._ws[e].getRange(),s.indexOf(i)<0&&s.push(i);return s.join(t)},M.prototype.getFirepower=function(t){var e,i=0;for(e=0;e<this._ws.length;e++)i+=this._ws[e].getFirepower(t);return i},M.prototype.hasMissiles=function(){var t;if(this._mLs)for(t=0;t<this._mLs.length;t++)if(this._mLs[t].getMissileCount()>0)return!0;return!1},M.prototype.getMissilesDisplayText=function(t){var e,i,s,n="",o={};for(t=t||", ",e=0;e<this._mLs.length;e++)i=this._mLs[e].getDisplayName(),o[i]?o[i]+=this._mLs[e].getMissileCount():o[i]=this._mLs[e].getMissileCount();for(s=Object.keys(o),e=0;e<s.length;e++)n+=(e>0?t:"")+o[s[e]]+" × "+s[e];return n},M.prototype.getMissileRangesDisplayText=function(t){t=t||"/";var e,i,s=[];for(e=0;e<this._mLs.length;e++)i=this._mLs[e].getNominalRange().toFixed(0),s.indexOf(i)<0&&s.push(i);return s.join(t)},M.prototype.getMissileFirepower=function(t){var e,i=0;for(e=0;e<this._mLs.length;e++)i+=this._mLs[e].getFirepower(t||0);return i},M.prototype.canBeReused=function(){return!this._alive},M.prototype.getHitRatio=function(){return this._shotsFired?this._hitsOnEnemies/this._shotsFired:0},M.prototype.getKills=function(){return this._kills},M.prototype.gainKill=function(){this._kills++},M.prototype.getScore=function(){return this._score},M.prototype.gainScore=function(t){this._score+=t},M.prototype.getDamageDealt=function(){return this._damageDealt},M.prototype.getMissileDamageDealt=function(){return this._mDamageDealt},M.prototype.gainDamageDealt=function(t,e){this._damageDealt+=t,e&&(this._mDamageDealt+=t)},M.prototype.getMissilesLaunched=function(){return this._msLaunched},M.prototype.getMissileHitsOnEnemies=function(){return this._mHitsOnEnemies},M.prototype.getMissileHitRatio=function(){return this._mHitsOnEnemies/this._msLaunched},M.prototype.getScoreValue=function(){return this._scoreValue},M.prototype.setPhysicalPosition=function(t){this.pMo.setPositionMatrix(i.translation4v(t))},M.prototype.setPhysicalPositionMatrix=function(t){this.pMo.setPositionMatrix(t)},M.prototype.getPhysicalPositionVector=function(){return this.pMo.copyPositionToVector(this._physicalPositionVector),this._physicalPositionVector},M.prototype.setPhysicalOrientationMatrix=function(t){this.pMo.setOrientationMatrix(t)},M.prototype.updateScaledOriMatrix=function(){i.setProd3x3SubOf4(this._scaledOriMatrix,this.pMo.sM,this.pMo.oM)},M.prototype.getScaledOriMatrix=function(){return this._scaledOriMatrix},M.prototype.getPositionMatrixInCameraSpace=function(){return this.vMo.getPositionMatrixInCameraSpace(this.vMo.getNode()._scene._camera)},M.prototype.getVelocityMatrix=function(){return this.pMo.getVelocityMatrix()},M.prototype.getRelativeVelocityMatrix=function(){return this._relativeVelocityMatrixValid||(i.setProdTranslationRotation4(this._relativeVelocityMatrix,this.pMo.getVelocityMatrix(),i.rotation4m4Aux(this.pMo.getRotationMatrixInverse())),this._relativeVelocityMatrixValid=!0),this._relativeVelocityMatrix},M.prototype.getTurningMatrix=function(){return this._turningMatrixValid||(i.setProd3x3SubOf4(this._turningMatrix,i.prod3x3SubOf4Aux(this.pMo.oM,this.pMo.getAngularVelocityMatrix()),i.rotation4m4Aux(this.pMo.getRotationMatrixInverse())),this._turningMatrixValid=!0),this._turningMatrix},M.prototype.getMaxAcceleration=function(){return this._propulsion?this._propulsion.getThrust()/this.pMo._mass:null},M.prototype.getMaxCombatSpeed=function(){return this.getMaxAcceleration()*p.getSetting(p.BS.MAX_COMBAT_FORWARD_SPEED_FACTOR)||0},M.prototype.getMaxAngularAcceleration=function(){return this._propulsion?this._propulsion.getAngularThrust()/this.pMo._mass:0},M.prototype.getMaxCombatTurnRate=function(){return this.getMaxAngularAcceleration()*t.DEG*p.getSetting(p.BS.TURN_ACCELERATION_DURATION_S)||0},M.prototype.getMaxThrusterMoveBurnLevel=function(){return this._propulsion?this._propulsion.getMaxMoveBurnLevel():0},M.prototype.getMaxThrusterTurnBurnLevel=function(){return this._propulsion?this._propulsion.getMaxTurnBurnLevel():0},M.prototype.getMaxTurnRateAtSpeed=function(t){var e=Math.abs(this._propulsion.getThrust()/(this.pMo._mass*t));return e<=1?Math.asin(e):Number.MAX_VALUE},M.prototype.getNeededBurnForSpeedChange=function(t,e){return t*this._burnForSpeedChangeFactor/e},M.prototype.getNeededBurnForAngularVelocityChange=function(t,e){return t*this._burnForAngularVelocityChangeFactor/e},M.prototype.getTopSpeed=function(){return this._topSpeed},M.prototype.loadFromJSON=function(t,e,s){var n,o;this._init(d.getSpacecraftClass(t.class),t.name,t.position?i.translation4v(t.position):null,i.rotation4FromJSON(t.rotations),void 0,e,s),t.squad&&(o=t.squad.split(" "),this.setSquad(o[0],parseInt(o[1],10))),t.loadout?this.equipLoadout(this._class.getLoadout(t.loadout)):t.equipment?(n=new d.Loadout(t.equipment),this.equipLoadout(n)):this._class._defaultLoadout&&this.equipLoadout(this._class.getLoadout(this._class._defaultLoadout)),t.away&&this.setAway(!0)},M.prototype.prepareForControl=function(){this._mC.prepareForControl()},M.prototype.isManeuveringLocked=function(){return this._mC._locked},M.prototype.lockManeuvering=function(){this._mC.setLocked(!0)},M.prototype.unlockManeuvering=function(){this._mC.setLocked(!1)},M.prototype.getFlightMode=function(){return this._mC.getFlightMode()},M.prototype.changeFlightMode=function(t){return this._mC.changeFlightMode(t)},M.prototype.toggleFlightAssist=function(){return this._mC.toggleFlightAssist()},M.prototype.toggleCruise=function(){return this._mC.toggleCruise()},M.prototype.forward=function(t){this._mC.forward(t)},M.prototype.stopForward=function(){this._mC.stopForward()},M.prototype.reverse=function(t){this._mC.reverse(t)},M.prototype.stopReverse=function(){this._mC.stopReverse()},M.prototype.strafeLeft=function(t){this._mC.strafeLeft(t)},M.prototype.stopLeftStrafe=function(){this._mC.stopLeftStrafe()},M.prototype.strafeRight=function(t){this._mC.strafeRight(t)},M.prototype.stopRightStrafe=function(){this._mC.stopRightStrafe()},M.prototype.raise=function(t){this._mC.raise(t)},M.prototype.stopRaise=function(){this._mC.stopRaise()},M.prototype.lower=function(t){this._mC.lower(t)},M.prototype.stopLower=function(){this._mC.stopLower()},M.prototype.toggleSpeedHolding=function(){return this._mC.toggleSpeedHolding()},M.prototype.setSpeedHolding=function(t){this._mC.setSpeedHolding(t)},M.prototype.resetSpeed=function(){this._mC.resetSpeed()},M.prototype.setSpeedTarget=function(t){this._mC.setSpeedTarget(t)},M.prototype.getSpeedTarget=function(){return this._mC.getSpeedTarget()},M.prototype.hasSpeedTarget=function(){return this._mC.hasSpeedTarget()},M.prototype.getMaxSpeed=function(){return this._mC.getMaxSpeed()},M.prototype.yawLeft=function(t){this._mC.yawLeft(t)},M.prototype.yawRight=function(t){this._mC.yawRight(t)},M.prototype.pitchUp=function(t){this._mC.pitchUp(t)},M.prototype.pitchDown=function(t){this._mC.pitchDown(t)},M.prototype.rollLeft=function(t){this._mC.rollLeft(t)},M.prototype.rollRight=function(t){this._mC.rollRight(t)},M.prototype.acquireResources=function(t,e){t&&(c.getShader(p.getSetting(p.BS.HITBOX_SHADER_NAME)),c.getTexture(p.getSetting(p.BS.HITBOX_TEXTURE_NAME))),this._class.acquireResources(e),a.executeWhenReady(function(){this._alive&&this.pMo.setScalingMatrix(i.scaling4(this._class.getModel()._scale))}.bind(this))},M.prototype.addToSceneNow=function(t,n,o,r,a,u,_,d){var p,g,m,S,T,y,I,A,M,C,N,O,R;if(this._class){if(!1!==r.self?(g=a.shaderName?c.getManagedShader(a.shaderName):this._class.getShader(),A=new l.ParameterizedMesh(this._class.getModel(),g,this._class.getTexturesOfTypes(g.getTextureTypes(),c.getTextureQualityPreferenceList()),a.positionMatrix||this.pMo.pM,a.orientationMatrix||this.pMo.oM,a.scalingMatrix||i.scaling4(this._class.getModel()._scale),!0===o,n,a.smallestSizeWhenDrawn,D),this.vMo&&!a.replaceVisualModel||(this.vMo=A),this._name&&A.setName(this._name),y=this._class._factionColor||x,I=a.factionColor||this._team&&this._team._color||y,A.setUniformValueFunction("originalFactionColor",function(){return y}),A.setUniformValueFunction("replacementFactionColor",function(){return I}),A.setUniformValueFunction("shieldState",function(){return this.getShieldState()}.bind(this)),A.hasParameterArray(b)&&A.setParameterArray(b,c.getGroupTransformIdentityArray()),c.areLuminosityTexturesAvailable()&&A.hasParameterArray(v)&&A.setParameterArray(v,this._class._defaultLuminosityFactors),m=t.addObject(A),a.visualModel&&s.showError("Attempting to specify a visual model for the Spacecraft.addToScene() operation while a new one is also created!",s.ErrorSeverity.MINOR)):(A=a.visualModel||this.vMo,m=A.getNode()),!0===r.weapons)for(O={shaderName:a.shaderName},p=0;p<this._ws.length;p++)this._ws[p].addToSceneNow(m,n,o,O,_);if(!0===r.missilesInLaunchers)for(R={shaderName:a.shaderName,allMissiles:r.allMissilesInLaunchers},p=0;p<this._mLs.length;p++)this._mLs[p].addToSceneNow(m,n,o,R,d);if(!0===r.thrusterParticles&&this._propulsion&&this._propulsion.addToScene(m),!0===r.projectileResources)for(p=0;p<this._ws.length;p++)this._ws[p].addProjectileResourcesToScene(t);if(!0===r.missileResources)for(p=0;p<this._mLs.length;p++)this._mLs[p].addMissileResourcesToScene(t);if(!0===r.explosion&&(S=new E.Explosion(this._class._explosionClass,i.IDENTITY4,i.IDENTITY4,e.NULL3,!0),S.addResourcesToScene(t)),!0===r.cameraConfigurations&&this._addCameraConfigurationsForViews(),w&&!0===r.lightSources)for(T=this._class._lightSources,this._lights.length=0,C=[A],p=0;p<T.length;p++)T[p].spotDirection?(M=new h.SpotLightSource(T[p].color,T[p].intensity,T[p].position,T[p].spotDirection,T[p].spotCutoffAngle,T[p].spotFullIntensityAngle,C),this._lights.push(M),t.addSpotLightSource(M)):(M=new h.PointLightSource(T[p].color,T[p].intensity,T[p].position,C),t.addPointLightSource(M,f.SPACECRAFT_LIGHT_PRIORITY),this._lights.push(M));if(!0===r.blinkers)for(p=0;p<this._blinkers.length;p++)this._blinkers[p].addToScene(m,r.lightSources),a.randomAnimationTime&&(0===p?N=this._blinkers[p].setRandomTime():this._blinkers[p].setTime(N));this._away&&(this._away=!1,this.setAway(!0)),u&&u(A)}},M.prototype.addToScene=function(e,i,s,n,o,r,l,h){var u,_,d,p;if(n=n||t.EMPTY_OBJECT,o=o||t.EMPTY_OBJECT,!o.skipResources){if(this.acquireResources(!1,{omitShader:!!o.shaderName,explosion:n.explosion,damageIndicators:n.damageIndicators,blinkers:n.blinkers,sound:n.sound}),o.shaderName&&c.getShader(o.shaderName),!0===n.weapons)for(d={omitShader:!!o.shaderName,projectileResources:n.projectileResources,sound:n.sound},u=0;u<this._ws.length;u++)this._ws[u].acquireResources(d);if(!0===n.missileResources)for(p={omitShader:!!o.shaderName,missileOnly:!1,sound:n.sound,trail:!0},u=0;u<this._mLs.length;u++)this._mLs[u].acquireResources(p);else if(!0===n.missilesInLaunchers)for(p={omitShader:!!o.shaderName,missileOnly:!0,sound:n.sound},u=0;u<this._mLs.length;u++)this._mLs[u].acquireResources(p);if(!0===n.thrusterParticles&&this._propulsion&&(this._propulsion.addThrusters(this._class._thrusterSlots),this._propulsion.acquireResources({sound:n.sound})),!0===n.jumpEngine&&this._jumpEngine&&this._jumpEngine.acquireResources({sound:n.sound}),!0===n.shield&&this._shield&&this._shield.acquireResources({sound:n.sound}),!0===n.explosion&&this._class._explosionClass.acquireResources({sound:n.sound}),!0===n.blinkers)for(_=this._class._blinkerDescriptors,u=0;u<_.length;u++)_[u].acquireResources()}a.executeWhenReady(this.addToSceneNow.bind(this,e,i,s,n,o,r,l,h))},M.prototype.createCameraConfigurationForView=function(t){return t.createCameraConfiguration(this.vMo,p.getDefaultCameraBaseOrientation(),p.getDefaultCameraPointToFallback(),p.getDefaultCameraFOV(),p.getDefaultCameraSpan())},M.prototype._addCameraConfigurationsForViews=function(){var t;for(t=0;t<this._class._views.length;t++)this.vMo.getNode().addCameraConfiguration(this.createCameraConfigurationForView(this._class._views[t]))},M.prototype._updateScoreValue=function(){var t;for(this._scoreValue=this._class.getScoreValue(),t=0;t<this._ws.length;t++)this._scoreValue+=this._ws[t].getScoreValue();for(t=0;t<this._mLs.length;t++)this._scoreValue+=this._mLs[t].getScoreValue();this._propulsion&&(this._scoreValue+=this._propulsion.getScoreValue()),this._shield&&(this._scoreValue+=this._shield.getScoreValue())},M.prototype._addWeapon=function(t,e){var i,s=this._class._wSlots;(void 0===e||e<0)&&(e=this._ws.length),e<s.length&&(i=s[e],this._ws.push(new T.Weapon(t,this,i)))},M.prototype._setActiveMissileLauncherIndex=function(t){this._activeMissileLauncherIndex=t,this._tC.setMissileLauncher(this._activeMissileLauncherIndex>=0?this._mLs[this._activeMissileLauncherIndex]:null)},M.prototype._addMissiles=function(t,e,i){var s,n=this._class._mLs;(void 0===i||i<0)&&(i=this._mLs.length),i<n.length&&(s=n[i],this._mLs.push(new T.MissileLauncher(t,this,s,e)),this._activeMissileLauncherIndex<0&&this._setActiveMissileLauncherIndex(0),this._mClasses.indexOf(t)<0&&this._mClasses.push(t))},M.prototype._addPropulsion=function(t){this._propulsion=new T.Propulsion(t,this.pMo),this._mC.updateForNewPropulsion(),this._mC.updateTurningLimit(),this._topSpeed=r.getDrag()&&this._class._dragFactor?Math.sqrt(this.getMaxAcceleration()/(r.getDrag()*this._class._dragFactor)):0,this._updateBurnNeedFactors()},M.prototype._addJumpEngine=function(t){this._jumpEngine=new T.JumpEngine(t,this)},M.prototype._addShield=function(t){this._shield=new T.Shield(t,this)},M.prototype.unequip=function(){var t;for(t=0;t<this._ws.length;t++)this._ws[t].destroy();for(this._ws=[],t=0;t<this._mLs.length;t++)this._mLs[t].destroy();this._mLs=[],this._mClasses=[],this._setActiveMissileLauncherIndex(-1),this._propulsion&&this._propulsion.destroy(),this._propulsion=null,this._mC.updateForNewPropulsion(),this._mC.updateTurningLimit(),this._updateScoreValue()},M.prototype.equipLoadout=function(t){var e,i,s;if(t){for(i=t.getWeaponDescriptors(),e=0;e<i.length;e++)this._addWeapon(d.getWeaponClass(i[e].className),i[e].slotIndex);for(s=t.getMissileDescriptors(),e=0;e<s.length;e++)this._addMissiles(d.getMissileClass(s[e].className),s[e].amount,s[e].launcherIndex);null!==t.getPropulsionDescriptor()&&this._addPropulsion(d.getPropulsionClass(t.getPropulsionDescriptor().className)),null!==t.getJumpEngineDescriptor()&&this._addJumpEngine(d.getJumpEngineClass(t.getJumpEngineDescriptor().className)),null!==t.getShieldDescriptor()&&this._addShield(d.getShieldClass(t.getShieldDescriptor().className))}this._updateScoreValue()},M.prototype.getLoadoutNames=function(){return this._class.getLoadoutNames()},M.prototype.getSoundSourceForFireSound=function(){var t;return t=i.translationVector3(this.getPositionMatrixInCameraSpace()),Math.abs(t[0])<=N&&Math.abs(t[1])<=N&&Math.abs(t[2])<=N?null:this.getSoundSource()},M.prototype.fire=function(t){var e,i,s,n=!1;if(!this._firingDisabled){for(i=this.getScaledOriMatrix(),e=0;e<this._ws.length;e++)s=this._ws[e].fire(i,t,this.getSoundSourceForFireSound()),n=s>0||n,this._shotsFired+=s;if(n){for(e=0;e<this._tedBy.length;e++)this._tedBy[e].handleEvent(S.TARGET_FIRED);this.handleEvent(S.FIRED)}}},M.prototype._autoChangeMissileLauncher=function(){var t,e,i;t=this._activeMissileLauncherIndex,e=this._mLs[t]._class,i=this._mLs[t]._salvo;do{this._activeMissileLauncherIndex=(this._activeMissileLauncherIndex+1)%this._mLs.length}while(this._activeMissileLauncherIndex!==t&&(!this._mLs[this._activeMissileLauncherIndex].hasMissilesLeftToLaunch()||this._mLs[this._activeMissileLauncherIndex]._class!==e));if(this._activeMissileLauncherIndex===t&&!this._mLs[t].hasMissilesLeftToLaunch())do{this._activeMissileLauncherIndex=(this._activeMissileLauncherIndex+1)%this._mLs.length}while(this._activeMissileLauncherIndex!==t&&!this._mLs[this._activeMissileLauncherIndex].hasMissilesLeftToLaunch());this._activeMissileLauncherIndex===t?this._mLs[t].getMissileCount()<=0&&this._setActiveMissileLauncherIndex(-1):(this._setActiveMissileLauncherIndex(this._activeMissileLauncherIndex),this._mLs[this._activeMissileLauncherIndex]._class===e?this._mLs[this._activeMissileLauncherIndex].setSalvoMode(i):(this._mLs[this._activeMissileLauncherIndex].setMinimumCooldown(p.getBattleSetting(p.BS.MISSILE_AUTO_CHANGE_COOLDOWN)),p.getBattleSetting(p.BS.DEFAULT_SALVO_MODE)&&this._mLs[this._activeMissileLauncherIndex].setSalvoMode(!0),m.playMissileChangeSound()))},M.prototype.launchMissile=function(){var t,e,i;if(!this._firingDisabled&&this._activeMissileLauncherIndex>=0&&this._tC.isMissileLocked()){if(e=this.getScaledOriMatrix(),i=this._mLs[this._activeMissileLauncherIndex].launch(e,this.getSoundSourceForFireSound(),!1)){for(this._msLaunched++,t=0;t<this._tedBy.length;t++)this._tedBy[t].handleEvent(S.TARGET_FIRED);this.handleEvent(S.FIRED),this._autoChangeMissileLauncher()}return i}return null},M.prototype.handleSalvoMissileLaunched=function(){this._msLaunched++,this._activeMissileLauncherIndex>=0&&this._mLs[this._activeMissileLauncherIndex].getMissileCount()<=0&&this._autoChangeMissileLauncher()},M.prototype.changeMissile=function(){var t,e,i;if(this._activeMissileLauncherIndex>=0){t=this._activeMissileLauncherIndex,e=this._mLs[t]._class;do{this._activeMissileLauncherIndex=(this._activeMissileLauncherIndex+1)%this._mLs.length}while(this._activeMissileLauncherIndex!==t&&(!this._mLs[this._activeMissileLauncherIndex].hasMissilesLeftToLaunch()||this._mLs[this._activeMissileLauncherIndex]._class===e));return i=this._activeMissileLauncherIndex!==t,i&&(this._setActiveMissileLauncherIndex(this._activeMissileLauncherIndex),p.getBattleSetting(p.BS.DEFAULT_SALVO_MODE)&&this._mLs[this._activeMissileLauncherIndex].setSalvoMode(!0)),i}return!1},M.prototype.toggleSalvo=function(){return this._activeMissileLauncherIndex>=0&&this._mLs[this._activeMissileLauncherIndex].toggleSalvoMode()},M.prototype.getActiveMissileLauncher=function(){
return this._activeMissileLauncherIndex>=0?this._mLs[this._activeMissileLauncherIndex]:null},M.prototype.getMissileCount=function(t){var e,i=0;for(e=0;e<this._mLs.length;e++)this._mLs[e]._class===t&&(i+=this._mLs[e].getMissileCount());return i},M.prototype.increaseHitsOnEnemies=function(t){t?this._mHitsOnEnemies++:this._hitsOnEnemies++},M.prototype.setBeingTargeted=function(t){this._tedBy&&(this._tedBy.push(t),this.handleEvent(S.BEING_TARGETED,{spacecraft:t}))},M.prototype.setBeingUntargeted=function(t){this._tedBy&&this._tedBy.splice(this._tedBy.indexOf(t),1)},M.prototype.setTarget=function(t){this._tC.setTarget(t)},M.prototype.targetNextNearestHostile=function(){return this._tC.targetNextNearestHostile()},M.prototype.targetPreviousNearestHostile=function(){return this._tC.targetPreviousNearestHostile()},M.prototype.targetNextBestHostile=function(){return this._tC.targetNextBestHostile()},M.prototype.targetNextNearestNonHostile=function(){return this._tC.targetNextNearestNonHostile()},M.prototype.getTarget=function(){return this._tC.getTarget()},M.prototype.getTargetHitPosition=function(){return this._tC.getTargetHitPosition()},M.prototype.getMissileLockRatio=function(){return this._tC.getMissileLockRatio()},M.prototype.getPropulsionDisplayName=function(){return this._propulsion.getDisplayName()},M.prototype.resetThrusterBurn=function(){this._propulsion.resetThrusterBurn()},M.prototype.addThrusterBurn=function(t,e){this._propulsion.addThrusterBurn(t,e)},M.prototype.updatePropulsionVisuals=function(){this._propulsion.updateVisuals()},M.prototype.resetViewCameras=function(){this.vMo.getNode().resetCameraConfigurations()},M.prototype.damage=function(t,s,n,o,r,a){var l,h,u,c,_,d,p,g,m;if(this._shield&&(t=this._shield.damage(t)),t=Math.max(0,t-this._class._armor),_=this._hitpoints>0,this._hitpoints-=t,this._hitpoints<=0)_&&o&&this.isHostile(o)&&(d=this.getScoreValue(),t+=this._hitpoints,o.gainDamageDealt(t,r),o.gainScore((1-O)*t/this._maxHitpoints*d),o.gainScore(O*d),o.gainKill()),this._hitpoints=0;else{for(l=0;l<this._class._damageIndicators.length;l++)h=this._class._damageIndicators[l],u=h.hullIntegrity/100*this._maxHitpoints,this._hitpoints<=u&&this._hitpoints+t>u&&(a>0?(p=[0,0,0,1],m=this.pMo.getBodySize(),e.setSum3(p,s,e.scaled3(n,-m)),p=this.pMo.checkHitRelative(p,e.scaled3(n,-1),m,0),p||(g=e.scaled3(s,-1),m=e.extractLength3(g),p=this.pMo.checkHitRelative(e.NULL4W1,g,m,0)),!p||e.length3Squared(p,s)<.01?p=s:g&&(n=e.scaled3(g,-1))):p=s,c=E.getExplosion(),c.init(h.explosionClass,i.translation4vAux(p),i.IDENTITY4,n,!0),c.addToSceneNow(this.vMo.getNode(),this.getSoundSource()),this._activeDamageIndicators.push(c));_&&o&&o._alive&&this.isHostile(o)&&(o.gainDamageDealt(t,r),o.gainScore((1-O)*t/this._maxHitpoints*this.getScoreValue()))}this.handleEvent(S.BEING_HIT,{spacecraft:o,hitPosition:s}),o._alive&&!o._away&&(o.getTarget()===this&&o.handleEvent(S.TARGET_HIT),o.handleEvent(S.ANY_SPACECRAFT_HIT,{spacecraft:this})),this.isHostile(o)&&o.increaseHitsOnEnemies(r)},M.prototype.aimWeapons=function(t,e,i){var s,n,o=this.getTarget();for(o&&this._ws.length>0&&(s=this.getTargetHitPosition()),n=0;n<this._ws.length;n++)o&&!this._firingDisabled?this._ws[n].aimTowards(s,t,e,this.getScaledOriMatrix(),i):this._ws[n].rotateToDefaultPosition(t,i)},M.prototype.jumpOut=function(t){!this._away&&this._jumpEngine&&this._jumpEngine.jumpOut(t)},M.prototype.jumpIn=function(){this._away&&this._jumpEngine&&this._jumpEngine.jumpIn()},M.prototype._getSoundSourcePosition=function(){var t=this.getPositionMatrixInCameraSpace();return this._soundSourcePosition[0]=.1*Math.round(10*t[12]),this._soundSourcePosition[1]=.1*Math.round(10*t[13]),this._soundSourcePosition[2]=.1*Math.round(10*t[14]),this._soundSourcePosition},M.prototype.getSoundSource=function(){return this._soundSource||(this._soundSource=_.createSoundSource([0,0,0])),this._soundSource},M.prototype._startHumSound=function(){this._humSoundClip.setVolume(0),this._humSoundClip.play(),this._humSoundClip.rampVolume(this._humSoundVolume,.02,!0,!0)},M.prototype.respawn=function(t){var e;for(this._alive=!0,this._hitpoints=this._maxHitpoints,this._timeElapsedSinceDestruction=-1,this._humSoundClip&&this._startHumSound(),e=0;e<this._blinkers.length;e++)t?this._blinkers[e].setRandomTime():this._blinkers[e].setTime(0)},M.prototype.setHitpointsToZero=function(){this._hitpoints=0},M.DEFAULT_SIMULATE_PARAMS={controlThrusters:!0,applyThrusterForces:!0},M.prototype.simulate=function(t,e){var s,n;if(this._alive&&!this._away){if(e=e||M.DEFAULT_SIMULATE_PARAMS,this._tC.simulate(t),n=this._getSoundSourcePosition(),this.getSoundSource().setPosition(n[0],n[1],n[2]),this._hitpoints<=0){if(this._timeElapsedSinceDestruction<0)for(this._timeElapsedSinceDestruction=0,this._humSoundClip&&this._humSoundClip.stopPlaying(_.SOUND_RAMP_DURATION),this._propulsion&&(this._propulsion.resetThrusterBurn(),this._propulsion.simulate(0,this.getSoundSource(),!1)),this._explosion=E.getExplosion(),this._explosion.init(this._class._explosionClass,this.pMo.pM,this.pMo.oM,i.getRowC43(this.pMo.pM),!0,!0,this.pMo.getVelocityMatrix()),this._explosion.addToScene(this.vMo.getNode()._scene._rootNode,this.getSoundSource()),s=0;s<this._activeDamageIndicators;s++)this._activeDamageIndicators[s].finish();else if(this._timeElapsedSinceDestruction+=t,this._timeElapsedSinceDestruction>this._class._explosionClass.getTotalDuration()*this._class._showTimeRatioDuringExplosion)return this._alive=!1,void(!1!==this.handleEvent(S.DESTRUCTED)&&this.destroy(!0))}else{for(s=0;s<this._ws.length;s++)this._ws[s].simulate(t);for(s=0;s<this._mLs.length;s++)this._mLs[s].simulate(t),this._activeMissileLauncherIndex<0&&this._mLs[s].hasMissilesLeftToLaunch()&&this._setActiveMissileLauncherIndex(s);this._propulsion&&(e.controlThrusters&&this._mC.controlThrusters(t),this._propulsion.simulate(t,this._soundSource,e.applyThrusterForces)),this._jumpEngine&&this._jumpEngine.simulate(t),this._shield&&this._shield.simulate(t),this._class.hasHumSound()&&(this._humSoundClip||(this._humSoundClip=this._class.createHumSoundClip(this._soundSource),this._humSoundVolume=this._humSoundClip.getVolume(),this._humSoundClip&&this._startHumSound()))}this.pMo.simulate(t),this._relativeVelocityMatrixValid=!1,this._turningMatrixValid=!1,this.updateScaledOriMatrix(),this.vMo.setPositionMatrix(this.pMo.pM),this.vMo.setOrientationMatrix(this.pMo.oM),this._propulsion&&this._mC.updateSpeedIncrement(t)}},M.prototype.addEventHandler=function(t,e){this._eventHandlers[t]=this._eventHandlers[t]||[],this._eventHandlers[t].push(e)},M.prototype.handleEvent=function(t,e){var i,s;if(this._eventHandlers&&this._eventHandlers[t])for(s=!0,i=0;i<this._eventHandlers[t].length;i++)s=this._eventHandlers[t][i](e)&&s;return s},M.prototype.getMaxProjectileCount=function(){var t,e=0;for(t=0;t<this._ws.length;t++)e+=this._ws[t].getMaxProjectileCount();return e},M.prototype.getMaxMissileCount=function(){var t,e=0;for(t=0;t<this._mLs.length;t++)e+=this._mLs[t].getMaxMissileCount();return e},M.prototype.getMaxExplosionCount=function(){var t,e=0;for(e+=1,e+=this._class._damageIndicators.length,t=0;t<this._ws.length;t++)e+=this._ws[t].getMaxExplosionCount();for(t=0;t<this._mLs.length;t++)e+=this._mLs[t].getMaxExplosionCount();return e},M.prototype.getMaxParticleCount=function(){var t,e,i=0;for(i+=this._class._explosionClass.getMaxParticleCount(),e=this._class._damageIndicators,t=0;t<e.length;t++)i+=e[t].explosionClass.getMaxParticleCount();for(t=0;t<this._ws.length;t++)i+=this._ws[t].getMaxParticleCount();for(t=0;t<this._mLs.length;t++)i+=this._mLs[t].getMaxParticleCount();return i},M.prototype.getLockingTimeFactor=function(){return this._class.getLockingTimeFactor()},M.prototype.destroy=function(t){var e;if(t||(this._class=null),this._ws)for(e=0;e<this._ws.length;e++)this._ws[e]&&(this._ws[e].destroy(),this._ws[e]=null);if(this._ws=null,this._mLs)for(e=0;e<this._mLs.length;e++)this._mLs[e]&&(this._mLs[e].destroy(),this._mLs[e]=null);this._mLs=null,this._mClasses=null,this._propulsion&&(this._propulsion.destroy(),this._propulsion=null),this._jumpEngine&&(this._jumpEngine.destroy(),this._jumpEngine=null),this._shield&&(this._shield.destroy(),this._shield=null),this._mC&&(this._mC.destroy(),this._mC=null),this._tC&&(this._tC.destroy(),this._tC=null),this._tedBy=null,this._eventHandlers=null,this._explosion=null,this.vMo&&this.vMo.getNode()&&!this.vMo.getNode().canBeReused()&&this.vMo.getNode().markAsReusable(!0),this.vMo=null,this._lights=null,this.pMo=null,this._activeDamageIndicators&&(this._activeDamageIndicators=null),this._alive=!1,this._humSoundClip&&(this._humSoundClip.destroy(),this._humSoundClip=null),this._soundSource&&(this._soundSource=null)},p.executeWhenReady(function(){v=p.getSetting(p.GENERAL_SETTINGS.UNIFORM_LUMINOSITY_FACTORS_ARRAY_NAME),b=p.getSetting(p.GENERAL_SETTINGS.UNIFORM_GROUP_TRANSFORMS_ARRAY_NAME),C=p.getSetting(p.BS.HITBOX_COLOR),N=p.getSetting(p.BS.WEAPON_FIRE_SOUND_STACK_MINIMUM_DISTANCE),O=p.getSetting(p.BS.SCORE_FRACTION_FOR_KILL),I(),c.executeWhenReady(y),c.onSettingsChange(y)}),{SpacecraftFormation:L,resetRandomSeed:I,Spacecraft:M}}),define("armada/logic/ai",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/physics","armada/configuration","armada/logic/SpacecraftEvents","armada/logic/classes","armada/logic/spacecraft","armada/logic/equipment","utils/polyfill"],function(t,e,i,s,n,o,r,a,l,h){"use strict";function u(){return Object.keys(m)}function c(t,e){this._sc=t,this._mission=e,this._standingDown=!1,this._tList=null,this._priorityTargets=!1,this._hitCountByNonTarget=0,this._wRange=this._sc&&this._sc._ws.length>0?this._sc._ws[0].getRange():0,this._attackingTarget=!1,this._sc&&(this._sc.setSpeedHolding(!0),this._sc.addEventHandler(r.BEING_HIT,this._handleBeingHit.bind(this)),this._sc.addEventHandler(r.COMMAND_RECEIVED,this._handleCommand.bind(this)))}function _(t,e){var i=e._pilotedCraft&&e._pilotedCraft.isHostile(t)?e.getDifficultyLevel().getEnemyReactionTimeFactor():1;c.call(this,t,e),this._timeSinceLastRoll=0,this._timeSinceLastTargetHit=0,this._timeSinceLastClosingIn=0,this._evasiveManeuverDelayLeft=0,this._evasiveManeuverDelay=O*i,this._evasiveManeuverTime=-1,this._evasiveVelocityVector=[0,0],this._rollTime=-1,this._chargePhase=E.NONE,this._chargeDestination=[0,0,0],this._maxDistanceFactor=A,this._isBlockedBy=null,this._facingTarget=!1,this._tDistance=0,this._tOffset=[0,0,0],this._tOffsetUpdateTimeLeft=0,this._maxAimError=0,this._aimError=[0,0],this._fireDelayLeft=0,this._fireDelay=N*i,this._msOnTarget=[],this._sc.addEventHandler(r.TARGET_HIT,this._handleTargetHit.bind(this)),this._sc.addEventHandler(r.ANY_SPACECRAFT_HIT,this._handleAnySpacecraftHit.bind(this)),this._sc.addEventHandler(r.TARGET_FIRED,this._handleTargetFired.bind(this))}function d(t,e){c.call(this,t,e)}function p(){this._ais=[]}var g,m,f,S={JUMP:"jump",TARGET:"target",STAND_DOWN:"standDown"},T={IN:"in",OUT:"out"},E={NONE:-1,APPROACH_ATTACK:0,EVADE:1},y=1e3/n.ANGULAR_VELOCITY_MATRIX_DURATION,I=Math.radians(45),A=.3,M=Math.radians(45),C=Math.radians(2),N=350,O=200,R=0,L=0;return c.prototype.turn=function(t,i,s){var n,o,r,a,l;n=this._sc.getTurningMatrix(),r=this._sc.getMaxAngularAcceleration(),l=L/(r*s),o=Math.sign(n[4])*e.angle2y(n[4],n[5])*y,a=Math.max(o*o/(2*r),.001),t>a?this._sc.yawLeft(Math.min(Math.max(0,l*(t-a)),1)):t<-a&&this._sc.yawRight(Math.min(Math.max(0,l*(-t-a)),1)),o=Math.sign(n[6])*e.angle2x(n[5],n[6])*y,a=Math.max(o*o/(2*r),.001),i>a?this._sc.pitchUp(Math.min(Math.max(0,l*(i-a)),1)):i<-a&&this._sc.pitchDown(Math.min(Math.max(0,l*(-i-a)),1))},c.prototype.rollAndYaw=function(t,i,s){var n,o,r,a,l;n=this._sc.getTurningMatrix(),r=this._sc.getMaxAngularAcceleration(),l=L/(r*s),o=Math.sign(n[2])*e.angle2x(n[0],n[2])*y,a=Math.max(o*o/(2*r),.001),t>a?this._sc.rollLeft(Math.min(Math.max(0,l*(t-a)),1)):t<-a&&this._sc.rollRight(Math.min(Math.max(0,l*(-t-a)),1)),o=Math.sign(n[4])*e.angle2y(n[4],n[5])*y,a=Math.max(o*o/(2*r),.001),i>a?this._sc.yawLeft(Math.min(Math.max(0,l*(i-a)),1)):i<-a&&this._sc.yawRight(Math.min(Math.max(0,l*(-i-a)),1))},c.prototype.rollAndPitch=function(t,i,s){var n,o,r,a,l;n=this._sc.getTurningMatrix(),r=this._sc.getMaxAngularAcceleration(),l=L/(r*s),o=Math.sign(n[2])*e.angle2x(n[0],n[2])*y,a=Math.max(o*o/(2*r),.001),t>a?this._sc.rollLeft(Math.min(Math.max(0,l*(t-a)),1)):t<-a&&this._sc.rollRight(Math.min(Math.max(0,l*(-t-a)),1)),o=Math.sign(n[6])*e.angle2x(n[5],n[6])*y,a=Math.max(o*o/(2*r),.001),i>a?this._sc.pitchUp(Math.min(Math.max(0,l*(i-a)),1)):i<-a&&this._sc.pitchDown(Math.min(Math.max(0,l*(-i-a)),1))},c.prototype.approach=function(t,e,i,s){var n,o;n=this._sc.getRelativeVelocityMatrix()[13],o=n*n/(2*this._sc.getMaxAcceleration()),n<0&&(o=-o),t-o>e?this._sc.setSpeedTarget(s):i>=0&&t-o<i?this._sc.setSpeedTarget(-s):this._sc.resetSpeed()},c.prototype._handleTargetSwitch=function(){this._hitCountByNonTarget=0},c._tListFilterFunction=function(t){return t._alive},c.prototype._updateTarget=function(t){var e,i;if(this._standingDown)return void this._sc.setTarget(null);if(i=this._sc.getTarget(),this._tList&&(this._tList=this._tList.filter(c._tListFilterFunction)),this._tList&&this._tList.length>0){if(this._priorityTargets){if(t)this._tList.indexOf(t)>=0&&this._sc.setTarget(t);else if(!i||this._tList.indexOf(i)<0){for(e=0;e<this._tList.length;e++)if(!this._tList[e]._away){this._sc.setTarget(this._tList[e]);break}!i&&e>=this._tList.length&&this._sc.targetNextBestHostile()}}else if(t)this._sc.setTarget(t);else if(!i){for(e=0;e<this._tList.length;e++)if(!this._tList[e]._away){this._sc.setTarget(this._tList[e]);break}e>=this._tList.length&&this._sc.targetNextBestHostile()}}else t?this._sc.setTarget(t):i||this._sc.targetNextBestHostile();this._sc.getTarget()!==i&&this._handleTargetSwitch()},c.prototype._handleBeingHit=function(t){var e=t.spacecraft;this._sc&&!this._sc.canBeReused()&&!e.canBeReused()&&!e._away&&e.isHostile(this._sc)&&this._sc.getTarget()&&this._sc.getTarget()!==e&&(this._sc.getTarget().getTarget()===this._sc&&this._attackingTarget||this._updateTarget(e),this._hitCountByNonTarget++)},c.prototype._handleCommand=function(n){var o,r,a;switch(n.command){case S.JUMP:if((n.jump&&n.jump.way?n.jump.way:this._sc._away?T.IN:T.OUT)===T.IN){if(this._sc._away){if(n.jump)if(n.lead&&n.index>0&&n.jump.formation)this._sc.setPhysicalPosition(l.Spacecraft.getPositionInFormation(n.jump.formation,n.index,n.lead.getPhysicalPositionVector(),n.lead.pMo.oM)),this._sc.setPhysicalOrientationMatrix(i.matrix4(n.lead.pMo.oM));else if(n.jump.anchor)if(n.clearCache&&(n.jump.anchorSpacecraft=null,n.clearCache=!1),r=n.jump.anchorSpacecraft||this._mission.getSpacecraft(n.jump.anchor))n.jump.anchorSpacecraft=r,n.jump.distance?(this._sc.setPhysicalOrientationMatrix(i.prod3x3SubOf4(i.rotationX4Aux((g()-.5)*Math.PI),i.rotationZ4Aux(g()*t.DOUBLE_PI))),this._sc.setPhysicalPosition(e.scaled3(i.getRowB4(this._sc.pMo.oM),-n.jump.distance))):(n.jump.position&&this._sc.setPhysicalPosition(n.jump.position),n.jump.rotations&&this._sc.setPhysicalOrientationMatrix(i.rotation4FromJSON(n.jump.rotations))),n.jump.relative&&(this._sc.setPhysicalPositionMatrix(i.prodTranslationRotation4(this._sc.pMo.pM,r.pMo.oM)),this._sc.setPhysicalOrientationMatrix(i.prod4(this._sc.pMo.oM,r.pMo.oM))),this._sc.setPhysicalPosition(e.sum3(this._sc.getPhysicalPositionVector(),r.getPhysicalPositionVector()));else{if(!n.jump.fallbackPosition)break;this._sc.setPhysicalPosition(n.jump.fallbackPosition),n.jump.fallbackRotations&&this._sc.setPhysicalOrientationMatrix(i.rotation4FromJSON(n.jump.fallbackRotations))}this._sc.jumpIn()}}else this._sc.jumpOut(!1);break;case S.TARGET:if(n.target){if(n.clearCache&&(n.target.targetSpacecrafts=null,n.clearCache=!1),n.target.targetSpacecrafts)this._tList=n.target.targetSpacecrafts.slice();else{if(n.target.single)(a=this._mission.getSpacecraft(n.target.single))&&(this._tList=[a]);else if(n.target.list)for(this._tList=[],o=0;o<n.target.list.length;o++)(a=this._mission.getSpacecraft(n.target.list[o]))&&this._tList.push(a);else if(n.target.squads)for(this._tList=[],o=0;o<n.target.squads.length;o++)this._tList=this._tList.concat(this._mission.getSpacecraftsInSquad(n.target.squads[o]));else n.target.none?this._tList=null:s.showError("'"+this._sc.getDisplayName()+"' has no target specified for targeting command!");this._tList&&(n.target.targetSpacecrafts=this._tList.slice())}this._tList&&this._tList.length>0?(this._sc.setTarget(this._tList[0]),this._standingDown=!1):n.target.none&&this._sc.setTarget(null),this._priorityTargets=!0===n.target.priority}break;case S.STAND_DOWN:this._standingDown=!0;break;default:s.showError("Unknown spacecraft command: '"+n.command+"'!")}},_.prototype=new c,_.prototype.constructor=_,_.prototype._updateAimError=function(){this._aimError[0]=2*(Math.random()-.5)*this._maxAimError,this._aimError[1]=2*(Math.random()-.5)*this._maxAimError},_.prototype._startNewAttackRun=function(){this._chargePhase=E.NONE,this._sc.changeFlightMode(h.FlightMode.COMBAT),this._hitCountByNonTarget=0,this._timeSinceLastTargetHit=0,this._timeSinceLastClosingIn=0,this._timeSinceLastRoll=0,this._maxDistanceFactor=A,this._isBlockedBy=null,this._rollTime=-1,this._tOffset=[0,0,0],this._tOffsetUpdateTimeLeft=1500,this._maxAimError=C,this._fireDelayLeft=this._fireDelay,this._updateAimError()},_.prototype._handleTargetSwitch=function(){c.prototype._handleTargetSwitch.call(this),this._msOnTarget.length=0,this._startNewAttackRun()},_.prototype._triggerEvasiveManeuver=function(){return this._evasiveManeuverTime<0&&(this._evasiveManeuverDelayLeft=this._evasiveManeuverDelay,this._evasiveManeuverTime=0,!0)},_.prototype._handleBeingHit=function(t){this._isBlockedBy||this._triggerEvasiveManeuver()&&(this._evasiveVelocityVector[0]=-t.hitPosition[0],this._evasiveVelocityVector[1]=-t.hitPosition[2],e.normalize2(this._evasiveVelocityVector)),c.prototype._handleBeingHit.call(this,t)},_.prototype._handleTargetHit=function(){this._timeSinceLastTargetHit=0},_.prototype._handleAnySpacecraftHit=function(t){var e=t.spacecraft;!this._sc||this._sc.canBeReused()||e===this._sc||this._chargePhase===E.EVADE||e===this._sc.getTarget()||this._isBlockedBy&&!this._isBlockedBy.isHostile(this._sc)||(this._isBlockedBy=e,this._evasiveManeuverTime=-1,this._chargePhase=E.NONE,this._sc.changeFlightMode(h.FlightMode.COMBAT))},_.prototype._handleTargetFired=function(){var i;!this._isBlockedBy&&this._facingTarget&&this._sc&&this._sc.getTarget()&&this._sc.getTarget().getTarget()===this._sc&&this._tDistance>.5*this._wRange&&this._triggerEvasiveManeuver()&&(i=Math.random()*t.DOUBLE_PI,this._evasiveVelocityVector[0]=1,this._evasiveVelocityVector[1]=0,e.rotate2(this._evasiveVelocityVector,i))},_.prototype.handleSceneMoved=function(t){e.add3(this._chargeDestination,t)},_.prototype.control=function(s){var n,o,r,a,l,u,c,_,d,p,g,m,f,S,T,y,A,N,O,L,x,v,b,D,w,F,P,V,U,B,H,G,j;if(this._sc){if(this._sc.canBeReused())return void(this._sc=null);if(this._sc._away)return;for(H=!1,this._updateTarget(),y=this._sc.getMaxAcceleration(),f=this._sc.vMo.getScaledSize(),r=i.translationVector3(this._sc.pMo.pM),j=i.inverseOfRotation4Aux(this._sc.pMo.oM),O=this._sc.getRelativeVelocityMatrix()[13],n=this._sc.getTarget(),this._attackingTarget=!1,p=0;p<this._msOnTarget.length;p++)this._msOnTarget[p].getTarget()!==n&&(this._msOnTarget.splice(p,1),p--);if(this._chargePhase===E.EVADE)this._attackingTarget=!!n,l=e.diff3(this._chargeDestination,r),_=e.prodVec3Mat4Aux(l,j),this._tDistance=e.extractLength3(_),U=e.getYawAndPitch(_),this.turn(U.yaw,U.pitch,s),this._sc.setSpeedTarget(2*y),(this._tDistance<=1||_[1]<0||O<0)&&this._startNewAttackRun();else if(n)if(a=i.translationVector3(n.pMo.pM),this._tOffsetUpdateTimeLeft<=0?(this._tOffsetUpdateTimeLeft=1500,u=e.diff3(this._sc.getTargetHitPosition(),a),e.length3Squared(e.diff3(this._tOffset,u))<625?this._maxAimError*=.5:this._maxAimError=C,this._tOffset=u,this._updateAimError()):this._tOffsetUpdateTimeLeft-=s,e.add3(a,this._tOffset),l=e.diff3(a,r),_=e.prodVec3Mat4Aux(l,j),this._tDistance=e.extractLength3(_),U=e.getYawAndPitch(_),U.yaw+=this._aimError[0],U.pitch+=this._aimError[1],this._facingTarget=Math.abs(U.yaw)<I&&Math.abs(U.pitch)<I,this.turn(U.yaw,U.pitch,s),this._isBlockedBy&&(B=!1,!this._isBlockedBy.canBeReused()&&this._facingTarget&&this._isBlockedBy.pMo.checkHit(a,l,1e3,f/2)&&(d=e.prodVec3Mat4Aux(e.diff3Aux(i.translationVector3(this._isBlockedBy.pMo.pM),r),j),L=1*y,d[0]<0?(this._sc.strafeRight(L),B=!0):(this._sc.strafeLeft(L),B=!0),d[2]>0?(this._sc.lower(L),B=!0):(this._sc.raise(L),B=!0)),B||(this._isBlockedBy=null,this._sc.stopLeftStrafe(),this._sc.stopRightStrafe(),this._sc.stopLower(),this._sc.stopRaise()),H=!0),(G=this._sc._ws)&&G.length>0){if(S=n.vMo.getScaledSize(),T=Math.atan(.25*S/this._tDistance),P=G[0].getProjectileVelocity()+O,g=this._tDistance/P*1e3,v=G[0].getCooldown(),this._sc.aimWeapons(.001,T,s),this._facingTarget||(this._timeSinceLastClosingIn=0,this._timeSinceLastTargetHit=0,this._hitCountByNonTarget=0),e.length3(e.diff3Aux(this._sc.getTargetHitPosition(),r))<=G[0].getRange(O)?(this._attackingTarget=!0,Math.abs(U.yaw)<T&&Math.abs(U.pitch)<T&&(!this._isBlockedBy||this._isBlockedBy.isHostile(this._sc))?this._fireDelayLeft>0?this._fireDelayLeft-=s:(this._sc.fire(),this._isBlockedBy||(this._timeSinceLastRoll+=s,this._timeSinceLastTargetHit+=s,this._timeSinceLastClosingIn+=s,D=g+3*v,this._timeSinceLastRoll>D&&this._timeSinceLastTargetHit>D&&(this._rollTime=0),this._rollTime>=0&&(this._sc.rollLeft(),this._timeSinceLastRoll=0,this._rollTime+=s,w=this._sc.getMaxAngularAcceleration(),F=w*R,b=M>F*R?R+(M-F*R)/F:Math.sqrt(4*M/w)/2,this._rollTime>1e3*b&&(this._rollTime=-1)))):(this._timeSinceLastRoll=0,this._fireDelayLeft=this._fireDelay)):(this._timeSinceLastRoll=0,this._fireDelayLeft=this._fireDelay),this._sc.getActiveMissileLauncher())if(this._sc.getActiveMissileLauncher()._class._antiShip===n.isFighter())this._sc.changeMissile();else{for(m=n._hitpoints+n.getShieldCapacity(),p=0;p<this._msOnTarget.length;p++)m-=this._msOnTarget[p].getClass().getDamage(0);m>0&&(o=this._sc.launchMissile())&&this._msOnTarget.push(o)}this._chargePhase===E.NONE&&(this._hitCountByNonTarget>=4||this._timeSinceLastTargetHit>g+15*v)&&(this._chargePhase=E.APPROACH_ATTACK,this._sc.changeFlightMode(h.FlightMode.CRUISE)),this._chargePhase===E.NONE?(V=g+5*v,this._timeSinceLastClosingIn>V&&this._timeSinceLastTargetHit>V&&this._maxDistanceFactor>.125&&(this._maxDistanceFactor=Math.max(this._maxDistanceFactor-.05,.125),this._timeSinceLastClosingIn=0),x=.5*(f+S),N=x+this._maxDistanceFactor*this._wRange,A=x+.06*this._wRange,this._facingTarget?this.approach(this._tDistance,N,A,2*y):this._sc.resetSpeed()):this._chargePhase===E.APPROACH_ATTACK&&(N=Math.sqrt(2*(S+.5*f)/y)*y*4,this._facingTarget?(this._sc.setSpeedTarget(4*y),this._tDistance<=N&&(this._chargePhase=E.EVADE,this._sc.changeFlightMode(h.FlightMode.COMBAT),c=e.normal3(l),this._chargeDestination=e.sum3(r,e.scaled3(e.diff3(e.sum3(a,e.scaled3(e.normalize3(e.prodVec3Mat3Aux(e.perpendicular3(c),i.rotation3Aux(c,Math.random()*t.DOUBLE_PI))),N)),r),1)))):(this._chargePhase=E.NONE,this._sc.changeFlightMode(h.FlightMode.COMBAT),this._sc.resetSpeed()))}else this._sc.resetSpeed();else this._facingTarget=!1,this._tDistance=0,this._sc.resetSpeed(),this._sc.aimWeapons(.001,0,s);H||(this._evasiveManeuverTime>=0&&this._evasiveManeuverDelayLeft<=0?(0===this._evasiveManeuverTime&&(this._evasiveVelocityVector[0]*=1*y,this._evasiveVelocityVector[1]*=1*y,e.rotate2(this._evasiveVelocityVector,(Math.random()-.5)*Math.PI)),this._evasiveVelocityVector[0]>0?this._sc.strafeRight(this._evasiveVelocityVector[0]):this._evasiveVelocityVector[0]<0?this._sc.strafeLeft(-this._evasiveVelocityVector[0]):(this._sc.stopLeftStrafe(),this._sc.stopRightStrafe()),this._evasiveVelocityVector[1]>0?this._sc.raise(this._evasiveVelocityVector[1]):this._evasiveVelocityVector[1]<0?this._sc.lower(-this._evasiveVelocityVector[1]):(this._sc.stopLower(),this._sc.stopRaise()),this._evasiveManeuverTime+=s,this._evasiveManeuverTime>1e3&&(this._evasiveManeuverTime=-1)):(this._evasiveManeuverDelayLeft>0&&(this._evasiveManeuverDelayLeft-=s),this._sc.stopLeftStrafe(),this._sc.stopRightStrafe(),this._sc.stopLower(),this._sc.stopRaise()))}},d.prototype=new c,d.prototype.constructor=d,d.prototype.handleSceneMoved=function(){},d.prototype.control=function(s){var n,o,r,l,h,u,c,_,d,p,g,m,f,S,T,E,y,A,M,C,N;if(this._sc){if(this._sc.canBeReused())return void(this._sc=null);if(this._sc._away)return;if(this._updateTarget(),m=this._sc.getMaxAcceleration(),d=this._sc.vMo.getScaledSize(),o=i.translationVector3(this._sc.pMo.pM),N=i.inverseOfRotation4Aux(this._sc.pMo.oM),n=this._sc.getTarget(),this._attackingTarget=!1,n){if(M=n.isHostile(this._sc),r=i.translationVector3(n.pMo.pM),l=e.diff3(r,o),h=e.prodVec3Mat4(l,N),_=e.extractLength3(h),M&&(E=e.getYawAndPitch(h),A=Math.abs(E.yaw)<I&&Math.abs(E.pitch)<I),(C=this._sc._ws)&&C.length>0)if(p=n.vMo.getScaledSize(),g=Math.atan(.25*p/_),M&&(S=.25*d,f=S+.9*this._wRange),this._sc.aimWeapons(.001,g,s),M){if(A?this.approach(_,f,0,2*m):this._sc.resetSpeed(),_>f)this.turn(E.yaw,E.pitch,s);else switch(u=this._sc.getClass()._attackVectorAngles,T=this._sc.getClass()._attackThresholdAngle,this._sc.getClass()._turnStyle){case a.SpacecraftTurnStyle.YAW_PITCH:(Math.abs(E.yaw-u[0])>T||Math.abs(E.pitch-u[1])>T)&&this.turn(E.yaw-u[0],E.pitch-u[1],s);break;case a.SpacecraftTurnStyle.ROLL_YAW:y=e.getRollAndYaw(h,!0),c=[y.roll-u[0],y.yaw-u[1]],(Math.abs(c[0])>T||Math.abs(c[1])>T)&&(Math.abs(c[1])>t.HALF_PI?c[0]=0:Math.abs(c[0])>t.HALF_PI&&(c[1]=0),this.rollAndYaw(c[0],c[1],s));break;case a.SpacecraftTurnStyle.ROLL_PITCH:y=e.getRollAndPitch(h,!0),c=[y.roll-u[0],y.pitch-u[1]],(Math.abs(c[0])>T||Math.abs(c[1])>T)&&(Math.abs(c[1])>t.HALF_PI?c[0]=0:Math.abs(c[0]-Math.sign(c[0])*Math.PI)<Math.abs(c[0])&&(c[0]-=Math.sign(c[0])*Math.PI,y.pitch=-y.pitch),this.rollAndPitch(c[0],y.pitch-u[1],s))}e.length3(e.diff3(this._sc.getTargetHitPosition(),o))-S<=C[0].getRange(this._sc.getRelativeVelocityMatrix()[13])&&(this._sc.fire(!0),this._attackingTarget=!0)}else this._sc.resetSpeed()}else this._sc.resetSpeed(),this._sc.aimWeapons(.001,0,s)}},p.prototype.clearAIs=function(){this._ais=[]},p.prototype.addAI=function(t,e,i){this._ais.push(new m[t](e,i))},p.prototype.control=function(t){var e;for(e=0;e<this._ais.length;e++)this._ais[e].control(t)},p.prototype.handleSceneMoved=function(t){var e;for(e=0;e<this._ais.length;e++)this._ais[e].handleSceneMoved(t)},m={},m.fighter=_,m.ship=d,f=new p(m),o.executeWhenReady(function(){R=o.getSetting(o.BS.TURN_ACCELERATION_DURATION_S),L=1e3/R,g=Math.seed(Math.random())}),{FIGHTER_AI_NAME:"fighter",SHIP_AI_NAME:"ship",SpacecraftCommand:S,JumpCommandWay:T,getAITypes:u,clearAIs:f.clearAIs.bind(f),addAI:f.addAI.bind(f),control:f.control.bind(f),handleSceneMoved:f.handleSceneMoved.bind(f)}}),define("armada/logic/missions",["utils/utils","utils/types","utils/matrices","modules/application","modules/game","modules/async-resource","modules/resource-manager","modules/media-resources","modules/pools","modules/egom-model","modules/physics","modules/scene/camera","modules/scene/renderable-objects","armada/constants","armada/graphics","armada/logic/classes","armada/configuration","armada/strings","armada/logic/constants","armada/logic/environments","armada/logic/SpacecraftEvents","armada/logic/spacecraft","armada/logic/equipment","armada/logic/explosion","armada/logic/ai","utils/polyfill"],function(t,e,i,s,n,o,r,a,l,h,u,c,_,d,p,g,m,f,S,T,E,y,I,A,M){"use strict";function C(t){this._name=null,this._faction=null,this._displayNameReplacements={index:-1},this._color=null,"string"==typeof t?(this._name=t,this._faction=t):"object"==typeof t?(this._name=t.name||t.faction||s.showError("Team defined without a name or faction!"),this._faction=t.faction,this._displayNameReplacements.index=t.index,this._color=t.color||null):s.showError("Invalid parameter specified for Team constructor!"),this._initialCount=0,this._squads=[]}function N(t,e,i,s){this._objects=t,this._center=null,this._boundaries=null,this._objects.length>0&&this._calculateCenter(s),this._subnodes=e>0&&this._objects.length>i?this._generateSubnodes(e-1,i):null}function O(t){this._descriptor=t||{},this._scs=null,this._shortString=null}function R(e){this._type=e?t.getSafeEnumValue(nt,e.type,null):null,this._subjects=e?new O(e.subjects):null,e&&this._checkParams(e.params)}function L(t){R.call(this,t)}function x(t){R.call(this,t)}function v(t){R.call(this,t),this._running=!this._params||!this._params.start,this._trigger=null,this._timeElapsed=this._params?this._params.startValue||0:0,this._count=0,this._canBeImpossible=!!this._params&&(this._params.when===at.BEFORE||this._params.when===at.WITHIN||this._params.when===at.ONCE||this._params.when===at.REPEAT&&this._params.maxCount),this._before=!!this._params&&this._params.when===at.BEFORE,this._impossible=!1}function b(t){return new(tt[t.type]||R)(t)}function D(e){var i,n,o
;if(this._conditions=null,e.conditions&&e.conditions.length>0)for(this._conditions=[],i=0;i<e.conditions.length;i++)this._conditions.push(b(e.conditions[i]));if(o=t.getSafeEnumValue(it,e.which,it.ALL),this._all=o===it.ALL,n=t.getSafeEnumValue(st,e.when,st.BECOMES_TRUE),this._falsy=n===st.BECOMES_FALSE,this._all||(this._falsy=!this._falsy),this._once=!0,void 0!==e.once)this._once=e.once;else if(this._conditions)for(i=0;i<this._conditions.length;i++)if(this._conditions[i].canChangeMultipleTimes()){this._once=!1;break}if(this._delay=e.delay||0,this._countDown=!1,this._onFireHandlers=[],this._previousConditionState=!1,this._fired=!1,this._canBeImpossible=!0,!this._falsy&&this._conditions)for(this._canBeImpossible=!this._all,i=0;i<this._conditions.length;i++)if(this._conditions[i].canBeImpossible()){this._canBeImpossible=this._all;break}this._conditions||this._once||(s.showError("A trigger has no conditions, 'once' cannot be set to false!"),this._once=!0),!this._once&&this._delay&&(s.showError("Triggers without 'once' cannot have delays!"),this._delay=0)}function w(e,i){this._type=e?t.getSafeEnumValue(lt,e.type,null):null,this._delay=e?e.delay||0:0,this._trigger=i,this._trigger&&this._trigger.addFireHandler(this._addToExecutionQueue.bind(this)),this._subjects=e?new O(e.subjects):null,e&&this._checkParams(e.params)}function F(t,e){w.call(this,t,e)}function P(t,e){w.call(this,t,e)}function V(t,e){w.call(this,t,e)}function U(t,e){w.call(this,t,e)}function B(t,e){w.call(this,t,e)}function H(t,e){w.call(this,t,e)}function G(t){var e;for(this._name=t.name,this._trigger=new D(t.trigger),this._actions=[],e=0;e<t.actions.length;e++)this._actions.push(new(et[t.actions[e].type]||w)(t.actions[e],this._trigger))}function j(t){this._name=t,this._nextMissionName=null,this._environment=null,this._ownsEnvironment=!1,this._anticipationTheme=null,this._combatTheme=null,this._views=null,this._teams=null,this._events=null,this._actionQueue=null,this._winActions=null,this._loseActions=null,this._scs=null,this._pilotedCraft=null,this._hitObjects=null,this._state=ht.NONE,this._defaultObjective=!0,this._objectivesState=null,this._referenceScore=0,this._tSpacecrafts=null,this._escortedSpacecrafts=null,this._difficultyLevel=null}function k(t,e){r.JSONResource.call(this,t,e,!0),this._test=!0===this._dataJSON.test,this._custom=!0===this._dataJSON.custom,this._pilotedSpacecraftDescriptor=null,this._localData=JSON.parse(localStorage[this._getLocalStorageID()]||"{}"),this._initLocalData()}function W(t){this._name=t.name,this._playerHitpointsFactor=t.playerHitpointsFactor,this._friendlyHitpointsFactor=t.friendlyHitpointsFactor,this._enemyReactionTimeFactor=t.enemyReactionTimeFactor,this._playerSelfDamage=t.playerSelfDamage,this._playerFriendlyFireDamage=t.playerFriendlyFireDamage,this._hitboxOffset=t.hitboxOffset}function X(t){this._name=t.name,this._referenceBaseScoreFactor=t.referenceBaseScoreFactor,this._referenceHitRatio=t.referenceHitRatio,this._referenceHullIntegrity=t.referenceHullIntegrity,this._referenceTeamSurvival=t.referenceTeamSurvival}function Y(){o.AsyncResource.call(this),this._difficulty=null,this._difficultyLevels=null,this._missionPerformanceLevels=null,this._tipIDs=null,this._missionManager=new r.ResourceManager}var z,q,Q,J,K,Z,$,tt,et,it={ALL:"all",ANY:"any"},st={BECOMES_TRUE:"becomesTrue",BECOMES_FALSE:"becomesFalse"},nt={DESTROYED:"destroyed",COUNT:"count",TIME:"time"},ot={ALL:"all",ANY:"any"},rt={BELOW:"below",ABOVE:"above",EQUALS:"equals"},at={BEFORE:"before",AFTER:"after",WITHIN:"within",ONCE:"once",REPEAT:"repeat"},lt={MESSAGE:"message",CLEAR_MESSAGES:"clearMessages",COMMAND:"command",HUD:"hud",WIN:"win",LOSE:"lose"},ht={NONE:0,BATTLE:1,IN_PROGRESS:2,COMPLETED:3,FAILED:4,DEFEAT:5,ENDED:6},ut={IN_PROGRESS:0,COMPLETED:1,FAILED:2},ct=d.LOCAL_STORAGE_PREFIX+"missions_",_t=ct+"difficulty",dt=null;return Object.freeze(it),Object.freeze(st),Object.freeze(nt),Object.freeze(at),Object.freeze(lt),Object.freeze(ht),C.prototype.getDisplayName=function(){return t.formatString(f.get(f.FACTION.PREFIX,this._faction,this._faction||this._name),this._displayNameReplacements)},C.prototype.getInitialCount=function(){return this._initialCount},C.prototype.addSpacecraft=function(t){var e,i,n=t._squad;if(t.setTeam(this),n){for(e=0;e<this._squads.length;e++)if(n===this._squads[e].name){this._squads[e].crafts.push(t);break}e>=this._squads.length&&this._squads.push({name:n,crafts:[t]}),i=m.gHS(m.BS.HUD.WINGMEN_STATUS_CRAFT_POSITIONS).length,this._squads[e].crafts.length>i&&s.showError("Warning: squad '"+n+"' of team '"+this._name+"' has more than "+i+" members, and thus cannot be displayed correctly in the wingmen status panel!")}this._initialCount++},N.prototype._calculateCenter=function(t){var e,i,s,n,o=0,r=0,a=0;for(t&&(s=this._objects[0].pMo.pM,n=this._objects[0].pMo.getSize(),this._boundaries=[[s[0]-n,s[0]+n],[s[1]-n,s[1]+n],[s[2]-n,s[2]+n]]),e=0,i=this._objects.length;e<i;e++)s=this._objects[e].pMo.pM,o+=s[12],r+=s[13],a+=s[14],t&&(n=this._objects[e].pMo.getSize(),s[12]-n<this._boundaries[0][0]&&(this._boundaries[0][0]=s[12]-n),s[12]+n>this._boundaries[0][1]&&(this._boundaries[0][1]=s[12]+n),s[13]-n<this._boundaries[1][0]&&(this._boundaries[1][0]=s[13]-n),s[13]+n>this._boundaries[1][1]&&(this._boundaries[1][1]=s[13]+n),s[14]-n<this._boundaries[2][0]&&(this._boundaries[2][0]=s[14]-n),s[14]+n>this._boundaries[2][1]&&(this._boundaries[2][1]=s[14]+n));o/=i,r/=i,a/=i,this._center=[o,r,a]},N.prototype._generateSubnodes=function(e,i){var s,n,o,r,a,l,h,u,c,_,d,p,g,m;for(s=0,n=this._objects.length;s<n;s++)r=this._objects[s],a=r.pMo.pM,o=r.pMo.getSize(),a[12]-o<this._center[0]&&(a[13]-o<this._center[1]&&(a[14]-o<this._center[2]&&(l=l||[],l.push(r)),a[14]+o>=this._center[2]&&(h=h||[],h.push(r))),a[13]+o>=this._center[1]&&(a[14]-o<this._center[2]&&(u=u||[],u.push(r)),a[14]+o>=this._center[2]&&(c=c||[],c.push(r)))),a[12]+o>=this._center[0]&&(a[13]-o<this._center[1]&&(a[14]-o<this._center[2]&&(_=_||[],_.push(r)),a[14]+o>=this._center[2]&&(d=d||[],d.push(r))),a[13]+o>=this._center[1]&&(a[14]-o<this._center[2]&&(p=p||[],p.push(r)),a[14]+o>=this._center[2]&&(g=g||[],g.push(r))));return m=new Array(8),m[0]=new N(l||t.EMPTY_ARRAY,e,i,!1),m[1]=new N(h||t.EMPTY_ARRAY,e,i,!1),m[2]=new N(u||t.EMPTY_ARRAY,e,i,!1),m[3]=new N(c||t.EMPTY_ARRAY,e,i,!1),m[4]=new N(_||t.EMPTY_ARRAY,e,i,!1),m[5]=new N(d||t.EMPTY_ARRAY,e,i,!1),m[6]=new N(p||t.EMPTY_ARRAY,e,i,!1),m[7]=new N(g||t.EMPTY_ARRAY,e,i,!1),m},N.prototype.getObjects=function(e,i,s,n,o,r){var a;return this._subnodes?this._boundaries&&(i<this._boundaries[0][0]||e>this._boundaries[0][1]||n<this._boundaries[1][0]||s>this._boundaries[1][1]||r<this._boundaries[2][0]||o>this._boundaries[2][1])?t.EMPTY_ARRAY:(a=[],e<this._center[0]&&(s<this._center[1]&&(o<this._center[2]&&(a=a.concat(this._subnodes[0].getObjects(e,i,s,n,o,r))),r>=this._center[2]&&(a=a.concat(this._subnodes[1].getObjects(e,i,s,n,o,r)))),n>=this._center[1]&&(o<this._center[2]&&(a=a.concat(this._subnodes[2].getObjects(e,i,s,n,o,r))),r>=this._center[2]&&(a=a.concat(this._subnodes[3].getObjects(e,i,s,n,o,r))))),i>=this._center[0]&&(s<this._center[1]&&(o<this._center[2]&&(a=a.concat(this._subnodes[4].getObjects(e,i,s,n,o,r))),r>=this._center[2]&&(a=a.concat(this._subnodes[5].getObjects(e,i,s,n,o,r)))),n>=this._center[1]&&(o<this._center[2]&&(a=a.concat(this._subnodes[6].getObjects(e,i,s,n,o,r))),r>=this._center[2]&&(a=a.concat(this._subnodes[7].getObjects(e,i,s,n,o,r))))),a):this._objects},O.prototype.has=function(t){return this._descriptor.spacecrafts&&this._descriptor.spacecrafts.indexOf(t.getID())>=0||this._descriptor.squads&&this._descriptor.squads.indexOf(t._squad)>=0||this._descriptor.teams&&this._descriptor.teams.indexOf(t.getTeam()._name)>=0},O.prototype._cacheSpacecrafts=function(t){var e,i;for(this._scs=[],i=t.getSpacecrafts(),e=0;e<i.length;e++)this.has(i[e])&&this._scs.push(i[e])},O.prototype.getSpacecrafts=function(t,e){return!t||this._scs&&!e||this._cacheSpacecrafts(t),this._scs},O.prototype.isMulti=function(){return this._descriptor.spacecrafts&&this._descriptor.spacecrafts.length>1||this._descriptor.squads&&this._descriptor.squads.length>0||this._descriptor.teams&&this._descriptor.teams.length>0},O._mapSpacecraftID=function(t){return f.getDefiniteArticleForWord(t)+" <strong>"+t+"</strong>"},O._getMappedSpacecraftIDs=function(t){return f.getList(t.map(O._mapSpacecraftID))},O._mapSquadID=function(t){return t=f.get(f.SQUAD.PREFIX,t,t),f.getDefiniteArticleForWord(t)+" <strong>"+t+"</strong>"},O._getMappedSquadIDs=function(t){return f.getList(t.map(O._mapSquadID))},O._mapTeamID=function(t){return t=f.get(f.FACTION.PREFIX,t,t),f.getDefiniteArticleForWord(t)+" <strong>"+t+"</strong>"},O._getMappedTeamIDs=function(t){return f.getList(t.map(O._mapTeamID))},O.prototype.toString=function(){var e="";return this._descriptor.spacecrafts&&(e+=O._getMappedSpacecraftIDs(this._descriptor.spacecrafts)),this._descriptor.squads&&(e.length>0&&(e+="; "),e+=t.formatString(f.get(this._descriptor.squads.length>1?f.MISSIONS.OBJECTIVE_SUBJECTS_SQUADS:f.MISSIONS.OBJECTIVE_SUBJECTS_SQUAD),{ids:O._getMappedSquadIDs(this._descriptor.squads)})),this._descriptor.teams&&(e.length>0&&(e+="; "),e+=t.formatString(f.get(this._descriptor.teams.length>1?f.MISSIONS.OBJECTIVE_SUBJECTS_TEAMS:f.MISSIONS.OBJECTIVE_SUBJECTS_TEAM),{ids:O._getMappedTeamIDs(this._descriptor.teams)})),e},O.prototype.getLiveSubjectCount=function(t){var e,i=0;for(e=0;e<this._scs.length;e++)!this._scs[e]._alive||t&&this._scs[e]._away||i++;return i},O.prototype.getShortString=function(){return this._shortString||(!this._descriptor.spacecrafts||this._descriptor.squads||this._descriptor.teams?this._descriptor.spacecrafts||!this._descriptor.squads||this._descriptor.teams?this._descriptor.spacecrafts||this._descriptor.squads||!this._descriptor.teams?this._shortString=t.formatString(f.get(f.BATTLE.OBJECTIVE_SUBJECTS_SPACECRAFTS),{count:this._scs.length}):this._descriptor.teams.length>1?this._shortString=t.formatString(f.get(f.BATTLE.OBJECTIVE_SUBJECTS_TEAMS),{count:this._descriptor.teams.length}):this._shortString=f.get(f.FACTION.PREFIX,this._descriptor.teams[0],this._descriptor.teams[0]):this._descriptor.squads.length>1?this._shortString=t.formatString(f.get(f.BATTLE.OBJECTIVE_SUBJECTS_SQUADS),{count:this._descriptor.squads.length}):this._shortString=f.get(f.SQUAD.PREFIX,this._descriptor.squads[0],this._descriptor.squads[0]):this._scs.length>1?this._shortString=t.formatString(f.get(f.BATTLE.OBJECTIVE_SUBJECTS_SPACECRAFTS),{count:this._scs.length}):this._shortString=this._scs[0].getDisplayName()),this._shortString},R.prototype._handleWrongParams=function(){s.showError("Wrong parameters specified for condition of type: '"+this._type+"'!")},R.prototype.canBeImpossible=function(){return!1},R.prototype.isImpossible=function(){return!1},R.prototype.isActive=function(){return!0},R.prototype.canChangeMultipleTimes=function(){return!1},L.prototype=new R,L.prototype.constructor=L,L.prototype._checkParams=function(e){return this._params=e,this._params&&this._params.which&&!t.getSafeEnumValue(ot,this._params.which)?(this._handleWrongParams(),!1):(this._all=!this._params||!this._params.which||this._params.which===ot.ALL,!0)},L.prototype.isSatisfied=function(t){var e,i=this._subjects.getSpacecrafts(t);for(e=0;e<i.length;e++)if(i[e]._alive===this._all)return!this._all;return this._all},L.prototype.getObjectiveString=function(e){var i=t.formatString(f.get(e,this._subjects.isMulti()?this._all?f.OBJECTIVE.DESTROY_SUFFIX.name:f.OBJECTIVE.DESTROY_ANY_SUFFIX.name:f.OBJECTIVE.DESTROY_ONE_SUFFIX.name),{subjects:this._subjects.toString()});return i=i.charAt(0).toUpperCase()+i.slice(1)},L.prototype.getObjectiveStateString=function(e){var i,s,n;return this._subjects.getSpacecrafts()?(s=this._subjects.getLiveSubjectCount(!0),n=s>1?" ("+s+")":"",i=t.formatString(f.get(e,f.OBJECTIVE.DESTROY_SUFFIX.name),{subjects:this._subjects.getShortString()})+n,i=i.charAt(0).toUpperCase()+i.slice(1)):""},L.prototype.getTargetSpacecrafts=function(t){return this._subjects.getSpacecrafts(t)},L.prototype.getEscortedSpacecrafts=function(t){return this._subjects.getSpacecrafts(t)},x.prototype=new R,x.prototype.constructor=x,x.prototype._checkParams=function(e){return this._params=e,!(!this._params||"number"!=typeof this._params.count||!t.getSafeEnumValue(rt,this._params.relation))||(this._handleWrongParams(),!1)},x.prototype.isSatisfied=function(t){var e,i,s=this._subjects.getSpacecrafts(t);for(i=0,e=0;e<s.length;e++)s[e]._alive&&i++;switch(this._params.relation){case rt.BELOW:return i<this._params.count;case rt.ABOVE:return i>this._params.count;case rt.EQUALS:return i===this._params.count}return!1},x.prototype.getObjectiveString=function(e){var i;return this._params.relation!==rt.BELOW?(s.showError("Count conditions for mission objectives must have relation set to '"+rt.BELOW+"'!"),null):(i=t.formatString(f.get(e,f.OBJECTIVE.COUNT_BELOW_SUFFIX.name),{subjects:this._subjects.toString(),count:this._params.count}),i=i.charAt(0).toUpperCase()+i.slice(1))},x.prototype.getObjectiveStateString=function(e){var i,s;return this._subjects.getSpacecrafts()?(s=this._subjects.getLiveSubjectCount(),i=t.formatString(f.get(e,f.OBJECTIVE.COUNT_BELOW_SUFFIX.name),{subjects:this._subjects.getShortString(),count:this._params.count,live:s,remaining:Math.max(0,s-this._params.count)}),i=i.charAt(0).toUpperCase()+i.slice(1)):""},x.prototype.getTargetSpacecrafts=function(t){return this._subjects.getSpacecrafts(t)},x.prototype.getEscortedSpacecrafts=function(t){return this._subjects.getSpacecrafts(t)},v.prototype=new R,v.prototype.constructor=v,v.prototype._checkParams=function(e){return this._params=e,!(!this._params||"number"!=typeof this._params.time||!t.getSafeEnumValue(at,this._params.when)||void 0!==this._params.start&&"string"!=typeof this._params.start||this._params.when!==at.REPEAT&&void 0!==this._params.maxCount||this._params.when===at.REPEAT&&void 0!==this._params.maxCount&&"number"!=typeof this._params.maxCount||void 0!==this._params.startValue&&"number"!=typeof this._params.startValue)||(this._handleWrongParams(),!1)},v.prototype.isSatisfied=function(t,e){var i=!1;if(this._params.start&&!this._trigger&&(this._trigger=t.getEvent(this._params.start)&&t.getEvent(this._params.start)._trigger,this._trigger||(this._params.start=null)),!this._running&&!this._impossible&&this._trigger&&this._trigger.hasFired()&&(this._running=!0),this._running)switch(this._timeElapsed+=e,this._params.when){case at.BEFORE:case at.WITHIN:if(this._timeElapsed<this._params.time)return!0;this._impossible=!0;break;case at.AFTER:if(this._timeElapsed>this._params.time)return!0;break;case at.ONCE:if(this._timeElapsed>=this._params.time&&0===this._count)return this._running=!1,this._count=1,this._impossible=!0,!0;break;case at.REPEAT:if(!this._params.maxCount||this._count<this._params.maxCount){for(;this._timeElapsed>=this._params.time;)this._timeElapsed-=this._params.time,i=!0;if(i)return this._count++,!0}else this._running=!1,this._impossible=!0}return!!this._before&&this._timeElapsed<this._params.time},v.prototype.getObjectiveString=function(e,i){var n;return i||this._params&&this._params.when===at.AFTER?!i||this._params&&this._params.when===at.BEFORE?(n=t.formatString(f.get(e,i?f.OBJECTIVE.TIME_MULTI_SUFFIX.name:f.OBJECTIVE.TIME_SUFFIX.name),{time:t.formatTimeToMinutes(this._params.time)}),i||(n=n.charAt(0).toUpperCase()+n.slice(1)),n):(s.showError("Time conditions used in combination with other conditions for mission objectives must have 'when' = '"+at.BEFORE+"'!"),null):(s.showError("Single time conditions for mission objectives must have 'when' = '"+at.AFTER+"'!"),null)},v.prototype.getObjectiveStateString=function(e,i){var s,n;return n=1e3*Math.ceil(.001*Math.max(0,this._params.time-this._timeElapsed)),s=t.formatString(f.get(e,i?f.OBJECTIVE.TIME_MULTI_SUFFIX.name:f.OBJECTIVE.TIME_SUFFIX.name),{time:t.formatTimeToMinutes(n)}),s=s.charAt(0).toUpperCase()+s.slice(1)},v.prototype.getTargetSpacecrafts=function(){return t.EMPTY_ARRAY},v.prototype.getEscortedSpacecrafts=function(){return t.EMPTY_ARRAY},v.prototype.canBeImpossible=function(){return this._canBeImpossible},v.prototype.isImpossible=function(){return this._impossible},v.prototype.isActive=function(){return this._running&&(!this._params||this._timeElapsed<this._params.time)},v.prototype.canChangeMultipleTimes=function(){return this._params.when===at.REPEAT},D.prototype.addFireHandler=function(t){this._onFireHandlers.push(t)},D.prototype.fire=function(t){var e;if(this._delay>0)return void(this._countDown=!0);for(e=0;e<this._onFireHandlers.length;e++)this._onFireHandlers[e](t);this._fired=!0},D.prototype.hasFired=function(){return this._fired},D.prototype.simulate=function(t,e){var i,s;if(this._once){if(this._fired)return;if(this._countDown)return this._delay-=e,void(this._delay<=0&&this.fire(t))}if(!this._conditions)return void this.fire(t);for(i=this._all,s=0;s<this._conditions.length;s++)this._conditions[s].isSatisfied(t,e)===this._falsy&&(i=!this._all);this._previousConditionState===this._falsy&&i!==this._falsy&&this.fire(t),this._previousConditionState=i},D.prototype.getObjectiveCount=function(t){return t?this._conditions.length:1},D.prototype.getObjectiveStrings=function(t,e){var i,n,o,r=[];if(!this._conditions)return s.showError("Win and lose events must have conditions!"),null;if(!this._all)return s.showError("Triggers for mission objectives must be set to 'which' = '"+it.ALL+"'!"),null;if(this._falsy)return s.showError("Triggers for mission objectives must be set to 'when' = '"+st.BECOMES_TRUE+"'!"),null;if(n=this._conditions.length>1,e)for(i=0;i<this._conditions.length;i++)r.push(this._conditions[i].getObjectiveString(t,n));else{for(o="",i=0;i<this._conditions.length;i++)o+=(i>0?" ":"")+this._conditions[i].getObjectiveString(t,n);r.push(o)}return r},D.prototype.getObjectivesState=function(t,e,i,s,n){var o,r,a,l,h,u=this._conditions.length>1;if(t)for(o=0;o<this._conditions.length;o++)((h=this._conditions[o].isSatisfied(e,0)?this._conditions[o].canBeImpossible()&&!i?e._state===ht.COMPLETED?ut.COMPLETED:ut.IN_PROGRESS:ut.COMPLETED:this._conditions[o].isImpossible()?ut.FAILED:ut.IN_PROGRESS)!==ut.IN_PROGRESS||this._conditions[o].isActive()||i)&&(s[n].text=this._conditions[o].getObjectiveStateString(f.BATTLE.OBJECTIVE_WIN_PREFIX,u),s[n].state=h,s[n].completable=!0,n++);else{for(r=!0,a=!1,o=0;o<this._conditions.length;o++)if(!this._conditions[o].isSatisfied(e,0)&&(r=!1,this._conditions[o].isImpossible())){a=!0;break}if(l=this._conditions.length>0?this._conditions[0].getObjectiveStateString(f.BATTLE.OBJECTIVE_LOSE_PREFIX,u):"",(h=r?ut.FAILED:a||i||e._state===ht.COMPLETED?ut.COMPLETED:ut.IN_PROGRESS)===ut.IN_PROGRESS)for(o=1;o<this._conditions.length;o++)this._conditions[o].isActive()&&(l+=" "+this._conditions[o].getObjectiveStateString(f.BATTLE.OBJECTIVE_LOSE_PREFIX,u));l&&(s[n].text=l,s[n].state=h,s[n].completable=this._canBeImpossible,n++)}return n},D.prototype.getTargetSpacecrafts=function(t){var e,i=[];for(e=0;e<this._conditions.length;e++)i=i.concat(this._conditions[e].getTargetSpacecrafts(t));return i},D.prototype.getEscortedSpacecrafts=function(t){var e,i=[];for(e=0;e<this._conditions.length;e++)i=i.concat(this._conditions[e].getEscortedSpacecrafts(t));return i},D.prototype.canBeImpossible=function(){return this._canBeImpossible},w.prototype.getType=function(){return this._type},w.prototype._handleWrongParams=function(){s.showError("Wrong parameters specified for action of type: '"+this._type+"'!")},w.prototype._addToExecutionQueue=function(t){this._delay>0?t.queueAction(this,this._delay):this.execute(t)},w.prototype.triggerCanBeImpossible=function(){return this._trigger.canBeImpossible()},F.prototype=new w,F.prototype.constructor=F,F.prototype._checkParams=function(){return!0},F.prototype.execute=function(t){t.completeMission()},F.prototype.getObjectiveCount=function(){return this._trigger.getObjectiveCount(!0)},F.prototype.getObjectiveStrings=function(){return this._trigger.getObjectiveStrings(f.MISSIONS.OBJECTIVE_WIN_PREFIX,!0)},F.prototype.getObjectivesState=function(t,e,i,s){return this._trigger.getObjectivesState(!0,t,e,i,s)},P.prototype=new w,P.prototype.constructor=P,P.prototype._checkParams=function(){return!0},P.prototype.execute=function(t){t.failMission()},P.prototype.getObjectiveCount=function(){return this._trigger.getObjectiveCount(!1)},P.prototype.getObjectiveStrings=function(){return this._trigger.getObjectiveStrings(f.MISSIONS.OBJECTIVE_LOSE_PREFIX,!1)},P.prototype.getObjectivesState=function(t,e,i,s){return this._trigger.getObjectivesState(!1,t,e,i,s)},V.prototype=new w,V.prototype.constructor=V,V.prototype._checkParams=function(t){return this._params=t,!(!this._params||!this._params.text&&!this._params.textID||void 0!==this._params.text&&"string"!=typeof this._params.text&&"object"!=typeof this._params.text||void 0!==this._params.textID&&"string"!=typeof this._params.textID||void 0!==this._params.source&&"string"!=typeof this._params.source||void 0!==this._params.duration&&"number"!=typeof this._params.duration||void 0!==this._params.permanent&&"boolean"!=typeof this._params.permanent||void 0!==this._params.urgent&&"boolean"!=typeof this._params.urgent)&&(void 0===this._params.color||"object"==typeof this._params.color&&this._params.color instanceof Array)||(this._handleWrongParams(),!1)},V.prototype.execute=function(e){var i;this._params.source&&!(i=e.getSpacecraft(this._params.source))||n.getScreen().queueHUDMessage({text:(this._params.source?"{spacecrafts/"+this._params.source+"}: ":"")+f.get(f.MISSION.PREFIX,t.getFilenameWithoutExtension(e._name)+f.MISSION.MESSAGES_SUFFIX.name+this._params.textID,"object"==typeof this._params.text?this._params.text[f.getLanguage()]:this._params.text),duration:this._params.duration,appearAnimation:!0,permanent:this._params.permanent,color:this._params.color,source:i},this._params.urgent)},U.prototype=new w,U.prototype.constructor=U,U.prototype._checkParams=function(){return!0},U.prototype.execute=function(){n.getScreen().clearHUDMessages()},B.prototype=new w,B.prototype.constructor=B,B.prototype._checkParams=function(t){return this._params=t,!(!this._params||void 0!==this._params.command&&"string"!=typeof this._params.command)||(this._handleWrongParams(),!1)},B.prototype.execute=function(t){var e,i=this._subjects.getSpacecrafts(t,!0);if(i.length>0)for(this._params.lead=i[0],this._params.clearCache=!0,e=0;e<i.length;e++)this._params.index=e,i[e].handleEvent(E.COMMAND_RECEIVED,this._params)},H.prototype=new w,H.prototype.constructor=H,H.prototype._checkParams=function(t){return this._params=t,!(!this._params||void 0!==this._params.state&&"string"!=typeof this._params.state)||(this._handleWrongParams(),!1)},H.prototype.execute=function(t){var e=t._pilotedCraft;e&&e.handleEvent(E.HUD,this._params)},G.prototype.getActions=function(){return this._actions},G.prototype.simulate=function(t,e){this._trigger.simulate(t,e)},j.prototype.getNextMissionName=function(){return this._nextMissionName},j.prototype.getAnticipationTheme=function(){return this._anticipationTheme},j.prototype.getCombatTheme=function(){return this._combatTheme},j.prototype.getSpacecraft=function(t){var e;for(e=0;e<this._scs.length;e++)if(this._scs[e].getID()===t)return this._scs[e];return null},j.prototype.getSpacecrafts=function(){return this._scs},j.prototype.getSpacecraftsInSquad=function(t){var e,i=[];for(e=0;e<this._scs.length;e++)this._scs[e]._squad===t&&i.push(this._scs[e]);return i},j.prototype.applyToSpacecrafts=function(t){var e;for(e=0;e<this._scs.length;e++)t(this._scs[e])},j.prototype.isFinished=function(){return this._state===ht.COMPLETED||this._state===ht.FAILED||this._state===ht.DEFEAT||this._state===ht.ENDED},j.prototype.getTargetSpacecrafts=function(){return this._tSpacecrafts},j.prototype.getEscortedSpacecrafts=function(){return this._escortedSpacecrafts},j.prototype.getDifficultyLevel=function(){return this._difficultyLevel},j.prototype.completeMission=function(){this._state===ht.IN_PROGRESS&&(this._state=ht.COMPLETED)},j.prototype.failMission=function(){this._state!==ht.IN_PROGRESS&&this._state!==ht.COMPLETED||!this._pilotedCraft||this._pilotedCraft._away||(this._state=ht.FAILED)},j.prototype._updateState=function(){var t,e;if(this._pilotedCraft){if(this._pilotedCraft._away||this._updateObjectivesState(),this._pilotedCraft.canBeReused())return void(this._state=ht.DEFEAT);if(this._state===ht.BATTLE){for(t=0;t<this._scs.length;t++)if(this._scs[t]&&!this._scs[t].canBeReused()&&this._pilotedCraft.isHostile(this._scs[t]))return;return void(this._state=ht.COMPLETED)}if(this._state===ht.IN_PROGRESS&&!this._pilotedCraft._away){for(e=!0,t=0;t<this._objectivesState.length;t++){if(this._objectivesState[t].state===ut.FAILED)return void(this._state=ht.FAILED);e=e&&(this._objectivesState[t].state===ut.COMPLETED||!this._objectivesState[t].completable)&&this._objectivesState[t].text}if(e)return void(this._state=ht.COMPLETED)}}else if(this._state===ht.BATTLE&&this.noHostilesPresent())return void(this._state=ht.ENDED)},j.prototype.noHostilesPresent=function(){var t,e,i=null;for(t=0;t<this._scs.length;t++)if(this._scs[t]&&!this._scs[t].canBeReused()){if((e=this._scs[t].getTeam())&&i&&e!==i)return!1;i=e}return!0},j.prototype.getSpacecraftCountForTeam=function(t){var e,i=0;for(e=0;e<this._scs.length;e++)this._scs[e]&&!this._scs[e].canBeReused()&&this._scs[e].getTeam()===t&&i++;return i},j.prototype.getHostileSpacecraftCount=function(t,e){var i,s=0;for(i=0;i<this._scs.length;i++)!this._scs[i]||this._scs[i].canBeReused()||e&&this._scs[i]._away||this._scs[i].isHostile(t)&&s++;return s},j.prototype.getFollowedSpacecraftForScene=function(t){var e,i;if(t._camera.getFollowedNode())for(e=t._camera.getFollowedNode()._renderableObject,i=0;i<this._scs.length;i++)if(this._scs[i].vMo===e)return this._scs[i];return null},j.prototype.getEnvironment=function(){return this._environment},j.prototype.getTeam=function(t){var e;for(e=0;e<this._teams.length;e++)if(this._teams[e]._name===t)return this._teams[e];return s.showError("No team exists with name '"+t+"'!"),null},j.prototype.getEvent=function(t){var e;for(e=0;e<this._events.length;e++)if(this._events[e]._name===t)return this._events[e];return s.showError("No mission event exists with name '"+t+"'!"),null},j.prototype.getObjectives=function(){var t,e=[];for(this._defaultObjective&&e.push(f.get(f.MISSIONS.OBJECTIVE_WIN_PREFIX,f.OBJECTIVE.DESTROY_ALL_SUFFIX.name)),t=0;t<this._winActions.length;t++)e=e.concat(this._winActions[t].getObjectiveStrings());for(t=0;t<this._loseActions.length;t++)e=e.concat(this._loseActions[t].getObjectiveStrings());return e},j.prototype.getObjectivesState=function(t){return t&&this._updateObjectivesState(t),this._objectivesState},j.prototype._updateObjectivesState=function(t){var e,i,s,n,o=0;for(this._defaultObjective&&(n=this._pilotedCraft,i="",n&&(s=this.getHostileSpacecraftCount(n,!0))>0&&(i=" ("+s+")"),this._objectivesState[0].text=f.get(f.BATTLE.OBJECTIVE_WIN_PREFIX,f.OBJECTIVE.DESTROY_ALL_SUFFIX.name)+i,this._objectivesState[0].state=n&&n._alive?this.getHostileSpacecraftCount(n,!1)>0?ut.IN_PROGRESS:ut.COMPLETED:ut.FAILED,this._objectivesState[0].completable=!0,o++),e=0;e<this._winActions.length;e++)o=this._winActions[e].getObjectivesState(this,t,this._objectivesState,o);for(e=0;e<this._loseActions.length;e++)o=this._loseActions[e].getObjectivesState(this,t,this._objectivesState,o);for(;o<this._objectivesState.length;)this._objectivesState[o].text="",o++},j.prototype.loadEnvironment=function(t){"string"==typeof t.environment?(this._environment=T.getEnvironment(t.environment),this._environment||s.showError("Cannot load environment '"+t.environment+"' for mission: no such environment exists!"),this._ownsEnvironment=!1):"object"==typeof t.environment?(this._environment=new T.Environment(t.environment),this._ownsEnvironment=!0):s.showError("Invalid environment specified for mission!")},j.prototype.loadObjectives=function(t){var e,i,s,n,o;if(this._events=[],t.events)for(e=0;e<t.events.length;e++)this._events.push(new G(t.events[e],this));for(this._actionQueue=[],this._state=ht.NONE,this._winActions=[],this._loseActions=[],e=0;e<this._events.length;e++)for(s=this._events[e].getActions(),i=0;i<s.length;i++)n=s[i].getType(),n===lt.WIN?this._winActions.push(s[i]):n===lt.LOSE&&this._loseActions.push(s[i]);if(this._defaultObjective=0===this._winActions.length,this._defaultObjective)for(e=0;e<this._loseActions.length;e++)if(this._loseActions[e].triggerCanBeImpossible()){this._defaultObjective=!1;break}if(o=this._defaultObjective?1:0,this._pilotedCraft){for(e=0;e<this._winActions.length;e++)o+=this._winActions[e].getObjectiveCount();for(e=0;e<this._loseActions.length;e++)o+=this._loseActions[e].getObjectiveCount()}for(this._objectivesState=new Array(o),e=0;e<o;e++)this._objectivesState[e]={};(this._winActions.length>0||this._loseActions.length>0)&&(this._state=ht.IN_PROGRESS)},j.prototype.queueAction=function(t,e){this._actionQueue.push({action:t,delay:e})},j.prototype.getReferenceScore=function(){return this._referenceScore},j.prototype.hasShadows=function(){return this._environment.hasShadows()},j.prototype.loadFromJSON=function(e,n,o){var r,a,l,h,c,_,d,f,S,T,E,A,N,O,R,L,x,v,b,D;if(this._difficultyLevel=$.getDifficultyLevel(n),I.handleDifficultySet(this._difficultyLevel),y.resetRandomSeed(),this._nextMissionName=e.nextMission||null,this.loadEnvironment(e),l=p.isShadowMappingEnabled(),this._environment.hasShadows()?p.setShadowMapping():p.setShadowMapping(!1,!1),l!==p.isShadowMappingEnabled()&&p.handleSettingsChanged(),u.setDrag(this._environment.getDrag(),this._environment._angularDrag),this._anticipationTheme=e.anticipationTheme,this._combatTheme=e.combatTheme,this._teams=[],e.teams)for(r=0;r<e.teams.length;r++)this._teams.push(new C("string"==typeof e.teams[r]?e.teams[r]:Object.assign({index:(r+1).toString()},e.teams[r])));if(this._views=[],e.views)for(r=0;r<e.views.length;r++)this._views.push(new g.SceneView(e.views[r]));for(this._scs=[],this._hitObjects=[],M.clearAIs(),v=[],r=0;r<e.spacecrafts.length;r++)if(e.spacecrafts[r].count)for(E=e.spacecrafts[r].squad,A=e.spacecrafts[r].names,N=e.spacecrafts[r].loadouts,O=e.spacecrafts[r].pilotedIndex,R=e.spacecrafts[r].positions,L=e.spacecrafts[r].formation,x=i.rotation4FromJSON(e.spacecrafts[r].rotations),b=t.deepCopy(e.spacecrafts[r]),delete b.count,delete b.names,delete b.loadouts,delete b.pilotedIndex,delete b.positions,delete b.formation,a=0;a<e.spacecrafts[r].count;a++)D=t.deepCopy(b),E&&(D.squad=E+" "+(a+1).toString()),A&&(D.name=A[a]),N&&(D.loadout=N[a%N.length]),O===a+1&&(D.piloted=!0,delete D.ai),R&&(D.position=R[a]),L&&(R&&s.showError("Both positions and formation have been defined for spacecraft group - formation will be used!",s.ErrorSeverity.MINOR),D.position=y.Spacecraft.getPositionInFormation(L,a,D.position,x)),v.push(D);else v.push(e.spacecrafts[r]);for(r=0;r<v.length;r++)h=new y.Spacecraft,h.loadFromJSON(v[r],this._hitObjects,this._environment),!o&&v[r].piloted&&(this._pilotedCraft=h,h.multiplyMaxHitpoints(this._difficultyLevel.getPlayerHitpointsFactor())),c=v[r].team,c?(_=this.getTeam(c),_?_.addSpacecraft(h):s.showError("Invalid team ID '"+c+"' specified for "+h.getClassName()+"!")):o&&(_=new C({faction:"numbered",index:(this._teams.length+1).toString()}),this._teams.push(_),h.setTeam(_)),this._scs.push(h);for(this._referenceScore=0,_=this._pilotedCraft&&this._pilotedCraft.getTeam(),S=0,
T=this._difficultyLevel.getFriendlyHitpointsFactor(),r=0;r<v.length;r++)h=this._scs[r],v[r].initialTarget&&h.setTarget(this.getSpacecraft(v[r].initialTarget)),this._pilotedCraft&&(!v[r].excludeFromReferenceScore&&this._pilotedCraft.isHostile(h)&&(this._referenceScore+=h.getScoreValue()),this._pilotedCraft.isFriendly(h)&&(h!==this._pilotedCraft&&h.multiplyMaxHitpoints(T),S++)),d=v[r].ai,!d&&o&&(d=h.isFighter()?m.getSetting(m.BS.DEMO_FIGHTER_AI_TYPE):m.getSetting(m.BS.DEMO_SHIP_AI_TYPE)),d&&M.addAI(d,h,this);for(S>0&&(this._referenceScore/=S),this.loadObjectives(e),this._tSpacecrafts=[],r=0;r<this._events.length;r++)for(f=this._events[r].getActions(),a=0;a<f.length;a++)f[a].getType()===lt.WIN&&(this._tSpacecrafts=this._tSpacecrafts.concat(this._events[r]._trigger.getTargetSpacecrafts(this)));for(this._escortedSpacecrafts=[],r=0;r<this._events.length;r++)for(f=this._events[r].getActions(),a=0;a<f.length;a++)f[a].getType()===lt.LOSE&&(this._escortedSpacecrafts=this._escortedSpacecrafts.concat(this._events[r]._trigger.getEscortedSpacecrafts(this)));this._pilotedCraft||(this._state=ht.NONE),this._state!==ht.NONE||this.noHostilesPresent()||(this._state=ht.BATTLE)},j.prototype.isTeamMission=function(){return this._pilotedCraft&&this._pilotedCraft.getTeam()&&this._pilotedCraft.getTeam().getInitialCount()>1},j.prototype.getScoreStatistics=function(t,e,i,s,n){var o,r,a,l,h=this.isTeamMission();return t=Math.round(t),o=Math.round((t||0)*(e||(n||0)*m.getSetting(m.BS.MISSILE_HIT_RATIO_FACTOR))),r=Math.round(i*(h?m.getSetting(m.BS.SCORE_BONUS_FOR_HULL_INTEGRITY_TEAM):m.getSetting(m.BS.SCORE_BONUS_FOR_HULL_INTEGRITY))),h&&(a=Math.round(s*m.getSetting(m.BS.SCORE_BONUS_FOR_TEAM_SURVIVAL))),l=t+o+r+(h?a:0),{baseScore:t,hitRatioBonus:o,hullIntegrityBonus:r,teamSurvivalBonus:a,score:l}},j.prototype.getPerformanceStatistics=function(){var t=this._pilotedCraft,e=this.isTeamMission(),i=e?(this.getSpacecraftCountForTeam(t.getTeam())-(t._alive?1:0))/(t.getTeam().getInitialCount()-1):0,s=this.getScoreStatistics(t.getScore(),t.getHitRatio(),t.getHullIntegrity(),i,t.getMissileHitRatio()),n=$.getPerformanceInfo(this,s.score);return{baseScore:s.baseScore,hitRatioBonus:s.hitRatioBonus,hullIntegrityBonus:s.hullIntegrityBonus,teamSurvival:e?i:void 0,teamSurvivalBonus:s.teamSurvivalBonus,score:s.score,performance:n.performance,nextPerformance:n.nextPerformance,nextPerformanceScore:n.nextPerformanceScore}},j.prototype.getPerformanceLevelScores=function(){return $.getPerformanceLevelScores(this)},j.prototype.createCameraConfigurationForSceneView=function(t,e){var s,n,o=i.getYawAndPitch(t.oM);return s=new c.CameraPositionConfiguration(!t.isMovable(),t.turnsAroundObjects(),t.movesRelativeToObject(),t.getPositionFollowedObjectsForScene(e),t.startsWithRelativePosition(),i.matrix4(t.pM),t.getDistanceRange(),t.getConfines(),t.resetsWhenLeavingConfines()),n=new c.CameraOrientationConfiguration(!t.isTurnable(),t.pointsTowardsObjects(),t.isFPS(),t.getOrientationFollowedObjectsForScene(e),i.matrix4(t.oM),Math.degrees(o.yaw),Math.degrees(o.pitch),t.getAlphaRange(),t.getBetaRange(),t.getBaseOrientation()||m.getDefaultCameraBaseOrientation(),t.getPointToFallback()||m.getDefaultCameraPointToFallback()),new c.CameraConfiguration(t._name,s,n,t.getFOV()||m.getDefaultCameraFOV(),t.getFOVRange(),t.getSpan()||m.getDefaultCameraSpan(),t.resetsOnFocusChange())},j.prototype._handleSpacecraftJumpIn=function(t){this._hitObjects.indexOf(t)<=0&&this._hitObjects.push(t)},j.prototype.getMaxProjectileCount=function(){var t,e=0;for(t=0;t<this._scs.length;t++)e+=this._scs[t].getMaxProjectileCount();return e},j.prototype.getMaxMissileCount=function(){var t,e=0;for(t=0;t<this._scs.length;t++)e+=this._scs[t].getMaxMissileCount();return e},j.prototype.getMaxExplosionCount=function(){var t,e=0;for(t=0;t<this._scs.length;t++)e+=this._scs[t].getMaxExplosionCount();return e},j.prototype.getMaxParticleCount=function(){var t,e=0;for(t=0;t<this._scs.length;t++)e+=this._scs[t].getMaxParticleCount();return e},j.prototype.addToScene=function(t,e,i){var s,n=!!i;for(this._environment&&this._environment.addToScene(t),s=0;s<this._scs.length;s++)this._scs[s].addToScene(t,void 0,n,{hitboxes:!1,weapons:!0,missilesInLaunchers:p.areMissilesInLaunchersVisible(),thrusterParticles:!n,projectileResources:!n,missileResources:!n,explosion:!n,damageIndicators:!n,cameraConfigurations:!n,lightSources:!n,blinkers:!n,jumpEngine:!n,shield:!n,sound:!n},{randomAnimationTime:!0,smallestSizeWhenDrawn:void 0,shaderName:null},null),e&&this._scs[s].addToScene(e,p.getMaxLoadedLOD(),!0,{weapons:!0},{shaderName:m.gHS(m.BS.HUD.TARGET_VIEW_TARGET_ITEM_SHADER)}),this._scs[s]._away?this._scs[s].addEventHandler(E.JUMPED_IN,this._handleSpacecraftJumpIn.bind(this,this._scs[s])):this._hitObjects.push(this._scs[s]);a.executeWhenReady(function(){if(this._views.length>0)for(s=0;s<this._views.length;s++)t.addCameraConfiguration(this.createCameraConfigurationForSceneView(this._views[s],t)),0===s&&t._camera.followNode(null,!0,0);else this._pilotedCraft&&t._camera.followNode(this._pilotedCraft.vMo.getNode(),!0,0,null,m.getDefaultCamerConfigurationName(this._pilotedCraft));t._camera.update(0),q.prefill(Math.ceil(this.getMaxParticleCount()*m.getSetting(m.BS.PARTICLE_POOL_PREFILL_FACTOR))),Q.prefill(Math.ceil(this.getMaxProjectileCount()*m.getSetting(m.BS.PROJECTILE_POOL_PREFILL_FACTOR)),function(t){t.createVisualModel()}),J.prefill(Math.ceil(this.getMaxMissileCount()*m.getSetting(m.BS.MISSILE_POOL_PREFILL_FACTOR)),function(t){t.createVisualModel()}),Z.prefill(Math.ceil(this.getMaxExplosionCount()*m.getSetting(m.BS.EXPLOSION_POOL_PREFILL_FACTOR)),function(t){t.createVisualModel()}),K.prefill(Math.ceil(this.getMaxMissileCount()*m.getSetting(m.BS.MISSILE_POOL_PREFILL_FACTOR)*m.getSetting(m.BS.TRAIL_SEGMENT_POOL_PREFILL_FACTOR)))}.bind(this))},j._handleProjectile=function(t,e,i,s){i.simulate(t,e,this._pilotedCraft),i.canBeReused()&&Q.markAsFree(s)},j._handleMissile=function(t,e,i,s){i.simulate(t,e,this._pilotedCraft),i.canBeReused()&&J.markAsFree(s)},j._handleTrailSegment=function(t,e){t.canBeReused()&&K.markAsFree(e)},j._handleExplosion=function(t,e){t.canBeReused()&&Z.markAsFree(e)},j._handleParticle=function(t,e){t.canBeReused()&&q.markAsFree(e)},j._filterActionEntry=function(t){return t.delay>0},j.prototype.prepareScene=function(t){return!!this._environment.addParticleEffectsToScene(t)&&(this._environment.simulate(),!0)},j.prototype.tick=function(t,e){var i,s,n,o;for(this._environment&&this._environment.simulate(),i=0;i<this._actionQueue.length;i++)this._actionQueue[i].delay-=t,this._actionQueue[i].delay<=0&&this._actionQueue[i].action.execute(this);for(this._actionQueue=this._actionQueue.filter(j._filterActionEntry),i=0;i<this._events.length;i++)this._events[i].simulate(this,this._pilotedCraft&&this._pilotedCraft._away?0:t);for(i=0;i<this._scs.length;i++)this._scs[i].simulate(t),this._scs[i].canBeReused()||this._scs[i]._away?(o=this._hitObjects.indexOf(this._scs[i]),o>=0&&(this._hitObjects[o]=null,this._hitObjects.splice(o,1)),this._scs[i].canBeReused()&&(this._scs[i].destroy(!0),this._scs[i]=null,this._scs.splice(i,1),i--)):z&&this._scs[i].hideHitbox();Q.hasLockedObjects()&&(n=new N(this._hitObjects,2,1,!0),Q.executeForLockedObjects(j._handleProjectile.bind(this,t,n))),J.hasLockedObjects()&&(n=n||new N(this._hitObjects,2,1,!0),J.executeForLockedObjects(j._handleMissile.bind(this,t,n))),Z.hasLockedObjects()&&Z.executeForLockedObjects(j._handleExplosion),q.hasLockedObjects()&&q.executeForLockedObjects(j._handleParticle),K.hasLockedObjects()&&K.executeForLockedObjects(j._handleTrailSegment),e&&(s=e.moveCameraToOrigoIfNeeded(m.getSetting(m.BS.MOVE_TO_ORIGO_DISTANCE)))&&M.handleSceneMoved(s),this._updateState()},j.prototype.destroy=function(){var t;if(this._environment&&(this._ownsEnvironment?this._environment.destroy():this._environment.removeFromScene()),this._environment=null,this._views){for(t=0;t<this._views.length;t++)this._views[t]&&(this._views[t].destroy(),this._views[t]=null);this._views=null}if(this._scs){for(t=0;t<this._scs.length;t++)this._scs[t]&&(this._scs[t].destroy(),this._scs[t]=null);this._scs=null}this._pilotedCraft=null,this._hitObjects=null,q.clear(),Q.clear(),J.clear(),Z.clear(),K.clear()},k.prototype=new r.JSONResource,k.prototype.constructor=k,k.prototype._initLocalData=function(){var t,e,i=$.getDifficultyNames();for(t=0;t<i.length;t++)this._localData[i[t]]=this._localData[i[t]]||{},e=this._localData[i[t]],e.winCount=e.winCount||0,e.loseCount=e.loseCount||0},k.prototype._getLocalStorageID=function(){return ct+this._name},k.prototype._saveLocalData=function(){localStorage[this._getLocalStorageID()]=JSON.stringify(this._localData)},k.prototype.getTitle=function(){return this._dataJSON.title||""},k.prototype.getDescription=function(){return this._dataJSON.description||""},k.prototype.getAuthor=function(){return this._dataJSON.info?this._dataJSON.info.author:null},k.prototype.getDisplayDescription=function(){return f.get(f.MISSION.PREFIX,t.getFilenameWithoutExtension(this._name)+f.MISSION.DESCRIPTION_SUFFIX.name,this.getDescription()?t.formatString(f.get(f.MISSIONS.NO_TRANSLATED_DESCRIPTION),{originalDescription:this.getDescription()}):f.get(f.MISSIONS.NO_DESCRIPTION))},k.prototype.getPilotedSpacecraftDescriptor=function(){var e,i;if(!this._pilotedSpacecraftDescriptor)for(e=0;e<this._dataJSON.spacecrafts.length;e++){if(this._dataJSON.spacecrafts[e].piloted){this._pilotedSpacecraftDescriptor=this._dataJSON.spacecrafts[e];break}if(this._dataJSON.spacecrafts[e].pilotedIndex){i=t.deepCopy(this._dataJSON.spacecrafts[e]),i.names&&(i.name=i.names[i.pilotedIndex-1],delete i.names),i.loadouts&&(i.loadout=i.loadouts[i.pilotedIndex-1],delete i.loadouts),delete i.count,delete i.pilotedIndex,delete i.positions,delete i.formation,this._pilotedSpacecraftDescriptor=i;break}}return this._pilotedSpacecraftDescriptor},k.prototype.getEnvironment=function(){var t=null;return this._readyToUse?(t=new j(this._name),t.loadEnvironment(this._dataJSON),t.getEnvironment()):(s.showError("Cannot get mission environment from mission descriptor that has not yet been initialized!"),null)},k.prototype.getMissionObjectives=function(){var t=null;return this._readyToUse?(t=new j(this._name),t.loadObjectives(this._dataJSON),t.getObjectives()):(s.showError("Cannot get mission objectives from mission descriptor that has not yet been initialized!"),null)},k.prototype.getTipIDs=function(){return this._dataJSON.tips},k.prototype.createMission=function(t,e){var i=null;return this._readyToUse?(i=new j(this._name),i.loadFromJSON(this._dataJSON,t,e)):s.showError("Cannot create mission from descriptor that has not yet been initialized!"),i},k.prototype.getBestScore=function(t){return t=t||$.getDifficulty(),this._localData[t].bestScore},k.prototype.getBestPerformance=function(t){return t=t||$.getDifficulty(),this._localData[t].bestPerformance},k.prototype.updateBestScore=function(t,e,i){i=i||$.getDifficulty();var s=this._localData[i];return(void 0===s.bestScore||t>s.bestScore)&&(s.bestScore=t,s.bestPerformance=e,this._saveLocalData(),!0)},k.prototype.increasePlaythroughCount=function(t,e){e=e||$.getDifficulty(),t?this._localData[e].winCount++:this._localData[e].loseCount++,this._saveLocalData()},k.prototype.getWinCount=function(t){return t=t||$.getDifficulty(),this._localData[t].winCount},W.prototype.getPlayerHitpointsFactor=function(){return this._playerHitpointsFactor},W.prototype.getFriendlyHitpointsFactor=function(){return this._friendlyHitpointsFactor},W.prototype.getEnemyReactionTimeFactor=function(){return this._enemyReactionTimeFactor},W.prototype.getPlayerSelfDamage=function(){return this._playerSelfDamage},W.prototype.getPlayerFriendlyFireDamage=function(){return this._playerFriendlyFireDamage},W.prototype.getHitboxOffset=function(){return this._hitboxOffset},X.prototype.getRequiredScore=function(t){return this._referenceBaseScoreFactor?t.getScoreStatistics(t.getReferenceScore()*(t.isTeamMission()?this._referenceBaseScoreFactor:1),this._referenceHitRatio,this._referenceHullIntegrity,this._referenceTeamSurvival).score:0},Y.prototype=new o.AsyncResource,Y.prototype.constructor=Y,Y.prototype.getPerformanceInfo=function(t,e){var i,s={},n=this._missionPerformanceLevels.length;for(i=0;i<n&&!(e<this._missionPerformanceLevels[i].getRequiredScore(t));i++);return s.performance=i>0?this._missionPerformanceLevels[i-1]._name:"failed",s.nextPerformance=i<n?this._missionPerformanceLevels[i]._name:null,s.nextPerformanceScore=s.nextPerformance?this._missionPerformanceLevels[i].getRequiredScore(t):0,s},Y.prototype.getPerformanceLevelScores=function(t){var e,i={};for(e=0;e<this._missionPerformanceLevels.length;e++)i[this._missionPerformanceLevels[e]._name]=this._missionPerformanceLevels[e].getRequiredScore(t);return i},Y.prototype.loadConfigurationFromJSON=function(t){var e;for(this._difficultyLevels=[],e=0;e<t.difficultyLevels.length;e++)this._difficultyLevels.push(new W(t.difficultyLevels[e]));for(this._missionPerformanceLevels=[],e=0;e<t.missionPerformanceLevels.length;e++)this._missionPerformanceLevels.push(new X(t.missionPerformanceLevels[e]));this._tipIDs=t.tips},Y.prototype.loadSettingsFromLocalStorage=function(){var t,i;this._difficulty=$.getDifficultyNames()[0],void 0!==localStorage[_t]&&(i={silentFallback:s.hasVersionChanged(),defaultValue:$.getDifficultyNames()[0]},t=e.getValueOfTypeFromLocalStorage({baseType:"enum",values:$.getDifficultyNames()},_t,i),i.error&&!s.hasVersionChanged()||this.setDifficulty(t,!!i.error&&i.error!==e.Errors.INVALID_ENUM_OBJECT_ERROR))},Y.prototype.requestLoad=function(t){var e={},i=function(){this.setToReady(),this._missionManager.setToReady()}.bind(this);e.missions=k,this._missionManager.requestConfigLoad(m.getConfigurationSetting(m.CONFIGURATION.MISSION_FILES).filename,m.getConfigurationSetting(m.CONFIGURATION.MISSION_FILES).folder,e,t?function(){this._missionManager.requestAllResources(),this._missionManager.executeWhenReady(i),this._missionManager.requestResourceLoad()}.bind(this):i)},Y.prototype.getDifficulty=function(){return this._difficulty},Y.prototype.setDifficulty=function(t,e){void 0===e&&(e=!0),this._difficulty!==t&&(this._difficulty=t,e&&(localStorage[_t]=t))},Y.prototype.getDifficultyNames=function(){var t,e=[];for(t=0;t<this._difficultyLevels.length;t++)e.push(this._difficultyLevels[t]._name);return e},Y.prototype.getDifficultyLevel=function(t){var e;for(e=0;e<this._difficultyLevels.length;e++)if(this._difficultyLevels[e]._name===t)return this._difficultyLevels[e];return null},Y.prototype.getTipIDs=function(){return this._tipIDs},Y.prototype.getMissionNames=function(){var t=[];return this._missionManager.executeForAllResourcesOfType("missions",function(e){t.push(e._name)},!1,!0),t},Y.prototype.getMissionDescriptors=function(){var t=[];return this._missionManager.executeForAllResourcesOfType("missions",function(e){t.push(e)},!1,!0),t},Y.prototype.getMissionDescriptor=function(t){return this._missionManager.getResource("missions",t)},Y.prototype.requestMissionDescriptor=function(t,e,i){var s=this._missionManager.getResource("missions",t,i);s?(this._missionManager.requestResourceLoad(),this._missionManager.executeWhenReady(function(){e(s)})):e(null)},Y.prototype.requestMission=function(t,e,i,s){var n=this._missionManager.getResource("missions",t);n?(this._missionManager.requestResourceLoad(),this._missionManager.executeWhenReady(function(){s(n.createMission(e,i))})):s(null)},Y.prototype.createMissionDescriptor=function(t){this._missionManager.createResource("missions",t)},q=l.getPool(S.PARTICLE_POOL_NAME,_.Particle),Q=l.getPool(S.PROJECTILE_POOL_NAME,I.Projectile),J=l.getPool(S.MISSILE_POOL_NAME,I.Missile),K=l.getPool(S.TRAIL_SEGMENT_POOL_NAME,_.TrailSegment),Z=l.getPool(S.EXPLOSION_POOL_NAME,A.Explosion),$=new Y,tt={},tt[nt.DESTROYED]=L,tt[nt.COUNT]=x,tt[nt.TIME]=v,et={},et[lt.WIN]=F,et[lt.LOSE]=P,et[lt.MESSAGE]=V,et[lt.CLEAR_MESSAGES]=U,et[lt.COMMAND]=B,et[lt.HUD]=H,m.executeWhenReady(function(){z=m.getSetting(m.BS.SHOW_HITBOXES_FOR_HITCHECKS),dt=m.getSetting(m.GENERAL_SETTINGS.UNIFORM_GROUP_TRANSFORMS_ARRAY_NAME)}),{ConditionType:nt,TriggerWhen:st,TriggerWhich:it,DestroyedConditionWhich:ot,CountConditionRelation:rt,TimeConditionWhen:at,ActionType:lt,MissionState:ht,ObjectiveState:ut,SubjectGroup:O,createCondition:b,FAILED_MISSION_PERFORMACE:"failed",loadConfigurationFromJSON:$.loadConfigurationFromJSON.bind($),loadSettingsFromLocalStorage:$.loadSettingsFromLocalStorage.bind($),requestLoad:$.requestLoad.bind($),executeWhenReady:$.executeWhenReady.bind($),getDifficulty:$.getDifficulty.bind($),setDifficulty:$.setDifficulty.bind($),getDifficultyNames:$.getDifficultyNames.bind($),getTipIDs:$.getTipIDs.bind($),getMissionNames:$.getMissionNames.bind($),getMissionDescriptor:$.getMissionDescriptor.bind($),getMissionDescriptors:$.getMissionDescriptors.bind($),requestMissionDescriptor:$.requestMissionDescriptor.bind($),requestMission:$.requestMission.bind($),createMissionDescriptor:$.createMissionDescriptor.bind($)}}),define("modules/screens",["utils/utils","utils/types","modules/application","modules/async-resource","modules/components","modules/managed-gl","modules/media-resources","modules/strings"],function(t,e,i,s,n,o,r,a){"use strict";function l(e){var i;return C.enabled?(i=t.getLuminance(e),t.getMixedColor(t.gammaCorrect(t.filterColor([i,i,i,e[3]],C.filter),C.gamma),e,C.originalColorRatio)):e}function h(t,e,i,n,o,r){s.AsyncResource.call(this),this._name=t,this._htmlFilename=e,this._style=i||{},this._cssLoaded=!1,this._model=null,this._background=null,this._container=null,this._superImposed=!1,this._simpleComponents=[],this._externalComponentBindings=[],this._externalComponentsLoaded=0,this._externalComponentsToLoad=0,this._visible=!1,this._onShow=n?n[f]:null,this._onHide=n?n[S]:null,this._onActivate=n?n[T]:null,this._keyDownHandler=o?this._getKeyDownHandler(o):null,this._elementEventHandlers=r||null,e&&this.requestModelLoad()}function u(s){this._left=s.left,this._centerX=s.centerX,this._right=s.right,this._top=s.top,this._centerY=s.centerY,this._bottom=s.bottom,this._width=s.width,this._height=s.height,this._scaleMode=e.getEnumValue(t.ScaleMode,s.scaleMode),this._xScaleMode=e.getEnumValue(t.ScaleMode,s.xScaleMode||t.ScaleMode.ASPECT),this._yScaleMode=e.getEnumValue(t.ScaleMode,s.yScaleMode||t.ScaleMode.ASPECT),this._isValid()||i.showError("Invalid layout specified!")}function c(s,n,o,r,a,l,h,c){this._x=s[0],this._y=s[1],this._text=null,this._font=o,this._size=r,this._scaleMode=e.getEnumValue(t.ScaleMode,a),this._scaleMode===t.ScaleMode.ASPECT&&i.showError("Cannot set the scaling mode to aspect for fonts!"),this._color=null,this._align=h||"left",this._boxLayout=c?new u(c):null,this._boxLeft=-1,this._boxTop=-1,this._boxWidth=-1,this._boxHeight=-1,this._boxValid=!1,this._boxCleared=!1,this._visible=!0,this._lastWidth=-1,this._lastHeight=-1,this._textWidth=-1,this._cssFont=null,this._cssColor=null,this._words=null,this._sections=null,this._textLength=0,this._revealState=1,this._lineHeight=-1,this.setText(n),this.setColor(l)}function _(t){this._canvas=document.createElement("canvas"),this._clipSpaceLayout=new u(t),this._context=this._canvas.getContext("2d",{alpha:!0}),this._context.textBaseline="top",this._texts=[],this._visible=!0,this._cleared=!0,this._viewportWidth=-1,this._viewportHeight=-1}function d(t,i,s,n){this._canvas=t,this._resizeable=t.classList.contains(y),this._antialiasing=i,this._alpha=s,this._filtering=e.getEnumValue(o.TextureFiltering,n,{name:"ScreenCanvas.filtering"}),this._context=null,this._textLayers=[]}function p(t,i,s,n,r,a,l,u,c,_){h.call(this,t,i,s,u,c,_),this._antialiasing=n,this._alpha=r,this._filtering=i?e.getEnumValue(o.TextureFiltering,a,{name:"HTMLScreenWithCanvases.filtering"}):null,this._canvases={},this._sceneCanvasBindings=[],this._renderLoop=I,this._renderTimes=[],this._minFPS=0,this._maxFPS=0,this._fpsSum=0,this._fpsFrameCount=0,this._resizeEventListener=null,this._useRequestAnimFrame=l}function g(t,e,i,s,o,r,a,l,u,c){h.call(this,t,e,i,l,this._getKeyCommands(u),c),this._menuOptions=r,this._menuContainerID=a,this._menuComponent=this.registerExternalComponent(new n.MenuComponent(A,s,o,this._menuOptions,l),this._menuContainerID)}function m(t,e,i,s){C.enabled=t,C.originalColorRatio=e,C.filter[1]=i,C.filter[2]=i,C.gamma=s}var f=n.SHOW_EVENT_NAME,S=n.HIDE_EVENT_NAME,T="activate",E=n.ELEMENT_ID_SEPARATOR,y="resizeable",I=-1,A="menu",M={name:"error.antialiasingChange",defaultValue:"The antialiasing setting has been changed. Please restart the application to apply the new setting!"},C={enabled:!1,originalColorRatio:.5,filter:[1,1,1,1],gamma:1};return h.prototype=new s.AsyncResource,h.prototype.constructor=h,h.prototype._isLoaded=function(){return this._model&&this._cssLoaded&&this._externalComponentsLoaded===this._externalComponentsToLoad},h.prototype._getKeyDownHandler=function(e){var i,s,n={};for(i=Object.keys(e),s=0;s<i.length;s++)n[t.getKeyCodeOf(i[s])]=e[i[s]];return function(t){n[t.keyCode]&&n[t.keyCode].call(this,t)}.bind(this)},h.prototype._addEventListeners=function(){this._keyDownHandler&&document.addEventListener("keydown",this._keyDownHandler)},h.prototype._removeEventListeners=function(){this._keyDownHandler&&document.removeEventListener("keydown",this._keyDownHandler)},h.prototype.requestModelLoad=function(){i.requestTextFile("screen",this._htmlFilename,function(t){var e;this._model=document.createDocumentFragment(),e=document.createElement("div"),e.innerHTML=t,this._model.appendChild(e.firstElementChild),this._isLoaded()&&this.setToReady()}.bind(this)),this._style.cssFilename?(this._cssLoaded=!1,i.requestCSSFile("css",this._style.cssFilename,function(){this._cssLoaded=!0,this._isLoaded()&&this.setToReady()}.bind(this))):this._cssLoaded=!0},h.prototype.setActive=function(t){t?(this._addEventListeners(),this._onActivate&&this._onActivate()):this._removeEventListeners()},h.prototype._addElementEventListeners=function(t){var e,i,s,n,o,r;if(this._elementEventHandlers)for(t=t||this._container,o=Object.keys(this._elementEventHandlers),i=0;i<o.length;i++)for(e=t.querySelectorAll(o[i]),r=Object.keys(this._elementEventHandlers[o[i]]),s=0;s<e.length;s++)for(n=0;n<r.length;n++)e[s].addEventListener(r[n],this._elementEventHandlers[o[i]][r[n]])},h.prototype.addScreenToPage=function(t,e,i,s){s=s||document.body,this.executeWhenReady(function(){var n,o;for(e&&(this._background=document.createElement("div"),this._background.setAttribute("id",this._getElementID("screenBackground")),this._background.className=this._style.backgroundClassName||"screenBackground",this._background.hidden=!0),this._container=document.createElement("div"),this._container.setAttribute("id",this._getElementID("screenContainer")),this._container.className=this._style.containerClassName||"screenContainer",this._container.hidden=!0,i?this._container.appendChild(this._model.firstElementChild.cloneNode(!0)):this._container.appendChild(this._model.firstElementChild),n=this._container.querySelectorAll("[id]"),o=0;o<n.length;o++)n[o].setAttribute("id",this._getElementID(n[o].getAttribute("id")));this._background&&s.appendChild(this._background),s.appendChild(this._container),this._visible=!1,this._initializeComponents(),this._addElementEventListeners(),t&&t(),i||(this._model=null)})},h.prototype.show=function(){if(!this._visible){if(this._container)return this._container.hidden=!1,this._visible=!0,this._onShow&&this._onShow(),!0;i.showError("Attempting to show screen '"+this._name+"' before adding it to the page!")}return!1},h.prototype.superimposeOnPage=function(e,i){this._container&&(i=i||document.body,this._background&&(e&&(this._background.style.backgroundColor=t.getCSSColor(e)),this._background.hidden=!1,i.appendChild(this._background)),i.appendChild(this._container),this._superImposed=!0),this.show()},h.prototype.hide=function(){if(this._visible){if(this._container)return this._container.hidden=!0,this._background&&(this._background.hidden=!0),this._visible=!1,this._superImposed=!1,this.setActive(!1),this._onHide&&this._onHide(),!0;i.showError("Attempting to hide screen '"+this._name+"' before adding it to the page!")}return!1},h.prototype.isSuperimposed=function(){return this._superImposed},h.prototype._initializeComponents=function(){var t,e;for(t=0;t<this._simpleComponents.length;t++)this._simpleComponents[t].initComponent();for(t=0;t<this._externalComponentBindings.length;t++)this._externalComponentBindings[t].parentNodeID&&(e=this.getElement(this._externalComponentBindings[t].parentNodeID)),this.addExternalComponent(this._externalComponentBindings[t].component,e);this._updateComponents()},h.prototype._getElementID=function(t){return this._name+E+t},h.prototype._getOriginalElementID=function(t){return t.getAttribute("id").substr(this._name.length+E.length)},h.prototype._updateComponents=function(){var t,e;if(this._container){for(t=this._container.querySelectorAll(".translatable, ["+n.TRANSLATION_KEY_ATTRIBUTE+"]"),e=0;e<t.length;e++)t[e].innerHTML=a.get({name:t[e].getAttribute(n.TRANSLATION_KEY_ATTRIBUTE)||this._name+"."+this._getOriginalElementID(t[e]),defaultValue:t[e].innerHTML});for(e=0;e<this._externalComponentBindings.length;e++)this._externalComponentBindings[e].component.updateComponents()}},h.prototype.updateScreen=function(){this._updateComponents()},h.prototype.registerSimpleComponent=function(t){var e=new n.SimpleComponent(t,this._getElementID(t));return this._simpleComponents.push(e),e},h.prototype.registerExternalComponent=function(t,e){return this._externalComponentsToLoad++,this._externalComponentBindings.push({component:t,parentNodeID:e}),t.setRootElementID(this._getElementID(t._name)),t.executeWhenReady(function(){this._externalComponentsLoaded++,this._isLoaded()&&this.setToReady()}.bind(this)),t},h.prototype.addExternalComponent=function(t,e){return t.appendToPage(e),t},h.prototype.updateStatus=function(t){this._status?this._status.setContent(t):alert(t)},h.prototype.getElement=function(t){return this._container.querySelector("#"+this._getElementID(t))},u.prototype._isValid=function(){var e;if(void 0!==this._width){if(e=0,void 0!==this._left&&e++,void 0!==this._centerX&&e++,void 0!==this._right&&e++,1!==e)return!1}else{if(void 0===this._left||void 0!==this._centerX||void 0===this._right)return!1;if(this._scaleMode!==t.ScaleMode.ASPECT||this._xScaleMode!==t.ScaleMode.ASPECT)return!1}if(void 0!==this._height){if(e=0,void 0!==this._top&&e++,void 0!==this._centerY&&e++,void 0!==this._bottom&&e++,1!==e)return!1}else{if(void 0===this._top||void 0!==this._centerY||void 0===this._bottom)return!1;if(this._scaleMode!==t.ScaleMode.ASPECT||this._yScaleMode!==t.ScaleMode.ASPECT)return!1}return!0},u.prototype.getClipSpaceCenterX=function(){return void 0!==this._centerX?this._centerX:void 0!==this._width?void 0!==this._left?this._left+this._width/2:this._right-this._width/2:(this._left+this._right)/2},u.prototype.getClipSpaceCenterY=function(){return void 0!==this._centerY?this._centerY:void 0!==this._height?void 0!==this._bottom?this._bottom+this._height/2:this._top-this._height/2:(this._bottom+this._top)/2},u.prototype.getClipSpacePosition=function(){return[this.getClipSpaceCenterX(),this.getClipSpaceCenterY()]},u.prototype.getClipSpaceWidth=function(){return void 0!==this._width?this._width:this._right-this._left},u.prototype.getClipSpaceHeight=function(){return void 0!==this._height?this._height:this._top-this._bottom},u.prototype.getClipSpaceSize=function(){return[this.getClipSpaceWidth(),this.getClipSpaceHeight()]},u.prototype.getClipSpaceLeft=function(){return void 0!==this._left?this._left:this.getClipSpaceCenterX()-this.getClipSpaceWidth()/2},u.prototype.getClipSpaceRight=function(){return void 0!==this._right?this._right:this.getClipSpaceCenterX()+this.getClipSpaceWidth()/2},u.prototype.getClipSpaceBottom=function(){return void 0!==this._bottom?this._bottom:this.getClipSpaceCenterY()-this.getClipSpaceHeight()/2},u.prototype.getClipSpaceTop=function(){return void 0!==this._top?this._top:this.getClipSpaceCenterY()+this.getClipSpaceHeight()/2},u.prototype.getWidth=function(e,i){return this.getClipSpaceWidth()/2*(t.xScalesWithWidth(this._scaleMode,e,i)?e:i)},u.prototype.getHeight=function(e,i){return this.getClipSpaceHeight()/2*(t.yScalesWithHeight(this._scaleMode,e,i)?i:e)},u.prototype.getSize=function(t,e){return[this.getWidth(t,e),this.getHeight(t,e)]},u.prototype.getCenterX=function(e,i){var s;return s=t.xScalesWithWidth(this._xScaleMode,e,i)?e:i,void 0!==this._left?(this.getClipSpaceLeft()+1)/2*s+this.getWidth(e,i)/2:void 0!==this._centerX?e/2+this.getClipSpaceCenterX()/2*s:e-(1-this.getClipSpaceRight())/2*s-this.getWidth(e,i)/2},u.prototype.getCenterY=function(e,i){var s;return s=t.yScalesWithHeight(this._yScaleMode,e,i)?i:e,void 0!==this._top?(1-this.getClipSpaceTop())/2*s+this.getHeight(e,i)/2:void 0!==this._centerY?i/2-this.getClipSpaceCenterY()/2*s:i-(this.getClipSpaceBottom()+1)/2*s-this.getHeight(e,i)/2},u.prototype.setPosition=function(t,e){this._centerX=t,this._centerY=e},u.prototype.getPosition=function(t,e){return[this.getCenterX(t,e),this.getCenterY(t,e)]},u.prototype.getLeft=function(e,i){var s;return s=t.xScalesWithWidth(this._xScaleMode,e,i)?e:i,void 0!==this._left?(this.getClipSpaceLeft()+1)/2*s:void 0!==this._centerX?e/2+this.getClipSpaceCenterX()/2*s-this.getWidth(e,i)/2:e-(1-this.getClipSpaceRight())/2*s-this.getWidth(e,i)},u.prototype.getTop=function(e,i){var s;return s=t.yScalesWithHeight(this._yScaleMode,e,i)?i:e,void 0!==this._top?(1-this.getClipSpaceTop())/2*s:void 0!==this._centerY?i/2-this.getClipSpaceCenterY()/2*s-this.getHeight(e,i)/2:i-(this.getClipSpaceBottom()+1)/2*s-this.getHeight(e,i)},u.prototype.getBottom=function(e,i){var s;return s=t.yScalesWithHeight(this._yScaleMode,e,i)?i:e,void 0!==this._top?(1-this.getClipSpaceTop())/2*s+this.getHeight(e,i):void 0!==this._centerY?i/2-this.getClipSpaceCenterY()/2*s+this.getHeight(e,i)/2:i-(this.getClipSpaceBottom()+1)/2*s},u.prototype.getPositiveLeft=function(t,e){return this.getLeft(t,e)/t},u.prototype.getPositiveBottom=function(t,e){return 1-this.getBottom(t,e)/e},u.prototype.getPositiveWidth=function(t,e){return this.getWidth(t,e)/t},u.prototype.getPositiveHeight=function(t,e){return this.getHeight(t,e)/e},c.prototype._updateCSSFont=function(e,i){t.scalesWithWidth(this._scaleMode,e,i)?this._cssFont=this._size*e+"px":this._cssFont=this._size*i+"px",this._cssFont=this._cssFont+" "+this._font},c.prototype.invalidateLayout=function(){this._boxValid=!1},c.prototype._updateLayout=function(){this._boxLayout&&!this._boxValid&&(this._boxTop=this._boxLayout.getTop(this._lastWidth,this._lastHeight),this._boxLeft=this._boxLayout.getLeft(this._lastWidth,this._lastHeight),this._boxWidth=this._boxLayout.getWidth(this._lastWidth,this._lastHeight),this._boxHeight=this._boxLayout.getHeight(this._lastWidth,this._lastHeight),this._boxValid=!0)},c.prototype._updateSize=function(t,e){t===this._lastWidth&&e===this._lastHeight||(this._lastWidth=t,this._lastHeight=e,this._updateCSSFont(t,e),this._textWidth=-1,this._boxValid=!1)},c.prototype._clearBox=function(t){this._boxLayout&&this._boxWidth>=0&&!this._boxCleared&&(t.clearRect(this._boxLeft,this._boxTop,this._boxWidth,this._boxHeight),this._boxCleared=!0)},c.prototype._breakIntoSections=function(t){var e,s,n,o,r,a,l,h,u,c,_,d,p,g,m,f,S,T,E,y,I,A,M,C=function(){var t;for(t=p;t<o.length;t++)switch(r){case"right":o[t].xOffset-=u;break;case"center":
o[t].xOffset-=.5*u}},N=function(e){C(),l++,o.push({text:e,xOffset:0,yOffset:l*d,color:g&&g.color}),g&&(g.length=g.text.length,g.startIndex=M,M+=g.length),g=o[o.length-1],p=o.length-1,T=0,u=e.length>0?t.measureText(e).width:0,S=!1},O=function(e){T+=t.measureText(g.text).width,o.push({text:"",xOffset:T,yOffset:l*d,color:e}),g.length=g.text.length,g.startIndex=M,M+=g.length,g=o[o.length-1]},R=function(){if(I.length<2)g.text.length>0?O():delete g.color;else switch(I[0]){case"color":A=I[1].split(",").map(parseFloat),g.text.length>0?O(A):g.color=A;break;default:i.showError("Unrecognized text modifier: '"+I[0]+"'!")}};for(n=this._text.split("\n"),this._words=[],e=0;e<n.length;e++)this._words.push(n[e].split(" "));for(_=this._boxLayout?this._boxWidth:this._lastWidth,this._textWidth=t.measureText(this._text).width,this._lineHeight=1.2*t.measureText("M").width,this._sections=[],o=this._sections,d=this._lineHeight,r=this._align,l=-1,T=0,u=0,p=0,M=0,e=0;e<this._words.length;e++)for(N(""),s=0;s<this._words[e].length;s++){if(m=this._words[e][s],(E=m.indexOf("["))>=0){if(y=m.indexOf("]"),I=m.substring(E+1,y).split(":"),0===E){if(R(),m.length>y+1){this._words[e][s]=m.substr(y+1),s--;continue}continue}f=y<m.length-1?m.substr(y+1):null,m=m.substring(0,E)}else f=null;a=g.text,h=a+(u>0&&!S?" ":"")+m,c=T+t.measureText(h).width,0===s||c<_?(g.text=h,u=c):N(m),S=!1,E>0&&R(),f&&(this._words[e][s]=f,s--,S=!0)}g&&(g.length=g.text.length,g.startIndex=M,M+=g.length),this._textLength=M,C()},c.prototype.setRevealState=function(t){this._revealState=t},c.prototype.render=function(e){var i,s,n,o,r;if(this._visible){for(this._clearBox(e),e.fillStyle=this._cssColor,this._updateSize(e.canvas.width,e.canvas.height),this._updateLayout(),e.font=this._cssFont,e.textAlign="left",this._boxLayout&&this._boxWidth>=0&&(e.save(),e.rect(this._boxLeft,this._boxTop,this._boxWidth,this._boxHeight),e.clip()),this._textWidth<0&&this._breakIntoSections(e),s=this._cssColor,o=Math.round(this._revealState*this._textLength),i=0;i<this._sections.length&&this._sections[i].startIndex<=o;i++)n=this._sections[i].color?t.getCSSColor(l(this._sections[i].color)):this._cssColor,s!==n&&(s=n,e.fillStyle=s),r=this._sections[i].startIndex+this._sections[i].length-1>o?this._sections[i].text.substring(0,o-this._sections[i].startIndex+1):this._sections[i].text,e.fillText(r,(this._x+1)/2*this._lastWidth+this._sections[i].xOffset,(1-this._y)/2*this._lastHeight+this._sections[i].yOffset);return this._boxLayout?(e.restore(),this._boxCleared=0===this._text.length,!1):this._text.length>0}return this._clearBox(e),!1},c.prototype.invalidate=function(){this._lastWidth=-1,this._lastHeight=-1,this._textWidth=-1},c.prototype.setPosition=function(t){this._x=t[0],this._y=t[1]},c.prototype.setText=function(e,i){(e=i?t.formatString(e,i):e)!==this._text&&(this._text=e,this._textWidth=-1)},c.prototype.setColor=function(e){this._color=e,this._cssColor=t.getCSSColor(l(e))},c.prototype.show=function(){this._visible||(this._visible=!0,this.invalidate())},c.prototype.hide=function(){this._visible&&(this._visible=!1,this.invalidate())},_.prototype.clearContext=function(t){this._cleared||(this._context.clearRect(0,0,this._canvas.width,this._canvas.height),t&&(this._context.strokeStyle=t,this._context.strokeRect(0,0,this._canvas.width,this._canvas.height)),this._cleared=!0)},_.prototype.addText=function(t){this._texts.push(t)},_.prototype.render=function(){var t;if(this._visible)for(this.clearContext(),t=0;t<this._texts.length;t++)this._cleared=!this._texts[t].render(this._context)&&this._cleared},_.prototype.updateLayout=function(){this._canvas.style.top=this._clipSpaceLayout.getTop(this._viewportWidth,this._viewportHeight)+"px",this._canvas.style.left=this._clipSpaceLayout.getLeft(this._viewportWidth,this._viewportHeight)+"px",this._canvas.width=this._clipSpaceLayout.getWidth(this._viewportWidth,this._viewportHeight),this._canvas.height=this._clipSpaceLayout.getHeight(this._viewportWidth,this._viewportHeight),this._cleared=!1},_.prototype.handleResize=function(t,e){this._viewportWidth=t,this._viewportHeight=e,this.updateLayout()},_.prototype.setContainer=function(t){this.handleResize(t.width,t.height),t.parentNode.appendChild(this._canvas),this._canvas.style.position="absolute",this._canvas.zIndex=t.zIndex+1},_.prototype.isVisible=function(){return this._visible},_.prototype.show=function(){var t;if(!this._visible){for(t=0;t<this._texts.length;t++)this._texts[t].invalidate();this._visible=!0,this._canvas.hidden=!1}},_.prototype.hide=function(){var t;if(this._visible){for(this.clearContext(),t=0;t<this._texts.length;t++)this._texts[t].invalidate();this._visible=!1,this._canvas.hidden=!0}},_.prototype.getLayout=function(){return this._clipSpaceLayout},d.prototype.getCanvasElement=function(){return this._canvas},d.prototype.isResizeable=function(){return this._resizeable},d.prototype.getManagedContext=function(){return this._context||(this._context=new o.ManagedGLContext(this._canvas.getAttribute("id"),this._canvas,this._antialiasing,this._alpha,this._filtering)),this._context},d.prototype.clearManagedContext=function(){this._context&&this._context.clear()},d.prototype.setAntialiasing=function(t){if(t!==this._antialiasing){if(this._context)return i.showError(a.get(M)),!1;this._antialiasing=t}return!0},d.prototype.setFiltering=function(t){t!==this._filtering&&(this._filtering=t,this._context&&this._context.setFiltering(this._filtering))},d.prototype.handleResize=function(){var t,e=this._canvas.clientWidth,i=this._canvas.clientHeight;if(this._canvas.width!==e||this._canvas.height!==i)for(this._canvas.width=e,this._canvas.height=i,t=0;t<this._textLayers.length;t++)this._textLayers[t].handleResize(e,i)},d.prototype.addTextLayer=function(t){this._textLayers.push(t),t.setContainer(this._canvas)},d.prototype.renderTextLayers=function(){var t;for(t=0;t<this._textLayers.length;t++)this._textLayers[t].render()},p.prototype=new h,p.prototype.constructor=p,p.prototype.handleResize=function(){this.resizeCanvases(),this._renderLoop===I&&this.render()},p.prototype.clearSceneCanvasBindings=function(){var t;for(t=0;t<this._sceneCanvasBindings.length;t++)this._sceneCanvasBindings[t].canvas.clearManagedContext();this._sceneCanvasBindings=[]},p.prototype.hide=function(){return!!h.prototype.hide.call(this)&&(this.stopRenderLoop(),!0)},p.prototype._getAlphaForCanvas=function(t){return"boolean"==typeof this._alpha?this._alpha:"boolean"==typeof this._alpha[t]?this._alpha[t]:(i.showError("No alpha channel support is defined for canvas '"+t+"' of screen '"+this._name+"'!"),!1)},p.prototype._initializeComponents=function(){var t,e;for(h.prototype._initializeComponents.call(this),t=this._container.getElementsByTagName("canvas"),e=0;e<t.length;e++)this._canvases[t[e].getAttribute("id")]=new d(t[e],this._antialiasing,this._getAlphaForCanvas(this._getOriginalElementID(t[e])),this._filtering);this._resizeEventListener=this.handleResize.bind(this),window.addEventListener("resize",this._resizeEventListener)},p.prototype.getScreenCanvas=function(t){return this._canvases[this._getElementID(t)]},p.prototype.bindSceneToCanvas=function(t,e){var i,s=!1;for(i=0;i<this._sceneCanvasBindings.length;i++)this._sceneCanvasBindings[i].scene===t&&this._sceneCanvasBindings[i].canvas===e&&(s=!0);!1===s&&this._sceneCanvasBindings.push({scene:t,canvas:e}),t.addToContext(e.getManagedContext()),this._renderLoop!==I&&e.getManagedContext().setup()},p.prototype.setAntialiasing=function(t){var e;if(t!==this._antialiasing){this._antialiasing=t;for(e in this._canvases)if(this._canvases.hasOwnProperty(e)&&!this._canvases[e].setAntialiasing(this._antialiasing))return}},p.prototype.setFiltering=function(t){var i;if((t=e.getEnumValue(o.TextureFiltering,t,{name:"HTMLScreenWithCanvases.filtering",defaultValue:this._filtering}))!==this._filtering){this._filtering=t;for(i in this._canvases)this._canvases.hasOwnProperty(i)&&this._canvases[i].setFiltering(this._filtering)}},p.prototype._render=function(t){var e,i;for(i=Object.keys(this._canvases),e=0;e<this._sceneCanvasBindings.length;e++)this._sceneCanvasBindings[e].scene.render(this._sceneCanvasBindings[e].canvas.getManagedContext(),t);for(e=0;e<i.length;e++)this._canvases[i[e]].renderTextLayers()},p.prototype.render=function(){var t,e,i,s;if(t=performance.now(),e=this._renderTimes&&this._renderTimes.length>0?t-this._renderTimes[this._renderTimes.length-1]:0,this._render(e),this._renderLoop!==I){for(this._renderTimes.push(t),i=!1;this._renderTimes.length>1&&t-this._renderTimes[0]>1e3;)this._renderTimes.shift(),i=!0;i&&(s=this._renderTimes.length,(0===this._minFPS||this._minFPS>s)&&(this._minFPS=s),(0===this._maxFPS||this._maxFPS<s)&&(this._maxFPS=s),this._fpsSum+=s,this._fpsFrameCount++)}},p.prototype._renderRequestAnimFrame=function(t){var e,i,s;if(this._renderLoop!==I){for(e=this._renderTimes&&this._renderTimes.length>0?t-this._renderTimes[this._renderTimes.length-1]:0,this._render(e),this._renderTimes.push(t),i=!1;this._renderTimes.length>1&&t-this._renderTimes[0]>1e3;)this._renderTimes.shift(),i=!0;i&&(s=this._renderTimes.length,(0===this._minFPS||this._minFPS>s)&&(this._minFPS=s),(0===this._maxFPS||this._maxFPS<s)&&(this._maxFPS=s),this._fpsSum+=s,this._fpsFrameCount++),window.requestAnimationFrame(this._renderRequestAnimFrame.bind(this))}},p.prototype.startRenderLoop=function(t){var e;if(this._renderLoop===I){for(e=0;e<this._sceneCanvasBindings.length;e++)this._sceneCanvasBindings[e].canvas.getManagedContext().setup();this._renderTimes=[performance.now()],this._minFPS=0,this._maxFPS=0,this._fpsSum=0,this._fpsFrameCount=0,this._useRequestAnimFrame?(this._renderLoop=-2,window.requestAnimationFrame(this._renderRequestAnimFrame.bind(this))):this._renderLoop=setInterval(function(){this.render()}.bind(this),t)}},p.prototype.stopRenderLoop=function(){this._renderLoop!==I&&(this._useRequestAnimFrame||clearInterval(this._renderLoop),this._renderLoop=I,this._renderTimes=[])},p.prototype.getFPS=function(){return this._renderTimes.length},p.prototype.getFPSStats=function(){return this._renderTimes.length+" ("+(this._fpsFrameCount>0?Math.round(this._fpsSum/this._fpsFrameCount):"0")+", "+this._minFPS+"-"+this._maxFPS+")"},p.prototype.resizeCanvases=function(){var t;for(t in this._canvases)this._canvases.hasOwnProperty(t)&&!0===this._canvases[t].isResizeable()&&this._canvases[t].handleResize()},g.prototype=new h,g.prototype.constructor=g,g.prototype._getKeyCommands=function(t){return t=t||{},t.up=t.up||function(){this._menuComponent.selectPrevious()}.bind(this),t.down=t.down||function(){this._menuComponent.selectNext()}.bind(this),t.enter=t.enter||function(){this._menuComponent.activateSelected()}.bind(this),t},g.prototype.setActive=function(t){h.prototype.setActive.call(this,t),this._menuComponent.unselect()},{ELEMENT_ID_SEPARATOR:E,HTMLScreen:h,CanvasText:c,ClipSpaceLayout:u,TextLayer:_,HTMLScreenWithCanvases:p,MenuScreen:g,setAnaglyphTextRendering:m}}),define("armada/screens/battle",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/game","modules/components","modules/screens","modules/media-resources","modules/egom-model","modules/scene/renderable-objects","modules/scene/scene-graph","modules/analytics","armada/strings","armada/screens/shared","armada/graphics","armada/audio","armada/logic/classes","armada/configuration","armada/control","armada/logic/SpacecraftEvents","armada/logic/missions","armada/logic/equipment","armada/logic/ai","utils/polyfill"],function(t,e,i,s,n,o,r,a,l,h,u,c,_,d,p,g,m,f,S,T,E,y,I){"use strict";function A(){var t,e,i;ws!==As&&(e=performance.now(),i=e-ct,S.control(i),I.control(i),t=lt.getFollowedSpacecraftForScene(ht),_t||(lt.tick(i,ht),It+=i,lt.isFinished()||lt.noHostilesPresent()||(he+=i)>ue&&g.playMusic(Et)),t&&(t.canBeReused()||t._away?S.isInPilotMode()?S.switchToSpectatorMode(!0):St&&(ht._camera.followNextNode()||S.switchToSpectatorMode(!0,!0),At=0):St&&f.getBattleSetting(f.BS.DEMO_VIEW_SWITCHING)&&(At+=i)>f.getSetting(f.BS.DEMO_VIEW_SWITCH_INTERVAL)&&(At=0,ht._camera.changeToNextView(),Math.random()<f.getSetting(f.BS.DEMO_DOUBLE_VIEW_SWITCH_CHANCE)&&ht._camera.changeToNextView())),ct=e)}function M(){lt&&lt.destroy(),lt=null,ht&&ht.clear(!0),ht=null,Re&&Re.clear(!0),Re=null,Xt=null,se=null,oe=0,re=null,g.playMusic(null),Vt=0,Ut=0,Bt=0,Ht=0,Gt=0,jt=0,kt=0,Tt="",fs=null}function C(){var t=E.getMissionDescriptor(mt).getTipIDs()||E.getTipIDs(),e=Math.min(Math.floor(Math.random()*t.length),t.length-1);Tt=_.get(_.TIP.PREFIX,t[e])}function N(){_t=!0,ht&&ht.setShouldAnimate(!1)}function O(){ht&&ht.setShouldAnimate(!0),_t=!1}function R(){_t?O():N()}function L(){_e=!1}function x(){_e=!0}function v(){_e=!_e}function b(){var t;for(t=0;t<Ps.length;t++)Ps[t].handleGraphicsSettingsChanged()}function D(){var t=this.getTarget();t&&t.isHostile(this)&&!lt.isFinished()&&(he=0,yt&&g.playMusic(yt))}function w(){return ie={text:_.get(_.BATTLE.MESSAGE_JUMP_ENGAGED),color:ms.colors.jump,queue:xs,permanent:!0,silent:!0},gt.queueHUDMessage(ie,!0),Wt=ht._camera.getConfiguration(),!0}function F(){return gt.clearHUDMessages(xs),ht._camera.startTransitionToConfiguration(Wt),!0}function P(t,e,i){var s=t.vMo.getNode().getCameraConfigurationsWithName(e);return s.length>0&&(ht._camera.startTransitionToConfiguration(s[0],i),!0)}function V(e){e.duration===e.timeLeft&&P(this,f.getSetting(f.BS.JUMP_PREPARE_VIEW_NAME),e.duration),e.timeLeft<=0?(L(),P(this,f.getSetting(f.BS.JUMP_OUT_VIEW_NAME),0)||ht._camera.setToFreeCamera()):gt.queueHUDMessage({text:t.formatString(_.get(_.BATTLE.MESSAGE_JUMP_PREPARING),{timeLeft:t.formatTimeToSeconds(e.timeLeft)}),color:ms.colors.jump,duration:1,queue:xs,silent:!0},!0)}function U(){this===lt.getFollowedSpacecraftForScene(ht)&&(St?P(this,f.getSetting(f.BS.JUMP_OUT_VIEW_NAME),0):ht._camera.setToFreeCamera())}function B(){var t=lt._pilotedCraft;t&&t._alive&&!t._away&&t.isHostile(this)&&(!se||oe<=0?(se&&(se.timeLeft=0),se={text:"\n\n"+_.get(_.BATTLE.MESSAGE_NEW_HOSTILES),color:ms.colors.alert,blinkInterval:f.gHS(f.BS.HUD.NEW_HOSTILES_ALERT_BLINK_INTERVAL),duration:f.gHS(f.BS.HUD.NEW_HOSTILES_ALERT_DURATION),silent:!0,queue:Ls},gt.queueHUDMessage(se,!0),re=[this],ne.play()):re.push(this),oe=se.duration)}function H(e){var i,s;if(s=Ts[t.constantName(e.state)],e.section)fs[Ss[t.constantName(e.section)]]=s;else for(i=0;i<fs.length;i++)fs[i]=s}function G(t,e,i,s,n,o,r,a){this._class=new m.TexturedModelClass({name:Ms,shader:t,texture:e}),this._position=i,this._scale=[.5*s[0],.5*s[1]],this._scaleMode=n,this._color=o,this._angle=0,this._clipCoordinates=h.CLIP_COORDINATES_NO_CLIP.slice(),this._clipColor=r||[0,0,0,0],this._textureCoordinates=a,this.vMo=null,this._node=null}function j(t){return Ps.push(t),t}function k(){return j(new G(Ns,f.gHS(f.BS.HUD.SHIP_INDICATOR).texture,[0,0,0],f.gHS(f.BS.HUD.SHIP_INDICATOR).sizes.maximum,f.gHS(f.BS.HUD.SHIP_INDICATOR).scaleMode,f.gHS(f.BS.HUD.SHIP_INDICATOR).colors.hostile,void 0,f.gHS(f.BS.HUD.SHIP_INDICATOR).mapping))}function W(t){return j(new G(Cs,f.gHS(f.BS.HUD.SHIP_STATUS_INDICATOR).texture,[0,0],f.gHS(f.BS.HUD.SHIP_STATUS_INDICATOR).sizes.reticle,f.gHS(f.BS.HUD.SHIP_STATUS_INDICATOR).scaleMode,f.gHS(f.BS.HUD.SHIP_STATUS_INDICATOR).colors.friendly,void 0,f.gHS(f.BS.HUD.SHIP_STATUS_INDICATOR).mappings[t]))}function X(){return j(new G(Cs,f.gHS(f.BS.HUD.SHIP_ARROW).texture,[0,0],f.gHS(f.BS.HUD.SHIP_ARROW).sizes.default,f.gHS(f.BS.HUD.SHIP_ARROW).scaleMode,f.gHS(f.BS.HUD.SHIP_ARROW).colors.hostile,void 0,f.gHS(f.BS.HUD.SHIP_ARROW).mapping))}function Y(){return j(new G(Cs,f.gHS(f.BS.HUD.MISSILE_LOCK_INDICATOR).texture,[0,0],[1,1],f.gHS(f.BS.HUD.MISSILE_LOCK_INDICATOR).scaleMode,f.gHS(f.BS.HUD.SHIP_ARROW).colors.hostile,void 0,f.gHS(f.BS.HUD.MISSILE_LOCK_INDICATOR).mapping))}function z(){return j(new G(Ns,f.gHS(f.BS.HUD.WEAPON_IMPACT_INDICATOR).texture,[0,0,0],f.gHS(f.BS.HUD.WEAPON_IMPACT_INDICATOR).size,f.gHS(f.BS.HUD.WEAPON_IMPACT_INDICATOR).scaleMode,f.gHS(f.BS.HUD.WEAPON_IMPACT_INDICATOR).colors.normal,void 0,f.gHS(f.BS.HUD.WEAPON_IMPACT_INDICATOR).mapping))}function q(e,i,s){var n,o,a;return n=t.deepCopy(f.gHS(f.BS.HUD.WINGMEN_STATUS_SQUAD_LAYOUT)),n.right+=n.width*e,o=f.gHS(f.BS.HUD.WINGMEN_STATUS_CRAFT_POSITIONS)[i-1][s],a=ps.size,n.right-=n.width*(.5-.5*(o[0]+a[0])),n.top-=n.height*(.5-.5*(o[1]+a[1])),n.width*=a[0],n.height*=a[1],new r.ClipSpaceLayout(n)}function Q(t,e,i){var s,n;return s=ps.mappings,n=new G(Os,ps.texture,t.getClipSpacePosition(),t.getClipSpaceSize(),t._scaleMode,ps.colors.fullIntegrity,void 0,e&&s[e]||s.general),i||j(n),n}function J(t){var e=f.gHS(f.BS.HUD.WINGMEN_STATUS_SQUAD_TEXT).position;return e=[e[0]+2*t*f.gHS(f.BS.HUD.WINGMEN_STATUS_SQUAD_LAYOUT).width/f.gHS(f.BS.HUD.WINGMEN_STATUS_BACKGROUND).layout.width,e[1]],new r.CanvasText(e,"",f.gHS(f.BS.HUD.WINGMEN_STATUS_SQUAD_TEXT).fontName,f.gHS(f.BS.HUD.WINGMEN_STATUS_SQUAD_TEXT).fontSize,wi._scaleMode,f.gHS(f.BS.HUD.WINGMEN_STATUS_SQUAD_TEXT).color,"center")}function K(){var e,i,s,n,o,l,h;for(de=de||j(new G(Cs,f.gHS(f.BS.HUD.CENTER_CROSSHAIR).texture,[0,0],f.gHS(f.BS.HUD.CENTER_CROSSHAIR).size,xi,f.gHS(f.BS.HUD.CENTER_CROSSHAIR).color,void 0,f.gHS(f.BS.HUD.CENTER_CROSSHAIR).mapping)),de.addToScene(ht),$e=$e||j(new G(Cs,f.gHS(f.BS.HUD.DRIFT_ARROW).texture,[0,0],f.gHS(f.BS.HUD.DRIFT_ARROW).size,f.gHS(f.BS.HUD.DRIFT_ARROW).scaleMode,f.gHS(f.BS.HUD.DRIFT_ARROW).colors.maxSpeed,void 0,f.gHS(f.BS.HUD.DRIFT_ARROW).mapping)),$e.addToScene(ht),Ee||(Ee=[X()]),e=0;e<Ee.length;e++)Ee[e].addToScene(ht);if(!Ne)for(Ne=[],n=Object.keys(f.gHS(f.BS.HUD.SHIP_STATUS_INDICATOR).mappings),e=0;e<n.length;e++)Ne.push(W(n[e]));for(e=0;e<Ne.length;e++)Ne[e].addToScene(ht);if(!ye)for(ye=[],e=0;e<f.gHS(f.BS.HUD.MISSILE_LOCK_INDICATOR_COUNT);e++)ye.push(Y());for(e=0;e<f.gHS(f.BS.HUD.MISSILE_LOCK_INDICATOR_COUNT);e++)ye[e].addToScene(ht);for(Te||(Te=[k()]),e=0;e<Te.length;e++)Te[e].addToScene(ht);for(Oe=Oe||j(new G(Ns,f.gHS(f.BS.HUD.AIM_ASSIST_INDICATOR).texture,[0,0,0],f.gHS(f.BS.HUD.AIM_ASSIST_INDICATOR).size,f.gHS(f.BS.HUD.AIM_ASSIST_INDICATOR).scaleMode,f.gHS(f.BS.HUD.AIM_ASSIST_INDICATOR).colors.hostile,void 0,f.gHS(f.BS.HUD.AIM_ASSIST_INDICATOR).mapping)),Oe.addToScene(ht),pe||(pe=[z()]),e=0;e<pe.length;e++)pe[e].addToScene(ht);for(De=De||j(new G(Os,f.gHS(f.BS.HUD.TARGET_INFO_BACKGROUND).texture,Di.getClipSpacePosition(),Di.getClipSpaceSize(),Di._scaleMode,f.gHS(f.BS.HUD.TARGET_INFO_BACKGROUND).color,void 0,f.gHS(f.BS.HUD.TARGET_INFO_BACKGROUND).mapping)),De.addToScene(ht),Ue=Ue||j(new G(Os,f.gHS(f.BS.HUD.WINGMEN_STATUS_BACKGROUND).texture,wi.getClipSpacePosition(),wi.getClipSpaceSize(),wi._scaleMode,f.gHS(f.BS.HUD.WINGMEN_STATUS_BACKGROUND).color,void 0,f.gHS(f.BS.HUD.WINGMEN_STATUS_BACKGROUND).mapping)),Ue.addToScene(ht),ii=ii||j(new G(Os,f.gHS(f.BS.HUD.FLIGHT_MODE_INDICATOR_BACKGROUND).texture,ji.getClipSpacePosition(),ji.getClipSpaceSize(),ji._scaleMode,f.gHS(f.BS.HUD.FLIGHT_MODE_INDICATOR_BACKGROUND).color,void 0,f.gHS(f.BS.HUD.FLIGHT_MODE_INDICATOR_BACKGROUND).mapping)),ii.addToScene(ht),ri=ri||j(new G(Os,f.gHS(f.BS.HUD.MISSILE_INFO_BACKGROUND).texture,ki.getClipSpacePosition(),ki.getClipSpaceSize(),ki._scaleMode,f.gHS(f.BS.HUD.MISSILE_INFO_BACKGROUND).color,void 0,f.gHS(f.BS.HUD.MISSILE_INFO_BACKGROUND).mapping)),ri.addToScene(ht),Ei=Ei||j(new G(Os,f.gHS(f.BS.HUD.OBJECTIVES_BACKGROUND).texture,Yi.getClipSpacePosition(),Yi.getClipSpaceSize(),Yi._scaleMode,f.gHS(f.BS.HUD.OBJECTIVES_BACKGROUND).color,void 0,f.gHS(f.BS.HUD.OBJECTIVES_BACKGROUND).mapping)),Ei.addToScene(ht),Mi=Mi||j(new G(Os,f.gHS(f.BS.HUD.ESCORTS_BACKGROUND).texture,zi.getClipSpacePosition(),zi.getClipSpaceSize(),zi._scaleMode,f.gHS(f.BS.HUD.ESCORTS_BACKGROUND).color,void 0,f.gHS(f.BS.HUD.ESCORTS_BACKGROUND).mapping)),Mi.addToScene(ht),gi=gi||j(new G(Os,f.gHS(f.BS.HUD.MESSAGE_BACKGROUND).texture,qi.getClipSpacePosition(),qi.getClipSpaceSize(),qi._scaleMode,f.gHS(f.BS.HUD.MESSAGE_BACKGROUND).color,void 0,f.gHS(f.BS.HUD.MESSAGE_BACKGROUND).mapping)),gi.addToScene(ht),je||(ke=[],je=[]),e=0;e<je.length;e++)je[e].body.addToScene(ht),je[e].shield.addToScene(ht);if(Ge&&Ge.addToScene(ht),we=we||j(new G(Rs,f.gHS(f.BS.HUD.TARGET_HULL_INTEGRITY_BAR).texture,Fi.getClipSpacePosition(),Fi.getClipSpaceSize(),Fi._scaleMode,f.gHS(f.BS.HUD.TARGET_HULL_INTEGRITY_BAR).colors.filled,f.gHS(f.BS.HUD.TARGET_HULL_INTEGRITY_BAR).colors.empty,f.gHS(f.BS.HUD.TARGET_HULL_INTEGRITY_BAR).mapping)),we.addToScene(ht),Fe=Fe||j(new G(Rs,f.gHS(f.BS.HUD.TARGET_SHIELD_BAR).texture,Pi.getClipSpacePosition(),Pi.getClipSpaceSize(),Pi._scaleMode,f.gHS(f.BS.HUD.TARGET_SHIELD_BAR).colors.filled,f.gHS(f.BS.HUD.TARGET_SHIELD_BAR).colors.empty,f.gHS(f.BS.HUD.TARGET_SHIELD_BAR).mapping)),Fe.addToScene(ht),Xe=Xe||j(new G(Rs,f.gHS(f.BS.HUD.SPEED_BAR).texture,Vi.getClipSpacePosition(),Vi.getClipSpaceSize(),Vi._scaleMode,f.gHS(f.BS.HUD.SPEED_BAR).colors.combatFilled,f.gHS(f.BS.HUD.SPEED_BAR).colors.combatEmpty,f.gHS(f.BS.HUD.SPEED_BAR).mapping)),Xe.addToScene(ht),Ye=Ye||j(new G(Rs,f.gHS(f.BS.HUD.SPEED_TARGET_INDICATOR).texture,Vi.getClipSpacePosition(),Vi.getClipSpaceSize(),Vi._scaleMode,f.gHS(f.BS.HUD.SPEED_TARGET_INDICATOR).color,void 0,f.gHS(f.BS.HUD.SPEED_TARGET_INDICATOR).mapping)),Ye.addToScene(ht),ze=ze||j(new G(Rs,f.gHS(f.BS.HUD.MISSILE_INDICATOR).texture,Bi.getClipSpacePosition(),Bi.getClipSpaceSize(),Bi._scaleMode,f.gHS(f.BS.HUD.MISSILE_INDICATOR).colors.loading,f.gHS(f.BS.HUD.MISSILE_INDICATOR).colors.loading,f.gHS(f.BS.HUD.MISSILE_INDICATOR).mappings.single)),ze.addToScene(ht),h=new G(Rs,f.gHS(f.BS.HUD.MISSILE_INDICATOR).texture,Bi.getClipSpacePosition(),Bi.getClipSpaceSize(),Bi._scaleMode,f.gHS(f.BS.HUD.MISSILE_INDICATOR).colors.loading,f.gHS(f.BS.HUD.MISSILE_INDICATOR).colors.loading,f.gHS(f.BS.HUD.MISSILE_INDICATOR).mappings.salvo),h.addResourcesToScene(ht),ti=ti||j(new G(Rs,f.gHS(f.BS.HUD.HULL_INTEGRITY_BAR).texture,Hi.getClipSpacePosition(),Hi.getClipSpaceSize(),Hi._scaleMode,f.gHS(f.BS.HUD.HULL_INTEGRITY_BAR).colors.filled,f.gHS(f.BS.HUD.HULL_INTEGRITY_BAR).colors.empty,f.gHS(f.BS.HUD.HULL_INTEGRITY_BAR).mapping)),ti.addToScene(ht),ei=ei||j(new G(Rs,f.gHS(f.BS.HUD.SHIELD_BAR).texture,Gi.getClipSpacePosition(),Gi.getClipSpaceSize(),Gi._scaleMode,f.gHS(f.BS.HUD.SHIELD_BAR).colors.filled,f.gHS(f.BS.HUD.SHIELD_BAR).colors.empty,f.gHS(f.BS.HUD.SHIELD_BAR).mapping)),ei.addToScene(ht),ge=ge||j(new G(Rs,f.gHS(f.BS.HUD.TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR).texture,Wi.getClipSpacePosition(),Wi.getClipSpaceSize(),Wi._scaleMode,f.gHS(f.BS.HUD.TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR).colors.hostileFilled,void 0,f.gHS(f.BS.HUD.TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR).mapping)),ge.addToScene(ht),me=me||j(new G(Rs,f.gHS(f.BS.HUD.TARGET_SHIELD_QUICK_VIEW_BAR).texture,Xi.getClipSpacePosition(),Xi.getClipSpaceSize(),Xi._scaleMode,f.gHS(f.BS.HUD.TARGET_SHIELD_QUICK_VIEW_BAR).colors.filled,void 0,f.gHS(f.BS.HUD.TARGET_SHIELD_QUICK_VIEW_BAR).mapping)),me.addToScene(ht),i=f.gHS(f.BS.HUD.MAX_ESCORTS_DISPLAYED),!Ri)for(Ri=[],e=0;e<i;e++)Ri.push({}),l=t.deepCopy(ds.layouts.hull),l.top+=e*f.gHS(f.BS.HUD.ESCORTS_TEXT_OFFSET)*zi.getClipSpaceHeight()*.5,Ri[e].hullLayout=new r.ClipSpaceLayout(l),Ri[e].hull=j(new G(Rs,ds.texture,Ri[e].hullLayout.getClipSpacePosition(),Ri[e].hullLayout.getClipSpaceSize(),Ri[e].hullLayout._scaleMode,ds.colors.fullHull,ds.colors.destroyed,ds.mapping)),l=t.deepCopy(ds.layouts.shield),l.top+=e*f.gHS(f.BS.HUD.ESCORTS_TEXT_OFFSET)*zi.getClipSpaceHeight()*.5,Ri[e].shieldLayout=new r.ClipSpaceLayout(l),Ri[e].shield=j(new G(Rs,ds.texture,Ri[e].shieldLayout.getClipSpacePosition(),Ri[e].shieldLayout.getClipSpaceSize(),Ri[e].shieldLayout._scaleMode,ds.colors.shield,ds.colors.lostShield,ds.mapping));for(e=0;e<i;e++)Ri[e].hull.addToScene(ht),Ri[e].shield.addToScene(ht);for(fe=fe||j(new G(Cs,f.gHS(f.BS.HUD.CURSOR).texture,[0,0],f.gHS(f.BS.HUD.CURSOR).size,f.gHS(f.BS.HUD.CURSOR).scaleMode,f.gHS(f.BS.HUD.CURSOR).color,void 0,f.gHS(f.BS.HUD.CURSOR).mappings.still)),fe.addToScene(ht),Se=Se||j(new G(Cs,f.gHS(f.BS.HUD.CURSOR).texture,[0,0],f.gHS(f.BS.HUD.CURSOR).size,f.gHS(f.BS.HUD.CURSOR).scaleMode,f.gHS(f.BS.HUD.CURSOR).color,void 0,f.gHS(f.BS.HUD.CURSOR).mappings.turn)),Se.addToScene(ht),s=q(0,1,0),n=Object.keys(ps.mappings),e=0;e<n.length;e++)o=Q(s,n[e],!0),o.addResourcesToScene(ht);a.getSoundEffect(f.gHS(f.BS.HUD.TARGET_SWITCH_SOUND).name),a.getSoundEffect(f.gHS(f.BS.HUD.TARGET_SWITCH_DENIED_SOUND).name),a.getSoundEffect(f.gHS(f.BS.HUD.FLIGHT_MODE_SWITCH_SOUND).name),a.getSoundEffect(f.gHS(f.BS.HUD.MISSILE_CHANGE_SOUND).name),a.getSoundEffect(f.gHS(f.BS.HUD.MISSILE_CHANGE_DENIED_SOUND).name),a.getSoundEffect(f.gHS(f.BS.HUD.MISSILE_SALVO_SOUND).name),a.getSoundEffect(f.gHS(f.BS.HUD.MISSILE_LOADED_SOUND).name),a.getSoundEffect(f.gHS(f.BS.HUD.MISSILE_LOCKING_SOUND).name),a.getSoundEffect(f.gHS(f.BS.HUD.MISSILE_LOCKED_SOUND).name),a.getSoundEffect(f.gHS(f.BS.HUD.MESSAGE_SOUND).name),a.getSoundEffect(f.gHS(f.BS.HUD.MESSAGE_TYPE_SOUND).name),a.getSoundEffect(f.gHS(f.BS.HUD.NEW_HOSTILES_ALERT_SOUND).name)}function Z(){return"<span class='highlightedText'>"+S.getInputInterpreter(S.KEYBOARD_NAME).getControlStringForAction("quit")+"</span>"}function $(t){return t._alive&&!t._away&&t!==Ot}function tt(t){return t!==Ot}function et(t){return t>1e3?(t/1e3).toPrecision(3)+"k":Math.round(t).toString()}function it(e,i,s,n){return e>.5?t.getMixedColor(s,i,2*(e-.5)):t.getMixedColor(n,s,2*e)}function st(t){t.setUniformValueFunction(h.UNIFORM_COLOR_NAME,function(){return be}),t.setScale(1/t.getSize()),xe=t}function nt(t){return fs[t]===Ts.VISIBLE||fs[t]===Ts.HIGHLIGHTED&&le}function ot(){r.HTMLScreenWithCanvases.call(this,d.BATTLE_SCREEN_NAME,d.BATTLE_SCREEN_SOURCE,{cssFilename:d.BATTLE_SCREEN_CSS,backgroundClassName:d.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:d.SCREEN_CONTAINER_CLASS_NAME},p.getAntialiasing(),!0,p.getFiltering(),f.getSetting(f.GENERAL_SETTINGS.USE_REQUEST_ANIM_FRAME),{activate:function(){Li=f.gHS(f.BS.HUD.AIM_ASSIST_CROSSHAIRS)}}),this._stats=this.registerSimpleComponent(Es),this._loadingBox=this.registerExternalComponent(new o.LoadingBox(ys,d.LOADING_BOX_SOURCE,{cssFilename:d.LOADING_BOX_CSS},_.LOADING.HEADER.name)),this._infoBox=this.registerExternalComponent(new o.InfoBox(Is,d.INFO_BOX_SOURCE,{cssFilename:d.INFO_BOX_CSS},_.INFO_BOX.HEADER.name,_.INFO_BOX.OK_BUTTON.name,{show:function(){this.pauseBattle()}.bind(this),hide:function(){this.resumeBattle(),O(),St?(S.switchToSpectatorMode(!1,!0),ht._camera.followNextNode(),At=0):S.switchToPilotMode(lt._pilotedCraft,!0)}.bind(this),buttonselect:d.playButtonSelectSound,buttonclick:d.playButtonClickSound}))}function rt(t){return t.state===E.ObjectiveState.COMPLETED}function at(){var e,i,s,o,r,a=!1;i=lt._pilotedCraft,e=lt._state===E.MissionState.COMPLETED,r=E.getMissionDescriptor(lt._name),lt._state!==E.MissionState.NONE&&r.increasePlaythroughCount(e),s=i?i.getHitRatio():0,o=i?lt.getPerformanceStatistics():{},e&&!r._custom&&(a=r.updateBestScore(o.score,o.performance),c.sendEvent("score",[t.getFilenameWithoutExtension(mt)],{difficulty:ft,score:o.score})),n.getScreen(d.DEBRIEFING_SCREEN_NAME).setData({missionState:lt._state,objectives:lt.getObjectives(),objectivesCompleted:lt.getObjectivesState(!0).map(rt),performance:e?o.performance:E.FAILED_MISSION_PERFORMACE,nextPerformance:e?o.nextPerformance:null,nextPerformanceScore:e?o.nextPerformanceScore:0,score:e?o.score:0,isRecord:a,elapsedTime:It,kills:i?i.getKills():0,damageDealt:i?Math.round(i.getDamageDealt()):0,baseScore:o.baseScore||0,hitRatio:s,hitRatioBonus:o.hitRatioBonus,missileDamageDealt:i?Math.round(i.getMissileDamageDealt()):0,missilesLaunched:i?Math.round(i.getMissilesLaunched()):0,missilesHit:i?Math.round(i.getMissileHitsOnEnemies()):0,hullIntegrity:i?i.getHullIntegrity():0,hullIntegrityBonus:o.hullIntegrityBonus,teamSurvival:o.teamSurvival,teamSurvivalBonus:o.teamSurvivalBonus,nextMissionName:e?lt.getNextMissionName():null}),n.setScreen(d.DEBRIEFING_SCREEN_NAME)}var lt,ht,ut,ct,_t,dt,pt,gt,mt,ft,St,Tt,Et,yt,It,At,Mt,Ct,Nt,Ot,Rt,Lt,xt,vt,bt,Dt,wt,Ft,Pt,Vt,Ut,Bt,Ht,Gt,jt,kt,Wt,Xt,Yt,zt,qt,Qt,Jt,Kt,Zt,$t,te,ee,ie,se,ne,oe,re,ae,le,he,ue,ce,_e,de,pe,ge,me,fe,Se,Te,Ee,ye,Ie,Ae,Me,Ce,Ne,Oe,Re,Le,xe,ve,be,De,we,Fe,Pe,Ve,Ue,Be,He,Ge,je,ke,We,Xe,Ye,ze,qe,Qe,Je,Ke,Ze,$e,ti,ei,ii,si,ni,oi,ri,ai,li,hi,ui,ci,_i,di,pi,gi,mi,fi,Si,Ti,Ei,yi,Ii,Ai,Mi,Ci,Ni,Oi,Ri,Li,xi,vi,bi,Di,wi,Fi,Pi,Vi,Ui,Bi,Hi,Gi,ji,ki,Wi,Xi,Yi,zi,qi,Qi,Ji,Ki,Zi,$i,ts,es,is,ss,ns,os,rs,as,ls,hs,us,cs,_s,ds,ps,gs,ms,fs,Ss={TARGET_INFO:0,TARGET_INDICATOR:1,SHIP_INDICATORS:2,AIM_ASSIST_INDICATOR:3,WEAPON_IMPACT_INDICATORS:4,HULL_BAR:5,SHIELD_BAR:6,SPEED_BAR:7,DRIFT_ARROW:8,FLIGHT_MODE:9,WINGMEN_INFO:10,MISSILE_INFO:11,MISSILE_INDICATOR:12,OBJECTIVES:13,ESCORTS:14,SCORE:15},Ts={VISIBLE:0,HIDDEN:1,HIGHLIGHTED:2
},Es="stats",ys="loadingBox",Is="infoBox",As=-1,Ms="hudElementClass",Cs="ui2d",Ns="ui3d",Os="ui2d-mix-viewport",Rs="ui2d-clip-viewport",Ls="hostileAlert",xs="system",vs=[xs,"mission","info",Ls],bs=["name","class","team","firepower","distance","velocity"],Ds={weapons:!0},ws=As,Fs={},Ps=[],Vs=i.identity4();return Object.freeze(Ss),Object.freeze(Ts),G.prototype._getModelName=function(){return"squareModel"+(this._textureCoordinates?"-"+this._textureCoordinates[0].join("-")+"-"+this._textureCoordinates[1].join("-"):"")},G.prototype._acquireResources=function(){var t,e;t=this._getModelName(),e=a.getModel(t,{allowNullResult:!0}),this._class.acquireResources({model:e||l.squareModel(t,this._textureCoordinates)})},G.prototype._initVisualModel=function(){this.vMo?this.vMo.init(this._class.getModel(),this._class.getShader(),this._class.getTexturesOfTypes(this._class.getShader().getTextureTypes(),p.getTextureQualityPreferenceList()),this._position,this._scale,this._scaleMode,this._color,Math.degrees(this._angle),this._clipCoordinates,this._clipColor):this.vMo=new h.UIElement(this._class.getModel(),this._class.getShader(),this._class.getTexturesOfTypes(this._class.getShader().getTextureTypes(),p.getTextureQualityPreferenceList()),this._position,this._scale,this._scaleMode,this._color,Math.degrees(this._angle),this._clipCoordinates,this._clipColor)},G.prototype.addToScene=function(t){this._acquireResources(),a.executeWhenReady(function(){this._initVisualModel(),this._node=t.addUIObject(this.vMo)}.bind(this))},G.prototype.addResourcesToScene=function(t){this._acquireResources(),a.executeWhenReady(function(){this._initVisualModel(),t.addResourcesOfObject(this.vMo)}.bind(this))},G.prototype.hide=function(){this._node.hide()},G.prototype.show=function(){this._node.show()},G.prototype.isVisible=function(){return this._node.isVisible()},G.prototype.setPosition=function(t){this._position=t,this.vMo&&this.vMo.setPosition(t)},G.prototype.setSize=function(t){this._scale[0]=.5*t[0],this._scale[1]=.5*t[1],this.vMo&&this.vMo.setSize(this._scale)},G.prototype.setAngle=function(t){this._angle=t,this.vMo&&this.vMo.setAngle(t)},G.prototype.setColor=function(t){this._color=t,this.vMo&&this.vMo.setColor(t)},G.prototype.clipX=function(e,i){this._textureCoordinates&&(e=t.getLinearMix(this._textureCoordinates[0][0],this._textureCoordinates[1][0],e),i=t.getLinearMix(this._textureCoordinates[0][0],this._textureCoordinates[1][0],i)),this._clipCoordinates[0]=e,this._clipCoordinates[1]=i,this.vMo&&this.vMo.clipX(e,i)},G.prototype.clipY=function(e,i){this._textureCoordinates&&(e=1-t.getLinearMix(this._textureCoordinates[1][1],this._textureCoordinates[0][1],e),i=1-t.getLinearMix(this._textureCoordinates[1][1],this._textureCoordinates[0][1],i)),this._clipCoordinates[2]=1-i,this._clipCoordinates[3]=1-e,this.vMo&&this.vMo.clipY(e,i)},G.prototype.setClipColor=function(t){this._clipColor=t,this.vMo&&this.vMo.setClipColor(t)},G.prototype.setTextureCoordinates=function(t){this._textureCoordinates=t,this.vMo&&this.vMo.setModel(p.getModel(this._getModelName()).getEgomModel())},G.prototype.setScaleMode=function(t){this._scaleMode=t,this.vMo&&this.vMo.setScaleMode(t)},G.prototype.applyLayout=function(t,e,i){this.setPosition(t.getPosition(e,i)),this.setSize(t.getSize(e,i))},G.prototype.handleGraphicsSettingsChanged=function(){this._class.handleGraphicsSettingsChanged()},ot.prototype=new r.HTMLScreenWithCanvases,ot.prototype.constructor=ot,ot.prototype.hide=function(){return!!r.HTMLScreenWithCanvases.prototype.hide.call(this)&&(this.pauseBattle(),M(),!0)},ot.prototype._initializeComponents=function(){var t;r.HTMLScreenWithCanvases.prototype._initializeComponents.call(this),t=this.getScreenCanvas("battleCanvas").getCanvasElement(),dt&&window.removeEventListener("resize",dt),dt=dt||function(){S.setScreenCenter(t.width/2,t.height/2)},window.addEventListener("resize",dt),dt()},ot.prototype._updateComponents=function(){r.HTMLScreenWithCanvases.prototype._updateComponents.call(this)},ot.prototype.pauseBattle=function(t,e){S.stopListening(),ut=document.body.style.cursor,document.body.style.cursor=n.getDefaultCursor(),-2!==ws&&clearInterval(ws),ws=As,ht&&ht.setShouldAnimate(!1),this.stopRenderLoop(),!1!==t&&(g.resetMusicVolume(),g.setMusicVolume(f.getSetting(f.BS.MUSIC_VOLUME_IN_MENUS)*g.getMusicVolume(),!1)),!1!==e&&(g.resetSFXVolume(),g.setSFXVolume(f.getSetting(f.BS.SFX_VOLUME_IN_MENUS)*g.getSFXVolume(),!1)),qt&&qt.stopPlaying(.01)},ot.prototype.resumeBattle=function(){document.body.style.cursor=ut||n.getDefaultCursor(),ws===As?(ct=performance.now(),ht&&(_t||ht.setShouldAnimate(!0)),ws=f.getSetting(f.GENERAL_SETTINGS.USE_REQUEST_ANIM_FRAME)?-2:setInterval(A,1e3/f.getSetting(f.BS.SIMULATION_STEPS_PER_SECOND)),S.startListening(),this.startRenderLoop(1e3/f.getSetting(f.BS.RENDER_FPS))):s.showError("Trying to resume simulation while it is already going on!",s.ErrorSeverity.MINOR,"No action was taken, to avoid double-running the simulation."),g.resetMusicVolume(),g.resetSFXVolume()},ot.prototype._updateLoadingStatus=function(t,e){void 0!==t&&this._loadingBox.updateStatus(Tt+d.getSubParagraph(t)),void 0!==e&&this._loadingBox.updateProgress(e)},ot.prototype._updateLoadingBoxForResourceLoad=function(e,i,s,n){this._updateLoadingStatus(t.formatString(_.get(_.LOADING.RESOURCE_READY),{resource:e,resourceType:i,loaded:n,total:s}),20+n/s*60)},ot.prototype._addUITexts=function(){var t,e,i,s=this.getScreenCanvas("battleCanvas"),n=function(t,e,i,s){var n,o;return n=f.gHS(t),o=new r.CanvasText(n.position,"",n.fontName,n.fontSize,e._scaleMode,n.color||n.colors[Object.keys(n.colors)[0]],s),i.addText(o),o},o=function(t){return new r.CanvasText(t,"",f.gHS(f.BS.HUD.SPEED_TEXT).fontName,f.gHS(f.BS.HUD.SPEED_TEXT).fontSize,Vi._scaleMode,f.gHS(f.BS.HUD.SPEED_TEXT).colors.combatForward)};if(Me||(Me=new r.TextLayer(f.gHS(f.BS.HUD.DISTANCE_TEXT_LAYER_LAYOUT)),s.addTextLayer(Me)),Ce||(Ce=new r.CanvasText(f.gHS(f.BS.HUD.DISTANCE_TEXT).position,"",f.gHS(f.BS.HUD.DISTANCE_TEXT).fontName,f.gHS(f.BS.HUD.DISTANCE_TEXT).fontSize,new r.ClipSpaceLayout(vi)._scaleMode,f.gHS(f.BS.HUD.DISTANCE_TEXT).colors.hostile,"left",f.gHS(f.BS.HUD.DISTANCE_TEXT).layout),Me.addText(Ce)),Pe||(Pe=new r.TextLayer(f.gHS(f.BS.HUD.TARGET_INFO_TEXT_LAYER_LAYOUT)),s.addTextLayer(Pe)),!Ve)for(Ve={},t=0;t<bs.length;t++)Ve[bs[t]]=function(t){return new r.CanvasText(f.gHS(f.BS.HUD.TARGET_INFO_TEXT).positions[t],"",f.gHS(f.BS.HUD.TARGET_INFO_TEXT).fontName,f.gHS(f.BS.HUD.TARGET_INFO_TEXT).fontSizes["name"===t?"name":"others"],Di._scaleMode,f.gHS(f.BS.HUD.TARGET_INFO_TEXT).colors.friendly)}(bs[t]),Pe.addText(Ve[bs[t]]);if(Be||(Be=new r.TextLayer(f.gHS(f.BS.HUD.WINGMEN_STATUS_BACKGROUND).layout),s.addTextLayer(Be)),He=He||n(f.BS.HUD.WINGMEN_STATUS_HEADER_TEXT,wi,Be),He.setText(_.get(_.BATTLE.HUD_WINGMEN_HEADER)),We||(We=[]),Je||(Je=new r.TextLayer(f.gHS(f.BS.HUD.SPEED_TEXT_LAYER_LAYOUT)),s.addTextLayer(Je)),Ke||(Ke=o(f.gHS(f.BS.HUD.SPEED_TEXT).positions.maxForward),Je.addText(Ke)),Ze||(Ze=o(f.gHS(f.BS.HUD.SPEED_TEXT).positions.maxReverse),Je.addText(Ze)),qe||(qe=new r.TextLayer(f.gHS(f.BS.HUD.MISSILE_INDICATOR_TEXT_LAYOUT)),s.addTextLayer(qe)),Qe||(Qe=new r.CanvasText(f.gHS(f.BS.HUD.MISSILE_INDICATOR_TEXT).position,"",f.gHS(f.BS.HUD.MISSILE_INDICATOR_TEXT).fontName,f.gHS(f.BS.HUD.MISSILE_INDICATOR_TEXT).fontSize,Bi._scaleMode,f.gHS(f.BS.HUD.MISSILE_INDICATOR_TEXT).colors.ready,"right"),qe.addText(Qe)),si||(si=new r.TextLayer(f.gHS(f.BS.HUD.FLIGHT_MODE_INDICATOR_BACKGROUND).layout),s.addTextLayer(si)),ni=ni||n(f.BS.HUD.FLIGHT_MODE_HEADER_TEXT,ji,si),ni.setText(_.get(_.BATTLE.HUD_FLIGHT_MODE)),oi||(oi=new r.CanvasText(f.gHS(f.BS.HUD.FLIGHT_MODE_TEXT).position,"",f.gHS(f.BS.HUD.FLIGHT_MODE_TEXT).fontName,f.gHS(f.BS.HUD.FLIGHT_MODE_TEXT).fontSize,ji._scaleMode,f.gHS(f.BS.HUD.FLIGHT_MODE_TEXT).colors.combat),si.addText(oi)),ai||(ai=new r.TextLayer(f.gHS(f.BS.HUD.MISSILE_INFO_BACKGROUND).layout),s.addTextLayer(ai)),li=li||n(f.BS.HUD.MISSILE_INFO_HEADER_TEXT,ki,ai),li.setText(_.get(_.BATTLE.HUD_MISSILES)),!hi)for(hi=[],ui=[],e=f.gHS(f.BS.HUD.MAX_MISSILE_INFO_DISPLAYED),t=0;t<e;t++)hi.push(function(t){var e=f.gHS(f.BS.HUD.MISSILE_INFO_TEXT).positions.name;return e=[e[0],e[1]+t*f.gHS(f.BS.HUD.MISSILE_INFO_TEXT_OFFSET)],new r.CanvasText(e,"",f.gHS(f.BS.HUD.MISSILE_INFO_TEXT).fontName,f.gHS(f.BS.HUD.MISSILE_INFO_TEXT).fontSize,ki._scaleMode,f.gHS(f.BS.HUD.MISSILE_INFO_TEXT).colors.notSelected)}(t)),ai.addText(hi[t]),ui.push(function(t){var e=f.gHS(f.BS.HUD.MISSILE_INFO_TEXT).positions.count;return e=[e[0],e[1]+t*f.gHS(f.BS.HUD.MISSILE_INFO_TEXT_OFFSET)],new r.CanvasText(e,"",f.gHS(f.BS.HUD.MISSILE_INFO_TEXT).fontName,f.gHS(f.BS.HUD.MISSILE_INFO_TEXT).fontSize,ki._scaleMode,f.gHS(f.BS.HUD.MISSILE_INFO_TEXT).colors.notSelected,"right")}(t)),ai.addText(ui[t]);if(ci||(ci=new r.TextLayer(f.gHS(f.BS.HUD.HEADER_TEXT_LAYER_LAYOUT)),s.addTextLayer(ci)),_i=_i||n(f.BS.HUD.SMALL_HEADER_TEXT,ci.getLayout(),ci,"center"),di=di||n(f.BS.HUD.BIG_HEADER_TEXT,ci.getLayout(),ci,"center"),pi=pi||n(f.BS.HUD.SUBHEADER_TEXT,ci.getLayout(),ci,"center"),mi||(i=f.gHS(f.BS.HUD.MESSAGE_BACKGROUND).layout,i.width-=f.gHS(f.BS.HUD.MESSAGE_TEXT_MARGIN),mi=new r.TextLayer(i),s.addTextLayer(mi)),fi=fi||n(f.BS.HUD.MESSAGE_TEXT,mi.getLayout(),mi,"center"),Si||(Si=new r.TextLayer(f.gHS(f.BS.HUD.TOP_LEFT_TEXT_LAYER_LAYOUT)),s.addTextLayer(Si)),Ti=Ti||n(f.BS.HUD.SCORE_TEXT,Si.getLayout(),Si,"left"),yi||(yi=new r.TextLayer(f.gHS(f.BS.HUD.OBJECTIVES_BACKGROUND).layout),s.addTextLayer(yi)),Ii=Ii||n(f.BS.HUD.OBJECTIVES_HEADER_TEXT,Yi,yi),Ii.setText(_.get(_.BATTLE.HUD_OBJECTIVES)),!Ai)for(Ai=[],e=f.gHS(f.BS.HUD.MAX_OBJECTIVES_DISPLAYED),t=0;t<e;t++)Ai.push(function(t){var e=f.gHS(f.BS.HUD.OBJECTIVES_TEXT).position;return e=[e[0],e[1]+t*f.gHS(f.BS.HUD.OBJECTIVES_TEXT_OFFSET)],new r.CanvasText(e,"",f.gHS(f.BS.HUD.OBJECTIVES_TEXT).fontName,f.gHS(f.BS.HUD.OBJECTIVES_TEXT).fontSize,Yi._scaleMode,f.gHS(f.BS.HUD.OBJECTIVES_TEXT).colors.inProgress)}(t)),yi.addText(Ai[t]);if(Ci||(Ci=new r.TextLayer(f.gHS(f.BS.HUD.ESCORTS_BACKGROUND).layout),s.addTextLayer(Ci)),Ni=Ni||n(f.BS.HUD.ESCORTS_HEADER_TEXT,zi,Ci),Ni.setText(_.get(_.BATTLE.HUD_ESCORTED_SHIPS_HEADER)),!Oi)for(Oi=[],e=f.gHS(f.BS.HUD.MAX_ESCORTS_DISPLAYED),t=0;t<e;t++)Oi.push(function(t){var e=f.gHS(f.BS.HUD.ESCORTS_TEXT).position;return e=[e[0],e[1]+t*f.gHS(f.BS.HUD.ESCORTS_TEXT_OFFSET)],new r.CanvasText(e,"",f.gHS(f.BS.HUD.ESCORTS_TEXT).fontName,f.gHS(f.BS.HUD.ESCORTS_TEXT).fontSize,zi._scaleMode,f.gHS(f.BS.HUD.ESCORTS_TEXT).colors.alive)}(t)),Ci.addText(Oi[t])},ot.prototype.showDevelopmentInfo=function(){this._stats.show(),_i.show()},ot.prototype.hideDevelopmentInfo=function(){this._stats.hide(),_i.hide()},ot.prototype.toggleDevInfoVisibility=function(){this._stats.isVisible()?this.hideDevelopmentInfo():this.showDevelopmentInfo()},ot.prototype.showMessage=function(t){this._infoBox.updateMessage(t),this._infoBox.show()},ot.prototype.setHeaderContent=function(t,e){di&&di.setText(t,e)},ot.prototype.setSubheaderContent=function(t,e){pi&&pi.setText(t,e)},ot.prototype.queueHUDMessage=function(t,e){var i,n,o,r,a,l,h,u,c;for(i=t.text,n=i.indexOf("{");n>=0;n=i.indexOf("{"))if((o=i.indexOf("}"))>=0){switch(l=i.substring(n+1,o).split("/"),l[0]){case"controlStrings":h="[color:"+ms.colors.controlString.join(",")+"]"+S.getInputInterpreter(l[1]).getControlStringForAction(l[2])+"[]";break;case"spacecrafts":c=lt.getSpacecraft(l[1]),h="[color:"+(Ot.isHostile(c)?ms.colors.hostileSpacecraft:ms.colors.friendlySpacecraft).join(",")+"]"+c.getDisplayName()+"[]";break;default:s.showError("Unknown reference type specified in HUD message: '"+l[0]+"'!"),h=""}i=i.substring(0,n)+h+i.substr(o+1)}else s.showError("Unclosed reference in HUD message: '"+t.text+"'!");for(a=0,u=!1,r=0;r<i.length;r++)"["===i[r]?u=!0:"]"===i[r]?u=!1:!1===u&&"\n"!==i[r]&&a++;t.text=i,t.new=!0,t.timeLeft=t.duration||Math.round(70*a+400),t.appearDuration=t.appearAnimation?Math.round(7*a):0,t.appearTimeLeft=t.appearDuration||0,t.queue=t.queue||"info",e?Xt[t.queue].unshift(t):Xt[t.queue].push(t)},ot.prototype.clearHUDMessages=function(t){Xt[t||"info"]=[]},ot.prototype.clearHUDMessageQueues=function(){var t;for(t=0;t<vs.length;t++)Xt[vs[t]]=[]},ot.prototype._updateHUD=function(n){var o,r,a,l,h,u,c,d,g,m,T,I,A,M,C,N,O,R,L,x,v,b,D,w,F,P,V,U,B,H,G,j,Y,K,Z,ot,rt,at,ut,ct,_t,dt,pt,gt,mt,ft,Tt,Et,yt,It,At,Mt,Ct,Nt,Wt,ie,ne,he,ue,He,ni,li,ci,_i,Si,Ii,Ni,fs,Ts,Es,ys,Is,As,Ms,Cs,Ns,Os,Rs,Ls,xs,bs,ws,Fs,Ps,Vs,Us,Bs,Hs,Gs,js=lt?lt.getFollowedSpacecraftForScene(ht):null,ks=this.getScreenCanvas("battleCanvas").getCanvasElement();if(Ns=!1,js&&_e){if(ae=(ae+n)%ce,le=ae<.5*ce,Si=js.getView(ht._camera.getConfiguration()._name)._isAimingView,di.show(),S.isInPilotMode()?(pi.hide(),nt(Ss.SCORE)?(Ti.setText(t.formatString(_.get(_.BATTLE.SCORE),{score:Math.round(js.getScore())})),Ti.show()):Ti.hide()):(pi.setText(js.getDisplayName()||js.getClass().getDisplayName()),pi.show(),Ti.hide()),Si?de.show():de.hide(),ws=S.getInputInterpreter(S.MOUSE_NAME),S.isListening()&&ws.isEnabled()&&S.isInPilotMode()&&!S.isControllerPriority(S.CAMERA_CONTROLLER_NAME)&&!S.isMouseTurningDisabled()&&!js.isManeuveringLocked()?(ot=ws._mousePosition,ot=[2*(ot[0]/ks.width-.5),2*(.5-ot[1]/ks.height)],ws.isMouseDisplaced()?(fe.hide(),Se.show(),Se.setPosition(ot),Y=e.angle2y(ot[0]*ks.width/ks.height,ot[1]),Se.setAngle(Y*(ot[0]<0?-1:1))):(fe.show(),Se.hide(),fe.setPosition(ot))):(fe.hide(),Se.hide()),yt=js.getRelativeVelocityMatrix(),nt(Ss.SPEED_BAR)){if(L=yt[13],x=Math.abs(L),R=js.getMaxAcceleration(),!(v=js.getMaxSpeed()))for(v=f.gHS(f.BS.HUD.SPEED_BAR_BASE_MAX_SPEED_FACTOR)*R||f.gHS(f.BS.HUD.SPEED_BAR_DEFAULT_BASE_MAX_SPEED),b=f.gHS(f.BS.HUD.SPEED_BAR_MAX_SPEED_STEP_FACTOR),D=f.gHS(f.BS.HUD.SPEED_BAR_MAX_SPEED_STEP_BUFFER);v+D<x;)v*=b;js.hasSpeedTarget()&&(F=js.getSpeedTarget(),F=L*F>=0?Math.abs(F):0),w=Math.min(x/v,1),at=f.gHS(f.BS.HUD.SPEED_TEXT).positions.maxForward,ut=f.gHS(f.BS.HUD.SPEED_TEXT).positions.maxReverse,li=f.gHS(f.BS.HUD.SPEED_BAR).colors,Fs=js.getFlightMode(),L>=0?(Xe.setColor(li[Fs+"Filled"]),Xe.setClipColor(li[Fs+"Empty"]),Xe.clipY(0,w),Ke.setPosition(at),Ke.setColor(f.gHS(f.BS.HUD.SPEED_TEXT).colors[Fs+"Forward"]),Ke.setText(Math.max(v,L).toFixed()),Ze.setPosition([at[0],ut[1]+(at[1]-ut[1])*w]),Ze.setColor(f.gHS(f.BS.HUD.SPEED_TEXT).colors[Fs+"Forward"]),Ze.setText(x.toFixed()),Ye.clipX(.5-Ui[0]/2,.5+Ui[0]/2),js.hasSpeedTarget()?(Ye.clipY(F/v-Ui[1]/2,F/v+Ui[1]/2),Ye.show()):Ye.hide()):(Xe.setColor(li[Fs+"ReverseFilled"]),Xe.setClipColor(li[Fs+"ReverseEmpty"]),Xe.clipY(1-w,1),Ke.setPosition(ut),Ke.setColor(f.gHS(f.BS.HUD.SPEED_TEXT).colors[Fs+"Reverse"]),Ke.setText(Math.min(-v,L).toFixed()),Ze.setPosition([at[0],at[1]-(at[1]-ut[1])*w]),Ze.setColor(f.gHS(f.BS.HUD.SPEED_TEXT).colors[Fs+"Reverse"]),Ze.setText("-"+x.toFixed()),Ye.clipX(.5-Ui[0]/2,.5+Ui[0]/2),js.hasSpeedTarget()?(Ye.clipY(1-(F/v+Ui[1]/2),1-(F/v-Ui[1]/2)),Ye.show()):Ye.hide()),Xe.applyLayout(Vi,ks.width,ks.height),Xe.show(),Ye.applyLayout(Vi,ks.width,ks.height),Je.show()}else Xe.hide(),Ye.hide(),Je.hide();if(Si&&nt(Ss.DRIFT_ARROW)?(rt=[yt[12],yt[14]],P=e.extractLength2(rt),P>cs?($e.show(),h=ht._camera.getAspect(),U=f.gHS(f.BS.HUD.DRIFT_ARROW_POSITION_RADIUS)*(t.yScalesWithHeight(xi,ks.width,ks.height)?1:h),$e.setPosition(e.scaled2([rt[0]/h,rt[1]],U)),$e.setAngle(Math.acos(rt[1])*(rt[0]<0?-1:1)),V=_s*R,0===V&&(V=v),$e.setColor(t.getMixedColor(f.gHS(f.BS.HUD.DRIFT_ARROW).colors.minSpeed,f.gHS(f.BS.HUD.DRIFT_ARROW).colors.maxSpeed,Math.min((P-cs)/(V-cs),1)))):$e.hide()):$e.hide(),N=js.getHullIntegrity(),O=js.getShieldIntegrity(),js!==Ot?(Ot=js,Rt=js.getTeam()?js.getTeam()._squads:[],ke=[],Lt=js._mClasses,bt=N,Dt=O,T=0,I=0,Vt=0,Ut=0):(N<bt?(Vt=Ki,T=1):Vt>0&&(Vt-=n,T=Vt/Ki),bt=N,O<Dt?(Ut=Zi,I=1):Ut>0&&(Ut-=n,I=Ut/Zi),Dt=O),li=f.gHS(f.BS.HUD.HULL_INTEGRITY_BAR).colors,nt(Ss.HULL_BAR)?(Vt>0?(ti.setColor(t.getMixedColor(li.filled,li.filledWhenDecreasing,T)),ti.setClipColor(t.getMixedColor(li.empty,li.emptyWhenDecreasing,T))):(ti.setColor(li.filled),ti.setClipColor(li.empty)),ti.clipY(0,N),ti.applyLayout(Hi,ks.width,ks.height),ti.show()):ti.hide(),js.hasShield()&&nt(Ss.SHIELD_BAR)?(li=f.gHS(f.BS.HUD.SHIELD_BAR).colors,Ut>0?(ei.setColor(t.getMixedColor(li.filled,li.filledWhenDecreasing,I)),ei.setClipColor(t.getMixedColor(li.empty,li.emptyWhenDecreasing,I))):(ei.setColor(li.filled),ei.setClipColor(li.empty)),ei.clipY(0,O),ei.applyLayout(Gi,ks.width,ks.height),ei.show()):ei.hide(),nt(Ss.FLIGHT_MODE)){switch(ii.applyLayout(ji,ks.width,ks.height),ii.show(),oi.setText(_.get(_.FLIGHT_MODE.PREFIX,js.getFlightMode(),js.getFlightMode())),li=f.gHS(f.BS.HUD.FLIGHT_MODE_TEXT).colors,js.getFlightMode()){case y.FlightMode.FREE:oi.setColor(li.free);break;case y.FlightMode.COMBAT:oi.setColor(li.combat);break;case y.FlightMode.CRUISE:oi.setColor(li.cruise);break;default:s.showError("Unknown flight mode: "+js.getFlightMode()+"!")}si.show()}else ii.hide(),si.hide();if(K=0,Lt.length>0){for(li=f.gHS(f.BS.HUD.MISSILE_INFO_TEXT).colors,a=js.getActiveMissileLauncher(),H=0,u=0;u<hi.length;u++)u<Lt.length?(Fs=Lt[u]._shortName,d=js.getMissileCount(Lt[u]),ui[u].setText(d.toString()),d<=0?Mt=li.empty:a&&a._class===Lt[u]?(js.getTarget()&&(K=js.getMissileLockRatio()),Ni=K>=1,Os=a.isReady(),Mt=Os?Ni?li.readySelected:li.lockingSelected:li.loadingSelected,a._salvo&&(Fs+=" (×"+Math.min(a.getSalvo(),a.getMissileCount())+")"),H=d,Ni?(ee?Os&&!Jt&&Qt.play():te.play(),ee=!0):(w=K*Zt,w<=0?$t=0:(w=Math.floor(w)+1,w>$t?($t++,Kt.play()):w<$t&&($t=0)),ee=!1),Jt=Os):Mt=li.notSelected,hi[u].setText(Fs),hi[u].setColor(Mt),ui[u].setColor(Mt),hi[u].show(),ui[u].show()):(hi[u].hide(),ui[u].hide());nt(Ss.MISSILE_INFO)?(ri.applyLayout(ki,ks.width,ks.height),ri.show(),ai.show()):(ri.hide(),ai.hide()),H>0&&nt(Ss.MISSILE_INDICATOR)?(ze.setTextureCoordinates(f.gHS(f.BS.HUD.MISSILE_INDICATOR).mappings[a._salvo?"salvo":"single"]),li=f.gHS(f.BS.HUD.MISSILE_INDICATOR).colors,w=a.getLoadRatio(),w<1?(ze.setColor(li.locking),ze.setClipColor(li.loading),ze.clipY(0,w)):(ze.setColor(li.ready),ze.setClipColor(li.locking),ze.clipY(0,K)),ze.applyLayout(Bi,ks.width,ks.height),ze.show(),Qe.setText(H.toString()),li=f.gHS(f.BS.HUD.MISSILE_INDICATOR_TEXT).colors,Qe.setColor(w>=1?Ni?li.ready:li.locking:li.loading),qe.show()):(ze.hide(),qe.hide())}else ri.hide(),ai.hide(),ze.hide(),qe.hide();if(!St&&S.isInPilotMode()){if(nt(Ss.OBJECTIVES)){for(Ei.applyLayout(Yi,ks.width,ks.height),Ei.show(),Ps=lt.getObjectivesState(),li=f.gHS(f.BS.HUD.OBJECTIVES_TEXT).colors,u=0;u<Ai.length;u++)if(u<Ps.length){switch(Ai[u].setText(Ps[u].text),Ps[u].state){case E.ObjectiveState.IN_PROGRESS:Ai[u].setColor(li.inProgress);break;case E.ObjectiveState.COMPLETED:Ai[u].setColor(li.completed);break;case E.ObjectiveState.FAILED:Ai[u].setColor(li.failed)}Ai[u].show()}else Ai[u].hide();yi.show()}else Ei.hide(),yi.hide();if(Bs=xt.filter(tt),Bs.length>0&&nt(Ss.ESCORTS)){for(Mi.applyLayout(zi,ks.width,ks.height),Mi.show(),u=0;u<Oi.length;u++)u<Bs.length?(Oi[u].setText(Bs[u].getDisplayName()||_.get(_.BATTLE.HUD_SPACECRAFT_NAME_UNKNOWN)),Ms=Bs[u]._away,li=f.gHS(f.BS.HUD.ESCORTS_TEXT).colors,Oi[u].setColor(Bs[u]._alive?Ms?li.away:li.alive:li.destroyed),Ri[u].hull.setColor(Ms?ds.colors.awayHull:it(Bs[u].getHullIntegrity(),ds.colors.fullHull,ds.colors.halfHull,ds.colors.zeroHull)),Ri[u].hull.clipX(0,Bs[u].getHullIntegrity()),Ri[u].hull.applyLayout(Ri[u].hullLayout,ks.width,ks.height),Oi[u].show(),Ri[u].hull.show(),Bs[u].hasShield()&&!Ms?(Ri[u].shield.clipX(0,Bs[u].getShieldIntegrity()),Ri[u].shield.applyLayout(Ri[u].shieldLayout,ks.width,ks.height),Ri[u].shield.show()):Ri[u].shield.hide()):(Oi[u].hide(),Ri[u].hull.hide(),Ri[u].shield.hide());Ci.show()}else for(Mi.hide(),Ci.hide(),u=0;u<Ri.length;u++)Ri[u].hull.hide(),Ri[u].shield.hide()}else for(Ei.hide(),yi.hide(),Mi.hide(),Ci.hide(),u=0;u<Ri.length;u++)Ri[u].hull.hide(),Ri[u].shield.hide();for(u=0;u<vs.length&&0===Xt[vs[u]].length;)u++;if(S.isInPilotMode()&&u<vs.length?(Gs=Xt[vs[u]],Gs[0].new&&(Gs[0].silent||Gs[0].appearTimeLeft||zt.play(),Gs[0].new=!1),fi.setText(Gs[0].text),Gs[0].appearTimeLeft>0?(fi.setRevealState(1-Gs[0].appearTimeLeft/Gs[0].appearDuration),Gs[0].appearTimeLeft-=n,Gs[0].silent||(qt.setVolume(f.gHS(f.BS.HUD.MESSAGE_TYPE_SOUND).volume),qt.play())):(fi.setRevealState(1),qt.stopLoop()),Mt=Gs[0].color?Gs[0].color:ms.colors.default,Gs[0].blinkInterval>0&&(Mt=Mt.slice(),Mt[3]=Mt[3]*Math.abs((Gs[0].duration-Gs[0].timeLeft)%Gs[0].blinkInterval/Gs[0].blinkInterval-.5)*2),fi.setColor(Mt),Yt=Gs[0].source,As=!1,Gs[0].permanent||(Gs[0]===se?(Gs[0].timeLeft=oe,oe<=0&&(As=!0)):Gs[0].timeLeft-=n,Gs[0].timeLeft<=0&&(Gs.shift(),Gs.length>0&&(Gs[0].new=!0))),As?(mi.hide(),gi.hide()):(gi.applyLayout(qi,ks.width,ks.height),gi.show(),mi.show())):(mi.hide(),gi.hide(),qt.stopPlaying(.01),Yt=null),oe>0&&(oe-=n),o=js.getTarget(),wt!==o?(wt=o,Ts=!0,Gt=Qi,M=1):Gt>0?(Gt-=n,M=Gt/Qi):M=0,A=jt>0?jt/Ji:0,Rs=!1,Ls=!1,xs=!1,bs=!1,o){if(gt=o.getPhysicalPositionVector(),pt=js.getPhysicalPositionVector(),mt=e.diff3(gt,pt),l=e.length3(mt),Z=js._ws,fs=o.isHostile(js),Z.length>0){for(ft=js.getTargetHitPosition(),!Li&&nt(Ss.AIM_ASSIST_INDICATOR)&&(Oe.setPosition(ft),Mt=fs?f.gHS(f.BS.HUD.AIM_ASSIST_INDICATOR).colors.hostile:f.gHS(f.BS.HUD.AIM_ASSIST_INDICATOR).colors.friendly,Gt>0||jt>0?(T=Math.max(M,A),Oe.setColor(t.getMixedColor(Mt,f.gHS(f.BS.HUD.AIM_ASSIST_INDICATOR).colors.appear,T)),Oe.setSize(e.scaled2(hs,1+(us-1)*T))):(Oe.setColor(Mt),Oe.setSize(hs)),Oe.show(),Rs=!0),m=e.length3(e.diff3(ft,pt)),ci=js.pMo.oM,g=js.vMo.sM[0],_i=js.getScaledOriMatrix(),Ni=!1,u=0;u<Z.length;u++)pe.length<=u&&(pe.push(z()),pe[u].addToScene(ht)),Z[u]._fixed?(Tt=Z[u].getOrigoPositionMatrix(),It=e.sumArray3([pt,e.scaled3(i.getRowB43(ci),m),e.scaled3(i.getRowA43(ci),Tt[12]*g),e.scaled3(i.getRowC43(ci),Tt[14]*g)])):(Et=Z[u].getBasePointPosVector(_i),It=e.sum3(Et,e.scaled3(i.getRowB43(Z[u].getProjectileOrientationMatrix()),e.length3(e.diff3(ft,Et))))),Li&&e.sub3(It,e.diff3Aux(ft,gt)),pe[u].setPosition(It),m<=Z[u].getRange(L)?(pe[u].setColor(f.gHS(f.BS.HUD.WEAPON_IMPACT_INDICATOR).colors.normal),Ni=!0):pe[u].setColor(f.gHS(f.BS.HUD.WEAPON_IMPACT_INDICATOR).colors.outOfRange),Gt>0?pe[u].setSize(e.scaled2(as,1+(ls-1)*M)):pe[u].setSize(as),pe[u].show();if(nt(Ss.WEAPON_IMPACT_INDICATORS)){for(;u<pe.length;)pe[u].hide(),u++;Ls=!0}!Ni||js.isFighter()&&e.dot3(i.getRowB43(ci),mt)<0?(Rs=!1,jt=Ji):jt-=n}N=o.getHullIntegrity(),O=o.getShieldIntegrity(),nt(Ss.TARGET_INFO)&&(De.applyLayout(Di,ks.width,ks.height),De.show(),be=it(N,f.gHS(f.BS.HUD.TARGET_VIEW_TARGET_ITEM_FULL_INTEGRITY_COLOR),f.gHS(f.BS.HUD.TARGET_VIEW_TARGET_ITEM_HALF_INTEGRITY_COLOR),f.gHS(f.BS.HUD.TARGET_VIEW_TARGET_ITEM_ZERO_INTEGRITY_COLOR)),Le!==o&&(Re.clearNodes(!0),xe=null,Le=o,Le.addToScene(Re,p.getMaxLoadedLOD(),!0,Ds,ve,st)),xe&&xe.setOrientationM4(f.gHS(f.BS.HUD.RELATIVE_TARGET_ORIENTATION)?i.prod4Aux(o.pMo.oM,i.inverseOfRotation4Aux(i.lookTowards4Aux(e.normalize3(e.diffTranslation3Aux(js.pMo.pM,o.pMo.pM)),i.getRowC43(js.pMo.oM)))):i.IDENTITY4),Re.setRelativeViewport(bi.getPositiveLeft(ks.width,ks.height),bi.getPositiveBottom(ks.width,ks.height),bi.getPositiveWidth(ks.width,ks.height),bi.getPositiveHeight(ks.width,ks.height)),we.clipX(0,N),we.applyLayout(Fi,ks.width,ks.height),we.show(),o.hasShield()?(Fe.clipX(0,O),Fe.applyLayout(Pi,ks.width,ks.height),Fe.show()):Fe.hide(),Ct=fs?f.gHS(f.BS.HUD.TARGET_INFO_TEXT).colors.hostile:f.gHS(f.BS.HUD.TARGET_INFO_TEXT).colors.friendly,Ve.name.setColor(Ct),Ve.name.setText(o.getDisplayName()||_.get(_.BATTLE.HUD_SPACECRAFT_NAME_UNKNOWN)),Ve.team.setColor(Ct),Ve.team.setText(o.getTeam()?o.getTeam().getDisplayName():_.get(_.BATTLE.HUD_TEAM_UNKNOWN)),Ve.class.setColor(Ct),Ve.class.setText(o.getClass().getDisplayName()),Ve.firepower.setColor(Ct),B=o.getTarget()&&o.getTarget().getClass()._armor,Ve.firepower.setText(_.get(_.BATTLE.HUD_FIREPOWER)+": "+(B?o.getFirepower(B).toFixed(1)+" / ":"")+o.getFirepower().toFixed(1)),Ve.distance.setColor(Ct),Ve.distance.setText(_.get(_.BATTLE.HUD_DISTANCE)+": "+t.getLengthString(l)),Ve.velocity.setColor(Ct),Ve.velocity.setText(_.get(_.BATTLE.HUD_VELOCITY)+": "+e.length3(i.translationVector3(o.getVelocityMatrix())).toFixed()+" m/s"),Pe.show(),xs=!0),Si&&(ge.clipX(.5-N/2,.5+N/2),ge.applyLayout(Wi,ks.width,ks.height),o.hasShield()?(me.clipX(.5-O/2,.5+O/2),me.applyLayout(Xi,ks.width,ks.height),me.show()):me.hide(),Ts?(Ft=N,Pt=O,Bt=0,Ht=0,T=0,I=0):(N<Ft?(Bt=$i,T=1):Bt>0&&(Bt-=n,T=Bt/$i),Ft=N,O<Pt?(Ht=ts,I=1):Ht>0&&(Ht-=n,I=Ht/ts),Pt=O),li=f.gHS(f.BS.HUD.TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR).colors,Nt=fs?li.hostileFilled:li.friendlyFilled,Wt=fs?li.hostileEmpty:li.friendlyEmpty,Bt>0?ge.setColor(t.getMixedColor(Nt,li.filledWhenDecreasing,T)):ge.setColor(Nt),ge.setClipColor(Wt),ge.show(),o.hasShield()?(li=f.gHS(f.BS.HUD.TARGET_SHIELD_QUICK_VIEW_BAR).colors,Ht>0?me.setColor(t.getMixedColor(li.filled,li.filledWhenDecreasing,I)):me.setColor(li.filled),me.setClipColor(li.empty),me.show()):me.hide(),bs=nt(Ss.TARGET_INDICATOR))}if(Rs||Oe.hide(),!Ls)for(u=0;u<pe.length;u++)pe[u].hide();if(xs||(De.hide(),Le&&(Re.clearNodes(!0),Le=null,xe=null),we.hide(),Fe.hide(),Pe.hide()),bs||(ge.hide(),me.hide(),Me.hide()),Rt.length>0&&nt(Ss.WINGMEN_INFO)){for(Ue.applyLayout(wi,ks.width,ks.height),Ue.show(),Be.show(),d=0,ys=!1,u=0;u<Rt.length;u++)for(We.length<=u&&(We.push(J(u)),Be.addText(We[u])),We[u].setText(_.get(_.SQUAD.PREFIX,Rt[u].name,Rt[u].name)),We[u].show(),H=Math.min(Rt[u].crafts.length,gs),c=0;c<H;c++)r=Rt[u].crafts[c],ke.length<=d&&(ke.push(q(u,H,c)),je.length>d&&je[d].body.setTextureCoordinates(ps.mappings[r.getTypeName()]||ps.mappings.general)),je.length<=d&&(je.push({body:Q(ke[d],r.getTypeName()),shield:Q(ke[d],"shield")}),je[d].body.addToScene(ht),je[d].shield.addToScene(ht)),je[d].body.applyLayout(ke[d],ks.width,ks.height),je[d].shield.applyLayout(ke[d],ks.width,ks.height),je[d].body.setColor(r._alive?r._away?ps.colors.away:it(r.getHullIntegrity(),ps.colors.fullIntegrity,ps.colors.halfIntegrity,ps.colors.zeroIntegrity):ps.colors.destroyed),je[d].body.show(),r._alive&&!r._away&&r.hasShield()?(je[d].shield.setColor(it(r.getShieldIntegrity(),ps.colors.fullShieldIntegrity,ps.colors.halfShieldIntegrity,ps.colors.zeroShieldIntegrity)),je[d].shield.show()):je[d].shield.hide(),r===js&&(Ge||(Ge=Q(ke[d],"player"),Ge.addToScene(ht)),Ge.applyLayout(ke[d],ks.width,ks.height),Ge.setColor(je[d].body._color),Ge.show(),ys=!0),d++;for(;u<We.length;)We[u].hide(),u++;for(u=d;u<je.length;u++)je[u].body.hide(),je[u].shield.hide();!ys&&Ge&&Ge.hide()}else{for(Ue.hide(),Be.hide(),u=0;u<je.length;u++)je[u].body.hide(),je[u].shield.hide();Ge&&Ge.hide()}for(Bs=lt.getSpacecrafts().filter($),Hs=js._tedBy.filter($),h=ht._camera.getAspect(),T=Math.abs(2*kt/es-1),li=f.gHS(f.BS.HUD.SHIP_INDICATOR).colors,ie=t.getMixedColor(li.hostile,li.hostileHighlight,T),ne=t.getMixedColor(li.friendly,li.friendlyHighlight,T),li=f.gHS(f.BS.HUD.SHIP_ARROW).colors,he=t.getMixedColor(li.hostile,li.hostileHighlight,T),ue=t.getMixedColor(li.friendly,li.friendlyHighlight,T),S.isInPilotMode()&&se&&oe>0?(Is=!0,T=2*Math.abs((se.duration-oe)%se.blinkInterval/se.blinkInterval-.5),He=t.getMixedColor(f.gHS(f.BS.HUD.SHIP_INDICATOR).colors.hostile,f.gHS(f.BS.HUD.SHIP_INDICATOR).colors.newHostile,T),ni=t.getMixedColor(f.gHS(f.BS.HUD.SHIP_ARROW).colors.hostile,f.gHS(f.BS.HUD.SHIP_ARROW).colors.newHostile,T)):Is=!1,j=0,u=0;u<Bs.length;u++){if(Rs=Bs[u]===o&&nt(Ss.TARGET_INDICATOR)||Bs[u]!==o&&nt(Ss.SHIP_INDICATORS),Cs=Bs[u]===Yt,Te.length<=u&&(Te.push(k()),Te[u].addToScene(ht)),gt=Bs[u].getPhysicalPositionVector(),Us=Te[u],Us.setPosition(gt),fs=Bs[u].isHostile(js),C=Bs[u].vMo.updateVisibleSize({camera:ht._camera},!0).width*ss,_t=Bs[u]===o?is.targetMinimum:is.minimum,ct=[Math.min(Math.max(_t[0],C),is.maximum[0]),Math.min(Math.max(_t[1],C),is.maximum[1])],li=f.gHS(f.BS.HUD.SHIP_INDICATOR).colors,Cs&&Us.setColor(li.transmission),Bs[u]===o?(Cs||Us.setColor(fs?Is&&re.indexOf(Bs[u])>=0?t.getMixedColor(li.hostileTarget,li.newHostile,T):li.hostileTarget:li.friendlyTarget),Gt>0?Us.setSize(e.scaled2(ct,1+(ns-1)*M)):Us.setSize(ct)):(Cs||Us.setColor(Is&&re.indexOf(Bs[u])>=0?He:Hs.indexOf(Bs[u])>=0?fs?ie:ne:fs?li.hostile:li.friendly),Us.setSize(ct)),Rs?Us.show():Us.hide(),Ee.length<=u&&(Ee.push(X()),Ee[u].addToScene(ht)),At=i.getRowD4(i.prod34Aux(Bs[u].pMo.pM,ht._camera.getViewMatrix(),ht._camera.getProjectionMatrix())),Ii=At[3]<0,e.normalize4D(At),Us=Ee[u],Ii||At[0]<-1||At[0]>1||At[1]<-1||At[1]>1)Rs?Us.show():Us.hide(),At[0]*=h,e.normalize2(At),Ii&&e.negate2(At),U=f.gHS(f.BS.HUD.SHIP_ARROW_POSITION_RADIUS)*(t.yScalesWithHeight(xi,ks.width,ks.height)?1/h:1),Us.setPosition(e.scaled2([At[0],At[1]*h],U)),Us.setAngle(Math.acos(At[1])*(At[0]<0?-1:1)),li=f.gHS(f.BS.HUD.SHIP_ARROW).colors,Cs&&Us.setColor(li.transmission),Bs[u]===o?(Cs||Us.setColor(fs?Is&&re.indexOf(Bs[u])>=0?t.getMixedColor(li.hostileTarget,li.newHostile,T):li.hostileTarget:li.friendlyTarget),Gt>0?Us.setSize(e.scaled2(os.target,1+(rs-1)*M)):Us.setSize(os.target),
Me.hide()):(Cs||Us.setColor(Is&&re.indexOf(Bs[u])>=0?ni:Hs.indexOf(Bs[u])>=0?fs?he:ue:fs?li.hostile:li.friendly),Us.setSize(os.default));else if(Us.hide(),Bs[u]===o&&Rs&&(Ce.setText(et(l)),Ce.setColor(fs?f.gHS(f.BS.HUD.DISTANCE_TEXT).colors.hostile:f.gHS(f.BS.HUD.DISTANCE_TEXT).colors.friendly),G=.5*ct[1]*(t.scalesWithWidth(Te[u]._scaleMode,h,1)?h:1),ot=[At[0],At[1]-G],Es=t.scalesWithWidth(Ce._boxLayout._scaleMode,h,1),dt=[vi.width/(Es?1:h),vi.height*(Es?h:1)],Ce._boxLayout.setPosition(ot[0]+.5*dt[0],ot[1]-.5*dt[1]),Ce.invalidateLayout(),Ce.setPosition([ot[0]+.05*dt[0],ot[1]-.95*dt[1]]),Me.show(),f.gHS(f.BS.HUD.ALWAYS_SHOW_TARGET_HULL_BAR_AT_CENTER)||(ot[1]=At[1]+G,ge.setPosition([(.5+.5*ot[0])*ks.width,(.5-.5*(ot[1]+1.5*Wi.getClipSpaceHeight()))*ks.height]),me.setPosition([(.5+.5*ot[0])*ks.width,(.5-.5*(ot[1]+1.75*Wi.getClipSpaceHeight()+Xi.getClipSpaceHeight()))*ks.height])),K>0)){for(U=.5*ct[1]*f.gHS(f.BS.HUD.MISSILE_LOCK_INDICATOR_RADIUS)*(t.yScalesWithHeight(Te[u]._scaleMode,ks.width,ks.height)?1/h:1),K<1?(Ie+=n*f.gHS(f.BS.HUD.MISSILE_LOCK_INDICATOR_ROTATION_SPEED),Ae=0):(Ie=Math.radians(f.gHS(f.BS.HUD.MISSILE_LOCK_INDICATOR_ANGLE)),Ae=(Ae+n/f.gHS(f.BS.HUD.MISSILE_LOCK_INDICATOR_BLINK_INTERVAL))%1),Y=Ie,li=f.gHS(f.BS.HUD.MISSILE_LOCK_INDICATOR).colors,Mt=fs?li.hostileTarget:li.friendlyTarget,dt=e.scaled2(ct,f.gHS(f.BS.HUD.MISSILE_LOCK_INDICATOR_SIZE)),c=0;c<ye.length;c++)Us=ye[c],K<1||Ae>.25&&Ae<.75?(Us.setPosition([At[0]+Math.cos(Y)*U,At[1]+Math.sin(Y)*h*U]),Us.setSize(dt),Us.setAngle(-.5*Math.PI-Y),Us.setColor(Mt),Us.show(),Y+=2*Math.PI/f.gHS(f.BS.HUD.MISSILE_LOCK_INDICATOR_COUNT)):Us.hide();Ns=!0}for(c=0;c<Bs.length&&(!Bs[c].isHostile(js)||vt.indexOf(Bs[c])>=0);)c++;if(Vs=[],Cs&&Vs.push("transmission"),xt.indexOf(Bs[u])>=0&&Vs.push("protect"),c<Bs.length&&vt.indexOf(Bs[u])>=0&&Vs.push("destroy"),Vs.length>0&&Rs)if(Ee[u].isVisible())Ne.length<=j&&(Ne.push(W(Vs[0])),Ne[j].addToScene(ht)),Us=Ne[j],j++,Us.setColor(f.gHS(f.BS.HUD.SHIP_STATUS_INDICATOR).colors[Vs[0]]||Ee[u]._color),Us.setScaleMode(Ee[u]._scaleMode),Us.setSize(f.gHS(f.BS.HUD.SHIP_STATUS_INDICATOR).sizes.arrow),Us.setPosition(e.scaled2([At[0],At[1]*h],(f.gHS(f.BS.HUD.SHIP_ARROW_POSITION_RADIUS)+1.5*Ee[u]._scale[0])*(t.yScalesWithHeight(xi,ks.width,ks.height)?1/h:1))),Us.setTextureCoordinates(f.gHS(f.BS.HUD.SHIP_STATUS_INDICATOR).mappings[Vs[0]]),Us.show();else for(Es=t.scalesWithWidth(Te[u]._scaleMode,h,1),G=.5*ct[1]*(Es?h:1),ot=[At[0],At[1]-G],dt=f.gHS(f.BS.HUD.SHIP_STATUS_INDICATOR).sizes.reticle,dt=[.5*dt[0]/(Es?1:h),.5*dt[1]*(Es?h:1)],c=0;c<Vs.length;c++)Ne.length<=j&&(Ne.push(W(Vs[c])),Ne[j].addToScene(ht)),Us=Ne[j],j++,Us.setColor(f.gHS(f.BS.HUD.SHIP_STATUS_INDICATOR).colors[Vs[c]]||Te[u]._color),Us.setScaleMode(Te[u]._scaleMode),Us.setSize(f.gHS(f.BS.HUD.SHIP_STATUS_INDICATOR).sizes.reticle),Us.setPosition([ot[0]-dt[0]*(1.2+2.1*(Vs.length-1-c)),ot[1]-1.2*dt[1]]),Us.setTextureCoordinates(f.gHS(f.BS.HUD.SHIP_STATUS_INDICATOR).mappings[Vs[c]]),Us.show()}for(;u<Te.length;)Te[u].hide(),Ee[u].hide(),u++;for(;j<Ne.length;)Ne[j].hide(),j++;ht.showUI()}else _e?di.show():di.hide(),pi.hide(),Ti.hide(),ht.hideUI(),Re.clearNodes(!0),Le=null,xe=null,Pe.hide(),Je.hide(),si.hide(),ai.hide(),qe.hide(),yi.hide(),Ci.hide(),mi.hide(),qt.stopPlaying(.01),Me.hide(),Be.hide();if(kt=(kt+n)%es,!Ns)for(Ie=Math.radians(f.gHS(f.BS.HUD.MISSILE_LOCK_INDICATOR_ANGLE)),Ae=0,u=0;u<ye.length;u++)ye[u].hide()},ot.prototype._render=function(e){var i,s,o,a;if(-2===ws&&A(),ht&&(ht._camera.update(ws!==As?e:0),this._updateHUD(e)),r.HTMLScreenWithCanvases.prototype._render.call(this,e),ht&&this._stats.isVisible()&&this._stats.setTextContent(this.getFPSStats()),ws!==As)if(St)lt&&Mt!==lt._state&&(Mt=lt._state)===E.MissionState.ENDED&&g.playMusic("ambient");else{if((s=lt._pilotedCraft)&&s._alive&&s._away)return void(Nt>f.getSetting(f.BS.QUIT_DELAY_AFTER_JUMP_OUT)?at():Nt+=e);lt&&Mt!==lt._state?(Mt=lt._state,Ct=0):Ct<f.getSetting(f.BS.GAME_STATE_DISPLAY_DELAY)&&(Ct+=e)>=f.getSetting(f.BS.GAME_STATE_DISPLAY_DELAY)&&(i=lt._state===E.MissionState.COMPLETED,o=Math.round(It/1e3),E.getMissionDescriptor(lt._name)._custom||(a={difficulty:ft,time:o},pt&&(pt.win?a.prevwin=!0:a.prevlose=!0,a.prevdifficulty=pt.difficulty,a.prevtime=pt.time),c.sendEvent(i?"win":"lose",[t.getFilenameWithoutExtension(mt)],a),pt={win:i,difficulty:ft,time:o}),s&&s._alive?this.queueHUDMessage({text:_.get(i?_.BATTLE.MESSAGE_VICTORY:_.BATTLE.MESSAGE_FAIL),queue:"mission",permanent:!0},!0):(this.pauseBattle(!1,!0),d.openDialog({header:_.get(_.BATTLE.MESSAGE_DEFEAT_HEADER),message:_.get(_.BATTLE.MESSAGE_DEFEAT_MESSAGE),buttons:[{caption:_.get(_.BATTLE.MESSAGE_DEFEAT_DEBRIEFING),action:at},{caption:_.get(_.BATTLE.MESSAGE_DEFEAT_RESTART),action:function(){n.closeSuperimposedScreen(),this.startNewBattle({restart:!0})}.bind(this)},{caption:_.get(_.BATTLE.MESSAGE_DEFEAT_SPECTATE),action:function(){n.closeSuperimposedScreen(),this.resumeBattle()}.bind(this)}],onClose:function(){this.resumeBattle()}.bind(this)})),g.playMusic(i?"victory":"defeat",i?"ambient":null,f.getSetting(f.BS.END_THEME_CROSSFADE_DURATION)))}},ot.prototype.startNewBattle=function(e){var i=performance.now(),n=this.getScreenCanvas("battleCanvas").getCanvasElement();e=e||{},e.restart&&this.pauseBattle(),void 0!==e.missionSourceFilename&&(mt=e.missionSourceFilename),void 0!==e.difficulty&&(ft=e.difficulty),void 0!==e.demoMode&&(St=e.demoMode),M(),C(),document.body.classList.add("wait"),this._loadingBox.show(),this.resizeCanvases(),S.setScreenCenter(n.width/2,n.height/2),this._updateLoadingStatus(_.get(_.BATTLE.LOADING_BOX_LOADING_MISSION),0),E.requestMission(mt,ft,St,function(e){var o,r,l,h,m,y,I,A,M;for(lt=e,vt=lt.getTargetSpacecrafts(),xt=lt.getEscortedSpacecrafts(),o=E.getMissionDescriptor(lt._name),r=o._custom,St||(lt._pilotedCraft&&lt._state!==E.MissionState.NONE||o.increasePlaythroughCount(!0),r?c.sendEvent("customstart"):(pt=null,c.sendEvent("start",[t.getFilenameWithoutExtension(mt)],{difficulty:ft}))),Mt=lt._state,Ct=f.getSetting(f.BS.GAME_STATE_DISPLAY_DELAY),Nt=0,this._updateLoadingStatus(_.get(_.BATTLE.LOADING_BOX_BUILDING_SCENE),10),p.shouldUseShadowMapping()&&p.getShadowMappingShader(),ht=new u.Scene(0,0,1,1,!0,[!0,!0,!0,!0],[0,0,0,1],!0,p.getLODContext(),p.getMaxDirLights(),p.getMaxPointLights(),p.getMaxSpotLights(),{useVerticalValues:f.getSetting(f.GENERAL_SETTINGS.USE_VERTICAL_CAMERA_VALUES),viewDistance:f.getSetting(f.BS.VIEW_DISTANCE),fov:40,span:.2,transitionDuration:f.getSetting(f.BS.CAMERA_DEFAULT_TRANSITION_DURATION),transitionStyle:f.getSetting(f.BS.CAMERA_DEFAULT_TRANSITION_STYLE)}),ht.setShouldUpdateCamera(!1),Re=new u.Scene(bi.getPositiveLeft(n.width,n.height),bi.getPositiveBottom(n.width,n.height),bi.getPositiveWidth(n.width,n.height),bi.getPositiveHeight(n.width,n.height),!1,[!0,!0,!0,!0],[0,0,0,0],!0,p.getLODContext(),0,0,0,{useVerticalValues:f.getSetting(f.GENERAL_SETTINGS.USE_VERTICAL_CAMERA_VALUES),viewDistance:f.gHS(f.BS.HUD.TARGET_VIEW_VIEW_DISTANCE),fov:f.gHS(f.BS.HUD.TARGET_VIEW_FOV),span:f.getSetting(f.CAMERA_SETTINGS.DEFAULT_SPAN),transitionDuration:f.getSetting(f.BS.CAMERA_DEFAULT_TRANSITION_DURATION),transitionStyle:f.getSetting(f.BS.CAMERA_DEFAULT_TRANSITION_STYLE)},!1),Re._camera.moveToPosition([0,0,f.gHS(f.BS.HUD.TARGET_VIEW_CAMERA_DISTANCE)],0),lt.addToScene(ht,Re),K(),fs=new Array(Object.keys(Ss).length),M=0;M<fs.length;M++)fs[M]=Ts.VISIBLE;ae=0,kt=0,this._addUITexts(),Xt=Xt||{},this.clearHUDMessageQueues(),g.initMusic(f.getSetting(f.BS.AMBIENT_MUSIC),"ambient",!0),l=f.getSetting(f.BS.ANTICIPATION_MUSIC),h=lt.getAnticipationTheme(),h?m=l.indexOf(l):(m=Math.min(Math.floor(Math.random()*l.length),l.length-1),h=l[m]),Et=m>=0?"anticipation"+m:h,y=f.getSetting(f.BS.COMBAT_MUSIC),I=lt.getCombatTheme(),I?A=y.indexOf(I):(A=Math.min(Math.floor(Math.random()*y.length),y.length-1),I=y[A]),yt=A>=0?"combat"+A:I,g.initMusic(h,Et,!0),g.initMusic(I,yt,!0),g.initMusic(f.getSetting(f.BS.VICTORY_MUSIC),"victory",!1),g.initMusic(f.getSetting(f.BS.DEFEAT_MUSIC),"defeat",!1),g.initMusic(f.getSetting(f.BS.DEBRIEFING_VICTORY_MUSIC),d.DEBRIEFING_VICTORY_THEME,!0),g.initMusic(f.getSetting(f.BS.DEBRIEFING_DEFEAT_MUSIC),d.DEBRIEFING_DEFEAT_THEME,!0),S.getController(S.GENERAL_CONTROLLER_NAME).setMission(lt),S.getController(S.GENERAL_CONTROLLER_NAME).setBattle(Fs),S.getController(S.CAMERA_CONTROLLER_NAME).setControlledCamera(ht._camera),this._updateLoadingStatus(_.get(_.LOADING.RESOURCES_START),20),a.executeOnResourceLoad(this._updateLoadingBoxForResourceLoad.bind(this)),a.executeWhenReady(function(){ht.setShadowMapping(lt.hasShadows()?p.getShadowMappingSettings():null),this._updateLoadingStatus(_.get(_.LOADING.INIT_WEBGL),80),t.executeAsync(function(){if(this.setAntialiasing(p.getAntialiasing()),this.setFiltering(p.getFiltering()),this.clearSceneCanvasBindings(),this.bindSceneToCanvas(ht,this.getScreenCanvas("battleCanvas")),this.bindSceneToCanvas(Re,this.getScreenCanvas("battleCanvas")),Re.clearNodes(!0),this._updateLoadingStatus(_.get(_.LOADING.READY),100),s.log("Game data loaded in "+((performance.now()-i)/1e3).toFixed(3)+" seconds!",1),_i.setText(_.get(_.BATTLE.DEVELOPMENT_VERSION_NOTICE),{version:s.getVersion()}),document.body.classList.remove("wait"),S.switchToSpectatorMode(!1,!0),this.setHeaderContent(r?o.getTitle()||t.getFilenameWithoutExtension(mt):_.get(_.MISSION.PREFIX,t.getFilenameWithoutExtension(mt)+_.MISSION.NAME_SUFFIX.name)),ut=document.body.style.cursor,this.showMessage(t.formatString(_.get(_.BATTLE.MESSAGE_READY),{menuKey:Z()})),lt.applyToSpacecrafts(function(t){t.addEventHandler(T.FIRED,D.bind(t)),t===lt._pilotedCraft?(t.addEventHandler(T.JUMP_ENGAGED,w.bind(t)),t.addEventHandler(T.JUMP_CANCELLED,F.bind(t)),t.addEventHandler(T.PREPARING_JUMP,V.bind(t)),t.addEventHandler(T.HUD,H.bind(t))):(t.addEventHandler(T.JUMP_OUT_STARTED,U.bind(t)),t.addEventHandler(T.ARRIVED,B.bind(t)))}),Qt=a.getSoundEffect(f.gHS(f.BS.HUD.MISSILE_LOADED_SOUND).name).createSoundClip(a.SoundCategory.SOUND_EFFECT,f.gHS(f.BS.HUD.MISSILE_LOADED_SOUND).volume),$t=0,Kt=a.getSoundEffect(f.gHS(f.BS.HUD.MISSILE_LOCKING_SOUND).name).createSoundClip(a.SoundCategory.SOUND_EFFECT,f.gHS(f.BS.HUD.MISSILE_LOCKING_SOUND).volume),te=a.getSoundEffect(f.gHS(f.BS.HUD.MISSILE_LOCKED_SOUND).name).createSoundClip(a.SoundCategory.SOUND_EFFECT,f.gHS(f.BS.HUD.MISSILE_LOCKED_SOUND).volume),zt=a.getSoundEffect(f.gHS(f.BS.HUD.MESSAGE_SOUND).name).createSoundClip(a.SoundCategory.SOUND_EFFECT,f.gHS(f.BS.HUD.MESSAGE_SOUND).volume),qt=a.getSoundEffect(f.gHS(f.BS.HUD.MESSAGE_TYPE_SOUND).name).createSoundClip(a.SoundCategory.SOUND_EFFECT,f.gHS(f.BS.HUD.MESSAGE_TYPE_SOUND).volume,!0),ne=a.getSoundEffect(f.gHS(f.BS.HUD.NEW_HOSTILES_ALERT_SOUND).name).createSoundClip(a.SoundCategory.SOUND_EFFECT,f.gHS(f.BS.HUD.NEW_HOSTILES_ALERT_SOUND).volume),this._loadingBox.hide(),x(),this.startRenderLoop(1e3/f.getSetting(f.BS.RENDER_FPS)),It=0,he=0,ee=!1,g.playMusic(lt.noHostilesPresent()?"ambient":Et),lt.prepareScene(ht)){for(ht.setShouldAnimate(!0),M=0;M<20;M++)this._render(100);ht.setShouldAnimate(!1)}}.bind(this))}.bind(this)),a.requestResourceLoad()}.bind(this))},f.executeWhenReady(function(){xi=f.gHS(f.BS.HUD.CENTER_CROSSHAIR).scaleMode,Ui=f.gHS(f.BS.HUD.SPEED_TARGET_INDICATOR).size,vi=f.gHS(f.BS.HUD.DISTANCE_TEXT).layout,bi=new r.ClipSpaceLayout(f.gHS(f.BS.HUD.TARGET_VIEW_LAYOUT)),Di=new r.ClipSpaceLayout(f.gHS(f.BS.HUD.TARGET_INFO_BACKGROUND).layout),wi=new r.ClipSpaceLayout(f.gHS(f.BS.HUD.WINGMEN_STATUS_BACKGROUND).layout),Fi=new r.ClipSpaceLayout(f.gHS(f.BS.HUD.TARGET_HULL_INTEGRITY_BAR).layout),Pi=new r.ClipSpaceLayout(f.gHS(f.BS.HUD.TARGET_SHIELD_BAR).layout),Vi=new r.ClipSpaceLayout(f.gHS(f.BS.HUD.SPEED_BAR).layout),Bi=new r.ClipSpaceLayout(f.gHS(f.BS.HUD.MISSILE_INDICATOR).layout),Hi=new r.ClipSpaceLayout(f.gHS(f.BS.HUD.HULL_INTEGRITY_BAR).layout),Gi=new r.ClipSpaceLayout(f.gHS(f.BS.HUD.SHIELD_BAR).layout),ji=new r.ClipSpaceLayout(f.gHS(f.BS.HUD.FLIGHT_MODE_INDICATOR_BACKGROUND).layout),ki=new r.ClipSpaceLayout(f.gHS(f.BS.HUD.MISSILE_INFO_BACKGROUND).layout),Yi=new r.ClipSpaceLayout(f.gHS(f.BS.HUD.OBJECTIVES_BACKGROUND).layout),zi=new r.ClipSpaceLayout(f.gHS(f.BS.HUD.ESCORTS_BACKGROUND).layout),qi=new r.ClipSpaceLayout(f.gHS(f.BS.HUD.MESSAGE_BACKGROUND).layout),Qi=f.gHS(f.BS.HUD.TARGET_SWITCH_ANIMATION_DURATION),Ji=f.gHS(f.BS.HUD.AIM_ASSIST_APPEAR_ANIMATION_DURATION),Ki=f.gHS(f.BS.HUD.HULL_INTEGRITY_DECREASE_ANIMATION_DURATION),Zi=f.gHS(f.BS.HUD.SHIELD_DECREASE_ANIMATION_DURATION),$i=f.gHS(f.BS.HUD.TARGET_HULL_INTEGRITY_DECREASE_ANIMATION_DURATION),ts=f.gHS(f.BS.HUD.TARGET_SHIELD_DECREASE_ANIMATION_DURATION),es=f.gHS(f.BS.HUD.SHIP_INDICATOR_HIGHLIGHT_ANIMATION_INTERVAL),is=f.gHS(f.BS.HUD.SHIP_INDICATOR).sizes,ss=f.gHS(f.BS.HUD.SHIP_INDICATOR_SIZE_FACTOR),ns=f.gHS(f.BS.HUD.TARGET_INDICATOR_SWITCH_SCALE),hs=f.gHS(f.BS.HUD.AIM_ASSIST_INDICATOR).size,us=f.gHS(f.BS.HUD.AIM_ASSIST_INDICATOR_APPEAR_SCALE),os=f.gHS(f.BS.HUD.SHIP_ARROW).sizes,rs=f.gHS(f.BS.HUD.TARGET_ARROW_SWITCH_SCALE),as=f.gHS(f.BS.HUD.WEAPON_IMPACT_INDICATOR).size,ls=f.gHS(f.BS.HUD.WEAPON_IMPACT_INDICATOR_SWITCH_SCALE),cs=f.gHS(f.BS.HUD.DRIFT_ARROW_MIN_SPEED),_s=f.gHS(f.BS.HUD.DRIFT_ARROW_MAX_SPEED_FACTOR),Wi=new r.ClipSpaceLayout(f.gHS(f.BS.HUD.TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR).layout),Xi=new r.ClipSpaceLayout(f.gHS(f.BS.HUD.TARGET_SHIELD_QUICK_VIEW_BAR).layout),ds=f.gHS(f.BS.HUD.ESCORTS_INTEGRITY_BARS),ps=f.gHS(f.BS.HUD.WINGMEN_STATUS_CRAFT_INDICATOR),gs=f.gHS(f.BS.HUD.WINGMEN_STATUS_CRAFT_POSITIONS).length,ms=f.gHS(f.BS.HUD.MESSAGE_TEXT),Zt=f.gHS(f.BS.HUD.MISSILE_LOCKING_SOUND_COUNT),ve={shaderName:f.gHS(f.BS.HUD.TARGET_VIEW_TARGET_ITEM_SHADER),positionMatrix:i.IDENTITY4,orientationMatrix:Vs,skipResources:!0},ce=f.gHS(f.BS.HUD.HIGHLIGHT_INTERVAL),ue=1e3*f.getSetting(f.BS.COMBAT_THEME_DURATION_AFTER_FIRE)}),p.executeWhenReady(function(){}),p.onSettingsChange(b),Fs.getBattleScreen=function(){return gt||(gt=new ot,Fs.pauseBattle=gt.pauseBattle.bind(gt),Fs.resumeBattle=gt.resumeBattle.bind(gt)),gt},Fs.stopTime=N,Fs.resumeTime=O,Fs.toggleTime=R,Fs.showHUD=x,Fs.hideHUD=L,Fs.toggleHUDVisibility=v,Fs.HUDSection=Ss,Fs.HUDSectionState=Ts,Fs}),define("armada/screens/menus",["utils/utils","modules/application","modules/screens","modules/game","modules/analytics","armada/constants","armada/screens/shared","armada/strings","armada/audio","armada/screens/battle"],function(t,e,i,s,n,o,r,a,l,h){"use strict";var u=o.LOCAL_STORAGE_PREFIX+"firstRunNoteShown",c=!1,_=[{id:a.MAIN_MENU.NEW_GAME.name,action:function(){n.sendEvent("newgame"),l.resume(),s.setScreen(r.MISSIONS_SCREEN_NAME)}},{id:a.MAIN_MENU.DATABASE.name,action:function(){n.sendEvent("database"),l.resume(),s.setScreen(r.DATABASE_SCREEN_NAME)}},{id:a.MAIN_MENU.SETTINGS.name,action:function(){n.sendEvent("settings"),l.resume(),s.setScreen(r.SETTINGS_SCREEN_NAME)}},{id:a.MAIN_MENU.ABOUT.name,action:function(){n.sendEvent("about"),l.resume(),s.setScreen(r.ABOUT_SCREEN_NAME)}}];return{getMainMenuScreen:function(){return e.usesElectron()&&_.push({id:a.MAIN_MENU.QUIT.name,action:function(){window.close()}}),new i.MenuScreen(r.MAIN_MENU_SCREEN_NAME,r.MAIN_MENU_SCREEN_SOURCE,{backgroundClassName:r.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:r.SCREEN_CONTAINER_CLASS_NAME},r.MENU_COMPONENT_SOURCE,r.MENU_STYLE,_,r.MAIN_MENU_CONTAINER_ID,{show:function(){var i,o,h;if(l.resetMasterVolume(),l.resetMusicVolume(),"true"!==localStorage[u])localStorage[u]="true",r.openDialog({header:a.get(a.FIRST_RUN_NOTE.HEADER),message:t.formatString(a.get(a.FIRST_RUN_NOTE.MESSAGE),{chrome:'<a target="_blank" rel="noopener" href="https://www.google.com/chrome/">Google Chrome</a>',facebook:'<a target="_blank" rel="noopener" href="https://www.facebook.com/interstellar.armada">facebook</a>'}),buttons:[{caption:a.get(a.FIRST_RUN_NOTE.BUTTON),action:function(){l.resume(),s.closeSuperimposedScreen(),l.playMusic(r.MENU_THEME),n.login()}}]});else if(e.hasVersionChanged()&&!c){if(c=!0,i=t.formatString(a.get(a.RELEASE_NOTES.GENERAL),{version:e.getVersion()})+"<br/><br/>",o=e.getNewReleases(),o.length>0)for(h=0;h<o.length;h++)i+="<h2>"+o[h]+"</h2>"+t.formatString(a.get(a.RELEASE_NOTES.PREFIX,o[h]));else i+=t.formatString(a.get(a.RELEASE_NOTES.NO_NEWS),{github:'<a target="_blank" rel="noopener" href="https://github.com/nkrisztian89/interstellar-armada/releases">Github</a>'});r.openDialog({header:a.get(a.RELEASE_NOTES.HEADER),message:i,messageClass:r.RELEASE_NOTES_CLASS_NAME,buttons:[{caption:a.get(a.RELEASE_NOTES.BUTTON),action:function(){l.resume(),s.closeSuperimposedScreen(),l.playMusic(r.MENU_THEME),n.login()}}]})}else l.playMusic(r.MENU_THEME),n.login();r.setupFullscreenButton.call(this)},optionselect:r.playButtonSelectSound,optionclick:r.playButtonClickSound})},getSettingsMenuScreen:function(){return new i.MenuScreen(r.SETTINGS_SCREEN_NAME,r.SETTINGS_SCREEN_SOURCE,{backgroundClassName:r.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:r.SCREEN_CONTAINER_CLASS_NAME},r.MENU_COMPONENT_SOURCE,r.MENU_STYLE,[{id:a.SETTINGS.GENERAL.name,action:function(){s.setScreen(r.GENERAL_SETTINGS_SCREEN_NAME)}},{id:a.SETTINGS.GRAPHICS.name,action:function(){s.setScreen(r.GRAPHICS_SCREEN_NAME)}},{id:a.SETTINGS.AUDIO.name,action:function(){s.setScreen(r.AUDIO_SCREEN_NAME)}},{id:a.SETTINGS.GAMEPLAY.name,action:function(){s.setScreen(r.GAMEPLAY_SETTINGS_SCREEN_NAME)}},{id:a.SETTINGS.CONTROLS.name,action:function(){s.setScreen(r.CONTROLS_SCREEN_NAME)}},{id:a.SCREEN.BACK.name,action:function(){s.setScreen(r.MAIN_MENU_SCREEN_NAME)}}],r.SETTINGS_MENU_CONTAINER_ID,r.MENU_EVENT_HANDLERS,{escape:function(){s.setScreen(r.MAIN_MENU_SCREEN_NAME)}})},getIngameMenuScreen:function(){return new i.MenuScreen(r.INGAME_MENU_SCREEN_NAME,r.INGAME_MENU_SCREEN_SOURCE,{cssFilename:r.INGAME_MENU_SCREEN_CSS,backgroundClassName:r.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:r.SCREEN_CONTAINER_CLASS_NAME},r.MENU_COMPONENT_SOURCE,r.MENU_STYLE,[{id:a.INGAME_MENU.RESUME.name,action:function(){s.closeSuperimposedScreen(),h.resumeBattle()}},{id:a.SETTINGS.CONTROLS.name,action:function(){s.setScreen(r.CONTROLS_SCREEN_NAME,!0,r.SUPERIMPOSE_BACKGROUND_COLOR)}},{id:a.SETTINGS.AUDIO.name,action:function(){s.setScreen(r.AUDIO_SCREEN_NAME,!0,r.SUPERIMPOSE_BACKGROUND_COLOR)}},{id:a.SETTINGS.GAMEPLAY.name,action:function(){s.setScreen(r.GAMEPLAY_SETTINGS_SCREEN_NAME,!0,r.SUPERIMPOSE_BACKGROUND_COLOR)}},{id:a.INGAME_MENU.RESTART.name,action:function(){r.openDialog({header:a.get(a.INGAME_MENU.RESTART_HEADER),message:a.get(a.INGAME_MENU.RESTART_MESSAGE),buttons:[{caption:a.get(a.SCREEN.CANCEL),action:function(){s.closeSuperimposedScreen()}},{caption:a.get(a.INGAME_MENU.RESTART_RESTART),action:function(){s.closeSuperimposedScreen(),s.closeSuperimposedScreen(),s.getScreen().startNewBattle({restart:!0})}}]})}},{id:a.INGAME_MENU.QUIT.name,action:function(){r.openDialog({header:a.get(a.INGAME_MENU.QUIT_HEADER),message:a.get(a.INGAME_MENU.QUIT_MESSAGE),buttons:[{caption:a.get(a.SCREEN.CANCEL),action:function(){s.closeSuperimposedScreen()}},{caption:a.get(a.INGAME_MENU.QUIT_TO_MISSIONS),action:function(){s.setScreen(r.MISSIONS_SCREEN_NAME)}},{caption:a.get(a.INGAME_MENU.QUIT_TO_MAIN_MENU),action:function(){s.setScreen(r.MAIN_MENU_SCREEN_NAME)}}]})}}],r.INGAME_MENU_CONTAINER_ID,r.MENU_EVENT_HANDLERS,{escape:function(){s.closeSuperimposedScreen(),h.resumeBattle()}})}}}),define("armada/screens/missions",["utils/utils","modules/game","modules/screens","modules/components","modules/analytics","armada/strings","armada/audio","armada/screens/shared","armada/logic/spacecraft","armada/logic/missions"],function(t,e,i,s,n,o,r,a,l,h){"use strict";function u(t){return o.get(o.SETTING.PREFIX,t)}function c(){return h.getDifficultyNames().map(u)}function _(){i.HTMLScreen.call(this,a.MISSIONS_SCREEN_NAME,a.MISSIONS_SCREEN_SOURCE,{cssFilename:a.MISSIONS_SCREEN_CSS,backgroundClassName:a.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:a.SCREEN_CONTAINER_CLASS_NAME},{show:function(){r.resetMasterVolume(),r.resetMusicVolume(),r.playMusic(a.MENU_THEME)}},this._getKeyCommands(),a.BUTTON_EVENT_HANDLERS),this._listContainerID=a.MISSIONS_LIST_CONTAINER_ID,this._backButton=this.registerSimpleComponent(g),this._missionTitle=this.registerSimpleComponent(S),this._missionLocation=this.registerSimpleComponent(T),this._difficultySelector=null,this._missionDescription=this.registerSimpleComponent(I),this._missionObjectivesTitle=this.registerSimpleComponent("missionObjectivesTitle"),this._missionObjectives=this.registerSimpleComponent("missionObjectives"),this._playerSpacecraftTitle=this.registerSimpleComponent("playerSpacecraftTitle"),this._playerSpacecraftData=this.registerSimpleComponent("playerSpacecraftData"),this._playerSpacecraftWeapons=this.registerSimpleComponent("playerSpacecraftWeapons"),this._playerSpacecraftMissiles=this.registerSimpleComponent("playerSpacecraftMissiles"),this._playerSpacecraftShield=this.registerSimpleComponent("playerSpacecraftShield"),this._playerSpacecraftPropulsion=this.registerSimpleComponent("playerSpacecraftPropulsion"),this._fileInput=this.registerSimpleComponent(M),this._fileButton=this.registerSimpleComponent(A),this._demoButton=this.registerSimpleComponent(m),this._launchButton=this.registerSimpleComponent(f),this._listComponent=this.registerExternalComponent(new s.ListComponent(C,a.LIST_COMPONENT_SOURCE,{cssFilename:a.LIST_COMPONENT_CSS,listClassName:a.LIST_CLASS_NAME,listContainerClassName:p,elementClassName:a.LIST_ELEMENT_CLASS_NAME,elementContainerClassName:a.LIST_ELEMENT_CONTAINER_CLASS_NAME,captionClassName:a.CAPTION_CLASS_NAME,subcaptionClassName:a.SUBCAPTION_CLASS_NAME,disabledElementClassName:s.DISABLED_CLASS_NAME,selectedElementClassName:s.SELECTED_CLASS_NAME,highlightedElementClassName:s.HIGHLIGHTED_CLASS_NAME},this._getListElements(),!0,{elementhighlight:function(){a.playButtonSelectSound(!0)},elementselect:function(t,e){a.playButtonClickSound(e),this._selectMission(t)}.bind(this)}),this._listContainerID),h.executeWhenReady(function(){this._difficultySelector=this.registerExternalComponent(new s.Selector(y,a.SELECTOR_SOURCE,{cssFilename:a.SELECTOR_CSS,selectorClassName:"smallSelector",propertyContainerClassName:"smallSelectorPropertyContainer"},{id:o.MISSIONS.DIFFICULTY.name},c()),E)}.bind(this))}var d,p="missionListContainer",g="backButton",m="demoButton",f="launchButton",S="missionTitle",T="missionLocation",E="difficultyContainer",y="difficultySelector",I="missionDescription",A="fileButton",M="fileInput",C="list";return _.prototype=new i.HTMLScreen,_.prototype.constructor=_,_.prototype._getListElements=function(){var e,i=[],s=h.getMissionNames();for(e=0;e<s.length;e++)i.push({captionID:o.MISSION.PREFIX.name+t.getFilenameWithoutExtension(s[e])+o.MISSION.NAME_SUFFIX.name,subcaptionID:o.MISSIONS.NOT_COMPLETED.name});return i.push({captionID:o.MISSIONS.CUSTOM_MISSION_CAPTION.name,subcaptionID:o.MISSIONS.CUSTOM_MISSION_SUBCAPTION.name}),i},_.prototype._selectMission=function(e){var i,s,n,r;e>=0&&e<h.getMissionNames().length?(i=h.getMissionNames()[e],s=t.getFilenameWithoutExtension(i),this._missionTitle.setContent(o.get({name:o.MISSION.PREFIX.name+s+o.MISSION.NAME_SUFFIX.name},void 0,s)),this._missionDescription.setContent(o.get(o.MISSIONS.LOADING_DESCRIPTION)),this._missionObjectivesTitle.hide(),this._missionObjectives.hide(),this._playerSpacecraftTitle.hide(),this._playerSpacecraftData.hide(),this._playerSpacecraftWeapons.hide(),this._playerSpacecraftMissiles.hide(),this._playerSpacecraftShield.hide(),this._playerSpacecraftPropulsion.hide(),this._fileButton.hide(),h.requestMissionDescriptor(i,function(i){var s;this._listComponent.getSelectedIndex()===e&&(i.getTitle()&&(this._missionTitle.setContent(i.getTitle()),this._listComponent.setCaption(e,i.getTitle())),d&&(d.destroy(),d=null),n=i.getPilotedSpacecraftDescriptor(),n&&(d=new l.Spacecraft,d.loadFromJSON(n)),s=i.getMissionObjectives().map(function(t){return"<li>"+t+"</li>"}),this._missionLocation.setContent(o.get(o.MISSIONS.LOCATION)+" "+i.getEnvironment().getDisplayName()),this._missionDescription.setContent(i._custom?(i.getAuthor()?t.formatString(o.get(o.MISSIONS.CREATED_BY),{author:i.getAuthor()})+"<br><br>":"")+(i.getDescription()||i.getDisplayDescription()):i.getDisplayDescription()),this._missionObjectives.setContent(s.join("")),d?(this._playerSpacecraftData.setContent(o.get(o.MISSIONS.SPACECRAFT_DATA),{class:d.getClass().getDisplayName()}),d.hasWeapons()?(this._playerSpacecraftWeapons.setContent(o.get(o.MISSIONS.SPACECRAFT_WEAPONS),{weapons:d.getWeaponsDisplayText()||"-",firepower:d.getFirepower().toFixed(1),range:d.hasWeapons()?d.getWeaponRangesDisplayText()+" m":"-"}),this._playerSpacecraftWeapons.show()):(this._playerSpacecraftWeapons.setContent(""),this._playerSpacecraftWeapons.hide()),d.hasMissiles()?(this._playerSpacecraftMissiles.setContent(o.get(o.MISSIONS.SPACECRAFT_MISSILES),{missiles:d.getMissilesDisplayText()||"-",firepower:d.getMissileFirepower(),range:d.getMissileRangesDisplayText()+" m"}),this._playerSpacecraftMissiles.show()):(this._playerSpacecraftMissiles.setContent(""),this._playerSpacecraftMissiles.hide()),d.hasShield()?(this._playerSpacecraftShield.setContent(o.get(o.MISSIONS.SPACECRAFT_SHIELD),{shield:d.hasShield()?d.getShieldDisplayName():"-",shieldCapacity:d.hasShield()?d.getShieldCapacity():"-",shieldRechargeRate:d.hasShield()?d.getShieldRechargeRate()+" / s":"-"}),this._playerSpacecraftShield.show()):(this._playerSpacecraftShield.setContent(""),this._playerSpacecraftShield.hide()),d._propulsion?(this._playerSpacecraftPropulsion.setContent(o.get(o.MISSIONS.SPACECRAFT_PROPULSION),{propulsion:d._propulsion?d.getPropulsionDisplayName():"-",speed:d._propulsion?Math.round(d.getMaxCombatSpeed())+" m/s":"-",turnRate:d._propulsion?Math.round(d.getMaxCombatTurnRate())+" °/s":"-"}),this._playerSpacecraftPropulsion.show()):(this._playerSpacecraftPropulsion.setContent(""),this._playerSpacecraftPropulsion.hide())):this._playerSpacecraftData.setContent("-"),this._missionObjectivesTitle.show(),this._missionObjectives.show(),this._playerSpacecraftTitle.show(),this._playerSpacecraftData.show())}.bind(this)),this._launchButton.enable(),this._demoButton.enable()):(r=e>=0,this._missionTitle.setContent(o.get(o.MISSIONS.NO_SELECTED_NAME)),this._missionLocation.setContent(""),this._missionDescription.setContent(o.get(r?o.MISSIONS.CUSTOM_DESCRIPTION:o.MISSIONS.NO_SELECTED_DESCRIPTION),{editor:'<a target="_blank" rel="noopener" href="editor.html">Interstellar Armada editor</a>'}),this._missionObjectivesTitle.hide(),this._missionObjectives.hide(),this._playerSpacecraftTitle.hide(),this._playerSpacecraftData.hide(),this._playerSpacecraftWeapons.hide(),this._playerSpacecraftMissiles.hide(),this._playerSpacecraftShield.hide(),this._playerSpacecraftPropulsion.hide(),this._launchButton.disable(),this._demoButton.disable(),this._fileButton.setVisible(r))},_.prototype._getKeyCommands=function(t){return t=t||{},t.up=t.up||function(t){this._listComponent.highlightPrevious(),t.preventDefault()}.bind(this),t.down=t.down||function(t){this._listComponent.highlightNext(),t.preventDefault()}.bind(this),t.enter=t.enter||function(){this._listComponent.getSelectedIndex()>=0&&this._listComponent.getHighlightedIndex()===this._listComponent.getSelectedIndex()?this._launchMission(!1):this._listComponent.selectHighlighted()}.bind(this),t.space=t.space||function(t){this._listComponent.selectHighlighted(),t.preventDefault()}.bind(this),t.escape=function(){e.closeOrNavigateTo(a.MAIN_MENU_SCREEN_NAME)},t},_.prototype._updateScores=function(){var e,i;e=h.getMissionDescriptors(),i=0,this._listComponent.executeForListElements(function(s){var n,r,l,h;i<e.length&&(h=s.querySelector("."+a.SUBCAPTION_CLASS_NAME),e[i]._custom?(h.innerHTML=o.get(o.MISSIONS.CUSTOM_MISSION_SUBCAPTION),l=0):(n=e[i].getBestScore(),r=e[i].getBestPerformance(),l=e[i].getWinCount(),h.innerHTML=t.formatString(l>0?void 0===n?o.get(o.MISSIONS.SANDBOX_COMPLETED):o.get(o.MISSIONS.BEST_SCORE):o.get(o.MISSIONS.NOT_COMPLETED),{score:n||0,medal:r?t.formatString("<img class='missionMedal' src='assets/images/empire_{performance}_20.png' alt='{performance}'>",{performance:r}):" - "})),l>0?h.classList.add("completed"):h.classList.remove("completed")),i++})},_.prototype.setActive=function(t){i.HTMLScreen.prototype.setActive.call(this,t),t&&(this._updateScores(),this._listComponent.reset(),this._selectMission(-1))},_.prototype._launchMission=function(t){var i=this._listComponent.getSelectedIndex();i>=0&&(r.playMusic(null),e.setScreen(a.BATTLE_SCREEN_NAME),e.getScreen().startNewBattle({missionSourceFilename:h.getMissionNames()[i],difficulty:h.getDifficultyNames()[this._difficultySelector.getSelectedIndex()],demoMode:t}))},_.prototype._updateValues=function(){h.executeWhenReady(function(){this._difficultySelector.selectValueWithIndex(h.getDifficultyNames().indexOf(h.getDifficulty()))}.bind(this))},_.prototype._initializeComponents=function(){i.HTMLScreen.prototype._initializeComponents.call(this),this._backButton._element.onclick=function(){return e.closeOrNavigateTo(a.MAIN_MENU_SCREEN_NAME),!1}.bind(this),this._difficultySelector.onChange=function(){h.setDifficulty(h.getDifficultyNames()[this._difficultySelector.getSelectedIndex()]),this._updateScores()}.bind(this),this._demoButton._element.onclick=function(){return this._launchMission(!0),!1}.bind(this),this._launchButton._element.onclick=function(){return this._launchMission(!1),!1}.bind(this),this._fileInput._element.onchange=function(){var i=this._fileInput._element.files[0];i&&i.text().then(function(s){var r=JSON.parse(s);r&&(r.name=i.name,r.custom=!0,h.getMissionNames().indexOf(r.name)>=0?e.showError("A mission with this filename already exists!",e.ErrorSeverity.MINOR):(h.createMissionDescriptor(r),this._listComponent.setCaption(h.getMissionNames().length-1,r.title||t.getFilenameWithoutExtension(r.name)),this.selectMission(r.name),this._listComponent.addListElement({captionID:o.MISSIONS.CUSTOM_MISSION_CAPTION.name,subcaptionID:o.MISSIONS.CUSTOM_MISSION_SUBCAPTION.name}),n.sendEvent("customload")))
}.bind(this)).catch(function(){e.showError("The selected file doesn't seem to be a valid mission file!",e.ErrorSeverity.MINOR)})}.bind(this),this._fileButton._element.onclick=function(){return this._fileInput._element.click(),!1}.bind(this),this._fileInput.hide()},_.prototype._updateComponents=function(){i.HTMLScreen.prototype._updateComponents.call(this),this._difficultySelector.setValueList(c()),this._updateValues(),this._updateScores()},_.prototype.show=function(){return!!i.HTMLScreen.prototype.show.call(this)&&(this._updateValues(),!0)},_.prototype.selectMission=function(t){var e=h.getMissionNames().indexOf(t);this._listComponent.selectIndex(e,!0),this._selectMission(e)},{getMissionsScreen:function(){return new _}}}),define("armada/screens/debriefing",["utils/utils","modules/game","modules/screens","armada/configuration","armada/strings","armada/audio","armada/screens/shared","armada/logic/missions"],function(t,e,i,s,n,o,r,a){"use strict";function l(){i.HTMLScreen.call(this,r.DEBRIEFING_SCREEN_NAME,r.DEBRIEFING_SCREEN_SOURCE,{cssFilename:r.DEBRIEFING_SCREEN_CSS,backgroundClassName:r.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:r.SCREEN_CONTAINER_CLASS_NAME},{show:function(){o.resetMasterVolume(),o.resetMusicVolume(),o.playMusic(h?r.DEBRIEFING_VICTORY_THEME:r.DEBRIEFING_DEFEAT_THEME,void 0,s.getSetting(s.BS.DEBRIEFING_THEME_FADE_IN_DURATION))}},{escape:function(){e.closeOrNavigateTo(r.MAIN_MENU_SCREEN_NAME)}},r.BUTTON_EVENT_HANDLERS),this._nextMissionName=null,this._backButton=this.registerSimpleComponent(u),this._title=this.registerSimpleComponent(c),this._medal=this.registerSimpleComponent(_),this._scoreContainer=this.registerSimpleComponent(d),this._scoreSpan=this.registerSimpleComponent(p),this._newRecord=this.registerSimpleComponent(g),this._descriptionParagraph=this.registerSimpleComponent(m),this._objectivesTable=this.registerSimpleComponent(f),this._scoreBreakdownContainer=this.registerSimpleComponent(S),this._timeCell=this.registerSimpleComponent(T),this._killsCell=this.registerSimpleComponent(E),this._damageCell=this.registerSimpleComponent(y),this._hitRatioCell=this.registerSimpleComponent(I),this._mDamageCell=this.registerSimpleComponent(A),this._mHitRatioCell=this.registerSimpleComponent(M),this._hullIntegrityCell=this.registerSimpleComponent(C),this._teamSurvivalCell=this.registerSimpleComponent(N),this._baseScoreCell=this.registerSimpleComponent(O),this._hitRatioBonusCell=this.registerSimpleComponent(R),this._hullIntegrityBonusCell=this.registerSimpleComponent(L),this._teamSurvivalBonusCell=this.registerSimpleComponent(x),this._restartButton=this.registerSimpleComponent(v),this._nextButton=this.registerSimpleComponent(b)}var h,u="backButton",c="title",_="medal",d="scoreContainer",p="score",g="newRecord",m="description",f="objectivesTable",S="scoreBreakdownContainer",T="timeCell",E="killsCell",y="damageCell",I="hitRatioCell",A="missileDamageCell",M="missileHitRatioCell",C="hullIntegrityCell",N="teamSurvivalCell",O="baseScoreCell",R="hitRatioBonusCell",L="hullIntegrityBonusCell",x="teamSurvivalBonusCell",v="restartButton",b="nextButton";return l.prototype=new i.HTMLScreen,l.prototype.constructor=l,l.prototype._initializeComponents=function(){i.HTMLScreen.prototype._initializeComponents.call(this),this._backButton._element.onclick=function(){return e.closeOrNavigateTo(r.MISSIONS_SCREEN_NAME),!1}.bind(this),this._restartButton._element.onclick=function(){return e.closeOrNavigateTo(r.BATTLE_SCREEN_NAME),e.getScreen().startNewBattle({restart:!0}),!1}.bind(this),this._nextButton._element.onclick=function(){return e.closeOrNavigateTo(r.MISSIONS_SCREEN_NAME),e.getScreen().selectMission(this._nextMissionName),!1}.bind(this)},l.prototype._updateComponents=function(){i.HTMLScreen.prototype._updateComponents.call(this)},l.prototype.setData=function(e){var i,s,o,r,l;switch(s=e.missionState===a.MissionState.COMPLETED,h=e.missionState===a.MissionState.COMPLETED||e.missionState===a.MissionState.NONE,i=s?n.get(n.PERFORMANCE_LEVEL.PREFIX,e.performance):"",this._title.setContent(e.missionState===a.MissionState.COMPLETED?n.get(n.DEBRIEFING.VICTORY_TITLE):e.missionState===a.MissionState.NONE?n.get(n.DEBRIEFING.GENERIC_TITLE):n.get(n.DEBRIEFING.DEFEAT_TITLE)),this._medal._element.src=t.formatString("assets/images/empire_{performance}_100.png",{performance:e.missionState!==a.MissionState.NONE?e.performance:"white"}),this._scoreContainer.setVisible(s),this._scoreSpan.setVisible(s),this._scoreSpan.isVisible()&&this._scoreSpan.setContent(n.get(n.DEBRIEFING.SCORE),{score:e.score}),this._newRecord.setVisible(s&&e.isRecord),e.missionState){case a.MissionState.COMPLETED:o=t.formatString(n.get(n.DEBRIEFING.DESCRIPTION_VICTORY),{performance:n.getDefiniteArticleForWord(i)+" <strong>"+i+"</strong>"})+(e.nextPerformanceScore?t.formatString(n.get(n.DEBRIEFING.DESCRIPTION_NEXT_PERFORMANCE),{score:e.nextPerformanceScore}):"");break;case a.MissionState.NONE:o=n.get(n.DEBRIEFING.DESCRIPTION_GENERIC);break;case a.MissionState.FAILED:o=n.get(n.DEBRIEFING.DESCRIPTION_FAIL);break;case a.MissionState.DEFEAT:o=n.get(n.DEBRIEFING.DESCRIPTION_DEFEAT);break;default:o=n.get(n.DEBRIEFING.DESCRIPTION_LEFT_EARLY)}for(this._descriptionParagraph.setContent(o),o="",r=0;r<e.objectives.length;r++)l=e.missionState===a.MissionState.COMPLETED||e.objectivesCompleted[r],o+='<tr><td class="'+(l?"completedObjective":"failedObjective")+'">'+(l?n.get(n.DEBRIEFING.COMPLETED):n.get(n.DEBRIEFING.FAILED))+':</td><td class="statLabelCell">'+e.objectives[r]+"</td></tr>";this._objectivesTable.setContent(o),this._timeCell.setContent(t.formatTimeToMinutes(e.elapsedTime)),this._killsCell.setContent(e.kills.toString()),this._damageCell.setContent(e.damageDealt.toString()),this._hitRatioCell.setContent(e.hitRatio>0?Math.round(100*e.hitRatio)+"%":"-"),this._mDamageCell.setContent(e.missileDamageDealt.toString()),this._mHitRatioCell.setContent(e.missilesHit.toString()+" / "+e.missilesLaunched.toString()),this._hullIntegrityCell.setContent(Math.round(100*e.hullIntegrity)+"%"),this._teamSurvivalCell.setContent(void 0!==e.teamSurvival?Math.round(100*e.teamSurvival)+"%":"-"),this._scoreBreakdownContainer.setVisible(s),this._scoreBreakdownContainer.isVisible()&&(this._baseScoreCell.setContent(e.baseScore.toString()),this._hitRatioBonusCell.setContent(e.hitRatioBonus.toString()),this._hullIntegrityBonusCell.setContent(e.hullIntegrityBonus.toString()),this._teamSurvivalBonusCell.setContent(e.teamSurvivalBonus?e.teamSurvivalBonus.toString():"-")),this._nextMissionName=e.nextMissionName,this._nextMissionName?this._nextButton.show():this._nextButton.hide()},{getDebriefingScreen:function(){return new l}}}),define("armada/screens/database",["utils/utils","utils/vectors","utils/matrices","modules/components","modules/screens","modules/game","modules/media-resources","modules/scene/lights","modules/scene/scene-graph","armada/screens/shared","armada/strings","armada/graphics","armada/logic/classes","armada/configuration","armada/logic/missions","armada/logic/spacecraft","utils/polyfill"],function(t,e,i,s,n,o,r,a,l,h,u,c,_,d,p,g){"use strict";function m(t){return d.getSetting(t)}function f(){return c.isRevealAvailable()?m(it.SHOW_WIREFRAME_MODEL):!m(it.SHOW_SOLID_MODEL)}function S(){return c.isRevealAvailable()&&m(it.MODEL_REVEAL_ANIMATION)}function T(){clearInterval(rt),rt=H}function E(){at=0}function y(){var t,e=performance.now(),i=f()?P:U,s=m(it.SHOW_SOLID_MODEL)?B:V;at=i,rt!==H&&clearInterval(rt),rt=setInterval(function(){t=performance.now()-e,t>U*m(it.REVEAL_DURATION)&&(t=Math.max(U*m(it.REVEAL_DURATION),t-m(it.REVEAL_SOLID_DELAY_DURATION))),at<s?at=Math.min(i+t/m(it.REVEAL_DURATION),s):(T(),st.setShouldAnimate(!0))},1e3/m(it.REVEAL_FPS))}function I(){clearInterval(lt),lt=H}function A(e){var s=i.prod3x3SubOf4Aux(i.rotationZ4Aux(e*t.RAD),i.rotationX4Aux(m(it.ROTATION_VIEW_ANGLE)*t.RAD));ht&&ht.setOrientationMatrix(i.matrix4(s)),ut&&ut.setOrientationMatrix(i.matrix4(s))}function M(t){var e,i=performance.now();A(t),lt!==H&&clearInterval(lt),lt=setInterval(function(){var t=nt.vMo;e=performance.now(),t&&(ht&&ht.rotate(t.getZDirectionVector(),(e-i)*Math.radians(360/m(it.ROTATION_DURATION))),ut&&ut.rotate(t.getZDirectionVector(),(e-i)*Math.radians(360/m(it.ROTATION_DURATION)))),i=e},1e3/m(it.ROTATION_FPS))}function C(t){t=Math.min(Math.max(_t*m(it.MIN_SIZE_FACTOR),t),_t*m(it.MAX_SIZE_FACTOR)),ut&&ut.setScalingMatrix(i.scaling4(t)),ht&&ht.setScalingMatrix(i.scaling4(t))}function N(t){var e=t.getMaxY(),i=t.getHeight();t.setUniformValueFunction($,function(){return m(it.WIREFRAME_COLOR)}),t.setUniformValueFunction(Q,function(){return at<=V}),t.setUniformValueFunction(J,function(){return e-(at>V?at-V:at)*i*(1+m(it.REVEAL_TRANSITION_LENGTH_FACTOR))}),t.setUniformValueFunction(K,function(){return at<=V?i*m(it.REVEAL_TRANSITION_LENGTH_FACTOR):0}),t.setUniformValueFunction(Z,function(){return m(it.REVEAL_COLOR)})}function O(t){var e=t.getMaxY(),i=t.getHeight();t.setUniformValueFunction(Q,function(){return!0}),t.setUniformValueFunction(J,function(){return e-(at-U)*i*(1+m(it.REVEAL_TRANSITION_LENGTH_FACTOR))}),t.setUniformValueFunction(K,function(){return at<B?i*m(it.REVEAL_TRANSITION_LENGTH_FACTOR):0}),t.setUniformValueFunction(Z,function(){return m(it.REVEAL_COLOR)})}function R(){var t=_.getSpacecraftClassesInArray(!0)[ot];nt=new g.Spacecraft(t,null,i.identity4(),i.identity4(),t._defaultLoadout),c.getShader(m(it.WIREFRAME_SHADER_NAME)),c.getShader(m(it.SOLID_SHADER_NAME)),m(it.SHOW_SOLID_MODEL)?nt.addToScene(st,c.getMaxLoadedLOD(),!1,{weapons:!0,missilesInLaunchers:!0,lightSources:!0,blinkers:!0},{shaderName:m(it.SOLID_SHADER_NAME)},function(t){ht=t,O(ht)},function(t){O(t)},function(t){O(t)}):ht=null,f()?nt.addToScene(st,c.getMaxLoadedLOD(),!0,{weapons:!0,missilesInLaunchers:!0},{shaderName:m(it.WIREFRAME_SHADER_NAME)},function(t){ut=t,N(ut)},function(t){N(t)},function(t){N(t)}):ut=null}function L(i){ht&&(ht.rotate(e.UNIT3_Y,-(i.screenX-ct[0])*m(it.ROTATION_MOUSE_SENSITIVITY)*t.RAD),ht.rotate(e.UNIT3_X,-(i.screenY-ct[1])*m(it.ROTATION_MOUSE_SENSITIVITY)*t.RAD)),ut&&(ut.rotate(e.UNIT3_Y,-(i.screenX-ct[0])*m(it.ROTATION_MOUSE_SENSITIVITY)*t.RAD),ut.rotate(e.UNIT3_X,-(i.screenY-ct[1])*m(it.ROTATION_MOUSE_SENSITIVITY)*t.RAD)),ct=[i.screenX,i.screenY]}function x(t){return document.body.onmousemove=null,document.body.onmouseup=null,nt&&m(it.MODEL_AUTO_ROTATION)&&M(m(it.ROTATION_START_ANGLE)),t.preventDefault(),!1}function v(t){return m(it.MODEL_MOUSE_ROTATION)&&(ct=[t.screenX,t.screenY],m(it.MODEL_AUTO_ROTATION)&&I(),document.body.onmousemove=L,document.body.onmouseup=x),t.preventDefault(),!1}function b(t){var e,i=0;return t.deltaY>0&&(i=et),t.deltaY<1&&(i=tt),i&&(e=nt.vMo.sM[0],C(e*i)),!1}function D(){return u.get(u.DATABASE.LENGTH)+": {length}<br/>"+u.get(u.SPACECRAFT_STATS.ARMOR)+": {armor} ("+u.get(u.SPACECRAFT_STATS.ARMOR_RATING)+")<br/>"+u.get(u.DATABASE.WEAPON_SLOTS)+": {weaponSlots}<br/>"+u.get(u.DATABASE.MISSILE_LAUNCHERS)+": {missileLaunchers}<br/>"+u.get(u.DATABASE.LOCK_RESIST)+": {lockResist}<br/>"}function w(){T(),I(),o.closeOrNavigateTo(h.MAIN_MENU_SCREEN_NAME)}function F(){n.HTMLScreenWithCanvases.call(this,h.DATABASE_SCREEN_NAME,h.DATABASE_SCREEN_SOURCE,{cssFilename:h.DATABASE_SCREEN_CSS,backgroundClassName:h.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:h.SCREEN_CONTAINER_CLASS_NAME},c.getAntialiasing(),!0,c.getFiltering(),m(d.GENERAL_SETTINGS.USE_REQUEST_ANIM_FRAME),void 0,{escape:w,left:this.selectPreviousShip.bind(this),right:this.selectNextShip.bind(this)},h.BUTTON_EVENT_HANDLERS),this._itemNameHeader=this.registerSimpleComponent(G),this._itemTypeHeader=this.registerSimpleComponent(j),this._itemStatsParagraph=this.registerSimpleComponent(k),this._itemDescriptionParagraph=this.registerSimpleComponent(W),this._backButton=this.registerSimpleComponent(X),this._prevButton=this.registerSimpleComponent(Y),this._nextButton=this.registerSimpleComponent(z),this._loadingBox=this.registerExternalComponent(new s.LoadingBox(q,h.LOADING_BOX_SOURCE,{cssFilename:h.LOADING_BOX_CSS},u.LOADING.HEADER.name))}var P=0,V=P+1,U=V,B=U+1,H=-1,G="itemName",j="itemType",k="itemStats",W="itemDescription",X="backButton",Y="prevButton",z="nextButton",q="loadingBox",Q="revealFront",J="revealStart",K="revealTransitionLength",Z="revealColor",$="color",tt=1.05,et=.95,it=d.DATABASE_SETTINGS,st=null,nt=null,ot=0,rt=-1,at=0,lt=-1,ht=null,ut=null,ct=null,_t=0,dt=0,pt=!0;return F.prototype=new n.HTMLScreenWithCanvases,F.prototype.constructor=F,F.prototype._initializeComponents=function(){n.HTMLScreenWithCanvases.prototype._initializeComponents.call(this),this._backButton._element.onclick=w,this._prevButton._element.onclick=function(){this.selectPreviousShip()}.bind(this),this._nextButton._element.onclick=function(){this.selectNextShip()}.bind(this)},F.prototype._updateItemInfo=function(){var e,i,s,n,o=_.getSpacecraftClassesInArray(!0)[ot];if(dt=nt&&nt.vMo?nt.vMo.getHeightInMeters():0,this._itemNameHeader.setContent(o.getDisplayName()),this._itemTypeHeader.setContent(o._scType.getDisplayName()),o._mLs.length>0)for(n="",i=o.getMissileLaunchersBySize(),s=Object.keys(i),e=0;e<s.length;e++)e>0&&(n+=", "),n+=i[s[e]].length+" "+u.get(u.MISSILE_SIZE.PREFIX,s[e],s[e]);this._itemStatsParagraph.setContent(D(),{length:dt&&t.getLengthString(dt)||"-",armor:o._hitpoints||"-",rating:o._armor||"0",weaponSlots:o._wSlots.length||"-",missileLaunchers:o._mLs.length>0?n:"-",lockResist:o.getLockingTimeFactor()||"-"}),this._itemDescriptionParagraph.setContent(o.getDisplayDescription()+"<br/><br/>"+o._scType.getDisplayDescription())},F.prototype._updateComponents=function(){n.HTMLScreenWithCanvases.prototype._updateComponents.call(this),this._updateItemInfo()},F.prototype._updateLoadingStatus=function(t,e){void 0!==t&&this._loadingBox.updateStatus(h.getSubParagraph(t)),void 0!==e&&this._loadingBox.updateProgress(e)},F.prototype._updateLoadingBoxForResourceLoad=function(e,i,s,n){this._updateLoadingStatus(t.formatString(u.get(u.LOADING.RESOURCE_READY),{resource:e,resourceType:i,loaded:n,total:s}),15+n/s*60)},F.prototype._initializeCanvas=function(){var t,e,i,s;if(pt=!0,document.body.classList.add("wait"),m(it.SHOW_LOADING_BOX_FIRST_TIME)&&this._loadingBox.show(),this._updateLoadingStatus(u.get(u.DATABASE.LOADING_BOX_INITIALIZING),0),this.getScreenCanvas("databaseCanvas").handleResize(),c.shouldUseShadowMapping()&&c.getShadowMappingShader(),t=this.getScreenCanvas("databaseCanvas").getCanvasElement(),st=new l.Scene(0,0,1,1,!0,[!0,!0,!0,!0],m(it.BACKGROUND_COLOR),!0,c.getLODContext(),c.getMaxDirLights(),c.getMaxPointLights(),c.getMaxSpotLights(),{useVerticalValues:m(d.GENERAL_SETTINGS.USE_VERTICAL_CAMERA_VALUES),viewDistance:m(it.ITEM_VIEW_DISTANCE),fov:m(it.ITEM_VIEW_FOV),span:m(it.ITEM_VIEW_SPAN)}),i=m(it.LIGHT_SOURCES))for(e=0;e<i.length;e++)st.addDirectionalLightSource(new a.DirectionalLightSource(i[e].color,i[e].direction));m(it.SHOW_LOADING_BOX_FIRST_TIME)&&r.executeOnResourceLoad(this._updateLoadingBoxForResourceLoad.bind(this)),r.executeWhenReady(function(){s=c.getShadowMappingSettings(),s&&(s.ranges=[],s.deferSetup=!0),st.setShadowMapping(s)}.bind(this)),m(it.SHOW_LOADING_BOX_FIRST_TIME)&&this._updateLoadingStatus(u.get(u.LOADING.RESOURCES_START),15),ot=0,this.loadShip(),t.onmousedown=v,t.onwheel=b},F.prototype.show=function(){return!!n.HTMLScreenWithCanvases.prototype.show.call(this)&&(this.executeWhenReady(function(){this._initializeCanvas()}),!0)},F.prototype.hide=function(){return!!n.HTMLScreenWithCanvases.prototype.hide.call(this)&&(this.executeWhenReady(function(){st.clearNodes(!0),st.clearPointLights(),st.clearSpotLights(),this.render()}),rt!==H&&(clearInterval(rt),rt=H),lt!==H&&(clearInterval(lt),lt=H),!0)},F.prototype.selectPreviousShip=function(){ot-=1,-1===ot&&(ot=_.getSpacecraftClassesInArray(!0).length-1),this.loadShip()},F.prototype.selectNextShip=function(){ot=(ot+1)%_.getSpacecraftClassesInArray(!0).length,this.loadShip()},F.prototype.loadShip=function(e){e&&(ot=_.getSpacecraftClassesInArray(!0).indexOf(_.getSpacecraftClass(e))),document.body.classList.add("wait"),T(),I(),this.stopRenderLoop(),st.clearNodes(!0),st.clearPointLights(),st.clearSpotLights(),st.setShouldAnimate(!1),nt&&nt.destroy(),nt=null,this.render(),p.executeWhenReady(function(){this._updateItemInfo(),R(),r.executeOnResourceLoad(this._updateLoadingBoxForResourceLoad.bind(this)),r.executeWhenReady(function(){var e=nt.vMo;if(!e)return void o.log("WARNING! No visual item to load for database, loading aborted!");this._updateItemInfo(),this.bindSceneToCanvas(st,this.getScreenCanvas("databaseCanvas")),st._camera.moveToPosition([0,0,e.getScaledSize()],0),c.shouldUseShadowMapping()?(st.setShadowMapRanges([.5*e.getScaledSize(),e.getScaledSize()]),st.enableShadowMapping()):st.disableShadowMapping(),_t=e.sM[0],C(_t*m(it.START_SIZE_FACTOR)),this._updateLoadingStatus(u.get(u.LOADING.INIT_WEBGL),75),this._sceneCanvasBindings[0].canvas.getManagedContext().setup(),S()&&E(),this.render(),t.executeAsync(function(){(m(it.MODEL_AUTO_ROTATION)||m(it.MODEL_MOUSE_ROTATION)||S())&&this.startRenderLoop(1e3/m(it.RENDER_FPS)),m(it.MODEL_AUTO_ROTATION)?M(m(S()?it.ROTATION_REVEAL_START_ANGLE:it.ROTATION_START_ANGLE)):A(m(it.ROTATION_START_ANGLE)),S()?y():(at=B,st.setShouldAnimate(!0)),document.body.classList.remove("wait"),(pt&&m(it.SHOW_LOADING_BOX_FIRST_TIME)||!pt&&m(it.SHOW_LOADING_BOX_ON_ITEM_CHANGE))&&(this._updateLoadingStatus(u.get(u.LOADING.READY),100),this._loadingBox.hide()),pt=!1}.bind(this))}.bind(this),function(){!pt&&m(it.SHOW_LOADING_BOX_ON_ITEM_CHANGE)&&this._loadingBox.show()}.bind(this),!0),this._updateLoadingStatus(u.get(u.LOADING.RESOURCES_START),15),r.requestResourceLoad()}.bind(this),function(){!pt&&m(it.SHOW_LOADING_BOX_ON_ITEM_CHANGE)&&this._loadingBox.show()}.bind(this),!0)},{getDatabaseScreen:function(){return new F}}}),define("armada/screens/general-settings",["modules/components","modules/screens","modules/game","modules/analytics","armada/constants","armada/strings","armada/screens/shared","utils/polyfill"],function(t,e,i,s,n,o,r){"use strict";function a(){e.HTMLScreen.call(this,r.GENERAL_SETTINGS_SCREEN_NAME,r.GENERAL_SETTINGS_SCREEN_SOURCE,{cssFilename:r.GENERAL_SETTINGS_SCREEN_CSS,backgroundClassName:r.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:r.SCREEN_CONTAINER_CLASS_NAME},void 0,{escape:this._applyAndClose.bind(this)},r.BUTTON_EVENT_HANDLERS),this._backButton=this.registerSimpleComponent(u),this._defaultsButton=this.registerSimpleComponent(c),this._languageSelector=this._registerSelector(_,o.GENERAL_SETTINGS.LANGUAGE.name,l),this._analyticsSelector=this._registerSelector(d,o.GENERAL_SETTINGS.ANALYTICS.name,h()),this._analyticsNote=this.registerSimpleComponent(p)}var l,h=function(){return[o.get(o.SETTING.OFF),o.get(o.SETTING.ON)]},u="backButton",c="defaultsButton",_="languageSelector",d="analyticsSelector",p="analyticsNote",g=h().indexOf(o.get(o.SETTING.ON)),m=h().indexOf(o.get(o.SETTING.OFF));return a.prototype=new e.HTMLScreen,a.prototype.constructor=a,a.prototype._applyAndClose=function(){s.setEnabled(this._analyticsSelector.getSelectedIndex()===g),document.body.style.cursor="wait",i.requestLanguageChange(this._languageSelector.getSelectedValue(),o,function(){document.body.style.cursor=i.getDefaultCursor(),localStorage.setItem(n.LANGUAGE_LOCAL_STORAGE_ID,i.getLanguage()),i.closeOrNavigateTo(r.SETTINGS_SCREEN_NAME)})},a.prototype._registerSelector=function(e,i,s){return this.registerExternalComponent(new t.Selector(e,r.SELECTOR_SOURCE,{cssFilename:r.SELECTOR_CSS},{id:i},s),"settingsDiv")},a.prototype._initializeComponents=function(){e.HTMLScreen.prototype._initializeComponents.call(this),this._backButton._element.onclick=function(){return this._applyAndClose(),!1}.bind(this),this._defaultsButton._element.onclick=function(){return s.enable(),localStorage.removeItem(n.LANGUAGE_LOCAL_STORAGE_ID),document.body.style.cursor="wait",i.requestLanguageChange(i.getDefaultLanguage(),o,function(){document.body.style.cursor=i.getDefaultCursor()}),this._updateValues(),!1}.bind(this)},a.prototype._updateComponents=function(){e.HTMLScreen.prototype._updateComponents.call(this),this._defaultsButton.setContent(o.get(o.SETTINGS.DEFAULTS)),this._analyticsSelector.setValueList(h()),this._updateValues()},a.prototype._updateValues=function(){this._languageSelector.selectValue(i.getLanguage()),this._analyticsSelector.selectValueWithIndex(!0===s.isEnabled()?g:m)},a.prototype.show=function(){return!!e.HTMLScreen.prototype.show.call(this)&&(this._updateValues(),!0)},{getGeneralSettingsScreen:function(){return l=i.getLanguages(),new a}}}),define("armada/screens/graphics-settings",["utils/utils","modules/application","modules/components","modules/screens","modules/managed-gl","modules/game","armada/strings","armada/screens/shared","armada/graphics","utils/polyfill"],function(t,e,i,s,n,o,r,a,l){"use strict";function h(){s.HTMLScreen.call(this,a.GRAPHICS_SCREEN_NAME,a.GRAPHICS_SCREEN_SOURCE,{cssFilename:a.GRAPHICS_SCREEN_CSS,backgroundClassName:a.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:a.SCREEN_CONTAINER_CLASS_NAME},void 0,{escape:this._applyAndClose.bind(this)},a.BUTTON_EVENT_HANDLERS),this._backButton=this.registerSimpleComponent(R),this._titleHeading=this.registerSimpleComponent(L),this._defaultsButton=this.registerSimpleComponent(x),this._generalLevelSelector=null,this._antialiasingSelector=null,this._filteringSelector=null,this._textureQualitySelector=null,this._cubemapQualitySelector=null,this._lodSelector=null,this._msInLaunchersSelector=null,this._shaderComplexitySelector=null,this._shadowMappingSelector=null,this._shadowQualitySelector=null,this._shadowDistanceSelector=null,this._maxDynamicLightsSelector=null,this._particleAmountSelector=null,this._dustParticleAmountSelector=null,l.executeWhenReady(function(){this._generalLevelSelector=this._registerSelector(v,r.GRAPHICS.GENERAL_LEVEL.name,m().map(d),z,b,D),this._antialiasingSelector=this._registerSelector(w,r.GRAPHICS.ANTIALIASING.name,p(),q),this._filteringSelector=this._registerSelector(F,r.GRAPHICS.FILTERING.name,f().map(d),q),this._textureQualitySelector=this._registerSelector(P,r.GRAPHICS.TEXTURE_QUALITY.name,S().map(d),q),this._cubemapQualitySelector=this._registerSelector(V,r.GRAPHICS.BACKGROUND_QUALITY.name,T().map(d),q),this._lodSelector=this._registerSelector(U,r.GRAPHICS.MODEL_DETAILS.name,E().map(d),q),this._msInLaunchersSelector=this._registerSelector(B,r.GRAPHICS.MISSILES_IN_LAUNCHERS.name,p(),q),this._shaderComplexitySelector=this._registerSelector(H,r.GRAPHICS.SHADERS.name,y().map(d),Q),this._shadowMappingSelector=this._registerSelector(G,r.GRAPHICS.SHADOWS.name,p(),Q),this._shadowQualitySelector=this._registerSelector(j,r.GRAPHICS.SHADOW_QUALITY.name,I().map(d),Q),this._shadowDistanceSelector=this._registerSelector(k,r.GRAPHICS.SHADOW_DISTANCE.name,A().map(d),Q),this._maxDynamicLightsSelector=this._registerSelector(W,r.GRAPHICS.MAX_DYNAMIC_LIGHTS.name,M().map(d),Q),this._particleAmountSelector=this._registerSelector(X,r.GRAPHICS.PARTICLE_AMOUNT.name,C().map(d),q),this._dustParticleAmountSelector=this._registerSelector(Y,r.GRAPHICS.DUST_PARTICLE_AMOUNT.name,N().map(d),Q)}.bind(this))}var u=["custom"],c=function(t){return function(i){var s,n=t.PREFIX;return n?(s=r.get(n,i),[s,i]):(e.showError("Cannot find caption string specified for setting '"+i+"', because no prefix is available for the corresponding string category!"),[i,i])}},_=function(t){return n.isAnisotropicFilteringAvailable()||t!==n.TextureFiltering.ANISOTROPIC},d=function(t){return t[0]},p=function(){return[r.get(r.SETTING.OFF),r.get(r.SETTING.ON)]},g=function(){return[r.get(r.SETTING.OFF)]},m=function(){return l.getGeneralLevelNames().concat(u).map(c(r.SETTING))},f=function(){return t.getEnumValues(n.TextureFiltering).filter(_).map(c(r.GRAPHICS))},S=function(){return l.getTextureQualities().map(c(r.SETTING))},T=function(){return l.getCubemapQualities().map(c(r.SETTING))},E=function(){return l.getLODLevels().map(c(r.SETTING))},y=function(){return l.getShaderComplexities().map(c(r.SETTING))},I=function(){return l.getShadowMapQualities().map(c(r.SETTING))},A=function(){return l.getShadowDistances().map(c(r.SETTING))},M=function(){return l.getPointLightAmounts().map(c(r.SETTING))},C=function(){return l.getParticleAmounts().map(c(r.SETTING))},N=function(){return l.getDustParticleAmounts().map(c(r.SETTING))},O=function(t,e){return e.findIndex(function(e){return e[1]===t})},R="backButton",L="title",x="defaultsButton",v="generalLevelSelector",b="separateSelector",D="smallSelectorPropertyContainer",w="aaSelector",F="filteringSelector",P="textureQualitySelector",V="cubemapQualitySelector",U="lodSelector",B="missilesInLaunchersSelector",H="shaderComplexitySelector",G="shadowMappingSelector",j="shadowQualitySelector",k="shadowDistanceSelector",W="maxDynamicLightSelector",X="particleAmountSelector",Y="dustParticleAmountSelector",z="generalLevelDiv",q="settingsDivLeft",Q="settingsDivRight",J=p().indexOf(r.get(r.SETTING.ON)),K=p().indexOf(r.get(r.SETTING.OFF));return h.prototype=new s.HTMLScreen,h.prototype.constructor=h,h.prototype._registerSelector=function(t,e,s,n,o,r){return this.registerExternalComponent(new i.Selector(t,a.SELECTOR_SOURCE,{cssFilename:a.SELECTOR_CSS,selectorClassName:o,propertyContainerClassName:r},{id:e},s),n)},h.prototype._applyAndClose=function(){l.setAntialiasing(this._antialiasingSelector.getSelectedIndex()===J),l.setFiltering(f()[this._filteringSelector.getSelectedIndex()][1]),l.setTextureQuality(S()[this._textureQualitySelector.getSelectedIndex()][1]),l.setCubemapQuality(T()[this._cubemapQualitySelector.getSelectedIndex()][1]),l.setLODLevel(E()[this._lodSelector.getSelectedIndex()][1]),l.setMissilesInLaunchersVisible(this._msInLaunchersSelector.getSelectedIndex()===J),l.setParticleAmount(C()[this._particleAmountSelector.getSelectedIndex()][1]),l.setDustParticleAmount(N()[this._dustParticleAmountSelector.getSelectedIndex()][1]),l.handleSettingsChanged(),o.closeOrNavigateTo(a.SETTINGS_SCREEN_NAME)},h.prototype._initializeComponents=function(){var t;s.HTMLScreen.prototype._initializeComponents.call(this),t=function(t){0!==t&&this._generalLevelSelector.selectValueWithIndex(m().length-1,0)}.bind(this),this._backButton._element.onclick=function(){return this._applyAndClose(),!1}.bind(this),this._defaultsButton._element.onclick=function(){return l.restoreDefaults(),t(),this._updateValues(),!1}.bind(this),this._generalLevelSelector.onChange=function(t){if(0!==t&&this._generalLevelSelector.getSelectedIndex()===m().length-1)return void(t>0?this._generalLevelSelector.selectNextValue():this._generalLevelSelector.selectPreviousValue());this._generalLevelSelector.getSelectedIndex()!==m().length-1?(l.setGeneralLevel(l.getGeneralLevelNames()[this._generalLevelSelector.getSelectedIndex()]),this._updateComponents()):l.setGeneralLevel(null)}.bind(this),this._antialiasingSelector.onChange=t,this._filteringSelector.onChange=t,this._textureQualitySelector.onChange=t,this._cubemapQualitySelector.onChange=t,this._lodSelector.onChange=t,this._msInLaunchersSelector.onChange=t,this._particleAmountSelector.onChange=t,this._dustParticleAmountSelector.onChange=t,this._shaderComplexitySelector.onChange=function(e){l.setShaderComplexity(y()[this._shaderComplexitySelector.getSelectedIndex()][1]),this._updateShadowMappingSelector(),this._updateShadowQualitySelector(),this._updateShadowDistanceSelector(),this._updateMaxDynamicLightsSelector(),t(e)}.bind(this),this._shadowMappingSelector.onChange=function(e){l.setShadowMapping(this._shadowMappingSelector.getSelectedIndex()===J),this._updateShadowQualitySelector(),this._updateShadowDistanceSelector(),this._updateMaxDynamicLightsSelector(),t(e)}.bind(this),this._shadowQualitySelector.onChange=function(e){l.setShadowMapQuality(I()[this._shadowQualitySelector.getSelectedIndex()][1]),t(e)}.bind(this),this._shadowDistanceSelector.onChange=function(e){l.setShadowDistance(A()[this._shadowDistanceSelector.getSelectedIndex()][1]),this._updateMaxDynamicLightsSelector(),t(e)}.bind(this),this._maxDynamicLightsSelector.onChange=function(e){l.setPointLightAmount(M()[this._maxDynamicLightsSelector.getSelectedIndex()][1]),this._updateShadowMappingSelector(),this._updateShadowDistanceSelector(),t(e)}.bind(this)},h.prototype._updateComponents=function(){s.HTMLScreen.prototype._updateComponents.call(this),this._defaultsButton.setContent(r.get(r.SETTINGS.DEFAULTS)),this._generalLevelSelector.setValueList(m().map(d)),this._antialiasingSelector.setValueList(n.isAntialiasingAvailable()?p():g()),this._filteringSelector.setValueList(f().map(d)),this._textureQualitySelector.setValueList(S().map(d)),this._cubemapQualitySelector.setValueList(T().map(d)),this._lodSelector.setValueList(E().map(d)),this._msInLaunchersSelector.setValueList(p()),this._shaderComplexitySelector.setValueList(y().map(d)),this._shadowMappingSelector.setValueList(p()),this._shadowQualitySelector.setValueList(I().map(d)),this._shadowDistanceSelector.setValueList(A().map(d)),this._maxDynamicLightsSelector.setValueList(M().map(d)),this._particleAmountSelector.setValueList(C().map(d)),this._dustParticleAmountSelector.setValueList(N().map(d)),this._updateValues()},h.prototype._updateShadowMappingSelector=function(){l.canEnableShadowMapping()?(this._shadowMappingSelector.setValueList(p()),this._shadowMappingSelector.selectValueWithIndex(!0===l.isShadowMappingEnabled()?J:K)):(this._shadowMappingSelector.setValueList(g()),this._shadowMappingSelector.selectValueWithIndex(K))},h.prototype._updateShadowQualitySelector=function(){l.canEnableShadowMapping()&&l.isShadowMappingEnabled()?(this._shadowQualitySelector.setValueList(I().map(d)),this._shadowQualitySelector.selectValueWithIndex(O(l.getShadowMapQuality(),I()))):(this._shadowQualitySelector.setValueList(g()),this._shadowQualitySelector.selectValueWithIndex(K))},h.prototype._updateShadowDistanceSelector=function(){l.canEnableShadowMapping()&&l.isShadowMappingEnabled()?(this._shadowDistanceSelector.setValueList(A().map(d)),this._shadowDistanceSelector.selectValueWithIndex(O(l.getShadowDistance(),A()))):(this._shadowDistanceSelector.setValueList(g()),this._shadowDistanceSelector.selectValueWithIndex(K))},h.prototype._updateMaxDynamicLightsSelector=function(){l.areDynamicLightsAvailable()?(this._maxDynamicLightsSelector.setValueList(M().map(d)),this._maxDynamicLightsSelector.selectValueWithIndex(O(l.getPointLightAmount(),M()))):(this._maxDynamicLightsSelector.setValueList(g()),this._maxDynamicLightsSelector.selectValueWithIndex(K))},h.prototype._updateValues=function(){l.executeWhenReady(function(){var t=l.getGeneralLevel();this._generalLevelSelector.selectValueWithIndex(t?O(t,m()):m().length-1),this._antialiasingSelector.selectValueWithIndex(!0===l.getAntialiasing()?J:K),this._filteringSelector.selectValueWithIndex(O(l.getFiltering(),f())),this._textureQualitySelector.selectValueWithIndex(O(l.getTextureQuality(),S())),this._cubemapQualitySelector.selectValueWithIndex(O(l.getCubemapQuality(),T())),this._lodSelector.selectValueWithIndex(O(l.getLODLevel(),E())),this._msInLaunchersSelector.selectValueWithIndex(!0===l.areMissilesInLaunchersVisible()?J:K),this._shaderComplexitySelector.selectValueWithIndex(O(l.getShaderComplexity(),y())),this._updateShadowMappingSelector(),this._updateShadowQualitySelector(),this._updateShadowDistanceSelector(),this._updateMaxDynamicLightsSelector(),this._particleAmountSelector.selectValueWithIndex(O(l.getParticleAmount(),C())),this._dustParticleAmountSelector.selectValueWithIndex(O(l.getDustParticleAmount(),N()))}.bind(this))},h.prototype.show=function(){return!!s.HTMLScreen.prototype.show.call(this)&&(this._updateValues(),!0)},{getGraphicsScreen:function(){return new h}}}),
define("armada/screens/audio-settings",["modules/components","modules/screens","modules/game","armada/strings","armada/screens/shared","armada/audio","utils/polyfill"],function(t,e,i,s,n,o){"use strict";function r(){e.HTMLScreen.call(this,n.AUDIO_SCREEN_NAME,n.AUDIO_SCREEN_SOURCE,{backgroundClassName:n.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:n.SCREEN_CONTAINER_CLASS_NAME},void 0,{escape:this._saveAndClose.bind(this)},n.BUTTON_EVENT_HANDLERS),this._backButton=this.registerSimpleComponent(a),this._defaultsButton=this.registerSimpleComponent(l),this._masterVolumeSlider=this._registerSlider(h,s.AUDIO.MASTER_VOLUME.name,o.setMasterVolume),this._musicVolumeSlider=this._registerSlider(u,s.AUDIO.MUSIC_VOLUME.name,o.setMusicVolume),this._sfxVolumeSlider=this._registerSlider(c,s.AUDIO.SFX_VOLUME.name,o.setSFXVolume),this._uiVolumeSlider=this._registerSlider(_,s.AUDIO.UI_VOLUME.name,o.setUIVolume)}var a="backButton",l="defaultsButton",h="masterVolumeSlider",u="musicVolumeSlider",c="sfxVolumeSlider",_="uiVolumeSlider";return r.prototype=new e.HTMLScreen,r.prototype.constructor=r,r.prototype._saveAndClose=function(){o.setMasterVolume(this._masterVolumeSlider.getValue()),o.setMusicVolume(this._musicVolumeSlider.getValue()),o.setSFXVolume(this._sfxVolumeSlider.getValue()),o.setUIVolume(this._uiVolumeSlider.getValue()),i.closeOrNavigateTo(n.SETTINGS_SCREEN_NAME)},r.prototype._registerSlider=function(e,i,s){return this.registerExternalComponent(new t.Slider(e,n.SLIDER_SOURCE,{cssFilename:n.SLIDER_CSS},{id:i},{min:0,max:1,step:.01,default:1},function(t){s(t,!1)}),"settingsDiv")},r.prototype._initializeComponents=function(){e.HTMLScreen.prototype._initializeComponents.call(this),this._backButton._element.onclick=function(){return this._saveAndClose(),!1}.bind(this),this._defaultsButton._element.onclick=function(){return o.restoreDefaults(),this._updateValues(),!1}.bind(this)},r.prototype._updateComponents=function(){e.HTMLScreen.prototype._updateComponents.call(this),this._defaultsButton.setContent(s.get(s.SETTINGS.DEFAULTS)),this._updateValues()},r.prototype._updateValues=function(){this._masterVolumeSlider.setNumericValue(o.getMasterVolume()),this._musicVolumeSlider.setNumericValue(o.getMusicVolume()),this._sfxVolumeSlider.setNumericValue(o.getSFXVolume()),this._uiVolumeSlider.setNumericValue(o.getUIVolume())},r.prototype.show=function(){return!!e.HTMLScreen.prototype.show.call(this)&&(o.resetMasterVolume(),o.resetMusicVolume(),o.resetSFXVolume(),o.resetUIVolume(),this._updateValues(),!0)},{getAudioScreen:function(){return new r}}}),define("armada/screens/gameplay-settings",["modules/application","modules/components","modules/screens","modules/game","armada/strings","armada/screens/shared","armada/configuration","utils/polyfill"],function(t,e,i,s,n,o,r){"use strict";function a(){i.HTMLScreen.call(this,o.GAMEPLAY_SETTINGS_SCREEN_NAME,o.GAMEPLAY_SETTINGS_SCREEN_SOURCE,{cssFilename:o.GAMEPLAY_SETTINGS_SCREEN_CSS,backgroundClassName:o.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:o.SCREEN_CONTAINER_CLASS_NAME},void 0,{escape:this._applyAndClose.bind(this)},o.BUTTON_EVENT_HANDLERS),this._backButton=this.registerSimpleComponent(p),this._titleHeading=this.registerSimpleComponent(g),this._hudTitleHeading=this.registerSimpleComponent(m),this._cameraTitleHeading=this.registerSimpleComponent(f),this._controlsTitleHeading=this.registerSimpleComponent(S),this._defaultsButton=this.registerSimpleComponent(T),this._tHullAtCenterSelector=null,this._offsetImpactIndicatorsSelector=null,this._relativeTargetOrientationSelector=null,this._preferredFighterViewSelector=null,this._preferredShipViewSelector=null,this._demoViewSwitchingSelector=null,this._defaultSalvoModeSelector=null,r.executeWhenReady(function(){this._tHullAtCenterSelector=this._registerSelector(E,n.GAMEPLAY_SETTINGS.TARGET_HEALTH_AT_CENTER.name,c(),O),this._offsetImpactIndicatorsSelector=this._registerSelector(y,n.GAMEPLAY_SETTINGS.OFFSET_IMPACT_INDICATORS.name,c(),O),this._relativeTargetOrientationSelector=this._registerSelector(I,n.GAMEPLAY_SETTINGS.RELATIVE_TARGET_ORIENTATION.name,c(),O),this._preferredFighterViewSelector=this._registerSelector(A,n.GAMEPLAY_SETTINGS.PREFERRED_FIGHTER_VIEW.name,_(),R),this._preferredShipViewSelector=this._registerSelector(M,n.GAMEPLAY_SETTINGS.PREFERRED_SHIP_VIEW.name,d(),R),this._demoViewSwitchingSelector=this._registerSelector(C,n.GAMEPLAY_SETTINGS.DEMO_VIEW_SWITCHING.name,c(),R),this._defaultSalvoModeSelector=this._registerSelector(N,n.GAMEPLAY_SETTINGS.DEFAULT_SALVO_MODE.name,c(),L)}.bind(this))}var l,h,u=function(e){return function(i){var s=e.PREFIX;return s?n.get(s,i):(t.showError("Cannot find caption string specified for setting '"+i+"', because no prefix is available for the corresponding string category!"),i)}},c=function(){return[n.get(n.SETTING.OFF),n.get(n.SETTING.ON)]},_=function(){return l.map(u(n.OBJECT_VIEW))},d=function(){return h.map(u(n.OBJECT_VIEW))},p="backButton",g="title",m="hudTitle",f="cameraTitle",S="controlsTitle",T="defaultsButton",E="targetHullAtCenterSelector",y="offsetImpactIndicatorsSelector",I="relativeTargetOrientationSelector",A="preferredFighterViewSelector",M="preferredShipViewSelector",C="demoViewSwitchSelector",N="defaultSalvoModeSelector",O="hudSettingsDiv",R="cameraSettingsDiv",L="controlsSettingsDiv",x=c().indexOf(n.get(n.SETTING.ON)),v=c().indexOf(n.get(n.SETTING.OFF));return a.prototype=new i.HTMLScreen,a.prototype.constructor=a,a.prototype._registerSelector=function(t,i,s,n){return this.registerExternalComponent(new e.Selector(t,o.SELECTOR_SOURCE,{cssFilename:o.SELECTOR_CSS},{id:i},s),n||O)},a.prototype._applyAndClose=function(){r.setHUDSetting(r.BS.HUD.ALWAYS_SHOW_TARGET_HULL_BAR_AT_CENTER,this._tHullAtCenterSelector.getSelectedIndex()===x),r.setHUDSetting(r.BS.HUD.AIM_ASSIST_CROSSHAIRS,this._offsetImpactIndicatorsSelector.getSelectedIndex()===x),r.setHUDSetting(r.BS.HUD.RELATIVE_TARGET_ORIENTATION,this._relativeTargetOrientationSelector.getSelectedIndex()===x),r.setBattleSetting(r.BS.DEFAULT_FIGHTER_VIEW_NAME,l[this._preferredFighterViewSelector.getSelectedIndex()]),r.setBattleSetting(r.BS.DEFAULT_SHIP_VIEW_NAME,h[this._preferredShipViewSelector.getSelectedIndex()]),r.setBattleSetting(r.BS.DEMO_VIEW_SWITCHING,this._demoViewSwitchingSelector.getSelectedIndex()===x),r.setBattleSetting(r.BS.DEFAULT_SALVO_MODE,this._defaultSalvoModeSelector.getSelectedIndex()===x),s.closeOrNavigateTo(o.SETTINGS_SCREEN_NAME)},a.prototype._initializeComponents=function(){i.HTMLScreen.prototype._initializeComponents.call(this),this._backButton._element.onclick=function(){return this._applyAndClose(),!1}.bind(this),this._defaultsButton._element.onclick=function(){return r.resetHUDSettings(),r.resetBattleSettings(),this._updateValues(),!1}.bind(this)},a.prototype._updateComponents=function(){i.HTMLScreen.prototype._updateComponents.call(this),this._defaultsButton.setContent(n.get(n.SETTINGS.DEFAULTS)),this._tHullAtCenterSelector.setValueList(c()),this._offsetImpactIndicatorsSelector.setValueList(c()),this._relativeTargetOrientationSelector.setValueList(c()),this._preferredFighterViewSelector.setValueList(_()),this._preferredShipViewSelector.setValueList(d()),this._demoViewSwitchingSelector.setValueList(c()),this._defaultSalvoModeSelector.setValueList(c()),this._updateValues()},a.prototype._updateValues=function(){r.executeWhenReady(function(){this._tHullAtCenterSelector.selectValueWithIndex(!0===r.gHS(r.BS.HUD.ALWAYS_SHOW_TARGET_HULL_BAR_AT_CENTER)?x:v),this._offsetImpactIndicatorsSelector.selectValueWithIndex(!0===r.gHS(r.BS.HUD.AIM_ASSIST_CROSSHAIRS)?x:v),this._relativeTargetOrientationSelector.selectValueWithIndex(!0===r.gHS(r.BS.HUD.RELATIVE_TARGET_ORIENTATION)?x:v),this._preferredFighterViewSelector.selectValueWithIndex(l.indexOf(r.getBattleSetting(r.BS.DEFAULT_FIGHTER_VIEW_NAME))),this._preferredShipViewSelector.selectValueWithIndex(h.indexOf(r.getBattleSetting(r.BS.DEFAULT_SHIP_VIEW_NAME))),this._demoViewSwitchingSelector.selectValueWithIndex(!0===r.getBattleSetting(r.BS.DEMO_VIEW_SWITCHING)?x:v),this._defaultSalvoModeSelector.selectValueWithIndex(!0===r.getBattleSetting(r.BS.DEFAULT_SALVO_MODE)?x:v)}.bind(this))},a.prototype.show=function(){return!!i.HTMLScreen.prototype.show.call(this)&&(this._updateValues(),!0)},r.executeWhenReady(function(){l=r.getSetting(r.BS.DEFAULT_FIGHTER_VIEW_NAME_OPTIONS),h=r.getSetting(r.BS.DEFAULT_SHIP_VIEW_NAME_OPTIONS)}),{getGameplaySettingsScreen:function(){return new a}}}),define("armada/screens/control-settings",["utils/utils","modules/screens","modules/components","modules/game","armada/strings","armada/screens/shared","armada/control"],function(t,e,i,s,n,o,r){"use strict";function a(t,e){document.getElementById(e).innerHTML=r.getInputInterpreter(t).getControlStringForAction(e),document.getElementById(e).className=T}function l(){null!==C&&(a(r.KEYBOARD_NAME,C),C=null,document.onkeydown=null,document.onkeyup=null)}function h(t){t.keyCode===I&&(N=!0),t.keyCode===A&&(O=!0),t.keyCode===M&&(R=!0)}function u(e){e.keyCode===I?N=!1:e.keyCode===A?O=!1:e.keyCode===M&&(R=!1),r.getInputInterpreter(r.KEYBOARD_NAME).setAndStoreBinding(new r.KeyBinding(C,t.getKeyOfCode(e.keyCode),N,O,R)),l()}function c(t){var e=t.getAttribute("id");C===e?l():(l(),C=e,t.innerHTML=y,t.className=E,N=!1,O=!1,R=!1,document.onkeydown=function(t){h(t)},document.onkeyup=function(t){u(t)})}function _(){l(),s.closeOrNavigateTo(o.SETTINGS_SCREEN_NAME)}function d(){e.HTMLScreen.call(this,o.CONTROLS_SCREEN_NAME,o.CONTROLS_SCREEN_SOURCE,{cssFilename:o.CONTROLS_SCREEN_CSS,backgroundClassName:o.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:o.SCREEN_CONTAINER_CLASS_NAME},void 0,{escape:_},o.BUTTON_EVENT_HANDLERS),this._backButton=this.registerSimpleComponent(p),this._titleHeading=this.registerSimpleComponent(g),this._mouseTurnSensitivitySlider=this.registerExternalComponent(new i.Slider(S,o.SLIDER_SOURCE,{cssFilename:o.SLIDER_CSS},{id:n.CONTROLS.MOUSE_TURN_SENSITIVITY.name},{min:0,max:.5,step:.01,default:.25},function(t){r.getInputInterpreter(r.MOUSE_NAME).setAndStoreDisplacementAreaRelativeSize(1-t)}),f),this._defaultsButton=this.registerSimpleComponent(m)}var p="backButton",g="title",m="defaultsButton",f="settingsContainer",S="mouseTurnSensitivitySlider",T="clickable",E="highlightedItem",y="?",I=16,A=17,M=18,C=null,N=!1,O=!1,R=!1;return d.prototype=new e.HTMLScreen,d.prototype.constructor=d,d.prototype._initializeComponents=function(){e.HTMLScreen.prototype._initializeComponents.call(this),this._backButton._element.onclick=function(){return _(),!1}.bind(this),this._defaultsButton._element.onclick=function(){return l(),r.restoreDefaults(),this._updateValues(),this._generateTables(),!1}.bind(this)},d.prototype._updateComponents=function(){e.HTMLScreen.prototype._updateComponents.call(this),this._defaultsButton.setContent(n.get(n.SETTINGS.DEFAULTS)),this._updateValues(),this._generateTables()},d.prototype._generateTables=function(){r.executeWhenReady(function(){var e,i,s,a,l,h,u,_,d,p,g,m,f,S,E=this.getElement("tablesContainer"),y=r.getControllers(),I={},A=function(t){var e=this.getElement(t);e.hidden=!e.hidden,o.playButtonClickSound(!0)},M=function(){o.playButtonSelectSound(!0)},C=function(){c(this)};for(E.innerHTML="",e=0;e<y.length;e++){for(l="table_"+y[e].getType(),h=document.createElement("h2"),h.innerHTML=t.formatString(n.get(n.CONTROLS.CONTROLLER_TYPE_HEADING),{controllerType:n.get(n.CONTOLLER.PREFIX,y[e].getType())}),h.className="controls tableTitle",h.onclick=A.bind(this,l),h.onmouseenter=M,E.appendChild(h),u=document.createElement("table"),u.id=this._getElementID(l),u.className="controlsTable outerContainer",_=document.createElement("thead"),i=0,a=r.getInputInterpreters().length;i<a;i++)d=document.createElement("th"),d.innerHTML=n.get(n.INPUT.DEVICE_NAME_PREFIX,r.getInputInterpreters()[i].getDeviceName()),_.appendChild(d);for(_.innerHTML+="<th>"+n.get(n.CONTROLS.ACTION)+"</th>",p=document.createElement("tbody"),g=y[e].getActions(),i=0;i<g.length;i++)I[g[i]._name]=n.ACTION_DESCRIPTIONS.PREFIX.name+g[i]._name;for(i=0;i<g.length;i++){for(m=document.createElement("tr"),s=0,a=r.getInputInterpreters().length;s<a;s++)f=document.createElement("td"),r.getInputInterpreters()[s].getDeviceName()===r.KEYBOARD_NAME&&(f.setAttribute("id",g[i]._name),f.className=T,f.onclick=C),f.innerHTML=r.getInputInterpreters()[s].getControlStringForAction(g[i]._name),m.appendChild(f);S=document.createElement("td"),S.innerHTML=n.get(n.ACTION_DESCRIPTIONS.PREFIX,g[i]._name),m.appendChild(S),p.appendChild(m)}u.appendChild(_),u.appendChild(p),u.hidden=!0,E.appendChild(u)}}.bind(this))},d.prototype._updateValues=function(){this._mouseTurnSensitivitySlider.setNumericValue(1-r.getInputInterpreter(r.MOUSE_NAME).getDisplacementAreaRelativeSize())},d.prototype.show=function(){return!!e.HTMLScreen.prototype.show.call(this)&&(this._updateValues(),!0)},{getControlsScreen:function(){return new d}}}),define("armada/screens/about",["modules/game","modules/screens","armada/strings","armada/screens/shared"],function(t,e,i,s){"use strict";function n(t,e){return t.textContent.localeCompare(e.textContent)}function o(t,e){return'<a target="_blank" rel="noopener" href="'+t+'">'+e+"</a>"}function r(){e.HTMLScreen.call(this,s.ABOUT_SCREEN_NAME,s.ABOUT_SCREEN_SOURCE,{cssFilename:s.ABOUT_SCREEN_CSS,backgroundClassName:s.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:s.SCREEN_CONTAINER_CLASS_NAME},void 0,{escape:function(){t.closeOrNavigateTo(s.MAIN_MENU_SCREEN_NAME)}},s.BUTTON_EVENT_HANDLERS),this._backButton=this.registerSimpleComponent(a),this._versionParagraph=this.registerSimpleComponent(l),this._aboutGameDevParagraph=this.registerSimpleComponent(h),this._aboutLicenseParagraph=this.registerSimpleComponent(c),this._aboutUsedSoftwareParagraph=this.registerSimpleComponent(u)}var a="backButton",l="versionParagraph",h="aboutGameDevParagraph",u="usedSoftwareParagraph",c="licenseParagraph";return r.prototype=new e.HTMLScreen,r.prototype.constructor=r,r.prototype._initializeComponents=function(){e.HTMLScreen.prototype._initializeComponents.call(this),this._backButton._element.onclick=function(){return t.closeOrNavigateTo(s.MAIN_MENU_SCREEN_NAME),!1}.bind(this)},r.prototype._updateComponents=function(){var s,r,a,l,h,u,c;for(e.HTMLScreen.prototype._updateComponents.call(this),this._versionParagraph.customizeContent({version:t.getVersion()}),this._aboutGameDevParagraph.customizeContent({facebook:o("https://www.facebook.com/interstellar.armada","facebook"),github:o("https://github.com/nkrisztian89/interstellar-armada","github"),email:o("mailto:armada.galactic.ace@gmail.com","email")}),this._aboutUsedSoftwareParagraph.customizeContent({inkscape:o("https://inkscape.org","Inkscape"),blender:o("https://www.blender.org/","Blender"),gimp:o("https://www.gimp.org","GIMP"),audacity:o("http://www.audacityteam.org","Audacity"),bfxr:o("http://www.bfxr.net","Bfxr"),lmms:o("https://lmms.io","LMMS"),fontforge:o("https://fontforge.github.io/en-US/","FontForge"),netbeans:o("https://netbeans.org/","Netbeans"),git:o("https://git-scm.com/","git"),npm:o("https://www.npmjs.com/","npm"),grunt:o("https://gruntjs.com/","Grunt"),sass:o("http://sass-lang.com/","Sass"),lazarus:o("http://www.lazarus-ide.org/","Lazarus"),chrome:o("https://www.google.com/chrome","Google Chrome"),firefox:o("https://www.mozilla.org/firefox","Firefox"),ubuntu:o("http://www.ubuntu.com/desktop","Ubuntu"),eslint:o("http://plugins.netbeans.org/plugin/63486/eslint","ESLint"),glsl:o("http://plugins.netbeans.org/plugin/46515/glsl-syntax-highlighter","GLSL Syntax Highlighter"),markdown:o("http://plugins.netbeans.org/plugin/50964/markdown-support","Markdown Support")}),this._aboutLicenseParagraph.customizeContent({license:o("http://www.gnu.org/licenses/gpl-3.0-standalone.html","GNU GPLv3"),sansation:o("http://www.dafont.com/sansation.font","Sansation"),aldrich:o("https://fonts.google.com/specimen/Aldrich","Aldrich"),audiowide:o("https://fonts.google.com/specimen/Audiowide","Audiowide"),fontlog:o("assets/fonts/FONTLOG.txt","fontlog"),requireJS:o("http://requirejs.org/","RequireJS"),requireJSLicense:o("license/RequireJS-License.txt",i.get(i.ABOUT.REQUIRE_JS_LICENSE)),assetLicense:o("https://creativecommons.org/licenses/by/4.0/","CC BY 4.0"),soundLicense:o("license/sfx-license.txt",i.get(i.ABOUT.HERE))}),"magyar"===i.getLanguage()?(u=!0,s=this._container.querySelectorAll(".huName:not(.reversed)")):(u=!1,s=this._container.querySelectorAll(".huName.reversed")),r=0;r<s.length;r++)l=u?s[r].textContent.lastIndexOf(" "):s[r].textContent.indexOf(" "),h=[s[r].textContent.substring(0,l),s[r].textContent.substring(l+1)],s[r].textContent=h[1]+" "+h[0],s[r].classList.toggle("reversed");for(c=this._container.querySelectorAll(".orderedNameList"),r=0;r<c.length;r++)for(s=Array.prototype.slice.call(c[r].getElementsByTagName("li")),s.sort(n),a=0;a<s.length;a++)c[r].appendChild(s[a])},{getAboutScreen:function(){return new r}}}),define("armada/screens/dialog",["modules/game","modules/screens","armada/screens/shared"],function(t,e,i){"use strict";function s(){e.HTMLScreen.call(this,i.DIALOG_SCREEN_NAME,i.DIALOG_SCREEN_SOURCE,{cssFilename:i.DIALOG_SCREEN_CSS,backgroundClassName:i.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:i.SCREEN_CONTAINER_CLASS_NAME},void 0,{left:this._selectPrevious.bind(this),right:this._selectNext.bind(this),enter:this._activateSelected.bind(this),escape:function(){t.closeSuperimposedScreen(),this._onClose&&this._onClose()}.bind(this)}),this._header=this.registerSimpleComponent(n),this._message=this.registerSimpleComponent(o),this._leftButton=this.registerSimpleComponent(r),this._middleButton=this.registerSimpleComponent(a),this._rightButton=this.registerSimpleComponent(l),this._buttons=[this._leftButton,this._middleButton,this._rightButton],this._selectedIndex=-1,this._activeButtonCount=0,this._buttonLeaveHandler=this._selectIndex.bind(this,-1),this._onClose=null}var n="header",o="message",r="leftButton",a="middleButton",l="rightButton";return s.prototype=new e.HTMLScreen,s.prototype.constructor=s,s.prototype._selectIndex=function(t){t!==this._selectedIndex&&(this._selectedIndex>=0&&this._buttons[this._selectedIndex].unselect(),this._selectedIndex=t,this._selectedIndex>=0&&(this._buttons[this._selectedIndex].select(),i.playButtonSelectSound(!0)))},s.prototype._selectNext=function(){this._selectIndex((this._selectedIndex+1)%this._activeButtonCount)},s.prototype._selectPrevious=function(){var t=this._selectedIndex>0?this._selectedIndex:this._activeButtonCount;this._selectIndex((t-1)%this._buttons.length)},s.prototype._activateSelected=function(){this._selectedIndex>=0&&this._buttons[this._selectedIndex]._element.onclick()},s.prototype.setActive=function(t){e.HTMLScreen.prototype.setActive.call(this,t),this._selectIndex(-1)},s.prototype._createButtonClickHandler=function(t){return function(){t(),i.playButtonClickSound(!0)}},s.prototype.setup=function(t){var e;for(this._onClose=t.onClose,this._header.setVisible(t.header&&t.header.length>0),this._header.isVisible()&&this._header.setContent(t.header),t.messageClass&&(this._message._element.className+=" "+t.messageClass),this._message.setContent(t.message),e=0;e<this._buttons.length;e++)this._buttons[e]._element.onclick=null,this._buttons[e]._element.onmousemove=null,this._buttons[e]._element.onmouseleave=null;for(e=0;e<t.buttons.length;e++)this._buttons[e].setContent(t.buttons[e].caption),this._buttons[e]._element.onclick=this._createButtonClickHandler(t.buttons[e].action),this._buttons[e]._element.onmousemove=this._selectIndex.bind(this,e),this._buttons[e]._element.onmouseleave=this._buttonLeaveHandler,this._buttons[e].show();for(this._activeButtonCount=t.buttons.length;e<this._buttons.length;)this._buttons[e].hide(!0),e++},{getDialogScreen:function(){return new s}}}),define("armada/armada",["modules/game","modules/components","modules/analytics","modules/scene/lights","armada/constants","armada/graphics","armada/audio","armada/configuration","armada/logic/environments","armada/logic/missions","armada/control","armada/strings","armada/screens/shared","armada/screens/menus","armada/screens/missions","armada/screens/battle","armada/screens/debriefing","armada/screens/database","armada/screens/general-settings","armada/screens/graphics-settings","armada/screens/audio-settings","armada/screens/gameplay-settings","armada/screens/control-settings","armada/screens/about","armada/screens/dialog"],function(t,e,i,s,n,o,r,a,l,h,u,c,_,d,p,g,m,f,S,T,E,y,I,A,M){"use strict";var C=document.getElementById("splashProgress");return C.max=6,t.setGameName(n.GAME_NAME),t.setStartScreenName("mainMenu"),t.setConfigFolder("config/"),t.setConfigFileName("config.json"),t.setFileCacheBypassEnabled(!1),t.setPreviouslyRunVersion(localStorage[n.VERSION_LOCAL_STORAGE_ID]),t._loadGameSettingsAndExecuteCallback=function(t,e){o.loadSettingsFromJSON(t.graphics),o.loadSettingsFromLocalStorage(),r.loadSettingsFromJSON(t.audio),r.loadSettingsFromLocalStorage(),a.loadSettingsFromJSON(t.logic),u.loadSettingsFromJSON(t.control),u.loadSettingsFromLocalStorage(),h.loadSettingsFromLocalStorage(),o.executeWhenReady(function(){s.setupLiSPSM(o.getLispsmMinimumNear(),o.getLispsmNearFactor())}),a.executeWhenReady(function(){l.requestLoad(),l.executeWhenReady(function(){C.value=2,h.requestLoad(!1),h.executeWhenReady(function(){C.value=3,e()})})})},t._loadGameConfigurationAndExecuteCallback=function(e,s){var n=t.showError;a.loadConfigurationFromJSON(e.dataFiles.logic),o.loadConfigurationFromJSON(e.graphics),r.loadConfigurationFromJSON(e.audio),h.loadConfigurationFromJSON(e.logic),u.loadConfigurationFromJSON(e.control),C.value=1,e.analyticsEnabled&&i.init(e.analyticsUrl),t.showError=function(t,e,s){i.sendEvent("error",void 0,{message:t.length>120?t.substr(0,120)+"...":t}),n(t,e,s)},s()},t._buildScreensAndExecuteCallback=function(i){t.addScreen(d.getMainMenuScreen()),t.addScreen(p.getMissionsScreen()),t.addScreen(g.getBattleScreen()),t.addScreen(m.getDebriefingScreen()),t.addScreen(f.getDatabaseScreen()),t.addScreen(d.getSettingsMenuScreen()),t.addScreen(S.getGeneralSettingsScreen()),t.addScreen(T.getGraphicsScreen()),t.addScreen(E.getAudioScreen()),t.addScreen(y.getGameplaySettingsScreen()),t.addScreen(I.getControlsScreen()),t.addScreen(A.getAboutScreen()),t.addScreen(d.getIngameMenuScreen(),!0),t.addScreen(M.getDialogScreen(),!0),C.value=4,t.executeWhenAllScreensReady(function(){C.value=5,t.requestLanguageChange(localStorage.getItem(n.LANGUAGE_LOCAL_STORAGE_ID)||t.getDefaultLanguage(),c,function(){C.value=6,e.clearStoredDOMModels(),localStorage[n.VERSION_LOCAL_STORAGE_ID]=t.getVersion(),_.initAudio(i)})})},t}),requirejs(["armada/armada"],function(t){"use strict";t.initialize({electron:location.hash.indexOf("electron")>=0,local:location.hash.indexOf("local")>=0})}),define("main",function(){});